[
  {
    "text": "uh welcome to have been pwned and how to serve billions of requests and terabytes of data without going",
    "start": "160",
    "end": "6879"
  },
  {
    "text": "broke uh I'm going to start this off by telling you a little bit about myself my",
    "start": "6879",
    "end": "12000"
  },
  {
    "text": "name is stepan y I'm Icelandic and for this whole reason of being Icelandic you",
    "start": "12000",
    "end": "17920"
  },
  {
    "text": "probably have a measurable portion of the entire country here in the room with you I'm a principal software engineer at",
    "start": "17920",
    "end": "24480"
  },
  {
    "text": "Lucin in re also Microsoft MVP and I may have been pwned conf and",
    "start": "24480",
    "end": "30560"
  },
  {
    "text": "maintainer and have been for the for a while that's a link to my blog want to",
    "start": "30560",
    "end": "36239"
  },
  {
    "text": "take a look at it but to start this off uh have I been",
    "start": "36239",
    "end": "42120"
  },
  {
    "text": "pwned to answer all your questions then yes you have it was launched on December 4th",
    "start": "42120",
    "end": "48680"
  },
  {
    "text": "2013 by Troy hunt Troy Hunt's an Australian he used to frequent NDC but unfortunately he's not here with us",
    "start": "48680",
    "end": "55520"
  },
  {
    "text": "today it allows like the gist of it is it allows internet users to check out if their data have or has been leaked in a",
    "start": "55520",
    "end": "62440"
  },
  {
    "text": "data breach uh some statistics currently it contains",
    "start": "62440",
    "end": "68799"
  },
  {
    "text": "breaches for 6 674 websites over 12 billion email addresses",
    "start": "68799",
    "end": "75439"
  },
  {
    "text": "which don't have to think about very long to realize that there more email addresses than are humans in the world",
    "start": "75439",
    "end": "81479"
  },
  {
    "text": "and over 850 million passwords or their hashes to be more",
    "start": "81479",
    "end": "86600"
  },
  {
    "text": "correct have been pwn has a notification service you can register and verify your",
    "start": "86600",
    "end": "93240"
  },
  {
    "text": "email and how in pwn will let you know if that email is found in uh data bries",
    "start": "93240",
    "end": "98640"
  },
  {
    "text": "as they come in it also has uh domain search",
    "start": "98640",
    "end": "104079"
  },
  {
    "text": "functionality for example if you have your own domain or if you are a system administrator you can verify your domain with have been poned and it will then",
    "start": "104079",
    "end": "111360"
  },
  {
    "text": "let you know if any email addresses under that domain are found in a data bridge is this is very",
    "start": "111360",
    "end": "118520"
  },
  {
    "text": "handy then it also has an ingestion pipeline uh",
    "start": "118520",
    "end": "124039"
  },
  {
    "text": "which is used by law enforcement uh and government so for example agencies like the FBI uh and the NCA NCA for those",
    "start": "124039",
    "end": "131400"
  },
  {
    "text": "that don't know is pretty much the equivalent of the FBI in the UK they actually feed data or passwords into",
    "start": "131400",
    "end": "137640"
  },
  {
    "text": "have been pwned uh through an API pipeline that we have and just over the last year they",
    "start": "137640",
    "end": "143879"
  },
  {
    "text": "ingested millions of passwords so it's good to get these things these are these are passwords",
    "start": "143879",
    "end": "149160"
  },
  {
    "text": "that they find for example in their investigations uh SE teams from different governments also have access",
    "start": "149160",
    "end": "156080"
  },
  {
    "text": "to have been poned they get they get free access to it so they can like if any any government email addresses are",
    "start": "156080",
    "end": "162159"
  },
  {
    "text": "found in data breaches the SE teams are notified and as far as I know and the",
    "start": "162159",
    "end": "168800"
  },
  {
    "text": "last time I checked it 34 governments signed up it's USA UK Germany Iceland I think pretty much all the Nordic",
    "start": "168800",
    "end": "174480"
  },
  {
    "text": "countries for example uh but",
    "start": "174480",
    "end": "181080"
  },
  {
    "text": "going to ask you very quickly if you recognize this number I'm not I'm not expecting you to you probably don't and",
    "start": "181080",
    "end": "187159"
  },
  {
    "text": "you're not supposed to but be clear a little bit later",
    "start": "187159",
    "end": "192879"
  },
  {
    "text": "on but many of you might recognize this number for the sole reason of like we",
    "start": "192879",
    "end": "198080"
  },
  {
    "text": "all know how to count but this number is actually uh",
    "start": "198080",
    "end": "203840"
  },
  {
    "text": "according to data breaches the most popular password in the world so I'm really really hoping that",
    "start": "203840",
    "end": "208959"
  },
  {
    "text": "none of you actually have this as a password Suare uh if you do please go ahead and change",
    "start": "208959",
    "end": "214840"
  },
  {
    "text": "it but if you worked with all computers you would probably recognize that this is a hexadecimal",
    "start": "214840",
    "end": "221360"
  },
  {
    "text": "string but to be more correct this is actually sh one hash of 1 2 3 4 5 6 and",
    "start": "221360",
    "end": "228439"
  },
  {
    "text": "why is that important because we can actually use the Shan hash to see if 1 2 3 456 has",
    "start": "228439",
    "end": "234680"
  },
  {
    "text": "been a data Bridge simply take the five first five characters go to this URL get a text",
    "start": "234680",
    "end": "241200"
  },
  {
    "text": "file back and you look for the rest of the hash in the file and there you see the number",
    "start": "241200",
    "end": "247239"
  },
  {
    "text": "behind this is how often 1 2 3 4 5 6 has been seen in a data",
    "start": "247239",
    "end": "253280"
  },
  {
    "text": "Bridge yes that's 37.6 million times and it's probably",
    "start": "253280",
    "end": "259440"
  },
  {
    "text": "been in a data breach a lot more often these are just the data breaches that we can actually see that the password has been in",
    "start": "259440",
    "end": "264639"
  },
  {
    "text": "there so have a been pwn has an API the P password API and that's sort of",
    "start": "264639",
    "end": "270440"
  },
  {
    "text": "becomes the focus of this talk because that's where most of the traffic goes like I said in there there are 850",
    "start": "270440",
    "end": "276639"
  },
  {
    "text": "million password hashes in that API All the known breach passwords that",
    "start": "276639",
    "end": "281800"
  },
  {
    "text": "we have found in the data breaches we both have sha one and nlm hashes uh ntlm",
    "start": "281800",
    "end": "287960"
  },
  {
    "text": "hashes are good because like I said or like it says you can download the hashes",
    "start": "287960",
    "end": "293840"
  },
  {
    "text": "for offline use like in a big file so you can you can check off line",
    "start": "293840",
    "end": "299919"
  },
  {
    "text": "you don't have to have to use the API for everything um and for example in the case of ntlm if you're if you're a",
    "start": "299919",
    "end": "305639"
  },
  {
    "text": "system administrator for an active directory domain you can actually fetch that file and see if any of your users",
    "start": "305639",
    "end": "311560"
  },
  {
    "text": "have well what's considered uh unfit passwords for use without knowing what the password",
    "start": "311560",
    "end": "318960"
  },
  {
    "text": "is it can be integrated in a number of ways and it has been so just just to name uh three cases one password uses",
    "start": "319639",
    "end": "327720"
  },
  {
    "text": "have been pwned for its watch to Fe feature uh they have a feature where they actually like go over",
    "start": "327720",
    "end": "334240"
  },
  {
    "text": "your passwords that you have in your password manager and can actually tell you no this one is not too complex and this one is actually vulnerable Mozilla",
    "start": "334240",
    "end": "341319"
  },
  {
    "text": "uses have a been pone for Firefox monitor so they can tell you if the email address you're signing up for has",
    "start": "341319",
    "end": "348160"
  },
  {
    "text": "uh or using in any of your logins has been in a data breach and the email line where I used to work uh actually can",
    "start": "348160",
    "end": "354919"
  },
  {
    "text": "tell users when they're logging in if their password is not safe anymore",
    "start": "354919",
    "end": "360080"
  },
  {
    "text": "so these are just a just a few examples for example the1 line one this is what happens when you log in with a bad",
    "start": "360080",
    "end": "365400"
  },
  {
    "text": "password you get notified it says Hey because you know the only place where",
    "start": "365400",
    "end": "371319"
  },
  {
    "text": "they actually have your password when you're logging in so they say hey like this password you're using is not safe you should go to account management and",
    "start": "371319",
    "end": "377440"
  },
  {
    "text": "change it and enable two Factor authentication if you haven't and then it like gives you links to like good",
    "start": "377440",
    "end": "382960"
  },
  {
    "text": "password hygien uh in the middle you see the one password integration it has Watch Tower and the big Red Square there",
    "start": "382960",
    "end": "390520"
  },
  {
    "text": "is actually checking they have a been toned API to see if the passwords are any of your passwords in your one",
    "start": "390520",
    "end": "396360"
  },
  {
    "text": "password Vault are insecure and Firefox monitor tells you that like your email address has been",
    "start": "396360",
    "end": "402039"
  },
  {
    "text": "exposed in several data breaches yes that's my email address I'm actually happy that it's just 11 probably could",
    "start": "402039",
    "end": "407800"
  },
  {
    "text": "be a lot more um and then it tells you like which data bees you've been in and what data was actually leaked in that",
    "start": "407800",
    "end": "414199"
  },
  {
    "text": "data breach so you can EAS look up and see if",
    "start": "414199",
    "end": "420840"
  },
  {
    "text": "a password is unfit for use uh just consider any password that's in there to",
    "start": "420840",
    "end": "426680"
  },
  {
    "text": "be unfit for use and why is that because these password lists or pretty",
    "start": "426680",
    "end": "431800"
  },
  {
    "text": "much since we have the passwords that means the bad guys have the passwords as well and they regularly go through this",
    "start": "431800",
    "end": "437680"
  },
  {
    "text": "list and just like go rampant on services with partnet like checking every or usually the most popular",
    "start": "437680",
    "end": "444000"
  },
  {
    "text": "passwords and basically see what what sticks and unfortunately a lot of them stick",
    "start": "444000",
    "end": "450680"
  },
  {
    "text": "now the password itself is never sent to the AL Pon API and neither is the full",
    "start": "450680",
    "end": "457560"
  },
  {
    "text": "hash of it uh and that's because of K anonymity and I'm going to explain that in a little bit but that's used to",
    "start": "457560",
    "end": "463080"
  },
  {
    "text": "prevent uh for example if your network traffic was going through a proxy whoever controls the proxy can't",
    "start": "463080",
    "end": "469199"
  },
  {
    "text": "actually see what password you're looking up because that would be bad so pretty easy to use calculate the",
    "start": "469199",
    "end": "476720"
  },
  {
    "text": "sh one hash of the password issue a request look up the rest of it in the text file and see if you can find the",
    "start": "476720",
    "end": "482599"
  },
  {
    "text": "rest of the hash in there but to make the example like even more clear uh let's start with Hunter",
    "start": "482599",
    "end": "489360"
  },
  {
    "text": "tube this is a this is a story from IRC I don't remember how many of you",
    "start": "489360",
    "end": "494919"
  },
  {
    "text": "remember IRC uh see if you can spot the joke in there so basically this is a chat going",
    "start": "494919",
    "end": "502000"
  },
  {
    "text": "on between two people I want him saying hey if you type in your password it just shows up Stars so the guy types in his",
    "start": "502000",
    "end": "507560"
  },
  {
    "text": "password hun2 uh do look like stars to me so the other guy pays it back saying no it looks like stars to me oh so you",
    "start": "507560",
    "end": "514479"
  },
  {
    "text": "can go Hunter 2 my Hunter 2 and Hunter 2 right does that look funny to you and the guy said yeah I just see a bunch of",
    "start": "514479",
    "end": "520518"
  },
  {
    "text": "stars all I see is like when you type Hunter two it shows up with stars wait so you know my password uh no because",
    "start": "520519",
    "end": "526399"
  },
  {
    "text": "like I copy pasted your stars so it like shows correctly up with you oh",
    "start": "526399",
    "end": "533120"
  },
  {
    "text": "okay so let's use Hunter 2 as an example this is the sh one hash from Hunter 2",
    "start": "533519",
    "end": "539200"
  },
  {
    "text": "and what we're interested in is these parts the green part is actually what we",
    "start": "539200",
    "end": "546079"
  },
  {
    "text": "will be appending to the URL so we do a get request to the API the green",
    "start": "546079",
    "end": "552200"
  },
  {
    "text": "part we get back a text file and we will be looking for a line starting with red",
    "start": "552200",
    "end": "557480"
  },
  {
    "text": "part and in the case of 100 two this is what you'll find and yes someone or some",
    "start": "557480",
    "end": "563600"
  },
  {
    "text": "people have used2 23,000 times as a password probably because they thought",
    "start": "563600",
    "end": "570040"
  },
  {
    "text": "it was a good idea it isn't um so that's that's how easy it is to",
    "start": "570040",
    "end": "575560"
  },
  {
    "text": "actually use the API just to sort of go over the hosting",
    "start": "575560",
    "end": "581320"
  },
  {
    "text": "environment uh hosting environment is that simple really uh the hashes are just text files they're stored in Azure",
    "start": "581320",
    "end": "587480"
  },
  {
    "text": "blob storage email addresses are stored in Azure table storage where we actually use the domain as a partitioning key and",
    "start": "587480",
    "end": "595120"
  },
  {
    "text": "the uh everything before the ad sign is a row key both the email and domain search is run",
    "start": "595120",
    "end": "601200"
  },
  {
    "text": "as Azure functions uh the hash files are also served by Azure functions like all",
    "start": "601200",
    "end": "606360"
  },
  {
    "text": "they do is like just an HTP trigger fetches the taex file and returns it back and this is actually all these as",
    "start": "606360",
    "end": "613079"
  },
  {
    "text": "functions are open sourced at least the pan post P passwords one are so you can actually look them up there if you",
    "start": "613079",
    "end": "619959"
  },
  {
    "text": "want uh so traffic is growing fast this is the request per month that",
    "start": "619959",
    "end": "627440"
  },
  {
    "text": "the P passwords API receives started out pretty small uh then it is",
    "start": "627440",
    "end": "633240"
  },
  {
    "text": "gradually increasing and it currently seems to be almost increasing in an exponential rate um I hope it doesn't",
    "start": "633240",
    "end": "640440"
  },
  {
    "text": "continue doing that because we're going to have to figure something out then but just to look at the numbers as",
    "start": "640440",
    "end": "646880"
  },
  {
    "text": "of this month like all of the Shan D nlm hashes are 60 GB that's all the text",
    "start": "646880",
    "end": "654399"
  },
  {
    "text": "files now considering like for both ntlm and ch1 you really just have over 1",
    "start": "654399",
    "end": "660240"
  },
  {
    "text": "million tax files because there's a limited key range in there the average tax file is 30",
    "start": "660240",
    "end": "666040"
  },
  {
    "text": "Koby and we are currently serving over 5 billion HTTP requests per month so",
    "start": "666040",
    "end": "672120"
  },
  {
    "text": "putting that down is it's over 2,000 requests per second every second every minute every hour every day all the time",
    "start": "672120",
    "end": "679839"
  },
  {
    "text": "on average so that's a lot uh when I was actually gathering",
    "start": "679839",
    "end": "686200"
  },
  {
    "text": "this data I figured out like when when did I actually put in a proposal for this talk and in The Proposal I actually",
    "start": "686200",
    "end": "692920"
  },
  {
    "text": "said I was mentioning 1.6 billion requests per month that was uh because",
    "start": "692920",
    "end": "698079"
  },
  {
    "text": "the numbers I had were from March 222 so I'm sorry that uh this was a lie",
    "start": "698079",
    "end": "704360"
  },
  {
    "text": "because currently this is up to five like I said 5 billion requests as of this month and to sort of try to put this",
    "start": "704360",
    "end": "712360"
  },
  {
    "text": "into perspective uh of how much data this",
    "start": "712360",
    "end": "717959"
  },
  {
    "text": "is this is is 126.80",
    "start": "717959",
    "end": "722560"
  },
  {
    "text": "that so that sort of sort of puts it into perspective how much data is actually being",
    "start": "750440",
    "end": "757360"
  },
  {
    "text": "transferred so if you do some maths serving this like straight out of Asher",
    "start": "757360",
    "end": "763240"
  },
  {
    "text": "uh with nothing in between would be expensive if you think about us fetching tax files from blob storage it would be",
    "start": "763240",
    "end": "769639"
  },
  {
    "text": "5 billion read operations uh I actually had to update",
    "start": "769639",
    "end": "775320"
  },
  {
    "text": "that number should be 126 terab not 125 but it's not going to make all",
    "start": "775320",
    "end": "780760"
  },
  {
    "text": "difference and putting this into the Azure calculator comes out to many dollars and not such wow to be more",
    "start": "780760",
    "end": "787600"
  },
  {
    "text": "exact it would be more than $12,600 per month just to just to serve this data and this like we're just",
    "start": "787600",
    "end": "793880"
  },
  {
    "text": "reading data and putting it back that's because Asher actually builds you for the amount of data that you send through",
    "start": "793880",
    "end": "800600"
  },
  {
    "text": "the network and for of course for the uh read operations from the",
    "start": "800600",
    "end": "806480"
  },
  {
    "text": "blobs but as like probably will be all of you figured out this is completely static data so there's no reason for us",
    "start": "806480",
    "end": "813040"
  },
  {
    "text": "to do this all the time every time so of course we cash all the things in there",
    "start": "813040",
    "end": "818720"
  },
  {
    "text": "but caching is not enough like we could cash like just in the Azure function and save on the read operations but we'",
    "start": "818720",
    "end": "824600"
  },
  {
    "text": "still be serving those terabytes of data so we had to figure out uh something",
    "start": "824600",
    "end": "830920"
  },
  {
    "text": "else so the obvious reason would be to put a CDN in front of it and we went with Cloud",
    "start": "830920",
    "end": "836920"
  },
  {
    "text": "flare they have a CDN uh their CDN is fast it's actually very very fast uh",
    "start": "836920",
    "end": "843920"
  },
  {
    "text": "Global reach they have 250 Edge nodes all over the world like 10,000 networks",
    "start": "843920",
    "end": "850320"
  },
  {
    "text": "connect pretty much directly to them that's isps um like Cloud providers and",
    "start": "850320",
    "end": "856560"
  },
  {
    "text": "a lot of other people they have a free tier which does a lot of the things that I'll be talking about without you having",
    "start": "856560",
    "end": "862720"
  },
  {
    "text": "to pay anything actually so this seemed like a very perfect fit and when I say",
    "start": "862720",
    "end": "868440"
  },
  {
    "text": "it's faster than I think I actually mean that literally because they say that 95% of the world's population is within 50",
    "start": "868440",
    "end": "874680"
  },
  {
    "text": "milliseconds of a cloud for data center it takes you 100 milliseconds to Blink just to put that into",
    "start": "874680",
    "end": "882880"
  },
  {
    "text": "perspective so cloudfare caching uh it",
    "start": "883079",
    "end": "888160"
  },
  {
    "text": "cloudfare is very simple you basically just route your domain through them and they they do a lot of things just out of",
    "start": "888160",
    "end": "894759"
  },
  {
    "text": "the box and a lot of things is just pretty much just like flipping on switches uh there are some things you have to think of though it depends on",
    "start": "894759",
    "end": "901320"
  },
  {
    "text": "the content type you're serving it's going to be easy or not but we figured okay we can just set the cash TTL or the",
    "start": "901320",
    "end": "908120"
  },
  {
    "text": "time to live to a very high value and that is currently set to 30 days so we're basically telling all the",
    "start": "908120",
    "end": "914519"
  },
  {
    "text": "cloud for Edge nodes to Cache The Blob files for 30 days on the edge nodes but",
    "start": "914519",
    "end": "920600"
  },
  {
    "text": "you get a lot of other perks uh as well from cloud fa like they they give you https they can give you HTTP 2 and 3",
    "start": "920600",
    "end": "927639"
  },
  {
    "text": "like all the latest protocols brought compression they just do all of these things for you and you don't have to worry about like flipping those switches",
    "start": "927639",
    "end": "934319"
  },
  {
    "text": "on your own web servers the initial implementation that",
    "start": "934319",
    "end": "939800"
  },
  {
    "text": "we actually did was pretty much just create a cloud for worker that's it's pretty much just a",
    "start": "939800",
    "end": "945800"
  },
  {
    "text": "snippet of of JavaScript that you can run on the cloud for nodes so what that does is it gets a",
    "start": "945800",
    "end": "952519"
  },
  {
    "text": "request goes to the origin which is the aure servers uh fetches the data sets some",
    "start": "952519",
    "end": "958959"
  },
  {
    "text": "course headers so people can like do this directly from their browsers validates the request like is it a get",
    "start": "958959",
    "end": "965160"
  },
  {
    "text": "request there the like hash prefix valid is five characters Etc and then we do URL normalization because one of the",
    "start": "965160",
    "end": "972560"
  },
  {
    "text": "things that is sneaky is that URLs are case sensitive well technically not all",
    "start": "972560",
    "end": "978800"
  },
  {
    "text": "of it because the scheme HTTP or htps isn't and the host name is not but the rest of the URL is Cas",
    "start": "978800",
    "end": "985160"
  },
  {
    "text": "sensitive so to for example if we would fetch uh if we would fetch the hash file for",
    "start": "985160",
    "end": "993079"
  },
  {
    "text": "fffff all in lower case web servers would look at it differently as in if it was all uppercase so what the cloud",
    "start": "993079",
    "end": "999519"
  },
  {
    "text": "flare worker does is basically just gets the URL converts the range to uppercase so we're always fetching the same thing",
    "start": "999519",
    "end": "1005639"
  },
  {
    "text": "otherwise we would be could be taking up multiple cash slots for the same request the cloud worker is open source",
    "start": "1005639",
    "end": "1013360"
  },
  {
    "text": "as well if you want to take a look at it so that's that's there",
    "start": "1013360",
    "end": "1019319"
  },
  {
    "text": "the initial results of that implementation was that the cash it was 99.5% which is a",
    "start": "1019319",
    "end": "1025558"
  },
  {
    "text": "lot so with our current numbers like that would bring the bill down from",
    "start": "1025559",
    "end": "1030600"
  },
  {
    "text": "12,000 how was it $12,600 down to 63 which is good or actually it's great and",
    "start": "1030600",
    "end": "1038438"
  },
  {
    "text": "like I mentioned you can download all the hashes for offline use and clouds were even cached the big single fall",
    "start": "1038439",
    "end": "1043600"
  },
  {
    "text": "downloads which were like almost 15 GB they of course are compressed we're not like giving a 60 GB text file so it's",
    "start": "1043600",
    "end": "1052120"
  },
  {
    "text": "the uh single file downloads are compressed already but this this what they do and",
    "start": "1052120",
    "end": "1058160"
  },
  {
    "text": "like I said great success so we had all static data cashed for a long time or",
    "start": "1058160",
    "end": "1063200"
  },
  {
    "text": "until we purched not a 100% hit ratio because cloudfare has other customers than us so",
    "start": "1063200",
    "end": "1069679"
  },
  {
    "text": "they might they might need some space on their Edge no so they might like boot some of our stuff off their off their",
    "start": "1069679",
    "end": "1075520"
  },
  {
    "text": "cash to get make room for something else but like almost every request was going",
    "start": "1075520",
    "end": "1081360"
  },
  {
    "text": "through them and not to the origin so everything was awesome right uh is it",
    "start": "1081360",
    "end": "1089760"
  },
  {
    "text": "though so in December 2021 that's when we",
    "start": "1089760",
    "end": "1096799"
  },
  {
    "text": "actually open sourced the pawn passwords API and at the same time we got a lot of new passwords from uh the FBI and the",
    "start": "1096799",
    "end": "1103600"
  },
  {
    "text": "NCA like 225 millions of them I think the I think the number was that we we",
    "start": "1103600",
    "end": "1109480"
  },
  {
    "text": "went up from like 400 or something million or 500 something million up to like 6 or 700 so there was a very",
    "start": "1109480",
    "end": "1117320"
  },
  {
    "text": "sizable increase to the amount of data that was in the uh that was in The Blob",
    "start": "1117320",
    "end": "1124039"
  },
  {
    "text": "files and like getting a lot of new data like for this kind of service would be a good thing",
    "start": "1124039",
    "end": "1130480"
  },
  {
    "text": "right well turns out there are limits to how big a single item in the cach can be and why do I say a single",
    "start": "1130480",
    "end": "1137080"
  },
  {
    "text": "item because I mentioned the big files that you can download like The like I",
    "start": "1137080",
    "end": "1142720"
  },
  {
    "text": "want to get a zip file of all the Shan hashes like one big file 15 gab like almost 15 GB that was before they added",
    "start": "1142720",
    "end": "1150799"
  },
  {
    "text": "225 million new passwords in there so the limit for Pawn password was 15",
    "start": "1150799",
    "end": "1158399"
  },
  {
    "text": "GB and how do we know this well we can ask tooy",
    "start": "1158440",
    "end": "1163520"
  },
  {
    "text": "wallet what I mean by asking tooy wallet is this",
    "start": "1163520",
    "end": "1170080"
  },
  {
    "text": "this is this is the expenditure report Troy got that month see everything is",
    "start": "1170080",
    "end": "1176720"
  },
  {
    "text": "fine up until December 20th when it's Bill skyrocketed like absolutely",
    "start": "1176720",
    "end": "1181760"
  },
  {
    "text": "skyrocketed 11,448 Australian doll which is like I think it's around the exchange rate at",
    "start": "1181760",
    "end": "1188760"
  },
  {
    "text": "the time I think it's around like $8,000 us so we had to take a look at this like",
    "start": "1188760",
    "end": "1194799"
  },
  {
    "text": "what's going on we got to investigate so we started looking at the cloud for",
    "start": "1194799",
    "end": "1200080"
  },
  {
    "text": "dashboards and this is that uh that that day so I'm going to point a",
    "start": "1200080",
    "end": "1206919"
  },
  {
    "text": "few things out this was in 24 hours all of a sudden the origin had served 3",
    "start": "1206919",
    "end": "1212559"
  },
  {
    "text": "terab of data and it was due to cash misses now",
    "start": "1212559",
    "end": "1218840"
  },
  {
    "text": "you can see like I don't can't really tell how clear it is like the little green bar there is the text files they",
    "start": "1218840",
    "end": "1224799"
  },
  {
    "text": "were all being cached so that those weren't a problem but what it says been there the binary files the big zip text",
    "start": "1224799",
    "end": "1232039"
  },
  {
    "text": "files they were hardly ever being cached",
    "start": "1232039",
    "end": "1238919"
  },
  {
    "text": "so that was a something that was an oversight but when you have a service with this amount of traffic little",
    "start": "1238919",
    "end": "1245000"
  },
  {
    "text": "oversight can result in a pretty massive Bill uh we solved the issue by removing",
    "start": "1245000",
    "end": "1251720"
  },
  {
    "text": "the file downloads s ofile downloads put in uh like Azure",
    "start": "1251720",
    "end": "1256880"
  },
  {
    "text": "expenditure like monitors and alerting so we now get alerts if the expenditure",
    "start": "1256880",
    "end": "1262320"
  },
  {
    "text": "starts starts Rising too quickly and we to bring back the syn of all downloads We decided to create a downloader uh we",
    "start": "1262320",
    "end": "1270240"
  },
  {
    "text": "also thought use this opportunity because as we've added the API for like the FBI and others to put stuff in there",
    "start": "1270240",
    "end": "1277360"
  },
  {
    "text": "we realized that the data would be changing a lot more often than it did so we decided okay we'll just create a",
    "start": "1277360",
    "end": "1283200"
  },
  {
    "text": "downloader we'll open source it and I can just download all the files because you have a limited range of like file LS",
    "start": "1283200",
    "end": "1289480"
  },
  {
    "text": "that you can get so it's pretty easy to just go through them it's pretty much just a for",
    "start": "1289480",
    "end": "1294600"
  },
  {
    "text": "loop everything was good for a while but then we added the nlm hashes",
    "start": "1294600",
    "end": "1301600"
  },
  {
    "text": "that was February this year so adding the ntlm hashes uh was",
    "start": "1301600",
    "end": "1309000"
  },
  {
    "text": "like wasn't hard like we already had all the data so we decided okay we'll just like this was a this was like a big",
    "start": "1309000",
    "end": "1315600"
  },
  {
    "text": "feature request so we decided okay we'll just put all the Anum hashes to like new text files put that up there and update",
    "start": "1315600",
    "end": "1320960"
  },
  {
    "text": "the Azure function and we thought well everything's good until Troy slides into my DMs uh",
    "start": "1320960",
    "end": "1329080"
  },
  {
    "text": "saying like wondering why the erress data is still quite high and we it took",
    "start": "1329080",
    "end": "1334400"
  },
  {
    "text": "a while to figure this out uh but in the end it just pretty much just came down",
    "start": "1334400",
    "end": "1339600"
  },
  {
    "text": "to numbers um what happened when we actually introduced the anlm hashes was that we",
    "start": "1339600",
    "end": "1347039"
  },
  {
    "text": "added 1 million5 files again so we went from 1 million files to 2 million",
    "start": "1347039",
    "end": "1352400"
  },
  {
    "text": "files so that the amount of files that were",
    "start": "1352400",
    "end": "1357880"
  },
  {
    "text": "being increased uh basically caused Cloud to start like we were taking up",
    "start": "1357880",
    "end": "1363640"
  },
  {
    "text": "instead of taking like a million slots for the cash items we started taking 2 million and like I said they have other",
    "start": "1363640",
    "end": "1369240"
  },
  {
    "text": "customers so they might have to boot things off the cash um so items were getting like booted off their Edge cach",
    "start": "1369240",
    "end": "1376360"
  },
  {
    "text": "more frequently and unfortunately that means",
    "start": "1376360",
    "end": "1381600"
  },
  {
    "text": "that the sh one hashes which were primarily ones being fetched because this was a new feature it meant that",
    "start": "1381600",
    "end": "1387240"
  },
  {
    "text": "they started get get booting up more often and like we saw earlier when like",
    "start": "1387240",
    "end": "1392799"
  },
  {
    "text": "the cash hit rate drops the bills go up so we started talking with cloudfare",
    "start": "1392799",
    "end": "1399320"
  },
  {
    "text": "okay how can we get the cashit rate back up and Cloud for has a thing called Cloud for cash",
    "start": "1399320",
    "end": "1405799"
  },
  {
    "text": "Reserve now cash Reserve is I think it's still in beta but what it is is a cash",
    "start": "1405799",
    "end": "1411799"
  },
  {
    "text": "for the cash so we spend less",
    "start": "1411799",
    "end": "1417120"
  },
  {
    "text": "cash uh but how does it work uh it's not it's not very complex",
    "start": "1417120",
    "end": "1423120"
  },
  {
    "text": "sits between the origin and the edge nodes and it's just magic but it's not",
    "start": "1423120",
    "end": "1428960"
  },
  {
    "text": "really magic uh it's built on what they call R2 uh which is is a bit of a naming like",
    "start": "1428960",
    "end": "1436919"
  },
  {
    "text": "they're making a little bit of fun of Amazon there because they have S3 does the same thing it's S3 compatible so they call it R2 it's basically just",
    "start": "1436919",
    "end": "1443480"
  },
  {
    "text": "another like storage bucket so what they actually do is they sit between the edge",
    "start": "1443480",
    "end": "1449080"
  },
  {
    "text": "nodes and the origin and as the like request hit the origin they start saving them to uh to",
    "start": "1449080",
    "end": "1456880"
  },
  {
    "text": "their cash Reserve but to do this they have some",
    "start": "1456880",
    "end": "1462720"
  },
  {
    "text": "requirements uh CU these are things that are being stored like this is this is not just",
    "start": "1462720",
    "end": "1469279"
  },
  {
    "text": "this is no longer just living in the ate this is living in a bucket somewhere so they have some requirements like of course the data needs to be cashable um",
    "start": "1469279",
    "end": "1475840"
  },
  {
    "text": "B it is we're just like serving a bunch of text files should have time to live at least 10 hours like check um and then",
    "start": "1475840",
    "end": "1484039"
  },
  {
    "text": "needs to return a Content link header like we already know how big the files are so not a problem where is",
    "start": "1484039",
    "end": "1491200"
  },
  {
    "text": "it we thought this wasn't a problem because like we tested this of course locally and we always got a Content",
    "start": "1491200",
    "end": "1497399"
  },
  {
    "text": "length header but when we pushed it to Azure we stopped getting the cont length header",
    "start": "1497399",
    "end": "1503399"
  },
  {
    "text": "and we were trying to figure out what's going on now Azure which in this case like has",
    "start": "1503399",
    "end": "1510919"
  },
  {
    "text": "I serving this data they saw that the requests were coming in for text files",
    "start": "1510919",
    "end": "1516360"
  },
  {
    "text": "and text files are not jpegs or zip files so they're usually uncompressed",
    "start": "1516360",
    "end": "1521600"
  },
  {
    "text": "data so I in Azure thought hey I'm just going to be I'm just going to be helpful this is static data I'm just going to",
    "start": "1521600",
    "end": "1527720"
  },
  {
    "text": "dynamically compress it on the way out as I'm responding so trying to be helpful I",
    "start": "1527720",
    "end": "1533440"
  },
  {
    "text": "guess uh but the way Dynamic compression works is it gets the actual data and it",
    "start": "1533440",
    "end": "1540000"
  },
  {
    "text": "as it's streaming it out it just compresses it that is if the client actually can handle",
    "start": "1540000",
    "end": "1545799"
  },
  {
    "text": "it but I'm wondering if any of you can spot the problem",
    "start": "1545799",
    "end": "1551720"
  },
  {
    "text": "here so like I said it's dynamically compressing things so it doesn't know",
    "start": "1552120",
    "end": "1559039"
  },
  {
    "text": "how big the response is going to be until it's finished responding so is it ringing any",
    "start": "1559039",
    "end": "1566440"
  },
  {
    "text": "bells what's the first thing that gets as like the first part of the response",
    "start": "1566440",
    "end": "1571919"
  },
  {
    "text": "from HP server it's the headers right the headers include content length",
    "start": "1571919",
    "end": "1579120"
  },
  {
    "text": "which should tell you how big the response is going to be but as as is responding it doesn't know how big the response is going to be because it's not",
    "start": "1579120",
    "end": "1584919"
  },
  {
    "text": "done compressing it it doesn't compress it all in memory because if you would serving a 15 GB file like You' be taking",
    "start": "1584919",
    "end": "1590520"
  },
  {
    "text": "up all the memory on the server so as the response heads are sent",
    "start": "1590520",
    "end": "1595919"
  },
  {
    "text": "before the actual response is sent well obviously uh it removes the content",
    "start": "1595919",
    "end": "1603880"
  },
  {
    "text": "length header and this took a while to figure out but we thought all right they are",
    "start": "1603880",
    "end": "1610520"
  },
  {
    "text": "compressing the data like because they they're trying to be helpful and makes sense for like most use cases but we'll",
    "start": "1610520",
    "end": "1616720"
  },
  {
    "text": "just go ahead and disable the compression natur Dynamic compression but we",
    "start": "1616720",
    "end": "1623000"
  },
  {
    "text": "can't and I can tell you I really really tried I think I tried every possible setting I could find even some settings",
    "start": "1623000",
    "end": "1629120"
  },
  {
    "text": "I probably shouldn't have found um try to mess with I tried to mess with like configuration files and everything else",
    "start": "1629120",
    "end": "1635120"
  },
  {
    "text": "to turn this off until I finally just basically got a response saying nope sorry you",
    "start": "1635120",
    "end": "1640840"
  },
  {
    "text": "can't and upon re receiving the response this was sort of my reaction uh I was not happy",
    "start": "1640840",
    "end": "1650000"
  },
  {
    "text": "because this was a requirement for us to be able to put the cash Reserve in there and while we couldn't fix this like the",
    "start": "1650000",
    "end": "1655159"
  },
  {
    "text": "bills are just going up so I started thinking a lot about it but I actually did find the fix in the",
    "start": "1655159",
    "end": "1661320"
  },
  {
    "text": "end though so this is me hitting the uh development like Azure function directly",
    "start": "1661320",
    "end": "1666360"
  },
  {
    "text": "not going through Cloud FL as you can see I'm like the content encoding V that means broadly that means",
    "start": "1666360",
    "end": "1672559"
  },
  {
    "text": "it's compressed and I'm getting a Content length header back now",
    "start": "1672559",
    "end": "1679240"
  },
  {
    "text": "this was not this was not the cleanest solution but I figured hey like if I",
    "start": "1679240",
    "end": "1685200"
  },
  {
    "text": "just compress the response before I gets it there's no reason for is to compress it so in the aure function because I can",
    "start": "1685200",
    "end": "1693279"
  },
  {
    "text": "assume or like I can assume I know that the files are not that big I can allow myself the luxury of just reading them",
    "start": "1693279",
    "end": "1698840"
  },
  {
    "text": "all into memory compressing them there and then just handing is back the compressed response so that's pretty",
    "start": "1698840",
    "end": "1705080"
  },
  {
    "text": "much what I'm doing I'm just taking over the responsibility of of doing the compression depending on if the client",
    "start": "1705080",
    "end": "1711080"
  },
  {
    "text": "supports compression or not so went through the requirements so now",
    "start": "1711080",
    "end": "1717600"
  },
  {
    "text": "we fulfill all the requirements and upon seeing this work I was quite",
    "start": "1717600",
    "end": "1724480"
  },
  {
    "text": "happy uh so this is the current",
    "start": "1724960",
    "end": "1730279"
  },
  {
    "text": "situation uh with the functions this is a single day of requests going into um",
    "start": "1730279",
    "end": "1738200"
  },
  {
    "text": "into Cloud for the for the hash ranges and as you can see like we get",
    "start": "1738200",
    "end": "1744240"
  },
  {
    "text": "16731 million request and 16731 million requests are served by Cloud 184 went to",
    "start": "1744240",
    "end": "1751320"
  },
  {
    "text": "the origin which if you put this into numbers it's a",
    "start": "1751320",
    "end": "1758159"
  },
  {
    "text": "99.9999% hit ratio which is literally one in a million so like you can actually see when you're doing Quest 2",
    "start": "1758159",
    "end": "1764320"
  },
  {
    "text": "Cloud flare you can see the response headers if it was a c hit or not so if you ever look at the cash headers uh",
    "start": "1764320",
    "end": "1770919"
  },
  {
    "text": "coming from the P password API and you see a cash miss you can be pretty happy because you're literally one in a million uh right",
    "start": "1770919",
    "end": "1778640"
  },
  {
    "text": "there so this was this was pretty sucessful and this is actually something that we did just like 3 months",
    "start": "1778640",
    "end": "1786720"
  },
  {
    "text": "ago so okay we thought okay let's wrap things up without the cloud FL caching",
    "start": "1786720",
    "end": "1794320"
  },
  {
    "text": "uh the as reg fees and read operations like I said would exceed $12,000 month and that is not really sustainable if",
    "start": "1794320",
    "end": "1800399"
  },
  {
    "text": "you're trying to run a free service uh especially if there's just like one person paying for all",
    "start": "1800399",
    "end": "1806240"
  },
  {
    "text": "this the a network Eis fees are free because they say like the first 100 gbt",
    "start": "1806240",
    "end": "1812960"
  },
  {
    "text": "are free and we like since we put in Cloud for cash Reserve we never exceed that so we're not paying any e fees",
    "start": "1812960",
    "end": "1818919"
  },
  {
    "text": "anymore at least from last year the storage BL read operations are free as well because they give you 10,000 read",
    "start": "1818919",
    "end": "1824960"
  },
  {
    "text": "operations per month and we never actually hit those unless we actually purchas the cash which is",
    "start": "1824960",
    "end": "1831360"
  },
  {
    "text": "rare so the entire Azure storage bill right now is just like",
    "start": "1831360",
    "end": "1837279"
  },
  {
    "text": "$1.25 for the 60 GB we store in the blob storage cler does not build EAS fees and",
    "start": "1837279",
    "end": "1844919"
  },
  {
    "text": "this is what actually makes this possible but for cash Reserve they actually do bill you for the amount of",
    "start": "1844919",
    "end": "1850799"
  },
  {
    "text": "data stored and how many operations they have to read from the storage similar to The aure Blob storage they have to store",
    "start": "1850799",
    "end": "1856840"
  },
  {
    "text": "a lot of data and it's not free so they bill you for reads rights uh and",
    "start": "1856840",
    "end": "1862519"
  },
  {
    "text": "usually rights aren't that many they're like we only write to the cash Reserve like I said when we purchas the cash but",
    "start": "1862519",
    "end": "1869480"
  },
  {
    "text": "otherwise we're just reading from it and usually the edge nodes are taking like uh a bunch of the hits so that's not big",
    "start": "1869480",
    "end": "1877080"
  },
  {
    "text": "either so I think the total amounts to like $16.5 us per month like I said earlier we before we actually hit cash",
    "start": "1877080",
    "end": "1883679"
  },
  {
    "text": "reserve and before we actually started getting all the cashes evicted we calculated would be around $67 per month",
    "start": "1883679",
    "end": "1889519"
  },
  {
    "text": "but like after adding the nlm hashes that would have been rising pretty quickly so 16.5 us per month instead of",
    "start": "1889519",
    "end": "1897200"
  },
  {
    "text": "12,000 is pretty much a 99% saving so recapping all of this like",
    "start": "1897200",
    "end": "1905519"
  },
  {
    "text": "sort of what what we've learned from all this is well the obvious the obvious learning from this is Cash static data",
    "start": "1905519",
    "end": "1911120"
  },
  {
    "text": "there's no reason for you to spend CPU Cycles or memory or whatever on constantly serving data that's never",
    "start": "1911120",
    "end": "1917240"
  },
  {
    "text": "going to change like you can you can just cach it and return it like that",
    "start": "1917240",
    "end": "1922399"
  },
  {
    "text": "directly if you have static data with like long lifetimes for example if",
    "start": "1922399",
    "end": "1928200"
  },
  {
    "text": "you're serving let's say zip files that rarely change or you're serving images that rarely change or like you rarely",
    "start": "1928200",
    "end": "1934519"
  },
  {
    "text": "update a CSS or whatever should think about serving it over a CDN because that",
    "start": "1934519",
    "end": "1939919"
  },
  {
    "text": "will actually bring that data a lot closer to the users so it'll be a lot faster to fetch it and it's never going",
    "start": "1939919",
    "end": "1945120"
  },
  {
    "text": "to hit your servers at least rarely uh only the scheme and the host in a URL",
    "start": "1945120",
    "end": "1953039"
  },
  {
    "text": "are case insensitive it's what I was explaining with the URL normalization so these two URLs are not the same and not",
    "start": "1953039",
    "end": "1960039"
  },
  {
    "text": "not according to web servers a lot of web servers they do automatically like if they would get one of these and they",
    "start": "1960039",
    "end": "1965639"
  },
  {
    "text": "were like working against the case senstive File system and not finding they would just try okay can I find another file that",
    "start": "1965639",
    "end": "1970880"
  },
  {
    "text": "fits but you should never assume that uh the URLs are or whatever is serving the",
    "start": "1970880",
    "end": "1976440"
  },
  {
    "text": "URLs is is uh case insensitive you need to make sure that",
    "start": "1976440",
    "end": "1982679"
  },
  {
    "text": "you can easily Purge or invalidate the cach when you have like either on your side or the CDN uh thankfully like",
    "start": "1982679",
    "end": "1989200"
  },
  {
    "text": "cloudfare uh Asher like Asher CDN Amazon cloudfront they all have apis that that do this for",
    "start": "1989200",
    "end": "1995600"
  },
  {
    "text": "you or dashboards where you can like click a button and do this uh to make it easier but a good thing to also think",
    "start": "1995600",
    "end": "2001559"
  },
  {
    "text": "about is for example in the case of CSS or JavaScript uh it would be good for you to just not have like my site. Js",
    "start": "2001559",
    "end": "2009720"
  },
  {
    "text": "and when it changes then users are not going to get the new version because all of them have cached it it would be good for example to append something to the",
    "start": "2009720",
    "end": "2016440"
  },
  {
    "text": "file name like the hash of the file or something else because then if the file changes you'll be getting a different file",
    "start": "2016440",
    "end": "2022240"
  },
  {
    "text": "name so that's uh that's a good thing to do as well be aware of caching limits in our",
    "start": "2022240",
    "end": "2028799"
  },
  {
    "text": "case the the 15 GB one was like it was not really well documented it's not sort",
    "start": "2028799",
    "end": "2035240"
  },
  {
    "text": "of an extreme case but usually the CD intercast providers will actually tell you like you know you need to do this",
    "start": "2035240",
    "end": "2041159"
  },
  {
    "text": "and this and this for everything to work one of them is for example the headers make sure that they comply with whatever",
    "start": "2041159",
    "end": "2047559"
  },
  {
    "text": "the CDN requirements you have because otherwise you're putting a CD in front it's not going to do anything because you're not telling it the correct things",
    "start": "2047559",
    "end": "2053200"
  },
  {
    "text": "to do and that sort of that sort of brings it down to the um",
    "start": "2053200",
    "end": "2061280"
  },
  {
    "text": "the gist of it of of actually how this is done I mean like none of this is really complex for ex especially for",
    "start": "2061280",
    "end": "2067480"
  },
  {
    "text": "static data but as soon as you start getting Dynamic data there are all the things you have to think about",
    "start": "2067480",
    "end": "2073679"
  },
  {
    "text": "now I decided to uh leave a lot of room for questions if you have any",
    "start": "2073679",
    "end": "2079480"
  },
  {
    "text": "um this is it's not a topic that like a lot of people think about but probably",
    "start": "2079480",
    "end": "2085200"
  },
  {
    "text": "should if you're serving any kind of data so if you have any feel free to bring them",
    "start": "2085200",
    "end": "2092079"
  },
  {
    "text": "on AF might change",
    "start": "2092720",
    "end": "2098240"
  },
  {
    "text": "so the question is are we afraid that cloudfl might change his pricing policy uh no not at the moment at least uh",
    "start": "2098240",
    "end": "2106920"
  },
  {
    "text": "they they like make themselves out to be like uh say they make themselves out to",
    "start": "2106920",
    "end": "2113119"
  },
  {
    "text": "be fast and have these pricing policies usually for these big companies when they're changing their pricing policies",
    "start": "2113119",
    "end": "2119040"
  },
  {
    "text": "they usually get a very big hats up or like at least some some uh a very good",
    "start": "2119040",
    "end": "2124640"
  },
  {
    "text": "time in advance for you to actually respond to it so it's not really something we're worried about at the moment at",
    "start": "2124640",
    "end": "2131240"
  },
  {
    "text": "least anyone else",
    "start": "2131240",
    "end": "2136119"
  },
  {
    "text": "yeah so the question is like because we're storing the fouls based on the",
    "start": "2147440",
    "end": "2152800"
  },
  {
    "text": "first five digits of the hash like would it make a difference if we put it down to six uh the difference would be that",
    "start": "2152800",
    "end": "2160680"
  },
  {
    "text": "well the obvious difference would be we go from 1 million files to 16 million files",
    "start": "2160680",
    "end": "2166200"
  },
  {
    "text": "um so then now this is sort of a convenience thing but like the more digits we actually put in the hash the",
    "start": "2166200",
    "end": "2173599"
  },
  {
    "text": "more chances are of someone actually identifying what password you're looking up because we'd be giving like uh we'd",
    "start": "2173599",
    "end": "2180000"
  },
  {
    "text": "be giving servers or everyone in the middle proxy servers like more information even if it's just six digits",
    "start": "2180000",
    "end": "2185800"
  },
  {
    "text": "but you've you've cut the you've got the like possibilities of the passwords down a lot they will be would be smaller",
    "start": "2185800",
    "end": "2192400"
  },
  {
    "text": "files that be returning but we found that five digits uh pretty much The Sweet Spot",
    "start": "2192400",
    "end": "2199280"
  },
  {
    "text": "there anyone",
    "start": "2200839",
    "end": "2204160"
  },
  {
    "text": "else all right so thank you very much then uh you can find my blog if you want",
    "start": "2207480",
    "end": "2214240"
  },
  {
    "text": "find me on Twitter send me an email if you have more questions I have a bunch of iin P stickers here in front which",
    "start": "2214240",
    "end": "2219599"
  },
  {
    "text": "you can feel free to grab if you want um don't forget the feedback on your way out and enjoy the rest of NC thank you",
    "start": "2219599",
    "end": "2225760"
  },
  {
    "text": "very much",
    "start": "2225760",
    "end": "2228920"
  }
]