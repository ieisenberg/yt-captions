[
  {
    "text": "welcome everyone to my talk called the privileg escalation in Microsoft Azure",
    "start": "4560",
    "end": "10360"
  },
  {
    "text": "uh my name is Christian uh and uh uh first a little bit about myself uh I",
    "start": "10360",
    "end": "18760"
  },
  {
    "text": "work as a uh pentester with application security and security Engineering in a",
    "start": "18760",
    "end": "25359"
  },
  {
    "text": "company called binary security and uh uh uh I'm uh in my",
    "start": "25359",
    "end": "32520"
  },
  {
    "text": "day-to-day job I'm mostly working with hacking and securing Cloud environments for European clients mostly in",
    "start": "32520",
    "end": "40440"
  },
  {
    "text": "Azure uh I also do some vulnerability Research into various uh Cloud providers",
    "start": "40440",
    "end": "47120"
  },
  {
    "text": "previously I've done most uh Research into Google Cloud platform uh because they are good to",
    "start": "47120",
    "end": "55320"
  },
  {
    "text": "work with and they pay nice bounties but in recent years I've been working mostly",
    "start": "55320",
    "end": "60519"
  },
  {
    "text": "with Asher uh just because that's what I work most with uh in my day",
    "start": "60519",
    "end": "67960"
  },
  {
    "text": "job uh so the agenda for today is as follows uh this talk will focus on",
    "start": "68000",
    "end": "74680"
  },
  {
    "text": "privilege escalation in micros Microsoft uh Azure using something called Azure",
    "start": "74680",
    "end": "79720"
  },
  {
    "text": "Resource Management API uh often referred to as arm so whenever I'm saying arm I'm uh referring",
    "start": "79720",
    "end": "87799"
  },
  {
    "text": "to this resource manager API uh and uh basically the r API is just",
    "start": "87799",
    "end": "94280"
  },
  {
    "text": "the uh the API for doing everything uh related to management in in Azure no",
    "start": "94280",
    "end": "100560"
  },
  {
    "text": "matter what uh kind of client you're using uh first I'll give an introduction",
    "start": "100560",
    "end": "107119"
  },
  {
    "text": "to to what the RM API is uh and give my impression of uh how authorization is",
    "start": "107119",
    "end": "113640"
  },
  {
    "text": "handled there because that's important for the concept of privilege escalation uh I'll also touched briefly",
    "start": "113640",
    "end": "120640"
  },
  {
    "text": "on uh uh azure's role based access control for access to Azure",
    "start": "120640",
    "end": "126039"
  },
  {
    "text": "resources uh that is used in in arm uh after that I'm going to uh show",
    "start": "126039",
    "end": "132840"
  },
  {
    "text": "you the methodology for finding bugs in uh the arm API or in Microsoft",
    "start": "132840",
    "end": "139000"
  },
  {
    "text": "AER uh so if you're into finding bugs uh",
    "start": "139000",
    "end": "144160"
  },
  {
    "text": "I'll show you some cool tricks uh and you can definitely go home and find similar bugs yourself because the ones",
    "start": "144160",
    "end": "150360"
  },
  {
    "text": "I'm going to show you are quite simple uh and after that I'll take you",
    "start": "150360",
    "end": "155879"
  },
  {
    "text": "through some uh some vulnerabilities that uh uh we in binary security have",
    "start": "155879",
    "end": "161080"
  },
  {
    "text": "found in Azure uh and when I'm talking about bugs I'm referring to bugs in the core Azure",
    "start": "161080",
    "end": "169959"
  },
  {
    "text": "platform not like misconfigurations and stuff so uh this is bugs that everybody",
    "start": "169959",
    "end": "176319"
  },
  {
    "text": "is vulnerable to uh by default unless they do some specific configurations",
    "start": "176319",
    "end": "182440"
  },
  {
    "text": "which I'll get back to uh so some of the bugs that I am going to talk about are are still",
    "start": "182440",
    "end": "189560"
  },
  {
    "text": "unfixed uh even though I responsibly disclosed them to Microsoft years",
    "start": "189560",
    "end": "195319"
  },
  {
    "text": "ago uh [Music] so if everything is going according to",
    "start": "195319",
    "end": "201799"
  },
  {
    "text": "plan I'm going to exploit the bugs that are unfixed in a live running environment which is of course uh what",
    "start": "201799",
    "end": "209280"
  },
  {
    "text": "can go wrong with that plan uh and for the vulnerabilities that",
    "start": "209280",
    "end": "216200"
  },
  {
    "text": "I will present I can't cover all resources because Azure is huge I will focus on a couple of uh much used ones",
    "start": "216200",
    "end": "223560"
  },
  {
    "text": "uh namely Azure API management and um app Services um but focused on web uh",
    "start": "223560",
    "end": "232920"
  },
  {
    "text": "apps and function apps so uh motivation for this talk both",
    "start": "232920",
    "end": "240680"
  },
  {
    "text": "from my uh side and uh possibly for you as listeners is that exploiting the RM",
    "start": "240680",
    "end": "246879"
  },
  {
    "text": "API really often Works uh when we are hacking live",
    "start": "246879",
    "end": "253319"
  },
  {
    "text": "environments uh for customers and such we uh are not always using the arm API",
    "start": "253319",
    "end": "260519"
  },
  {
    "text": "in our exploitation we also uh exploit a lot of misconfigurations in ENT Tri ID",
    "start": "260519",
    "end": "266479"
  },
  {
    "text": "uh and uh what accounts actually has access to the resource and stuff uh but",
    "start": "266479",
    "end": "272280"
  },
  {
    "text": "that's not as interesting uh in this context because that's well documented",
    "start": "272280",
    "end": "278080"
  },
  {
    "text": "and uh you can find information about that uh other",
    "start": "278080",
    "end": "283800"
  },
  {
    "text": "places uh additionally people assume uh at least people I talk to developers and",
    "start": "283800",
    "end": "290639"
  },
  {
    "text": "admins uh who use AER uh often assume that the cloud is secure as long as you",
    "start": "290639",
    "end": "298199"
  },
  {
    "text": "uh follow the documentation and configure it the way Microsoft says that you should configure it but as we will",
    "start": "298199",
    "end": "304800"
  },
  {
    "text": "see soon that's not always the case uh so we in B security as well have",
    "start": "304800",
    "end": "312400"
  },
  {
    "text": "not really looked into all the resources in Azure we have only barely scratched the surface of the resource types and",
    "start": "312400",
    "end": "319039"
  },
  {
    "text": "the arm API so uh there's bound to be more bugs there and every time I do like",
    "start": "319039",
    "end": "326319"
  },
  {
    "text": "some research into this uh I find more bugs so uh it's definitely a good place to do",
    "start": "326319",
    "end": "332680"
  },
  {
    "text": "research as well uh and there's even the possibility of bounties uh if you find",
    "start": "332680",
    "end": "338720"
  },
  {
    "text": "vulnerabilities that Microsoft are willing to accept as new vulnerabilities uh but most important",
    "start": "338720",
    "end": "345479"
  },
  {
    "text": "though uh in the context of NDC security is that uh developers are really often",
    "start": "345479",
    "end": "353440"
  },
  {
    "text": "responsible for uh configuring the cloud",
    "start": "353440",
    "end": "358520"
  },
  {
    "text": "infrastructure uh in addition to actually writing the code of the application or what they are going to",
    "start": "358520",
    "end": "364639"
  },
  {
    "text": "run there uh so my take on this is that the uh a bug in the application code uh",
    "start": "364639",
    "end": "373479"
  },
  {
    "text": "that is written by the developer can be more or less damaging to the security of the system as a whole uh normally it's",
    "start": "373479",
    "end": "381639"
  },
  {
    "text": "not that big of a deal uh it can be but normally it's like minor vulnerabilities",
    "start": "381639",
    "end": "387479"
  },
  {
    "text": "such as crossy scripting and stuff uh but a vulnerability in the core Cloud",
    "start": "387479",
    "end": "394840"
  },
  {
    "text": "components uh that uh for instance leaks uh static secret that will give forever",
    "start": "394840",
    "end": "402199"
  },
  {
    "text": "access to some resource that is in the cloud uh will always be",
    "start": "402199",
    "end": "407560"
  },
  {
    "text": "catastrophic uh and of course the the aspect of everyone being vulnerable if",
    "start": "407560",
    "end": "413000"
  },
  {
    "text": "there is a bug there uh and uh addition if you know the",
    "start": "413000",
    "end": "420400"
  },
  {
    "text": "details of how a cloud resource can be configured all the uh attributes that",
    "start": "420400",
    "end": "427440"
  },
  {
    "text": "you can set on a resource then uh you can secure it better because you",
    "start": "427440",
    "end": "434960"
  },
  {
    "text": "can understand what can be uh turned on and off and most settings in Microsoft",
    "start": "434960",
    "end": "442160"
  },
  {
    "text": "Azure is uh not secure by default so we have to activate some kind of toggle or",
    "start": "442160",
    "end": "450319"
  },
  {
    "text": "a bully in in the uh resource configuration for it to be more",
    "start": "450319",
    "end": "457560"
  },
  {
    "text": "secure so let's jump right into the RM API uh what I'm talking about here like",
    "start": "457560",
    "end": "465919"
  },
  {
    "text": "HTTP request wise are all the apis that run behind this management. azure.com",
    "start": "465919",
    "end": "474240"
  },
  {
    "text": "domain uh and uh what the RM API is is that m m l it acts as a mediator uh",
    "start": "474520",
    "end": "482440"
  },
  {
    "text": "between all the clients uh using or managing resources in Azure such as the",
    "start": "482440",
    "end": "489319"
  },
  {
    "text": "Azure portal the Azure CLI uh or by proxy",
    "start": "489319",
    "end": "495479"
  },
  {
    "text": "terraform uh or whatever you are using to to create and modify",
    "start": "495479",
    "end": "501240"
  },
  {
    "text": "resources uh it's been around since 2004 14ish uh replacing some Legacy solution",
    "start": "501240",
    "end": "508199"
  },
  {
    "text": "which is now disabled uh it has automated",
    "start": "508199",
    "end": "513240"
  },
  {
    "text": "documentation uh the entire API which is nice uh but certain endpoint end points",
    "start": "513240",
    "end": "520360"
  },
  {
    "text": "are undocumented as we have found and uh uh that's interesting in the context of",
    "start": "520360",
    "end": "526600"
  },
  {
    "text": "this talk because that's a that's one of the things that we're going to exploit later uh another interesting uh thing is",
    "start": "526600",
    "end": "534880"
  },
  {
    "text": "that the arm API normally handles and terminates the authorization so",
    "start": "534880",
    "end": "541320"
  },
  {
    "text": "you when you're managing resource you're sending your access token to the arm API",
    "start": "541320",
    "end": "546839"
  },
  {
    "text": "uh the arm API does some magic thing removes your token adds its own token",
    "start": "546839",
    "end": "553000"
  },
  {
    "text": "and then forwards the request to the backend resource which actually uh does",
    "start": "553000",
    "end": "558079"
  },
  {
    "text": "the change or is the data uh so that makes it a great Target",
    "start": "558079",
    "end": "563560"
  },
  {
    "text": "for privilege escalation uh vulnerabilities and also other kinds of bugs but today we're focusing on",
    "start": "563560",
    "end": "569920"
  },
  {
    "text": "privilege escalation uh it's also backwards compatible by using API versions in the",
    "start": "569920",
    "end": "576279"
  },
  {
    "text": "URL uh which is also an important point for this talk uh",
    "start": "576279",
    "end": "582800"
  },
  {
    "text": "and so they release new API versions every now and then uh but the old API",
    "start": "582800",
    "end": "589200"
  },
  {
    "text": "version will still uh exist after it has been",
    "start": "589200",
    "end": "595000"
  },
  {
    "text": "deprecated uh so since we're talking about PR escalation we need to have a look at the authorization",
    "start": "596640",
    "end": "603920"
  },
  {
    "text": "logic uh so this is kind of my take on",
    "start": "603920",
    "end": "609320"
  },
  {
    "text": "how authorization in the RM API works it's closed source so I don't really know but uh from Microsoft documentation",
    "start": "609320",
    "end": "616640"
  },
  {
    "text": "and some of my uh own and my colleagues experimentation I have kind of uh",
    "start": "616640",
    "end": "622760"
  },
  {
    "text": "figured out this uh and the arm API permissions are set through uh these",
    "start": "622760",
    "end": "630320"
  },
  {
    "text": "permission strings that looks something like this uh it has uh a provider name",
    "start": "630320",
    "end": "636720"
  },
  {
    "text": "or a company which is almost always Microsoft and a provider name for the uh",
    "start": "636720",
    "end": "642680"
  },
  {
    "text": "the API uh what the the API is and then a resource type and uh finally an",
    "start": "642680",
    "end": "650320"
  },
  {
    "text": "action uh and this action can be one of read write delete and action so this is",
    "start": "650320",
    "end": "657399"
  },
  {
    "text": "an example of",
    "start": "657399",
    "end": "661240"
  },
  {
    "text": "uh this is an example of uh uh permission string for reading app",
    "start": "663639",
    "end": "668800"
  },
  {
    "text": "service sites uh so in this example the first one microsoft. web is a provider",
    "start": "668800",
    "end": "674560"
  },
  {
    "text": "name and then resource type is the sites host runtime host and the action is read",
    "start": "674560",
    "end": "681399"
  },
  {
    "text": "so um by default the action uh the red",
    "start": "681399",
    "end": "686600"
  },
  {
    "text": "part translates to an http verb directly so in this example right here if we have",
    "start": "686600",
    "end": "693720"
  },
  {
    "text": "read permission on the resource type sites host runtime host then we can do",
    "start": "693720",
    "end": "699120"
  },
  {
    "text": "get request to the corresponding arm API and uh that's the bottom image there",
    "start": "699120",
    "end": "706079"
  },
  {
    "text": "I just uh kind of a pseudo get request there uh to that endo and I get the 200",
    "start": "706079",
    "end": "712720"
  },
  {
    "text": "okay back because I have the reader permission on that resource uh a post request to to the",
    "start": "712720",
    "end": "719399"
  },
  {
    "text": "same API will fail if the user only has the read permission as we can see in this example",
    "start": "719399",
    "end": "724920"
  },
  {
    "text": "here and then when you get this error message uh the client uh and S user",
    "start": "724920",
    "end": "730760"
  },
  {
    "text": "principal name with object ID so and so on does not have",
    "start": "730760",
    "end": "736120"
  },
  {
    "text": "authorization uh to do this to make a post request you typically need either the right uh or action",
    "start": "736760",
    "end": "745680"
  },
  {
    "text": "action uh so in typical Microsoft uh uh",
    "start": "745680",
    "end": "751720"
  },
  {
    "text": "way uh they have named one of the actions action just to confuse",
    "start": "751720",
    "end": "757560"
  },
  {
    "text": "people uh so this is how uh they do role-based access control uh and these permission",
    "start": "757560",
    "end": "766399"
  },
  {
    "text": "strings on on one user object often gets a role and one role corresponds to a",
    "start": "766399",
    "end": "772079"
  },
  {
    "text": "whole bunch of permission strings uh so just for Simplicity today",
    "start": "772079",
    "end": "777240"
  },
  {
    "text": "we will be focusing on buil-in which is mostly used as well you had the built-in roll uh reader uh which is",
    "start": "777240",
    "end": "784639"
  },
  {
    "text": "supposed to give access to read resources and you have contributor which is supposed to give access to",
    "start": "784639",
    "end": "791079"
  },
  {
    "text": "change some if not all aspects of a resource and you have the owner role as",
    "start": "791079",
    "end": "796120"
  },
  {
    "text": "well which is uh just uh contributor and then some user access uh",
    "start": "796120",
    "end": "802440"
  },
  {
    "text": "um like you can add new users to to roles as",
    "start": "802440",
    "end": "807959"
  },
  {
    "text": "well uh uh so with this knowledge",
    "start": "807959",
    "end": "813839"
  },
  {
    "text": "uh about at least my assumption of how arm authorization Works let's try to",
    "start": "813839",
    "end": "821000"
  },
  {
    "text": "find a pattern on where privilege escalation bugs can be and before I go to the next slide do anyone like uh want",
    "start": "821000",
    "end": "830560"
  },
  {
    "text": "to have a guess at what kind of HTTP request for instance can lead to",
    "start": "830560",
    "end": "836079"
  },
  {
    "text": "vulnerabilities here if not I will spoil it and say that the",
    "start": "836079",
    "end": "843519"
  },
  {
    "text": "get requests can because as I said if you have the reader role uh you will",
    "start": "843519",
    "end": "849000"
  },
  {
    "text": "have all the read permission strings on all the resources and you can uh call all the",
    "start": "849000",
    "end": "855279"
  },
  {
    "text": "geta endpoints on the arm API and because of this every sensitive",
    "start": "855279",
    "end": "860800"
  },
  {
    "text": "geta endpoint is a risk and uh uh because the RM API",
    "start": "860800",
    "end": "868240"
  },
  {
    "text": "terminates the user authorization context then you will always get access",
    "start": "868240",
    "end": "874880"
  },
  {
    "text": "to what's whatever is back end if you can set send the get request to the arm API so there's been a lot of these bugs",
    "start": "874880",
    "end": "882680"
  },
  {
    "text": "where a get request to the r API returns something something sensitive or causes",
    "start": "882680",
    "end": "888320"
  },
  {
    "text": "a change and Microsoft has applied patches over the years to some of these uh we in",
    "start": "888320",
    "end": "896120"
  },
  {
    "text": "binary security have found a bunch of bugs using two good tricks which I'm going to detail for you uh",
    "start": "896120",
    "end": "904759"
  },
  {
    "text": "today one of them is to find undocumented endpoints so endpoints that",
    "start": "904759",
    "end": "910279"
  },
  {
    "text": "are not documented in official rest API documentation for for arm and the other is to go back in time uh if you remember",
    "start": "910279",
    "end": "917800"
  },
  {
    "text": "when I spoke about these API versions and use an earlier uh API versions that I have not have the patches from",
    "start": "917800",
    "end": "924279"
  },
  {
    "text": "Microsoft retrofitted which is surprisingly common",
    "start": "924279",
    "end": "929759"
  },
  {
    "text": "uh so finally I'll show you some uh examples of the bugs we found after we gone through these tricks in a bit more",
    "start": "929759",
    "end": "939680"
  },
  {
    "text": "detail so first one uh is undocumented endpoints I don't know if how well you",
    "start": "939680",
    "end": "946959"
  },
  {
    "text": "can see this but this is just a screen cap of uh how the rest API documentation",
    "start": "946959",
    "end": "952040"
  },
  {
    "text": "looks like uh and here we are on the API management uh",
    "start": "952040",
    "end": "959279"
  },
  {
    "text": "arm API provider and the user uh resource type and you can see in this",
    "start": "959279",
    "end": "966160"
  },
  {
    "text": "list right here all the operations on the user API so we have create or update",
    "start": "966160",
    "end": "972079"
  },
  {
    "text": "delete generate so URL get get shed access token list by services and and so",
    "start": "972079",
    "end": "980120"
  },
  {
    "text": "on um uh luckily for us there are a bunch",
    "start": "980680",
    "end": "989480"
  },
  {
    "text": "of API endpoints that are not automatically documented for some",
    "start": "989480",
    "end": "994920"
  },
  {
    "text": "reason um but most of the permission strings and most most of the actions are",
    "start": "994920",
    "end": "1002040"
  },
  {
    "text": "documented in the role-based access control documentation so this can be either",
    "start": "1002040",
    "end": "1008240"
  },
  {
    "text": "found from uh documentation website or uh they can be uh found in this",
    "start": "1008240",
    "end": "1015120"
  },
  {
    "text": "operations API which is present on all",
    "start": "1015120",
    "end": "1020839"
  },
  {
    "text": "providers uh so this example here is the operations API from uh uh API",
    "start": "1020959",
    "end": "1027839"
  },
  {
    "text": "management and each of these permission string names uh it doesn't map directly to uh",
    "start": "1027839",
    "end": "1037319"
  },
  {
    "text": "the uh API endpoint necessarily but it's pretty close so normally you can guess",
    "start": "1037319",
    "end": "1043880"
  },
  {
    "text": "what the corresponding API endpoint is",
    "start": "1043880",
    "end": "1048880"
  },
  {
    "text": "uh and uh the keys endpoint which I show you which is on the example here is not",
    "start": "1050200",
    "end": "1058640"
  },
  {
    "text": "in the rest API docs if you pay attention uh on the user object there is no keys endpoint in the official",
    "start": "1058640",
    "end": "1065840"
  },
  {
    "text": "documentation but it is callable and it is uh documented in the role-based access",
    "start": "1065840",
    "end": "1071559"
  },
  {
    "text": "control and uh this key endpoint uh used to contain a bug that would allow us to",
    "start": "1071559",
    "end": "1078159"
  },
  {
    "text": "do privileges escalation so that's one of the things I'm going to to show you later but it",
    "start": "1078159",
    "end": "1084240"
  },
  {
    "text": "has been patched now this particular bug uh second trick I'm going to focus",
    "start": "1084240",
    "end": "1090880"
  },
  {
    "text": "on is to go back in time so the r API is",
    "start": "1090880",
    "end": "1096640"
  },
  {
    "text": "backwards compatible all the way to 2014 in most cases so the reason for this is that if",
    "start": "1096640",
    "end": "1104679"
  },
  {
    "text": "you write automation to use the arm API",
    "start": "1104679",
    "end": "1109799"
  },
  {
    "text": "sorry my voice is giving in uh then uh",
    "start": "1109799",
    "end": "1115000"
  },
  {
    "text": "that automation that you write should be continue to work even though they replace the API with a new version so",
    "start": "1115000",
    "end": "1121320"
  },
  {
    "text": "that's Microsoft uh Microsoft's uh uh reason for having this backwards",
    "start": "1121320",
    "end": "1129039"
  },
  {
    "text": "compatibility uh and if you call the uh one of the RM apis for one provider with",
    "start": "1130039",
    "end": "1137600"
  },
  {
    "text": "just gibberish in the uh API version query parameter you will get returned all the different",
    "start": "1137600",
    "end": "1144919"
  },
  {
    "text": "available uh API versions for that API which is really useful if you want to find",
    "start": "1144919",
    "end": "1151760"
  },
  {
    "text": "bugs uh so if we now combine everything that we know about permission strings uh",
    "start": "1152520",
    "end": "1159600"
  },
  {
    "text": "operations API and API versions The Bugs will just keep on uh",
    "start": "1159600",
    "end": "1166880"
  },
  {
    "text": "coming uh so first First We Take the permission strings from two API versions",
    "start": "1166880",
    "end": "1172200"
  },
  {
    "text": "a decade apart one from 2014 and one from 2024 sorry for the picture of a",
    "start": "1172200",
    "end": "1177760"
  },
  {
    "text": "terminal here but uh this is just me putting the all of the operations API",
    "start": "1177760",
    "end": "1183120"
  },
  {
    "text": "that I show you in last uh a few slides ago uh into two bash",
    "start": "1183120",
    "end": "1190600"
  },
  {
    "text": "variables and uh if we diff these two APR versions we see what's changed",
    "start": "1190600",
    "end": "1197159"
  },
  {
    "text": "between the 20 14 version and the 2024 version and actually not that much have",
    "start": "1197159",
    "end": "1204320"
  },
  {
    "text": "has been changed in the API management arm API uh but there are a few actions",
    "start": "1204320",
    "end": "1211080"
  },
  {
    "text": "that have been deprecated uh so for instance from this",
    "start": "1211080",
    "end": "1217480"
  },
  {
    "text": "we can see that uh the check custom host name action and the manage VPN action",
    "start": "1217480",
    "end": "1225520"
  },
  {
    "text": "has been taken out of the uh RM API uh in the newest",
    "start": "1225520",
    "end": "1232080"
  },
  {
    "text": "version and since this has the action uh action uh that's not exactly what we're",
    "start": "1232080",
    "end": "1239240"
  },
  {
    "text": "looking for since we are looking for privilege escalation opportunities but it might be interesting to test these for for other bugs since it's a legacy",
    "start": "1239240",
    "end": "1247559"
  },
  {
    "text": "uh API what is interesting though is the uh",
    "start": "1247559",
    "end": "1253440"
  },
  {
    "text": "third operation here get SSO token we see that it was conf converted",
    "start": "1253440",
    "end": "1259440"
  },
  {
    "text": "from a read action in 2014 to a write action in 2024 or in some API version in",
    "start": "1259440",
    "end": "1268640"
  },
  {
    "text": "between and this is exactly what we're looking for and it turned out that this",
    "start": "1268640",
    "end": "1273679"
  },
  {
    "text": "in fact was uh a bug as well using this you can generate a special single sign",
    "start": "1273679",
    "end": "1280520"
  },
  {
    "text": "on token That was supposed to be to um",
    "start": "1280520",
    "end": "1286279"
  },
  {
    "text": "supposed to be made for logging into developer portal in the API management",
    "start": "1286279",
    "end": "1291679"
  },
  {
    "text": "uh solution which is an entirely separate service we don't care about that uh but uh it used a static uh uh",
    "start": "1291679",
    "end": "1300840"
  },
  {
    "text": "key to generate a shared access signature that could be uh used in any",
    "start": "1300840",
    "end": "1307080"
  },
  {
    "text": "of the API management arm endpoints and uh that token can be could",
    "start": "1307080",
    "end": "1313360"
  },
  {
    "text": "be used to perform all actions on the API service",
    "start": "1313360",
    "end": "1318799"
  },
  {
    "text": "so uh I have held this presentation once before",
    "start": "1318799",
    "end": "1324679"
  },
  {
    "text": "and uh before I held the presentation last time I found this bug uh and I told Microsoft that I'm",
    "start": "1324679",
    "end": "1332720"
  },
  {
    "text": "going to present this uh in a few months time and they ended up uh patching this",
    "start": "1332720",
    "end": "1339200"
  },
  {
    "text": "uh even though you can still call the API you will get an empty response uh together uh back again which is a good",
    "start": "1339200",
    "end": "1346919"
  },
  {
    "text": "thing uh so now on to some uh real",
    "start": "1346919",
    "end": "1354679"
  },
  {
    "text": "bugs uh first I promised you that I'm going to talk about API management and",
    "start": "1357000",
    "end": "1362960"
  },
  {
    "text": "Azure app service we'll do APM API management",
    "start": "1362960",
    "end": "1368679"
  },
  {
    "text": "first and apim if is uh much used resource uh it's for managing apis",
    "start": "1368679",
    "end": "1376559"
  },
  {
    "text": "unsurprisingly and we have found a lot of vulnerabilities in apim uh some of them",
    "start": "1376559",
    "end": "1383120"
  },
  {
    "text": "in the arm API the ones I'm going to talk about now made it possible to read Secrets deploy",
    "start": "1383120",
    "end": "1389760"
  },
  {
    "text": "new products uh or apis as the built-in reader role so what's interesting with",
    "start": "1389760",
    "end": "1399120"
  },
  {
    "text": "this sorry is that some of them are unfixed unless a manual patch is applied",
    "start": "1399520",
    "end": "1406919"
  },
  {
    "text": "so uh Mar doesn't tell you that uh this is vulnerable uh but they",
    "start": "1406919",
    "end": "1414120"
  },
  {
    "text": "have made a patch available uh which is of course when",
    "start": "1414120",
    "end": "1421720"
  },
  {
    "text": "it's not documented anywhere that you should do this to be secure then uh uh administrators and developers doesn't",
    "start": "1421720",
    "end": "1427760"
  },
  {
    "text": "know about this and it won't happen so uh what's relevant for this is",
    "start": "1427760",
    "end": "1437279"
  },
  {
    "text": "uh the azure API management management API which in the developer portal no not",
    "start": "1437279",
    "end": "1443640"
  },
  {
    "text": "the developer portal the asro portal can be find found in this management API uh",
    "start": "1443640",
    "end": "1449520"
  },
  {
    "text": "setting and Microsoft actually says that this is going to be deprecated this year",
    "start": "1449520",
    "end": "1455600"
  },
  {
    "text": "but they also said that old API versions are going to",
    "start": "1455600",
    "end": "1461640"
  },
  {
    "text": "be deprecated uh for Azure API management uh like two years ago when I",
    "start": "1461640",
    "end": "1466880"
  },
  {
    "text": "first reported a bug uh to them and it still hasn't happened so let's see when",
    "start": "1466880",
    "end": "1472360"
  },
  {
    "text": "that will happen so a API management management API which",
    "start": "1472360",
    "end": "1479360"
  },
  {
    "text": "is of course the thing a standard Microsoft naming convention uh unless specifically",
    "start": "1479360",
    "end": "1486039"
  },
  {
    "text": "disabled it's enabled by default but you have the possibility of disabling it not",
    "start": "1486039",
    "end": "1491440"
  },
  {
    "text": "exactly disabling it but you have the possibility of hiding it so that the only one that can reach the management",
    "start": "1491440",
    "end": "1497080"
  },
  {
    "text": "API is the API which you probably should uh that is a service uh hosted on",
    "start": "1497080",
    "end": "1506440"
  },
  {
    "text": "uh this predictable URL here so the API M service name. management. aure api.",
    "start": "1506440",
    "end": "1516080"
  },
  {
    "text": "net this runs some variant of of kudu uh",
    "start": "1518480",
    "end": "1523600"
  },
  {
    "text": "which is tailored for apim so it uses kudu which is uh open source and it has",
    "start": "1523600",
    "end": "1530799"
  },
  {
    "text": "change it some way to to fit apim uh and uh as an admin of an API",
    "start": "1530799",
    "end": "1540080"
  },
  {
    "text": "Management Service you can either send HTTP request directly to this management API or via the r API so both of them",
    "start": "1540080",
    "end": "1547480"
  },
  {
    "text": "will work uh and the paths are identical in the r API and the uh direct management",
    "start": "1547480",
    "end": "1554520"
  },
  {
    "text": "API which is this is called",
    "start": "1554520",
    "end": "1558679"
  },
  {
    "text": "so uh one of the bugs that I have uh been",
    "start": "1560279",
    "end": "1565360"
  },
  {
    "text": "uh referring to earlier uh this uh is an",
    "start": "1565360",
    "end": "1570480"
  },
  {
    "text": "API request for um a vulnerability that gave some privileged",
    "start": "1570480",
    "end": "1576240"
  },
  {
    "text": "Keys as you can see the HTTP verb is get so it's callable by",
    "start": "1576240",
    "end": "1582000"
  },
  {
    "text": "readers in this case it was exploitable on every API version but in an",
    "start": "1582000",
    "end": "1587039"
  },
  {
    "text": "undocumented API point namely the users Keys uh endpoint uh and Microsoft has kind of",
    "start": "1587039",
    "end": "1595600"
  },
  {
    "text": "fixed this uh they have fixed it for priv privilege escalation but uh the end",
    "start": "1595600",
    "end": "1601240"
  },
  {
    "text": "point still exist if you have contributor uh a contributor role and",
    "start": "1601240",
    "end": "1606880"
  },
  {
    "text": "I'll get back to why that's probably not a good idea",
    "start": "1606880",
    "end": "1612039"
  },
  {
    "text": "either uh but these Service keys that you get returned when you call the API they are similar two static secrets",
    "start": "1612039",
    "end": "1619200"
  },
  {
    "text": "that are used in other resources in Azure so if you are working with Azure you know that uh there are these static",
    "start": "1619200",
    "end": "1626679"
  },
  {
    "text": "account keys that have like Master access to a resource for a bunch of different",
    "start": "1626679",
    "end": "1632679"
  },
  {
    "text": "resource uh such as for storage accounts or Cosmos databas bases and so",
    "start": "1632679",
    "end": "1639240"
  },
  {
    "text": "on so we normally uh when we talk to clients we normally recommend to try to",
    "start": "1639240",
    "end": "1646399"
  },
  {
    "text": "limit the use of static secrets as much as you can um but for some resources such as",
    "start": "1646399",
    "end": "1654600"
  },
  {
    "text": "API management you can't really turn it off it's just built in and it's there uh",
    "start": "1654600",
    "end": "1660320"
  },
  {
    "text": "you're not necessarily using it but it's used under the hood so it cannot be",
    "start": "1660320",
    "end": "1667039"
  },
  {
    "text": "disabled these keys can be used uh to create shared access signatures and access the management API",
    "start": "1668039",
    "end": "1676760"
  },
  {
    "text": "directly so let's try to do a demo of this",
    "start": "1676760",
    "end": "1683120"
  },
  {
    "text": "uh if I can just find my",
    "start": "1683760",
    "end": "1688000"
  },
  {
    "text": "cursor okay how's this",
    "start": "1696840",
    "end": "1701240"
  },
  {
    "text": "um I can zoom in uh a little bit if it's uh if it's small all in the back uh so",
    "start": "1703960",
    "end": "1710399"
  },
  {
    "text": "here we are in the Azure portal this is just for demo purposes I will be showing",
    "start": "1710399",
    "end": "1715840"
  },
  {
    "text": "the the keys end point first uh how that works I'm logged in uh as a user with",
    "start": "1715840",
    "end": "1723519"
  },
  {
    "text": "the read uh role uh as I will show here uh so um I'm going into the I am Tab and",
    "start": "1723519",
    "end": "1732919"
  },
  {
    "text": "I'm uh um viewing my current roll assignments I'm assigned the reader",
    "start": "1732919",
    "end": "1740039"
  },
  {
    "text": "uh and that's supposed to have access to uh read view all resources but does not",
    "start": "1741000",
    "end": "1746799"
  },
  {
    "text": "allow you to make any changes okay that's fine and uh all of the uh",
    "start": "1746799",
    "end": "1752480"
  },
  {
    "text": "permissions under here uh those uh correspond to the permission strings that we spoke about earlier",
    "start": "1752480",
    "end": "1761080"
  },
  {
    "text": "and now we just want a token for the management API",
    "start": "1771159",
    "end": "1777200"
  },
  {
    "text": "and as I mentioned the the uh arm API Azure resource manage management",
    "start": "1777200",
    "end": "1784279"
  },
  {
    "text": "API uh is used by all clients including the portal so we can just take one of",
    "start": "1784279",
    "end": "1790240"
  },
  {
    "text": "the request there and paste it into a http request",
    "start": "1790240",
    "end": "1798559"
  },
  {
    "text": "to the management API here and uh uh",
    "start": "1798559",
    "end": "1804279"
  },
  {
    "text": "this request here is using a new is version of the API 2022",
    "start": "1804279",
    "end": "1809559"
  },
  {
    "text": "version uh and when it was recorded it was a live system uh just created uh",
    "start": "1809559",
    "end": "1817720"
  },
  {
    "text": "with the default settings and uh if I call this as a",
    "start": "1817720",
    "end": "1823080"
  },
  {
    "text": "reader I get these primary and secondary keys for the user with",
    "start": "1823080",
    "end": "1829720"
  },
  {
    "text": "id1 and the user with id1 is the built-in uh service user for apim which",
    "start": "1829720",
    "end": "1836279"
  },
  {
    "text": "cannot be disabled and you need it uh this here I will just gloss over",
    "start": "1836279",
    "end": "1842679"
  },
  {
    "text": "this but uh it's just um a an internal command interface that",
    "start": "1842679",
    "end": "1848880"
  },
  {
    "text": "you we use to to do uh stuff that we have to do a lot of times so this just",
    "start": "1848880",
    "end": "1856480"
  },
  {
    "text": "creates a shared access signal from this key uh the primary key uh and",
    "start": "1856480",
    "end": "1864120"
  },
  {
    "text": "spits it out and the shared access signature is used for authorization or authentication in a lot of uh uh",
    "start": "1864120",
    "end": "1871240"
  },
  {
    "text": "Microsoft services and right here uh I am",
    "start": "1871240",
    "end": "1877919"
  },
  {
    "text": "preparing an HTTP request with this signature uh which I've made entirely from the key that I uh could access as a",
    "start": "1877919",
    "end": "1886760"
  },
  {
    "text": "reader and and uh I'm creating a new API called evil hackers",
    "start": "1886760",
    "end": "1894760"
  },
  {
    "text": "API and uh just to show you that uh there are no apis existing on this API",
    "start": "1894760",
    "end": "1900760"
  },
  {
    "text": "Management Service as of now I'm doing this and if I run the HP request it",
    "start": "1900760",
    "end": "1907760"
  },
  {
    "text": "should appear in the uh apis",
    "start": "1907760",
    "end": "1913159"
  },
  {
    "text": "this is of course a problem because well the it's a privilege escalation",
    "start": "1918039",
    "end": "1923320"
  },
  {
    "text": "vulnerability and uh uh usually a lot of",
    "start": "1923320",
    "end": "1929080"
  },
  {
    "text": "uh uh people may get access to uh a resource such as API management and",
    "start": "1929080",
    "end": "1936039"
  },
  {
    "text": "because of the nature of API management a lot of companies have uh used API",
    "start": "1936039",
    "end": "1941960"
  },
  {
    "text": "management across a lot of different teams and a lot of different products so a lot of people will have uh read access",
    "start": "1941960",
    "end": "1948919"
  },
  {
    "text": "to API management uh okay so that was uh one of",
    "start": "1948919",
    "end": "1956200"
  },
  {
    "text": "the bugs",
    "start": "1956200",
    "end": "1959679"
  },
  {
    "text": "uh go back to the slides again so second trick I was uh uh",
    "start": "1961600",
    "end": "1970279"
  },
  {
    "text": "talking about was going back in time uh last one was finding an undocumented API",
    "start": "1970279",
    "end": "1975880"
  },
  {
    "text": "endpoint right uh uh and the previous bug was uh patched by",
    "start": "1975880",
    "end": "1981600"
  },
  {
    "text": "Microsoft uh but similar bugs uh used that can be used for privilege",
    "start": "1981600",
    "end": "1988000"
  },
  {
    "text": "escalation exist on several apis if you use the old API versions and as I said",
    "start": "1988000",
    "end": "1994159"
  },
  {
    "text": "uh we reported this uh years ago uh the first ones at least and msrc Microsoft",
    "start": "1994159",
    "end": "2002480"
  },
  {
    "text": "security response uh something Center was that well we know about this we know",
    "start": "2002480",
    "end": "2008120"
  },
  {
    "text": "that this is a problem and that's why we will make this cool toggle in API management to",
    "start": "2008120",
    "end": "2014399"
  },
  {
    "text": "disable uh pre disable all old uh vulnerable API",
    "start": "2014399",
    "end": "2020000"
  },
  {
    "text": "versions the problem is that this toggle that they made is off by default uh leaving all apim services",
    "start": "2020000",
    "end": "2027760"
  },
  {
    "text": "vulnerable uh and it doesn't matter if you create a new apim service today it's still toggled off so I mean you don't",
    "start": "2027760",
    "end": "2036320"
  },
  {
    "text": "need to use the 2004 version if you use if you create a brand new apim IM",
    "start": "2036320",
    "end": "2042080"
  },
  {
    "text": "service but uh that's kind of a typical thing in Microsoft Azure as far as I can",
    "start": "2042080",
    "end": "2048000"
  },
  {
    "text": "see it it's insecure by default and sometimes it's difficult to know that uh",
    "start": "2048000",
    "end": "2054720"
  },
  {
    "text": "this toggle that you have to click through like uh five panes in the Azure",
    "start": "2054720",
    "end": "2060839"
  },
  {
    "text": "portal that this does anything to to improve the security uh however if you pay for",
    "start": "2060839",
    "end": "2068800"
  },
  {
    "text": "Microsoft Defender for cloud you will get a medium severity alert saying you should probably toggle this but there's",
    "start": "2068800",
    "end": "2075720"
  },
  {
    "text": "no explanation to as to why why this is a",
    "start": "2075720",
    "end": "2081000"
  },
  {
    "text": "problem uh so I guess we can say for all uh types of resources if there is the",
    "start": "2081440",
    "end": "2087720"
  },
  {
    "text": "option to disable uh old API versions you should probably do",
    "start": "2087720",
    "end": "2094440"
  },
  {
    "text": "it uh so uh last time I held this talk I told Microsoft that I will uh would hold",
    "start": "2094760",
    "end": "2102160"
  },
  {
    "text": "it in a few months and uh uh said that I will show these",
    "start": "2102160",
    "end": "2107560"
  },
  {
    "text": "vulnerabilities uh you know about these so that should be okay it's uh uh your",
    "start": "2107560",
    "end": "2113160"
  },
  {
    "text": "decision to not really fix these properly or alert your customers about",
    "start": "2113160",
    "end": "2119000"
  },
  {
    "text": "this for the past two years uh so the last time I held this talk they actually I H held the talk on",
    "start": "2119000",
    "end": "2126079"
  },
  {
    "text": "a Tuesday and they actually pass patched it in the weekend before uh I should I was going to hold the talk so they knew",
    "start": "2126079",
    "end": "2132760"
  },
  {
    "text": "about the dates and everything so I mean it's uh assumptions again but uh I think",
    "start": "2132760",
    "end": "2139400"
  },
  {
    "text": "that was the deadline they worked uh worked against uh so most likely they patched",
    "start": "2139400",
    "end": "2145839"
  },
  {
    "text": "it since they had it vulnerable for such a long time they only patched it to ruin my live demo uh but uh now it's been a",
    "start": "2145839",
    "end": "2154040"
  },
  {
    "text": "while so it's been patched for months now uh but I still try to uh I'm still",
    "start": "2154040",
    "end": "2160240"
  },
  {
    "text": "trying to going to try to do a live demo on a live environment showing showing",
    "start": "2160240",
    "end": "2165760"
  },
  {
    "text": "some other unpatched bugs that still work and that they seemingly have uh no",
    "start": "2165760",
    "end": "2173200"
  },
  {
    "text": "immediate plans to fix at",
    "start": "2173200",
    "end": "2177200"
  },
  {
    "text": "least um yes and uh before I'm jumping into",
    "start": "2180480",
    "end": "2185720"
  },
  {
    "text": "the live demo we can have a quick look at uh",
    "start": "2185720",
    "end": "2191079"
  },
  {
    "text": "the uh SSO token vulnerability which uh",
    "start": "2191079",
    "end": "2196920"
  },
  {
    "text": "was uh the bug that was uh",
    "start": "2196920",
    "end": "2201240"
  },
  {
    "text": "patched so right here I'm just showing the same thing as was in the last video",
    "start": "2203079",
    "end": "2209240"
  },
  {
    "text": "I'm logged in with a user with reader access I shouldn't have access to change anything in this API Management Service",
    "start": "2209240",
    "end": "2216000"
  },
  {
    "text": "I'm getting a token uh for the arm",
    "start": "2216000",
    "end": "2221160"
  },
  {
    "text": "API and I'm using that token to send our request uh to the arm API and I'll just",
    "start": "2224359",
    "end": "2233560"
  },
  {
    "text": "zoom a little bit in case it's difficult to see uh the get SSO token endpoint",
    "start": "2233560",
    "end": "2239000"
  },
  {
    "text": "which we saw in the uh API diffs right that it has been converted from uh uh",
    "start": "2239000",
    "end": "2247599"
  },
  {
    "text": "read action to an action action but if we just call the API version 2014 then",
    "start": "2247599",
    "end": "2255839"
  },
  {
    "text": "we're all good uh so this is even better than the",
    "start": "2255839",
    "end": "2262680"
  },
  {
    "text": "last video was I shown you because this actually creates a shared AIS uh",
    "start": "2262680",
    "end": "2268400"
  },
  {
    "text": "signature for us so we don't have to take the key and convert it to a shared access",
    "start": "2268400",
    "end": "2274000"
  },
  {
    "text": "signature uh so it's easy e to exploit but uh it",
    "start": "2274000",
    "end": "2280880"
  },
  {
    "text": "is um better to do it like this for Microsoft side because then you don't",
    "start": "2280880",
    "end": "2287200"
  },
  {
    "text": "leak the permanent uh Secrets the master key uh",
    "start": "2287200",
    "end": "2293000"
  },
  {
    "text": "which uh was in the user Keys endpoint which cannot be disabled unless you like",
    "start": "2293000",
    "end": "2298079"
  },
  {
    "text": "delete the API Management Service and create a new one uh so yeah let's also mention that",
    "start": "2298079",
    "end": "2305960"
  },
  {
    "text": "uh this SSO to toen is actually designed to go to the portal uh",
    "start": "2305960",
    "end": "2314440"
  },
  {
    "text": "which is a developer portal um um feature of API management it's not",
    "start": "2314440",
    "end": "2321920"
  },
  {
    "text": "actually designed to to be used on the management API but because it's the same",
    "start": "2321920",
    "end": "2327000"
  },
  {
    "text": "master key that these have been derived from these signatures it can be used in",
    "start": "2327000",
    "end": "2332079"
  },
  {
    "text": "the management API as well",
    "start": "2332079",
    "end": "2336200"
  },
  {
    "text": "so here I'm doing uh same thing as in last demo I'm creating a new",
    "start": "2338160",
    "end": "2345119"
  },
  {
    "text": "API and this is now empty but with this sh access signature",
    "start": "2345119",
    "end": "2351119"
  },
  {
    "text": "uh I am allowed to call the API management management API",
    "start": "2351119",
    "end": "2358680"
  },
  {
    "text": "directly and create a new API so that's a",
    "start": "2360760",
    "end": "2366079"
  },
  {
    "text": "problem they uh as mentioned they decided to fix that before my last La",
    "start": "2366079",
    "end": "2371640"
  },
  {
    "text": "demo uh but there are some unfixed uh stuff as",
    "start": "2371640",
    "end": "2376960"
  },
  {
    "text": "well uh so let's see if I'm able to show",
    "start": "2376960",
    "end": "2382440"
  },
  {
    "text": "you same user as in the video uh we just have to wait some Azure minutes uh once",
    "start": "2385720",
    "end": "2391400"
  },
  {
    "text": "in a while I have the reader role uh on this TMP apim",
    "start": "2391400",
    "end": "2397839"
  },
  {
    "text": "Hansen API Management Service now um I'm going to I'm",
    "start": "2397839",
    "end": "2404880"
  },
  {
    "text": "not I'm not going to focus on all the features of the of API management but",
    "start": "2404880",
    "end": "2410480"
  },
  {
    "text": "one of them is called subscription keys and this is kind of API keys that are",
    "start": "2410480",
    "end": "2416359"
  },
  {
    "text": "supposed to be used when calling the actual apis that you deploy uh so they",
    "start": "2416359",
    "end": "2422119"
  },
  {
    "text": "don't have anything with a management uh plane to do but uh uh when you have the",
    "start": "2422119",
    "end": "2427359"
  },
  {
    "text": "FL apis the the subscription keys can be used to access the apis uh they are static secrets so you",
    "start": "2427359",
    "end": "2434440"
  },
  {
    "text": "probably shouldn't use them to uh perform secur sensitive security",
    "start": "2434440",
    "end": "2440640"
  },
  {
    "text": "operations uh but of course uh that is done from time to time and if I try to",
    "start": "2440640",
    "end": "2448880"
  },
  {
    "text": "uh select these show hide keys in the portal to reveal the keys I will get no",
    "start": "2448880",
    "end": "2455040"
  },
  {
    "text": "access because you don't have sufficient permission to list the secrets because they have been defined as Secrets now uh",
    "start": "2455040",
    "end": "2462839"
  },
  {
    "text": "but let's see if we can get a token uh this is a live",
    "start": "2462839",
    "end": "2469839"
  },
  {
    "text": "environment so don't steal my management",
    "start": "2469839",
    "end": "2473599"
  },
  {
    "text": "token but it will work if you",
    "start": "2477720",
    "end": "2481680"
  },
  {
    "text": "do yeah",
    "start": "2484440",
    "end": "2488440"
  },
  {
    "text": "uh okay so let's uh try to it's truncated",
    "start": "2491880",
    "end": "2500400"
  },
  {
    "text": "somewhere copy",
    "start": "2500400",
    "end": "2503680"
  },
  {
    "text": "all okay I'm just taking the axis token from the because I couldn't see what I did wrong this is just a proxy that I",
    "start": "2510040",
    "end": "2517880"
  },
  {
    "text": "use uh to proxy the requests from the browser to make it simple uh they are",
    "start": "2517880",
    "end": "2523440"
  },
  {
    "text": "just raw HTTP requests nothing fancy uh okay so this should work uh and now I have called the",
    "start": "2523440",
    "end": "2533359"
  },
  {
    "text": "subscriptions endpoint uh of the same TMP API M Hansen",
    "start": "2533359",
    "end": "2539960"
  },
  {
    "text": "uh API service for the newest API uh version and I can see that there are",
    "start": "2539960",
    "end": "2547760"
  },
  {
    "text": "uh subscription here because I'm allowed to read the resources but I can't see",
    "start": "2547760",
    "end": "2553240"
  },
  {
    "text": "the subscription key uh because I'm not allowed to see the sub subscription key because it's",
    "start": "2553240",
    "end": "2559920"
  },
  {
    "text": "defined as a secret right so what I can do here is to uh use the same trusty",
    "start": "2559920",
    "end": "2566119"
  },
  {
    "text": "trick as we have seen before go back in time to an easier era uh to",
    "start": "2566119",
    "end": "2574599"
  },
  {
    "text": "2014 and then we have the primary and secondary subscription keys so this is",
    "start": "2574599",
    "end": "2581040"
  },
  {
    "text": "still a problem and uh there are a few way of fixing it which we will get back to but",
    "start": "2581040",
    "end": "2588640"
  },
  {
    "text": "uh main way is just to toggle that thing disable old API",
    "start": "2588640",
    "end": "2595000"
  },
  {
    "text": "versions uh there is also another interesting end point",
    "start": "2595000",
    "end": "2601960"
  },
  {
    "text": "and if we call this other uh API uh the",
    "start": "2603119",
    "end": "2608800"
  },
  {
    "text": "tenant axis API with the newest API",
    "start": "2608800",
    "end": "2613920"
  },
  {
    "text": "versions We can see some suspicious things down here we get a primary key",
    "start": "2613920",
    "end": "2619760"
  },
  {
    "text": "and a secondary key which is null so if we use the same exact trick",
    "start": "2619760",
    "end": "2625880"
  },
  {
    "text": "again to go back in time to some previous API version it doesn't has to be have to be 2014 that can be anywhere",
    "start": "2625880",
    "end": "2634280"
  },
  {
    "text": "before they patched it then we should see these primary and",
    "start": "2634280",
    "end": "2640079"
  },
  {
    "text": "secondary keys and maybe you recognize them from before but let's do the whole",
    "start": "2640079",
    "end": "2645640"
  },
  {
    "text": "thing again just to show you that it's still exploitable in a live environment uh so this is",
    "start": "2645640",
    "end": "2653440"
  },
  {
    "text": "the uh command line interface again uh the only thing is it do it's does is to",
    "start": "2653440",
    "end": "2660000"
  },
  {
    "text": "do some hmac stuff with this key uh so it's nothing fancy uh the process is",
    "start": "2660000",
    "end": "2665200"
  },
  {
    "text": "documented by Microsoft so we just copy their Co their code to use this uh and",
    "start": "2665200",
    "end": "2670920"
  },
  {
    "text": "we are calling this as the end integration user uh which is a built-in",
    "start": "2670920",
    "end": "2676119"
  },
  {
    "text": "user that uh can actually be disabled uh but it's not obvious that you are",
    "start": "2676119",
    "end": "2683559"
  },
  {
    "text": "disabling this integration user uh from the portal it's like disable management API and if you disable the manage API uh",
    "start": "2683559",
    "end": "2691200"
  },
  {
    "text": "you're not actually disabling the management API you're disabling the integration user uh uh but if we use this shared M",
    "start": "2691200",
    "end": "2699400"
  },
  {
    "text": "uh shared access signature uh just to call the um management API",
    "start": "2699400",
    "end": "2708119"
  },
  {
    "text": "directly uh I'm going to paste it remove line",
    "start": "2708119",
    "end": "2713319"
  },
  {
    "text": "break can see that we are authenticated and that we can read stuff nice and yeah",
    "start": "2713319",
    "end": "2720520"
  },
  {
    "text": "this uh just to go back to this again this is the API service. management. -",
    "start": "2720520",
    "end": "2727520"
  },
  {
    "text": "api. net uh but as this is the integration user it of course has all access on the",
    "start": "2727520",
    "end": "2735480"
  },
  {
    "text": "uh API service so if we want we can deploy new apis we can delete apis we",
    "start": "2735480",
    "end": "2741079"
  },
  {
    "text": "can change API operations we can read secrets we can do whatever we want uh so I'll try to show you this as",
    "start": "2741079",
    "end": "2749520"
  },
  {
    "text": "well um see if there are any apis",
    "start": "2749520",
    "end": "2755559"
  },
  {
    "text": "here no AP except the echo API which is just an example API if you click Ops",
    "start": "2755559",
    "end": "2761559"
  },
  {
    "text": "this from the portal you get this default API uh and I'm trying to create",
    "start": "2761559",
    "end": "2767359"
  },
  {
    "text": "the evil hacker API which of course",
    "start": "2767359",
    "end": "2773480"
  },
  {
    "text": "worked uh and uh if we refresh this and Wait Another Minute",
    "start": "2773480",
    "end": "2781599"
  },
  {
    "text": "we see that the evil hacker API is created and that's still still explorable",
    "start": "2792319",
    "end": "2799359"
  },
  {
    "text": "today uh funny thing in",
    "start": "2799800",
    "end": "2804559"
  },
  {
    "text": "this exploiting old API management uh apis uh is I just wanted to show you",
    "start": "2805839",
    "end": "2813559"
  },
  {
    "text": "this API version retirements June 2024 in their official documentation they're",
    "start": "2813559",
    "end": "2819680"
  },
  {
    "text": "saying that starting June 1st 2024 all older API will be",
    "start": "2819680",
    "end": "2826599"
  },
  {
    "text": "retired uh this was previously communicated at",
    "start": "2826599",
    "end": "2832040"
  },
  {
    "text": "September 30th 2023 which was the date that they told me that okay you can't",
    "start": "2832040",
    "end": "2837240"
  },
  {
    "text": "speak to anyone about this publicly until that date uh but that's one and a half years ago and it's two years ago",
    "start": "2837240",
    "end": "2843880"
  },
  {
    "text": "since I reported the vulnerability so they are apparent not able to to patch this properly for all customers so we",
    "start": "2843880",
    "end": "2850680"
  },
  {
    "text": "have to do it ourselves uh okay back to the",
    "start": "2850680",
    "end": "2858200"
  },
  {
    "text": "slides uh I'll just go quickly through the the asra service as well uh I'll",
    "start": "2873520",
    "end": "2879359"
  },
  {
    "text": "probably skip the demo but it's just a recorded demo so not that important um",
    "start": "2879359",
    "end": "2884520"
  },
  {
    "text": "so we also find two separate vulnerabilities in the RM apis for Azure",
    "start": "2884520",
    "end": "2889760"
  },
  {
    "text": "app Service uh both of them were examples of the trick where we go back in time and",
    "start": "2889760",
    "end": "2895280"
  },
  {
    "text": "use an old API version they were fixed by Microsoft uh and",
    "start": "2895280",
    "end": "2902000"
  },
  {
    "text": "uh when they were exploitable they made it possible to read uh environment variables and execute code as a",
    "start": "2902000",
    "end": "2910480"
  },
  {
    "text": "reader uh while preparing for this talk today uh I also find another bug which",
    "start": "2910480",
    "end": "2918359"
  },
  {
    "text": "uh makes it possible for our reader to bypass an their Network restrictions on",
    "start": "2918359",
    "end": "2923920"
  },
  {
    "text": "Azure app Services it's a kind of minor bug but uh if you need a",
    "start": "2923920",
    "end": "2931040"
  },
  {
    "text": "firewall bypass for uh uh app Services uh there is a zero day there and you",
    "start": "2931040",
    "end": "2936799"
  },
  {
    "text": "know how to find it uh so",
    "start": "2936799",
    "end": "2942559"
  },
  {
    "text": "the bugs that we find found both LED to remote Cod execution in an app Service",
    "start": "2942559",
    "end": "2949760"
  },
  {
    "text": "uh or a function app uh first uh bug could just be",
    "start": "2949760",
    "end": "2955640"
  },
  {
    "text": "exploited by calling uh this uh admin token API with an old API version and it",
    "start": "2955640",
    "end": "2962599"
  },
  {
    "text": "gave us a token uh since it's a get request we can call it as a reader if we decode the",
    "start": "2962599",
    "end": "2970480"
  },
  {
    "text": "token we see the audience is the azurewebsites.net that specific app",
    "start": "2970480",
    "end": "2977160"
  },
  {
    "text": "Service uh and the issue of the token is the uh Source control management or or",
    "start": "2977160",
    "end": "2984599"
  },
  {
    "text": "SCM uh for that relevant resource uh so this token uh is used internally uh and it",
    "start": "2984599",
    "end": "2993640"
  },
  {
    "text": "has all access to uh the app service uh admin API directly on the on the app",
    "start": "2993640",
    "end": "3001240"
  },
  {
    "text": "service including the possibility to deploy functions and execute",
    "start": "3001240",
    "end": "3006319"
  },
  {
    "text": "code uh so in this example I've used the token to deploy a new function to an existing uh function app",
    "start": "3006319",
    "end": "3015200"
  },
  {
    "text": "as a reader just by calling one arm API and using a token uh on the direct",
    "start": "3015200",
    "end": "3023079"
  },
  {
    "text": "API another uh bug that we found was was the possibility of reading environment",
    "start": "3023079",
    "end": "3029760"
  },
  {
    "text": "variables uh the top image here is uh how uh the environment variables uh of",
    "start": "3029760",
    "end": "3036520"
  },
  {
    "text": "an app service looks like for a reader uh if you open it in the a portal uh while the bottom uh is how it",
    "start": "3036520",
    "end": "3043799"
  },
  {
    "text": "looks like for a contributor note that uh me following best practice has",
    "start": "3043799",
    "end": "3050000"
  },
  {
    "text": "have used these keyal references for extra security uh so they won't even uh",
    "start": "3050000",
    "end": "3056799"
  },
  {
    "text": "turn up in the um aure portal for a",
    "start": "3056799",
    "end": "3061920"
  },
  {
    "text": "contributor uh but there is an API uh in the arm API which uh can be used to uh",
    "start": "3062240",
    "end": "3071480"
  },
  {
    "text": "list processes which is is a get request and uh that uh",
    "start": "3071480",
    "end": "3080240"
  },
  {
    "text": "also includes all the environmental variables of that process so if we call",
    "start": "3080240",
    "end": "3085280"
  },
  {
    "text": "the process of pit Z which is the default root process with an old uh API version we get uh all of",
    "start": "3085280",
    "end": "3092720"
  },
  {
    "text": "the environment variables including the uh key volt uh Secrets as they have been",
    "start": "3092720",
    "end": "3099680"
  },
  {
    "text": "injected into the runtime of the app service dynamically on",
    "start": "3099680",
    "end": "3105440"
  },
  {
    "text": "start uh and this is this can still be used by this is fixed but it can still",
    "start": "3105680",
    "end": "3110960"
  },
  {
    "text": "be used by uh contributors uh so",
    "start": "3110960",
    "end": "3116640"
  },
  {
    "text": "if you're wondering what's behind that uh hidden secret field in a keyal",
    "start": "3116640",
    "end": "3122839"
  },
  {
    "text": "references uh in uh an app service then this is a trick to to see it",
    "start": "3122839",
    "end": "3128640"
  },
  {
    "text": "without uh deplo actually deploying anything um so I I think we'll skip the",
    "start": "3128640",
    "end": "3138079"
  },
  {
    "text": "demo here just so that we can finish a bit early uh because I have some",
    "start": "3138079",
    "end": "3146920"
  },
  {
    "text": "opinions on how to fix this this is kind of",
    "start": "3146920",
    "end": "3152000"
  },
  {
    "text": "vulnerabilities that is in the cloud in the cloud resources it's not specific to",
    "start": "3152000",
    "end": "3158079"
  },
  {
    "text": "Azure I just used Azure as an example there are similar vulnerabilities in the",
    "start": "3158079",
    "end": "3164480"
  },
  {
    "text": "uh other Cloud providers as well of course uh but in the Azure case we don't",
    "start": "3164480",
    "end": "3170119"
  },
  {
    "text": "really recommend limiting people's read access uh so please don't interpret this",
    "start": "3170119",
    "end": "3176839"
  },
  {
    "text": "talk as that uh because that causes a lot of friction uh especially if like if",
    "start": "3176839",
    "end": "3182200"
  },
  {
    "text": "developers can't have read access to their own resources that would be crazy uh what can be done though is to",
    "start": "3182200",
    "end": "3190319"
  },
  {
    "text": "limit access to the management apis like the source control management for app",
    "start": "3190319",
    "end": "3195359"
  },
  {
    "text": "services and management API for API management uh that can be limited by",
    "start": "3195359",
    "end": "3202160"
  },
  {
    "text": "making them private or vnet internal then you can use like the arm API there",
    "start": "3202160",
    "end": "3208799"
  },
  {
    "text": "you can't restrict that but the tokens that you get from exploiting",
    "start": "3208799",
    "end": "3213920"
  },
  {
    "text": "vulnerabilities in the RM API has to be used directly on the um Services",
    "start": "3213920",
    "end": "3219359"
  },
  {
    "text": "themselves so if they are integrated into a vnet and not accessible uh from",
    "start": "3219359",
    "end": "3224520"
  },
  {
    "text": "the public internet then you can't exploit it uh also apply the toggle in apim for",
    "start": "3224520",
    "end": "3232079"
  },
  {
    "text": "disabling uh Legacy apis and uh try to disable local",
    "start": "3232079",
    "end": "3239119"
  },
  {
    "text": "authenticate occas local authentication for all resources uh this static backd",
    "start": "3239119",
    "end": "3244599"
  },
  {
    "text": "door keys which is uh everywhere in Azure uh you can disable it for all",
    "start": "3244599",
    "end": "3250400"
  },
  {
    "text": "resources like apim these static secrets that you have seen uh for the user with",
    "start": "3250400",
    "end": "3257640"
  },
  {
    "text": "id1 for instance you can't disable that uh and even though Microsoft has patched",
    "start": "3257640",
    "end": "3263640"
  },
  {
    "text": "it for readers then contributors can still read it and that might also be a problem like",
    "start": "3263640",
    "end": "3270079"
  },
  {
    "text": "if you get 2 minutes of contributor access to Resource you can create or you",
    "start": "3270079",
    "end": "3275839"
  },
  {
    "text": "can just fetch the the primary access key for that resource and keep on",
    "start": "3275839",
    "end": "3282040"
  },
  {
    "text": "creating new shared access signature and access it uh until the end of the of",
    "start": "3282040",
    "end": "3287359"
  },
  {
    "text": "time or the resource is deleted uh so some key take takeaways",
    "start": "3287359",
    "end": "3294440"
  },
  {
    "text": "from this talk try to not trust the cloud too much I don't mean that uh using the cloud is",
    "start": "3294440",
    "end": "3302480"
  },
  {
    "text": "inherently secure but just be aware of the risks of uh platform vulnerabilities",
    "start": "3302480",
    "end": "3307599"
  },
  {
    "text": "in the cloud and in the cloud resources that you use uh if you do threat modeling that should definitely be part",
    "start": "3307599",
    "end": "3314200"
  },
  {
    "text": "of the threat model uh because there are a lot of vulnerabilities there uh maybe more than you could",
    "start": "3314200",
    "end": "3321960"
  },
  {
    "text": "expect um so all Cloud platform has platforms has bugs I only found bugs in",
    "start": "3321960",
    "end": "3329359"
  },
  {
    "text": "GCB and Azure but uh I haven't really done any resear Research into AWS I just",
    "start": "3329359",
    "end": "3335119"
  },
  {
    "text": "assume that they exist there as well uh but if you are doing things right from the get-go only a few of them",
    "start": "3335119",
    "end": "3342280"
  },
  {
    "text": "will affect you so in this case all of the bugs I've talked about could be uh",
    "start": "3342280",
    "end": "3347640"
  },
  {
    "text": "not fixed but uh it won't wouldn't have uh had a huge impact uh if you applied",
    "start": "3347640",
    "end": "3355359"
  },
  {
    "text": "Network restrictions on all the resources uh so the RM API has a lot of",
    "start": "3355359",
    "end": "3363039"
  },
  {
    "text": "bugs you should go find them uh and I meant what I said we haven't looked into",
    "start": "3363039",
    "end": "3369599"
  },
  {
    "text": "like we have looked into 2% of the resource types probably this uh this problem is",
    "start": "3369599",
    "end": "3376520"
  },
  {
    "text": "probably present in uh many of them uh and uh if you're creating",
    "start": "3376520",
    "end": "3383599"
  },
  {
    "text": "resources I would recommend to try to understand every property of the a",
    "start": "3383599",
    "end": "3388640"
  },
  {
    "text": "resource management Json uh so if you just call the management",
    "start": "3388640",
    "end": "3393960"
  },
  {
    "text": "API on a resource you will get the Json structure um with all the properties try",
    "start": "3393960",
    "end": "3400200"
  },
  {
    "text": "to understand what each of them does and if it might has have an a security",
    "start": "3400200",
    "end": "3405640"
  },
  {
    "text": "benefit such as uh disabling all API versions or disabling local",
    "start": "3405640",
    "end": "3411599"
  },
  {
    "text": "authentication local authentication is these master keys uh that can be",
    "start": "3411599",
    "end": "3417079"
  },
  {
    "text": "disabled for for instance for storage accounts uh for databases but not for apim",
    "start": "3417079",
    "end": "3424640"
  },
  {
    "text": "unfortunately uh and finally uh don't report the bugs that you're going to live demo when you know there will be no",
    "start": "3424799",
    "end": "3431440"
  },
  {
    "text": "Bounty and this one trick of going back in time Microsoft never pays Bounty for that because they already know it's a",
    "start": "3431440",
    "end": "3438559"
  },
  {
    "text": "like an inherent problem uh just so you know undocumented API endpoints though",
    "start": "3438559",
    "end": "3445359"
  },
  {
    "text": "they will pay for those uh so these are some sources uh we have",
    "start": "3445359",
    "end": "3451359"
  },
  {
    "text": "written some writeups on uh some of the bugs here uh so if you're interested in reading more details you can uh go to",
    "start": "3451359",
    "end": "3458119"
  },
  {
    "text": "our website uh biner security. or bin. um if you want",
    "start": "3458119",
    "end": "3464880"
  },
  {
    "text": "to um ask a question or reach out to me you can send me an email or send me a",
    "start": "3464880",
    "end": "3470720"
  },
  {
    "text": "message on straa uh which is my preferred social media uh platform",
    "start": "3470720",
    "end": "3476920"
  },
  {
    "text": "uh also there's a QR codee there uh contains a link to the slides uh if you're interested in that I think it",
    "start": "3476920",
    "end": "3483960"
  },
  {
    "text": "might be the previous version of the slides but they should be kind of similar so it's all",
    "start": "3483960",
    "end": "3490760"
  },
  {
    "text": "good uh so thank you [Applause]",
    "start": "3490760",
    "end": "3497820"
  }
]