[
  {
    "start": "0",
    "end": "49000"
  },
  {
    "text": "all right well thanks uh the five of you for jumping in here um six now so um",
    "start": "5400",
    "end": "13080"
  },
  {
    "text": "please ask any questions as we go through um don't mind jumping into anything um if I don't explain something",
    "start": "13080",
    "end": "19320"
  },
  {
    "text": "or or there's something you want to know about as we go so this one is about detecting malicious activity in Ms SQL",
    "start": "19320",
    "end": "25720"
  },
  {
    "text": "uh I my name's Tristan Bennett I come from Perth Western Australia and work for a small company that provides",
    "start": "25720",
    "end": "32238"
  },
  {
    "text": "Security Services um to organizations within Australia um the GitHub at the bottom um is a repository it does have",
    "start": "32239",
    "end": "38960"
  },
  {
    "text": "all the SQL scripts the detections the Json files and the metadata that we'll go through um so all of that is",
    "start": "38960",
    "end": "44920"
  },
  {
    "text": "available um to you if you want to go and grab that later on SQL logging in 2024 is not something",
    "start": "44920",
    "end": "52039"
  },
  {
    "start": "49000",
    "end": "139000"
  },
  {
    "text": "I thought I would ever be talking about it's a technology that's been around forever um and what we found as we went",
    "start": "52039",
    "end": "58800"
  },
  {
    "text": "through this journey was was that we weren't able to get default logs out of it at all um there's just nothing there",
    "start": "58800",
    "end": "65680"
  },
  {
    "text": "um it all started with um a service called hack the box so hack the box has",
    "start": "65680",
    "end": "71439"
  },
  {
    "text": "uh vulnerable servers that they put up at regular intervals and as a security services provider we try and spend",
    "start": "71439",
    "end": "77920"
  },
  {
    "text": "Friday afternoons doing hack the box and the reason the primary reason I do it is to find new ways of uh attacking things",
    "start": "77920",
    "end": "85960"
  },
  {
    "text": "so that I can then translate that into our research environment replicate those misconfigurations or vulnerabilities and",
    "start": "85960",
    "end": "92840"
  },
  {
    "text": "see if we can then detect an attacker um abusing those for this particular box it",
    "start": "92840",
    "end": "98520"
  },
  {
    "text": "was called SQL and the initial uh Vector that we got in by was using a stored",
    "start": "98520",
    "end": "105360"
  },
  {
    "text": "procedure here called durry an extended stored procedure which allowed us to get the hash of the account that was running",
    "start": "105360",
    "end": "111600"
  },
  {
    "text": "the SQL service once we had that we're able to log on with that hash uh and continue the the attack that way so that",
    "start": "111600",
    "end": "118960"
  },
  {
    "text": "was really cool and so then then what we thought was that's a we've had pentesters in the past come into",
    "start": "118960",
    "end": "124439"
  },
  {
    "text": "environments they moved to Ms SQL because it usually holds a privileged",
    "start": "124439",
    "end": "129840"
  },
  {
    "text": "position within a domain environment or the accounts might um and we didn't we weren't able to see anything um in the",
    "start": "129840",
    "end": "136239"
  },
  {
    "text": "middle about what they were doing within mssql and so we thought this would be a f- minute job we'll Google some advice",
    "start": "136239",
    "end": "142800"
  },
  {
    "text": "on how to get logs out of mcle it's been around forever there must be a huge body of knowledge we'll be able to implement",
    "start": "142800",
    "end": "148599"
  },
  {
    "text": "that we'll write some detection we'll do our testing as normal and we'll go from there the problem was that just didn't",
    "start": "148599",
    "end": "154959"
  },
  {
    "text": "exist so for normal Windows this is for for on-prem servers there's still millions of them out there for Windows",
    "start": "154959",
    "end": "161680"
  },
  {
    "text": "servers it's all fairly well known we have security logs we're able to write detections we have cismon we have EDR",
    "start": "161680",
    "end": "167440"
  },
  {
    "text": "products all those sorts of things and so when an attacker attacks a Windows machine if they're running poers shell",
    "start": "167440",
    "end": "173800"
  },
  {
    "text": "batch scripts uh remotely executing commands relatively simple to detect a",
    "start": "173800",
    "end": "179040"
  },
  {
    "text": "number of tech techniques um and the reason for this is there's a huge body of knowledge out there around",
    "start": "179040",
    "end": "184799"
  },
  {
    "text": "configuring OS security events um and the left hand the picture there's from the Australian cyber security Center",
    "start": "184799",
    "end": "191080"
  },
  {
    "text": "which in Australia is a federal government uh agency that provides a lot of good technical advice about how to",
    "start": "191080",
    "end": "197640"
  },
  {
    "text": "set up Windows security logging and then forwarding that to a log aggregator or a seam or something like that we have",
    "start": "197640",
    "end": "204080"
  },
  {
    "text": "cismon which can be deployed we get device logs from Defender where organizations have um deployed that and",
    "start": "204080",
    "end": "210480"
  },
  {
    "text": "it means that Defender now is not only sending us alerts about suspicious activity it's sending us the raw device",
    "start": "210480",
    "end": "216159"
  },
  {
    "text": "logs that are at the same quality of cismon which is really really high fidelity and then we have other EDR",
    "start": "216159",
    "end": "221959"
  },
  {
    "text": "products which can also send uh device logs so lots of ways to get this stuff",
    "start": "221959",
    "end": "227239"
  },
  {
    "text": "the first two are are free effectively it's configuration and deploying free software and the other two are are paid",
    "start": "227239",
    "end": "233920"
  },
  {
    "text": "for but what we found with databases with mssql in particular is if the once",
    "start": "233920",
    "end": "239120"
  },
  {
    "text": "the attacker get gets into Ms SQL it it's a black hole there's no logging um we can sort of see some authentication",
    "start": "239120",
    "end": "245079"
  },
  {
    "text": "at the start and we may see the effects of what they execute on the other side but there was nothing in the middle and",
    "start": "245079",
    "end": "251159"
  },
  {
    "text": "I think for a long time for socks especially and when we detect pen testers we might detect 30 or 40 things",
    "start": "251159",
    "end": "257280"
  },
  {
    "text": "and we miss five or six and that's still a good day but the five or six May then be in this um s SQL mssql black hole we",
    "start": "257280",
    "end": "264960"
  },
  {
    "text": "we have had that we we know that has happened in the past with some of the testing we've had um and there's just not many detections that we can get and",
    "start": "264960",
    "end": "271520"
  },
  {
    "text": "they're not high quality so authentication is very difficult just off authentication to ascertain the",
    "start": "271520",
    "end": "277400"
  },
  {
    "text": "context and the intent of someone um whereas when you can actually see what they're doing and what they're executing",
    "start": "277400",
    "end": "283120"
  },
  {
    "text": "that's where we're able to determine whether it's malicious or not a lot easier so we did the same thing we",
    "start": "283120",
    "end": "288720"
  },
  {
    "text": "googled um advice on setting up mssql logging and the vast majority came back",
    "start": "288720",
    "end": "295000"
  },
  {
    "text": "it's just products it's just buy this deploy this agent that sort of stuff there was not",
    "start": "295000",
    "end": "300080"
  },
  {
    "text": "much good advice well there was no good advice on um security config auditing",
    "start": "300080",
    "end": "305520"
  },
  {
    "text": "slightly different there is advice on auditing but generally the auditing type logs and the security logs that that we",
    "start": "305520",
    "end": "311160"
  },
  {
    "text": "need to detect attackers are quite different there is some overlap so then I did what everyone else has been doing",
    "start": "311160",
    "end": "317440"
  },
  {
    "text": "lately and just ran them through Ai and asked chat GPT how to detect attackers in mssql and while there's a lot of",
    "start": "317440",
    "end": "324160"
  },
  {
    "text": "words there's not a lot of advice in there um it's very confident and it writes a lot um but the main points were",
    "start": "324160",
    "end": "331080"
  },
  {
    "text": "detect unusual patterns of access anomalies or suspicious patterns and unexpected or un if it was that easy if",
    "start": "331080",
    "end": "337600"
  },
  {
    "text": "I could just write a rule and say hey tell me when there's unusual patterns of access then I I wouldn't have a job um",
    "start": "337600",
    "end": "343720"
  },
  {
    "text": "so all of the advice was very very high level nothing that I could actually technically um work with or",
    "start": "343720",
    "end": "351080"
  },
  {
    "text": "Implement um going back to the default logging so then we spun upcm and we've",
    "start": "351080",
    "end": "356440"
  },
  {
    "text": "got a few um other products that run mssql in the background ground um and had a look at what the default logging",
    "start": "356440",
    "end": "362160"
  },
  {
    "text": "was and there are no security audits there are no database uh specifications",
    "start": "362160",
    "end": "367360"
  },
  {
    "text": "and there are no server audit specifications and what these are is the server security audit just tells it",
    "start": "367360",
    "end": "373560"
  },
  {
    "text": "where to write the logs and turns the auditing on is very simple the database audit you do for each database that you",
    "start": "373560",
    "end": "379599"
  },
  {
    "text": "want to monitor so the majority of these for us was in the master database because that's always there uh and it's",
    "start": "379599",
    "end": "386319"
  },
  {
    "text": "not custom uh and then msdb I believe has um jobs and other things that run in Ms SQL and then the server audit is more",
    "start": "386319",
    "end": "394720"
  },
  {
    "text": "across the whole server so granting privileges to user accounts not specifically for a database but across",
    "start": "394720",
    "end": "399759"
  },
  {
    "text": "the database server are held in the um server audit specifications as well as",
    "start": "399759",
    "end": "404919"
  },
  {
    "text": "authentication and there's none of those by default there is one you can check very",
    "start": "404919",
    "end": "411039"
  },
  {
    "text": "easily which is the uh auditing for logons um and we used to turn this on",
    "start": "411039",
    "end": "416240"
  },
  {
    "text": "for both failed and successful logons the problem with this is that every time SQL runs internal jobs and does things",
    "start": "416240",
    "end": "423160"
  },
  {
    "text": "internally it will generate login or authentication events and they're very high volume and very low value so now",
    "start": "423160",
    "end": "430560"
  },
  {
    "text": "with the audit spec that you'll see later on we've actually um told organizations to turn that login auditing off if they don't need it for",
    "start": "430560",
    "end": "437160"
  },
  {
    "text": "audit purposes so every time I mention something and say we've turned it off",
    "start": "437160",
    "end": "442199"
  },
  {
    "text": "that's the that's the caveat if you need it for auditing that's different we don't need those logs for detecting um",
    "start": "442199",
    "end": "448000"
  },
  {
    "text": "attackers or attack tools or techniques and things like that so what we ended up having to build",
    "start": "448000",
    "end": "455280"
  },
  {
    "start": "452000",
    "end": "875000"
  },
  {
    "text": "out of all this which turned into sort of an 8 to 12 week journey to get um what we would consider the Baseline",
    "start": "455280",
    "end": "461319"
  },
  {
    "text": "monitoring for Ms SQL was a set of configurations which is um very generic",
    "start": "461319",
    "end": "468680"
  },
  {
    "text": "um it doesn't include custom stuff for each organization we work with that sort of phase two uh documentation and the",
    "start": "468680",
    "end": "474960"
  },
  {
    "text": "reason this was important was um database administrators um some sometimes don't want certain things",
    "start": "474960",
    "end": "480639"
  },
  {
    "text": "audited or they may ask why we're auditing a particular stored procedure or a piece of config in our audit",
    "start": "480639",
    "end": "486879"
  },
  {
    "text": "scripts and what we're able to do with this documentation was link it back to our detections and show them as part of",
    "start": "486879",
    "end": "492159"
  },
  {
    "text": "an attack chain this is why we need these bits of auditing it's going to result in this detection if it's too",
    "start": "492159",
    "end": "498360"
  },
  {
    "text": "high volume or sensitive for the organization here's what you lose and it's very um easy to talk when we've got",
    "start": "498360",
    "end": "504039"
  },
  {
    "text": "the demonstrations and uh and able to say this is what you'll lose if we turn this off it's not the end of the world",
    "start": "504039",
    "end": "509520"
  },
  {
    "text": "we can still detect attackers around these areas the detections themselves that was actually the easiest um and",
    "start": "509520",
    "end": "515640"
  },
  {
    "text": "you'll see the logic for them is laughably simple all of the work is in configuring it and understanding uh the",
    "start": "515640",
    "end": "522080"
  },
  {
    "text": "logs that are produced matching those to detect an attack is actually the easiest part of all of this uh and then we had",
    "start": "522080",
    "end": "528920"
  },
  {
    "text": "an attack demo I wasn't game enough to live demo um back to my machined in Perth um so I've got some videos of",
    "start": "528920",
    "end": "535880"
  },
  {
    "text": "parts of the attack chain that abuse mssql to get us a um a beacon back to a",
    "start": "535880",
    "end": "541320"
  },
  {
    "text": "tool called Empire and then to steal ntlm",
    "start": "541320",
    "end": "546000"
  },
  {
    "text": "hashers the config um so we did start in the guey turning things on and and",
    "start": "546640",
    "end": "551959"
  },
  {
    "text": "adding all of these configurations uh and then we uh improved and it's all in one script now so what this one does is",
    "start": "551959",
    "end": "559959"
  },
  {
    "text": "sets the name of our audit spec and it tells it to write it to the application logs locally uh you could write them to",
    "start": "559959",
    "end": "565920"
  },
  {
    "text": "the security logs we just had an issue with the account not being uh admin to write to those so for our research",
    "start": "565920",
    "end": "571880"
  },
  {
    "text": "environment we point them to the application log the big difference in a Windows box is you need to be local",
    "start": "571880",
    "end": "577480"
  },
  {
    "text": "admin to read security you don't need to be local admin to read the application log so if the organization is",
    "start": "577480",
    "end": "582880"
  },
  {
    "text": "particularly sensitive about what might be in these logs write them across to the security logs uh and Grant the um",
    "start": "582880",
    "end": "589240"
  },
  {
    "text": "the SQL service account uh access to local admin and it turns on the loging with that last line State on if we",
    "start": "589240",
    "end": "595880"
  },
  {
    "text": "didn't use the script every time we make a change we got to restart the uh SQL Services whereas running the script",
    "start": "595880",
    "end": "602040"
  },
  {
    "text": "actually restarts it in the background for us so it did save us a lot of time cuz as you'll see SQL auditing is",
    "start": "602040",
    "end": "607760"
  },
  {
    "text": "extremely specific which is one of its downfalls here's the goey to turn it all",
    "start": "607760",
    "end": "613000"
  },
  {
    "text": "on um the reason I put these in is just so you never have to look at them again this one's not too bad it's easy enough to configure but the rest are stay away",
    "start": "613000",
    "end": "620680"
  },
  {
    "text": "type things this is the datab base audit so this is on Master itself um as you can",
    "start": "620680",
    "end": "625959"
  },
  {
    "text": "see the very B use master so then if we were doing custom and we'll show it a little bit later we'll just use a",
    "start": "625959",
    "end": "631279"
  },
  {
    "text": "different database and put our database um auditing in there but as you can see it's line by line so what I what you",
    "start": "631279",
    "end": "638160"
  },
  {
    "text": "can't do in SQL is say let me know if someone executes any stored procedure",
    "start": "638160",
    "end": "643920"
  },
  {
    "text": "you can't do it like that you can't use Stars you need to say let me know if someone executes the dur tree stored",
    "start": "643920",
    "end": "650320"
  },
  {
    "text": "procedure next line this stored procedure this store procedure this store procedure going through and doing",
    "start": "650320",
    "end": "656200"
  },
  {
    "text": "that in the guy just you just wouldn't do it um and as you can see there's a lot there and then we have by dbo we",
    "start": "656200",
    "end": "663120"
  },
  {
    "text": "also then need to replicate this config um minimum of three times for guest and Public Access just in case most of these",
    "start": "663120",
    "end": "670800"
  },
  {
    "text": "store procedures cannot be executed by guest and public but we put that config in as insurance just in case there's a",
    "start": "670800",
    "end": "677120"
  },
  {
    "text": "misconfiguration then it's extremely easy to spot when these are run when they shouldn't",
    "start": "677120",
    "end": "682320"
  },
  {
    "text": "be um the detail doesn't matter so much but this is the the entire script and you can sort of see those repeating",
    "start": "682320",
    "end": "687760"
  },
  {
    "text": "blocks that we had to do for the different uh user types in the in the um in the",
    "start": "687760",
    "end": "694120"
  },
  {
    "text": "database then we have the goey so once again don't just don't do it this way this is how I started and each line is a",
    "start": "694279",
    "end": "700920"
  },
  {
    "text": "drop down till we get so you drop execute down you drop object down all of this is manual it doesn't pre-populate",
    "start": "700920",
    "end": "708040"
  },
  {
    "text": "um then you search for the stored procedure you want and the other thing",
    "start": "708040",
    "end": "713360"
  },
  {
    "text": "we found is not all of the stored procedures are in the guey so we audit some of the stored procedures in in the",
    "start": "713360",
    "end": "719360"
  },
  {
    "text": "SQL script that are not available here and that was a big time waster because we didn't know how to audit certain",
    "start": "719360",
    "end": "725760"
  },
  {
    "text": "stored procedures in the in the guey when we added them in based on what we thought the names would be in the SQL",
    "start": "725760",
    "end": "732000"
  },
  {
    "text": "script it all worked which is quite frustrating that it's not exposed here and then you'll pick your user so you",
    "start": "732000",
    "end": "738120"
  },
  {
    "text": "can imagine doing these line by line by line by line and then having to do it three times each of the user types I",
    "start": "738120",
    "end": "743320"
  },
  {
    "text": "think I got down to about here before I was like I'm going to find out how to do this with SQL scripts properly um and",
    "start": "743320",
    "end": "749680"
  },
  {
    "text": "saved a huge amount of time then we have the server order this isn't too bad because it's server wide",
    "start": "749680",
    "end": "755519"
  },
  {
    "text": "it's not specific to datab bases and you can see usual things such as uh group changes impersonations uh failed logins",
    "start": "755519",
    "end": "763399"
  },
  {
    "text": "we didn't do successful logins because the volumes once again because of the internal processes they're just too high",
    "start": "763399",
    "end": "770480"
  },
  {
    "text": "and if someone executes a store procedure we can infer that they have successfully logged in the log on event",
    "start": "770480",
    "end": "775959"
  },
  {
    "text": "to us didn't matter from a security point of view but some organizations may need that from an audit perspective so",
    "start": "775959",
    "end": "782399"
  },
  {
    "text": "all of these only need to be done once um whereas the other ones if we have custom databases we need to do it for",
    "start": "782399",
    "end": "787760"
  },
  {
    "text": "those as well this one you could do in the guey because you just drop these down and okay and off you go but you may as well",
    "start": "787760",
    "end": "794120"
  },
  {
    "text": "just put it that the scripts are available in that GitHub repository you may as well just put them into one script and",
    "start": "794120",
    "end": "799600"
  },
  {
    "text": "go um this is what it looks like if we just paste that into sort of the management studio and run it and we just",
    "start": "799600",
    "end": "804800"
  },
  {
    "text": "get a nice single line completed successfully uh in the gith repository there's two versions of the script",
    "start": "804800",
    "end": "811000"
  },
  {
    "text": "there's a pre 20107 and a post 2017 and that's because before 2017 there there's",
    "start": "811000",
    "end": "817880"
  },
  {
    "text": "a particular extended uh stored procedure that's not in the database and so it errors out um and that's the",
    "start": "817880",
    "end": "823920"
  },
  {
    "text": "trusted assembly one that's in there somewhere and it's quite cool I'll show you that one in a sec so now we have in our database if we",
    "start": "823920",
    "end": "832519"
  },
  {
    "text": "go and have a look under the master database we have our Master audit under the msdb we have our um msdb audit we've",
    "start": "832519",
    "end": "840959"
  },
  {
    "text": "got the turn on which says Hey WR its application and we have our um server",
    "start": "840959",
    "end": "846399"
  },
  {
    "text": "audit spec these will come in instantly the other thing that got me is uh that",
    "start": "846399",
    "end": "851880"
  },
  {
    "text": "refresh button there doesn't refresh the whole tree it only refreshes what you select so if I have that selected and",
    "start": "851880",
    "end": "858360"
  },
  {
    "text": "refresh it'll show that but that one won't show up that took me way too long to realize that all my audit specs were",
    "start": "858360",
    "end": "864399"
  },
  {
    "text": "there I just on a re on a refresh they didn't show up so there was just lots of these little things that kept getting in",
    "start": "864399",
    "end": "870480"
  },
  {
    "text": "the way um of of getting this done quickly documentation this was really",
    "start": "870480",
    "end": "877880"
  },
  {
    "start": "875000",
    "end": "1062000"
  },
  {
    "text": "important this is this is what we then gave to organizations when we're first approaching them as as as their sock to",
    "start": "877880",
    "end": "884880"
  },
  {
    "text": "turn all of this stuff on because every time we approach infrastructure teams about adding new agents new config new",
    "start": "884880",
    "end": "891199"
  },
  {
    "text": "logging new anything there are always questions what impact will it have on the system um why do we need to do this",
    "start": "891199",
    "end": "897480"
  },
  {
    "text": "all of those common questions questions that we sought to answer through a full demo and a showing of what we're going",
    "start": "897480",
    "end": "903000"
  },
  {
    "text": "to do with these logs um and so what we did was we categorize them at the high",
    "start": "903000",
    "end": "908680"
  },
  {
    "text": "level of the attack Matrix about where it sort of fit we um the the tool we use",
    "start": "908680",
    "end": "914639"
  },
  {
    "text": "to test the specific command and this meant for the security teams at organizations they could go and use",
    "start": "914639",
    "end": "920600"
  },
  {
    "text": "PowerUp SQL and run this with a with a different IP address and they should",
    "start": "920600",
    "end": "925839"
  },
  {
    "text": "generate detections for those um detections and it's because of this auditing and that really helps the",
    "start": "925839",
    "end": "932040"
  },
  {
    "text": "conversation where someone says we we can't just due to volumes or something",
    "start": "932040",
    "end": "937120"
  },
  {
    "text": "um AIT let's say trusted assemblies so we can say okay well this is in the",
    "start": "937120",
    "end": "942399"
  },
  {
    "text": "execution phase of an attack and this is the um detection we don't get and then demonstrate in our environment how an",
    "start": "942399",
    "end": "948959"
  },
  {
    "text": "attacker would use that so for each of them um we had all",
    "start": "948959",
    "end": "954079"
  },
  {
    "text": "of these these were all in um this is in a spreadsheet but it's also in Json as well and so will have all of this um",
    "start": "954079",
    "end": "960839"
  },
  {
    "text": "information and where the evid is and these are important um for for us in monitoring um they're all",
    "start": "960839",
    "end": "968120"
  },
  {
    "text": "33205 um but this lets us filter them in the um platforms that we that the logs end up in and then we tried to put just",
    "start": "968120",
    "end": "974959"
  },
  {
    "text": "a sort of a human more human readable I'm terrible at it cuz I just write the technical side of what's Happening um",
    "start": "974959",
    "end": "982079"
  },
  {
    "text": "about what it's doing so this one we can get the ntlm hash um and even though Microsoft have kind of said get rid of",
    "start": "982079",
    "end": "988800"
  },
  {
    "text": "ntlm for the last 20 years I don't know of an organization who has fully gotten rid of the ability to use ntlm um and so",
    "start": "988800",
    "end": "996519"
  },
  {
    "text": "NM hashes are still extremely valuable and you'll get it whichever is running the SQL service",
    "start": "996519",
    "end": "1003680"
  },
  {
    "text": "account the Json we have for each of the um detections themselves just puts it into the attack Matrix here um C CSC a",
    "start": "1003680",
    "end": "1012800"
  },
  {
    "text": "brief description we have some other stuff that we use internally for for our sock around testing and some references",
    "start": "1012800",
    "end": "1018800"
  },
  {
    "text": "um and the other thing that we can use this for is um these go into our playbooks for our analysts so it's all just sitting there nicely in Json to be",
    "start": "1018800",
    "end": "1024959"
  },
  {
    "text": "used later however we need to uh and then we run a set a test Json",
    "start": "1024959",
    "end": "1030240"
  },
  {
    "text": "as well and so it means very easily I can um so testing the SP trusted assembly I can go and grab that command",
    "start": "1030240",
    "end": "1036720"
  },
  {
    "text": "I know which tool I have to use and I can go and go and test that the vision is as well is we have started to",
    "start": "1036720",
    "end": "1042520"
  },
  {
    "text": "construct and build out um automated testing I know that there are products out there um but for the size and the",
    "start": "1042520",
    "end": "1047959"
  },
  {
    "text": "scale we want to do with them they're they're cost prohibitive um and so what we can do is take this Json and run",
    "start": "1047959",
    "end": "1053799"
  },
  {
    "text": "automated testing in our customers quite easily these are all in the GitHub repository as well for all of the",
    "start": "1053799",
    "end": "1060400"
  },
  {
    "text": "detections and how to test them this testing took up a huge a huge",
    "start": "1060400",
    "end": "1067200"
  },
  {
    "start": "1062000",
    "end": "1239000"
  },
  {
    "text": "amount of time um because what we would have to do is put the config in do the",
    "start": "1067200",
    "end": "1072919"
  },
  {
    "text": "test hope the log was created as expected and if it wasn't go back and either have a look at source code of",
    "start": "1072919",
    "end": "1078159"
  },
  {
    "text": "tool tools to understand what stored procedures they were using rerun test again and try to get the logs and so it",
    "start": "1078159",
    "end": "1084200"
  },
  {
    "text": "was this back and forth because we couldn't say in SQL um give me a log for every execution of",
    "start": "1084200",
    "end": "1091760"
  },
  {
    "text": "a store procedure because that's not possible so we started with uh HAC tricks which is it's fantastic it's a",
    "start": "1091760",
    "end": "1097200"
  },
  {
    "text": "great resource um and what we did here was we wanted to understand cuz we could go and run this is crap map ex CME we",
    "start": "1097200",
    "end": "1105000"
  },
  {
    "text": "could go and run that and say hey let's steal nlm hashes but we don't really understand what's happening the thing",
    "start": "1105000",
    "end": "1111559"
  },
  {
    "text": "for us on the defense side is I like to we like to fully understand what is actually happening and so what we can do",
    "start": "1111559",
    "end": "1117760"
  },
  {
    "text": "is actually run raw SQL remotely using a tool called SQ shell which is just built",
    "start": "1117760",
    "end": "1123240"
  },
  {
    "text": "into Linux and so once we've once we've logged in we just use Carly but once we've logged in we can then go and run a",
    "start": "1123240",
    "end": "1129640"
  },
  {
    "text": "command shell of who am I and understand a bit more what's happening rather than just let a tool do it for us which most",
    "start": "1129640",
    "end": "1136000"
  },
  {
    "text": "attackers do it makes it really easy cuz the tools try do everything all at once whereas if they logged in and did things",
    "start": "1136000",
    "end": "1141600"
  },
  {
    "text": "one by one it might be more difficult to detect but it's not and you can see here our XP dirry stuff this is the one that",
    "start": "1141600",
    "end": "1148640"
  },
  {
    "text": "was the Catalyst for everything also then tells you um how to set up responder which is a piece of software",
    "start": "1148640",
    "end": "1154480"
  },
  {
    "text": "that's going to capture that hash and then um well you you need the SMB share",
    "start": "1154480",
    "end": "1159640"
  },
  {
    "text": "and then you can go and relay those um inm hashes this is SQL shell it's just the",
    "start": "1159640",
    "end": "1165640"
  },
  {
    "text": "man page for that it's just built in you can just execute raw SQL commands really easily from Linux as long as you have uh",
    "start": "1165640",
    "end": "1172400"
  },
  {
    "text": "a user that's allowed to log on metas sploit it's been around forever has a h cor modules for MSC call makes",
    "start": "1172400",
    "end": "1179200"
  },
  {
    "text": "it really easy to do things um and test and all of these are open source which meant we could always go back to source",
    "start": "1179200",
    "end": "1185559"
  },
  {
    "text": "code if something um we didn't understand how something worked crack map exac has a few um SQL modules as",
    "start": "1185559",
    "end": "1192880"
  },
  {
    "text": "well great tool very easy to use SQL Recons built-in net um and then the",
    "start": "1192880",
    "end": "1198360"
  },
  {
    "text": "reason we tried all of these different tools is they can all do the same thing and they all do it differently so we",
    "start": "1198360",
    "end": "1204799"
  },
  {
    "text": "would use Metasploit to steal NM hashers and then use SQL Recon and they might do it in slightly different ways or produce",
    "start": "1204799",
    "end": "1211320"
  },
  {
    "text": "different data in our logs and so then Fe each detection we would see if the",
    "start": "1211320",
    "end": "1216360"
  },
  {
    "text": "tool could do it go back and test with each of these tools uh so that one's net um built from uh someone that works at",
    "start": "1216360",
    "end": "1223120"
  },
  {
    "text": "IBM security intelligence really good tool um and then the last one was power",
    "start": "1223120",
    "end": "1228320"
  },
  {
    "text": "up SQL which is built in poell so we tried to also pick things that were written in different languages CU it",
    "start": "1228320",
    "end": "1233679"
  },
  {
    "text": "actually makes quite a big difference sometimes to the logs that we",
    "start": "1233679",
    "end": "1239120"
  },
  {
    "start": "1239000",
    "end": "1341000"
  },
  {
    "text": "get this is where the fun begins I suppose the detections and this is ultimately our goal this is what we're",
    "start": "1239880",
    "end": "1245240"
  },
  {
    "text": "trying to do is detect attackers uh and what we did is we focused on stored procedure use because",
    "start": "1245240",
    "end": "1251360"
  },
  {
    "text": "there's a huge amount of power in those and there's lots of them um SQL queries themselves so looking for password",
    "start": "1251360",
    "end": "1257240"
  },
  {
    "text": "hashes um dumping out users just Recon activities that um attackers will often do because within SQL you can then find",
    "start": "1257240",
    "end": "1264280"
  },
  {
    "text": "linked servers and you can find a heap of other things that will allow you to potentially move laterally through the",
    "start": "1264280",
    "end": "1269840"
  },
  {
    "text": "environment through SQL um and in the past it would have been a black hole no one would have been out well we wouldn't have been able to see what was",
    "start": "1269840",
    "end": "1276480"
  },
  {
    "text": "happening authentication uh is is interesting it was the third one down",
    "start": "1276480",
    "end": "1281640"
  },
  {
    "text": "it's a usual though it's brute forcing it's enumeration um but what we find is when",
    "start": "1281640",
    "end": "1287240"
  },
  {
    "text": "an attacker gets position to log in generally there'll be a single or attempt on SQL they're not really brute",
    "start": "1287240",
    "end": "1293320"
  },
  {
    "text": "forcing um SQL they may Brute Force users on the domain beforehand in in various ways actual brute forcing is",
    "start": "1293320",
    "end": "1299400"
  },
  {
    "text": "equal we we we haven't seen it unless they're trying to um just Pro just prove",
    "start": "1299400",
    "end": "1305120"
  },
  {
    "text": "a point or or get a detection raised and then there's some others around config changes because some of the store",
    "start": "1305120",
    "end": "1311559"
  },
  {
    "text": "procedures require a quick config change to use them and so we can um have a look for those and privilege change the",
    "start": "1311559",
    "end": "1318559"
  },
  {
    "text": "problem with privilege change and cict change is those are normal activities they happen all day every day executing",
    "start": "1318559",
    "end": "1324679"
  },
  {
    "text": "dirry just doesn't happen every day and so there's that that value or that um Fidelity we get from the log and we can",
    "start": "1324679",
    "end": "1330919"
  },
  {
    "text": "understand this is probably malicious someone changing another admin's privileges while it might be a query to",
    "start": "1330919",
    "end": "1336240"
  },
  {
    "text": "a team if it looks suspect it happens all day every",
    "start": "1336240",
    "end": "1340760"
  },
  {
    "start": "1341000",
    "end": "1550000"
  },
  {
    "text": "day so the first one we looked for around password around uh SQL queries",
    "start": "1341320",
    "end": "1346640"
  },
  {
    "text": "was anyone looking for the password hashers which are stored for all the local accounts in SQL um and so what",
    "start": "1346640",
    "end": "1352760"
  },
  {
    "text": "I've done is not so we all read it because it's a waste of time but you can copy that out it's not a picture um so",
    "start": "1352760",
    "end": "1359039"
  },
  {
    "text": "what I hate in presentations is where code is just images and I've got to type it out but this one here if you run that",
    "start": "1359039",
    "end": "1365000"
  },
  {
    "text": "in a SQL database and you have uh the correct level of privilege um we'll return you all of the local accounts and",
    "start": "1365000",
    "end": "1372559"
  },
  {
    "text": "the windows accounts the windows accounts won't have their password uh as we can see sort of here it's a Windows",
    "start": "1372559",
    "end": "1378200"
  },
  {
    "text": "log on so there's no password but sa we get the password hash that does",
    "start": "1378200",
    "end": "1383960"
  },
  {
    "text": "have to be cracked but if it's a poor password which essay accounts from 10 years ago that have never had their",
    "start": "1383960",
    "end": "1389840"
  },
  {
    "text": "password rotated might be um cracking may be trivial and there's a good bet",
    "start": "1389840",
    "end": "1394880"
  },
  {
    "text": "essay is reused across databases once you got essay you've got everything in that",
    "start": "1394880",
    "end": "1400039"
  },
  {
    "text": "database if you run that uh query as well in like management Studio you get a",
    "start": "1400039",
    "end": "1405080"
  },
  {
    "text": "nicer table and you can see here all the hashers yeah you've got those in your database probably in trouble but these",
    "start": "1405080",
    "end": "1410400"
  },
  {
    "text": "are my test accounts um but you get all the hashers uh and they're not salted I just use different",
    "start": "1410400",
    "end": "1416159"
  },
  {
    "text": "passwords actually these ones might be saled domain ones aren't these ones might",
    "start": "1416159",
    "end": "1421520"
  },
  {
    "text": "be so to detect someone quering password hashes this is it this is the logic and",
    "start": "1421520",
    "end": "1426720"
  },
  {
    "text": "this where where all the hard work if you just look at the detection you'd say oh that's really really easy and it kind",
    "start": "1426720",
    "end": "1432520"
  },
  {
    "text": "of is we just want a 33205 and that's just within our um within platform",
    "start": "1432520",
    "end": "1438039"
  },
  {
    "text": "that's just a quick way to get the right subset of logs then we just want the statement to contain",
    "start": "1438039",
    "end": "1444159"
  },
  {
    "text": "password and it's just not common um and if someone is making a query on a database with password hash um firstly",
    "start": "1444159",
    "end": "1451679"
  },
  {
    "text": "we're going to group by username and host name so what we can do later on is have a look and if it's an internal",
    "start": "1451679",
    "end": "1457000"
  },
  {
    "text": "process we can look at any of these fields um so application name users",
    "start": "1457000",
    "end": "1463120"
  },
  {
    "text": "those sorts of things and say okay this happens all the time don't alarm on this but what you'll see here as well is this",
    "start": "1463120",
    "end": "1470520"
  },
  {
    "text": "application name is that SQL shell so if you're in an environment with predominantly Windows machines and we",
    "start": "1470520",
    "end": "1476200"
  },
  {
    "text": "see any query with SQL shell it's probably a good chance an admin's doing",
    "start": "1476200",
    "end": "1481520"
  },
  {
    "text": "something they shouldn't or someone has access that shouldn't the the pitfall the downfall",
    "start": "1481520",
    "end": "1487600"
  },
  {
    "text": "of things like relying relying on that it's a good it's a good rule that we can have in the background looking for",
    "start": "1487600",
    "end": "1493960"
  },
  {
    "text": "remote execution of any query because of the app name but but the it's attacker",
    "start": "1493960",
    "end": "1499120"
  },
  {
    "text": "controlled so if I use a different tool now I've got this one so a lot of this is we have lots of overlapping",
    "start": "1499120",
    "end": "1506200"
  },
  {
    "text": "detections cuz there's no one detection for anything that will say you've been compromised um different users the quer",
    "start": "1506200",
    "end": "1513880"
  },
  {
    "text": "is the same but this changes now um and so while SQL shell is good I'm probably never going to have a rule looking for",
    "start": "1513880",
    "end": "1520520"
  },
  {
    "text": "the Microsoft SQL management Studio executing queries so it's not about not",
    "start": "1520520",
    "end": "1525600"
  },
  {
    "text": "having this rule not relying on it so this one's quite cool as you can",
    "start": "1525600",
    "end": "1531520"
  },
  {
    "text": "see we get the statement or the SQL query that's run and the beauty of these logs is we never get the return results",
    "start": "1531520",
    "end": "1537600"
  },
  {
    "text": "CU a lot of the initial organizations we worked with were worried that there'd be sensitive information in the logs it",
    "start": "1537600",
    "end": "1543240"
  },
  {
    "text": "never ever logs the um the return data which is exactly what we want from a security point of",
    "start": "1543240",
    "end": "1550080"
  },
  {
    "start": "1550000",
    "end": "1648000"
  },
  {
    "text": "view so then we have uh stored procedures and this this is where all the power for an attacker is these are",
    "start": "1550640",
    "end": "1556880"
  },
  {
    "text": "fantastic um as you can see there are lots you can go and have a look at all the stored",
    "start": "1556880",
    "end": "1562240"
  },
  {
    "text": "procedures in a SQL database and for the non-extended ones you'll have all of the",
    "start": "1562240",
    "end": "1568039"
  },
  {
    "text": "code for them so this one here is ADD log on and this is what it goes and does when we use the stored procedure to add",
    "start": "1568039",
    "end": "1574120"
  },
  {
    "text": "a new user to this database um and you can go and have a look and see what it does for extended procedures they're",
    "start": "1574120",
    "end": "1581640"
  },
  {
    "text": "generally more complex although this one really isn't but they're generally more complex and they're implemented through dlls so you can't really see the code um",
    "start": "1581640",
    "end": "1589799"
  },
  {
    "text": "in SQL and for us and what we needed to do there is no point in us trying to",
    "start": "1589799",
    "end": "1595640"
  },
  {
    "text": "even reverse a dll there's just no point we know what it does at a high enough level to understand what an attack will",
    "start": "1595640",
    "end": "1602440"
  },
  {
    "text": "abuse it for but as you can see there are lots of stored procedures extended stored procedures sorry you can",
    "start": "1602440",
    "end": "1608520"
  },
  {
    "text": "manipulate the registry so you can read and write the registry and the SQL account by default will run a system so",
    "start": "1608520",
    "end": "1614880"
  },
  {
    "text": "you can change anything in the registry and there are still cool attack techniques where you can downgrade and",
    "start": "1614880",
    "end": "1620440"
  },
  {
    "text": "get plain text passwords in memory use registry um tweaks you can enumerate",
    "start": "1620440",
    "end": "1625960"
  },
  {
    "text": "lots of things and you can copy and change um files on the on the disk as well through SQL you can even read files",
    "start": "1625960",
    "end": "1632919"
  },
  {
    "text": "and it will just bring them back in a table so you can read text files in SQL that are in um local admin type areas on",
    "start": "1632919",
    "end": "1640200"
  },
  {
    "text": "C drive it's pretty cool or because it runs a system or it runs as a service",
    "start": "1640200",
    "end": "1645360"
  },
  {
    "text": "account which generally has a high level of privilege so dirry is what started all of this and",
    "start": "1645360",
    "end": "1651840"
  },
  {
    "start": "1648000",
    "end": "2055000"
  },
  {
    "text": "the reason it's notorious public can execute dirry by default even to this",
    "start": "1651840",
    "end": "1656880"
  },
  {
    "text": "day the recommendation out there if you look up dirry is stop it from being publicly executable um and all the",
    "start": "1656880",
    "end": "1663240"
  },
  {
    "text": "testing we've done that's not a common config change to make so using TR true and trusted uh",
    "start": "1663240",
    "end": "1670640"
  },
  {
    "text": "metas spit um we set all of these and we we run it as an exploit and I've just chucked that in there for anyone it does",
    "start": "1670640",
    "end": "1676720"
  },
  {
    "text": "have metlo um all you'll need to change is obviously your authentication and your IPS um but that will then go off and try",
    "start": "1676720",
    "end": "1683120"
  },
  {
    "text": "and steal um nlm hashes so then on a um another console",
    "start": "1683120",
    "end": "1689799"
  },
  {
    "text": "window we'll set up responder and that's what captures the hash so responder generally will set up an SMB share a",
    "start": "1689799",
    "end": "1695440"
  },
  {
    "text": "fake SMB share um and the way V1 works is the SQL Server actually authenticates",
    "start": "1695440",
    "end": "1702000"
  },
  {
    "text": "to you without knowing who you are hence we get the hash so I've got a here of doing it uh",
    "start": "1702000",
    "end": "1709039"
  },
  {
    "text": "so on the right hand side this is just us using SQL shell to jump into this SQL",
    "start": "1709039",
    "end": "1714080"
  },
  {
    "text": "Server as a normal user with a password um and on this side I'm going to run a",
    "start": "1714080",
    "end": "1720039"
  },
  {
    "text": "tool called nlm relay x what that does is in this hosts file I have four",
    "start": "1720039",
    "end": "1725440"
  },
  {
    "text": "servers that I know about in the environment and what this will do is it will relay them to each of those servers",
    "start": "1725440",
    "end": "1731279"
  },
  {
    "text": "to see whether we can authenticate and steal credits so we'll set that up it starts",
    "start": "1731279",
    "end": "1738200"
  },
  {
    "text": "all of the different protocols and as you can see there's lots we can abuse this will be an SMB abuse though and",
    "start": "1738200",
    "end": "1743880"
  },
  {
    "text": "then on this side we'll log in with SQL shell and it's just a command line",
    "start": "1743880",
    "end": "1749360"
  },
  {
    "text": "interface like that no autocomplete no tabbing nothing very rudimentary but it works and so",
    "start": "1749360",
    "end": "1756480"
  },
  {
    "text": "here we're executing durry against this IP which is over there and it's a it's an SB share that doesn't even exist it",
    "start": "1756480",
    "end": "1763080"
  },
  {
    "text": "doesn't need to exist so what we can see here is very Qui quickly it just goes and throws",
    "start": "1763080",
    "end": "1769159"
  },
  {
    "text": "those nlm authentication uh relays it over to other machines now it does fail",
    "start": "1769159",
    "end": "1775200"
  },
  {
    "text": "CU you can't really relay to yourself easily you kind of can but you can't so it fails but we get some successes and",
    "start": "1775200",
    "end": "1782360"
  },
  {
    "text": "then we get usable hashes here so the SQL service account is local admin on",
    "start": "1782360",
    "end": "1787960"
  },
  {
    "text": "this box and using remote register we can dump those hashes out these can be used on the command line to then",
    "start": "1787960",
    "end": "1794799"
  },
  {
    "text": "authenticate these don't need to be relayed or decreed crypted these are usable",
    "start": "1794799",
    "end": "1800159"
  },
  {
    "text": "hashes so the important bits here yep we log on we run it we get the account for",
    "start": "1800159",
    "end": "1805320"
  },
  {
    "text": "SVC SQL if it was the system account it would be the host name dollar and it",
    "start": "1805320",
    "end": "1811640"
  },
  {
    "text": "wouldn't be as useful we can still use it in the domain it is a user account we unlikely be able to authenticate to",
    "start": "1811640",
    "end": "1817279"
  },
  {
    "text": "other boxes um and whoops go back uh and then we get failes",
    "start": "1817279",
    "end": "1824240"
  },
  {
    "text": "we get some successes and then here we get the LM and the NT and these are usable so for organizations that have",
    "start": "1824240",
    "end": "1830320"
  },
  {
    "text": "completely got rid of SMB V1 um and the ability to authenticate with NTM these",
    "start": "1830320",
    "end": "1835720"
  },
  {
    "text": "aren't going to be useful um but I I haven't come across an organization U that has fully gotten rid of nlm",
    "start": "1835720",
    "end": "1843679"
  },
  {
    "text": "yet also that's quite difficult to detect because remote registry doesn't log anything so you'd be surprised at",
    "start": "1843679",
    "end": "1849360"
  },
  {
    "text": "what Windows does and doesn't log there are tools but when I say we can't detect something that it's in pure logs um",
    "start": "1849360",
    "end": "1855880"
  },
  {
    "text": "having Defender crowd strike those edrs generally they're not going to be happy when we dump Sam with remote registry",
    "start": "1855880",
    "end": "1861559"
  },
  {
    "text": "but from a pure logging point of view remote registry starts and stops and that's all we",
    "start": "1861559",
    "end": "1868320"
  },
  {
    "text": "see so once again the detection is laughably simple but we're looking for a",
    "start": "1868360",
    "end": "1873519"
  },
  {
    "text": "33205 and the statement just needs to contain dirry and the reason we start",
    "start": "1873519",
    "end": "1878559"
  },
  {
    "text": "broad is so that we can understand for an organization if this never fires we can leave the rule like that if",
    "start": "1878559",
    "end": "1884639"
  },
  {
    "text": "something is checking what the structure looks like then we can fine-tune our",
    "start": "1884639",
    "end": "1889840"
  },
  {
    "text": "rules down but there's no point starting from a narrow scope and missing things",
    "start": "1889840",
    "end": "1894919"
  },
  {
    "text": "because it's burnt Us in the past where we assume something and so that's why the start of these detections is very",
    "start": "1894919",
    "end": "1900559"
  },
  {
    "text": "very simple and for the stored procedures the queries anything above",
    "start": "1900559",
    "end": "1905679"
  },
  {
    "text": "authentication the false positive rate coming coming out of systems in big Enterprises is very very",
    "start": "1905679",
    "end": "1912760"
  },
  {
    "text": "low once again Group by username and host name depending on the the seam or the logging platform that you're using",
    "start": "1912760",
    "end": "1918440"
  },
  {
    "text": "this can be useful for grouping things together and being able to search and using entities in Sentinel and things",
    "start": "1918440",
    "end": "1924159"
  },
  {
    "text": "like that um so what it looks like uh when we",
    "start": "1924159",
    "end": "1929279"
  },
  {
    "text": "look at the raw log is lots of data and it's XML sort of but what they do is",
    "start": "1929279",
    "end": "1935639"
  },
  {
    "text": "they just Jam everything in the data tag down to there it makes paing quite",
    "start": "1935639",
    "end": "1940880"
  },
  {
    "text": "difficult because this data is always different and it's not very well delimited um and so what we've done is",
    "start": "1940880",
    "end": "1947360"
  },
  {
    "text": "where we need to we'll either uh inline pars with Rex or we'll change paes to grab the bits out we want but you can",
    "start": "1947360",
    "end": "1954480"
  },
  {
    "text": "see there um the user the the statement so now we actually know our attacker IP",
    "start": "1954480",
    "end": "1960399"
  },
  {
    "text": "too which is quite cool and we can go and Hunt that down um but you'll notice this particular log doesn't have the",
    "start": "1960399",
    "end": "1967480"
  },
  {
    "text": "application like the other one did so if we run a query we know the application if we run a store procedure we don't and",
    "start": "1967480",
    "end": "1974120"
  },
  {
    "text": "there was a lot of that logging inconsistency where One log would have some really good stuff Another Log might",
    "start": "1974120",
    "end": "1979200"
  },
  {
    "text": "miss it so that was quite interesting to us not enough to change it from the point of view of we couldn't detect",
    "start": "1979200",
    "end": "1984720"
  },
  {
    "text": "something but enough that it was it was quite",
    "start": "1984720",
    "end": "1989200"
  },
  {
    "text": "interesting then as I was saying we're going through our tool so we're running this I think this one is PowerUp SQL so",
    "start": "1990039",
    "end": "1997200"
  },
  {
    "text": "running the nlm um hash dealer and my detections didn't fire I was like well how many ways are there to do this and",
    "start": "1997200",
    "end": "2004880"
  },
  {
    "text": "Murphy's Law if I think there's one there's two and so we can see that it'll either use dirry which we're auditing or it'll use",
    "start": "2004880",
    "end": "2013320"
  },
  {
    "text": "does the file exist because it does the same thing it tries to connect to the uh SMB file share to see if a file exists I",
    "start": "2013320",
    "end": "2020799"
  },
  {
    "text": "wasn't auditing that one so this is where we go back to our script we had a specific line in for this exact store",
    "start": "2020799",
    "end": "2027320"
  },
  {
    "text": "procedure and retest and then retest it across other tools and it was fantastic",
    "start": "2027320",
    "end": "2032519"
  },
  {
    "text": "that that these open source tools exist um and what we found is attacker tools",
    "start": "2032519",
    "end": "2037720"
  },
  {
    "text": "open source fantastic the defending tools closed Source paid for hard to get um if attackers and and researchers on",
    "start": "2037720",
    "end": "2045200"
  },
  {
    "text": "the red side charge for their tools I wouldn't be able to do half of my job um so this stuff was absolute um absolute",
    "start": "2045200",
    "end": "2052240"
  },
  {
    "text": "gold to be able to go in and have a look at source code command shell this this one's good",
    "start": "2052240",
    "end": "2058720"
  },
  {
    "text": "you can just you run commands um which is what every attacker wants to do right if we're talking about ransomware gangs",
    "start": "2058720",
    "end": "2063960"
  },
  {
    "text": "and they're the they're the most likely threat um especially for organizations in Australia they're just they they're",
    "start": "2063960",
    "end": "2071040"
  },
  {
    "text": "gunning for domain admin as quick as they can to put their software across as many things as they can to get that",
    "start": "2071040",
    "end": "2076440"
  },
  {
    "text": "Ransom if they need to go through SQL and run commands they will generally there are easier ways um but we can see",
    "start": "2076440",
    "end": "2083440"
  },
  {
    "text": "here I can run a a full command on Windows um to see what account I'm running at this is running as a um local",
    "start": "2083440",
    "end": "2091760"
  },
  {
    "text": "account um which tells the attacker a lot about what they could do with that account versus a domain account or",
    "start": "2091760",
    "end": "2097200"
  },
  {
    "text": "versus system so instead of just running a h my because everyone runs H my in C is",
    "start": "2097200",
    "end": "2103040"
  },
  {
    "text": "there's a really cool technique where if you resolve hack. seamless intelligence",
    "start": "2103040",
    "end": "2108800"
  },
  {
    "text": "as a text file this is what it returns uh that's Bas 64 encoded Powershell to",
    "start": "2108800",
    "end": "2115240"
  },
  {
    "text": "try and kill Defender it won't work but it tries tries its hardest a who am I and a c cuz everyone loves popping C now",
    "start": "2115240",
    "end": "2121800"
  },
  {
    "text": "the beauty of this is if you can pipe the results of this lookup into po shell",
    "start": "2121800",
    "end": "2127760"
  },
  {
    "text": "and it will just run it and it's such a cool way to run commands while never actually having to specify them on the",
    "start": "2127760",
    "end": "2134000"
  },
  {
    "text": "command line um so what we do as part of this stored procedure is once again this",
    "start": "2134000",
    "end": "2139640"
  },
  {
    "text": "is just text but we log in we execute command shell and we pipe in a random",
    "start": "2139640",
    "end": "2145839"
  },
  {
    "text": "because that text file will come back in a round robin um um order and we just",
    "start": "2145839",
    "end": "2151200"
  },
  {
    "text": "pipe it into Power shell and run it so we're either going to get a um Defender kill uh try uh who or",
    "start": "2151200",
    "end": "2158200"
  },
  {
    "text": "Cal uh the output for SQL shell isn't great but it doesn't really matter it gets the job done and we can see here we",
    "start": "2158200",
    "end": "2166280"
  },
  {
    "text": "tried to set MP pref which is um which is one way to kill Defender and we often",
    "start": "2166280",
    "end": "2172440"
  },
  {
    "text": "see that as just a default in an attacker batch file they will just try and kill Crow strike um amp Defender",
    "start": "2172440",
    "end": "2178640"
  },
  {
    "text": "they just try them all it's so easy to find because on initial um sort of compromise they don't know what EDR is",
    "start": "2178640",
    "end": "2185280"
  },
  {
    "text": "on there so they try them all so we see this a lot set MP pref it's a really really easy rule to pick someone trying",
    "start": "2185280",
    "end": "2190880"
  },
  {
    "text": "to kill Defender and that's what it's run from a DNS Lookout which is really cool and it runs it then out of the SQL",
    "start": "2190880",
    "end": "2199520"
  },
  {
    "text": "account um the the other things that got us time and time again is I could not",
    "start": "2199520",
    "end": "2204920"
  },
  {
    "text": "get that last command to work with this tool with CME due to how it escapes I",
    "start": "2204920",
    "end": "2211599"
  },
  {
    "text": "could not Escape I couldn't get the power shell in there without it being escaped so I got errors errors errors",
    "start": "2211599",
    "end": "2218079"
  },
  {
    "text": "and I thought it was my syntax and it's one of those you go around in circles it's actually the tool I cannot get a",
    "start": "2218079",
    "end": "2224319"
  },
  {
    "text": "combination of the quote types to get it to run so that took way too much time",
    "start": "2224319",
    "end": "2229680"
  },
  {
    "text": "then you go down and you can actually just run commands with with CME so it actually does work you just can't do",
    "start": "2229680",
    "end": "2235200"
  },
  {
    "text": "some of the more complex stuff with that particular Tool uh and this one here we",
    "start": "2235200",
    "end": "2240440"
  },
  {
    "text": "get back the um the username I don't know why the oh the password's in there cuz I gave it to it it's not not to get",
    "start": "2240440",
    "end": "2247000"
  },
  {
    "text": "a password back once again detection just look for command shell being executed um it just doesn't happen cuz",
    "start": "2247000",
    "end": "2253280"
  },
  {
    "text": "this is not to execute things within SQL this is for SQL to execute things on the",
    "start": "2253280",
    "end": "2258640"
  },
  {
    "text": "Windows host it's it's just not normal I would say if I could have any rule dir tree and command shell and you've got",
    "start": "2258640",
    "end": "2265240"
  },
  {
    "text": "SQL covered this is what we got I just thought I'd show the different way so",
    "start": "2265240",
    "end": "2271079"
  },
  {
    "text": "last views of the raw logs was in our seene platform this is what it looks like in the um uh event viewer itself",
    "start": "2271079",
    "end": "2277599"
  },
  {
    "text": "it's it's the same and we get the statement there we get the server I tried to attack and all the other bits and pieces uh and once again no",
    "start": "2277599",
    "end": "2284400"
  },
  {
    "text": "application for that one this is this is the one I like the",
    "start": "2284400",
    "end": "2289560"
  },
  {
    "start": "2286000",
    "end": "2564000"
  },
  {
    "text": "most trusted assembly this is fantastic has an abuse mechanism took way too long again um but",
    "start": "2289560",
    "end": "2296400"
  },
  {
    "text": "that's the story that's the story of all of this um took me a long time so for any devs that are used to using poell",
    "start": "2296400",
    "end": "2303359"
  },
  {
    "text": "and.net um it's it's really easy sorry it's not really easy for me it's really",
    "start": "2303359",
    "end": "2308440"
  },
  {
    "text": "easy for the devs on my team to go and make this into poell because it just wasn't working when I run it in poell I",
    "start": "2308440",
    "end": "2314680"
  },
  {
    "text": "could see why it wasn't working and the difference is within uh",
    "start": "2314680",
    "end": "2321079"
  },
  {
    "text": "proc giving it the file name of command if we go back one um so I've got here file name is command SLC and then give",
    "start": "2321079",
    "end": "2328680"
  },
  {
    "text": "it Powershell but that's not the file name it would just bomb out it just wouldn't work what I needed to do was",
    "start": "2328680",
    "end": "2334920"
  },
  {
    "text": "file name is command then I pass proc start info arguments and pass it the the",
    "start": "2334920",
    "end": "2340920"
  },
  {
    "text": "um po shell that I want then it started to work but of course compiling this and",
    "start": "2340920",
    "end": "2345960"
  },
  {
    "text": "running it remotely you don't get any errors back it just wasn't working so then we had to spend the time convert",
    "start": "2345960",
    "end": "2351560"
  },
  {
    "text": "this to Powershell so now I can very easily because of my colleagues go and test executing other processes in poell",
    "start": "2351560",
    "end": "2358800"
  },
  {
    "text": "which will translate back directly to a net executable which is really useful um in some of the testing we",
    "start": "2358800",
    "end": "2364920"
  },
  {
    "text": "do this is then a Bas 64 encoded Empire payload Empire is a um command and",
    "start": "2364920",
    "end": "2371480"
  },
  {
    "text": "control framework written in po shell uh really flexible really easy to use um",
    "start": "2371480",
    "end": "2377000"
  },
  {
    "text": "and great for attacking Windows because po shell is is there so what we'll show",
    "start": "2377000",
    "end": "2382040"
  },
  {
    "text": "here is uh on the left we have Empire yep we have Empire and we have uh",
    "start": "2382040",
    "end": "2387760"
  },
  {
    "text": "no agents that's what a callback will be called we called an agent and on the",
    "start": "2387760",
    "end": "2393240"
  },
  {
    "text": "right here we're going to run a um trusted assembly l through SQL Recon and we can see there the agent",
    "start": "2393240",
    "end": "2400640"
  },
  {
    "text": "checked in and so I even make a tyer and I just didn't re-record it but yeah by make",
    "start": "2400640",
    "end": "2406680"
  },
  {
    "text": "typos all the time so then we'll go and interact with that particular",
    "start": "2406680",
    "end": "2412720"
  },
  {
    "text": "agent and it will give us a heap of data about what we have so SVC SQL cor 1 we",
    "start": "2412839",
    "end": "2419400"
  },
  {
    "text": "know it's a domain account so getting domain accounts versus um local accounts is is far more preferable then we can",
    "start": "2419400",
    "end": "2426000"
  },
  {
    "text": "start to some of the built-in modules so we know there was I'll go back but we know it's also a local admin by its",
    "start": "2426000",
    "end": "2432440"
  },
  {
    "text": "Integrity type and what I've done is ask it to dump all the other passwords on the system um using a mimic cat's",
    "start": "2432440",
    "end": "2440040"
  },
  {
    "text": "implementation in Powershell so what it does is it it sends off the job the agent on the Box",
    "start": "2440040",
    "end": "2447079"
  },
  {
    "text": "in poell will run the job and return the um the results back into our command",
    "start": "2447079",
    "end": "2452640"
  },
  {
    "text": "line Empire and most of the C2 Frameworks are really cool it'll actually also go and put these into its",
    "start": "2452640",
    "end": "2458720"
  },
  {
    "text": "Vault and so you can use these creds um automatically without copying and pasting and all that sort of stuff but",
    "start": "2458720",
    "end": "2465359"
  },
  {
    "text": "that is usable on the command line these are inlm hashes that are usable to",
    "start": "2465359",
    "end": "2471359"
  },
  {
    "text": "authenticate so on the side here is all the cool stuff that happened in SQL and so what we don't actually get a log for",
    "start": "2471359",
    "end": "2479079"
  },
  {
    "text": "what executes we only get a log for this area here so we download a dlll from I",
    "start": "2479079",
    "end": "2486400"
  },
  {
    "text": "just host them on our website um and we add the hash to The Trusted assemblies",
    "start": "2486400",
    "end": "2491960"
  },
  {
    "text": "once the hash is in the trusted assemblies SQL will execute it and you yes you need to be an admin this is not",
    "start": "2491960",
    "end": "2498359"
  },
  {
    "text": "a something the guest or private can do public could do but once it's trusted we load it and there's a custom function",
    "start": "2498359",
    "end": "2505520"
  },
  {
    "text": "all the source code for this particular executables in the GitHub repository as well um but there's a custom function",
    "start": "2505520",
    "end": "2511960"
  },
  {
    "text": "name that you need to use for SQL to understand it it will execute it and then it will clean it up so there's",
    "start": "2511960",
    "end": "2518119"
  },
  {
    "text": "actually no evidence in The Trusted assemblies after it's executed that it was ever there um and unless you're",
    "start": "2518119",
    "end": "2524839"
  },
  {
    "text": "looking at them you just you just won't see them because they're not logged by default so what we get",
    "start": "2524839",
    "end": "2531400"
  },
  {
    "text": "is funnily enough another quite simple detection we have two we have running of",
    "start": "2531400",
    "end": "2537880"
  },
  {
    "text": "a trusted assembly and then we have running of a trusted assembly from the web which is even more weird than just",
    "start": "2537880",
    "end": "2545480"
  },
  {
    "text": "running a trusted assembly because it's got to be um added to that set of",
    "start": "2545480",
    "end": "2551040"
  },
  {
    "text": "trusted and then executed so this one once again I have never seen that fire",
    "start": "2551040",
    "end": "2556119"
  },
  {
    "text": "um across organizations we have implemented this in same same username host allows us to",
    "start": "2556119",
    "end": "2562240"
  },
  {
    "text": "go and check uh and search those easily so then there there were some",
    "start": "2562240",
    "end": "2568280"
  },
  {
    "start": "2564000",
    "end": "2817000"
  },
  {
    "text": "struggles uh through all of this um the main ones um as we've seen was the",
    "start": "2568280",
    "end": "2573520"
  },
  {
    "text": "exactness of the logging in SQL is extremely difficult to um work with",
    "start": "2573520",
    "end": "2579040"
  },
  {
    "text": "sometimes um because if you get one of those L if you're missing a store procedure you just don't get logs and so",
    "start": "2579040",
    "end": "2584319"
  },
  {
    "text": "you have to go back add them go back add them testing breadth was also um was",
    "start": "2584319",
    "end": "2591079"
  },
  {
    "text": "also an issue and that's around there's so many tools and there's so many ways to do things if I want to do certain",
    "start": "2591079",
    "end": "2596680"
  },
  {
    "text": "attacks in Windows against keros there's there's certain ways there's finite ways SQL there was so many ways to do the",
    "start": "2596680",
    "end": "2603760"
  },
  {
    "text": "same thing that then had to be retest Ted retested retested the log structure",
    "start": "2603760",
    "end": "2609319"
  },
  {
    "text": "which we didn't talk too much about but it's all jammed into the data tag which means when it comes into a scene that's",
    "start": "2609319",
    "end": "2615280"
  },
  {
    "text": "expecting XML it should actually be structured a little bit better than it is and it took some work to get the data",
    "start": "2615280",
    "end": "2621359"
  },
  {
    "text": "out that we needed and difficulty to implement um the SQL scripts we we've leaned heavily",
    "start": "2621359",
    "end": "2627640"
  },
  {
    "text": "on the organizations and their database admins to deployed at scale um I don't know how to um and they have seemed to",
    "start": "2627640",
    "end": "2634359"
  },
  {
    "text": "to overcome some of those issues with with with deployment and we've got it out there now on on hundreds of servers",
    "start": "2634359",
    "end": "2639640"
  },
  {
    "text": "which is really cool um so the exactness of logging comes back with these sorts",
    "start": "2639640",
    "end": "2645760"
  },
  {
    "text": "of things where we have to go into the source code to even understand the stor",
    "start": "2645760",
    "end": "2650880"
  },
  {
    "text": "procedure that was being used for a particular module sometimes there's 10 20 30 modules for SQL and we had to go",
    "start": "2650880",
    "end": "2657800"
  },
  {
    "text": "in for the we didn't do all 30 this is an ongoing bit of work but where we thought it would be in an attack chain",
    "start": "2657800",
    "end": "2664760"
  },
  {
    "text": "we would go in so now I've got add that store procedure and add job go back retest retest",
    "start": "2664760",
    "end": "2671280"
  },
  {
    "text": "retest the overall testing bread you can see so we tried to map out how it could",
    "start": "2671280",
    "end": "2676800"
  },
  {
    "text": "be used from compromise creds and what tools to all right that's in master",
    "start": "2676800",
    "end": "2683079"
  },
  {
    "text": "those ones are in msdb so separate auditing and separate testing this one",
    "start": "2683079",
    "end": "2688400"
  },
  {
    "text": "so for this is just a silly example but select payroll drop drop table those sorts of things that then goes into that",
    "start": "2688400",
    "end": "2694960"
  },
  {
    "text": "custom Arena of what's important to the organization that is outside of the",
    "start": "2694960",
    "end": "2700040"
  },
  {
    "text": "defaults so this is more looking for someone that knows the org and knows how or how to and wants to hurt them this",
    "start": "2700040",
    "end": "2706720"
  },
  {
    "text": "staff is for a more generic attacker that doesn't really care about the data in the database they're using the",
    "start": "2706720",
    "end": "2712880"
  },
  {
    "text": "database as a jump Point into the domain as you can see lots and lots of different things and then we get our C2",
    "start": "2712880",
    "end": "2719119"
  },
  {
    "text": "beacons and our active directory escalations Rex for anyone that has done",
    "start": "2719119",
    "end": "2725040"
  },
  {
    "text": "Rex my re is terrible you can see up there 22,000 steps is a lot of steps for",
    "start": "2725040",
    "end": "2731480"
  },
  {
    "text": "redx but this is the problem because it's not structured correctly um as XML",
    "start": "2731480",
    "end": "2738000"
  },
  {
    "text": "or Json would be it's quite expensive now we did get it down um but we've got",
    "start": "2738000",
    "end": "2744119"
  },
  {
    "text": "to go through all of this and unfortunately we still wanted the host name which was right down the bottom now",
    "start": "2744119",
    "end": "2749599"
  },
  {
    "text": "for for red jaxs it just means we're stepping through all of the data um to",
    "start": "2749599",
    "end": "2754680"
  },
  {
    "text": "get it there but my absolutely horrible reject at 22,000 we got that um down much further with",
    "start": "2754680",
    "end": "2761079"
  },
  {
    "text": "competent people and then actually deploying it at",
    "start": "2761079",
    "end": "2766480"
  },
  {
    "text": "scale um we're getting feedback from the ORS we work with about how they have done this um because just manually",
    "start": "2766480",
    "end": "2772640"
  },
  {
    "text": "pasting this into every database probably isn't feasible um but and I'm not sure how they've done that at scale but that was another one to overcome",
    "start": "2772640",
    "end": "2779240"
  },
  {
    "text": "because you can't just choose a group policy for this as far as I'm aware and then lucky last we had an",
    "start": "2779240",
    "end": "2785359"
  },
  {
    "text": "organizer that was pre 2016 and you need a certain license to even turn the logging on so",
    "start": "2785359",
    "end": "2792880"
  },
  {
    "text": "then there's some caveat it's all good in 2019 as we can see it's all ticked but back on 2016 for database auditing",
    "start": "2792880",
    "end": "2800839"
  },
  {
    "text": "you needed uh sp1 and then before 2016 which is still out there unfortunately",
    "start": "2800839",
    "end": "2807280"
  },
  {
    "text": "you actually needed a license grade to turn on logging and they didn't have that so they either had to go to 2016 or",
    "start": "2807280",
    "end": "2814000"
  },
  {
    "text": "2019 or up their license ing next up for us is custom application",
    "start": "2814000",
    "end": "2821960"
  },
  {
    "start": "2817000",
    "end": "3100000"
  },
  {
    "text": "logging and surprisingly and it's OT it it definitely applies um so for custom",
    "start": "2821960",
    "end": "2829480"
  },
  {
    "text": "stuff what we do here is we've been talking about master and msdb but let's",
    "start": "2829480",
    "end": "2835200"
  },
  {
    "text": "say logarithm these are all custom databases so if we know now and this",
    "start": "2835200",
    "end": "2840640"
  },
  {
    "text": "this is a body of work that's going to take longer but if an organization knows about their databases and what's",
    "start": "2840640",
    "end": "2845760"
  },
  {
    "text": "important to them we could say for the alarms instead of using Master use",
    "start": "2845760",
    "end": "2851520"
  },
  {
    "text": "logarithm alarms and set our audit policy on these custom databases it's a much longer Journey because the",
    "start": "2851520",
    "end": "2858599"
  },
  {
    "text": "organization firstly needs to know where the data is they care about technically deep in here and then what tables we're",
    "start": "2858599",
    "end": "2865599"
  },
  {
    "text": "looking for on queries and then who should be querying them who shouldn't be CU service accounts are going to be creating these all the time normal user",
    "start": "2865599",
    "end": "2872760"
  },
  {
    "text": "accounts maybe not so much so that's where we're going going next as we've put out the the what we call the",
    "start": "2872760",
    "end": "2878160"
  },
  {
    "text": "Baseline of auditing then going into the custom stuff for everyone this one really surprised me",
    "start": "2878160",
    "end": "2885160"
  },
  {
    "text": "and I'm sorry I don't have more content on this because I would love to do a whole talk just on this um so Mandan put",
    "start": "2885160",
    "end": "2891680"
  },
  {
    "text": "this out in May last year and we were reading through it and what we found",
    "start": "2891680",
    "end": "2897480"
  },
  {
    "text": "extremely interesting firstly was the fact that Ms SQL servers would be in an OT report related directly to control",
    "start": "2897480",
    "end": "2904559"
  },
  {
    "text": "units and and that sort of stuff and what mandiant's advice was was to enable",
    "start": "2904559",
    "end": "2910400"
  },
  {
    "text": "I left their word I'm not sure what's a word enable the usage of SQL extended stored procedures now going back through",
    "start": "2910400",
    "end": "2917400"
  },
  {
    "text": "everything we've been through there's lots of stored procedures but it does save for Shell execution so we could",
    "start": "2917400",
    "end": "2922720"
  },
  {
    "text": "assume it's command shell but what's Miss and and it's still good advice we could turn on XP command shell and and",
    "start": "2922720",
    "end": "2929480"
  },
  {
    "text": "understand or get a detection but I've got no idea what we would be looking for in that command and obviously to mandant",
    "start": "2929480",
    "end": "2936440"
  },
  {
    "text": "and it's their IP and I haven't been able to get anything out of even the mandant people that I know so I'm hoping",
    "start": "2936440",
    "end": "2942040"
  },
  {
    "text": "to get some more information about what it actually executes CU according to the paper when the attackers got on to Ms",
    "start": "2942040",
    "end": "2949559"
  },
  {
    "text": "SQL they're able to directly perform commands on the rtu",
    "start": "2949559",
    "end": "2955359"
  },
  {
    "text": "from SQL and that's how it actually works I I was very surprised by this so",
    "start": "2955359",
    "end": "2961240"
  },
  {
    "text": "I'd love to have more on this and we're working towards that but I did find it to be an extreme interesting use case",
    "start": "2961240",
    "end": "2967520"
  },
  {
    "text": "for SQL monitoring against OT networks and more and more we see OT networks",
    "start": "2967520",
    "end": "2973720"
  },
  {
    "text": "that have domains and and windows servers for control and there lots of them we treat them the same as a normal",
    "start": "2973720",
    "end": "2979839"
  },
  {
    "text": "domain for monitoring the same sorts of things around Coss abuse um if they're running certificate Services there's all",
    "start": "2979839",
    "end": "2985640"
  },
  {
    "text": "of these things that can help compromise a domain and OT is no different it's",
    "start": "2985640",
    "end": "2991400"
  },
  {
    "text": "just a bit easier because there's no users um apart from admins Everyone's an admin which is uh adds another layer of",
    "start": "2991400",
    "end": "2998799"
  },
  {
    "text": "complexity um so yeah hoping to get more on that um but it's um I haven't been",
    "start": "2998799",
    "end": "3004119"
  },
  {
    "text": "able to get anything back from Mandi yet um so as I was saying through the talk all of the stuff is um up on that",
    "start": "3004119",
    "end": "3011559"
  },
  {
    "text": "particular uh that GitHub repo uh and it will have um this one here is the Cs",
    "start": "3011559",
    "end": "3017319"
  },
  {
    "text": "file to um build the trusted assembly um executable that you can then run in SQL",
    "start": "3017319",
    "end": "3023799"
  },
  {
    "text": "um and as I was saying it's part of it um I do I'm pretty sure I've got the attribution there cuz I didn't come up",
    "start": "3023799",
    "end": "3029599"
  },
  {
    "text": "with it um but the custom function name is the key to getting that to run uh and then you're able to go off and run all",
    "start": "3029599",
    "end": "3036160"
  },
  {
    "text": "the bits and pieces there any questions after all of that",
    "start": "3036160",
    "end": "3044240"
  },
  {
    "text": "SQL",
    "start": "3044240",
    "end": "3046960"
  },
  {
    "text": "stuff now I guess a lot of those AR",
    "start": "3051000",
    "end": "3057440"
  },
  {
    "text": "we didn't test into um AO SQL if it's if it's the same as SQL which I I doubt it",
    "start": "3064480",
    "end": "3071640"
  },
  {
    "text": "is from a from a structure perspective some of it will carry over um but there are also better products for monitoring",
    "start": "3071640",
    "end": "3078599"
  },
  {
    "text": "a SQL yeah yep same as Oracle we haven't g into those other database texts as",
    "start": "3078599",
    "end": "3084119"
  },
  {
    "text": "well this is very specific for on Prem Ms squl",
    "start": "3084119",
    "end": "3089240"
  },
  {
    "text": "yep awesome well thanks everyone for uh coming in and listening to me talk on about",
    "start": "3090760",
    "end": "3097440"
  },
  {
    "text": "squl",
    "start": "3099520",
    "end": "3102520"
  }
]