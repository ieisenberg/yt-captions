[
  {
    "text": "[Music]",
    "start": "860",
    "end": "8880"
  },
  {
    "text": "hi everyone welcome to my presentation",
    "start": "8880",
    "end": "10880"
  },
  {
    "text": "skeletons in the app sandbox",
    "start": "10880",
    "end": "13679"
  },
  {
    "text": "i'm ron i currently do product security",
    "start": "13679",
    "end": "15599"
  },
  {
    "text": "at octa and in the past in my previous",
    "start": "15599",
    "end": "17600"
  },
  {
    "text": "role i've done n-day research and",
    "start": "17600",
    "end": "18960"
  },
  {
    "text": "reversing at trend micro as well as some",
    "start": "18960",
    "end": "20880"
  },
  {
    "text": "consulting and development elsewhere",
    "start": "20880",
    "end": "23840"
  },
  {
    "text": "today we're going to be talking about an",
    "start": "23840",
    "end": "25199"
  },
  {
    "text": "insidious little bug in launch services",
    "start": "25199",
    "end": "26880"
  },
  {
    "text": "that let an attacker escape the sandbox",
    "start": "26880",
    "end": "29199"
  },
  {
    "text": "the app sandbox in multiple different",
    "start": "29199",
    "end": "31199"
  },
  {
    "text": "ways because we're talking about that",
    "start": "31199",
    "end": "32800"
  },
  {
    "text": "sandbox we're going to give you some",
    "start": "32800",
    "end": "34399"
  },
  {
    "text": "background information on what it is as",
    "start": "34399",
    "end": "36320"
  },
  {
    "text": "well as reverse all the structures and",
    "start": "36320",
    "end": "38000"
  },
  {
    "text": "agents relative to the bug and then",
    "start": "38000",
    "end": "40320"
  },
  {
    "text": "we're going to spend most of our time",
    "start": "40320",
    "end": "41600"
  },
  {
    "text": "exploiting it we're going to go over",
    "start": "41600",
    "end": "42800"
  },
  {
    "text": "five different exploits and three",
    "start": "42800",
    "end": "44320"
  },
  {
    "text": "different patches",
    "start": "44320",
    "end": "46000"
  },
  {
    "text": "and then we're going to talk about",
    "start": "46000",
    "end": "47600"
  },
  {
    "text": "what's left the remaining attack surface",
    "start": "47600",
    "end": "49440"
  },
  {
    "text": "should you want to go look for variants",
    "start": "49440",
    "end": "51600"
  },
  {
    "text": "and then finally we're going to wrap it",
    "start": "51600",
    "end": "52800"
  },
  {
    "text": "up by talking about how you can defend",
    "start": "52800",
    "end": "54239"
  },
  {
    "text": "yourself with some tools and heuristics",
    "start": "54239",
    "end": "56239"
  },
  {
    "text": "so let's get into it the app sandbox is",
    "start": "56239",
    "end": "59120"
  },
  {
    "text": "a security security measure that's",
    "start": "59120",
    "end": "60960"
  },
  {
    "text": "designed to contain damage in two",
    "start": "60960",
    "end": "62800"
  },
  {
    "text": "different situations the first of which",
    "start": "62800",
    "end": "64960"
  },
  {
    "text": "is a user installing a malicious app",
    "start": "64960",
    "end": "66880"
  },
  {
    "text": "from the mac app store and the second",
    "start": "66880",
    "end": "68880"
  },
  {
    "text": "situation is an app installed from the",
    "start": "68880",
    "end": "70720"
  },
  {
    "text": "mac app store being compromised after",
    "start": "70720",
    "end": "72720"
  },
  {
    "text": "the fact and what it aims to achieve is",
    "start": "72720",
    "end": "74720"
  },
  {
    "text": "that before the sandbox the app",
    "start": "74720",
    "end": "76479"
  },
  {
    "text": "otherwise has access to a lot of user",
    "start": "76479",
    "end": "78400"
  },
  {
    "text": "data and a lot of system resources",
    "start": "78400",
    "end": "80479"
  },
  {
    "text": "there's nuance these days because of",
    "start": "80479",
    "end": "82000"
  },
  {
    "text": "privacy protections and tcc",
    "start": "82000",
    "end": "84400"
  },
  {
    "text": "but with the sandbox it's significantly",
    "start": "84400",
    "end": "86400"
  },
  {
    "text": "limited it has unrestricted access",
    "start": "86400",
    "end": "88240"
  },
  {
    "text": "within its little sand lot but otherwise",
    "start": "88240",
    "end": "90320"
  },
  {
    "text": "not to other user data and system",
    "start": "90320",
    "end": "92079"
  },
  {
    "text": "resources one notable example of a mac",
    "start": "92079",
    "end": "94720"
  },
  {
    "text": "app store app and it's going to come up",
    "start": "94720",
    "end": "96159"
  },
  {
    "text": "later is office macros are executed in",
    "start": "96159",
    "end": "99360"
  },
  {
    "text": "the app sandbox",
    "start": "99360",
    "end": "102079"
  },
  {
    "text": "so concretely you're allowed to access",
    "start": "102079",
    "end": "104000"
  },
  {
    "text": "the file system in your container under",
    "start": "104000",
    "end": "106000"
  },
  {
    "text": "library containers followed by your",
    "start": "106000",
    "end": "107840"
  },
  {
    "text": "bundle identifier",
    "start": "107840",
    "end": "109439"
  },
  {
    "text": "you have",
    "start": "109439",
    "end": "110640"
  },
  {
    "text": "some mock xbc communication allowed with",
    "start": "110640",
    "end": "112880"
  },
  {
    "text": "a limited set of services you can start",
    "start": "112880",
    "end": "115200"
  },
  {
    "text": "processes with posix spawn fork exec or",
    "start": "115200",
    "end": "118159"
  },
  {
    "text": "ns task however the caveat being here",
    "start": "118159",
    "end": "120399"
  },
  {
    "text": "that the child processes will inherit",
    "start": "120399",
    "end": "122159"
  },
  {
    "text": "the app sandbox and all of its",
    "start": "122159",
    "end": "124079"
  },
  {
    "text": "restrictions",
    "start": "124079",
    "end": "125520"
  },
  {
    "text": "one capability that i don't see talked",
    "start": "125520",
    "end": "127200"
  },
  {
    "text": "about often is that you can also talk",
    "start": "127200",
    "end": "129200"
  },
  {
    "text": "with launch services and start processes",
    "start": "129200",
    "end": "131520"
  },
  {
    "text": "through launch services this is what",
    "start": "131520",
    "end": "133200"
  },
  {
    "text": "we're going to focus on today",
    "start": "133200",
    "end": "135680"
  },
  {
    "text": "if you want to find a foolish list of",
    "start": "135680",
    "end": "137040"
  },
  {
    "text": "exceptions you can find the seatbelt",
    "start": "137040",
    "end": "138640"
  },
  {
    "text": "profile there",
    "start": "138640",
    "end": "140319"
  },
  {
    "text": "so let's dive into the launch services",
    "start": "140319",
    "end": "142319"
  },
  {
    "text": "capability ostensibly this capability is",
    "start": "142319",
    "end": "145040"
  },
  {
    "text": "intended for launching helper apps or at",
    "start": "145040",
    "end": "146879"
  },
  {
    "text": "least that's only mentioned of it in the",
    "start": "146879",
    "end": "148480"
  },
  {
    "text": "app sandbox guide",
    "start": "148480",
    "end": "150800"
  },
  {
    "text": "what the framework allows you do like i",
    "start": "150800",
    "end": "152560"
  },
  {
    "text": "mentioned you can launch other",
    "start": "152560",
    "end": "153760"
  },
  {
    "text": "applications or open files it's what",
    "start": "153760",
    "end": "155760"
  },
  {
    "text": "finder uses under the hood and it's",
    "start": "155760",
    "end": "157760"
  },
  {
    "text": "explicitly allowed in the seatbelt",
    "start": "157760",
    "end": "159519"
  },
  {
    "text": "profile under these two lines the first",
    "start": "159519",
    "end": "161840"
  },
  {
    "text": "of which being allow mock lookup on the",
    "start": "161840",
    "end": "163680"
  },
  {
    "text": "quarantine resolver service",
    "start": "163680",
    "end": "166160"
  },
  {
    "text": "and ls open privilege",
    "start": "166160",
    "end": "168160"
  },
  {
    "text": "this xpc service is implemented in the",
    "start": "168160",
    "end": "170239"
  },
  {
    "text": "core services ui agent so let's take a",
    "start": "170239",
    "end": "172160"
  },
  {
    "text": "closer look at that",
    "start": "172160",
    "end": "173840"
  },
  {
    "text": "the core services ui agent does many",
    "start": "173840",
    "end": "175760"
  },
  {
    "text": "things and has many handlers but the one",
    "start": "175760",
    "end": "177599"
  },
  {
    "text": "we're going to focus on is the csui ls",
    "start": "177599",
    "end": "179920"
  },
  {
    "text": "open handler and this essentially acts",
    "start": "179920",
    "end": "181840"
  },
  {
    "text": "as a launch d proxy how it works when a",
    "start": "181840",
    "end": "184560"
  },
  {
    "text": "sandbox app wants to open another app",
    "start": "184560",
    "end": "187040"
  },
  {
    "text": "through launch services it'll call into",
    "start": "187040",
    "end": "188800"
  },
  {
    "text": "launch services say through the open url",
    "start": "188800",
    "end": "191920"
  },
  {
    "text": "api",
    "start": "191920",
    "end": "192959"
  },
  {
    "text": "that's going to call into the core",
    "start": "192959",
    "end": "194159"
  },
  {
    "text": "services ui agent over xpc",
    "start": "194159",
    "end": "197519"
  },
  {
    "text": "the core services ui agent is going to",
    "start": "197519",
    "end": "199200"
  },
  {
    "text": "talk to running board d and send an rbs",
    "start": "199200",
    "end": "201360"
  },
  {
    "text": "launch request this is new in big sur by",
    "start": "201360",
    "end": "203360"
  },
  {
    "text": "the way he used to just directly talk to",
    "start": "203360",
    "end": "204959"
  },
  {
    "text": "launch d",
    "start": "204959",
    "end": "206879"
  },
  {
    "text": "but in turn running board d will now",
    "start": "206879",
    "end": "208560"
  },
  {
    "text": "submit the os launch d job and then",
    "start": "208560",
    "end": "210640"
  },
  {
    "text": "launch d will finally launch our",
    "start": "210640",
    "end": "212080"
  },
  {
    "text": "specified application now there are two",
    "start": "212080",
    "end": "214560"
  },
  {
    "text": "things here i want to highlight we're",
    "start": "214560",
    "end": "216239"
  },
  {
    "text": "allowed to open another application from",
    "start": "216239",
    "end": "218000"
  },
  {
    "text": "within the sandbox but we cannot pass",
    "start": "218000",
    "end": "220159"
  },
  {
    "text": "arguments or input to it that's a",
    "start": "220159",
    "end": "222159"
  },
  {
    "text": "crucial restriction but the second thing",
    "start": "222159",
    "end": "224400"
  },
  {
    "text": "i want to mention is that the launched",
    "start": "224400",
    "end": "226239"
  },
  {
    "text": "application will not inherit the app",
    "start": "226239",
    "end": "228319"
  },
  {
    "text": "sandbox like it might if you were to",
    "start": "228319",
    "end": "230319"
  },
  {
    "text": "execute it with posix spawn and so if",
    "start": "230319",
    "end": "232720"
  },
  {
    "text": "it's otherwise on sandbox it will launch",
    "start": "232720",
    "end": "235040"
  },
  {
    "text": "on sandbox",
    "start": "235040",
    "end": "237120"
  },
  {
    "text": "let's take a closer look at the input",
    "start": "237120",
    "end": "238640"
  },
  {
    "text": "provided to this agent",
    "start": "238640",
    "end": "241840"
  },
  {
    "text": "so it takes an input class",
    "start": "242159",
    "end": "244400"
  },
  {
    "text": "sorry it's called an ls remote open call",
    "start": "244400",
    "end": "247120"
  },
  {
    "text": "and it has an input ivar inputs has the",
    "start": "247120",
    "end": "250080"
  },
  {
    "text": "following structure it takes an ns array",
    "start": "250080",
    "end": "252239"
  },
  {
    "text": "of in urls as well as in-app rams in-app",
    "start": "252239",
    "end": "255200"
  },
  {
    "text": "ramps has this structure it has an ns",
    "start": "255200",
    "end": "257759"
  },
  {
    "text": "dictionary called environment and an",
    "start": "257759",
    "end": "259919"
  },
  {
    "text": "nsurl called application url it's all",
    "start": "259919",
    "end": "262320"
  },
  {
    "text": "relatively intuitive",
    "start": "262320",
    "end": "264240"
  },
  {
    "text": "let's uh we'll come back to that in a",
    "start": "264240",
    "end": "265680"
  },
  {
    "text": "second but first i wanted to plug the",
    "start": "265680",
    "end": "267520"
  },
  {
    "text": "little tool a hopper plug-in i wrote",
    "start": "267520",
    "end": "269440"
  },
  {
    "text": "that aims to help with reversing the",
    "start": "269440",
    "end": "271440"
  },
  {
    "text": "dyld",
    "start": "271440",
    "end": "272560"
  },
  {
    "text": "shared cache um as many of you who have",
    "start": "272560",
    "end": "275360"
  },
  {
    "text": "dealt with it know it kind of messes",
    "start": "275360",
    "end": "277600"
  },
  {
    "text": "everything up and the disassembly is",
    "start": "277600",
    "end": "279280"
  },
  {
    "text": "really ugly",
    "start": "279280",
    "end": "280560"
  },
  {
    "text": "what you'd see before is something like",
    "start": "280560",
    "end": "282560"
  },
  {
    "text": "this your class list or class ref",
    "start": "282560",
    "end": "284240"
  },
  {
    "text": "section might have pointer authenticated",
    "start": "284240",
    "end": "286000"
  },
  {
    "text": "addresses on arm 64 they'd be unparsed",
    "start": "286000",
    "end": "288960"
  },
  {
    "text": "unimported the disassembly would be",
    "start": "288960",
    "end": "291520"
  },
  {
    "text": "unintelligible and then after you ran",
    "start": "291520",
    "end": "293280"
  },
  {
    "text": "the tool everything would be parsed and",
    "start": "293280",
    "end": "295360"
  },
  {
    "text": "imported and type information would be",
    "start": "295360",
    "end": "297440"
  },
  {
    "text": "recovered and you have something a bit",
    "start": "297440",
    "end": "299120"
  },
  {
    "text": "more understandable so that's open",
    "start": "299120",
    "end": "300880"
  },
  {
    "text": "source you can go take a look at it",
    "start": "300880",
    "end": "302560"
  },
  {
    "text": "afterwards",
    "start": "302560",
    "end": "304240"
  },
  {
    "text": "let's go back to that input this time",
    "start": "304240",
    "end": "306000"
  },
  {
    "text": "something in particular will be",
    "start": "306000",
    "end": "307280"
  },
  {
    "text": "highlighted and that's the environment",
    "start": "307280",
    "end": "308960"
  },
  {
    "text": "ivar so i just want to take a step back",
    "start": "308960",
    "end": "311840"
  },
  {
    "text": "i mentioned that the app sandbox can",
    "start": "311840",
    "end": "313759"
  },
  {
    "text": "launch other applications through launch",
    "start": "313759",
    "end": "315440"
  },
  {
    "text": "services but it can't control their",
    "start": "315440",
    "end": "317120"
  },
  {
    "text": "arguments",
    "start": "317120",
    "end": "318240"
  },
  {
    "text": "how come this ivar is here",
    "start": "318240",
    "end": "320320"
  },
  {
    "text": "it must be ignored somewhere down the",
    "start": "320320",
    "end": "322240"
  },
  {
    "text": "line right at least you would think so",
    "start": "322240",
    "end": "324400"
  },
  {
    "text": "however that's not the case and that's",
    "start": "324400",
    "end": "326080"
  },
  {
    "text": "the root cause of the bug we're talking",
    "start": "326080",
    "end": "327600"
  },
  {
    "text": "about today a sandbox application can",
    "start": "327600",
    "end": "330000"
  },
  {
    "text": "launch other applications outside of the",
    "start": "330000",
    "end": "331759"
  },
  {
    "text": "sandbox and control their environment",
    "start": "331759",
    "end": "336120"
  },
  {
    "text": "so to trigger this the hard way which",
    "start": "338479",
    "end": "340639"
  },
  {
    "text": "isn't really that hard we'll extract the",
    "start": "340639",
    "end": "342160"
  },
  {
    "text": "relevant structures and write our xpc",
    "start": "342160",
    "end": "344000"
  },
  {
    "text": "client we'll set the ivar to the",
    "start": "344000",
    "end": "346160"
  },
  {
    "text": "nsdictionary of our choice containing",
    "start": "346160",
    "end": "347919"
  },
  {
    "text": "the environment variables we want to set",
    "start": "347919",
    "end": "349440"
  },
  {
    "text": "here we're setting food to bar",
    "start": "349440",
    "end": "351600"
  },
  {
    "text": "and then we're just going to send it off",
    "start": "351600",
    "end": "352800"
  },
  {
    "text": "to the quarantine resolver core services",
    "start": "352800",
    "end": "354880"
  },
  {
    "text": "ui agent we're going to launch the",
    "start": "354880",
    "end": "356400"
  },
  {
    "text": "application outside of the sandbox with",
    "start": "356400",
    "end": "358160"
  },
  {
    "text": "the controlled environment",
    "start": "358160",
    "end": "360080"
  },
  {
    "text": "but it gets even easier you can just use",
    "start": "360080",
    "end": "362240"
  },
  {
    "text": "the apis if you instantiate ns workspace",
    "start": "362240",
    "end": "365360"
  },
  {
    "text": "open configuration and set the",
    "start": "365360",
    "end": "367199"
  },
  {
    "text": "environment property to the nsdictionary",
    "start": "367199",
    "end": "369759"
  },
  {
    "text": "of your choice once again we set foo to",
    "start": "369759",
    "end": "371759"
  },
  {
    "text": "bar pass that to open url and in this",
    "start": "371759",
    "end": "374080"
  },
  {
    "text": "case we launched safari with controlled",
    "start": "374080",
    "end": "376080"
  },
  {
    "text": "environment variables",
    "start": "376080",
    "end": "377759"
  },
  {
    "text": "surely apple couldn't have overlooked",
    "start": "377759",
    "end": "379199"
  },
  {
    "text": "that and if you were to go take a look",
    "start": "379199",
    "end": "381440"
  },
  {
    "text": "at the documentation you see that for",
    "start": "381440",
    "end": "383199"
  },
  {
    "text": "the environment property it does",
    "start": "383199",
    "end": "385120"
  },
  {
    "text": "explicitly call it out if the calling",
    "start": "385120",
    "end": "387280"
  },
  {
    "text": "process is sandboxed the system ignores",
    "start": "387280",
    "end": "389440"
  },
  {
    "text": "the value of this property however 10 11",
    "start": "389440",
    "end": "392560"
  },
  {
    "text": "months from the initial report and",
    "start": "392560",
    "end": "394479"
  },
  {
    "text": "several reports later i've called it out",
    "start": "394479",
    "end": "396400"
  },
  {
    "text": "every single time that the docs are",
    "start": "396400",
    "end": "397840"
  },
  {
    "text": "incorrect this behavior remains and the",
    "start": "397840",
    "end": "399919"
  },
  {
    "text": "docs are still incorrect",
    "start": "399919",
    "end": "402800"
  },
  {
    "text": "one potential explanation is a new",
    "start": "402800",
    "end": "404639"
  },
  {
    "text": "feature in big sur that concerns the",
    "start": "404639",
    "end": "406880"
  },
  {
    "text": "inheritance of environment variables",
    "start": "406880",
    "end": "408720"
  },
  {
    "text": "through launch services so if a launch",
    "start": "408720",
    "end": "410639"
  },
  {
    "text": "services client wants to launch another",
    "start": "410639",
    "end": "412479"
  },
  {
    "text": "application they make sure that launched",
    "start": "412479",
    "end": "414560"
  },
  {
    "text": "application will have the environment of",
    "start": "414560",
    "end": "416560"
  },
  {
    "text": "the client and i guess this is to mimic",
    "start": "416560",
    "end": "419199"
  },
  {
    "text": "sort of behavior you might see through",
    "start": "419199",
    "end": "421280"
  },
  {
    "text": "posix spawn or elsewhere",
    "start": "421280",
    "end": "423440"
  },
  {
    "text": "but one other thing i want to call out",
    "start": "423440",
    "end": "425199"
  },
  {
    "text": "in this pseudo code is that the client",
    "start": "425199",
    "end": "427520"
  },
  {
    "text": "will also check if it's sandbox and if",
    "start": "427520",
    "end": "430000"
  },
  {
    "text": "it's sandbox and the variable to set is",
    "start": "430000",
    "end": "432080"
  },
  {
    "text": "home tempd or cfx user home it's going",
    "start": "432080",
    "end": "434800"
  },
  {
    "text": "to ignore it but i've said the magic",
    "start": "434800",
    "end": "436560"
  },
  {
    "text": "word several times already client and",
    "start": "436560",
    "end": "438880"
  },
  {
    "text": "that's precisely the problem with this",
    "start": "438880",
    "end": "440560"
  },
  {
    "text": "this is client-side validation",
    "start": "440560",
    "end": "443599"
  },
  {
    "text": "now let's actually get into the",
    "start": "443599",
    "end": "445120"
  },
  {
    "text": "exploitation so step one i can or the",
    "start": "445120",
    "end": "448960"
  },
  {
    "text": "first the first approach i i i had was",
    "start": "448960",
    "end": "452080"
  },
  {
    "text": "let's just use the easy way dyld insert",
    "start": "452080",
    "end": "454560"
  },
  {
    "text": "libraries if you specify this",
    "start": "454560",
    "end": "456160"
  },
  {
    "text": "environment variable to a die lab of",
    "start": "456160",
    "end": "458240"
  },
  {
    "text": "your choice of in your control you can",
    "start": "458240",
    "end": "460400"
  },
  {
    "text": "have that die lib loaded outside the",
    "start": "460400",
    "end": "462240"
  },
  {
    "text": "sandbox easy peasy or so you'd think",
    "start": "462240",
    "end": "465360"
  },
  {
    "text": "the major restriction here lies in apple",
    "start": "465360",
    "end": "467520"
  },
  {
    "text": "mobile file integrity where it's going",
    "start": "467520",
    "end": "469599"
  },
  {
    "text": "to ignore all the dyld variables on",
    "start": "469599",
    "end": "472319"
  },
  {
    "text": "apple binaries so you can specify it on",
    "start": "472319",
    "end": "474400"
  },
  {
    "text": "something like music but it's just going",
    "start": "474400",
    "end": "476240"
  },
  {
    "text": "to be ignored however i found an",
    "start": "476240",
    "end": "478479"
  },
  {
    "text": "alternative target that's a script",
    "start": "478479",
    "end": "480160"
  },
  {
    "text": "editor template called coco applet it's",
    "start": "480160",
    "end": "482479"
  },
  {
    "text": "available on default installations so no",
    "start": "482479",
    "end": "484479"
  },
  {
    "text": "quarantine x attribute",
    "start": "484479",
    "end": "486560"
  },
  {
    "text": "it's unsigned which means it's not",
    "start": "486560",
    "end": "488080"
  },
  {
    "text": "technically an apple binary",
    "start": "488080",
    "end": "490160"
  },
  {
    "text": "and that also means it has no",
    "start": "490160",
    "end": "491680"
  },
  {
    "text": "entitlements but the most important part",
    "start": "491680",
    "end": "493280"
  },
  {
    "text": "is that it runs outside the sandbox so",
    "start": "493280",
    "end": "495280"
  },
  {
    "text": "it's a perfect host for our malicious",
    "start": "495280",
    "end": "497599"
  },
  {
    "text": "dileb and how the exploitation looks is",
    "start": "497599",
    "end": "500000"
  },
  {
    "text": "something like this step one we'll set",
    "start": "500000",
    "end": "502160"
  },
  {
    "text": "dileb",
    "start": "502160",
    "end": "503280"
  },
  {
    "text": "dialib insert dyld insert libraries to",
    "start": "503280",
    "end": "506000"
  },
  {
    "text": "our bundle die lib and this is going to",
    "start": "506000",
    "end": "507440"
  },
  {
    "text": "be included inside our app under",
    "start": "507440",
    "end": "509120"
  },
  {
    "text": "frameworks like many dilemps are",
    "start": "509120",
    "end": "511919"
  },
  {
    "text": "next we're just going to launch coco",
    "start": "511919",
    "end": "513518"
  },
  {
    "text": "applet through the front door through",
    "start": "513519",
    "end": "514959"
  },
  {
    "text": "launch services that's going to call",
    "start": "514959",
    "end": "516640"
  },
  {
    "text": "into core services ui agent and then",
    "start": "516640",
    "end": "518560"
  },
  {
    "text": "launch coco applet outside of the",
    "start": "518560",
    "end": "520320"
  },
  {
    "text": "sandbox with controlled environment",
    "start": "520320",
    "end": "522320"
  },
  {
    "text": "variables specifically the one we set",
    "start": "522320",
    "end": "524720"
  },
  {
    "text": "and then finally because it's not an",
    "start": "524720",
    "end": "526399"
  },
  {
    "text": "apple binary it's going to respect the",
    "start": "526399",
    "end": "528000"
  },
  {
    "text": "value and try and load that dialip",
    "start": "528000",
    "end": "529839"
  },
  {
    "text": "outside of the sandbox sweet easy peasy",
    "start": "529839",
    "end": "532720"
  },
  {
    "text": "now i reported this on catalina and when",
    "start": "532720",
    "end": "534800"
  },
  {
    "text": "i went to try this on big sur i realized",
    "start": "534800",
    "end": "536800"
  },
  {
    "text": "it wasn't working for several reasons",
    "start": "536800",
    "end": "538959"
  },
  {
    "text": "the first of which are the new signing",
    "start": "538959",
    "end": "541600"
  },
  {
    "text": "and notarization requirements on arm 64.",
    "start": "541600",
    "end": "544000"
  },
  {
    "text": "but those are easy enough to get around",
    "start": "544000",
    "end": "545760"
  },
  {
    "text": "by specifying in our launch request a",
    "start": "545760",
    "end": "547760"
  },
  {
    "text": "different architecture however one thing",
    "start": "547760",
    "end": "550000"
  },
  {
    "text": "that i could not get around and i",
    "start": "550000",
    "end": "551360"
  },
  {
    "text": "realized only after the fact after the",
    "start": "551360",
    "end": "553200"
  },
  {
    "text": "report was that coco applet because it's",
    "start": "553200",
    "end": "556160"
  },
  {
    "text": "ostensibly not an apple binary",
    "start": "556160",
    "end": "558640"
  },
  {
    "text": "it has a first launch prompt and so that",
    "start": "558640",
    "end": "560880"
  },
  {
    "text": "that turns this exploit into requiring",
    "start": "560880",
    "end": "562959"
  },
  {
    "text": "interaction and makes it rather lousy",
    "start": "562959",
    "end": "566000"
  },
  {
    "text": "apple still thought it was worth fixing",
    "start": "566000",
    "end": "567920"
  },
  {
    "text": "and so they added",
    "start": "567920",
    "end": "569839"
  },
  {
    "text": "server side this following code or",
    "start": "569839",
    "end": "572080"
  },
  {
    "text": "rather pseudo code",
    "start": "572080",
    "end": "574480"
  },
  {
    "text": "they check the variable you want to set",
    "start": "574480",
    "end": "576000"
  },
  {
    "text": "if it has a dyld prefix it's going to be",
    "start": "576000",
    "end": "578399"
  },
  {
    "text": "ignored and not forwarded in the launch",
    "start": "578399",
    "end": "580399"
  },
  {
    "text": "request",
    "start": "580399",
    "end": "581440"
  },
  {
    "text": "simple enough",
    "start": "581440",
    "end": "582959"
  },
  {
    "text": "now let's see if we can remove the need",
    "start": "582959",
    "end": "585440"
  },
  {
    "text": "for user interaction because",
    "start": "585440",
    "end": "588160"
  },
  {
    "text": "it's otherwise pretty pointless and",
    "start": "588160",
    "end": "590160"
  },
  {
    "text": "we're going to do that by bypassing",
    "start": "590160",
    "end": "591920"
  },
  {
    "text": "another patch",
    "start": "591920",
    "end": "593519"
  },
  {
    "text": "so tais and dan of computes reported a",
    "start": "593519",
    "end": "595920"
  },
  {
    "text": "sandbox escape in system preferences and",
    "start": "595920",
    "end": "598480"
  },
  {
    "text": "the behavior they exploit is that system",
    "start": "598480",
    "end": "600320"
  },
  {
    "text": "preferences loads user preference panes",
    "start": "600320",
    "end": "602720"
  },
  {
    "text": "from a property list file",
    "start": "602720",
    "end": "604800"
  },
  {
    "text": "this property list file looks like this",
    "start": "604800",
    "end": "607120"
  },
  {
    "text": "it contains a serialized nsprefpane",
    "start": "607120",
    "end": "609360"
  },
  {
    "text": "bundle class with a path property",
    "start": "609360",
    "end": "611680"
  },
  {
    "text": "pointing to an absolute path to a bundle",
    "start": "611680",
    "end": "614079"
  },
  {
    "text": "a preference pane is just a bundle you",
    "start": "614079",
    "end": "615920"
  },
  {
    "text": "can see it highlighted there this nspref",
    "start": "615920",
    "end": "618160"
  },
  {
    "text": "pane path",
    "start": "618160",
    "end": "619440"
  },
  {
    "text": "is pointing to gpg preferences and they",
    "start": "619440",
    "end": "622800"
  },
  {
    "text": "figured that they could overwrite that",
    "start": "622800",
    "end": "624560"
  },
  {
    "text": "and have a different preference pane",
    "start": "624560",
    "end": "625920"
  },
  {
    "text": "load and that's correct",
    "start": "625920",
    "end": "628000"
  },
  {
    "text": "that's exactly what they did so they",
    "start": "628000",
    "end": "630079"
  },
  {
    "text": "launched system preferences inside the",
    "start": "630079",
    "end": "632000"
  },
  {
    "text": "app sandbox through exec remember doing",
    "start": "632000",
    "end": "634160"
  },
  {
    "text": "so in has the app inherit the sandbox so",
    "start": "634160",
    "end": "637519"
  },
  {
    "text": "it's launched inside the sandbox and the",
    "start": "637519",
    "end": "639519"
  },
  {
    "text": "path to the plist you can see it's",
    "start": "639519",
    "end": "641600"
  },
  {
    "text": "prefixed there with tilde library caches",
    "start": "641600",
    "end": "644320"
  },
  {
    "text": "once launched inside the sandbox the",
    "start": "644320",
    "end": "646160"
  },
  {
    "text": "tilde expands to the app container",
    "start": "646160",
    "end": "648440"
  },
  {
    "text": "com.app and what that means in the",
    "start": "648440",
    "end": "651200"
  },
  {
    "text": "original exploit is that once they they",
    "start": "651200",
    "end": "653200"
  },
  {
    "text": "launched it the user cache was written",
    "start": "653200",
    "end": "655040"
  },
  {
    "text": "in a location that was writable from the",
    "start": "655040",
    "end": "657600"
  },
  {
    "text": "sandbox",
    "start": "657600",
    "end": "658800"
  },
  {
    "text": "and what that meant is that they could",
    "start": "658800",
    "end": "660880"
  },
  {
    "text": "actually tamper with that path property",
    "start": "660880",
    "end": "662800"
  },
  {
    "text": "and they pointed the path property to a",
    "start": "662800",
    "end": "664640"
  },
  {
    "text": "malicious bundle inside their app",
    "start": "664640",
    "end": "667600"
  },
  {
    "text": "next they relaunched system preferences",
    "start": "667600",
    "end": "670160"
  },
  {
    "text": "which would launch its legacy loader",
    "start": "670160",
    "end": "671839"
  },
  {
    "text": "service to load these these preference",
    "start": "671839",
    "end": "673680"
  },
  {
    "text": "panes and it would load the bundle",
    "start": "673680",
    "end": "675120"
  },
  {
    "text": "outside of the sandbox sweet",
    "start": "675120",
    "end": "678000"
  },
  {
    "text": "how apple patched this is they added a",
    "start": "678000",
    "end": "679839"
  },
  {
    "text": "sandbox check to system preferences so",
    "start": "679839",
    "end": "682320"
  },
  {
    "text": "if it realizes it's running in a sandbox",
    "start": "682320",
    "end": "684880"
  },
  {
    "text": "it's going to exit early now let's talk",
    "start": "684880",
    "end": "687040"
  },
  {
    "text": "about how we can bypass their patch to",
    "start": "687040",
    "end": "689040"
  },
  {
    "text": "bypass our patch to get a proper zero",
    "start": "689040",
    "end": "691360"
  },
  {
    "text": "interaction exploit",
    "start": "691360",
    "end": "693680"
  },
  {
    "text": "once again here's the p list path how",
    "start": "693680",
    "end": "695920"
  },
  {
    "text": "this is resolved is with the ns search",
    "start": "695920",
    "end": "697600"
  },
  {
    "text": "path for directories and domains api the",
    "start": "697600",
    "end": "700160"
  },
  {
    "text": "second argument to this function is ns",
    "start": "700160",
    "end": "702160"
  },
  {
    "text": "user domain mask this is how they're",
    "start": "702160",
    "end": "703680"
  },
  {
    "text": "going to expand the tilde so when you",
    "start": "703680",
    "end": "706000"
  },
  {
    "text": "specify that domain mask it's going to",
    "start": "706000",
    "end": "707600"
  },
  {
    "text": "call into ns home directory and ns home",
    "start": "707600",
    "end": "710000"
  },
  {
    "text": "directory has a fast path where it just",
    "start": "710000",
    "end": "712079"
  },
  {
    "text": "reads the value of cf fixed user home",
    "start": "712079",
    "end": "714880"
  },
  {
    "text": "that's what you need to know to",
    "start": "714880",
    "end": "716079"
  },
  {
    "text": "understand our exploit here so in our",
    "start": "716079",
    "end": "718560"
  },
  {
    "text": "double patch bypass surgery number one",
    "start": "718560",
    "end": "720880"
  },
  {
    "text": "we're going to set cfx user home to the",
    "start": "720880",
    "end": "723040"
  },
  {
    "text": "container",
    "start": "723040",
    "end": "724240"
  },
  {
    "text": "our app sandbox container remember we",
    "start": "724240",
    "end": "726079"
  },
  {
    "text": "have read write access within the",
    "start": "726079",
    "end": "727519"
  },
  {
    "text": "container",
    "start": "727519",
    "end": "728880"
  },
  {
    "text": "next we're going to launch system",
    "start": "728880",
    "end": "730560"
  },
  {
    "text": "preferences outside of the sandbox this",
    "start": "730560",
    "end": "732639"
  },
  {
    "text": "is going to bypass the sandbox check in",
    "start": "732639",
    "end": "734880"
  },
  {
    "text": "the last path last patch but see if",
    "start": "734880",
    "end": "737279"
  },
  {
    "text": "fixed user home is still set to the",
    "start": "737279",
    "end": "738720"
  },
  {
    "text": "container so system preferences will",
    "start": "738720",
    "end": "740639"
  },
  {
    "text": "still write out the cache to a location",
    "start": "740639",
    "end": "742800"
  },
  {
    "text": "we can write to",
    "start": "742800",
    "end": "744480"
  },
  {
    "text": "next because it's written in a location",
    "start": "744480",
    "end": "746320"
  },
  {
    "text": "we can write to we can once again do",
    "start": "746320",
    "end": "748240"
  },
  {
    "text": "what they did overwrite the path",
    "start": "748240",
    "end": "750000"
  },
  {
    "text": "property in that cache file pointing to",
    "start": "750000",
    "end": "752160"
  },
  {
    "text": "our malicious bundle and the rest is",
    "start": "752160",
    "end": "754000"
  },
  {
    "text": "very similar we'll relaunch system",
    "start": "754000",
    "end": "755839"
  },
  {
    "text": "preferences it's going to launch the",
    "start": "755839",
    "end": "757680"
  },
  {
    "text": "legacy loader to load the bundle",
    "start": "757680",
    "end": "760000"
  },
  {
    "text": "and that's going to be loaded outside of",
    "start": "760000",
    "end": "761440"
  },
  {
    "text": "the sandbox completing the escape",
    "start": "761440",
    "end": "765360"
  },
  {
    "text": "okay now before i get into the next one",
    "start": "765519",
    "end": "769200"
  },
  {
    "text": "i want to highlight one thing we did in",
    "start": "769200",
    "end": "771760"
  },
  {
    "text": "the last and that's that or rather one",
    "start": "771760",
    "end": "774079"
  },
  {
    "text": "requirement the requirement was that we",
    "start": "774079",
    "end": "775839"
  },
  {
    "text": "had to bundle something with our",
    "start": "775839",
    "end": "777040"
  },
  {
    "text": "application and ideally to avoid app",
    "start": "777040",
    "end": "779279"
  },
  {
    "text": "store scrutiny or notarization",
    "start": "779279",
    "end": "781040"
  },
  {
    "text": "requirements let's see if we can remove",
    "start": "781040",
    "end": "782959"
  },
  {
    "text": "that requirement and do it without",
    "start": "782959",
    "end": "784560"
  },
  {
    "text": "bundling anything and we're going to do",
    "start": "784560",
    "end": "786160"
  },
  {
    "text": "that through the home variable",
    "start": "786160",
    "end": "788399"
  },
  {
    "text": "remember i added that big sur added some",
    "start": "788399",
    "end": "790639"
  },
  {
    "text": "validation of home",
    "start": "790639",
    "end": "792399"
  },
  {
    "text": "but it was done client-side in launch",
    "start": "792399",
    "end": "794079"
  },
  {
    "text": "services so",
    "start": "794079",
    "end": "795839"
  },
  {
    "text": "like you might imagine we can bypass",
    "start": "795839",
    "end": "797519"
  },
  {
    "text": "that by just going around the framework",
    "start": "797519",
    "end": "799440"
  },
  {
    "text": "by just sending the serialized data",
    "start": "799440",
    "end": "801040"
  },
  {
    "text": "directly to the agent and the target for",
    "start": "801040",
    "end": "803120"
  },
  {
    "text": "this exploit is going to be terminal.app",
    "start": "803120",
    "end": "806240"
  },
  {
    "text": "so here's the flow let's step through it",
    "start": "806240",
    "end": "808959"
  },
  {
    "text": "one by one",
    "start": "808959",
    "end": "810480"
  },
  {
    "text": "first we're going to write out a",
    "start": "810480",
    "end": "811600"
  },
  {
    "text": "malicious dot profile in our container",
    "start": "811600",
    "end": "814639"
  },
  {
    "text": "and this dot profile is going to contain",
    "start": "814639",
    "end": "816480"
  },
  {
    "text": "arbitrary shell commands it's going to",
    "start": "816480",
    "end": "818399"
  },
  {
    "text": "have the quarantine x attribute but",
    "start": "818399",
    "end": "819920"
  },
  {
    "text": "that's not going to matter later on",
    "start": "819920",
    "end": "822000"
  },
  {
    "text": "second we're going to point home to the",
    "start": "822000",
    "end": "824240"
  },
  {
    "text": "sandboxes container in the environment",
    "start": "824240",
    "end": "826079"
  },
  {
    "text": "ivar i mentioned in the app params",
    "start": "826079",
    "end": "828000"
  },
  {
    "text": "earlier and then we're going to",
    "start": "828000",
    "end": "829440"
  },
  {
    "text": "serialize the data and send it over xpc",
    "start": "829440",
    "end": "831680"
  },
  {
    "text": "to the core services ui agent this is",
    "start": "831680",
    "end": "833760"
  },
  {
    "text": "going to bypass that launch services",
    "start": "833760",
    "end": "835760"
  },
  {
    "text": "client-side validation and have our home",
    "start": "835760",
    "end": "838079"
  },
  {
    "text": "value register on the app we're about to",
    "start": "838079",
    "end": "840079"
  },
  {
    "text": "launch",
    "start": "840079",
    "end": "840880"
  },
  {
    "text": "and we launched terminal.app it's going",
    "start": "840880",
    "end": "842720"
  },
  {
    "text": "to launch outside of sandbox home is",
    "start": "842720",
    "end": "845120"
  },
  {
    "text": "going to be set on it and what",
    "start": "845120",
    "end": "846480"
  },
  {
    "text": "terminal.app is going to do in turn is",
    "start": "846480",
    "end": "848399"
  },
  {
    "text": "launch a login shell and login shell is",
    "start": "848399",
    "end": "850399"
  },
  {
    "text": "going to execute that dot profile file",
    "start": "850399",
    "end": "852800"
  },
  {
    "text": "we just wrote containing arbitrary shell",
    "start": "852800",
    "end": "854800"
  },
  {
    "text": "commands sweet i think we just improved",
    "start": "854800",
    "end": "857279"
  },
  {
    "text": "on the last one by having",
    "start": "857279",
    "end": "859600"
  },
  {
    "text": "no requirement to bundle anything with",
    "start": "859600",
    "end": "861279"
  },
  {
    "text": "our app this can be done entirely at",
    "start": "861279",
    "end": "863120"
  },
  {
    "text": "runtime",
    "start": "863120",
    "end": "865360"
  },
  {
    "text": "the patch for this one was released in",
    "start": "865360",
    "end": "866720"
  },
  {
    "text": "big sur 11.6 there's currently some",
    "start": "866720",
    "end": "868959"
  },
  {
    "text": "confusion with apple they told me it was",
    "start": "868959",
    "end": "871199"
  },
  {
    "text": "fixed in 11.5 but my initial report",
    "start": "871199",
    "end": "873760"
  },
  {
    "text": "clearly mentions that the vulnerable",
    "start": "873760",
    "end": "876000"
  },
  {
    "text": "tested version was 11.5 anyways here's",
    "start": "876000",
    "end": "879040"
  },
  {
    "text": "the patch if you specify the home",
    "start": "879040",
    "end": "880720"
  },
  {
    "text": "variable it's going to be overwritten",
    "start": "880720",
    "end": "882240"
  },
  {
    "text": "with the value in the core services ui",
    "start": "882240",
    "end": "884000"
  },
  {
    "text": "agent this is not a value you could",
    "start": "884000",
    "end": "885600"
  },
  {
    "text": "tamper with at least within the app",
    "start": "885600",
    "end": "887199"
  },
  {
    "text": "sandbox and it's also going to check for",
    "start": "887199",
    "end": "889360"
  },
  {
    "text": "the xpc prefix and the cf fixed user",
    "start": "889360",
    "end": "892320"
  },
  {
    "text": "home value the xpc prefix is a different",
    "start": "892320",
    "end": "894720"
  },
  {
    "text": "exploit i couldn't fit into this",
    "start": "894720",
    "end": "896079"
  },
  {
    "text": "presentation",
    "start": "896079",
    "end": "898560"
  },
  {
    "text": "you can find it elsewhere but",
    "start": "898560",
    "end": "900000"
  },
  {
    "text": "essentially",
    "start": "900000",
    "end": "901279"
  },
  {
    "text": "if those conditions are true the",
    "start": "901279",
    "end": "902720"
  },
  {
    "text": "variable is ignored and not sent along",
    "start": "902720",
    "end": "904639"
  },
  {
    "text": "in the launch request",
    "start": "904639",
    "end": "906320"
  },
  {
    "text": "now is this as good as we can get",
    "start": "906320",
    "end": "910079"
  },
  {
    "text": "i think we can",
    "start": "911040",
    "end": "912880"
  },
  {
    "text": "level up one further and so in the last",
    "start": "912880",
    "end": "914959"
  },
  {
    "text": "one i showed you how we can write to",
    "start": "914959",
    "end": "916240"
  },
  {
    "text": "disk and have that file executed but can",
    "start": "916240",
    "end": "918320"
  },
  {
    "text": "we remove that requirement altogether",
    "start": "918320",
    "end": "920079"
  },
  {
    "text": "can we make this a proper file list",
    "start": "920079",
    "end": "921920"
  },
  {
    "text": "exploit",
    "start": "921920",
    "end": "923120"
  },
  {
    "text": "and we can do that we're going to do it",
    "start": "923120",
    "end": "924959"
  },
  {
    "text": "first by looking at this api ns",
    "start": "924959",
    "end": "927839"
  },
  {
    "text": "workspace open url is going to take that",
    "start": "927839",
    "end": "929759"
  },
  {
    "text": "first argument and it's going to set it",
    "start": "929759",
    "end": "931279"
  },
  {
    "text": "to in url in the open call input",
    "start": "931279",
    "end": "933519"
  },
  {
    "text": "structure i showed you earlier if we",
    "start": "933519",
    "end": "935600"
  },
  {
    "text": "pass perl user bin perl to this api",
    "start": "935600",
    "end": "938480"
  },
  {
    "text": "we're going to see something like this",
    "start": "938480",
    "end": "940000"
  },
  {
    "text": "and what's going to happen under the",
    "start": "940000",
    "end": "941199"
  },
  {
    "text": "hood is the uti of perl is going to be",
    "start": "941199",
    "end": "943360"
  },
  {
    "text": "evaluated to public.unix executable and",
    "start": "943360",
    "end": "946399"
  },
  {
    "text": "then the binding for unix executable is",
    "start": "946399",
    "end": "948800"
  },
  {
    "text": "going to be evaluated to see that",
    "start": "948800",
    "end": "950959"
  },
  {
    "text": "terminal registered",
    "start": "950959",
    "end": "953839"
  },
  {
    "text": "uti",
    "start": "953839",
    "end": "955199"
  },
  {
    "text": "and some checks are going to prevent",
    "start": "955199",
    "end": "956560"
  },
  {
    "text": "this from actually occurring however if",
    "start": "956560",
    "end": "959120"
  },
  {
    "text": "we were to go use",
    "start": "959120",
    "end": "961759"
  },
  {
    "text": "the deprecated cousin of this api",
    "start": "961759",
    "end": "965360"
  },
  {
    "text": "excuse me",
    "start": "965360",
    "end": "966880"
  },
  {
    "text": "launch application what we'll see is",
    "start": "966880",
    "end": "969440"
  },
  {
    "text": "this argument is set to application url",
    "start": "969440",
    "end": "971680"
  },
  {
    "text": "in app params",
    "start": "971680",
    "end": "973519"
  },
  {
    "text": "structure a different structure by",
    "start": "973519",
    "end": "975440"
  },
  {
    "text": "passing user bin perl to this one we can",
    "start": "975440",
    "end": "977440"
  },
  {
    "text": "bypass that restriction and get perl to",
    "start": "977440",
    "end": "979759"
  },
  {
    "text": "launch in terminal now before we get",
    "start": "979759",
    "end": "981839"
  },
  {
    "text": "into the exploit many of you already can",
    "start": "981839",
    "end": "984160"
  },
  {
    "text": "tell that we've just expanded our attack",
    "start": "984160",
    "end": "986000"
  },
  {
    "text": "surface tremendously we now have",
    "start": "986000",
    "end": "988160"
  },
  {
    "text": "hundreds of extra unix executable",
    "start": "988160",
    "end": "990240"
  },
  {
    "text": "binaries available to us and we also",
    "start": "990240",
    "end": "993199"
  },
  {
    "text": "know that they used to",
    "start": "993199",
    "end": "994800"
  },
  {
    "text": "love putting features and flags into the",
    "start": "994800",
    "end": "997440"
  },
  {
    "text": "environment variables pearl has a very",
    "start": "997440",
    "end": "999600"
  },
  {
    "text": "special one in fact i call this one the",
    "start": "999600",
    "end": "1002079"
  },
  {
    "text": "mother of all bypasses",
    "start": "1002079",
    "end": "1004160"
  },
  {
    "text": "and it looks like this let's step",
    "start": "1004160",
    "end": "1005759"
  },
  {
    "text": "through it so first note that we're",
    "start": "1005759",
    "end": "1007600"
  },
  {
    "text": "going to use set end to set in the",
    "start": "1007600",
    "end": "1009920"
  },
  {
    "text": "environment variable in the client this",
    "start": "1009920",
    "end": "1011680"
  },
  {
    "text": "is going to abuse the big sur",
    "start": "1011680",
    "end": "1012959"
  },
  {
    "text": "inheritance feature i talked about",
    "start": "1012959",
    "end": "1014320"
  },
  {
    "text": "earlier we're going to set pearl5 up to",
    "start": "1014320",
    "end": "1017199"
  },
  {
    "text": "d this is going to launch pearl in debug",
    "start": "1017199",
    "end": "1019120"
  },
  {
    "text": "mode when pearl is running in debug mode",
    "start": "1019120",
    "end": "1021279"
  },
  {
    "text": "it's going to take the value of pearl5db",
    "start": "1021279",
    "end": "1023440"
  },
  {
    "text": "which we set next and it's going to",
    "start": "1023440",
    "end": "1025038"
  },
  {
    "text": "prepend that to any pearl code you might",
    "start": "1025039",
    "end": "1027120"
  },
  {
    "text": "want to execute in other words arbitrary",
    "start": "1027120",
    "end": "1029760"
  },
  {
    "text": "pearl code in pro 5db is going to be",
    "start": "1029760",
    "end": "1032079"
  },
  {
    "text": "executed lastly we're going to bypass",
    "start": "1032079",
    "end": "1034640"
  },
  {
    "text": "the unix executable launch restriction",
    "start": "1034640",
    "end": "1036558"
  },
  {
    "text": "by calling into the deprecated api and",
    "start": "1036559",
    "end": "1038640"
  },
  {
    "text": "passing user bin perl and this is going",
    "start": "1038640",
    "end": "1040640"
  },
  {
    "text": "to complete a fileless silent zero",
    "start": "1040640",
    "end": "1043438"
  },
  {
    "text": "interaction sandbox escape that's also",
    "start": "1043439",
    "end": "1045678"
  },
  {
    "text": "tweetable as a cherry on top",
    "start": "1045679",
    "end": "1048400"
  },
  {
    "text": "in these three lines are three issues",
    "start": "1048400",
    "end": "1050320"
  },
  {
    "text": "the first is environment variable",
    "start": "1050320",
    "end": "1051919"
  },
  {
    "text": "inheritance between sandbox and",
    "start": "1051919",
    "end": "1053520"
  },
  {
    "text": "unsandbox contacts i've highlighted this",
    "start": "1053520",
    "end": "1056000"
  },
  {
    "text": "several times already",
    "start": "1056000",
    "end": "1057679"
  },
  {
    "text": "second we're able to bypass the unix",
    "start": "1057679",
    "end": "1059600"
  },
  {
    "text": "executable restrictions by calling into",
    "start": "1059600",
    "end": "1061440"
  },
  {
    "text": "the deprecated api",
    "start": "1061440",
    "end": "1063600"
  },
  {
    "text": "and then finally it's not so much an",
    "start": "1063600",
    "end": "1065440"
  },
  {
    "text": "issue as it is",
    "start": "1065440",
    "end": "1066880"
  },
  {
    "text": "feature command injection as a feature",
    "start": "1066880",
    "end": "1068960"
  },
  {
    "text": "that's arbitrary pro code in pearl 5 db",
    "start": "1068960",
    "end": "1072480"
  },
  {
    "text": "okay now the final patch today was",
    "start": "1072480",
    "end": "1074480"
  },
  {
    "text": "issued in 11.5 and it checks that if the",
    "start": "1074480",
    "end": "1076799"
  },
  {
    "text": "client is sandboxed the argument",
    "start": "1076799",
    "end": "1078880"
  },
  {
    "text": "provided is it a bundle is it a",
    "start": "1078880",
    "end": "1081600"
  },
  {
    "text": "registered bundle and if it isn't a",
    "start": "1081600",
    "end": "1083440"
  },
  {
    "text": "permission error will be thrown",
    "start": "1083440",
    "end": "1085600"
  },
  {
    "text": "now the last exploit today has to do",
    "start": "1085600",
    "end": "1087760"
  },
  {
    "text": "with electron",
    "start": "1087760",
    "end": "1089120"
  },
  {
    "text": "electron is a mac os red teamers",
    "start": "1089120",
    "end": "1092640"
  },
  {
    "text": "i suppose you could say",
    "start": "1092640",
    "end": "1094400"
  },
  {
    "text": "dream it's",
    "start": "1094400",
    "end": "1096400"
  },
  {
    "text": "a well-known process injection vector",
    "start": "1096400",
    "end": "1098480"
  },
  {
    "text": "through electron run as node you can",
    "start": "1098480",
    "end": "1100240"
  },
  {
    "text": "specify that environment variable and",
    "start": "1100240",
    "end": "1102320"
  },
  {
    "text": "then you can pass arbitrary javascript",
    "start": "1102320",
    "end": "1104080"
  },
  {
    "text": "through arguments or standard input to",
    "start": "1104080",
    "end": "1106240"
  },
  {
    "text": "execute in the context of the electron",
    "start": "1106240",
    "end": "1108240"
  },
  {
    "text": "app and because of process injection",
    "start": "1108240",
    "end": "1110960"
  },
  {
    "text": "you'll have access to all of the privacy",
    "start": "1110960",
    "end": "1112799"
  },
  {
    "text": "tcc privileges as well as the",
    "start": "1112799",
    "end": "1114480"
  },
  {
    "text": "entitlements of the app and",
    "start": "1114480",
    "end": "1116720"
  },
  {
    "text": "it's it's perfect for that however from",
    "start": "1116720",
    "end": "1119200"
  },
  {
    "text": "within the app sandbox remember we",
    "start": "1119200",
    "end": "1121039"
  },
  {
    "text": "cannot specify any arguments",
    "start": "1121039",
    "end": "1123520"
  },
  {
    "text": "to an application we can just launch it",
    "start": "1123520",
    "end": "1125360"
  },
  {
    "text": "and control its environment so is there",
    "start": "1125360",
    "end": "1127120"
  },
  {
    "text": "another vector we can achieve process",
    "start": "1127120",
    "end": "1129120"
  },
  {
    "text": "injection with and it's kind of spoiled",
    "start": "1129120",
    "end": "1131039"
  },
  {
    "text": "with the title that's node options you",
    "start": "1131039",
    "end": "1133520"
  },
  {
    "text": "are allowed to pass",
    "start": "1133520",
    "end": "1135280"
  },
  {
    "text": "command line options to the underlying",
    "start": "1135280",
    "end": "1137039"
  },
  {
    "text": "process through node options",
    "start": "1137039",
    "end": "1138960"
  },
  {
    "text": "specifically it looks like this the",
    "start": "1138960",
    "end": "1140720"
  },
  {
    "text": "command line flag we're interested in is",
    "start": "1140720",
    "end": "1142559"
  },
  {
    "text": "require it takes this the path you you",
    "start": "1142559",
    "end": "1145200"
  },
  {
    "text": "passed to require and it'll just execute",
    "start": "1145200",
    "end": "1147280"
  },
  {
    "text": "that that's it",
    "start": "1147280",
    "end": "1148880"
  },
  {
    "text": "process injection complete one note i",
    "start": "1148880",
    "end": "1151360"
  },
  {
    "text": "want to mention here is that officially",
    "start": "1151360",
    "end": "1153440"
  },
  {
    "text": "in the electron docs this is only for",
    "start": "1153440",
    "end": "1155280"
  },
  {
    "text": "unpackaged applications where the main x",
    "start": "1155280",
    "end": "1158000"
  },
  {
    "text": "main executable is still named electron",
    "start": "1158000",
    "end": "1160880"
  },
  {
    "text": "however of course there was a bug there",
    "start": "1160880",
    "end": "1162799"
  },
  {
    "text": "was a bug where note options were not",
    "start": "1162799",
    "end": "1164559"
  },
  {
    "text": "filtered for path packaged apps which is",
    "start": "1164559",
    "end": "1167600"
  },
  {
    "text": "apps where the main executable was",
    "start": "1167600",
    "end": "1170000"
  },
  {
    "text": "renamed",
    "start": "1170000",
    "end": "1171280"
  },
  {
    "text": "uh they sort of fixed it they didn't",
    "start": "1171280",
    "end": "1173440"
  },
  {
    "text": "issue a security advisory but",
    "start": "1173440",
    "end": "1174960"
  },
  {
    "text": "acknowledged the security-related",
    "start": "1174960",
    "end": "1176840"
  },
  {
    "text": "nature i reported a patch bypass to them",
    "start": "1176840",
    "end": "1179600"
  },
  {
    "text": "which is relatively straightforward you",
    "start": "1179600",
    "end": "1181280"
  },
  {
    "text": "just specify electron runners node",
    "start": "1181280",
    "end": "1183120"
  },
  {
    "text": "alongside the node options and they",
    "start": "1183120",
    "end": "1184799"
  },
  {
    "text": "won't be filtered on packaged apps they",
    "start": "1184799",
    "end": "1187520"
  },
  {
    "text": "finally responded to me after months of",
    "start": "1187520",
    "end": "1189760"
  },
  {
    "text": "ignoring me",
    "start": "1189760",
    "end": "1191039"
  },
  {
    "text": "and they said we do not consider",
    "start": "1191039",
    "end": "1192320"
  },
  {
    "text": "physically local attacks in our thread",
    "start": "1192320",
    "end": "1193760"
  },
  {
    "text": "model while also admitting elsewhere",
    "start": "1193760",
    "end": "1196240"
  },
  {
    "text": "that require will remain filtered in",
    "start": "1196240",
    "end": "1197840"
  },
  {
    "text": "upstream electron as a security measure",
    "start": "1197840",
    "end": "1200000"
  },
  {
    "text": "so",
    "start": "1200000",
    "end": "1200720"
  },
  {
    "text": "essentially what it means is they don't",
    "start": "1200720",
    "end": "1202240"
  },
  {
    "text": "want to fix it",
    "start": "1202240",
    "end": "1204000"
  },
  {
    "text": "so here's the exploit you can take these",
    "start": "1204000",
    "end": "1206480"
  },
  {
    "text": "two lines essentially and put it in your",
    "start": "1206480",
    "end": "1208400"
  },
  {
    "text": "macro and escape the macro sandbox",
    "start": "1208400",
    "end": "1211360"
  },
  {
    "text": "inject into an electron app to abuse its",
    "start": "1211360",
    "end": "1213520"
  },
  {
    "text": "tc tcc privileges and entitlements and",
    "start": "1213520",
    "end": "1216320"
  },
  {
    "text": "nobody wants to fix this um let's go",
    "start": "1216320",
    "end": "1219039"
  },
  {
    "text": "over it and what it does",
    "start": "1219039",
    "end": "1220400"
  },
  {
    "text": "here we cut a head document containing",
    "start": "1220400",
    "end": "1222240"
  },
  {
    "text": "the javascript we want to run outside of",
    "start": "1222240",
    "end": "1223919"
  },
  {
    "text": "the sandbox to payload.js this is going",
    "start": "1223919",
    "end": "1226240"
  },
  {
    "text": "to be written inside the app sandbox",
    "start": "1226240",
    "end": "1228000"
  },
  {
    "text": "container and third i'm sorry and next",
    "start": "1228000",
    "end": "1230880"
  },
  {
    "text": "we're going to trigger",
    "start": "1230880",
    "end": "1232559"
  },
  {
    "text": "the bug we talked about today through a",
    "start": "1232559",
    "end": "1234240"
  },
  {
    "text": "third vector and that's the open cli",
    "start": "1234240",
    "end": "1236320"
  },
  {
    "text": "binary open will call into launch",
    "start": "1236320",
    "end": "1238159"
  },
  {
    "text": "services you can use the n flag to",
    "start": "1238159",
    "end": "1240320"
  },
  {
    "text": "specify the environment variables of",
    "start": "1240320",
    "end": "1242240"
  },
  {
    "text": "your choice that easy we'll specify",
    "start": "1242240",
    "end": "1244480"
  },
  {
    "text": "electron run as node to spec to to",
    "start": "1244480",
    "end": "1246960"
  },
  {
    "text": "bypass the node options filtering and",
    "start": "1246960",
    "end": "1248799"
  },
  {
    "text": "then finally we'll specify node options",
    "start": "1248799",
    "end": "1251840"
  },
  {
    "text": "to require the file we just wrote and",
    "start": "1251840",
    "end": "1254640"
  },
  {
    "text": "that's that's it",
    "start": "1254640",
    "end": "1257280"
  },
  {
    "text": "if you do want to work around this issue",
    "start": "1257280",
    "end": "1259440"
  },
  {
    "text": "you can protect yourself by disabling",
    "start": "1259440",
    "end": "1261280"
  },
  {
    "text": "the run as node fuse and that's going to",
    "start": "1261280",
    "end": "1263280"
  },
  {
    "text": "have electron run as node ignored in",
    "start": "1263280",
    "end": "1265120"
  },
  {
    "text": "your app some apps are already doing",
    "start": "1265120",
    "end": "1266880"
  },
  {
    "text": "this but as you can see the majority are",
    "start": "1266880",
    "end": "1268880"
  },
  {
    "text": "not",
    "start": "1268880",
    "end": "1271120"
  },
  {
    "text": "all right now what's left clearly apple",
    "start": "1274240",
    "end": "1276880"
  },
  {
    "text": "has chosen a wacomo approach they are",
    "start": "1276880",
    "end": "1278960"
  },
  {
    "text": "ignoring environment variables and",
    "start": "1278960",
    "end": "1280400"
  },
  {
    "text": "vectors as i report report them to them",
    "start": "1280400",
    "end": "1283440"
  },
  {
    "text": "but the crux of the issue remains and",
    "start": "1283440",
    "end": "1285280"
  },
  {
    "text": "that's that applications can still be",
    "start": "1285280",
    "end": "1286960"
  },
  {
    "text": "launched outside of the sandbox and",
    "start": "1286960",
    "end": "1288480"
  },
  {
    "text": "their environment variables can still be",
    "start": "1288480",
    "end": "1290159"
  },
  {
    "text": "controlled i think a big vector that's",
    "start": "1290159",
    "end": "1292559"
  },
  {
    "text": "left is application specific environment",
    "start": "1292559",
    "end": "1294880"
  },
  {
    "text": "variables today's example has been node",
    "start": "1294880",
    "end": "1297919"
  },
  {
    "text": "options but there are others",
    "start": "1297919",
    "end": "1299919"
  },
  {
    "text": "i might disclose them by the time the",
    "start": "1299919",
    "end": "1301679"
  },
  {
    "text": "actual talk happens",
    "start": "1301679",
    "end": "1303679"
  },
  {
    "text": "i've also shown you apis that can be",
    "start": "1303679",
    "end": "1306080"
  },
  {
    "text": "influenced by environment variables the",
    "start": "1306080",
    "end": "1308000"
  },
  {
    "text": "specific example was cf fixed user home",
    "start": "1308000",
    "end": "1310400"
  },
  {
    "text": "and in his home directory as well as its",
    "start": "1310400",
    "end": "1312320"
  },
  {
    "text": "many other dependents",
    "start": "1312320",
    "end": "1314320"
  },
  {
    "text": "and i didn't really talk about it today",
    "start": "1314320",
    "end": "1315760"
  },
  {
    "text": "but it does matter",
    "start": "1315760",
    "end": "1317280"
  },
  {
    "text": "sometimes sandbox parameters are",
    "start": "1317280",
    "end": "1318880"
  },
  {
    "text": "initialized via environment variables",
    "start": "1318880",
    "end": "1321280"
  },
  {
    "text": "and so you can shift where the",
    "start": "1321280",
    "end": "1323039"
  },
  {
    "text": "application or service is restricted and",
    "start": "1323039",
    "end": "1325840"
  },
  {
    "text": "possibly",
    "start": "1325840",
    "end": "1327200"
  },
  {
    "text": "cause some unintended consequences",
    "start": "1327200",
    "end": "1330320"
  },
  {
    "text": "if you want to defend yourself i",
    "start": "1330320",
    "end": "1331679"
  },
  {
    "text": "submitted a pr to the objective-c tool",
    "start": "1331679",
    "end": "1333760"
  },
  {
    "text": "process monitor to extract environment",
    "start": "1333760",
    "end": "1335919"
  },
  {
    "text": "variable information in process",
    "start": "1335919",
    "end": "1338080"
  },
  {
    "text": "execution events and once you have this",
    "start": "1338080",
    "end": "1340799"
  },
  {
    "text": "information available you'd want to look",
    "start": "1340799",
    "end": "1342640"
  },
  {
    "text": "for everything we talked about today",
    "start": "1342640",
    "end": "1345200"
  },
  {
    "text": "i also want to call it that java fits",
    "start": "1345200",
    "end": "1346640"
  },
  {
    "text": "the shield app already looks for the",
    "start": "1346640",
    "end": "1348080"
  },
  {
    "text": "first but it's not going to work in the",
    "start": "1348080",
    "end": "1349760"
  },
  {
    "text": "case of unpackaged applications for",
    "start": "1349760",
    "end": "1352159"
  },
  {
    "text": "example vs code and key base where you",
    "start": "1352159",
    "end": "1354320"
  },
  {
    "text": "only need to specify node options and",
    "start": "1354320",
    "end": "1356400"
  },
  {
    "text": "require the path the file of your choice",
    "start": "1356400",
    "end": "1360640"
  },
  {
    "text": "another heuristic that's worth looking",
    "start": "1360640",
    "end": "1362640"
  },
  {
    "text": "at if you can determine the parent",
    "start": "1362640",
    "end": "1364720"
  },
  {
    "text": "process identifier of an application",
    "start": "1364720",
    "end": "1366960"
  },
  {
    "text": "launched through launch services",
    "start": "1366960",
    "end": "1368799"
  },
  {
    "text": "jaren bradley has a tool called truetree",
    "start": "1368799",
    "end": "1370720"
  },
  {
    "text": "for that",
    "start": "1370720",
    "end": "1371840"
  },
  {
    "text": "and you check that the parent is sandbox",
    "start": "1371840",
    "end": "1373520"
  },
  {
    "text": "but the child isn't that's worth adding",
    "start": "1373520",
    "end": "1375600"
  },
  {
    "text": "some weighting to your detection",
    "start": "1375600",
    "end": "1377039"
  },
  {
    "text": "algorithm",
    "start": "1377039",
    "end": "1378159"
  },
  {
    "text": "and that's all for me today thank you",
    "start": "1378159",
    "end": "1380240"
  },
  {
    "text": "very much",
    "start": "1380240",
    "end": "1381970"
  },
  {
    "text": "[Music]",
    "start": "1381970",
    "end": "1391589"
  },
  {
    "text": "you",
    "start": "1392159",
    "end": "1394240"
  }
]