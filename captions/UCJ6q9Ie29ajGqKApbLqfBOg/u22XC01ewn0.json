[
  {
    "text": "okay so hello everyone good afternoon welcome to this talk let me introduce",
    "start": "30",
    "end": "5460"
  },
  {
    "text": "myself my name is Michael Graff meter I work as a security researcher trainer",
    "start": "5460",
    "end": "12300"
  },
  {
    "text": "architect I mostly work with a company called secure and I also work with a",
    "start": "12300",
    "end": "18000"
  },
  {
    "text": "company called gopis and this talk will be about some windows hello for business",
    "start": "18000",
    "end": "25740"
  },
  {
    "text": "stuff because I've been playing around with this technology for the past couple of months I've discovered several",
    "start": "25740",
    "end": "31320"
  },
  {
    "text": "different attack vectors of which can be used to do something bad to Active",
    "start": "31320",
    "end": "40260"
  },
  {
    "text": "Directory so let's talk about it just out of curiosity which one of you have",
    "start": "40260",
    "end": "46260"
  },
  {
    "text": "already deployed Windows hello for business in your environment or in your customers environment not many hands",
    "start": "46260",
    "end": "54420"
  },
  {
    "text": "actually as I was quite suspecting so let's first talk about what Windows",
    "start": "54420",
    "end": "61949"
  },
  {
    "text": "hello for business is and I will omit all the PR marketing bus and I will get",
    "start": "61949",
    "end": "67740"
  },
  {
    "text": "to the technical details behind this technology I will then talk about several attacks like injection of custom",
    "start": "67740",
    "end": "75030"
  },
  {
    "text": "keys I will talk about the rocket attack no of course also I will show you how to",
    "start": "75030",
    "end": "80159"
  },
  {
    "text": "audit this thing how to mitigate these security issues so let's start with",
    "start": "80159",
    "end": "86939"
  },
  {
    "text": "below Windows hello for business as you probably suspect it's not a lie Lionel Richie or Adele song but it's a",
    "start": "86939",
    "end": "95009"
  },
  {
    "text": "technology from Microsoft and it's one of Microsoft's three pillars for",
    "start": "95009",
    "end": "100409"
  },
  {
    "text": "password les authentication so the first pillar is Windows hello for business which allows a user to bind his identity",
    "start": "100409",
    "end": "109110"
  },
  {
    "text": "to a device to a notebook or specifically to a TPM chip that is on that notebook the second pillar is Fido",
    "start": "109110",
    "end": "116479"
  },
  {
    "text": "authentication you know you bikies Titan and some other devices and the third technology is the mobile application the",
    "start": "116479",
    "end": "125070"
  },
  {
    "text": "Authenticator application so we'll mostly talk about the first one at the end I will show you something that's",
    "start": "125070",
    "end": "131910"
  },
  {
    "text": "related to the second one to the Pfizer authentication",
    "start": "131910",
    "end": "137200"
  },
  {
    "text": "but let's stick to the windows hello for business part first so this is the users",
    "start": "137200",
    "end": "145900"
  },
  {
    "text": "perspective when a user locks in on a Windows hello for business enabled computer this screen pops up asking the",
    "start": "145900",
    "end": "153640"
  },
  {
    "text": "user to register for Windows hello for business and he's first asked to do some",
    "start": "153640",
    "end": "159190"
  },
  {
    "text": "multi-factor authentication you know like mobile application mmm short message or or something else and",
    "start": "159190",
    "end": "166650"
  },
  {
    "text": "then in the second step public/private key pair is generated on a TPM of that",
    "start": "166650",
    "end": "173080"
  },
  {
    "text": "device probably notebook and user is asked to provide a pin code widget and",
    "start": "173080",
    "end": "178240"
  },
  {
    "text": "protects the private key which is stored on the TPM and after user configures the",
    "start": "178240",
    "end": "186310"
  },
  {
    "text": "pin code this public key is registered in Active Directory or in Azure Active",
    "start": "186310",
    "end": "192190"
  },
  {
    "text": "Directory and the user can start using the pin code instead of his corporate",
    "start": "192190",
    "end": "198070"
  },
  {
    "text": "password and that pin code is only bound to this one specific device so even if",
    "start": "198070",
    "end": "204459"
  },
  {
    "text": "someone sniffs that thing code it cannot be used from other devices to sign into Active Directory and when the user then",
    "start": "204459",
    "end": "212560"
  },
  {
    "text": "goes into computer settings he can configure some more authentication factors for Windows hello for business",
    "start": "212560",
    "end": "218890"
  },
  {
    "text": "you know a Windows hello face like you use you smile at your computer and the",
    "start": "218890",
    "end": "224530"
  },
  {
    "text": "computer lets you in or you can bind your your fingerprint again as a replacement of that pin code so multiple",
    "start": "224530",
    "end": "232750"
  },
  {
    "text": "authentication factors are then supported with Windows hello and so",
    "start": "232750",
    "end": "237760"
  },
  {
    "text": "Windows hello for business there are different deployment options that an",
    "start": "237760",
    "end": "244270"
  },
  {
    "text": "administrator has to consider when deploying Windows hello for business and will be interested in those read modes",
    "start": "244270",
    "end": "251670"
  },
  {
    "text": "meaning on-premises key base trust and a sure ad joint key based trust and this",
    "start": "251670",
    "end": "260890"
  },
  {
    "text": "than the data model which is used in Active Directory when the technology is deployed you have a use",
    "start": "260890",
    "end": "267130"
  },
  {
    "text": "count his account object and then several key credentials object and one user can have one or more such",
    "start": "267130",
    "end": "274750"
  },
  {
    "text": "credential object each of those objects corresponds to a different device of that user and this data structure",
    "start": "274750",
    "end": "282250"
  },
  {
    "text": "contains ID of that is the public key which was generated on that TPM some",
    "start": "282250",
    "end": "287560"
  },
  {
    "text": "attestation data and of course information about that specific device",
    "start": "287560",
    "end": "293070"
  },
  {
    "text": "where is this information stored in Active Directory well in Active Directory 216 schema the new attribute",
    "start": "293070",
    "end": "300100"
  },
  {
    "text": "was added and it's called MSDS key credentialing and it's corresponding",
    "start": "300100",
    "end": "305580"
  },
  {
    "text": "backlink attribute an SDS key credentialing - BL so the rest of this",
    "start": "305580",
    "end": "311980"
  },
  {
    "text": "talk will be just only about these two attributes about nothing else",
    "start": "311980",
    "end": "317370"
  },
  {
    "text": "and what credential types can be stored in these attributes well first of them",
    "start": "317370",
    "end": "324460"
  },
  {
    "text": "ng C Keys next generation credentials these are the credentials that are stored on TPMS then we've already talked",
    "start": "324460",
    "end": "331090"
  },
  {
    "text": "about Fido right the the UB keys and SDK session transport keys these are some",
    "start": "331090",
    "end": "337530"
  },
  {
    "text": "computer authentication keys other types are undocumented I only know that",
    "start": "337530",
    "end": "343180"
  },
  {
    "text": "BitLocker keys can be stored in this attribute by but I haven't played with",
    "start": "343180",
    "end": "348490"
  },
  {
    "text": "this part yet so let's talk about the",
    "start": "348490",
    "end": "354190"
  },
  {
    "text": "first attack vector against this technology let's try to inject our",
    "start": "354190",
    "end": "359530"
  },
  {
    "text": "custom keys into Active Directory just",
    "start": "359530",
    "end": "365110"
  },
  {
    "text": "as a proof of concept so let me switch into the Active Directory environment",
    "start": "365110",
    "end": "370780"
  },
  {
    "text": "and I have this user account John for",
    "start": "370780",
    "end": "376120"
  },
  {
    "text": "whom I will generate key credentials so",
    "start": "376120",
    "end": "381520"
  },
  {
    "text": "what will I do I will just use a built-in command in Windows the new self signed certificate",
    "start": "381520",
    "end": "387400"
  },
  {
    "text": "and I will create a self signed certificate using this why because I just need this public/private key pair I",
    "start": "387400",
    "end": "394060"
  },
  {
    "text": "I don't need the actual certificate okay so I've just",
    "start": "394060",
    "end": "400600"
  },
  {
    "text": "rated this certificate on my computer",
    "start": "400600",
    "end": "405540"
  },
  {
    "text": "okay still still generating the public/private key pair apparently it",
    "start": "406680",
    "end": "414820"
  },
  {
    "text": "will be super secure because it takes long yeah now it's there and if I now",
    "start": "414820",
    "end": "420640"
  },
  {
    "text": "refresh the view of my user certificates here is the new self signed certificate",
    "start": "420640",
    "end": "426750"
  },
  {
    "text": "containing just s ID of that user in in subject and in issued by so I will now",
    "start": "426750",
    "end": "434980"
  },
  {
    "text": "write this public key from that certificate into an NGC key object it's",
    "start": "434980",
    "end": "441460"
  },
  {
    "text": "a blob data data structure this is its representation I've generated a device",
    "start": "441460",
    "end": "447310"
  },
  {
    "text": "ID current date I put in this public key and now I will use a built in Active",
    "start": "447310",
    "end": "456610"
  },
  {
    "text": "Directory command let's set a D object and I will write this newly generated key into an SD s key financial attribute",
    "start": "456610",
    "end": "464830"
  },
  {
    "text": "of that user object of user John so now the the public key is registered in",
    "start": "464830",
    "end": "471820"
  },
  {
    "text": "Active Directory and this public key works as a alternate set of credentials",
    "start": "471820",
    "end": "479860"
  },
  {
    "text": "so now if the user resets his password does anything else to his account but if",
    "start": "479860",
    "end": "486160"
  },
  {
    "text": "he doesn't do any modifications to this msds key credentialing attribute i as an",
    "start": "486160",
    "end": "492580"
  },
  {
    "text": "attacker still have access to this user account I can still authenticate against that",
    "start": "492580",
    "end": "497680"
  },
  {
    "text": "user account so let's do that and I will use a tool called kikyo it's from",
    "start": "497680",
    "end": "504550"
  },
  {
    "text": "Benjamin Delpy the author of mini cats like this tool is the Prada two mini cats so I will use it to request a TGT",
    "start": "504550",
    "end": "514150"
  },
  {
    "text": "ticket granting ticket from the Kerberos service using the PK in each protocol",
    "start": "514150",
    "end": "519849"
  },
  {
    "text": "public key initialization and I will provide it with the certificate I currently have stored on my computer so",
    "start": "519849",
    "end": "527890"
  },
  {
    "text": "if I execute this command and everything goes well it's",
    "start": "527890",
    "end": "534130"
  },
  {
    "text": "sending a request to a domain controller and I received a successful response",
    "start": "534130",
    "end": "542080"
  },
  {
    "text": "from the demon from the domain controller so here I have the TGT with the PAC data including the NT or ntlm",
    "start": "542080",
    "end": "556000"
  },
  {
    "text": "hash of the user's password so I haven't even known the user's password previously I only know that",
    "start": "556000",
    "end": "562330"
  },
  {
    "text": "public/private key pair but now I also know this which I can use for passed the heretics and and stuff like that okay so",
    "start": "562330",
    "end": "570100"
  },
  {
    "text": "that was just reading the the pack and now I can also ask ask for a regular TGT",
    "start": "570100",
    "end": "577180"
  },
  {
    "text": "story into into my computer the case the",
    "start": "577180",
    "end": "582610"
  },
  {
    "text": "TGT is here in a in a file now I can again use use mini cats to inject that",
    "start": "582610",
    "end": "587860"
  },
  {
    "text": "file into my computer's memory and to do a pastor ticket attack using this okay",
    "start": "587860",
    "end": "594190"
  },
  {
    "text": "so i've replaced password-based authentication with this certificate based authentication well active",
    "start": "594190",
    "end": "601450"
  },
  {
    "text": "directory has supported a certificate based authentication for a very long time but you need to have certificates",
    "start": "601450",
    "end": "608530"
  },
  {
    "text": "which were signed by a certificate authority but now you've seen that I have used a self-signed certificate that",
    "start": "608530",
    "end": "615100"
  },
  {
    "text": "was registered for this user account so no way of revoking that certificate",
    "start": "615100",
    "end": "620110"
  },
  {
    "text": "right because it's a self-signed thing",
    "start": "620110",
    "end": "625590"
  },
  {
    "text": "also during the demo you've seen one",
    "start": "625590",
    "end": "631210"
  },
  {
    "text": "command from my DS internals directory services internals PowerShell module that command was called get Ad geek",
    "start": "631210",
    "end": "637900"
  },
  {
    "text": "financial and I use this command just to generate this data structure that was later written into active directory so",
    "start": "637900",
    "end": "650590"
  },
  {
    "text": "what are the requirements for this attack vector to be possible first you need to have Windows Server to sixteen",
    "start": "650590",
    "end": "656920"
  },
  {
    "text": "domain controller because they added the support for this key based trust and also these domain controllers need to",
    "start": "656920",
    "end": "663760"
  },
  {
    "text": "have a KDC certificate but as soon as you deploy any enterprise certificate authority in that",
    "start": "663760",
    "end": "669610"
  },
  {
    "text": "environment all DC's get these certificates automatically so most of",
    "start": "669610",
    "end": "674830"
  },
  {
    "text": "the enterprise environments have these requirements met in order to write that",
    "start": "674830",
    "end": "681070"
  },
  {
    "text": "attribute MSDS King credential link I needed to have some permissions in Active Directory I needed to modify this",
    "start": "681070",
    "end": "687550"
  },
  {
    "text": "user object so it is a post exploitation a tag of course I needed to have those",
    "start": "687550",
    "end": "694709"
  },
  {
    "text": "permissions and then I created a persistence in Active Directory that",
    "start": "694709",
    "end": "700779"
  },
  {
    "text": "survives password resets now when let's look at it from the blue",
    "start": "700779",
    "end": "706899"
  },
  {
    "text": "teamers site let's look at the events that are generated on domain controllers",
    "start": "706899",
    "end": "712029"
  },
  {
    "text": "when doing this so as you see the the authentication generates a regular PK",
    "start": "712029",
    "end": "717910"
  },
  {
    "text": "init event as if you need a smart card sign on just the issuer name of the",
    "start": "717910",
    "end": "724120"
  },
  {
    "text": "certificate might be suspicious but you can actually put any arbitrary value in that subject name and you can try to",
    "start": "724120",
    "end": "731800"
  },
  {
    "text": "hide yourself when you do modification of this msds kiki credential link",
    "start": "731800",
    "end": "737680"
  },
  {
    "text": "attribute when you register a new device and you turned on attribute to change",
    "start": "737680",
    "end": "743950"
  },
  {
    "text": "auditing in Active Directory and even like this gets generated where it tells",
    "start": "743950",
    "end": "748959"
  },
  {
    "text": "you that this value was modified on this specific user account but you also only",
    "start": "748959",
    "end": "754600"
  },
  {
    "text": "see that some 828 bytes were written here but you don't see from what device",
    "start": "754600",
    "end": "760839"
  },
  {
    "text": "that originated what type of credentials display and so on then I really tried",
    "start": "760839",
    "end": "768400"
  },
  {
    "text": "hard to bypass this this law even but I failed miserably my first experiment was",
    "start": "768400",
    "end": "778709"
  },
  {
    "text": "implementing a client for MS DRS our protocol because this protocol come",
    "start": "778709",
    "end": "784510"
  },
  {
    "text": "contains one call IDL DRS right ng C key and you can use this protocol to modify",
    "start": "784510",
    "end": "792130"
  },
  {
    "text": "those keys instead of the LDAP instead of the regular LDAP protocol so this command is also present in my PowerShell",
    "start": "792130",
    "end": "799420"
  },
  {
    "text": "module but it generates the same even type as the LDAP protocol then I",
    "start": "799420",
    "end": "805360"
  },
  {
    "text": "try to use mini cats mini cats SDC shadow functionality to modify this msds key credentialing data",
    "start": "805360",
    "end": "813540"
  },
  {
    "text": "but the problem is that the type of the attribute is DN binary distinguished",
    "start": "813540",
    "end": "819460"
  },
  {
    "text": "time with binary and this is not yet supported by mini cats at this time",
    "start": "819460",
    "end": "825090"
  },
  {
    "text": "we'll see how it goes in the future now let's look at the data the data",
    "start": "825090",
    "end": "831580"
  },
  {
    "text": "structure which was written into active directory so can anyone here in this room interpret this data just by looking",
    "start": "831580",
    "end": "838390"
  },
  {
    "text": "at this probably not okay I would be surprised so this is what an",
    "start": "838390",
    "end": "843850"
  },
  {
    "text": "administrator might see in the attribute MSDS key coronary link when he looks into that so it's really not transparent",
    "start": "843850",
    "end": "854140"
  },
  {
    "text": "it's a black box when you try to look at this attribute using the Active Directory users and computers management",
    "start": "854140",
    "end": "863260"
  },
  {
    "text": "console you again see the binary data if you try to double click it you get this dialog that it's not supported you",
    "start": "863260",
    "end": "872050"
  },
  {
    "text": "cannot modify it you cannot delete the data you cannot view the data which is stored there using the user interface so",
    "start": "872050",
    "end": "879700"
  },
  {
    "text": "let's use a better tool which is again built into Windows and it's the LDP - so",
    "start": "879700",
    "end": "886600"
  },
  {
    "text": "it has some basic parsing of these MSDS key credentialing data structures but",
    "start": "886600",
    "end": "892450"
  },
  {
    "text": "they haven't implemented all the enumeration types support for all the key types so this one is a registration",
    "start": "892450",
    "end": "900730"
  },
  {
    "text": "of a Yubikey and you see that it says that the usage number seven which really means Fido is unknown so only only",
    "start": "900730",
    "end": "910180"
  },
  {
    "text": "partial support in this user interface I talked about permissions so who has the",
    "start": "910180",
    "end": "917560"
  },
  {
    "text": "permissions to modify this attribute by default apart from from domain admins of",
    "start": "917560",
    "end": "923170"
  },
  {
    "text": "course we have two new groups in Active Directory they are called key admins and Enterprise key are means and typical",
    "start": "923170",
    "end": "930610"
  },
  {
    "text": "members of these groups are ad FS Active Directory Federation services and so if you have a charade eConnect",
    "start": "930610",
    "end": "937240"
  },
  {
    "text": "deployed with some hybrid identity then this ad Connect service is a member of",
    "start": "937240",
    "end": "942580"
  },
  {
    "text": "one of these groups and also in the in the first line in the default ACLs you",
    "start": "942580",
    "end": "948130"
  },
  {
    "text": "see that computer objects can self register these key credentials for",
    "start": "948130",
    "end": "954670"
  },
  {
    "text": "themselves a side note there there is a",
    "start": "954670",
    "end": "960130"
  },
  {
    "text": "well-known bug in ED prep Active Directory preparations will you use when you are upgrading from older domains to",
    "start": "960130",
    "end": "968020"
  },
  {
    "text": "newer Active Directory domains and it mishandles the permissions of enterprise key admins and instead of modification",
    "start": "968020",
    "end": "975130"
  },
  {
    "text": "of MSDS key credential link it gives them full control over the domain object",
    "start": "975130",
    "end": "980380"
  },
  {
    "text": "which obviously is not right so there is a tool tool for from my former colleague",
    "start": "980380",
    "end": "986460"
  },
  {
    "text": "Michael from Holtz which can mitigate this and set those permissions in your",
    "start": "986460",
    "end": "993370"
  },
  {
    "text": "ad properly okay and I've also implemented this validated write of MSDS",
    "start": "993370",
    "end": "1001320"
  },
  {
    "text": "key credentialing attribute so if I generate a special format of this of",
    "start": "1001320",
    "end": "1006990"
  },
  {
    "text": "this data structure I can again write it into a computer object so this can be",
    "start": "1006990",
    "end": "1012720"
  },
  {
    "text": "used when I steal computer objects identity and under its identity I've",
    "start": "1012720",
    "end": "1018030"
  },
  {
    "text": "modified this MSDS key credentialing attribute and then even if the computer changes its Active Directory password I",
    "start": "1018030",
    "end": "1024930"
  },
  {
    "text": "still have access to that computer account I have still access to Active",
    "start": "1024930",
    "end": "1031740"
  },
  {
    "text": "Directory so this was the first part the first attack vector creation of your",
    "start": "1031740",
    "end": "1038400"
  },
  {
    "text": "custom NGC credentials next-generation credentials and injecting them into",
    "start": "1038400",
    "end": "1044000"
  },
  {
    "text": "Active Directory then there are several attack vectors which are related to",
    "start": "1044000",
    "end": "1050760"
  },
  {
    "text": "raqqa vulnerability who remembers the derocker the return of coppersmith",
    "start": "1050760",
    "end": "1056400"
  },
  {
    "text": "attack vulnerability okay a couple of you thank you so it was a very serious",
    "start": "1056400",
    "end": "1062660"
  },
  {
    "text": "vulnerability discovered like two or three years ago and it was a vulnerability or",
    "start": "1062660",
    "end": "1068390"
  },
  {
    "text": "of TPM chips which generated weak crackable public-private keepers you",
    "start": "1068390",
    "end": "1074360"
  },
  {
    "text": "could crack the you could factorize the the public key and generates retrieve",
    "start": "1074360",
    "end": "1082460"
  },
  {
    "text": "the private key out of a public key which breaks of course the",
    "start": "1082460",
    "end": "1088700"
  },
  {
    "text": "authentication and as we already said that Windows hello for business relies",
    "start": "1088700",
    "end": "1094040"
  },
  {
    "text": "on TPMS on keys generated on TPMS so",
    "start": "1094040",
    "end": "1099230"
  },
  {
    "text": "transitively this raqqa vulnerability is has also have something to do with",
    "start": "1099230",
    "end": "1106130"
  },
  {
    "text": "Windows hello for business and of course Microsoft was aware of that and they issued this security advisory they",
    "start": "1106130",
    "end": "1115070"
  },
  {
    "text": "implement its several patches for for Windows like like this one which adds",
    "start": "1115070",
    "end": "1120440"
  },
  {
    "text": "new events into computer even even looks when your Windows 10 computer meets this",
    "start": "1120440",
    "end": "1126700"
  },
  {
    "text": "bad keys these weak public keys you will see some even sin even looks probably no",
    "start": "1126700",
    "end": "1132350"
  },
  {
    "text": "one collects these events no one monitors these events but they are there you can also check the MMC interface",
    "start": "1132350",
    "end": "1140000"
  },
  {
    "text": "whether you have an old TPM chip with that bad version this is one of those",
    "start": "1140000",
    "end": "1146990"
  },
  {
    "text": "examples TPM from Infineon version 4.4 t",
    "start": "1146990",
    "end": "1152000"
  },
  {
    "text": "this one was definitely vulnerable so what microsoft recommends is to do they",
    "start": "1152000",
    "end": "1157490"
  },
  {
    "text": "recommend you to clear this TPM - to delete those those keys from TPM and of",
    "start": "1157490",
    "end": "1163190"
  },
  {
    "text": "course to fetch a patch and do a firmware update of this TPM chip on your",
    "start": "1163190",
    "end": "1169640"
  },
  {
    "text": "notebook so this was resolved also Microsoft's issued an undocumented",
    "start": "1169640",
    "end": "1175940"
  },
  {
    "text": "updates to ad FS Active Directory Federation services and with this powershell commandlets you can tell it",
    "start": "1175940",
    "end": "1183080"
  },
  {
    "text": "to start auditing wiki's being registered in a DFS and it will then",
    "start": "1183080",
    "end": "1190670"
  },
  {
    "text": "generate these two new events into even lock again these even types are",
    "start": "1190670",
    "end": "1196690"
  },
  {
    "text": "undocumented you would need to reverse engineer something to get to know these event IDs but they",
    "start": "1196690",
    "end": "1205790"
  },
  {
    "text": "are there and you can even block registration of weak keys so so far so",
    "start": "1205790",
    "end": "1212210"
  },
  {
    "text": "good they also develop this helper script or PowerShell module they",
    "start": "1212210",
    "end": "1218570"
  },
  {
    "text": "published it into a partial gallery it's called AD computer Keys and its purpose",
    "start": "1218570",
    "end": "1224750"
  },
  {
    "text": "was to remove these weak keys from",
    "start": "1224750",
    "end": "1230930"
  },
  {
    "text": "Active Directory and the way they they did that was replacing those keys",
    "start": "1230930",
    "end": "1238130"
  },
  {
    "text": "present in Active Directory with this one so this is the RSA public key which",
    "start": "1238130",
    "end": "1243650"
  },
  {
    "text": "is written by this module into Active Directory but the problem is that",
    "start": "1243650",
    "end": "1248690"
  },
  {
    "text": "although they call this key an unusable key it's completely usable so so a",
    "start": "1248690",
    "end": "1255800"
  },
  {
    "text": "person who generated this public/private key pair and hard-coded this public key",
    "start": "1255800",
    "end": "1261080"
  },
  {
    "text": "into that PowerShell script in in PowerShell gallery can still do",
    "start": "1261080",
    "end": "1267290"
  },
  {
    "text": "authentication against that account to which this this public key is registered actually it was generated by this guy at",
    "start": "1267290",
    "end": "1273920"
  },
  {
    "text": "Microsoft so he could have access to",
    "start": "1273920",
    "end": "1279590"
  },
  {
    "text": "those Active Directory environments where this script was executed so I",
    "start": "1279590",
    "end": "1285020"
  },
  {
    "text": "notified Microsoft and they have removed this script from power shell gallery so",
    "start": "1285020",
    "end": "1292840"
  },
  {
    "text": "but still if you executed this in your environment in the past you can use this",
    "start": "1292840",
    "end": "1298160"
  },
  {
    "text": "command to find those keys by that specific identifier and it will it will",
    "start": "1298160",
    "end": "1303980"
  },
  {
    "text": "show you the accounts which are paired with this so-called unusable hard-coded",
    "start": "1303980",
    "end": "1310190"
  },
  {
    "text": "key so this was another issue then",
    "start": "1310190",
    "end": "1316010"
  },
  {
    "text": "another issue that's that's related to to this vulnerability is that Active",
    "start": "1316010",
    "end": "1322040"
  },
  {
    "text": "Directory has broken referential integrity with those key credential",
    "start": "1322040",
    "end": "1327500"
  },
  {
    "text": "links so let's say you register your user account on a on a device and then",
    "start": "1327500",
    "end": "1334100"
  },
  {
    "text": "you Elite that device objects from Active Directory may be the device was stolen",
    "start": "1334100",
    "end": "1339830"
  },
  {
    "text": "compromised whatever but the funny thing is that the public key which was",
    "start": "1339830",
    "end": "1347060"
  },
  {
    "text": "registered on that device still remains in Active Directory it's it doesn't get",
    "start": "1347060",
    "end": "1352130"
  },
  {
    "text": "deleted from Active Directory because this this public key is not written to that device object but it is written to",
    "start": "1352130",
    "end": "1359240"
  },
  {
    "text": "the user object okay and then there there is no reference no backlink to the",
    "start": "1359240",
    "end": "1364610"
  },
  {
    "text": "device object on which registration was made so you delete this this object from",
    "start": "1364610",
    "end": "1370370"
  },
  {
    "text": "ID but that public-private keeper can still be used for authentication so this",
    "start": "1370370",
    "end": "1377060"
  },
  {
    "text": "really is a security issue also ad FS",
    "start": "1377060",
    "end": "1382390"
  },
  {
    "text": "has this feature stale device clean um you can configure it to delete stale devices all devices like every three",
    "start": "1382390",
    "end": "1389750"
  },
  {
    "text": "months or so but this feature has the same issue it only deletes the device",
    "start": "1389750",
    "end": "1396230"
  },
  {
    "text": "object but not public keys which are associated with this device even worse",
    "start": "1396230",
    "end": "1405080"
  },
  {
    "text": "if a company doesn't use TPMS or disables usage of DPMS for Windows hello",
    "start": "1405080",
    "end": "1412670"
  },
  {
    "text": "for business then these private keys are only written to software key storage providers from which they can of course",
    "start": "1412670",
    "end": "1419180"
  },
  {
    "text": "be retrieved these private keys and then they could be used by attackers",
    "start": "1419180",
    "end": "1424610"
  },
  {
    "text": "indefinitely okay so stolen notebooks which are not encrypted using BitLocker are a real",
    "start": "1424610",
    "end": "1431090"
  },
  {
    "text": "danger here for Active Directory authentication what is also bad we are",
    "start": "1431090",
    "end": "1436490"
  },
  {
    "text": "talking about public keys and as you know public keys are public right they they have this in their name so if you",
    "start": "1436490",
    "end": "1443540"
  },
  {
    "text": "look into permissions into Active Directory who can read these public keys who can read the the contents of the",
    "start": "1443540",
    "end": "1449420"
  },
  {
    "text": "MSDS key credentialing attribute everybody can do that authenticated users can do that that",
    "start": "1449420",
    "end": "1457550"
  },
  {
    "text": "means that everybody each user from Active Directory can list all those key credentials from ad and he",
    "start": "1457550",
    "end": "1465530"
  },
  {
    "text": "can then check them against this rocket owner ability and he could some identify weak keys and",
    "start": "1465530",
    "end": "1473150"
  },
  {
    "text": "then try cracking them on a on a high-performance cluster and that's why",
    "start": "1473150",
    "end": "1479360"
  },
  {
    "text": "I implemented this feature into my D s internal special module so again you use",
    "start": "1479360",
    "end": "1484809"
  },
  {
    "text": "regular powershell commandlets to retrieve the values of an SDS key credentialing then use this command a",
    "start": "1484809",
    "end": "1491059"
  },
  {
    "text": "lot of mine get a D key financial to pass the binary data structures and we will display the rocker view now you see",
    "start": "1491059",
    "end": "1501020"
  },
  {
    "text": "all the NGC and SDK keys that are registered in Active Directory for different user accounts you see that",
    "start": "1501020",
    "end": "1507830"
  },
  {
    "text": "some were registered in on-prem environment others in hybrid environment",
    "start": "1507830",
    "end": "1512929"
  },
  {
    "text": "against either Active Directory and this one which originates from Azure ad is really weak and it's crackable and it",
    "start": "1512929",
    "end": "1520100"
  },
  {
    "text": "still is in Active Directory and every Active Directory user can just run this",
    "start": "1520100",
    "end": "1525650"
  },
  {
    "text": "command and do this analysis without any special permissions Interactive directory so this opens elevation of",
    "start": "1525650",
    "end": "1533990"
  },
  {
    "text": "privileged attack you in the worst case you could elevate from a regular user from authenticated user to a domain",
    "start": "1533990",
    "end": "1540200"
  },
  {
    "text": "admin if the domain admin had this vulnerable TPM chip on his notebook and",
    "start": "1540200",
    "end": "1545270"
  },
  {
    "text": "he registered his device with his account through Windows hello for business ok so this is bad yeah you can",
    "start": "1545270",
    "end": "1554929"
  },
  {
    "text": "also use another view moduli to export all those module into a text file and",
    "start": "1554929",
    "end": "1560330"
  },
  {
    "text": "there are already tools which can pass this data structure including the",
    "start": "1560330",
    "end": "1566300"
  },
  {
    "text": "original tool which was released by the researchers who have find out about",
    "start": "1566300",
    "end": "1572059"
  },
  {
    "text": "found out about this rocker vulnerability so to my knowledge this is",
    "start": "1572059",
    "end": "1578720"
  },
  {
    "text": "the only way the the only tool so far that can extract this moduli these",
    "start": "1578720",
    "end": "1583730"
  },
  {
    "text": "public keys from active directory into some other format and send them to some",
    "start": "1583730",
    "end": "1590600"
  },
  {
    "text": "other cracking tools yeah so because of",
    "start": "1590600",
    "end": "1596510"
  },
  {
    "text": "my today's talk Microsoft issued a security adviser yesterday in the",
    "start": "1596510",
    "end": "1602030"
  },
  {
    "text": "evening and um they have released quite a long",
    "start": "1602030",
    "end": "1609379"
  },
  {
    "text": "manual on this so a compressed version of this talk is or part of it is in this",
    "start": "1609379",
    "end": "1617329"
  },
  {
    "text": "in this article of Microsoft and it also explains what you should do how you",
    "start": "1617329",
    "end": "1622729"
  },
  {
    "text": "should audit your Active Directory environment and what risks are connected",
    "start": "1622729",
    "end": "1629029"
  },
  {
    "text": "with this so let's look at the auditing part so if you have a shrek team",
    "start": "1629029",
    "end": "1638329"
  },
  {
    "text": "directory you can use this error ID portal and you can use this user",
    "start": "1638329",
    "end": "1645019"
  },
  {
    "text": "interface to list all your devices which are associated with the user accounts or you could use some some built-in",
    "start": "1645019",
    "end": "1650869"
  },
  {
    "text": "PowerShell commands in the EM Sol or user ad powershell modules but if you",
    "start": "1650869",
    "end": "1658279"
  },
  {
    "text": "have on-premises Active Directory there were no other tools before yesterday to",
    "start": "1658279",
    "end": "1665749"
  },
  {
    "text": "do to do this so you could use my own PowerShell module to list all those key",
    "start": "1665749",
    "end": "1671149"
  },
  {
    "text": "credential types from Active Directory and to interpret the data you see you bikies ng c credentials and other key",
    "start": "1671149",
    "end": "1679190"
  },
  {
    "text": "types and you should definitely validate these things you should validate these device IDs whether they correspond to",
    "start": "1679190",
    "end": "1685459"
  },
  {
    "text": "any existing devices in Active Directory or whether this value doesn't corresponds to any existing key meaning",
    "start": "1685459",
    "end": "1693529"
  },
  {
    "text": "that is probably something that an attacker injected to your Active Directory or it is an orphaned key which",
    "start": "1693529",
    "end": "1699259"
  },
  {
    "text": "is a reminder of a deleted device in Active Directory and so on okay so you can list this information from ID then",
    "start": "1699259",
    "end": "1708949"
  },
  {
    "text": "if you want to delete all the contents of these msds key credentialing",
    "start": "1708949",
    "end": "1715299"
  },
  {
    "text": "attribute you can use the built-in powershell tools and this is the only",
    "start": "1715299",
    "end": "1720739"
  },
  {
    "text": "way to delete it so you set ID users at ID computer and",
    "start": "1720739",
    "end": "1726079"
  },
  {
    "text": "you just clear the contents of this but the problem is that when a user has",
    "start": "1726079",
    "end": "1731209"
  },
  {
    "text": "multiple devices registered with his account by doing a cleanup of this actually",
    "start": "1731209",
    "end": "1736220"
  },
  {
    "text": "buuuut you remove revoke all those public is corresponding to all those devices but you you cannot do this",
    "start": "1736220",
    "end": "1743630"
  },
  {
    "text": "selectively for a specific device just to delete one and leave other public",
    "start": "1743630",
    "end": "1749120"
  },
  {
    "text": "keys corresponding to other devices intact in Active Directory so that is",
    "start": "1749120",
    "end": "1755870"
  },
  {
    "text": "why I created another PowerShell script for this and let me show you this",
    "start": "1755870",
    "end": "1761210"
  },
  {
    "text": "PowerShell script so this script first",
    "start": "1761210",
    "end": "1770140"
  },
  {
    "text": "retrieves all the key financial types which are registered for a specific user",
    "start": "1770140",
    "end": "1775429"
  },
  {
    "text": "account and using my most favorite PowerShell command which is our grid",
    "start": "1775429",
    "end": "1780500"
  },
  {
    "text": "view you can point and click select several such keys like this one I I",
    "start": "1780500",
    "end": "1787280"
  },
  {
    "text": "registered 20 minutes ago you can hit OK and that specific key is then deleted",
    "start": "1787280",
    "end": "1795049"
  },
  {
    "text": "from active directory leaving other Keys intact ok so again most of these",
    "start": "1795049",
    "end": "1802909"
  },
  {
    "text": "commands are just built in PowerShell commands built in active directory",
    "start": "1802909",
    "end": "1809500"
  },
  {
    "text": "module commands and the only command you need in addition to them is this get key",
    "start": "1809500",
    "end": "1816140"
  },
  {
    "text": "credential which interprets those binary data so that was selective key deletion",
    "start": "1816140",
    "end": "1831340"
  },
  {
    "text": "another feature that was implemented as mentioned at the beginning of the",
    "start": "1832330",
    "end": "1839539"
  },
  {
    "text": "presentation is Fido authentication and you can now use this Fido Keys Yubikey",
    "start": "1839539",
    "end": "1846770"
  },
  {
    "text": "fight e and e WB m and and others to authenticate not just against those",
    "start": "1846770",
    "end": "1852950"
  },
  {
    "text": "cloud services against web applications but you can use them to sign into Windows and again if you have these",
    "start": "1852950",
    "end": "1860809"
  },
  {
    "text": "devices registered in Active Directory you don't have a good visibility into",
    "start": "1860809",
    "end": "1865909"
  },
  {
    "text": "what what exact devices are there which users are are using what devices",
    "start": "1865909",
    "end": "1871460"
  },
  {
    "text": "and so on so that's why I created another view widget and passes and",
    "start": "1871460",
    "end": "1878950"
  },
  {
    "text": "interprets this this data from Active Directory on this line you see that this",
    "start": "1878950",
    "end": "1886190"
  },
  {
    "text": "user John Doe has five devices associated with his account he uses",
    "start": "1886190",
    "end": "1891799"
  },
  {
    "text": "Yubikey spy TN and also this golden Gate's with fingerprint readers so again",
    "start": "1891799",
    "end": "1899809"
  },
  {
    "text": "this is information retrieved from that blob from that data structure you've",
    "start": "1899809",
    "end": "1905480"
  },
  {
    "text": "seen previously so this is really good for auditing purposes and I think that",
    "start": "1905480",
    "end": "1911360"
  },
  {
    "text": "all the companies should be doing at least some basic basic auditing of these",
    "start": "1911360",
    "end": "1917240"
  },
  {
    "text": "values and also yesterday in the evening Microsoft has released its own",
    "start": "1917240",
    "end": "1923600"
  },
  {
    "text": "PowerShell module to do a very similar thing so if we we competed a little bit",
    "start": "1923600",
    "end": "1928929"
  },
  {
    "text": "with this and this module is called Windows hello for business tools and how",
    "start": "1928929",
    "end": "1936950"
  },
  {
    "text": "this module looks like it has commands for retrieval of those key credential",
    "start": "1936950",
    "end": "1942620"
  },
  {
    "text": "data and also for deleting some values for doing doing some cleanup and it's",
    "start": "1942620",
    "end": "1950090"
  },
  {
    "text": "actually pretty nice if you you can you can use it to connect to either Active Directory or to Azure Active Directory",
    "start": "1950090",
    "end": "1956330"
  },
  {
    "text": "to retrieve all those keys from there and it generates nice reports saying how",
    "start": "1956330",
    "end": "1962299"
  },
  {
    "text": "many users have these windows hello for business keys registered on them whether any of those are rockin",
    "start": "1962299",
    "end": "1969320"
  },
  {
    "text": "vulnerable whether any of those those keys are weak and whether any of those",
    "start": "1969320",
    "end": "1974900"
  },
  {
    "text": "keys are orphaned meaning they do not correspond to any device which is currently present in AD or in Azure ad",
    "start": "1974900",
    "end": "1983330"
  },
  {
    "text": "so this is again from Microsoft and it",
    "start": "1983330",
    "end": "1989000"
  },
  {
    "text": "seems to be officially supported so you can either use this module or my own DS",
    "start": "1989000",
    "end": "1994700"
  },
  {
    "text": "internals PowerShell module so to wrap",
    "start": "1994700",
    "end": "2000880"
  },
  {
    "text": "it up what recommendations should I give you what",
    "start": "2000880",
    "end": "2006460"
  },
  {
    "text": "you should remember from these from this talk well first of all this MSDS key",
    "start": "2006460",
    "end": "2012130"
  },
  {
    "text": "credentialing attribute is quite important in Active Directory and if you have Windows Server to 16 or newer",
    "start": "2012130",
    "end": "2018429"
  },
  {
    "text": "domain controllers you should be definitely looking into this this attribute so you should be auditing the changes of this attribute",
    "start": "2018429",
    "end": "2025450"
  },
  {
    "text": "most importantly on sensitive accounts on security sensitive accounts and you",
    "start": "2025450",
    "end": "2031360"
  },
  {
    "text": "should also do a one-time audit of any pre-existing values if you have any vulnerable Keys in there and you should",
    "start": "2031360",
    "end": "2038529"
  },
  {
    "text": "then delete those Keys patch those devices which correspond to go to those",
    "start": "2038529",
    "end": "2044200"
  },
  {
    "text": "keys and so on and you should definitely be faster than those attackers who might",
    "start": "2044200",
    "end": "2050608"
  },
  {
    "text": "misuse this third as you've seen at the",
    "start": "2050609",
    "end": "2056138"
  },
  {
    "text": "beginning almost no one knew this this feature and how this feature worked exactly but this does that this doesn't",
    "start": "2056139",
    "end": "2063608"
  },
  {
    "text": "mean that the attackers don't know this feature that the red teamers don't know",
    "start": "2063609",
    "end": "2069010"
  },
  {
    "text": "how this feature works so you should really keep up to date and before rolling new service new technology new",
    "start": "2069010",
    "end": "2076929"
  },
  {
    "text": "updates into your Active Directory environment you should really do your do",
    "start": "2076929",
    "end": "2082300"
  },
  {
    "text": "your work and and study those those changes and you should evaluate the security implications saying that I",
    "start": "2082300",
    "end": "2090760"
  },
  {
    "text": "really don't want to discourage you from using the windows hello for business functionality because I think it is it",
    "start": "2090760",
    "end": "2098079"
  },
  {
    "text": "is a really good technology interesting technology a hundred times better than passwords and it will apparently one day",
    "start": "2098079",
    "end": "2106930"
  },
  {
    "text": "replace passwords at least in in the Microsoft world in in Microsoft based",
    "start": "2106930",
    "end": "2113520"
  },
  {
    "text": "infrastructure so I really recommend using Windows hello for business just",
    "start": "2113520",
    "end": "2119079"
  },
  {
    "text": "take those precautions I will be demoing",
    "start": "2119079",
    "end": "2124450"
  },
  {
    "text": "the des internal spatial module tomorrow so you'll see some more functionality so",
    "start": "2124450",
    "end": "2130569"
  },
  {
    "text": "please come also my colleagues Paul and Mike will be demoing the secure forensic",
    "start": "2130569",
    "end": "2136839"
  },
  {
    "text": "her tools and I think that they will also be quite interesting so that's it",
    "start": "2136839",
    "end": "2146589"
  },
  {
    "text": "do have any questions yeah do you have",
    "start": "2146589",
    "end": "2158979"
  },
  {
    "text": "any kind of web link or something where we can find all your links with your",
    "start": "2158979",
    "end": "2164049"
  },
  {
    "text": "powershell scripts on one place okay that's a good question whether I have a",
    "start": "2164049",
    "end": "2170499"
  },
  {
    "text": "link well I don't have any any short link but you can you can google me and I",
    "start": "2170499",
    "end": "2176859"
  },
  {
    "text": "think that on the web of black hats the materials so we'll be linked but the",
    "start": "2176859",
    "end": "2182349"
  },
  {
    "text": "entire PowerShell module list open sourced on github so you can you can look up my github page the DSA internals",
    "start": "2182349",
    "end": "2189819"
  },
  {
    "text": "PowerShell module there and some or probably in an hour I will publish the",
    "start": "2189819",
    "end": "2197049"
  },
  {
    "text": "newest version of this module which already can't contains all the functionality would you've seen I was",
    "start": "2197049",
    "end": "2203200"
  },
  {
    "text": "just trying to postpone publishing the newest version of the module before Microsoft released that's security",
    "start": "2203200",
    "end": "2210479"
  },
  {
    "text": "advisory and if you are interested in those specific things regarding that get",
    "start": "2210479",
    "end": "2218979"
  },
  {
    "text": "Ad key credential commandlets then you can look up the documentation I really",
    "start": "2218979",
    "end": "2224890"
  },
  {
    "text": "work hard on the on the documentation part although I really hate creating documentation and yeah this get Ad key",
    "start": "2224890",
    "end": "2233979"
  },
  {
    "text": "credential command has some examples I've written seven different examples",
    "start": "2233979",
    "end": "2240400"
  },
  {
    "text": "and I think all the things I demoed today and you what you've seen on those slides are also contained on these",
    "start": "2240400",
    "end": "2248009"
  },
  {
    "text": "examples so we can grab it and you can play with your Active Directory and try",
    "start": "2248009",
    "end": "2253690"
  },
  {
    "text": "those things out okay another question",
    "start": "2253690",
    "end": "2259380"
  },
  {
    "text": "hi hi is there any tool which you can recommend to make sure the public and",
    "start": "2259380",
    "end": "2266109"
  },
  {
    "text": "private key is not weak considering that Roco vulnerability is one of the weaknesses which you spoke",
    "start": "2266109",
    "end": "2275069"
  },
  {
    "text": "yeah the question is how to prevent",
    "start": "2275069",
    "end": "2280319"
  },
  {
    "text": "those weak keys being generated well as already said you need to patch a TPM",
    "start": "2280319",
    "end": "2288069"
  },
  {
    "text": "module TPM modules on or on all your comparator corporate computers well if",
    "start": "2288069",
    "end": "2293380"
  },
  {
    "text": "you have buyout scenario with those devices or not under your controlled and then you have no control over those",
    "start": "2293380",
    "end": "2299020"
  },
  {
    "text": "devices but when you configure ad FS Active Directory Federation services",
    "start": "2299020",
    "end": "2304540"
  },
  {
    "text": "you've seen that undocumented PowerShell parameter you can tell it to deny any",
    "start": "2304540",
    "end": "2313450"
  },
  {
    "text": "new device registrations which originate from devices that have weak is actually",
    "start": "2313450",
    "end": "2318760"
  },
  {
    "text": "a DFS itself tries to do some heuristics to tell whether that key would is",
    "start": "2318760",
    "end": "2324339"
  },
  {
    "text": "currently being registered is vulnerable or not so definitely patch your ad FS",
    "start": "2324339",
    "end": "2329710"
  },
  {
    "text": "and turn on that feature and if you are collecting events from computer then you",
    "start": "2329710",
    "end": "2335200"
  },
  {
    "text": "can look that event ID in might slides and you should create a rule in your cm",
    "start": "2335200",
    "end": "2342790"
  },
  {
    "text": "or another security monitoring system and look for those IDs that weak keys",
    "start": "2342790",
    "end": "2348220"
  },
  {
    "text": "are generated on your computers so these are these are the things you could do about it",
    "start": "2348220",
    "end": "2353230"
  },
  {
    "text": "was it the answer to your question Thanks ok any other questions",
    "start": "2353230",
    "end": "2360390"
  },
  {
    "text": "okay so so that is that's it I hope we'll meet tomorrow in the Arsenal",
    "start": "2366250",
    "end": "2372710"
  },
  {
    "text": "section if you have Twitter and you'd like to follow me then you can follow me at and draft nitor and yeah thank you",
    "start": "2372710",
    "end": "2381110"
  },
  {
    "text": "for your attention goodbye and see you next time [Applause]",
    "start": "2381110",
    "end": "2387420"
  }
]