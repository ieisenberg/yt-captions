[
  {
    "start": "0",
    "end": "19000"
  },
  {
    "text": "[Music]",
    "start": "860",
    "end": "9040"
  },
  {
    "text": "hello and thank you for tuning in to this spiritual talk my name is sagi dolce i'm the vp of",
    "start": "9040",
    "end": "15519"
  },
  {
    "text": "research here at zero networks um",
    "start": "15519",
    "end": "20640"
  },
  {
    "start": "19000",
    "end": "19000"
  },
  {
    "text": "i've been doing defensive research for the past 10 plus years now in areas such as",
    "start": "20640",
    "end": "26320"
  },
  {
    "text": "lateral movement identity access and several others",
    "start": "26320",
    "end": "31679"
  },
  {
    "text": "i often write and produce some open source tools you can check them out",
    "start": "31679",
    "end": "36719"
  },
  {
    "text": "at our github i've been fortunate enough to speak at previous blackett events and awasp and a",
    "start": "36719",
    "end": "43200"
  },
  {
    "text": "few other chapters and of course you can check me out on twitter uh if you want to dm me about",
    "start": "43200",
    "end": "49520"
  },
  {
    "text": "this session or anything else so enough about me let's dive into the",
    "start": "49520",
    "end": "54960"
  },
  {
    "text": "actual talk uh today we're gonna spend a lot of time talking about rpc",
    "start": "54960",
    "end": "61120"
  },
  {
    "text": "uh so before i say why this talk is important or maybe why another rpc talk",
    "start": "61120",
    "end": "67600"
  },
  {
    "text": "i think we need a little bit of introduction about our pc so we all speak the same language",
    "start": "67600",
    "end": "75039"
  },
  {
    "text": "and then i'll dive deeper on why rpc is so important",
    "start": "75280",
    "end": "81040"
  },
  {
    "text": "one hint is of course heavily utilized by it administrators have been utilized by ransomware and",
    "start": "81040",
    "end": "87360"
  },
  {
    "text": "other attackers um and the problem of course with uh our",
    "start": "87360",
    "end": "93280"
  },
  {
    "text": "rcp is that's the third thing that i'm going to touch upon is the native protection that you have",
    "start": "93280",
    "end": "99360"
  },
  {
    "text": "in windows environment a little bit painful and they don't quite do the job",
    "start": "99360",
    "end": "105439"
  },
  {
    "text": "and this is part of the reason why we wrote the rpc firewall and we'll dive deeper into the tool itself show you how",
    "start": "105439",
    "end": "112159"
  },
  {
    "text": "it works and we'll end up with a lot of",
    "start": "112159",
    "end": "117439"
  },
  {
    "text": "practical examples show you how you can put them use this firewall for research or your",
    "start": "117439",
    "end": "123680"
  },
  {
    "text": "production environment and so on and short summary question time",
    "start": "123680",
    "end": "129200"
  },
  {
    "text": "so let's start so rpc of course when i say rpc i mean",
    "start": "129200",
    "end": "134400"
  },
  {
    "start": "133000",
    "end": "133000"
  },
  {
    "text": "remote procedure call a very i think a basic or a simple concept i",
    "start": "134400",
    "end": "140640"
  },
  {
    "text": "think anyone can relate to when a client want to call a function on a server they can do it so through",
    "start": "140640",
    "end": "148400"
  },
  {
    "text": "rpc the server can be in the same process it can be a different process or it can be on a different host",
    "start": "148400",
    "end": "155840"
  },
  {
    "text": "altogether of course if it's on a different host this is a remote rpc call",
    "start": "155840",
    "end": "162480"
  },
  {
    "text": "if it's a local it usually uses a local lpc lpc",
    "start": "162480",
    "end": "167680"
  },
  {
    "text": "ports if it's remote normally or most commonly it's done over tcp or smb and this is",
    "start": "167680",
    "end": "175120"
  },
  {
    "text": "what we're most interested in uh there's a bunch of other transport which are linked here",
    "start": "175120",
    "end": "181760"
  },
  {
    "text": "in the below so some of the terminology of course",
    "start": "181760",
    "end": "186879"
  },
  {
    "start": "184000",
    "end": "184000"
  },
  {
    "text": "there's a lot of information about rpc we're not going to get into uh everything but the basic concept that we",
    "start": "186879",
    "end": "193599"
  },
  {
    "text": "need to understand is uh the operation number the op numb this basically identifies the function",
    "start": "193599",
    "end": "199599"
  },
  {
    "text": "that you want to call we have the uuid the universal universal unique identifier",
    "start": "199599",
    "end": "207680"
  },
  {
    "text": "and that one identifies the rpc interface that you uh want to",
    "start": "207680",
    "end": "213760"
  },
  {
    "text": "contact and the endpoint that's basically the internet uh the transport that you're writing over it could be smb",
    "start": "213760",
    "end": "220799"
  },
  {
    "text": "it could be tcp a specific pipe over smb or a specific board or tcp and so forth",
    "start": "220799",
    "end": "227519"
  },
  {
    "text": "uh maybe to make this example more tangible uh for example you could look at this",
    "start": "227519",
    "end": "234000"
  },
  {
    "text": "uh protocol the tax task schedule protocol um so this is one example of an rpc",
    "start": "234000",
    "end": "241760"
  },
  {
    "text": "protocol among many and if you go to the standards assignment you can see there are",
    "start": "241760",
    "end": "246799"
  },
  {
    "text": "different uuids that describe various versions of",
    "start": "246799",
    "end": "252560"
  },
  {
    "text": "this protocol uh for example this is a well-known end point that you can contact this protocol",
    "start": "252560",
    "end": "258880"
  },
  {
    "text": "so if you want to talk to the task scheduler of the name pipe you'll use the at svc",
    "start": "258880",
    "end": "266080"
  },
  {
    "text": "pipe name and when i look at the actual details of the protocol",
    "start": "266080",
    "end": "272240"
  },
  {
    "text": "let's take this for example so you see different",
    "start": "274240",
    "end": "279360"
  },
  {
    "text": "functions and each function has their own up now so",
    "start": "279360",
    "end": "284639"
  },
  {
    "text": "that's just to make this a little bit more tangible now in windows environment",
    "start": "284639",
    "end": "290160"
  },
  {
    "start": "286000",
    "end": "286000"
  },
  {
    "text": "which is the focus of the stock the rpc rt4 dll that's the library also that the",
    "start": "290160",
    "end": "297040"
  },
  {
    "text": "clients the rpc clients are using their servers are using and it's basically in charge of",
    "start": "297040",
    "end": "302320"
  },
  {
    "text": "doing everything all they have is lifting and of course like i said before",
    "start": "302320",
    "end": "307520"
  },
  {
    "start": "306000",
    "end": "306000"
  },
  {
    "text": "there's a lot of resources that you can use to read and understand more what rpc",
    "start": "307520",
    "end": "313440"
  },
  {
    "text": "is and dive a little bit deeper this is some of the resources that i've used to understand myself and of course",
    "start": "313440",
    "end": "320000"
  },
  {
    "text": "some of those are referenced later here in this presentation okay so now that we have",
    "start": "320000",
    "end": "326639"
  },
  {
    "text": "our basic uh fundamentals of rpc 101 why is this talk important",
    "start": "326639",
    "end": "334160"
  },
  {
    "text": "and i hadn't hinted before about this and one of the reason is that",
    "start": "334160",
    "end": "339919"
  },
  {
    "text": "maybe you don't realize that maybe you do our pc is simply uh everywhere when",
    "start": "339919",
    "end": "345840"
  },
  {
    "text": "you're discussing a windows environment almost any service that you can think of probably exposes",
    "start": "345840",
    "end": "353680"
  },
  {
    "text": "one or many rpc interfaces which exposes tens or",
    "start": "353680",
    "end": "359680"
  },
  {
    "text": "maybe hundreds or even rpc functions and they're used for everything for",
    "start": "359680",
    "end": "367280"
  },
  {
    "text": "from creating scheduled tasks just like we saw printing authentication",
    "start": "367280",
    "end": "373360"
  },
  {
    "text": "uh directories services live replication uh remote management wmi dcom and so on",
    "start": "373360",
    "end": "379919"
  },
  {
    "text": "and so forth they're so prevalent that of course almost any uh",
    "start": "379919",
    "end": "385840"
  },
  {
    "text": "attacker group ransomware or off-the-shelf malware uses usually one",
    "start": "385840",
    "end": "391280"
  },
  {
    "text": "or another form of rpc some common examples that we see on the right of",
    "start": "391280",
    "end": "396720"
  },
  {
    "text": "course you can use schedule test for lateral movement dc sync to dump credentials",
    "start": "396720",
    "end": "403440"
  },
  {
    "text": "samr another protocol you can use to read or write from the domain controller",
    "start": "403440",
    "end": "409039"
  },
  {
    "text": "other uh lovable tools that we all know of ps exec remote decode and so on and so forth",
    "start": "409039",
    "end": "415440"
  },
  {
    "text": "shower pound used by bloodhound for reconnaissance corner shot",
    "start": "415440",
    "end": "420880"
  },
  {
    "text": "also for constant and the list goes on and on um i just want to highlight the these",
    "start": "420880",
    "end": "427599"
  },
  {
    "text": "top three because i'm going to use uh these attacks over and over in demos to to",
    "start": "427599",
    "end": "433599"
  },
  {
    "text": "show how the rpc file works and make a few points about the native protections",
    "start": "433599",
    "end": "439759"
  },
  {
    "text": "um and of course i've said the word demo so let's start",
    "start": "439759",
    "end": "445199"
  },
  {
    "start": "441000",
    "end": "441000"
  },
  {
    "text": "off with the demo and it's going to be a very quick demo",
    "start": "445199",
    "end": "451280"
  },
  {
    "text": "uh it's not anything new but just to show if you haven't really understood it yet that some of the very",
    "start": "451280",
    "end": "458720"
  },
  {
    "text": "common attack that we all know about all rely on rpc",
    "start": "458720",
    "end": "463759"
  },
  {
    "text": "so this is the setup that we're going to see throughout this presentation we have the target on the left it's a domain controller we have on the right the",
    "start": "463759",
    "end": "470720"
  },
  {
    "text": "client which does the attacking and it's running i'm going to run a bunch of attacks the ps exec",
    "start": "470720",
    "end": "476400"
  },
  {
    "text": "which produces a calculator because hackers love arithmetics for some reason",
    "start": "476400",
    "end": "483199"
  },
  {
    "text": "um test scheduler different kind of rpc protocol same type of result in this case again",
    "start": "483199",
    "end": "490479"
  },
  {
    "text": "we're gonna get the evil twin colic attack",
    "start": "490479",
    "end": "495520"
  },
  {
    "text": "mini cuts of course you can't talk about security and domains without saying mimikats",
    "start": "495520",
    "end": "500560"
  },
  {
    "text": "and this will simply read the kerberos tgt uh password hash the nth ntlm hash",
    "start": "500560",
    "end": "507919"
  },
  {
    "text": "directly from the domain controller again over rpc",
    "start": "507919",
    "end": "513440"
  },
  {
    "text": "and finally i'm going to do a couple of more attacks using the smr",
    "start": "513440",
    "end": "518839"
  },
  {
    "text": "protocol uh the fourth the first one is a very common procedure that is being called in a domain uh which can be used",
    "start": "518839",
    "end": "525920"
  },
  {
    "text": "for reconnaissance just to collect users uh and some other properties from the",
    "start": "525920",
    "end": "531120"
  },
  {
    "text": "domain controller you can do it over rpc and the other operation is more intrusive it's the right operation i'm",
    "start": "531120",
    "end": "536640"
  },
  {
    "text": "actually creating a fake computer inside the domain controller so once i",
    "start": "536640",
    "end": "542720"
  },
  {
    "text": "refresh you can see i have the fake name it's a fake computer that i've created so in a matter of about one minute we",
    "start": "542720",
    "end": "549360"
  },
  {
    "text": "saw five different attacks uh all of them utilize rpc um",
    "start": "549360",
    "end": "555839"
  },
  {
    "text": "again just to drive the point that it's a thing it's a thing that happens it happens a lot",
    "start": "555839",
    "end": "562240"
  },
  {
    "start": "561000",
    "end": "561000"
  },
  {
    "text": "so what is it about rpc because apart from being so so much popular and so heavily used if",
    "start": "562240",
    "end": "569839"
  },
  {
    "text": "you look at it as opposed to other protocols which are could be are very heavily used by administrators such",
    "start": "569839",
    "end": "576320"
  },
  {
    "text": "as rdp or windows management uh there can't be uh",
    "start": "576320",
    "end": "582080"
  },
  {
    "text": "this one can be easily firewalled but rpc can't be easily fireable uh just",
    "start": "582080",
    "end": "587200"
  },
  {
    "text": "because of how it's built it's been also for tcp or smd or other transports",
    "start": "587200",
    "end": "592480"
  },
  {
    "text": "the name pipe for the port are not well known in advanced always so you can't block a specific port or",
    "start": "592480",
    "end": "598959"
  },
  {
    "text": "disable a specific pipe and sometimes you can do it just like",
    "start": "598959",
    "end": "604160"
  },
  {
    "text": "we've seen in domain controller your domain controller rpc services have to be open",
    "start": "604160",
    "end": "610720"
  },
  {
    "text": "to almost any user because that's how they domain functions otherwise user won't be able to authenticate",
    "start": "610720",
    "end": "616959"
  },
  {
    "text": "your domain wouldn't work so not only you can block it it has to be",
    "start": "616959",
    "end": "623040"
  },
  {
    "start": "621000",
    "end": "621000"
  },
  {
    "text": "you can block it has to be open for the main function so to sum up",
    "start": "623040",
    "end": "628720"
  },
  {
    "text": "very heavily used your attack surface or any given host can easily be 2 000 plus",
    "start": "628720",
    "end": "634320"
  },
  {
    "text": "rpc calls uh potentially exposed to attackers we just saw there are many different",
    "start": "634320",
    "end": "640880"
  },
  {
    "text": "types of attacks that utilize rpc can be firewall has to be open",
    "start": "640880",
    "end": "646560"
  },
  {
    "text": "uh and that's why it's so interesting um so what you as a defender can do uh some",
    "start": "646560",
    "end": "653279"
  },
  {
    "text": "i guess some of you already know about rpc and some of the issues that it gives you uh",
    "start": "653279",
    "end": "658399"
  },
  {
    "text": "during pen tests or or others and the problem with trying out native protections is you",
    "start": "658399",
    "end": "666079"
  },
  {
    "start": "662000",
    "end": "662000"
  },
  {
    "text": "find out they're very much lacking uh of course the first thing that you're trying to look for is is there any",
    "start": "666079",
    "end": "672160"
  },
  {
    "text": "windows event that i can use and turns out there isn't one according to microsoft themselves",
    "start": "672160",
    "end": "679760"
  },
  {
    "text": "it looks like they planned on the event but the event never occurs",
    "start": "679760",
    "end": "685839"
  },
  {
    "text": "so there is no group policy or a flag or registry settings that you can turn on and get native or pc logs that you can",
    "start": "686079",
    "end": "693839"
  },
  {
    "text": "consume and start working on them you have another option you can use the event tracing for windows a little bit",
    "start": "693839",
    "end": "702000"
  },
  {
    "start": "697000",
    "end": "697000"
  },
  {
    "text": "lower level a little bit more complex um but even if you do that you still get",
    "start": "702000",
    "end": "708800"
  },
  {
    "text": "information that is very much limited for example if we look at this event log",
    "start": "708800",
    "end": "714720"
  },
  {
    "text": "i hope you can see uh you know very basic things about the rpc call you know",
    "start": "714720",
    "end": "719760"
  },
  {
    "text": "the interface id you know the optimum you know the endpoints and that's basically it where did this rpc come",
    "start": "719760",
    "end": "727360"
  },
  {
    "text": "from uh was it locally over tcp or named pipe or smb",
    "start": "727360",
    "end": "732480"
  },
  {
    "text": "was it remotely uh we don't really know who made this call is it a anonymous is it a another user",
    "start": "732480",
    "end": "740399"
  },
  {
    "text": "if so which user it is we don't know uh the other problem is that those trace",
    "start": "740399",
    "end": "746240"
  },
  {
    "text": "uh events produce a lot of logs uh we're talking about roughly two",
    "start": "746240",
    "end": "751680"
  },
  {
    "text": "million uh events per second because that includes the remote rpc and also",
    "start": "751680",
    "end": "756800"
  },
  {
    "text": "the local rpc so if you run even a medium environment that's a",
    "start": "756800",
    "end": "764160"
  },
  {
    "text": "lot of information to consume and filter out and even after you do it doesn't give you everything that you need",
    "start": "764160",
    "end": "770480"
  },
  {
    "start": "770000",
    "end": "770000"
  },
  {
    "text": "if you still want to use this information for hunting uh that's also pretty complex for",
    "start": "770480",
    "end": "776720"
  },
  {
    "text": "example this information talks about detecting just one",
    "start": "776720",
    "end": "782240"
  },
  {
    "text": "form of lateral movement over rpc the psx that we've seen in the previous demo",
    "start": "782240",
    "end": "788240"
  },
  {
    "text": "um and that require a lot of logs you need to go to the clients collect the rpc logs and the process",
    "start": "788240",
    "end": "795200"
  },
  {
    "text": "creation logs you need to go to the server take some logs from there you need to put your uh",
    "start": "795200",
    "end": "803120"
  },
  {
    "text": "sensors on the network click that logs from there you need to create all this logic",
    "start": "803120",
    "end": "808240"
  },
  {
    "text": "to create the correlations between those logs and after you do that maybe you'll get a detection for one",
    "start": "808240",
    "end": "813440"
  },
  {
    "text": "type of lateral movement so that's a lot of work and",
    "start": "813440",
    "end": "818639"
  },
  {
    "text": "it's very hard to do and very hard to scale and of course it has its drawbacks one",
    "start": "818639",
    "end": "824079"
  },
  {
    "text": "what happens if the client is custom not a native rpc client so you don't get those logs",
    "start": "824079",
    "end": "830160"
  },
  {
    "text": "or the client is compromised maybe you don't get any logs or false logs and so on",
    "start": "830160",
    "end": "836560"
  },
  {
    "start": "835000",
    "end": "835000"
  },
  {
    "text": "so what happens if you can't detect rpc with the logs can you still block it so",
    "start": "836560",
    "end": "841760"
  },
  {
    "text": "if you ask me those this question a few months ago i would say apparently apparently not but i was wrong because",
    "start": "841760",
    "end": "848959"
  },
  {
    "text": "apparently yes um i found this out through a tweet from benjamin delphi and i want to thank of",
    "start": "848959",
    "end": "854800"
  },
  {
    "text": "course craig uh kirby for letting most of the community know who probably",
    "start": "854800",
    "end": "860720"
  },
  {
    "text": "weren't aware that there are instance things rpc filters uh but it's a thing uh the windows",
    "start": "860720",
    "end": "867920"
  },
  {
    "text": "filtering platform actually supports them and the rpc runtime can",
    "start": "867920",
    "end": "873360"
  },
  {
    "text": "query or load those filters from the firewall",
    "start": "873360",
    "end": "879600"
  },
  {
    "start": "879000",
    "end": "879000"
  },
  {
    "text": "and they have a lot of options apparently that you can use",
    "start": "880480",
    "end": "885760"
  },
  {
    "text": "many of them i i would say they're not that practical like the image name or specific rpc flags you",
    "start": "885760",
    "end": "893040"
  },
  {
    "text": "probably won't need to use them on the databases the interface uad is a practical one you",
    "start": "893040",
    "end": "899279"
  },
  {
    "text": "can actually use them to completely block or allow whole interfaces",
    "start": "899279",
    "end": "904959"
  },
  {
    "text": "but there are some issues if you want to create filters based on the remote address for example which can be very",
    "start": "904959",
    "end": "911440"
  },
  {
    "text": "useful for example in the case of this sync you can't because it's not working it's",
    "start": "911440",
    "end": "917839"
  },
  {
    "text": "actually an issue we're working on with microsoft to try and resolve",
    "start": "917839",
    "end": "923920"
  },
  {
    "text": "another thing is that if you want to filter out a specific function just like we've seen",
    "start": "923920",
    "end": "929279"
  },
  {
    "text": "some operations like read operation from the sam database are common they happen a lot maybe they're",
    "start": "929279",
    "end": "935360"
  },
  {
    "text": "okay some operations like writing into the database less common maybe you need to",
    "start": "935360",
    "end": "940560"
  },
  {
    "text": "check them out it doesn't have that granularity",
    "start": "940560",
    "end": "946399"
  },
  {
    "text": "um so what i said earlier let's just see that again in a in a quick demo we're going",
    "start": "946399",
    "end": "952480"
  },
  {
    "text": "to see [Music] how the dc sync attack can be protected",
    "start": "952480",
    "end": "959279"
  },
  {
    "text": "with using the rpc filters and show you how the rpc filters work but of course once it does it breaks",
    "start": "959279",
    "end": "966160"
  },
  {
    "text": "your environment so this is the attack we've seen before and it's the same setup that we've seen before i would",
    "start": "966160",
    "end": "972399"
  },
  {
    "text": "just run the dc sync attack and of course nothing nothing new it works just like it did last time",
    "start": "972399",
    "end": "979199"
  },
  {
    "text": "this time i'm going to use those rc filters now you can use them with the windows api so they have",
    "start": "979199",
    "end": "986320"
  },
  {
    "text": "an api that you can use to create those rpc filters you can use them in this example i'm using the net sh",
    "start": "986320",
    "end": "992800"
  },
  {
    "text": "command and i'm creating a rule the rule is a block rule uh it's going to use the",
    "start": "992800",
    "end": "999440"
  },
  {
    "text": "uuid of the directory application to block and once i apply this rule i will try to",
    "start": "999440",
    "end": "1008000"
  },
  {
    "text": "run this attack again and of course unsurprisingly this attack will be blocked",
    "start": "1008000",
    "end": "1014240"
  },
  {
    "text": "so you do have that option so once around this we'll get the error file which means access denied",
    "start": "1014240",
    "end": "1021040"
  },
  {
    "text": "and the attack was blocked it worked of course but the patient died you know the",
    "start": "1021040",
    "end": "1026240"
  },
  {
    "text": "operation worked you blocked the rpc calls but you also block your",
    "start": "1026240",
    "end": "1031360"
  },
  {
    "text": "your domain possibly so what can one do when",
    "start": "1031360",
    "end": "1037199"
  },
  {
    "text": "native logs are not that non-existent tracing logs are complex filters as bugs",
    "start": "1037199",
    "end": "1045038"
  },
  {
    "text": "of course build your own rpc of course you don't have to build your own pc because we already did",
    "start": "1045039",
    "end": "1051919"
  },
  {
    "text": "so let's talk about the rpc firewall you can find it in our",
    "start": "1051919",
    "end": "1057200"
  },
  {
    "text": "git repository um of course welcome questions if you have feature",
    "start": "1057200",
    "end": "1063520"
  },
  {
    "text": "requests if you have any issues we'd like to know about it so you can contact us and",
    "start": "1063520",
    "end": "1069200"
  },
  {
    "text": "should be easy enough to download read the code and contribute",
    "start": "1069200",
    "end": "1074320"
  },
  {
    "text": "so we also encourage that so the goals of",
    "start": "1074320",
    "end": "1079600"
  },
  {
    "start": "1077000",
    "end": "1077000"
  },
  {
    "text": "writing the rpc firewall were pretty simple you wanted something to",
    "start": "1079600",
    "end": "1085039"
  },
  {
    "text": "work alongside the rpc filters so you can use them as complementary",
    "start": "1085039",
    "end": "1090799"
  },
  {
    "text": "tools sometimes you can't use the filters as we just saw there are other cases where",
    "start": "1090799",
    "end": "1097440"
  },
  {
    "text": "you may you may want to use the rpc filters instead that i perceive instead of the",
    "start": "1097440",
    "end": "1102960"
  },
  {
    "text": "rpc firewall so they work side by side uh and they give you very usable audits",
    "start": "1102960",
    "end": "1109840"
  },
  {
    "text": "and filtering i like the native ones um it gives you native logging so it",
    "start": "1109840",
    "end": "1116320"
  },
  {
    "text": "produces the windows event logs you can take those you can forward them to your sim it",
    "start": "1116320",
    "end": "1122320"
  },
  {
    "text": "doesn't produce millions of logs it produces just enough logs and you can tell it which logs to",
    "start": "1122320",
    "end": "1127840"
  },
  {
    "text": "produce can be useful for research you can put it on your server run a few attacks",
    "start": "1127840",
    "end": "1134480"
  },
  {
    "text": "see how it looks like in rpc understand how it works and so on and you can use it in production uh you",
    "start": "1134480",
    "end": "1141200"
  },
  {
    "text": "you can put in one or more or all your rpc servers",
    "start": "1141200",
    "end": "1146720"
  },
  {
    "text": "and configure it to block any unwanted activity so before we",
    "start": "1146720",
    "end": "1152559"
  },
  {
    "text": "dive into the firewall itself explain what it does i think it's important to do a quick demo",
    "start": "1152559",
    "end": "1158720"
  },
  {
    "text": "um just to give you a feel of how it looks like so here we have an rpc client in rpc server",
    "start": "1158720",
    "end": "1164960"
  },
  {
    "text": "now notice that the uh the direction is mixed on the bottom it's actually the server the client so",
    "start": "1164960",
    "end": "1171280"
  },
  {
    "text": "the server is listing on the name pipe and the client has two functions that they can call",
    "start": "1171280",
    "end": "1177520"
  },
  {
    "text": "over on the server one option is to just simply send text messages so",
    "start": "1177520",
    "end": "1183679"
  },
  {
    "text": "things that will be appropriate for this london event would be messages like t i would guess",
    "start": "1183679",
    "end": "1191679"
  },
  {
    "text": "and once they write these messages the server writes them another more risky thing",
    "start": "1191679",
    "end": "1197360"
  },
  {
    "text": "that the client can do is break and exit or brexit for short which will terminate",
    "start": "1197360",
    "end": "1202480"
  },
  {
    "text": "the server and on the right on the top we have the rpc file uh it's a very simple command",
    "start": "1202480",
    "end": "1208559"
  },
  {
    "text": "line tool uh and you can use it uh in this example would simply apply the firewall to this",
    "start": "1208559",
    "end": "1215760"
  },
  {
    "text": "server process so once i do that uh let's look what it",
    "start": "1215760",
    "end": "1221200"
  },
  {
    "text": "should do by looking at the configuration because it takes a configuration file and it allows",
    "start": "1221200",
    "end": "1226400"
  },
  {
    "text": "everything so we should expect everything to work just like it did before so when i send a message like a queen",
    "start": "1226400",
    "end": "1234720"
  },
  {
    "text": "again very appropriate message server writes it on the bottom",
    "start": "1234720",
    "end": "1239919"
  },
  {
    "text": "and once i block it first before i after i change the configuration i need to",
    "start": "1239919",
    "end": "1245200"
  },
  {
    "text": "update the file itself so it's the update command now as you would expect the client tries",
    "start": "1245200",
    "end": "1252240"
  },
  {
    "text": "to send more messages and of course all the messages are being blocked and we get uh",
    "start": "1252240",
    "end": "1258159"
  },
  {
    "text": "an error number five again it's the access denied error and i want to do something more",
    "start": "1258159",
    "end": "1265039"
  },
  {
    "text": "sophisticated or more granular i want to allow only messages",
    "start": "1265039",
    "end": "1271440"
  },
  {
    "text": "and i want to block all the break and exit so clients can write messages to the",
    "start": "1271440",
    "end": "1278080"
  },
  {
    "text": "server they can't shut the servers down and i want to have this granularity again i need to update and now as you",
    "start": "1278080",
    "end": "1284720"
  },
  {
    "text": "would expect once i write messages they get written inside the server no problem",
    "start": "1284720",
    "end": "1291840"
  },
  {
    "text": "um i will write another messages one more so this is the last one and now",
    "start": "1291840",
    "end": "1298400"
  },
  {
    "text": "when the client tries to actually break and exit it it gets blocked and another last",
    "start": "1298400",
    "end": "1304720"
  },
  {
    "text": "feature that i want to show you you can do unprotect this will remove the firewall from any process",
    "start": "1304720",
    "end": "1311200"
  },
  {
    "text": "that it's being protected on and now the client can send messages and they can also brexit",
    "start": "1311200",
    "end": "1318400"
  },
  {
    "text": "because there is no firewall nothing is blocking it so this is just we saw the basic",
    "start": "1318400",
    "end": "1324000"
  },
  {
    "start": "1322000",
    "end": "1322000"
  },
  {
    "text": "operation of the rpc firewall um the rpc file itself has three components",
    "start": "1324000",
    "end": "1331520"
  },
  {
    "start": "1328000",
    "end": "1328000"
  },
  {
    "text": "uh the firewall dealer itself uh this is what does all the heavy",
    "start": "1331520",
    "end": "1336720"
  },
  {
    "text": "lifting this one hooks a specific function inside the rpc runtime um i won't go into too much detail about",
    "start": "1336720",
    "end": "1344799"
  },
  {
    "text": "this because of of time constraints uh you can read about it more in the git documentation or",
    "start": "1344799",
    "end": "1352960"
  },
  {
    "text": "or the code itself but that's what it basically does it hooks specific function collects",
    "start": "1352960",
    "end": "1358080"
  },
  {
    "text": "information about the function that makes the decision should this be blocked or should this be allowed",
    "start": "1358080",
    "end": "1365200"
  },
  {
    "text": "we have the rpc manager this is the tool that we just saw it does the controlling",
    "start": "1365200",
    "end": "1371440"
  },
  {
    "text": "installation on the rpc5 will uninstall protect specific processes or all processes and so on and we have the rpc",
    "start": "1371440",
    "end": "1378720"
  },
  {
    "text": "messages this this is the dll that actually formats um",
    "start": "1378720",
    "end": "1383840"
  },
  {
    "text": "the the messages to be written to the event log so the rpc firewall just like we",
    "start": "1383840",
    "end": "1390559"
  },
  {
    "text": "mentioned it extracts a lot of information that is useful from the rpc call itself",
    "start": "1390559",
    "end": "1398000"
  },
  {
    "text": "the uid and the op num which interface which function was called the source address where it came",
    "start": "1398000",
    "end": "1404720"
  },
  {
    "text": "from which is crucial um the identity of the client if there is one um so if i find it authenticated",
    "start": "1404720",
    "end": "1412320"
  },
  {
    "text": "i should see that identity uh the process of course hosting the server uh as a side note",
    "start": "1412320",
    "end": "1418880"
  },
  {
    "text": "using pretty much the same mechanism you can also understand if it's a local call of rpc",
    "start": "1418880",
    "end": "1424720"
  },
  {
    "text": "because we're discussing remote calls if it's a local call you know the source uh",
    "start": "1424720",
    "end": "1430000"
  },
  {
    "text": "process id that made that call but let's i just want to mention this let's out of scope for",
    "start": "1430000",
    "end": "1436400"
  },
  {
    "text": "this discussion and the log that is being produced is",
    "start": "1436400",
    "end": "1442559"
  },
  {
    "start": "1438000",
    "end": "1438000"
  },
  {
    "text": "i would say much more usable uh we know which process uh received uh",
    "start": "1442559",
    "end": "1447840"
  },
  {
    "text": "the rpc call uh we you can also see here by the way the function that we hooked so you have",
    "start": "1447840",
    "end": "1453760"
  },
  {
    "text": "the name of the function in this event log um we get the network information like",
    "start": "1453760",
    "end": "1460640"
  },
  {
    "text": "which endpoint was used uh what was the port or named pipe and we have the",
    "start": "1460640",
    "end": "1465840"
  },
  {
    "text": "source network address so we know exactly where this call came from which is crucial",
    "start": "1465840",
    "end": "1471360"
  },
  {
    "text": "we have of course the information about the rpc the op number and the uid and we have the subject we know who made",
    "start": "1471360",
    "end": "1477200"
  },
  {
    "text": "this rpc call so we have uh i would say enough information to make it this this is a decision",
    "start": "1477200",
    "end": "1484320"
  },
  {
    "text": "if this is a good call or a bad call um also if you're interested you can use",
    "start": "1484320",
    "end": "1489760"
  },
  {
    "start": "1487000",
    "end": "1487000"
  },
  {
    "text": "some uh debug logs that write some debug information and gives you a little bit more information about uh our other rpc",
    "start": "1489760",
    "end": "1497120"
  },
  {
    "text": "interfaces inside the servers you can understand more the logic of the",
    "start": "1497120",
    "end": "1502159"
  },
  {
    "text": "rpc firewall if you want to debug something or understand this as a little bit deeper level",
    "start": "1502159",
    "end": "1509360"
  },
  {
    "start": "1508000",
    "end": "1508000"
  },
  {
    "text": "and let's talk about the manager itself um i've shown some of these commands i have the install uninstall",
    "start": "1509360",
    "end": "1516640"
  },
  {
    "text": "pretty self-explanatory the install basically dumps some dlls inside the system 32",
    "start": "1516640",
    "end": "1524960"
  },
  {
    "text": "the messages in the rpc firewall that they need to use they configure the event log and the uninstall of course",
    "start": "1524960",
    "end": "1530720"
  },
  {
    "text": "does the opposite is the event log it deletes your dlls and then you can protect specific",
    "start": "1530720",
    "end": "1537360"
  },
  {
    "text": "services or all services based on their name based on their pits and you can unprotect if you want to remove the",
    "start": "1537360",
    "end": "1544000"
  },
  {
    "text": "firewall altogether configuration wise",
    "start": "1544000",
    "end": "1550240"
  },
  {
    "start": "1546000",
    "end": "1546000"
  },
  {
    "text": "there is a the file manager reads the configuration file from the local folder where it's",
    "start": "1550240",
    "end": "1557919"
  },
  {
    "text": "running that's the name of the configuration file the rpc file conf",
    "start": "1557919",
    "end": "1563600"
  },
  {
    "text": "just like we saw for every change you simply update called the update command and",
    "start": "1563600",
    "end": "1570400"
  },
  {
    "text": "it should update all the firewalls currently it supports uuid",
    "start": "1570400",
    "end": "1576640"
  },
  {
    "text": "it supports opnom and it supports address for filtering and you can also control",
    "start": "1576640",
    "end": "1582799"
  },
  {
    "text": "the action of course if if it's block or allow and you can also control the audit",
    "start": "1582799",
    "end": "1588240"
  },
  {
    "text": "whether you produce an event log or don't produce an event logger that's very important for performance",
    "start": "1588240",
    "end": "1594960"
  },
  {
    "text": "uh the way that uh the filtering works is simply line by line",
    "start": "1594960",
    "end": "1601120"
  },
  {
    "text": "uh the first match determines um [Music]",
    "start": "1601120",
    "end": "1606159"
  },
  {
    "text": "and for example if we just seen the dc sync attack",
    "start": "1606159",
    "end": "1611200"
  },
  {
    "text": "if we want if we we would want to block uh",
    "start": "1611200",
    "end": "1616320"
  },
  {
    "text": "all dc sync action except for ones coming from other domain controllers we can do this with this configuration so",
    "start": "1616320",
    "end": "1623360"
  },
  {
    "text": "we allow uh specific addresses to call this interface which is the drsr we've seen",
    "start": "1623360",
    "end": "1630240"
  },
  {
    "text": "it before and every other interface would be any other call from another ip",
    "start": "1630240",
    "end": "1635440"
  },
  {
    "text": "address would be block so we can control our attack surface for rpc and for any rpc",
    "start": "1635440",
    "end": "1642799"
  },
  {
    "text": "in this specifically performance-wise i ran multiple tests",
    "start": "1642799",
    "end": "1648480"
  },
  {
    "start": "1644000",
    "end": "1644000"
  },
  {
    "text": "and as long as you don't the most happy operation is the writing of the event log",
    "start": "1648480",
    "end": "1654320"
  },
  {
    "text": "of course we're constantly improving that maybe by the time you see this which will be",
    "start": "1654320",
    "end": "1660399"
  },
  {
    "text": "in the future after i recall this presentation we will already fix that there is some penalty performance if",
    "start": "1660399",
    "end": "1666159"
  },
  {
    "text": "there is an audit but as long as there is no audit you get nothing that can be distinguished uh",
    "start": "1666159",
    "end": "1672320"
  },
  {
    "text": "i've run tens of thousands of rpc calls for different services i couldn't detect any cpu",
    "start": "1672320",
    "end": "1678880"
  },
  {
    "text": "differences timing differences and so on so it looks like it doesn't have any uh",
    "start": "1678880",
    "end": "1685360"
  },
  {
    "text": "major penalties for using this in production uh some consideration that you need to",
    "start": "1685360",
    "end": "1691600"
  },
  {
    "start": "1689000",
    "end": "1689000"
  },
  {
    "text": "take in mind when using the opposite firewall is this persistency and again",
    "start": "1691600",
    "end": "1697679"
  },
  {
    "text": "this is simply out of scope for this tool uh currently maybe in a future version",
    "start": "1697679",
    "end": "1702880"
  },
  {
    "text": "uh once the process is down the firewall of course because it hooks to specific functions",
    "start": "1702880",
    "end": "1707919"
  },
  {
    "text": "when the process is down the firewall and spins up as a new process",
    "start": "1707919",
    "end": "1713360"
  },
  {
    "text": "the file won't be there so for most services it's not a big issue because most of them are",
    "start": "1713360",
    "end": "1719440"
  },
  {
    "text": "persistent throughout the time that the server has been up so you can create a startup script or",
    "start": "1719440",
    "end": "1726000"
  },
  {
    "text": "service that continuously installs the rpc server",
    "start": "1726000",
    "end": "1731039"
  },
  {
    "text": "if you want so fit maybe you will do this in a future version of course when you run you need to have",
    "start": "1731039",
    "end": "1737279"
  },
  {
    "text": "admin privileges you can actually hook higher privileges higher privilege",
    "start": "1737279",
    "end": "1742880"
  },
  {
    "text": "processes there is an issue of course with protected process out of the box i think",
    "start": "1742880",
    "end": "1749200"
  },
  {
    "text": "you only get the rpc process which is relevant uh is maybe one",
    "start": "1749200",
    "end": "1755360"
  },
  {
    "text": "um but most of the processes that you can and should protect don't",
    "start": "1755360",
    "end": "1760559"
  },
  {
    "text": "are not protected um but if you still want to use the rpc firewall for research for example",
    "start": "1760559",
    "end": "1767600"
  },
  {
    "text": "you can do that with tools like mimikats you can remove the protection install the rpc file we'll see how",
    "start": "1767600",
    "end": "1775200"
  },
  {
    "text": "see how the calls work on the inside and then you use maybe the rpc filters",
    "start": "1775200",
    "end": "1781520"
  },
  {
    "text": "side by side and in production with the rpc firewall so this is also why it's important to",
    "start": "1781520",
    "end": "1787360"
  },
  {
    "text": "to have that distinction so now we come up to the last part",
    "start": "1787360",
    "end": "1792559"
  },
  {
    "text": "called burning bridges and now we're going to give practical example of how you can",
    "start": "1792559",
    "end": "1797679"
  },
  {
    "text": "use this tool if you're in a defensive team or just a researcher doing some rpc research",
    "start": "1797679",
    "end": "1805200"
  },
  {
    "text": "how you can use it and how you can actually use the production uh to protect your uh your server and services",
    "start": "1805200",
    "end": "1812240"
  },
  {
    "start": "1811000",
    "end": "1811000"
  },
  {
    "text": "uh so basic um two types of cycles or two types of operations i guess that you can use it",
    "start": "1812240",
    "end": "1818799"
  },
  {
    "text": "for you can use the rpc file to create a allow list simply audit everything allow everything",
    "start": "1818799",
    "end": "1826720"
  },
  {
    "text": "look at what is normal and if you're positive that it's normal",
    "start": "1826720",
    "end": "1832480"
  },
  {
    "text": "allow this and block everything else you can create your block list or deny",
    "start": "1832480",
    "end": "1837760"
  },
  {
    "text": "list do the same thing run specific attacks that you know that",
    "start": "1837760",
    "end": "1843919"
  },
  {
    "text": "are bad record use it to create your configuration that blocks all of these attacks",
    "start": "1843919",
    "end": "1850880"
  },
  {
    "text": "and put it in production and maybe later profit so let's see the final demo and again in",
    "start": "1850880",
    "end": "1857120"
  },
  {
    "text": "this demo i'm going to show uh some of the attacks that again we've already seen the smr",
    "start": "1857120",
    "end": "1864480"
  },
  {
    "start": "1859000",
    "end": "1859000"
  },
  {
    "text": "the samo as you remember we did a read operation from database which is like a",
    "start": "1864480",
    "end": "1869679"
  },
  {
    "text": "reconnaissance attack but also can be very common maybe you don't need to know every time",
    "start": "1869679",
    "end": "1875200"
  },
  {
    "text": "that this happens and we see a write attack so we create objects inside the",
    "start": "1875200",
    "end": "1880720"
  },
  {
    "text": "domain inside the directory uh so we'll see how you can block that",
    "start": "1880720",
    "end": "1886159"
  },
  {
    "text": "and create alerts specifically for that and for this sync we can see how unlike the rpc filter",
    "start": "1886159",
    "end": "1893600"
  },
  {
    "text": "the windows rpc filter which has this bug you can use it to block specific ip address and allow everything else",
    "start": "1893600",
    "end": "1901760"
  },
  {
    "text": "so again we have the same setup this is the target domain controller as you've seen",
    "start": "1902960",
    "end": "1908240"
  },
  {
    "text": "we have a configuration to allow everything and audit everything and before uh before we start of course",
    "start": "1908240",
    "end": "1915440"
  },
  {
    "text": "we need to install the rpc firewall so luckily we have the install command",
    "start": "1915440",
    "end": "1921519"
  },
  {
    "text": "that's exactly what i'm going to use and once it's installed",
    "start": "1921519",
    "end": "1927840"
  },
  {
    "text": "um it will create the it will dump dlls inside the root folder",
    "start": "1927840",
    "end": "1934320"
  },
  {
    "text": "it will also create the registry keys for the",
    "start": "1934320",
    "end": "1940000"
  },
  {
    "text": "windows event and i can what i just did is run it",
    "start": "1940000",
    "end": "1945919"
  },
  {
    "text": "to protect all processes inside my my machine so once i do that i have the log i",
    "start": "1945919",
    "end": "1952480"
  },
  {
    "text": "protect all the processes uh we can clear the log and start our cycle",
    "start": "1952480",
    "end": "1958399"
  },
  {
    "text": "like i described earlier so first things uh first we're going to do the read operation from the database",
    "start": "1958399",
    "end": "1965279"
  },
  {
    "text": "and again we've seen this attack uh we know that it works previously if you would run it using uh",
    "start": "1965279",
    "end": "1972640"
  },
  {
    "text": "native logs you'll get thousands if not hundreds of logs now we get a very limited information of logs",
    "start": "1972640",
    "end": "1978799"
  },
  {
    "text": "of only the rpc calls that we need uh so we can see exactly what's the interface id that was called what's the",
    "start": "1978799",
    "end": "1985440"
  },
  {
    "text": "up num where it came from the ip address who made this call and so on and so",
    "start": "1985440",
    "end": "1991760"
  },
  {
    "text": "forth and we can use it create our configuration file i will show that",
    "start": "1991760",
    "end": "1997039"
  },
  {
    "text": "later and create a and know that it's a good operation that we can allow",
    "start": "1997039",
    "end": "2003200"
  },
  {
    "text": "now we're doing again the tech that we did before of writing a computer inside the domain controller",
    "start": "2003200",
    "end": "2009919"
  },
  {
    "text": "uh again we saw that it works and unsurprisingly once i go to the event",
    "start": "2009919",
    "end": "2015039"
  },
  {
    "text": "log uh i will see only the events related to this attack",
    "start": "2015039",
    "end": "2020399"
  },
  {
    "text": "and again i have all the information that i need to create a block uh rule um",
    "start": "2020399",
    "end": "2026320"
  },
  {
    "text": "and know when somebody is trying to create uh objects inside my directory and finally",
    "start": "2026320",
    "end": "2032720"
  },
  {
    "text": "the this is sync attack that again we already seen um",
    "start": "2032720",
    "end": "2037760"
  },
  {
    "text": "again i'm going to run through it's the same type of operation and i'm just doing everything for uh completely",
    "start": "2037760",
    "end": "2043760"
  },
  {
    "text": "completeness so you know that it works and you see it for yourself again we get",
    "start": "2043760",
    "end": "2048960"
  },
  {
    "text": "all the information that we need where it came from this time it's not a dc so we know we need to allow it only for",
    "start": "2048960",
    "end": "2055358"
  },
  {
    "text": "disease and now i'm going to do i will go ahead and create a configuration which i",
    "start": "2055359",
    "end": "2061520"
  },
  {
    "text": "already prepared in advance and this configuration will block",
    "start": "2061520",
    "end": "2066960"
  },
  {
    "text": "the specific sam operations that are right these are not the only ones the operation 15 and 58 they're not the only",
    "start": "2066960",
    "end": "2074320"
  },
  {
    "text": "write operations but just for simplicity i just use these ones so i'm blocking them and i'm putting the audit on true",
    "start": "2074320",
    "end": "2081839"
  },
  {
    "text": "because i want to know when somebody is quote unquote attacking me using this type of techniques and i'm going to",
    "start": "2081839",
    "end": "2087839"
  },
  {
    "text": "allow everything else and not audit it because all the other operations maybe are not that interested",
    "start": "2087839",
    "end": "2094398"
  },
  {
    "text": "and under the same thing for the dc sync i'm only going to allow it from an ip which belongs to domain controller block",
    "start": "2094399",
    "end": "2101760"
  },
  {
    "text": "everything else mark audit true and that will create an event basically an alert a one-to-one",
    "start": "2101760",
    "end": "2108480"
  },
  {
    "text": "event to alert that i need to know about it especially if i'm in the security team",
    "start": "2108480",
    "end": "2114480"
  },
  {
    "text": "so now i need to update the firewall and once i do i'll run through all these tests just like we've seen before and",
    "start": "2114480",
    "end": "2119920"
  },
  {
    "text": "just to show you that it works um i'm going to run the read operation",
    "start": "2119920",
    "end": "2126000"
  },
  {
    "text": "the read operation is allowed so it's going to work but maybe more importantly no events are",
    "start": "2126000",
    "end": "2131839"
  },
  {
    "text": "produced so as long as everything's okay i don't get any events i don't get any penalty basically performance penalty",
    "start": "2131839",
    "end": "2139119"
  },
  {
    "text": "once i try to write i get an access denied and i get an event so now i know",
    "start": "2139119",
    "end": "2144400"
  },
  {
    "text": "that i'm being attacked over rpc i know it's where it's coming from the attack failed because it was blocked and i can",
    "start": "2144400",
    "end": "2151119"
  },
  {
    "text": "investigate the machine same thing for the moving because this is sync again i get a single event i know where i got",
    "start": "2151119",
    "end": "2157119"
  },
  {
    "text": "attacked from i know the hosts did it i can isolate them",
    "start": "2157119",
    "end": "2162400"
  },
  {
    "text": "and i didn't compromise they didn't compromise my domain uh",
    "start": "2162400",
    "end": "2169040"
  },
  {
    "text": "sorry about that",
    "start": "2169040",
    "end": "2172599"
  },
  {
    "text": "with that little glitch um i want to thank you for tuning in to my talk i just want to put up here my uh uh",
    "start": "2174640",
    "end": "2182400"
  },
  {
    "text": "the github you can check it out again contact me for anything you wish um",
    "start": "2182400",
    "end": "2189440"
  },
  {
    "text": "contribution are encouraged and i want to thank you again for tuning into my talk and i guess this is virtual",
    "start": "2189440",
    "end": "2195599"
  },
  {
    "text": "question time uh so thank you very much ciao",
    "start": "2195599",
    "end": "2201910"
  },
  {
    "text": "[Music]",
    "start": "2201910",
    "end": "2211518"
  }
]