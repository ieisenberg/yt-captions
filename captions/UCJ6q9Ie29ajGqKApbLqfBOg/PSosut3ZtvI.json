[
  {
    "start": "0",
    "end": "56000"
  },
  {
    "text": "[Music]",
    "start": "1700",
    "end": "4810"
  },
  {
    "text": "hello everyone and welcome to my talk do not trust the ASA Trojans",
    "start": "7580",
    "end": "13080"
  },
  {
    "text": "now you might immediately be asking what is an ASA and these are ASA these are",
    "start": "13080",
    "end": "18720"
  },
  {
    "text": "Cisco adaptive security appliances at the top there you see the original ASA released some 15 years ago that was",
    "start": "18720",
    "end": "26340"
  },
  {
    "text": "followed by the release of the asax which was followed more recently by the release of the asax Firepower services",
    "start": "26340",
    "end": "34739"
  },
  {
    "text": "now the ASA comes in a few other form factors as well including a virtual Appliance known as asav",
    "start": "34739",
    "end": "42059"
  },
  {
    "text": "and all of these are sort of Asa as well despite their names because they can run the operating system known as ASA",
    "start": "42059",
    "end": "49140"
  },
  {
    "text": "software that is of course the same operating system used by the previously mentioned Asa",
    "start": "49140",
    "end": "56640"
  },
  {
    "start": "56000",
    "end": "56000"
  },
  {
    "text": "now an ASA typically sits at the edge of your corporate Network where it can be a firewall a VPN an IPS and or a router",
    "start": "56640",
    "end": "64619"
  },
  {
    "text": "possibly all wrapped into one now the esa is a critical asset because it acts as the Gateway between the",
    "start": "64619",
    "end": "71100"
  },
  {
    "text": "internet and your corporate Network and it also implements a variety of access controls and protections",
    "start": "71100",
    "end": "78299"
  },
  {
    "text": "this talk is called do not trust the ASA because we're going to use a variety of features and vulnerabilities affecting",
    "start": "78299",
    "end": "84600"
  },
  {
    "text": "the ASA in order to get root shells on the ASA itself as well as the administrative systems that connects to",
    "start": "84600",
    "end": "91200"
  },
  {
    "text": "it now all the esa models we discussed earlier",
    "start": "91200",
    "end": "96600"
  },
  {
    "text": "can be managed by by this thick client known as adaptive security device manager or asdm ASTM is installed on an",
    "start": "96600",
    "end": "105180"
  },
  {
    "text": "administrator's Windows system so that they can remotely connect to their ASA or ASAS",
    "start": "105180",
    "end": "110460"
  },
  {
    "start": "106000",
    "end": "106000"
  },
  {
    "text": "and perform administrative tasks like updating firewall rules adding VPN users or simply monitoring the router's",
    "start": "110460",
    "end": "117600"
  },
  {
    "text": "behavior for about the next 20 slides or so it's",
    "start": "117600",
    "end": "122700"
  },
  {
    "start": "119000",
    "end": "119000"
  },
  {
    "text": "important to understand how the asdm client and the ASA communicate one of the first things that happens is",
    "start": "122700",
    "end": "129119"
  },
  {
    "text": "that the asdm client makes an HTTP request for a pdm.sgz file this file is",
    "start": "129119",
    "end": "136200"
  },
  {
    "text": "hosted on The Cisco asa's web server and the pdm.asg sgz is downloaded by the",
    "start": "136200",
    "end": "142739"
  },
  {
    "text": "client and then unpacked the sgz format is a non-standard one but regardless the",
    "start": "142739",
    "end": "149700"
  },
  {
    "text": "client finds inside is a whole bunch of java classes the client will load those classes into",
    "start": "149700",
    "end": "155280"
  },
  {
    "text": "memory execute them and that establishes the full administrative session with the",
    "start": "155280",
    "end": "160620"
  },
  {
    "text": "ASA now the fact that the sgz file contains much of the client's functionality will be important uh in a",
    "start": "160620",
    "end": "166980"
  },
  {
    "text": "bit now what's interesting about this is while that communication occurs over SSL",
    "start": "166980",
    "end": "174060"
  },
  {
    "text": "the ASM client never verifies the asa's server certificate which means that a man in the middle",
    "start": "174060",
    "end": "180959"
  },
  {
    "text": "like hacker cat here can monitor or even modify the communication between the asdm client and the ASA itself",
    "start": "180959",
    "end": "189239"
  },
  {
    "text": "essentially this should allow hackercat to take full control over the ASA as long as they're able to establish this",
    "start": "189239",
    "end": "195360"
  },
  {
    "text": "man in the middle position now that's not theoretical in nature pictured here is a screenshot of me",
    "start": "195360",
    "end": "202200"
  },
  {
    "text": "using the popular Tool Man in the middle proxy on the asdm client I use the",
    "start": "202200",
    "end": "207360"
  },
  {
    "text": "default man in the middle proxy certificate and the asdm client gave no indication that it was under attack now",
    "start": "207360",
    "end": "213599"
  },
  {
    "text": "like I said this should give me the attacker full control over the Asa but I might be able to gain control over",
    "start": "213599",
    "end": "220500"
  },
  {
    "text": "the administrator system as well recall that this pdm.sgz file is full of java",
    "start": "220500",
    "end": "226620"
  },
  {
    "text": "classes if the man in the middle can introduce malicious Java classes to the sgz maybe",
    "start": "226620",
    "end": "233220"
  },
  {
    "text": "the asdm client will execute that malicious code",
    "start": "233220",
    "end": "237980"
  },
  {
    "text": "to explore that I wrote this tool called get you it's an sgz file parser",
    "start": "238920",
    "end": "244440"
  },
  {
    "text": "it tracks all the files from an sgz file and drops them to disk on the right here",
    "start": "244440",
    "end": "249480"
  },
  {
    "text": "you can see a recent release of of an sgz file contained more than 13 000 Java",
    "start": "249480",
    "end": "254760"
  },
  {
    "text": "class files among some other files most importantly it contains a signature file",
    "start": "254760",
    "end": "260579"
  },
  {
    "text": "this file contains valid cryptographic signatures for all of the files in the",
    "start": "260579",
    "end": "266639"
  },
  {
    "text": "sgz and if the asdm client verifies the files it downloads against this",
    "start": "266639",
    "end": "272340"
  },
  {
    "text": "signature file and the attacker shouldn't be able to introduce malicious code",
    "start": "272340",
    "end": "278780"
  },
  {
    "text": "unfortunately the client doesn't do that last summer Cisco issued this advisory",
    "start": "278780",
    "end": "284280"
  },
  {
    "text": "and assigned cve 2021-1585 essentially this advisory says a man in",
    "start": "284280",
    "end": "290280"
  },
  {
    "text": "the middle can inject arbitrary Java classes into an sgz file and gain execution on an administrative system",
    "start": "290280",
    "end": "296699"
  },
  {
    "text": "via SDM now Cisco didn't release a patch for with this advisory in fact they didn't",
    "start": "296699",
    "end": "303840"
  },
  {
    "text": "try to patch it until June 2022 and unfortunately that patch wasn't effective",
    "start": "303840",
    "end": "309419"
  },
  {
    "text": "and I'm told Cisco released a new patch business vulnerability uh this very morning so this issue might be cleaned",
    "start": "309419",
    "end": "315540"
  },
  {
    "text": "up as of right now but that took more of a year more than a year after the initial public disclosure",
    "start": "315540",
    "end": "322940"
  },
  {
    "text": "the man in the middle is a difficult position to achieve for most attackers so it's also useful to note that 1585 is",
    "start": "324000",
    "end": "331740"
  },
  {
    "text": "actually uh is actually exploitable via evil endpoint what I mean by evil endpoint is that if",
    "start": "331740",
    "end": "338639"
  },
  {
    "text": "hacker cat can trick an administrator to connect their asdm client to an endpoint in hacker hackercast control",
    "start": "338639",
    "end": "346259"
  },
  {
    "text": "then hacker cat can provide the client with a malicious sgz file resulting in code execution on the administrator",
    "start": "346259",
    "end": "352979"
  },
  {
    "text": "system as pictured here again that's not theoretical either I've",
    "start": "352979",
    "end": "358440"
  },
  {
    "text": "actually written a couple of exploits for this one of which is a Metasploit module and this talk really emphasizes",
    "start": "358440",
    "end": "365340"
  },
  {
    "text": "the use of real exploits particularly Metasploit modules to really Hammer home that these are",
    "start": "365340",
    "end": "372539"
  },
  {
    "text": "viable attacks that could be pulled off by low-skilled attackers and therefore should be taken quite seriously",
    "start": "372539",
    "end": "380780"
  },
  {
    "text": "now obviously the man in the middle aspect of this attack is much more difficult when the administrator doesn't",
    "start": "380880",
    "end": "386400"
  },
  {
    "text": "connect to the ASA over the Internet hacker cat's going to have a hard time establishing any type of access",
    "start": "386400",
    "end": "392479"
  },
  {
    "text": "incorpnet so the administrator is probably safe in this configuration",
    "start": "392479",
    "end": "398400"
  },
  {
    "text": "but as a researcher I wanted to find a way to attack the administrator on corpnet as well and I figured I'd try to",
    "start": "398400",
    "end": "404880"
  },
  {
    "text": "modify the sgz file on the ASA itself remember the sgz is hosted on the",
    "start": "404880",
    "end": "410819"
  },
  {
    "text": "router's web server so I figured I might have some type of right access there to modify it",
    "start": "410819",
    "end": "418220"
  },
  {
    "text": "but I first needed to find how the sgz file got on the ASA in the first place and the answer is that it gets added to",
    "start": "418380",
    "end": "425520"
  },
  {
    "text": "the ASA when the asdm binary package is loaded on the system now the package is",
    "start": "425520",
    "end": "431039"
  },
  {
    "text": "available on Cisco's web website as pictured here but it's also loaded by default on some ASA for example the asav",
    "start": "431039",
    "end": "439220"
  },
  {
    "text": "and the test ASA that we purchased the 5506x also came with it pre-loaded but",
    "start": "439220",
    "end": "446099"
  },
  {
    "text": "regardless this sgz file is first introduced the asa's web server when",
    "start": "446099",
    "end": "451860"
  },
  {
    "text": "this asdm binary blob is loaded onto the Asa and so I went hunting for the sgz file",
    "start": "451860",
    "end": "459360"
  },
  {
    "start": "456000",
    "end": "456000"
  },
  {
    "text": "in the asdm binary package again this is a non-standard format so I had to do a",
    "start": "459360",
    "end": "465060"
  },
  {
    "text": "little work but it turned out to be simple enough the binary package breaks down into three major parts a general header a",
    "start": "465060",
    "end": "472620"
  },
  {
    "text": "manifest area and then all the files are catted together at the end",
    "start": "472620",
    "end": "477840"
  },
  {
    "text": "and I was also looking for security features in this binary package basically evidence that Cisco was",
    "start": "477840",
    "end": "484080"
  },
  {
    "text": "signing the package I did find this hash field in the header so my question was is this Hash a security feature or is it",
    "start": "484080",
    "end": "491819"
  },
  {
    "text": "just a checksum that ensures the Integrity of the file uh and it turned out it's just to check",
    "start": "491819",
    "end": "498240"
  },
  {
    "text": "some which might not sound like a big deal to a lay person but it really is because",
    "start": "498240",
    "end": "503280"
  },
  {
    "text": "there is no Cisco signature on the binary package anyone is able to craft",
    "start": "503280",
    "end": "508379"
  },
  {
    "text": "their own arbitrary asdm package which is a big deal because it means we as",
    "start": "508379",
    "end": "513899"
  },
  {
    "text": "attackers can upload arbitrary sgz files to the Asa among other things which in theory",
    "start": "513899",
    "end": "520680"
  },
  {
    "text": "should allow us to attack that administrator deep down in corpnet",
    "start": "520680",
    "end": "526380"
  },
  {
    "start": "525000",
    "end": "525000"
  },
  {
    "text": "now we did report at this issue to Cisco back in February of this year and Cisco released this advisory in June again",
    "start": "526380",
    "end": "534660"
  },
  {
    "text": "without a patch uh I believe a patch for this was also released today but I",
    "start": "534660",
    "end": "540540"
  },
  {
    "text": "haven't had a chance to look at it or verify it in any way so I don't have too much to say about that but this advisory",
    "start": "540540",
    "end": "547380"
  },
  {
    "text": "is exactly what we just discussed attackers can upload malicious asdm packages to the ASA which can result in",
    "start": "547380",
    "end": "554640"
  },
  {
    "text": "code execution on hosts connecting to the router so we're able to achieve what we set out",
    "start": "554640",
    "end": "560880"
  },
  {
    "text": "to do hackercat has a malicious asdm package hosted on the esa the only question that remains is how exactly",
    "start": "560880",
    "end": "567660"
  },
  {
    "text": "does hacker cat craft this malicious package now there are actually a bunch of files",
    "start": "567660",
    "end": "574320"
  },
  {
    "text": "in this binary package and there are a variety of attack vectors hacker cat can pursue with these files that will result",
    "start": "574320",
    "end": "580800"
  },
  {
    "text": "in code execution but as we've already talked about the SGC file and we know what the good",
    "start": "580800",
    "end": "586440"
  },
  {
    "text": "attack vector and we know that it's contained in this SGC file we'll just focus on that so",
    "start": "586440",
    "end": "593580"
  },
  {
    "text": "let's discuss a tool that will help hackercad build malicious asdm binary packages",
    "start": "593580",
    "end": "600560"
  },
  {
    "text": "so this is a tool I wrote called the way and the way has three major functions it",
    "start": "600600",
    "end": "606060"
  },
  {
    "text": "can extract I can parse and extract asdm packages to disk which is useful for",
    "start": "606060",
    "end": "612180"
  },
  {
    "text": "examining the contents of the package and modifying the content of a package",
    "start": "612180",
    "end": "617880"
  },
  {
    "start": "617000",
    "end": "617000"
  },
  {
    "text": "and it can also rebuild extracted asdm packages so for example in this slide I",
    "start": "617880",
    "end": "623700"
  },
  {
    "text": "modify the asdm's web portals index.html and I modify it to say hello black hat",
    "start": "623700",
    "end": "630779"
  },
  {
    "text": "then I use the way to rebuild a valid asdm package when the new package is loaded onto the ASA and we browse to the",
    "start": "630779",
    "end": "638459"
  },
  {
    "text": "asdm web portal on the router and we'll see hello black hat now appears on the",
    "start": "638459",
    "end": "643740"
  },
  {
    "text": "landing page and finally the way can just generate straight up malicious asdm packages and",
    "start": "643740",
    "end": "651300"
  },
  {
    "start": "645000",
    "end": "645000"
  },
  {
    "text": "now these packages contain an sgz file that will generate a reverse shell to an IP and poorer of the attacker's choosing",
    "start": "651300",
    "end": "658560"
  },
  {
    "text": "whenever an asdm client connects to the Asa pictured here is a client that connected",
    "start": "658560",
    "end": "664079"
  },
  {
    "text": "to a malicious asdm sending a reverse shell to my Ubuntu box",
    "start": "664079",
    "end": "669920"
  },
  {
    "start": "669000",
    "end": "669000"
  },
  {
    "text": "so by crafting a malicious ASTM package we can exploit ASTM clients not only connecting from the internet but from",
    "start": "670680",
    "end": "677519"
  },
  {
    "text": "corpnet as well the only challenge is installing our our",
    "start": "677519",
    "end": "682860"
  },
  {
    "text": "malicious asdm package in the first place it does require elevated privileges to install packages on the",
    "start": "682860",
    "end": "689519"
  },
  {
    "text": "ASA so that is certainly a limiting factor but of course attackers can find ways to",
    "start": "689519",
    "end": "695399"
  },
  {
    "text": "get the required credentials or they can use an inside attacker or tricking administrator into installing a",
    "start": "695399",
    "end": "701040"
  },
  {
    "text": "malicious package those are all very plausible attack vectors my favorite Vector is a supply chain",
    "start": "701040",
    "end": "707579"
  },
  {
    "text": "attack when I bought our test ASA 5506x with Firepower services",
    "start": "707579",
    "end": "714060"
  },
  {
    "text": "it arrived with an asdm package already loaded I had no way of knowing if it was a valid Cisco ASTM package or not the",
    "start": "714060",
    "end": "721079"
  },
  {
    "text": "reseller could have planted a malicious package on my device and they could have had code execution",
    "start": "721079",
    "end": "726180"
  },
  {
    "text": "within my home network when I started using and researching the ascm interface",
    "start": "726180",
    "end": "732000"
  },
  {
    "text": "now as we've seen this isn't a theoretical threat it is actually a viable and demonstratable attack that if",
    "start": "732000",
    "end": "738120"
  },
  {
    "text": "done correctly would leave the victim none the wiser",
    "start": "738120",
    "end": "743000"
  },
  {
    "text": "so that's all we're going to focus on for asdm hackery the rest of this talk will focus on a particular model of Asa",
    "start": "743640",
    "end": "750720"
  },
  {
    "text": "called the asax with Firepower services and then in this first section we're going to get a root shell on the system",
    "start": "750720",
    "end": "756839"
  },
  {
    "text": "over http as a reminder these are the asax and",
    "start": "756839",
    "end": "763019"
  },
  {
    "text": "Firepower Services they're the latest Hardware model to use the ASA name and",
    "start": "763019",
    "end": "768120"
  },
  {
    "text": "they are admittedly getting a bit long in the tooth but still in support and use globally",
    "start": "768120",
    "end": "775019"
  },
  {
    "text": "now the name Firepower Services actually just describe the special feature of this ASA in particular it describes this",
    "start": "775019",
    "end": "782040"
  },
  {
    "text": "old uh this oval at the bottom labeled ASA Firepower module deep packet",
    "start": "782040",
    "end": "788279"
  },
  {
    "text": "inspection and what that Firepower module actually is is a virtual machine running snort",
    "start": "788279",
    "end": "795000"
  },
  {
    "text": "essentially Firepower Services is an IPS that's installed directly on the ASA",
    "start": "795000",
    "end": "800279"
  },
  {
    "text": "itself it's a pretty nifty feature and from this diagram we can see incoming traffic is diverted through the virtual",
    "start": "800279",
    "end": "808260"
  },
  {
    "text": "machine for analysis now you can access the Firepower virtual",
    "start": "808260",
    "end": "814260"
  },
  {
    "text": "machine via the Cisco CLI the command session sfr console will drop you into a",
    "start": "814260",
    "end": "820260"
  },
  {
    "text": "telnet session which prompts for credentials and once authenticated you'll be able to access this is",
    "start": "820260",
    "end": "826200"
  },
  {
    "text": "apparently limited Firepower module shell except it isn't all that limited At All",
    "start": "826200",
    "end": "831899"
  },
  {
    "start": "829000",
    "end": "829000"
  },
  {
    "text": "by executing the expert command you'll drop down into a bash shell on the VM",
    "start": "831899",
    "end": "837000"
  },
  {
    "text": "and from there you can actually pseudo to root using the previously used telnet credentials",
    "start": "837000",
    "end": "843000"
  },
  {
    "text": "and this root shell as a feature isn't limited to terminal connections you can use it via SSH so anyone with SSH access",
    "start": "843000",
    "end": "850260"
  },
  {
    "text": "to the ASA can grab a root shell on this virtual machine now that is actually noteworthy because",
    "start": "850260",
    "end": "857220"
  },
  {
    "start": "854000",
    "end": "854000"
  },
  {
    "text": "this virtual machine when configured has network access meaning it can communicate with the inside Network",
    "start": "857220",
    "end": "864240"
  },
  {
    "text": "uh and it can communicate with the outside Network uh in that way when you",
    "start": "864240",
    "end": "869700"
  },
  {
    "text": "have access to this virtual machine you can reach the network that this the ASA",
    "start": "869700",
    "end": "874740"
  },
  {
    "text": "is trying to protect and you can reach outwards an attacker that grabs a root shell on this VM can install arbitrary software",
    "start": "874740",
    "end": "882120"
  },
  {
    "text": "uh persist through reboots in upgrades pivot attacks inwards exfiltrate data",
    "start": "882120",
    "end": "888060"
  },
  {
    "text": "out and perhaps most interestingly to me just chill out and sniff the traffic flowing through the VM and it's unlikely",
    "start": "888060",
    "end": "895139"
  },
  {
    "text": "that anyone is actually monitoring this virtual machine for malicious behavior it's rather it's a rather attractive",
    "start": "895139",
    "end": "902220"
  },
  {
    "text": "Target for an attacker to sit in this type of root shell is actually something most router vendors attempt to prevent",
    "start": "902220",
    "end": "908940"
  },
  {
    "text": "but on this ASA is just a feature now Cisco obviously knows this is",
    "start": "908940",
    "end": "915660"
  },
  {
    "start": "912000",
    "end": "912000"
  },
  {
    "text": "dangerous because they have this lockdown sensor command that can disable the expert command and thus access to",
    "start": "915660",
    "end": "922260"
  },
  {
    "text": "the root shell permanently but I'm not entirely sure how often this command is used and our next exploit",
    "start": "922260",
    "end": "928440"
  },
  {
    "text": "will bypass the lockdown anyways so I was investigating how I could land",
    "start": "928440",
    "end": "934320"
  },
  {
    "text": "in this root shell via HTTP and it turns out ASTM can talk to the Firepower module and generate these very pretty",
    "start": "934320",
    "end": "941040"
  },
  {
    "text": "graphs but asdm can't access the root shell if I use asdm to issue the session sfr",
    "start": "941040",
    "end": "948540"
  },
  {
    "start": "942000",
    "end": "942000"
  },
  {
    "text": "console command then the ASA basically replies you can't do interactive shells over https so get out of here",
    "start": "948540",
    "end": "956279"
  },
  {
    "text": "so I started messing around with some command injection vectors and here's one that was actually successful I issued",
    "start": "956279",
    "end": "962820"
  },
  {
    "text": "the command session sfr do backtick ID backtick where ID is a Linux command I",
    "start": "962820",
    "end": "968880"
  },
  {
    "text": "wanted to execute if ID is executed it will let us know which user the command executed as so",
    "start": "968880",
    "end": "975720"
  },
  {
    "text": "we can see that the ASA actually responded to my request with invalid do",
    "start": "975720",
    "end": "981360"
  },
  {
    "text": "command U would equal zero root meaning we successfully executed the command",
    "start": "981360",
    "end": "986459"
  },
  {
    "text": "Azure within the virtual machine which results in this scenario an",
    "start": "986459",
    "end": "992339"
  },
  {
    "text": "attacker over the internet can achieve a root shell on the fire Firepower module Virtual Machine by sending a rather",
    "start": "992339",
    "end": "999480"
  },
  {
    "text": "simple command injection exploit and the exploit is really simple so",
    "start": "999480",
    "end": "1005899"
  },
  {
    "text": "simple it could fit in a tweet so pictured here you can see a tweetable version of the exploit",
    "start": "1005899",
    "end": "1011060"
  },
  {
    "text": "you can see I use the curl utility bash Dev TCP and neck hat to throw the",
    "start": "1011060",
    "end": "1016459"
  },
  {
    "text": "exploit and catch a reverse shell originating from the Asa",
    "start": "1016459",
    "end": "1022040"
  },
  {
    "text": "and again this is great for an attacker they now have they now have their own malicious virtual machine on the ASA",
    "start": "1022040",
    "end": "1029298"
  },
  {
    "text": "that they can use to Pivot inwards and exfiltrate from",
    "start": "1029299",
    "end": "1034339"
  },
  {
    "text": "now Cisco did release an advisory for this but only after they realized that",
    "start": "1034339",
    "end": "1039558"
  },
  {
    "text": "it was a bypass for the lockdown sensor command Cisco has released patches for most but",
    "start": "1039559",
    "end": "1045079"
  },
  {
    "text": "not all ASA x with Firepower services and their advisory kind of makes a big",
    "start": "1045079",
    "end": "1050360"
  },
  {
    "text": "deal that the attack requires asdm credentials which is quite true but",
    "start": "1050360",
    "end": "1056299"
  },
  {
    "text": "those credentials might be easier to come by than you'd kind of imagine so I'm going to list a few ways you might",
    "start": "1056299",
    "end": "1062240"
  },
  {
    "text": "come along asdm credentials first recall that the asdm client is",
    "start": "1062240",
    "end": "1067940"
  },
  {
    "text": "vulnerable to man in the middle attacks additionally by default asdm client authenticates to the ASA using HTTP",
    "start": "1067940",
    "end": "1075380"
  },
  {
    "text": "basic authentication which means a man in the middle can trivially extract",
    "start": "1075380",
    "end": "1080660"
  },
  {
    "text": "valid asdm credentials from any HTTP request originally originating from the",
    "start": "1080660",
    "end": "1085700"
  },
  {
    "text": "asdm client oops so there's one way",
    "start": "1085700",
    "end": "1090880"
  },
  {
    "text": "it's also worth noting that the default credentials for the asdm interface are blank blank and you don't have to take",
    "start": "1091039",
    "end": "1097220"
  },
  {
    "text": "my word for it this slide is taken directly from Cisco's asdm book one and",
    "start": "1097220",
    "end": "1103520"
  },
  {
    "text": "of course we confirm this is true on our own 5506x",
    "start": "1103520",
    "end": "1109159"
  },
  {
    "text": "it also turns out the asdm client was logging credentials to the client log file for a time so I wrote a Metasploit",
    "start": "1109400",
    "end": "1116240"
  },
  {
    "text": "module that will scan through the asdm log files and pull out valid credentials so that's yet another way",
    "start": "1116240",
    "end": "1123340"
  },
  {
    "text": "and finally the asdm web interface doesn't have Brute Force protection enabled by default you have to go in and",
    "start": "1123340",
    "end": "1130640"
  },
  {
    "text": "enable this account lockout feature so the only thing that protects that",
    "start": "1130640",
    "end": "1136160"
  },
  {
    "start": "1133000",
    "end": "1133000"
  },
  {
    "text": "interface by default is an ASTM specific user agent one",
    "start": "1136160",
    "end": "1142580"
  },
  {
    "text": "version of which is pictured here without this user agent the ASA ignores the inbound asdm requests",
    "start": "1142580",
    "end": "1149360"
  },
  {
    "text": "so that's at least some type of protection um either way I ended up writing a",
    "start": "1149360",
    "end": "1155660"
  },
  {
    "text": "Metasploit module that Brute Force Brute Forces credentials on the asdm interface",
    "start": "1155660",
    "end": "1160820"
  },
  {
    "text": "now I think a lot of people believe that Brute Force attacks aren't very cool because they're not especially elegant",
    "start": "1160820",
    "end": "1166880"
  },
  {
    "text": "but we have seen apt like Gru use brute force attacks at scale with significant",
    "start": "1166880",
    "end": "1172520"
  },
  {
    "text": "success I'd suggest if it's good enough for Gru it's probably good enough for me and you",
    "start": "1172520",
    "end": "1179059"
  },
  {
    "text": "so with credentials in hand I also wrote I'm a display module for the command injection over http",
    "start": "1179059",
    "end": "1185299"
  },
  {
    "text": "here you can see I provide IPS and credentials throw the exploit and catch",
    "start": "1185299",
    "end": "1190640"
  },
  {
    "text": "a reverse shell yet again so uh we're going to switch our Focus to",
    "start": "1190640",
    "end": "1198440"
  },
  {
    "text": "abusing the installation of the Firepower module so nothing in the remainder of this talk is actually",
    "start": "1198440",
    "end": "1204500"
  },
  {
    "text": "considered a vulnerability by Cisco but I'll let you be your own judge on that matter",
    "start": "1204500",
    "end": "1211660"
  },
  {
    "text": "so interestingly the Firepower module is an add-on package kind of like the asdm",
    "start": "1212059",
    "end": "1217700"
  },
  {
    "text": "package it has to be installed the asax works totally fine without it and if the",
    "start": "1217700",
    "end": "1223700"
  },
  {
    "text": "user doesn't use the IPS feature like this will not want to install in the first place so a scenario where",
    "start": "1223700",
    "end": "1229880"
  },
  {
    "text": "hackercat has SSH access from the internet but the Firepower module isn't installed isn't that far-fetched but",
    "start": "1229880",
    "end": "1237380"
  },
  {
    "text": "without the Firepower module installed hacker cat can't access that special root shell",
    "start": "1237380",
    "end": "1243799"
  },
  {
    "text": "or Kenny so let's see how hacker cat can get the Shell by using the Firepower boot image",
    "start": "1243799",
    "end": "1250220"
  },
  {
    "start": "1250000",
    "end": "1250000"
  },
  {
    "text": "now the Firepower module installation process is a bit involved it happens in",
    "start": "1250220",
    "end": "1255320"
  },
  {
    "text": "three phases first the installation of a boot image then the installation of an",
    "start": "1255320",
    "end": "1260720"
  },
  {
    "text": "install package and finally an upgrade package is applied so we're going to talk about this file labeled number one",
    "start": "1260720",
    "end": "1267980"
  },
  {
    "text": "here and that's the boot image that's installed in phase one",
    "start": "1267980",
    "end": "1274340"
  },
  {
    "text": "the boot image needs to be downloaded from Cisco and copied to the ASA or an image might already be present on your",
    "start": "1274340",
    "end": "1280700"
  },
  {
    "text": "system as was the case when we purchased our test device but either way once the image is on the ASA you issue",
    "start": "1280700",
    "end": "1287900"
  },
  {
    "text": "two commands to boot it the First Command lets the ASA know this is the boot image you want to use the second",
    "start": "1287900",
    "end": "1294200"
  },
  {
    "text": "command actually boots it up you then issue the session sfr console",
    "start": "1294200",
    "end": "1300260"
  },
  {
    "start": "1296000",
    "end": "1296000"
  },
  {
    "text": "command to open a telnet connection to the boot image you'll be prompted for credentials so pictured here's the default credentials",
    "start": "1300260",
    "end": "1307039"
  },
  {
    "text": "for various versions of the boot image but note the default user is always",
    "start": "1307039",
    "end": "1312440"
  },
  {
    "text": "admin so once you're authenticated you'll drop down into the shell in the boot image",
    "start": "1312440",
    "end": "1318080"
  },
  {
    "text": "and this is actually extremely limited it's really only useful for installing stage two the install package",
    "start": "1318080",
    "end": "1324919"
  },
  {
    "text": "it doesn't have anything like the export command that we saw previously so let's",
    "start": "1324919",
    "end": "1330500"
  },
  {
    "text": "take a step back and instead log in as this undocumented user root with the password cisco123 and",
    "start": "1330500",
    "end": "1339860"
  },
  {
    "text": "Bam you got a root shell and what's great about that is the boot",
    "start": "1339860",
    "end": "1345140"
  },
  {
    "text": "images networks too so using hard-coded creds on the boot image gives hacker cat the special root shell again",
    "start": "1345140",
    "end": "1351559"
  },
  {
    "text": "now Cisco said that this is not a vulnerability because there are no security expectations during the",
    "start": "1351559",
    "end": "1356659"
  },
  {
    "text": "Firepower install process they had the same responses when we reported a command injection issue in the boot",
    "start": "1356659",
    "end": "1362840"
  },
  {
    "text": "image as well I'm not going to talk about that one because it's easier to talk about the hard-coded creds but I just want to",
    "start": "1362840",
    "end": "1370039"
  },
  {
    "text": "emphasize boot image contains no vulnerabilities",
    "start": "1370039",
    "end": "1375639"
  },
  {
    "start": "1374000",
    "end": "1374000"
  },
  {
    "text": "but vulnerability or not the hard-coded creds are dead useful now I wrote a",
    "start": "1375980",
    "end": "1381200"
  },
  {
    "text": "couple of exploits that automate the uploading and configuration needed to take advantage of this non-vulnerability",
    "start": "1381200",
    "end": "1387559"
  },
  {
    "text": "here once again you see that we have a root shell via Metasploit uh and now Cisco Cisco did remove this",
    "start": "1387559",
    "end": "1394940"
  },
  {
    "text": "hard-coded credential from a more recent version of the boot image but since the ASA doesn't actually",
    "start": "1394940",
    "end": "1400400"
  },
  {
    "text": "prevent you from using older boot images I can't say that's a particularly useful mitigation and in my mind because you",
    "start": "1400400",
    "end": "1407840"
  },
  {
    "text": "can always use these boot images no matter their age this is sort of a forever day",
    "start": "1407840",
    "end": "1414460"
  },
  {
    "text": "now the problem with the previous attacks the assumed SSH access which is obviously not going to typically be",
    "start": "1415159",
    "end": "1423080"
  },
  {
    "text": "available for an attacker so I wanted to figure out some attacks that assumes no access to the device",
    "start": "1423080",
    "end": "1428360"
  },
  {
    "text": "whatsoever I want to modify the Firepower install packages to install malicious code and then get on winning",
    "start": "1428360",
    "end": "1434960"
  },
  {
    "text": "victims to install the malicious packages again let's talk about the boot image",
    "start": "1434960",
    "end": "1442100"
  },
  {
    "text": "so this is the scenario hackercat is totally on the outside no access to the esa just sitting out there in the cold",
    "start": "1442100",
    "end": "1449960"
  },
  {
    "text": "so I want to help hacker cat out help hacker cat out so I started looking at",
    "start": "1449960",
    "end": "1455240"
  },
  {
    "text": "the format of the boot image it turns out it's just a totally generic bootable Linux ISO like it's just a live CD you",
    "start": "1455240",
    "end": "1463700"
  },
  {
    "text": "can even execute it in VMware Fusion without any type of issues there's really nothing Cisco specific about the",
    "start": "1463700",
    "end": "1470419"
  },
  {
    "text": "Boo images format so I figured well why don't I just create my own Live CD my own bootable",
    "start": "1470419",
    "end": "1477679"
  },
  {
    "text": "ISO give that to an administrator get them to install it then the ASA should",
    "start": "1477679",
    "end": "1483559"
  },
  {
    "text": "boot the malicious ISO I created because my operating theory was that the Cisco provided Firepower boo image which is a",
    "start": "1483559",
    "end": "1490880"
  },
  {
    "text": "totally normal Live CD or whatever and usually stories like this have a lot",
    "start": "1490880",
    "end": "1497480"
  },
  {
    "text": "more to them which you tried what failed uh funny thing is this just simply works",
    "start": "1497480",
    "end": "1503059"
  },
  {
    "text": "I grabbed an existing script for creating tiny core Linux bootable isos I",
    "start": "1503059",
    "end": "1508880"
  },
  {
    "text": "added in a few features the ability to play Doom a reverse shell you know the",
    "start": "1508880",
    "end": "1514760"
  },
  {
    "text": "essentials and this script which I rebranded as Pinch Me generates a",
    "start": "1514760",
    "end": "1520880"
  },
  {
    "text": "malicious ISO that the ASA will happily Boot and assign IP addresses to there",
    "start": "1520880",
    "end": "1526340"
  },
  {
    "text": "was no trial and error because the ASA doesn't attempt to block this at all uh it appears to just be a feature of the",
    "start": "1526340",
    "end": "1533539"
  },
  {
    "text": "asax that it will boot arbitrary virtual machines but again this isn't a",
    "start": "1533539",
    "end": "1539360"
  },
  {
    "text": "vulnerability so remember there are no security case security expectations for",
    "start": "1539360",
    "end": "1545600"
  },
  {
    "text": "the boot image so we can craft our own boot images uh",
    "start": "1545600",
    "end": "1550760"
  },
  {
    "text": "distribute them as we'd like and once installed have our special root shell again",
    "start": "1550760",
    "end": "1556340"
  },
  {
    "text": "but the problem with the boot image is it doesn't persist through reboots so I",
    "start": "1556340",
    "end": "1561440"
  },
  {
    "text": "started looking at the install package for a more sustained attack now remember the install package is part",
    "start": "1561440",
    "end": "1568279"
  },
  {
    "text": "two of the Firepower module installation the install package is installed by and overwrites the boot image",
    "start": "1568279",
    "end": "1576380"
  },
  {
    "text": "so I was trying to figure out the format the boot image expects the install package to be in",
    "start": "1576380",
    "end": "1581779"
  },
  {
    "text": "pictured here's python taken directly from the boot image and you can see it expects the install package to be in the",
    "start": "1581779",
    "end": "1589220"
  },
  {
    "text": "form of encrypted content signed checksum package wrapper format which is a mouthful",
    "start": "1589220",
    "end": "1595400"
  },
  {
    "text": "I'm pretty sure it's actually a really secure format as far as I can tell and",
    "start": "1595400",
    "end": "1600799"
  },
  {
    "text": "again as far as I can tell is the only format Cisco has ever published the install package in",
    "start": "1600799",
    "end": "1607960"
  },
  {
    "text": "and this is what it looks like this isn't super important to know just note that it starts with this keyword key uh",
    "start": "1608000",
    "end": "1615140"
  },
  {
    "text": "very early on it also turns out that the boot image has this if clause for the Firepower",
    "start": "1615140",
    "end": "1621679"
  },
  {
    "text": "module that allows a second install package format and this format is check some package wrapper an utterly insecure",
    "start": "1621679",
    "end": "1629779"
  },
  {
    "text": "format no six no Cisco signatures on this one it only has checksums like we",
    "start": "1629779",
    "end": "1636380"
  },
  {
    "text": "saw with the asdm package which means in theory we should be able",
    "start": "1636380",
    "end": "1641600"
  },
  {
    "text": "to craft one of these check some install packages and uh give it to an administrator and get them to install it",
    "start": "1641600",
    "end": "1648140"
  },
  {
    "text": "resulting in boot shell access once again and after some really tedious reverse",
    "start": "1648140",
    "end": "1654620"
  },
  {
    "start": "1651000",
    "end": "1651000"
  },
  {
    "text": "engineering I did figure out that in Secure format again it's not important just note that the file no longer starts",
    "start": "1654620",
    "end": "1661880"
  },
  {
    "text": "with a key keyword it goes right in the data now the problem is that we actually need",
    "start": "1661880",
    "end": "1668419"
  },
  {
    "text": "the install package to do its job namely install a whole bunch of Cisco stuff and",
    "start": "1668419",
    "end": "1673640"
  },
  {
    "text": "overwrite the boot image otherwise the installation process will fail so it",
    "start": "1673640",
    "end": "1678799"
  },
  {
    "text": "isn't enough to know the insecure format we need the insecure checksum package to",
    "start": "1678799",
    "end": "1684200"
  },
  {
    "text": "also contain all the Cisco stuff as well uh otherwise the installation will not",
    "start": "1684200",
    "end": "1689900"
  },
  {
    "text": "succeed so I wrote a tool that does that this tool is called WhatsApp",
    "start": "1689900",
    "end": "1695539"
  },
  {
    "start": "1691000",
    "end": "1691000"
  },
  {
    "text": "it takes a valid and signed installation package unpackages it inserts malicious",
    "start": "1695539",
    "end": "1700700"
  },
  {
    "text": "code repackages it into the insecure format and then it's ready to be",
    "start": "1700700",
    "end": "1706460"
  },
  {
    "text": "installed by an unwitting victim the malicious code is just an init script basically it tries to connect to",
    "start": "1706460",
    "end": "1713179"
  },
  {
    "text": "an ipm4 of the attacker's choosing every five minutes or so and this init script",
    "start": "1713179",
    "end": "1718340"
  },
  {
    "text": "Will Survive reboot reboots and even upgrades so it's a pretty useful little attack all you need is to get someone to",
    "start": "1718340",
    "end": "1725720"
  },
  {
    "text": "install it for you but remember this isn't a vulnerability",
    "start": "1725720",
    "end": "1732020"
  },
  {
    "text": "but the result again if installed is hacker cat is back in the root shell this time with persistence again with",
    "start": "1732020",
    "end": "1739520"
  },
  {
    "text": "access to the protected Network access to the internet and access to the",
    "start": "1739520",
    "end": "1744980"
  },
  {
    "text": "traffic flowing through the VM now actually describe I actually attempted to describe this to Cisco as a",
    "start": "1744980",
    "end": "1752000"
  },
  {
    "text": "supply chain attack uh however they disagreed they pointed out that the Firepower module has a root",
    "start": "1752000",
    "end": "1758659"
  },
  {
    "text": "shell as a feature and a vendor could simply insert arbitrary code into the virtual machine",
    "start": "1758659",
    "end": "1764960"
  },
  {
    "text": "using that root shell so no malicious installation package is really required",
    "start": "1764960",
    "end": "1771980"
  },
  {
    "text": "I agreed with their original sentiment but to me that's a separate and also concerning supply chain attack but I",
    "start": "1771980",
    "end": "1778640"
  },
  {
    "text": "wasn't really able to win them over to my point of view so that's the the hacks I have for you",
    "start": "1778640",
    "end": "1785539"
  },
  {
    "text": "in this talk we talked about man in the middle problems credential leaks code signing issues package signing issues",
    "start": "1785539",
    "end": "1792200"
  },
  {
    "text": "root shells a feature hard-coded credentials for a root shell command injection for root access and executing",
    "start": "1792200",
    "end": "1799580"
  },
  {
    "text": "arbitrary bootable ISO many of these make the ASA a perfect little Trojan Horse",
    "start": "1799580",
    "end": "1806240"
  },
  {
    "text": "now having said that let's look at some indicators and possible mitigations real quick",
    "start": "1806240",
    "end": "1812779"
  },
  {
    "text": "the number one thing I was taken away from this talk is that this pictured here can never be done never can you use",
    "start": "1812779",
    "end": "1820039"
  },
  {
    "text": "asdm over the internet without potentially risking your ASA the man in the middle issue to my knowledge is not",
    "start": "1820039",
    "end": "1826220"
  },
  {
    "text": "slated to be fixed I would actually encourage you to stop using ASM altogether and to disable the asdm",
    "start": "1826220",
    "end": "1832399"
  },
  {
    "text": "feature on your Asa I've written a few Yara rules to help identify some of the attacks we've we've",
    "start": "1832399",
    "end": "1839179"
  },
  {
    "text": "talked about here one rule detects malicious asdm packages another gitex unsigned install packages and then there",
    "start": "1839179",
    "end": "1846620"
  },
  {
    "text": "are two that will look through the asdm log files for one for credentials and the other one will detect usage of",
    "start": "1846620",
    "end": "1853220"
  },
  {
    "text": "malicious sgz files uh and ideally I'd love to be able to",
    "start": "1853220",
    "end": "1859100"
  },
  {
    "text": "stand up here and give you guidance on patching however there's slew of issues",
    "start": "1859100",
    "end": "1864140"
  },
  {
    "text": "in this talk that are not considered vulnerabilities or are unpashed or their patch status isn't clear as of today so",
    "start": "1864140",
    "end": "1871580"
  },
  {
    "text": "uh when patching isn't an option we usually apply mitigating controls",
    "start": "1871580",
    "end": "1876880"
  },
  {
    "text": "isolate and limit access and that's not that easy because the ASA is a critical",
    "start": "1876880",
    "end": "1882140"
  },
  {
    "text": "system in your network at the very least like I said I disable asdm ensure that",
    "start": "1882140",
    "end": "1887899"
  },
  {
    "text": "we're auditing who is logging into the system we saw a number of password issues in this talk so rotating",
    "start": "1887899",
    "end": "1893899"
  },
  {
    "text": "passwords might be smart and finally when it comes to the asax with Firepower Services I actually think that root",
    "start": "1893899",
    "end": "1901100"
  },
  {
    "text": "shell feature is far too dangerous even without all the additional packaging issues that we discussed I'd personally",
    "start": "1901100",
    "end": "1908659"
  },
  {
    "text": "retire and replace those as soon as possible and be sure you have some idea what's going on in that root shell until",
    "start": "1908659",
    "end": "1915200"
  },
  {
    "text": "you're able to replace them uh so that's actually it that's uh all",
    "start": "1915200",
    "end": "1921679"
  },
  {
    "text": "the code I've talked about is up on GitHub uh a lot more code actually uh if you like this talk you can find me on",
    "start": "1921679",
    "end": "1928399"
  },
  {
    "text": "the normal social media sites if you don't like the talk don't find me there",
    "start": "1928399",
    "end": "1933830"
  },
  {
    "text": "[Music]",
    "start": "1933830",
    "end": "1936940"
  },
  {
    "text": "[Music]",
    "start": "1940780",
    "end": "1943890"
  }
]