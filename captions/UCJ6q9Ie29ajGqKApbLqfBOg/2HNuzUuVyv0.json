[
  {
    "text": "all right welcome everyone this presentation is called Red Team techniques for evading bypassing and",
    "start": "0",
    "end": "6450"
  },
  {
    "text": "disabling Microsoft advanced threat protection and advanced threat analytics so this picture I'm from Canada and I",
    "start": "6450",
    "end": "14849"
  },
  {
    "text": "always love this picture this is from the IBM Toronto downtown data center",
    "start": "14849",
    "end": "19980"
  },
  {
    "text": "from 1963 but now it's actually a sushi restaurant so I'm rep bandit I'm the red",
    "start": "19980",
    "end": "28920"
  },
  {
    "text": "teaming ops lead 4x4 shred part of the",
    "start": "28920",
    "end": "35309"
  },
  {
    "text": "crest board for crest USA and I like being in Europe because crest actually means something here where nobody's",
    "start": "35309",
    "end": "41219"
  },
  {
    "text": "heard of it in North America I conduct",
    "start": "41219",
    "end": "47010"
  },
  {
    "text": "red teaming operations against defense contractors and some of North America's largest banks so I don't actually do red",
    "start": "47010",
    "end": "53399"
  },
  {
    "text": "teaming of IBM but for IBM so why this talk on Microsoft advanced analytics and",
    "start": "53399",
    "end": "60840"
  },
  {
    "text": "advanced threat protection well when you're testing really mature companies I've come against really good that's",
    "start": "60840",
    "end": "67460"
  },
  {
    "text": "defensive strategies and detection strategies at clients they've integrated",
    "start": "67460",
    "end": "72570"
  },
  {
    "text": "tools like system on an app Locker and a met and they're using Windows Event log",
    "start": "72570",
    "end": "78000"
  },
  {
    "text": "forwarding they've been implemented products like CrowdStrike and silence for host behavior analytics products",
    "start": "78000",
    "end": "85020"
  },
  {
    "text": "like rapid 7 user insights for domain behavior analytics and I've spent a lot",
    "start": "85020",
    "end": "90630"
  },
  {
    "text": "of time figuring how to bypass or evade them as a whole and when I saw that Microsoft was coming out with both host",
    "start": "90630",
    "end": "97650"
  },
  {
    "text": "and domain based behavior analytics tools and that ATP or advanced threat",
    "start": "97650",
    "end": "102750"
  },
  {
    "text": "protection was actually built into Windows 10 itself I knew this was an",
    "start": "102750",
    "end": "107790"
  },
  {
    "text": "area that as attackers we needed to spend a lot more time on especially",
    "start": "107790",
    "end": "113670"
  },
  {
    "text": "since both products are actually in the process of being integrated to under the",
    "start": "113670",
    "end": "119880"
  },
  {
    "text": "the advanced threat protection brand so I gave an original version of this talk",
    "start": "119880",
    "end": "126390"
  },
  {
    "text": "back at DEFCON which is the first talk on ATP and the second on ata as Nikhil",
    "start": "126390",
    "end": "133230"
  },
  {
    "text": "had done it gan ata like a day before mine but since then I've upgraded and heavily revised",
    "start": "133230",
    "end": "138870"
  },
  {
    "text": "this talk because new versions have come out so they fixed a lot of the bypasses that I found back then so I've had to",
    "start": "138870",
    "end": "145110"
  },
  {
    "text": "find more but there's probably a lot of techniques I haven't tested or found or",
    "start": "145110",
    "end": "150209"
  },
  {
    "text": "didn't think of so hopefully it inspires you to get you know familiar with these tools yourself so to set the stage when",
    "start": "150209",
    "end": "157319"
  },
  {
    "text": "I developed IBM x-force Reds TTP's or taktik technical tactical techniques and",
    "start": "157319",
    "end": "163590"
  },
  {
    "text": "procedures for red teaming I put a huge emphasis on hosts recon and internal",
    "start": "163590",
    "end": "169019"
  },
  {
    "text": "recon being two very distinct phases which will go into why in a bit but as",
    "start": "169019",
    "end": "175410"
  },
  {
    "text": "as red teamers when we're operating against really mature blue teams we need",
    "start": "175410",
    "end": "180690"
  },
  {
    "text": "to gain a solid understanding of what indicators are compromised our tools and techniques are leaving behind what",
    "start": "180690",
    "end": "186480"
  },
  {
    "text": "commands might be caught by script logging what's flag de belen system on and importantly how we can learn to use",
    "start": "186480",
    "end": "192000"
  },
  {
    "text": "techniques that avoid user behavior analytics because machine learnings you",
    "start": "192000",
    "end": "197370"
  },
  {
    "text": "know coming down the pipes and and lot of companies are going to be implementing better behavior analytics",
    "start": "197370",
    "end": "202739"
  },
  {
    "text": "than what's been out there in the past so here's a quick overview of advanced",
    "start": "202739",
    "end": "207750"
  },
  {
    "text": "threat protection or Windows Defender advanced tent protection it's currently active on more than 2 million devices I",
    "start": "207750",
    "end": "214470"
  },
  {
    "text": "think most of those are at Microsoft itself but this is the cloud ATP",
    "start": "214470",
    "end": "220290"
  },
  {
    "text": "dashboard that the sensors report into it's very similar to other dashboards you've seen out there for products like",
    "start": "220290",
    "end": "226139"
  },
  {
    "text": "CrowdStrike the difference with ATP is like I mentioned it's actually embedded",
    "start": "226139",
    "end": "231209"
  },
  {
    "text": "into Windows 10 Enterprise so there's there's no real you know it's not hard",
    "start": "231209",
    "end": "237630"
  },
  {
    "text": "to to activate and install this on a Windows 10 desktop because it's already",
    "start": "237630",
    "end": "243090"
  },
  {
    "text": "installed it's just a matter of running a quick script to activate the functionality release 3 recently came",
    "start": "243090",
    "end": "249989"
  },
  {
    "text": "bundled with the Windows 10 1709 or fall creators or autumn update for you in the",
    "start": "249989",
    "end": "257099"
  },
  {
    "text": "UK so it it came bundled on I believe",
    "start": "257099",
    "end": "262200"
  },
  {
    "text": "October 17th for the latest version and then the next versions gonna be coming out in this",
    "start": "262200",
    "end": "267570"
  },
  {
    "text": "spring so these sensors that are embedded in Windows 10 they collect behavioral signals from the box like",
    "start": "267570",
    "end": "274820"
  },
  {
    "text": "processes that are running changes to the registry file changes network",
    "start": "274820",
    "end": "280620"
  },
  {
    "text": "communications and they send all the sensor data to the cloud and then Microsoft's intelligence security graph",
    "start": "280620",
    "end": "287060"
  },
  {
    "text": "applies behavioral learning to it too to analyze the data that's coming from all",
    "start": "287060",
    "end": "292830"
  },
  {
    "text": "these different sensors so as of last month's while creators update the",
    "start": "292830",
    "end": "299190"
  },
  {
    "text": "Windows Defender brand was a include expanded to include not only the",
    "start": "299190",
    "end": "304530"
  },
  {
    "text": "traditional Windows Defender that we all love and hate it's now defender ATP",
    "start": "304530",
    "end": "310790"
  },
  {
    "text": "defender exploit guard which was previously omit if you've ever used that",
    "start": "310790",
    "end": "315980"
  },
  {
    "text": "application guard device guard credential guard and it's actually been",
    "start": "315980",
    "end": "321510"
  },
  {
    "text": "expanded to start to cover Windows Server 2012 r2 and 2016 it's also being",
    "start": "321510",
    "end": "328610"
  },
  {
    "text": "expanded to work with other products too that are running on Linux so it can take",
    "start": "328610",
    "end": "337110"
  },
  {
    "text": "any behavioral data from other third-party products and crunch that in the cloud as well and then deep",
    "start": "337110",
    "end": "344610"
  },
  {
    "text": "integration with advanced threat analytics the other product we'll be talking about today is coming in the",
    "start": "344610",
    "end": "349980"
  },
  {
    "text": "fall we're starting in the spring of next year so here's the release tree",
    "start": "349980",
    "end": "356100"
  },
  {
    "text": "dashboard I mentioned it right if we look in the bottom right corner we'll see the entire new Windows 10 security",
    "start": "356100",
    "end": "362280"
  },
  {
    "text": "stack all reporting into a single dashboard and this is interesting from a attackers perspective because before all",
    "start": "362280",
    "end": "369420"
  },
  {
    "text": "of this data was just mostly sitting on the box we didn't have to worry about somebody forwarding it off the box we",
    "start": "369420",
    "end": "376230"
  },
  {
    "text": "didn't worry about omit alerting on us but now it's all easily reporting into",
    "start": "376230",
    "end": "381390"
  },
  {
    "text": "the blue team so it makes adoption of you know a better defensive strategy a",
    "start": "381390",
    "end": "388020"
  },
  {
    "text": "lot easier for these these blue teams and then in release 4 just quickly this",
    "start": "388020",
    "end": "395010"
  },
  {
    "text": "is what's coming in the spring so Auto remediation so it's going to use windows firewall and the exploit guard",
    "start": "395010",
    "end": "403479"
  },
  {
    "text": "and app guard and all these different security tools in the security stack to block other threats across the",
    "start": "403479",
    "end": "409239"
  },
  {
    "text": "enterprise so it detects an attack on one it's gonna automatically say apply firewall rules to block c2 for any",
    "start": "409239",
    "end": "415959"
  },
  {
    "text": "malware to all endpoints so let's actually look at ATP in play here's with",
    "start": "415959",
    "end": "425439"
  },
  {
    "text": "just a basic launcher download cradle from PowerShell Empire or cobalt strike",
    "start": "425439",
    "end": "431469"
  },
  {
    "text": "you can see it's encoded it's going to detect that pretty easily it's also",
    "start": "431469",
    "end": "437529"
  },
  {
    "text": "going to detect really heavily heavy heavily office gated PowerShell commands and ones that we generate ourselves",
    "start": "437529",
    "end": "444699"
  },
  {
    "text": "using say the obfuscated Empire project this particular one was a custom cradle",
    "start": "444699",
    "end": "450879"
  },
  {
    "text": "from cobalt strike with a reverse DNS payload and the reason they can detect",
    "start": "450879",
    "end": "457599"
  },
  {
    "text": "this so so Microsoft gave us a really amazing framework with PowerShell as attackers",
    "start": "457599",
    "end": "462639"
  },
  {
    "text": "we've been favoring using PowerShell Exe a PowerShell exe the PowerShell core and",
    "start": "462639",
    "end": "468189"
  },
  {
    "text": "the underlying Windows management framework for several years because of its flexibility and ease of use so we've",
    "start": "468189",
    "end": "473769"
  },
  {
    "text": "been using awesome tools that have come out that leverage PowerShell like PowerShell Empire powerup unmanaged",
    "start": "473769",
    "end": "480789"
  },
  {
    "text": "PowerShell not PowerShell powersploit and the sharing power view user hunter",
    "start": "480789",
    "end": "486219"
  },
  {
    "text": "and bloodhound so a lot of you guys will be familiar with those tools but once we",
    "start": "486219",
    "end": "491229"
  },
  {
    "text": "had got all our tools focused on PowerShell then Microsoft implemented all of this logging and all these",
    "start": "491229",
    "end": "498039"
  },
  {
    "text": "different security features within PowerShell to kind of take our new shiny tools away by implementing all these new",
    "start": "498039",
    "end": "506740"
  },
  {
    "text": "security improvements so what are some of these improvements if we look at with the windows management framework or",
    "start": "506740",
    "end": "513159"
  },
  {
    "text": "PowerShell version 5 that includes script lock logging transaction and transcription logging it Flags on",
    "start": "513159",
    "end": "520000"
  },
  {
    "text": "suspicious strings like - and C it can",
    "start": "520000",
    "end": "525519"
  },
  {
    "text": "implement constrain language mode and it contains just enough administration support as a",
    "start": "525519",
    "end": "532540"
  },
  {
    "text": "as most people have been avoiding powershell version 5 by just calling powershell version 2 which didn't have",
    "start": "532540",
    "end": "538810"
  },
  {
    "text": "any of this and that was installed by default so even if defenders had upgraded and installed powershell",
    "start": "538810",
    "end": "545949"
  },
  {
    "text": "version 5 in the past powershell version two remained installed even unless they",
    "start": "545949",
    "end": "551380"
  },
  {
    "text": "specifically uninstall it but in Windows 10 1709 or the fall creators update",
    "start": "551380",
    "end": "558279"
  },
  {
    "text": "they've removed support for powershell version 2 altogether so you can't install it if you wanted to as an",
    "start": "558279",
    "end": "564459"
  },
  {
    "text": "attacker they've they've put in we'll",
    "start": "564459",
    "end": "570519"
  },
  {
    "text": "talk about that a minute they've put in ways to not only detect powershell",
    "start": "570519",
    "end": "577440"
  },
  {
    "text": "malicious commands but also windows scripting host vbscript and javascript",
    "start": "577440",
    "end": "583720"
  },
  {
    "text": "based attacks if you try to use tools like bent ends not powershell which",
    "start": "583720",
    "end": "589839"
  },
  {
    "text": "basically is just a front end wrapper to talk to the backend windows management framework that's also gonna be caught",
    "start": "589839",
    "end": "596079"
  },
  {
    "text": "because the commands still need to be sent to the backend windows management framework version 5 and we've seen",
    "start": "596079",
    "end": "602170"
  },
  {
    "text": "bypasses for a lot of these like covers yes amp c tool or different comm",
    "start": "602170",
    "end": "607360"
  },
  {
    "text": "techniques but red teamers really need to streamline and chain all those bypasses together to actually get code",
    "start": "607360",
    "end": "614709"
  },
  {
    "text": "execution on the box get a reverse shell and start to run commands all without being detected so that's actually pretty",
    "start": "614709",
    "end": "621550"
  },
  {
    "text": "difficult to do so as a result of these improvements we really need to go back to living off the land selectively",
    "start": "621550",
    "end": "628630"
  },
  {
    "text": "running powershell only after we're confident that we've disabled ATP and other next gen antivirus products the",
    "start": "628630",
    "end": "637810"
  },
  {
    "text": "the real powerhouse security I'd say technology that",
    "start": "637810",
    "end": "646300"
  },
  {
    "text": "Microsoft is put out lately is amp C or the anti-malware scanning interface and this is the reason that everything's",
    "start": "646300",
    "end": "652540"
  },
  {
    "text": "being caught because before so the MC",
    "start": "652540",
    "end": "658240"
  },
  {
    "text": "basically hooks the Windows scripting host so before an interpreter runs these",
    "start": "658240",
    "end": "663250"
  },
  {
    "text": "malicious commands everything is the office key everything's in plain text and it's",
    "start": "663250",
    "end": "669420"
  },
  {
    "text": "gonna catch dynamic Java vbscript and PowerShell code before it's executed began its run before run through the",
    "start": "669420",
    "end": "676350"
  },
  {
    "text": "Windows Defender there's an article that was just put out two days ago if you",
    "start": "676350",
    "end": "681480"
  },
  {
    "text": "want to have a look more into em see it's also pretty good at detecting using",
    "start": "681480",
    "end": "687060"
  },
  {
    "text": "sign binaries to launch malicious executables based on abnormal behavior like connecting to a recently registered",
    "start": "687060",
    "end": "694320"
  },
  {
    "text": "domain or connecting out to tour using vbscript within a macro enabled document",
    "start": "694320",
    "end": "700079"
  },
  {
    "text": "for example and you can see based on some of these alert examples that any of",
    "start": "700079",
    "end": "705720"
  },
  {
    "text": "the initial execution execution host recon and privilege escalation",
    "start": "705720",
    "end": "710760"
  },
  {
    "text": "activities are going to be flagged due to the underlying techniques used but so",
    "start": "710760",
    "end": "717600"
  },
  {
    "text": "you can get on a box initially undetected using say PowerShell Empire but the name of the game is to not get",
    "start": "717600",
    "end": "724140"
  },
  {
    "text": "caught so early so instead we want to use basically we want to use on office",
    "start": "724140",
    "end": "731490"
  },
  {
    "text": "gated JavaScript or VB script payloads that don't have kernel32 API declarations in them we want to use",
    "start": "731490",
    "end": "738529"
  },
  {
    "text": "signed execs to load payloads like cobalt strikes staged lists DNS payload and then we",
    "start": "738529",
    "end": "748620"
  },
  {
    "text": "want to you know whenever possible use things like veil and Ebola and shelter",
    "start": "748620",
    "end": "754620"
  },
  {
    "text": "to key you our malware whenever possible and encrypt it and so some some",
    "start": "754620",
    "end": "761160"
  },
  {
    "text": "techniques with some payloads created with veil won't be detected but now that",
    "start": "761160",
    "end": "769079"
  },
  {
    "text": "we're on the Box the challenge doesn't stop when we get on the Box undetected initially that's the easy part the",
    "start": "769079",
    "end": "775680"
  },
  {
    "text": "problem is detection of activities that we perform after we get on the box so tools and commands that are running like",
    "start": "775680",
    "end": "782760"
  },
  {
    "text": "creating a new process or doing host recon and environmental settings or local groups maybe we want to attempt to",
    "start": "782760",
    "end": "790380"
  },
  {
    "text": "bypass host controls like app Locker and omit and UAC and power shell constrain",
    "start": "790380",
    "end": "796560"
  },
  {
    "text": "language mode and amp C and whatnot we want to perform privilege escalation",
    "start": "796560",
    "end": "803429"
  },
  {
    "text": "to go from a regular user to admin on the box so all of these are commands",
    "start": "803429",
    "end": "809039"
  },
  {
    "text": "that we have to worry about getting detected on so as red teamers a lot of these will look pretty familiar to you",
    "start": "809039",
    "end": "815609"
  },
  {
    "text": "they're just hosts recon host information gathering a lot of those are gonna be flagged by ATP because that's",
    "start": "815609",
    "end": "823589"
  },
  {
    "text": "pretty suspicious that a regular users running those commands but not detected",
    "start": "823589",
    "end": "829470"
  },
  {
    "text": "is the windows management interface or WMI we can run the WMI command line W",
    "start": "829470",
    "end": "837149"
  },
  {
    "text": "make or we can run the we can call the underlying W my schema directly using",
    "start": "837149",
    "end": "843599"
  },
  {
    "text": "different classes like we see at the bottom there so in release four in the spring allegedly they're coming out with",
    "start": "843599",
    "end": "850559"
  },
  {
    "text": "a lot of improved WMI detections but we'll see how they do with that but right now W my is your best bet",
    "start": "850559",
    "end": "858949"
  },
  {
    "text": "also if you directly call windows api's and really return to living off the land",
    "start": "859289",
    "end": "865369"
  },
  {
    "text": "we can call windows api's through raw sockets with meterpreter such as the",
    "start": "865369",
    "end": "870659"
  },
  {
    "text": "Metasploit post module that use windows api is via railgun we can use cobalt",
    "start": "870659",
    "end": "877919"
  },
  {
    "text": "strike a number of cobalt strike mode modules or api only but before you run",
    "start": "877919",
    "end": "883169"
  },
  {
    "text": "these commands you want to make sure they actually are making just local calls and they aren't a combination of",
    "start": "883169",
    "end": "889859"
  },
  {
    "text": "local calls and Network calls like local admins search you know another",
    "start": "889859",
    "end": "897319"
  },
  {
    "text": "interesting way I saw that that was we could get on a box but not only get out",
    "start": "897319",
    "end": "903720"
  },
  {
    "text": "of box we could even as a regular user maintain persistence on the box after",
    "start": "903720",
    "end": "909239"
  },
  {
    "text": "the box is rebooted was through comm hijacking so I watched a talk by sub T and enigma",
    "start": "909239",
    "end": "914939"
  },
  {
    "text": "at Wild West hacking fest last month and it got me curious to look at where ATP",
    "start": "914939",
    "end": "921749"
  },
  {
    "text": "might be vulnerable or other opportunities to hijack comm and Windows 10 so after a few hours and a few drinks",
    "start": "921749",
    "end": "928829"
  },
  {
    "text": "with them I found several new comm hijacks in Windows 10 which can be used to get various",
    "start": "928829",
    "end": "934699"
  },
  {
    "text": "processes to run our malware for us so what is calm so for the sake of time I",
    "start": "934699",
    "end": "940850"
  },
  {
    "text": "won't go into too much detail but and you can look at James for Shaw's troopers talked earlier this year or the",
    "start": "940850",
    "end": "947180"
  },
  {
    "text": "windows archaeology talked by a KC map but all you really need to know is that when a pro sets loads it uses calm to",
    "start": "947180",
    "end": "954980"
  },
  {
    "text": "register and reference objects and settings within the Windows registry so",
    "start": "954980",
    "end": "960559"
  },
  {
    "text": "there are several registry hives that you'll probably be familiar with there's",
    "start": "960559",
    "end": "965929"
  },
  {
    "text": "H key local machine which only admins and system can write to then there's an H key current user which any user the",
    "start": "965929",
    "end": "972769"
  },
  {
    "text": "current user can write to and these actually blend when you log into Windows",
    "start": "972769",
    "end": "978259"
  },
  {
    "text": "they blend into a virtual hive called the HK current route so if we can find",
    "start": "978259",
    "end": "986689"
  },
  {
    "text": "instances where comm is loading settings from the current user registry and those",
    "start": "986689",
    "end": "994490"
  },
  {
    "text": "settings don't exist in HK local machine those will be populated up to HK crk",
    "start": "994490",
    "end": "1001600"
  },
  {
    "text": "current route so as an unprivileged user we can register those missing registry keys and",
    "start": "1001600",
    "end": "1008439"
  },
  {
    "text": "have a process run our malicious payload so in this example we see references to",
    "start": "1008439",
    "end": "1015610"
  },
  {
    "text": "HK current route from various programs and you'll see that those keys weren't",
    "start": "1015610",
    "end": "1022600"
  },
  {
    "text": "found so that's where using tools like process monitor we can identify these",
    "start": "1022600",
    "end": "1028298"
  },
  {
    "text": "missing column entries and hi Jacqueline so here's a basic script which basically",
    "start": "1028299",
    "end": "1035250"
  },
  {
    "text": "crates defines a new comm class ID within current user and defends a comm",
    "start": "1035250",
    "end": "1042250"
  },
  {
    "text": "scriptlet URL for the class so that scriptlet URL that we see at the bottom attacker slash payload SCT that's",
    "start": "1042250",
    "end": "1050049"
  },
  {
    "text": "actually just an XML file that contains our payload written in VB or J script we",
    "start": "1050049",
    "end": "1058480"
  },
  {
    "text": "could also instead of targeting",
    "start": "1058480",
    "end": "1063210"
  },
  {
    "text": "the treat has moniker we can target stuff like monikers like Proctor of 32",
    "start": "1063660",
    "end": "1069690"
  },
  {
    "text": "and just have them run a DLL instead so lots of different keys are vulnerable to",
    "start": "1069690",
    "end": "1075450"
  },
  {
    "text": "this or can be abused by this and here's the simplified view for those that have",
    "start": "1075450",
    "end": "1081900"
  },
  {
    "text": "been in the Windows registry before we're basically defining our payload and our new class called ac/dc just by",
    "start": "1081900",
    "end": "1088830"
  },
  {
    "text": "sub-team and then we're filling in that missing registry key which will be",
    "start": "1088830",
    "end": "1094590"
  },
  {
    "text": "populated up to current route so we're basically saying for this",
    "start": "1094590",
    "end": "1101190"
  },
  {
    "text": "missing key treat is treated as our malicious class and execute our malicious payload and now when we even",
    "start": "1101190",
    "end": "1110430"
  },
  {
    "text": "after reboot various processes are going to load our malicious payload from either HP current user or HP current",
    "start": "1110430",
    "end": "1117270"
  },
  {
    "text": "route and it will run our payloads you know for example 50 instances of calc",
    "start": "1117270",
    "end": "1123360"
  },
  {
    "text": "when I'm testing but any medium integrity process that calls this missing column object is going to run",
    "start": "1123360",
    "end": "1129420"
  },
  {
    "text": "our malware for us and we can create that malware using James's dotnet to",
    "start": "1129420",
    "end": "1135240"
  },
  {
    "text": "jscript or we can just call a malicious DLL instead the best part of this",
    "start": "1135240",
    "end": "1144240"
  },
  {
    "text": "technique is that you can use it to bypass MC because MC only triggers on",
    "start": "1144240",
    "end": "1150470"
  },
  {
    "text": "eval or dynamic script creation for Windows scripting host so all of those",
    "start": "1150470",
    "end": "1155690"
  },
  {
    "text": "improvements to vbscript and jscript that ATP relies on for detection aren't",
    "start": "1155690",
    "end": "1162390"
  },
  {
    "text": "triggered so now we're at a point where we have persistence on the box and we",
    "start": "1162390",
    "end": "1168750"
  },
  {
    "text": "can run whatever we want against the box let's look at how we can kill ATP",
    "start": "1168750",
    "end": "1175830"
  },
  {
    "text": "altogether after we've managed to maybe elevate to admit so unlike other",
    "start": "1175830",
    "end": "1182760"
  },
  {
    "text": "antiviruses we can't just use these common techniques to kill antivirus a",
    "start": "1182760",
    "end": "1188150"
  },
  {
    "text": "lot of these won't work even as an admin",
    "start": "1188150",
    "end": "1193190"
  },
  {
    "text": "you could maybe modify file permissions on log but that's very noisy and easy to detect",
    "start": "1193490",
    "end": "1201150"
  },
  {
    "text": "unlike other cloud AV or next-gen AV products like CrowdStrike you can't just uninstall them from an elevated command",
    "start": "1201150",
    "end": "1207720"
  },
  {
    "text": "prompt ATP requires an a generated off-boarding script with a sha-256 sign",
    "start": "1207720",
    "end": "1214650"
  },
  {
    "text": "key based on the unique org ID and certificate and the reason as an admin",
    "start": "1214650",
    "end": "1220440"
  },
  {
    "text": "you can't stop ATP is because of protected process light so ppl was a",
    "start": "1220440",
    "end": "1225960"
  },
  {
    "text": "mechanism that came out in Windows 8.1 that transferred many of the security restrictions apply to system processes",
    "start": "1225960",
    "end": "1233100"
  },
  {
    "text": "to user remote processes so the binary is actually signed by a Windows signing cert and the Windows ppl verification",
    "start": "1233100",
    "end": "1241650"
  },
  {
    "text": "extended key use is in the bottom right there so after the services launch has launched as protected Windows uses code",
    "start": "1241650",
    "end": "1248850"
  },
  {
    "text": "integrity to not only allow trusts to only allow trusted code to be injected",
    "start": "1248850",
    "end": "1254070"
  },
  {
    "text": "into these processes so you know we can't use say me me cats to inject into",
    "start": "1254070",
    "end": "1259350"
  },
  {
    "text": "L SAS if alsace is running as a ppl for example so if you want to know more",
    "start": "1259350",
    "end": "1265440"
  },
  {
    "text": "about ppl zelich sionis you covered them extensively in an older blog post but until now we actually haven't seen t pls",
    "start": "1265440",
    "end": "1272310"
  },
  {
    "text": "widely implemented at all there was a ppl bypass for traditional",
    "start": "1272310",
    "end": "1280140"
  },
  {
    "text": "Windows Defender because defender can be",
    "start": "1280140",
    "end": "1285510"
  },
  {
    "text": "modified by trusted installer only basically project zeros bypass was to",
    "start": "1285510",
    "end": "1292460"
  },
  {
    "text": "set the bin path of trusted installer to",
    "start": "1292460",
    "end": "1297960"
  },
  {
    "text": "stop Windows Defender and delete Windows Defender and then start the service up again but since released - they've",
    "start": "1297960",
    "end": "1304980"
  },
  {
    "text": "changed a TP - now run as a Windows ppl protection level instead of anti-male or",
    "start": "1304980",
    "end": "1310410"
  },
  {
    "text": "ppl and the process is configured as not stoppable so we can't use the same technique against a TP and there's an",
    "start": "1310410",
    "end": "1318810"
  },
  {
    "text": "alert that'll come up if you do try to use it against a TV",
    "start": "1318810",
    "end": "1323300"
  },
  {
    "text": "so this is this is a good quote by Matt it's basically stating that as an",
    "start": "1325130",
    "end": "1332880"
  },
  {
    "text": "attacker you know we we have to not only get on a box initially we have to become",
    "start": "1332880",
    "end": "1338160"
  },
  {
    "text": "admin and we have to bypass all the logging out there so as a defender you have so many opportunities to detect",
    "start": "1338160",
    "end": "1344940"
  },
  {
    "text": "attackers even if they have admin on a box you want to watch out for them you know blocking Windows Event log",
    "start": "1344940",
    "end": "1351690"
  },
  {
    "text": "forwarding and bypassing all those controls we talked about so using some",
    "start": "1351690",
    "end": "1357540"
  },
  {
    "text": "privileged techniques in release two we can't stop ATP anymore because it's",
    "start": "1357540",
    "end": "1364110"
  },
  {
    "text": "running as a ppl and a protective process or sorry in release two it wasn't",
    "start": "1364110",
    "end": "1370550"
  },
  {
    "text": "now diag track is running as a ppl and Diet track is the service that ATP uses",
    "start": "1370550",
    "end": "1379050"
  },
  {
    "text": "to communicate out to the windows cloud so it's the windows telemetry service and in in release two we could just stop",
    "start": "1379050",
    "end": "1386790"
  },
  {
    "text": "that service and prevent anything from connecting out to the cloud since then Microsoft's fix that and also made the",
    "start": "1386790",
    "end": "1395280"
  },
  {
    "text": "telemetry service of ppl that we can't stop but they didn't flag it as not",
    "start": "1395280",
    "end": "1403920"
  },
  {
    "text": "stoppable so we can use that same Windows Defender ppl bypass to stop it by just changing the location of its bin",
    "start": "1403920",
    "end": "1412740"
  },
  {
    "text": "file to to something non-existent as an admin we don't have permissions to",
    "start": "1412740",
    "end": "1418890"
  },
  {
    "text": "rename or delete the HTTP binaries however it is vulnerable to DLL hijacking",
    "start": "1418890",
    "end": "1424110"
  },
  {
    "text": "so since CNC proxy is just the communication module of ATP and its",
    "start": "1424110",
    "end": "1432240"
  },
  {
    "text": "supposed to load the Windows HTTP services DLL from system 32 but it",
    "start": "1432240",
    "end": "1438390"
  },
  {
    "text": "actually checks within its own folder first for that DLL so as an admin though",
    "start": "1438390",
    "end": "1444540"
  },
  {
    "text": "we can't delete sense proxy exe we can create DLLs in in the program folder and",
    "start": "1444540",
    "end": "1452429"
  },
  {
    "text": "so we can you know either create non-existent dll's",
    "start": "1452429",
    "end": "1457890"
  },
  {
    "text": "or we can create malicious dll's in there and that'll hijack the communication flow because sense proxy",
    "start": "1457890",
    "end": "1464850"
  },
  {
    "text": "is called every five minutes to communicate to the cloud so if it loads our DLL instead it won't actually",
    "start": "1464850",
    "end": "1470040"
  },
  {
    "text": "successfully load and it's just gonna crash as we see at the bottom there",
    "start": "1470040",
    "end": "1476990"
  },
  {
    "text": "another way to remove ppl protection for",
    "start": "1477620",
    "end": "1482970"
  },
  {
    "text": "a process and this wasn't very well documented at all in me me cots it was",
    "start": "1482970",
    "end": "1488790"
  },
  {
    "text": "originally created so you could remove ppl protection from Alsace in Windows 10",
    "start": "1488790",
    "end": "1494850"
  },
  {
    "text": "s but we can actually use that to remove process ppl protection from MS sense or",
    "start": "1494850",
    "end": "1502530"
  },
  {
    "text": "the HTTP executable and just kill it outright since then the Mimi cots driver is now",
    "start": "1502530",
    "end": "1514470"
  },
  {
    "text": "registered as malicious by ATP so it's actually what it's actually assigned",
    "start": "1514470",
    "end": "1519990"
  },
  {
    "text": "driver the Benjamin created and it loads",
    "start": "1519990",
    "end": "1525240"
  },
  {
    "text": "as Mimi drive so we can go into Mimi drive and we can change what it's",
    "start": "1525240",
    "end": "1530910"
  },
  {
    "text": "loading as we can you know we can say it it loads as anything we want the problem is this is a signed binary and it it",
    "start": "1530910",
    "end": "1543330"
  },
  {
    "text": "requires a valid kernel evey code signing cert to sign it so for most",
    "start": "1543330",
    "end": "1549450"
  },
  {
    "text": "people that's out of their realm of possibility because they have to first register a company and then they have to",
    "start": "1549450",
    "end": "1556230"
  },
  {
    "text": "have Microsoft or a edy certificate authority do some extended checks to",
    "start": "1556230",
    "end": "1563280"
  },
  {
    "text": "make sure that it's a legitimate company in that you actually work for it so as you know IBM obviously has access to",
    "start": "1563280",
    "end": "1569160"
  },
  {
    "text": "lots of code signing certs but for the average person not only is it difficult to get one but it's really hard to avoid",
    "start": "1569160",
    "end": "1575640"
  },
  {
    "text": "at attrition because you know they can easily see who created that certificate",
    "start": "1575640",
    "end": "1581210"
  },
  {
    "text": "it now also alerts on ppl tampering so if we removed process protection and",
    "start": "1581210",
    "end": "1587160"
  },
  {
    "text": "then there's the service restarted it's going to flag that we can get around that after Ms sense is",
    "start": "1587160",
    "end": "1594660"
  },
  {
    "text": "killed by just again changing the bin path but there's a lot easy there's a",
    "start": "1594660",
    "end": "1599910"
  },
  {
    "text": "much better way out there so we can use James for chess technique to become",
    "start": "1599910",
    "end": "1604980"
  },
  {
    "text": "trusted installer from admin and then once we're trusted installer we can have",
    "start": "1604980",
    "end": "1612120"
  },
  {
    "text": "write permissions to the program files directory and we can just rename atps executables to whatever we like so",
    "start": "1612120",
    "end": "1620510"
  },
  {
    "text": "that's a much cleaner way to do it and it won't be flagged by ATP but my",
    "start": "1620510",
    "end": "1627660"
  },
  {
    "text": "preferred technique is to make Microsoft turn the gun on itself so here's a snippet from my PowerShell script I put",
    "start": "1627660",
    "end": "1634650"
  },
  {
    "text": "together it's on my github basically all it does is resolve all the hosts that",
    "start": "1634650",
    "end": "1640080"
  },
  {
    "text": "Microsoft's communicating or ATP is communicating to in the cloud and just",
    "start": "1640080",
    "end": "1646170"
  },
  {
    "text": "adds a firewall rule to block them and the great thing about this technique is",
    "start": "1646170",
    "end": "1651330"
  },
  {
    "text": "you can also use this to block Windows Event log forwarding to block like system on and Pskov and you can just",
    "start": "1651330",
    "end": "1658980"
  },
  {
    "text": "base it on a port or a service instead of an IP but but this is a easy way to do it and I think that's actually the",
    "start": "1658980",
    "end": "1666630"
  },
  {
    "text": "best approach because that really can't be fixed nobody is going to be",
    "start": "1666630",
    "end": "1672560"
  },
  {
    "text": "preventing people from creating firewall rules unless they specifically done it",
    "start": "1672560",
    "end": "1677670"
  },
  {
    "text": "in group policy it doesn't require escalating the system to modify file",
    "start": "1677670",
    "end": "1682920"
  },
  {
    "text": "permissions or find a ppl bypass doesn't require creating some new signed kernel",
    "start": "1682920",
    "end": "1688410"
  },
  {
    "text": "module and now that we've blocked ATP and event log forwarding and system on",
    "start": "1688410",
    "end": "1694410"
  },
  {
    "text": "and all that we really don't care what we've done against the local box the",
    "start": "1694410",
    "end": "1701660"
  },
  {
    "text": "problem comes when organizations are using other products to manage the firewall like McAfee hips so if that's",
    "start": "1701660",
    "end": "1708960"
  },
  {
    "text": "the case you'd have to use one of the other techniques because we can't actually modify the firewall rules in",
    "start": "1708960",
    "end": "1716160"
  },
  {
    "text": "that case as easy so now we're at a point where we can comfortably run",
    "start": "1716160",
    "end": "1721290"
  },
  {
    "text": "commands without being flagged by a local Windows Defender advanced threat protection instance let's actually look",
    "start": "1721290",
    "end": "1728309"
  },
  {
    "text": "at the second product called advanced threat analytics it's intended to detect",
    "start": "1728309",
    "end": "1734250"
  },
  {
    "text": "typical Active Directory recon and lateral movement and credential attacks",
    "start": "1734250",
    "end": "1739669"
  },
  {
    "text": "so a lot of those attacks are there that you see it's pretty decent at detecting",
    "start": "1739669",
    "end": "1746690"
  },
  {
    "text": "this is the architecture all you really need to know is it's collecting logs off of the domain controller and forwarding",
    "start": "1746690",
    "end": "1754980"
  },
  {
    "text": "them to you ata in the upcoming version of Azur ATP or",
    "start": "1754980",
    "end": "1761130"
  },
  {
    "text": "basically advanced threat analytics in the cloud instead of fording those logs",
    "start": "1761130",
    "end": "1766590"
  },
  {
    "text": "to a local instance it's now forwarding them to the Microsoft cloud and it's",
    "start": "1766590",
    "end": "1772530"
  },
  {
    "text": "combining all of the telemetry data from ATP with HEA using the intelligent",
    "start": "1772530",
    "end": "1778860"
  },
  {
    "text": "security graph so this versions not going to be out for three months I have an invite to the beta right now but they",
    "start": "1778860",
    "end": "1785429"
  },
  {
    "text": "haven't changed any functionality yet it's coming in a couple months and when it does come it's actually going to be a",
    "start": "1785429",
    "end": "1791010"
  },
  {
    "text": "really formidable solution because you're not only leveraging all that telemetry data from every individual",
    "start": "1791010",
    "end": "1797490"
  },
  {
    "text": "endpoint you're also leveraging security events from domain controllers to to",
    "start": "1797490",
    "end": "1804000"
  },
  {
    "text": "alert on attacker behavior and quickly there's the the ATA console that you'd",
    "start": "1804000",
    "end": "1810929"
  },
  {
    "text": "log into and it shows all the attacks in progress so because it's behavior on",
    "start": "1810929",
    "end": "1818250"
  },
  {
    "text": "analytics it takes a little bit of time to baseline normal behavior especially",
    "start": "1818250",
    "end": "1823380"
  },
  {
    "text": "for abnormal behavior from users so already peeing two random boxes using",
    "start": "1823380",
    "end": "1831120"
  },
  {
    "text": "dackel abuse to modify sensitive groups using recon obviously to prevent false",
    "start": "1831120",
    "end": "1838830"
  },
  {
    "text": "positives it will it needs some learning time otherwise it's not going to be a very useful tool because it's going to",
    "start": "1838830",
    "end": "1844440"
  },
  {
    "text": "be flagging a regular user behavior and so in a lab when I'm testing this it's",
    "start": "1844440",
    "end": "1850110"
  },
  {
    "text": "obviously pretty hard for me to simulate a twenty thousand person corporate environment in a little lab but there's",
    "start": "1850110",
    "end": "1857190"
  },
  {
    "text": "basic principles of user behavior analytics that we can stick to to avoid being flagged for abnormal user behavior so as",
    "start": "1857190",
    "end": "1865710"
  },
  {
    "text": "an attacker we can leverage our TP history a PowerShell history we can look at users bookmarks to make sure that",
    "start": "1865710",
    "end": "1871590"
  },
  {
    "text": "we're only visiting sites we know in the corporate directory that they should be and key we can use passive tools like",
    "start": "1871590",
    "end": "1881429"
  },
  {
    "text": "Wireshark to baseline what activity is on the local network and make sure that we're only targeting those boxes Tom",
    "start": "1881429",
    "end": "1889409"
  },
  {
    "text": "Porter did a talk on extending bloodhound he talked about mapping out connections based on net stat a couple",
    "start": "1889409",
    "end": "1895649"
  },
  {
    "text": "of weeks ago which is another great technique so let's let's look at how",
    "start": "1895649",
    "end": "1903809"
  },
  {
    "text": "we're performing internal network recon so if you're performing bulk DNS queries",
    "start": "1903809",
    "end": "1909240"
  },
  {
    "text": "are doing nslookup or trying zone transfers that's gonna be flagged if you",
    "start": "1909240",
    "end": "1916500"
  },
  {
    "text": "try to use things like net user slash domain to get more information about particular user accounts that's using",
    "start": "1916500",
    "end": "1922710"
  },
  {
    "text": "the Samer protocol and that's gonna be flagged because that's that's pretty abnormal for users to be doing that but",
    "start": "1922710",
    "end": "1931500"
  },
  {
    "text": "not detected as if we use LDAP instead of Samer so we can use Power View to",
    "start": "1931500",
    "end": "1939990"
  },
  {
    "text": "first grab a list of computers and group members which is pretty normal traffic on a domain and really hard to flag and",
    "start": "1939990",
    "end": "1946380"
  },
  {
    "text": "flagging on this would would lead to a lot of false positives we can this is my preferred technique and you'll see in",
    "start": "1946380",
    "end": "1954299"
  },
  {
    "text": "this example we're actually doing WI queries against the local namespace so",
    "start": "1954299",
    "end": "1964700"
  },
  {
    "text": "this is really interesting because we're gathering all the information about the",
    "start": "1964700",
    "end": "1969899"
  },
  {
    "text": "domain but we're running it against the local box which has a relatively up to make up up-to-date copy of most of the",
    "start": "1969899",
    "end": "1976919"
  },
  {
    "text": "information in in an Active Directory domain so none of this traffic's going",
    "start": "1976919",
    "end": "1981929"
  },
  {
    "text": "over the wire it's not being run against the domain controller so it it's impossible for a TA to flag on that so",
    "start": "1981929",
    "end": "1991019"
  },
  {
    "text": "you you can use WMI CIM and let's in powershell version 2 or sim commandlets and powershell version 3 which are shown",
    "start": "1991019",
    "end": "1997880"
  },
  {
    "text": "alternatively you could use the WMI command line we can also use this method",
    "start": "1997880",
    "end": "2003680"
  },
  {
    "text": "to even see if a TA is in use in the in the environment so once we get on a box",
    "start": "2003680",
    "end": "2009470"
  },
  {
    "text": "and we're worried about performing recon against the internal domain we can first check that this group even exists in the",
    "start": "2009470",
    "end": "2016070"
  },
  {
    "text": "environment and if this group doesn't exist we know that a TA 1.8 is not in use in the environment so we're free to",
    "start": "2016070",
    "end": "2023870"
  },
  {
    "text": "run all the internal enumeration that we want it's really difficult to prevent",
    "start": "2023870",
    "end": "2032060"
  },
  {
    "text": "this you'd have to monitor the local security event log sort of nid for $7.99",
    "start": "2032060",
    "end": "2038860"
  },
  {
    "text": "and filtering on the security ID not being in the system so it's really difficult to detect people doing",
    "start": "2038860",
    "end": "2045230"
  },
  {
    "text": "enumeration using this technique also tools like user hunter and bloodhound",
    "start": "2045230",
    "end": "2052360"
  },
  {
    "text": "which uses user hunter to query servers to find all active SMB sessions so net",
    "start": "2052360",
    "end": "2058820"
  },
  {
    "text": "net user session enumeration to grab all the user doors and IPS associated with",
    "start": "2058820",
    "end": "2064010"
  },
  {
    "text": "those SMB sessions is going to be caught so if you've ever used bloodhound you'll see how valuable this technique is to",
    "start": "2064010",
    "end": "2070370"
  },
  {
    "text": "most attackers because they can use it to map out exactly who has a session on",
    "start": "2070370",
    "end": "2075470"
  },
  {
    "text": "what box in the domain and then map out the attack path against those users but",
    "start": "2075470",
    "end": "2080990"
  },
  {
    "text": "by default user hunter first queries the DC for a list of domain member computers",
    "start": "2080990",
    "end": "2087530"
  },
  {
    "text": "which will also include that all of the domain controllers in the environment if you run a default user hunter or",
    "start": "2087530",
    "end": "2097400"
  },
  {
    "text": "bloodhound against a domain it's gonna be flagged because you enumerated the",
    "start": "2097400",
    "end": "2102440"
  },
  {
    "text": "sessions from the domain controllers so if we see in the bottom right it it's",
    "start": "2102440",
    "end": "2108770"
  },
  {
    "text": "flagging based on against a domain controller but we can get around this by",
    "start": "2108770",
    "end": "2117020"
  },
  {
    "text": "manually providing a list of computers that don't include the DC so this was",
    "start": "2117020",
    "end": "2122510"
  },
  {
    "text": "the this is a much you know it takes a long longer time to go in and edit all of your domain controllers out of that list",
    "start": "2122510",
    "end": "2129980"
  },
  {
    "text": "that you're supplying with computer file flag there luckily the bloodhound gang put out a",
    "start": "2129980",
    "end": "2138050"
  },
  {
    "text": "new version called char pound and they included the flag for me or for s called",
    "start": "2138050",
    "end": "2143540"
  },
  {
    "text": "exclude DC so now that traffic is no longer going against domain controllers so when you're running Nets session",
    "start": "2143540",
    "end": "2150320"
  },
  {
    "text": "enumeration or Dhakal enumeration just make sure that you're including the exclude DC flag so now that we've",
    "start": "2150320",
    "end": "2158300"
  },
  {
    "text": "gathered info on potential part targets such as privileged users or you know",
    "start": "2158300",
    "end": "2164150"
  },
  {
    "text": "admin workstations let's look at how to perform lateral movement against these boxes so this typically involves",
    "start": "2164150",
    "end": "2172000"
  },
  {
    "text": "leveraging the gathered SMB session enumeration espy info or SPN info sorry",
    "start": "2172000",
    "end": "2178790"
  },
  {
    "text": "80 group info to target accounts and then performing remote code execution via techniques or remote exploits to",
    "start": "2178790",
    "end": "2187040"
  },
  {
    "text": "gain access to those other systems and move around the domain and elevate our privileges so if we're targeting the",
    "start": "2187040",
    "end": "2196280"
  },
  {
    "text": "domain controllers itself ata is pretty decent at detecting PS exec and W my exact against a DC it may detect due to",
    "start": "2196280",
    "end": "2205370"
  },
  {
    "text": "abnormal user behavior against a main member so me targeting another workstation or another server in the",
    "start": "2205370",
    "end": "2211610"
  },
  {
    "text": "domain using any of those techniques because of abnormal behavior if it sees",
    "start": "2211610",
    "end": "2217610"
  },
  {
    "text": "somebody in marketing going after a key security server that's pretty abnormal",
    "start": "2217610",
    "end": "2223340"
  },
  {
    "text": "because it's never seen anyone from that domain user group in the past go against that box let alone the user itself so to",
    "start": "2223340",
    "end": "2231890"
  },
  {
    "text": "avoid that whenever possible again we want to leverage powershell history in",
    "start": "2231890",
    "end": "2238190"
  },
  {
    "text": "our DP history and passively monitor the local domain traffic to see what boxes",
    "start": "2238190",
    "end": "2245210"
  },
  {
    "text": "are frequently talked to with users and then we also want to use session",
    "start": "2245210",
    "end": "2250370"
  },
  {
    "text": "enumeration against these boxes to see who should be logging into these boxes because they already have a valid",
    "start": "2250370",
    "end": "2256310"
  },
  {
    "text": "session there not detected is SPN numeration and",
    "start": "2256310",
    "end": "2263940"
  },
  {
    "text": "kerberos ting so any user if you're not familiar with it can enumerate service",
    "start": "2263940",
    "end": "2269250"
  },
  {
    "text": "principal names associated with service accounts and then they can request their Kerberos TGS ticket which is encrypted",
    "start": "2269250",
    "end": "2276090"
  },
  {
    "text": "with the accounts ntlm hash requesting these tickets blends in as regular",
    "start": "2276090",
    "end": "2283020"
  },
  {
    "text": "Active Directory traffic it's really difficult to properly and accurately flag on and once we have the SPN tickets",
    "start": "2283020",
    "end": "2289770"
  },
  {
    "text": "we can easily crack them if they're using somewhat weak service passwords",
    "start": "2289770",
    "end": "2296670"
  },
  {
    "text": "with with something like hash cap and so there's x-force's Reds part of X versus",
    "start": "2296670",
    "end": "2303450"
  },
  {
    "text": "Reds cluster I think we have 16 gtx 1080s so cracking the average SBN maybe",
    "start": "2303450",
    "end": "2309270"
  },
  {
    "text": "takes five minutes so from a defender point of view you really want to make",
    "start": "2309270",
    "end": "2314940"
  },
  {
    "text": "sure that any service count that's been registered as an SPN is using extremely",
    "start": "2314940",
    "end": "2321570"
  },
  {
    "text": "complex passwords so 24 characters in length is the best practice because hash",
    "start": "2321570",
    "end": "2327630"
  },
  {
    "text": "cat doesn't support that that many characters right now and and making sure",
    "start": "2327630",
    "end": "2332820"
  },
  {
    "text": "that they're extremely complex passwords if you used managed service account functionality you can set that as the",
    "start": "2332820",
    "end": "2339060"
  },
  {
    "text": "base line already and automatically have those service accounts update themselves with with complex passwords also not",
    "start": "2339060",
    "end": "2347880"
  },
  {
    "text": "detected is silver tickets so once we have those SPMS",
    "start": "2347880",
    "end": "2353600"
  },
  {
    "text": "we can once we have those service accounts we can just log into the",
    "start": "2353600",
    "end": "2361260"
  },
  {
    "text": "Associated server with those credentials and the authentication traffic will never hit the domain controller if we",
    "start": "2361260",
    "end": "2368820"
  },
  {
    "text": "use silver tickets if we don't use silver tickets they're gonna have service accounts maybe interactively",
    "start": "2368820",
    "end": "2376020"
  },
  {
    "text": "logging into a box and that's going to be pretty easy for 88 a flag on or other",
    "start": "2376020",
    "end": "2382950"
  },
  {
    "text": "solutions to flag on because they've never seen that service account login to a server as an interactive login for",
    "start": "2382950",
    "end": "2388470"
  },
  {
    "text": "example so we can avoid that authentication event altogether by using",
    "start": "2388470",
    "end": "2393900"
  },
  {
    "text": "silver tickets I'd imagine though with ATP integration",
    "start": "2393900",
    "end": "2401670"
  },
  {
    "text": "coming an ATP can read the local security event logs that information may",
    "start": "2401670",
    "end": "2407219"
  },
  {
    "text": "eventually hit the the 80 a cloud and they might start alerting on it but for now we're safe using silver tickets to",
    "start": "2407219",
    "end": "2414749"
  },
  {
    "text": "to only have local authentication events against servers HEA also detects",
    "start": "2414749",
    "end": "2422819"
  },
  {
    "text": "modification of sensitive groups so the following is a list of groups that are",
    "start": "2422819",
    "end": "2428670"
  },
  {
    "text": "considered sensitive by ata any user that as a member of these groups is also considered a sensitive account so if we",
    "start": "2428670",
    "end": "2436890"
  },
  {
    "text": "modify these groups such as adding a member or resetting a password of a",
    "start": "2436890",
    "end": "2441989"
  },
  {
    "text": "member in these groups ata should flag on it what I haven't run into a single",
    "start": "2441989",
    "end": "2447420"
  },
  {
    "text": "environment that these are the only sensitive or privileged groups in an Active Directory environment in fact",
    "start": "2447420",
    "end": "2452759"
  },
  {
    "text": "Microsoft if we follow their best practice on delegating permissions suggests that we create a lot more",
    "start": "2452759",
    "end": "2459809"
  },
  {
    "text": "privileged groups with delegated user rights so if we first use a tool like",
    "start": "2459809",
    "end": "2468359"
  },
  {
    "text": "bloodhound to kind of enumerate what",
    "start": "2468359",
    "end": "2474390"
  },
  {
    "text": "rights groups have in the environment we can enumerate Active Directory object",
    "start": "2474390",
    "end": "2480839"
  },
  {
    "text": "access control entities or the ACLs for each group or user and use bloodhound to",
    "start": "2480839",
    "end": "2486630"
  },
  {
    "text": "visualize the attack path so if we know that we have a be Edwards password and",
    "start": "2486630",
    "end": "2493170"
  },
  {
    "text": "we eventually want to get to DNS o1 we know that the helpdesk group has write",
    "start": "2493170",
    "end": "2499140"
  },
  {
    "text": "permissions on DNS admin and which has write permissions on that user account which has admin to the box so we can use",
    "start": "2499140",
    "end": "2506279"
  },
  {
    "text": "tools like bloodhound instead of using session enumeration we can use add a",
    "start": "2506279",
    "end": "2511559"
  },
  {
    "text": "close to abuse those but the problem is",
    "start": "2511559",
    "end": "2517190"
  },
  {
    "text": "excuse me the problem is if we target",
    "start": "2517190",
    "end": "2523299"
  },
  {
    "text": "DNS admin's because it's listed previously as a sensitive group we're",
    "start": "2523299",
    "end": "2531609"
  },
  {
    "text": "gonna get flagged by a TA so instead we",
    "start": "2531609",
    "end": "2538749"
  },
  {
    "text": "can so if we abuse these excess permissions to add ourselves to non sensitive admin groups like I set the",
    "start": "2538749",
    "end": "2547359"
  },
  {
    "text": "password of a target account to temporary login to a server such as a user that regularly accesses that box",
    "start": "2547359",
    "end": "2553839"
  },
  {
    "text": "combined with the numerating user sessions on the target server we can avoid being flagged by a TA for abnormal",
    "start": "2553839",
    "end": "2559869"
  },
  {
    "text": "user behavior by using an account again that would be expected to log into it",
    "start": "2559869",
    "end": "2565959"
  },
  {
    "text": "and Active Directory is working as designed here ABI this account is a member of the",
    "start": "2565959",
    "end": "2572169"
  },
  {
    "text": "helpdesk which had delegated control over the web service which was an admin on Apple 1 so it would be very difficult",
    "start": "2572169",
    "end": "2579849"
  },
  {
    "text": "to 8 for a TA to accurately detect us abusing these dackel permit permissions",
    "start": "2579849",
    "end": "2585819"
  },
  {
    "text": "as long as we're not modifying groups that were in the previous slide rohan",
    "start": "2585819",
    "end": "2593019"
  },
  {
    "text": "andy and will from specter ops crew recently covered a lot of this in the last bloodhound update so a favored",
    "start": "2593019",
    "end": "2604599"
  },
  {
    "text": "technique by attackers is once you have the ntlm hash of a victim so you get on",
    "start": "2604599",
    "end": "2612639"
  },
  {
    "text": "the box you run me me Katz you get their ntlm hash and you use that using say an",
    "start": "2612639",
    "end": "2618519"
  },
  {
    "text": "overpass the hash attack to request a Kerberos ticket and you use that Kerberos ticket to log into another box",
    "start": "2618519",
    "end": "2625569"
  },
  {
    "text": "that's gonna be flagged and the reason for that is you'll see that the alert",
    "start": "2625569",
    "end": "2631059"
  },
  {
    "text": "comes up as either unusual protocol implementation or encryption downgrade so a Kerberos ticket when you're",
    "start": "2631059",
    "end": "2638289"
  },
  {
    "text": "requesting it it actually expects the AES hashes to be included as well for",
    "start": "2638289",
    "end": "2643719"
  },
  {
    "text": "only including the rc4 which are the ntlm hashes and that's going to be",
    "start": "2643719",
    "end": "2648880"
  },
  {
    "text": "easily flaga becuz it's not regular authentication attempts so if we include",
    "start": "2648880",
    "end": "2655539"
  },
  {
    "text": "our fuyi request Kerberos ticket use using the AES password as well or sorry the AES key as",
    "start": "2655539",
    "end": "2664939"
  },
  {
    "text": "well you you can avoid being flagged now",
    "start": "2664939",
    "end": "2670059"
  },
  {
    "text": "most boxes will only contain the AES 256 key but I found that and it's really",
    "start": "2670059",
    "end": "2678559"
  },
  {
    "text": "struggling on how to find the AES 128-bit key and I found if you just use",
    "start": "2678559",
    "end": "2684349"
  },
  {
    "text": "all zeros or any 32 characters it won't flag on it so as long as you at least have the AES 256 key you won't get",
    "start": "2684349",
    "end": "2692719"
  },
  {
    "text": "flame not detected again if we're",
    "start": "2692719",
    "end": "2697729"
  },
  {
    "text": "avoiding domain level authentication events say by targeting sequel servers",
    "start": "2697729",
    "end": "2702859"
  },
  {
    "text": "that's not going to be flagged either because none of those authentication",
    "start": "2702859",
    "end": "2707989"
  },
  {
    "text": "events are making their way back up to the Active Directory so in the kill did cover a lot of that and in a blog post",
    "start": "2707989",
    "end": "2715119"
  },
  {
    "text": "but that's that's definitely a great technique is to avoid domain level",
    "start": "2715119",
    "end": "2721189"
  },
  {
    "text": "authentication events either with silver tickets or using sequel attacks that use",
    "start": "2721189",
    "end": "2726619"
  },
  {
    "text": "sequel off so once you have access to your privilege user it's time to move",
    "start": "2726619",
    "end": "2733519"
  },
  {
    "text": "towards achieving the primary goals of say a Red Team engagement so these might include dominance over the network and",
    "start": "2733519",
    "end": "2740719"
  },
  {
    "text": "you may or may not have to grab the end the Active Directory database or the",
    "start": "2740719",
    "end": "2745849"
  },
  {
    "text": "NTDs update it sure comes in handy but it comes with its own OPSEC challenges",
    "start": "2745849",
    "end": "2751219"
  },
  {
    "text": "that that you have to risk so if it's if you're on an engagement you only need access to specific source code or",
    "start": "2751219",
    "end": "2757819"
  },
  {
    "text": "specific file server maybe you don't have to grab the Active Directory database but again it sure comes in",
    "start": "2757819",
    "end": "2764569"
  },
  {
    "text": "handy so if we're trying to grab the",
    "start": "2764569",
    "end": "2770329"
  },
  {
    "text": "Active Directory database using DC sync this has been the preferred method by most people for quite a while because DC",
    "start": "2770329",
    "end": "2777289"
  },
  {
    "text": "sync is so fast and it's accurate the problem is using this technique is",
    "start": "2777289",
    "end": "2786829"
  },
  {
    "text": "really easy to catch because you're effectively impersonating a domain controller from say a workstation",
    "start": "2786829",
    "end": "2794090"
  },
  {
    "text": "so you're saying I have another domain controller you're saying hey I'm also a DC send me a copy of the Active",
    "start": "2794090",
    "end": "2800210"
  },
  {
    "text": "Directory database well obviously that workstation is not a DC and it's really",
    "start": "2800210",
    "end": "2805880"
  },
  {
    "text": "easy for a t-888 of flag as long as you're running this from the same forest",
    "start": "2805880",
    "end": "2813740"
  },
  {
    "text": "if you compromised credentials for another forest and ran the attack from",
    "start": "2813740",
    "end": "2820160"
  },
  {
    "text": "outside of that forest because the trust relationships exists between the two Active Directory forests that won't be",
    "start": "2820160",
    "end": "2826880"
  },
  {
    "text": "flagged if a TA is not running in the target environment but there's a lot",
    "start": "2826880",
    "end": "2832040"
  },
  {
    "text": "better ways to grab the database instead of DC sync so this is in 1.8 this is now",
    "start": "2832040",
    "end": "2839240"
  },
  {
    "text": "partially detected I found so we can use the WMI win32 shadow copy class to dump",
    "start": "2839240",
    "end": "2847460"
  },
  {
    "text": "the NTDs data or the Active Directory database via volume Shadow Copy without",
    "start": "2847460",
    "end": "2853040"
  },
  {
    "text": "having to call the volume Shadow Copy admin executable but this is now flagged",
    "start": "2853040",
    "end": "2859160"
  },
  {
    "text": "as a low severity event in ata 1.8 not because we're copying the Active",
    "start": "2859160",
    "end": "2864290"
  },
  {
    "text": "Directory database but because we tried a lateral movement against a domain",
    "start": "2864290",
    "end": "2870650"
  },
  {
    "text": "controller so it's pretty weird that there's still only flagging that is low",
    "start": "2870650",
    "end": "2876350"
  },
  {
    "text": "even though we're clearly making a copy of the Active Directory database containing all the users passwords and",
    "start": "2876350",
    "end": "2882080"
  },
  {
    "text": "whatnot also not detected is PS remoting",
    "start": "2882080",
    "end": "2887240"
  },
  {
    "text": "with L SAS inject so the win RM RPS",
    "start": "2887240",
    "end": "2893600"
  },
  {
    "text": "remoting we can inject me me cats into the alsace process on a domain",
    "start": "2893600",
    "end": "2899120"
  },
  {
    "text": "controller and grab the credentials from memory there's lots of ways to harden",
    "start": "2899120",
    "end": "2907790"
  },
  {
    "text": "against this as a blue Timur though we can prevent who has win RM RPS remoting writes into a box we can restrict that",
    "start": "2907790",
    "end": "2914990"
  },
  {
    "text": "as something as simple as saying only these specific groups can PS remote in or only these specific source",
    "start": "2914990",
    "end": "2921440"
  },
  {
    "text": "workstations or dresses can PS wrote in also not",
    "start": "2921440",
    "end": "2926750"
  },
  {
    "text": "detectives PS promoting with raw disk access so if we connect into a box we",
    "start": "2926750",
    "end": "2933530"
  },
  {
    "text": "can make a copy of the raw underlying file system file without starting any",
    "start": "2933530",
    "end": "2939349"
  },
  {
    "text": "services or injecting any processes or elevating the system you can easily",
    "start": "2939349",
    "end": "2947720"
  },
  {
    "text": "detect this using sis Mon for anything injecting into LSS or on your domain",
    "start": "2947720",
    "end": "2956300"
  },
  {
    "text": "controllers in 2012 r2 and up you can set Alsace as a protected process and",
    "start": "2956300",
    "end": "2962300"
  },
  {
    "text": "nothing can inject into it mm-hmm this",
    "start": "2962300",
    "end": "2968569"
  },
  {
    "text": "this techniques a little messy though because you're you're conveying a live",
    "start": "2968569",
    "end": "2973819"
  },
  {
    "text": "copy of the system file so because the copies in use at the time it might the",
    "start": "2973819",
    "end": "2981200"
  },
  {
    "text": "first attempt you might get a corrupted file which you can clean up or you can",
    "start": "2981200",
    "end": "2986869"
  },
  {
    "text": "just request it again and hopefully not get a version that's corrupt so now that",
    "start": "2986869",
    "end": "2993920"
  },
  {
    "text": "we have the Active Directory database what if we wanted to leverage the Kerberos ticket granting ticket service",
    "start": "2993920",
    "end": "3000579"
  },
  {
    "text": "or the krbtgt to create a golden ticket so we can come into this environment you",
    "start": "3000579",
    "end": "3008079"
  },
  {
    "text": "know six months down the line after compromising it to create a golden ticket on any account or any",
    "start": "3008079",
    "end": "3013660"
  },
  {
    "text": "non-existent account because we're just using the ntlm hash again it's gonna be",
    "start": "3013660",
    "end": "3022119"
  },
  {
    "text": "flagged as an encryption downgrade because the TGT",
    "start": "3022119",
    "end": "3027490"
  },
  {
    "text": "is expecting the ASP s to be in there but if we again include the AES keys",
    "start": "3027490",
    "end": "3036849"
  },
  {
    "text": "when we're creating that golden ticket it won't be flagged Microsoft also put",
    "start": "3036849",
    "end": "3042730"
  },
  {
    "text": "in a excessive session length or",
    "start": "3042730",
    "end": "3048490"
  },
  {
    "text": "excessive ticket creation history basically that if the length of the",
    "start": "3048490",
    "end": "3055089"
  },
  {
    "text": "ticket is more than like eight hours and it's used then it's going to be flagged so we can",
    "start": "3055089",
    "end": "3060119"
  },
  {
    "text": "get around that by just creating a ticket using it for 20 minutes and then destroying the ticket ourselves and that",
    "start": "3060119",
    "end": "3065940"
  },
  {
    "text": "won't be flagged by a TA so just make sure if you are using a golden ticket you're destroying it after you've used",
    "start": "3065940",
    "end": "3073349"
  },
  {
    "text": "it so for blue team takeaways you really",
    "start": "3073349",
    "end": "3080190"
  },
  {
    "text": "want to limit PS remoting sources to dedicated admin services or sorry min workstations you you want to use just",
    "start": "3080190",
    "end": "3088680"
  },
  {
    "text": "enough administration to help prevent lateral movement success if all the privileged users are only on my admitted",
    "start": "3088680",
    "end": "3097499"
  },
  {
    "text": "it's gonna be a lot harder for me to laterally move around the network you want to harden your sequel servers and",
    "start": "3097499",
    "end": "3103709"
  },
  {
    "text": "your sequel accounts to make sure that it's not easy to perform the same sequel",
    "start": "3103709",
    "end": "3108930"
  },
  {
    "text": "attacks that Nikhil has in his blog post you really want to make sure that you're",
    "start": "3108930",
    "end": "3115709"
  },
  {
    "text": "using strong service account passwords especially for your SBN link service",
    "start": "3115709",
    "end": "3121109"
  },
  {
    "text": "accounts you want to ata gives you the option to integrate sim and VPN",
    "start": "3121109",
    "end": "3127039"
  },
  {
    "text": "authentication logs into ata so definitely do that and I think key of",
    "start": "3127039",
    "end": "3133680"
  },
  {
    "text": "all you want to make sure you're using Windows Event log forwarding as a second source of security data so don't just",
    "start": "3133680",
    "end": "3140579"
  },
  {
    "text": "rely on your Windows Defender atps or your crowd strikes or your silences you want to be running system on you want to",
    "start": "3140579",
    "end": "3147509"
  },
  {
    "text": "be using Windows Event log for it or to get those logs off the box so even if I'm able to kill CrowdStrike or ATP or",
    "start": "3147509",
    "end": "3153959"
  },
  {
    "text": "what-have-you you still have a second source of all that data and you're selectively sending",
    "start": "3153959",
    "end": "3159449"
  },
  {
    "text": "some of those events off the Box to a central file share and alerting on them",
    "start": "3159449",
    "end": "3165229"
  },
  {
    "text": "you want to use tools like bloodhound to audit not only how easy it would be for",
    "start": "3165229",
    "end": "3172319"
  },
  {
    "text": "a user to move around with net session enumeration so finding sessions on different servers but also how easy is",
    "start": "3172319",
    "end": "3179819"
  },
  {
    "text": "it to abuse excess permissions within Active Directory groups so doing that",
    "start": "3179819",
    "end": "3184979"
  },
  {
    "text": "dackel abuse we talked about to move to different privileged groups maybe your help desk user has our group has way too many",
    "start": "3184979",
    "end": "3192420"
  },
  {
    "text": "permissions to some obscure delegated righted group that you forgot about by",
    "start": "3192420",
    "end": "3199829"
  },
  {
    "text": "using bloodhound you can audit that all in advance you can also enforce a es 256",
    "start": "3199829",
    "end": "3207839"
  },
  {
    "text": "for your SP n accounts and that way I'm not going to be able to crack them",
    "start": "3207839",
    "end": "3214069"
  },
  {
    "text": "assuming that that you're still using strong passwords in Windows 10 1703 and",
    "start": "3214069",
    "end": "3221160"
  },
  {
    "text": "up there a new feature called binary signature policy came in place to help",
    "start": "3221160",
    "end": "3226770"
  },
  {
    "text": "protect ppl s which basically again is only signed Microsoft code should be",
    "start": "3226770",
    "end": "3231839"
  },
  {
    "text": "able to inject into some of these ppl s so as long as you're enforcing binary signature policy you can you can help",
    "start": "3231839",
    "end": "3238130"
  },
  {
    "text": "prevent that you also really want to integrate those new defender branded",
    "start": "3238130",
    "end": "3244740"
  },
  {
    "text": "tools so that big windows 10 security stack that we saw with credential guard and app guard and an exploit guard you",
    "start": "3244740",
    "end": "3252180"
  },
  {
    "text": "want to make sure that you're actually leveraging all those tools because they work really well if you're properly",
    "start": "3252180",
    "end": "3257780"
  },
  {
    "text": "configuring them and paying attention to them but even just putting them in audit mode so logs are generated is is what",
    "start": "3257780",
    "end": "3265020"
  },
  {
    "text": "you at least want to do and lastly you want to enforce emits or in Windows 10",
    "start": "3265020",
    "end": "3271319"
  },
  {
    "text": "Windows Defender exploit guard has these rules called attack surface reduction",
    "start": "3271319",
    "end": "3277109"
  },
  {
    "text": "rules very easy to implement basically you're preventing processes like",
    "start": "3277109",
    "end": "3282329"
  },
  {
    "text": "Microsoft Word from creating new processes using like say a macro based attack so there's no reason why somebody",
    "start": "3282329",
    "end": "3290430"
  },
  {
    "text": "should be launching a document and it launches PowerShell dot exe or command exe",
    "start": "3290430",
    "end": "3295589"
  },
  {
    "text": "so using ASR you can you can really help prevent that from a red teamers",
    "start": "3295589",
    "end": "3300869"
  },
  {
    "text": "perspective we really need to return to living off the land and directly calling api's we want to leverage host-based",
    "start": "3300869",
    "end": "3308130"
  },
  {
    "text": "powershell tools like empire like power up etc only after we're confident that",
    "start": "3308130",
    "end": "3315450"
  },
  {
    "text": "we can evade or block ATP and event log",
    "start": "3315450",
    "end": "3320609"
  },
  {
    "text": "forwarding so even if we are manage to get around 80",
    "start": "3320609",
    "end": "3326900"
  },
  {
    "text": "ATP to get on the box initially again we have to be cognizant of what we're",
    "start": "3326900",
    "end": "3332790"
  },
  {
    "text": "running against the box and what's going to be picked up by PowerShell event logging or windows script host logging",
    "start": "3332790",
    "end": "3343520"
  },
  {
    "text": "you want to block Windows Event log forwarding right after your able to block ATP or other next-gen antivirus to",
    "start": "3343520",
    "end": "3353100"
  },
  {
    "text": "prevent additional logs from getting off the box and flagged on you you want to",
    "start": "3353100",
    "end": "3358770"
  },
  {
    "text": "use that active directory object abuse whenever possible to help avoid",
    "start": "3358770",
    "end": "3364890"
  },
  {
    "text": "performing remote code execution on a box you want to focus on information",
    "start": "3364890",
    "end": "3370770"
  },
  {
    "text": "gathering and lateral movement techniques that don't communicate with domain controllers so using sequel auth",
    "start": "3370770",
    "end": "3377660"
  },
  {
    "text": "using those silver tickets and querying the local WMI namespace you want to",
    "start": "3377660",
    "end": "3384540"
  },
  {
    "text": "Kerberos stand silver ticket all the things SPNs are my favorite target",
    "start": "3384540",
    "end": "3389910"
  },
  {
    "text": "because they're so easy any user can request them and most of the time you're",
    "start": "3389910",
    "end": "3395190"
  },
  {
    "text": "gonna find the odd SPN that that was registered with like password 0 1 for example you want to make sure you're",
    "start": "3395190",
    "end": "3402930"
  },
  {
    "text": "using a s keys when you're performing over over pass the hash to generate those Kerberos tickets or the golden",
    "start": "3402930",
    "end": "3410580"
  },
  {
    "text": "tickets you want to make sure how the AES as well and you want to abuse forest trust whenever possible because a TA is",
    "start": "3410580",
    "end": "3417990"
  },
  {
    "text": "specific to its own forest only so a big",
    "start": "3417990",
    "end": "3423300"
  },
  {
    "text": "thank you to everyone on this slide and Simon stone hog for permission to use this art highly suggests following",
    "start": "3423300",
    "end": "3430200"
  },
  {
    "text": "everyone on that list there they're way smarter than I will ever be really good",
    "start": "3430200",
    "end": "3435210"
  },
  {
    "text": "people the M SATA and ATP teens have been awesome to work with they've been",
    "start": "3435210",
    "end": "3440850"
  },
  {
    "text": "quickly patching all the bypasses that I've been finding and evasions I've been",
    "start": "3440850",
    "end": "3446430"
  },
  {
    "text": "finding release for is gonna come out with a lot of patches for the bypasses",
    "start": "3446430",
    "end": "3453510"
  },
  {
    "text": "that I found or at least ways to detect them in use so I'm looking forward to playing with",
    "start": "3453510",
    "end": "3459740"
  },
  {
    "text": "that in the future and finding more bypasses like a weird cat and mouse game with them but it's it's been fun for",
    "start": "3459740",
    "end": "3466730"
  },
  {
    "text": "sure so thank you everyone for your time and for coming out to the talk",
    "start": "3466730",
    "end": "3472390"
  }
]