[
  {
    "start": "0",
    "end": "17000"
  },
  {
    "text": "my name is john erickson this is persistent using abusing microsoft patches i apologize my laptop",
    "start": "80",
    "end": "6879"
  },
  {
    "text": "somehow does not work with the system so um i'm going to be clicking this",
    "start": "6879",
    "end": "13040"
  },
  {
    "text": "and this at the same time so it might get confusing there we go all right this is me that's",
    "start": "13040",
    "end": "20480"
  },
  {
    "start": "17000",
    "end": "80000"
  },
  {
    "text": "my twitter handle i don't tweet much but you can follow me if you want to i'm an engineer at eyesight partners",
    "start": "20480",
    "end": "26880"
  },
  {
    "text": "i've been there about three years now i focus on looking at vulnerabilities exploits",
    "start": "26880",
    "end": "34880"
  },
  {
    "text": "look at malware and a big part of my job is looking at patches which is what this talk is about every",
    "start": "34880",
    "end": "42640"
  },
  {
    "text": "patch tuesday look at microsoft adobe oracle et cetera",
    "start": "42640",
    "end": "48480"
  },
  {
    "text": "prior to i was at the mitre corporation for five years and before that i was at uh in the air",
    "start": "49360",
    "end": "55199"
  },
  {
    "text": "force and a couple defense contractors eyesight partners is a intelligence threat provider if you",
    "start": "55199",
    "end": "62800"
  },
  {
    "text": "would like more information about isi please visit our website or come talk to me after the talk",
    "start": "62800",
    "end": "69200"
  },
  {
    "text": "okay so here's what we're talking about today give a little background about what these fixes actually do um some",
    "start": "70159",
    "end": "76560"
  },
  {
    "text": "tools they can use to damn it sorry",
    "start": "76560",
    "end": "82080"
  },
  {
    "start": "80000",
    "end": "121000"
  },
  {
    "text": "that was my slide for my company sorry and this is what we're talking about today",
    "start": "82080",
    "end": "87840"
  },
  {
    "text": "um we're going to talk about some tools that you can use to look at these uh fix the patches some real world cases",
    "start": "88080",
    "end": "94479"
  },
  {
    "text": "where microsoft has utilized these fixes to prevent exploitation um",
    "start": "94479",
    "end": "100079"
  },
  {
    "text": "how i went about reverse engineering this fix it file format um a simple information disclosure",
    "start": "100079",
    "end": "107119"
  },
  {
    "text": "blog you might want to say that i found while doing this uh sdb explorer which is the tool i wrote during this research",
    "start": "107119",
    "end": "114159"
  },
  {
    "text": "and how you can go about creating your own in-memory patch fix-its and how you can use that to maintain",
    "start": "114159",
    "end": "119280"
  },
  {
    "text": "persistence okay so what are these in-memory patch",
    "start": "119280",
    "end": "125280"
  },
  {
    "start": "121000",
    "end": "192000"
  },
  {
    "text": "fix-its they are a subset of application compatibility fixes",
    "start": "125280",
    "end": "130720"
  },
  {
    "text": "there's a bunch of different names out there they they're called shim databases they're called app compat app compatibility",
    "start": "130720",
    "end": "137680"
  },
  {
    "text": "fixes microsoft has a whole website dedicated to these fix it is some microsoft fix-it",
    "start": "137680",
    "end": "143520"
  },
  {
    "text": "center there's thousands out there they provide",
    "start": "143520",
    "end": "149360"
  },
  {
    "text": "a way to modify an application's behavior how it interacts with windows so",
    "start": "149360",
    "end": "155840"
  },
  {
    "text": "for example if you needed to modify your resolution for some old program you",
    "start": "155840",
    "end": "161920"
  },
  {
    "text": "could have a shim that does that if you wanted to convert an old you know windows nt app",
    "start": "161920",
    "end": "169120"
  },
  {
    "text": "to make it work on windows 7 you might need to change some uh file locations or registry locations",
    "start": "169120",
    "end": "176720"
  },
  {
    "text": "so you can do that all with the sim databases and emit microsoft's enhanced mitigation",
    "start": "176720",
    "end": "183680"
  },
  {
    "text": "experience toolkit also works via this mechanism",
    "start": "183680",
    "end": "190560"
  },
  {
    "start": "192000",
    "end": "243000"
  },
  {
    "text": "so the the first public information i saw on this is from alex",
    "start": "192480",
    "end": "198560"
  },
  {
    "text": "and eskew i made a blog back in 2007 called secrets of the application compatibility",
    "start": "198560",
    "end": "204080"
  },
  {
    "text": "database i i guess he intended for it to be a nine part blog series he only did these first four that",
    "start": "204080",
    "end": "211760"
  },
  {
    "text": "i that i saw at least uh he gave a great introduction on the technology some system shims that",
    "start": "211760",
    "end": "219920"
  },
  {
    "text": "are built into windows how the shim engine interacts with the pe loader and um he never got to releasing his",
    "start": "219920",
    "end": "228319"
  },
  {
    "text": "tool or this bullet here uh 7 the run time in memory patching behavior",
    "start": "228319",
    "end": "235280"
  },
  {
    "text": "analysis if he would have released that blog entry i probably would not be here today talking about this stuff",
    "start": "235280",
    "end": "241840"
  },
  {
    "start": "243000",
    "end": "358000"
  },
  {
    "text": "mark badgett presented at derbycon last year he's mainly focused on",
    "start": "244799",
    "end": "252879"
  },
  {
    "text": "root kits and doing penetration testing work so that's kind of his focus he wants to do",
    "start": "252879",
    "end": "258160"
  },
  {
    "text": "uh root kit type things like process execution redirection and api hooking and file system height",
    "start": "258160",
    "end": "264479"
  },
  {
    "text": "registering registry hiding i showed how you could disable security features of the os like",
    "start": "264479",
    "end": "269919"
  },
  {
    "text": "disabling aslr or depth for processes and how to execute back doors he showed that you could do all this",
    "start": "269919",
    "end": "276400"
  },
  {
    "text": "through the application compatibility framework that's built right into windows it's a very neat work he did not talk",
    "start": "276400",
    "end": "283280"
  },
  {
    "text": "about in-memory patches which is the focus of this talk but still cool stuff",
    "start": "283280",
    "end": "290240"
  },
  {
    "text": "so what's the motivation why did i want to get started doing this you know patch tuesday comes out i diff",
    "start": "291280",
    "end": "299840"
  },
  {
    "text": "the patch for ie you find for for this example here 465 functions that",
    "start": "299840",
    "end": "307759"
  },
  {
    "text": "match that means you have to look through 465 functions that have there's differences in them",
    "start": "307759",
    "end": "315120"
  },
  {
    "text": "and are those differences secure related fixes are they just normal bug fixes for windows",
    "start": "315120",
    "end": "322720"
  },
  {
    "text": "it's it's a hard job it takes a long time it takes a long time to just load these dlls into ida and run bindif",
    "start": "322720",
    "end": "329680"
  },
  {
    "text": "on them it takes hours uh if you look at a fix-it patch for this particular cd here",
    "start": "329680",
    "end": "335680"
  },
  {
    "text": "there is two changes so within you know five minutes of downloading this fix-it running this tool you can",
    "start": "335680",
    "end": "342800"
  },
  {
    "text": "see oh they changed this assembly instruction from a jump not equal to a jumper they changed",
    "start": "342800",
    "end": "349759"
  },
  {
    "text": "this to hook this function to redirect code somewhere else very cool stuff and that's what got me",
    "start": "349759",
    "end": "355680"
  },
  {
    "text": "started in this okay so now let's talk about some tools",
    "start": "355680",
    "end": "362240"
  },
  {
    "start": "358000",
    "end": "382000"
  },
  {
    "text": "there's a few by microsoft application compatibility toolkit sv to xml and sv inst",
    "start": "362800",
    "end": "370800"
  },
  {
    "text": "as well as cdd which we'll talk about briefly and ftp explorer which is the tool i created",
    "start": "370800",
    "end": "376560"
  },
  {
    "text": "during this research",
    "start": "376560",
    "end": "381840"
  },
  {
    "start": "382000",
    "end": "528000"
  },
  {
    "text": "damn it someone yell at me if i forget to change the slide please",
    "start": "382000",
    "end": "388319"
  },
  {
    "text": "thank you okay so application compatibility toolkit",
    "start": "390080",
    "end": "395280"
  },
  {
    "text": "this is freely available for download from microsoft um it's a nice gui tool that allows you",
    "start": "395280",
    "end": "401520"
  },
  {
    "text": "to point and click and create nice application fixes however i don't think it's very well documented i've got",
    "start": "401520",
    "end": "408240"
  },
  {
    "text": "a couple examples here that i i just made up a pointer",
    "start": "408240",
    "end": "414560"
  },
  {
    "text": "so i created a compatibility fix here called shin via eit which",
    "start": "414560",
    "end": "421039"
  },
  {
    "text": "means it you're going to hook a function via export address table entry",
    "start": "421039",
    "end": "427199"
  },
  {
    "text": "when you create this the gui it's nice to point and click yeah i want to do a shim via eat and then it gives you a text box that",
    "start": "427199",
    "end": "433599"
  },
  {
    "text": "says arguments and it provides no documentation what's the format for that argument how do you",
    "start": "433599",
    "end": "439280"
  },
  {
    "text": "know i i have no idea so it was very confusing",
    "start": "439280",
    "end": "446479"
  },
  {
    "text": "they have fixes and they've got modes modes are a collection of fixes so i've got the top one here is a",
    "start": "446479",
    "end": "453440"
  },
  {
    "text": "compatibility fix and the bottom one's a compatibility mode what i really want to point out here is",
    "start": "453440",
    "end": "460160"
  },
  {
    "text": "the concept of matching files and so matching files for",
    "start": "460160",
    "end": "466080"
  },
  {
    "text": "ie it has to match this particular binary version company name product name etc if that",
    "start": "466080",
    "end": "474319"
  },
  {
    "text": "if those conditions are met then this compatibility fix will be applied",
    "start": "474319",
    "end": "479759"
  },
  {
    "text": "as well as the bottom if those conditions are met that compatibility mode will be set",
    "start": "479759",
    "end": "487440"
  },
  {
    "text": "now if we take the same you know tool  gui here and bring in one of these",
    "start": "490960",
    "end": "496400"
  },
  {
    "text": "fix-it shims um we see the same matching files entries like we saw in the previous",
    "start": "496400",
    "end": "502560"
  },
  {
    "text": "slide however there's no compatibility fixed listed here there's no compatibility",
    "start": "502560",
    "end": "508479"
  },
  {
    "text": "mode listed here so how do you know what this does that it has like no concept of what these",
    "start": "508479",
    "end": "515599"
  },
  {
    "text": "in-memory fix-its are what they do so i'm guessing that microsoft has some internal version of",
    "start": "515599",
    "end": "521839"
  },
  {
    "text": "this tool or maybe they use something a little bit different to create these",
    "start": "521839",
    "end": "526240"
  },
  {
    "start": "528000",
    "end": "630000"
  },
  {
    "text": "okay sv to xml created by microsoft employee",
    "start": "528880",
    "end": "534240"
  },
  {
    "text": "back in 2007 so about the same time alex was doing his work",
    "start": "534240",
    "end": "539600"
  },
  {
    "text": "this can dump what's called patch bits information this big oops sorry this big",
    "start": "539600",
    "end": "546720"
  },
  {
    "text": "blob of base64 data you can also have it dump these patch bits section into binary",
    "start": "546720",
    "end": "554320"
  },
  {
    "text": "files on on disk now it i'm sorry if it's very small here",
    "start": "554320",
    "end": "562959"
  },
  {
    "text": "uh but you can see that this kind of has the same information that's provided in the application",
    "start": "562959",
    "end": "569200"
  },
  {
    "text": "compatibility toolkit it's got the application names got the matching file entries followed by",
    "start": "569200",
    "end": "574880"
  },
  {
    "text": "here we get a little more information now there's a patch ref item here so that means if this matching",
    "start": "574880",
    "end": "580880"
  },
  {
    "text": "files entry is met it will apply this patch ref and it's got a patch tag id of 218",
    "start": "580880",
    "end": "589600"
  },
  {
    "text": "but what does 218 mean i have no idea this patch up here has no number associated",
    "start": "589600",
    "end": "595680"
  },
  {
    "text": "with it so is that 218 or is the one that's off the screen right now",
    "start": "595680",
    "end": "600880"
  },
  {
    "text": "above it or the one above that or how do you get this linkage of",
    "start": "600880",
    "end": "605920"
  },
  {
    "text": "if that blob of unknown data is for this particular version of ms-html dll",
    "start": "605920",
    "end": "618480"
  },
  {
    "text": "cdd uh from alex he never released it he's got this show",
    "start": "618480",
    "end": "624240"
  },
  {
    "text": "patches option thank you cdd by alex he's got the show",
    "start": "624240",
    "end": "633120"
  },
  {
    "start": "630000",
    "end": "653000"
  },
  {
    "text": "patches option um it's not clear if this",
    "start": "633120",
    "end": "638160"
  },
  {
    "text": "dumped out the base64 encoded blob like stb to xml or if it actually parsed out this",
    "start": "638160",
    "end": "644839"
  },
  {
    "text": "information in a better format but never released",
    "start": "644839",
    "end": "652480"
  },
  {
    "start": "653000",
    "end": "730000"
  },
  {
    "text": "okay so sp inst this is a file that's already on your computer it's a way for you to install sdb files",
    "start": "654480",
    "end": "662720"
  },
  {
    "text": "if you were if you go to microsoft's website you can download the msi to install",
    "start": "662720",
    "end": "670480"
  },
  {
    "text": "a fix-it but if you actually extract out what's in the msi you'll end up with the sdb file",
    "start": "670480",
    "end": "675680"
  },
  {
    "text": "and this tool allows you to install sdb files via this mechanism whether",
    "start": "675680",
    "end": "682079"
  },
  {
    "text": "they're stb files that you create using the application compatibility framework or toolkit or ones that you download",
    "start": "682079",
    "end": "688480"
  },
  {
    "text": "from microsoft you have to use the dash p option when the sdv file contains",
    "start": "688480",
    "end": "696079"
  },
  {
    "text": "in memory patches you have to be administrator to run this tool and",
    "start": "696079",
    "end": "702320"
  },
  {
    "text": "we'll talk about why later also a side effect of this is that",
    "start": "702320",
    "end": "710000"
  },
  {
    "text": "these items show up in your ad removed programs dialog and badgett mentioned in his derby con",
    "start": "710000",
    "end": "716240"
  },
  {
    "text": "talk you know he's doing all these cool root kit type things but then he has to go and see that his you",
    "start": "716240",
    "end": "723839"
  },
  {
    "text": "know root kit fix it is in the admin programs dialogue so not very not very stealthy",
    "start": "723839",
    "end": "731279"
  },
  {
    "start": "730000",
    "end": "810000"
  },
  {
    "text": "so these are the default locations and this is why you have to be",
    "start": "731279",
    "end": "736800"
  },
  {
    "text": "administrator because um stb instant in my tool have to write to these",
    "start": "736800",
    "end": "742639"
  },
  {
    "text": "two registry locations hkey local machine custom and installed sdb",
    "start": "742639",
    "end": "749760"
  },
  {
    "text": "and so what you'll find if you look at this location custom you'll find entries for applications that have shims",
    "start": "749760",
    "end": "756480"
  },
  {
    "text": "applied so you might find one for iexplore.exe or for windward or for outlook or",
    "start": "756480",
    "end": "762240"
  },
  {
    "text": "any other program that may have had a in-memory fix it uh installed one time this is also",
    "start": "762240",
    "end": "769360"
  },
  {
    "text": "where you'll see applications that have emit applied to them under the entries in custom there'll be",
    "start": "769360",
    "end": "776240"
  },
  {
    "text": "a guide you follow that guide under the installed sdb folder and you'll find",
    "start": "776240",
    "end": "783920"
  },
  {
    "text": "information like this this shows you the the description which is just a",
    "start": "784240",
    "end": "790480"
  },
  {
    "text": "comment i'll show you the database uh timestamp uh the location on the file system where the sdv file exists",
    "start": "790480",
    "end": "798480"
  },
  {
    "text": "and the database type which in this case this flag just means uh it's a shim database type",
    "start": "798480",
    "end": "806320"
  },
  {
    "text": "um",
    "start": "806320",
    "end": "808639"
  },
  {
    "start": "810000",
    "end": "903000"
  },
  {
    "text": "i got bored and i played around with animations and that's all i got so this is kind of like my uh my cab ride",
    "start": "811839",
    "end": "819279"
  },
  {
    "text": "from the airport here it's pretty exciting so this is my tool for installing i'm",
    "start": "819279",
    "end": "826240"
  },
  {
    "text": "going to talk more about my tool later but you give the the dash r",
    "start": "826240",
    "end": "831600"
  },
  {
    "text": "option with the sv file that you've you've got and you give you an application name that you want to shim uh this does not",
    "start": "831600",
    "end": "839760"
  },
  {
    "text": "show up in the add remove programs it does not copy the sv file to the",
    "start": "839760",
    "end": "846480"
  },
  {
    "text": "default locations i should have i should have mentioned back here actually",
    "start": "846480",
    "end": "851279"
  },
  {
    "text": "this is the default locations that the stb in program copies the file to so if you're",
    "start": "852720",
    "end": "860000"
  },
  {
    "text": "installing a 32-bit patch it's going to put it in the app patch custom directory and if",
    "start": "860000",
    "end": "865279"
  },
  {
    "text": "you're installing a 64-bit patch it's going to put it in the custom custom 64 directory",
    "start": "865279",
    "end": "872240"
  },
  {
    "text": "um my tool does not copy into these default locations so you need",
    "start": "872240",
    "end": "878240"
  },
  {
    "text": "to be aware of if you're making a patch for 60 64-bit program you need to have um",
    "start": "878240",
    "end": "887040"
  },
  {
    "text": "custom 64 somewhere in the full directory path that's how micro how windows checks to see if",
    "start": "887040",
    "end": "893040"
  },
  {
    "text": "you have got a 32-bit or 64-bit patch it just checks based on this directory name",
    "start": "893040",
    "end": "899839"
  },
  {
    "start": "903000",
    "end": "983000"
  },
  {
    "text": "okay so let's talk about some real world cases where microsoft has used this",
    "start": "903680",
    "end": "908959"
  },
  {
    "text": "the foremost recent that i've seen using the in memory fix it type are",
    "start": "908959",
    "end": "914959"
  },
  {
    "text": "these just a quick note in the news this week",
    "start": "914959",
    "end": "920560"
  },
  {
    "text": "microsoft put out an advisory about rtf vulnerability and in their security advisor they",
    "start": "920560",
    "end": "925920"
  },
  {
    "text": "mentioned a fix it patch that will help prevent it that's not an in memory",
    "start": "925920",
    "end": "931759"
  },
  {
    "text": "fix it patch that will just disable word opening rtf files essentially or",
    "start": "931759",
    "end": "937680"
  },
  {
    "text": "processing them so they don't have to they don't do it in memory patch",
    "start": "937680",
    "end": "943600"
  },
  {
    "text": "so these these top three are ie phones the bottom one was a xml core services",
    "start": "944320",
    "end": "949680"
  },
  {
    "text": "bug and in all these cases the fix-its were actually targeting ie",
    "start": "949680",
    "end": "957040"
  },
  {
    "text": "so xml core services is a system-wide library used by many applications such",
    "start": "957040",
    "end": "964000"
  },
  {
    "text": "as you know ward and outlook but microsoft just released the fix fix",
    "start": "964000",
    "end": "969199"
  },
  {
    "text": "it to protect ie using that library not not other ones uh and we're gonna focus",
    "start": "969199",
    "end": "977360"
  },
  {
    "text": "on this most recent one um for the rest of the talk",
    "start": "977360",
    "end": "983839"
  },
  {
    "start": "983000",
    "end": "1062000"
  },
  {
    "text": "so this was publicly disclosed by fireeye on february 11th",
    "start": "984000",
    "end": "989360"
  },
  {
    "text": "being exploited in the wild microsoft released to fix it on the 19th so that's eight days",
    "start": "989360",
    "end": "996160"
  },
  {
    "text": "they already had to fix it out the door which is great so that you don't have to wait till the next patch cycle of patch tuesday to be able",
    "start": "996160",
    "end": "1004000"
  },
  {
    "text": "to protect your enterprise again using my tool which we'll talk",
    "start": "1004000",
    "end": "1010399"
  },
  {
    "text": "about later this dash d option will essentially",
    "start": "1010399",
    "end": "1015440"
  },
  {
    "text": "print out all the matching file entries within the database so",
    "start": "1015440",
    "end": "1021120"
  },
  {
    "text": "this particular database file there was eight different entries that they're",
    "start": "1021120",
    "end": "1027199"
  },
  {
    "text": "targeting these versions of these versions of ie with these pe",
    "start": "1027199",
    "end": "1034319"
  },
  {
    "text": "checksums so ie 9 and ie10",
    "start": "1034319",
    "end": "1039839"
  },
  {
    "text": "uh and just you know a note on that if you don't have the if you didn't have the latest versions",
    "start": "1043520",
    "end": "1049039"
  },
  {
    "text": "of these dlls and install to fix it it does nothing for you",
    "start": "1049039",
    "end": "1054080"
  },
  {
    "text": "you have to have these exact versions for this fix it to help you otherwise it does nothing",
    "start": "1054080",
    "end": "1061600"
  },
  {
    "text": "so let's start talking about how we can figure out what this does now",
    "start": "1061600",
    "end": "1067039"
  },
  {
    "text": "when i first started research into this i didn't actually know about this",
    "start": "1067039",
    "end": "1072559"
  },
  {
    "text": "this extension to windebug that i'm showing here and so it's a kind of a manual process i",
    "start": "1072559",
    "end": "1077840"
  },
  {
    "text": "loaded up ie i did a memory dump i installed the fix it patch i loaded i",
    "start": "1077840",
    "end": "1084000"
  },
  {
    "text": "again did another memory dump and then did a binary compare of the two",
    "start": "1084000",
    "end": "1089039"
  },
  {
    "text": "outputs to figure out where the bytes started were they different essentially and um",
    "start": "1089039",
    "end": "1096559"
  },
  {
    "text": "it was a pain in the butt and this this um plug in here for winderbug is was very",
    "start": "1096559",
    "end": "1102720"
  },
  {
    "text": "helpful so if you want to play along at home this was the dll that i had running on my system when i ran these commands",
    "start": "1102720",
    "end": "1109840"
  },
  {
    "text": "and what we see here is before the fix-it there's no corruption",
    "start": "1109840",
    "end": "1116080"
  },
  {
    "text": "that's what this tool calls corruption or differences essentially",
    "start": "1116080",
    "end": "1121440"
  },
  {
    "text": "and so if we see this memory range here there was a 5 byte corruption",
    "start": "1121440",
    "end": "1127039"
  },
  {
    "text": "if you've got symbols installed you'll see that this was it within the insert text internal method",
    "start": "1127039",
    "end": "1133840"
  },
  {
    "text": "and the expected five bytes are those and the bytes it found there for those",
    "start": "1133840",
    "end": "1140480"
  },
  {
    "text": "and there's a second one now i've disassembled what those five bytes are",
    "start": "1140480",
    "end": "1146320"
  },
  {
    "text": "the new five bytes are down here and we can see they're both jump instructions",
    "start": "1146320",
    "end": "1151520"
  },
  {
    "text": "and i don't have it on the screen but if i would have showed the disassembly of the before fix-it installed you would",
    "start": "1151520",
    "end": "1158960"
  },
  {
    "text": "see that it's a standard function prolog just you know move edi",
    "start": "1158960",
    "end": "1165440"
  },
  {
    "text": "push ep etc so they're essentially hooking these two functions",
    "start": "1165440",
    "end": "1172480"
  },
  {
    "text": "and we're going to talk about these bytes later so i've bolded the things that i'm actually going to focus",
    "start": "1173760",
    "end": "1180320"
  },
  {
    "text": "on later the address uh here ends in 7-0 ef",
    "start": "1180320",
    "end": "1186240"
  },
  {
    "text": "there's a 5-bit corruption and if you can remember those 10 bites",
    "start": "1186240",
    "end": "1191280"
  },
  {
    "text": "remember them otherwise i'll remind you later",
    "start": "1191280",
    "end": "1194880"
  },
  {
    "start": "1195000",
    "end": "1293000"
  },
  {
    "text": "okay so what's this fix it actually do um if we look at what does that jump do",
    "start": "1196559",
    "end": "1203280"
  },
  {
    "text": "we we see where it jumps we disassemble that code and we can see that microsoft has damn it",
    "start": "1203280",
    "end": "1212880"
  },
  {
    "text": "saved all the registers called some additional function restored the registers and then it will return back to where um",
    "start": "1213600",
    "end": "1221440"
  },
  {
    "text": "the jump came from this particular function that their additional function that they're calling",
    "start": "1221440",
    "end": "1226559"
  },
  {
    "text": "increments a reference counter and this is a use after free bug so they are making sure that they always",
    "start": "1226559",
    "end": "1232960"
  },
  {
    "text": "increment this reference count microsoft actually wrote a blog about this and they say you know we know that",
    "start": "1232960",
    "end": "1239919"
  },
  {
    "text": "this produces a memory leak because we're never freeing this memory but at least it's preventing the vulnerability",
    "start": "1239919",
    "end": "1245120"
  },
  {
    "text": "from being exploited because we avoid the free don't whatever free",
    "start": "1245120",
    "end": "1252080"
  },
  {
    "text": "one other thing that i want to point out this other code here did not show up",
    "start": "1254080",
    "end": "1261440"
  },
  {
    "text": "in the check image output as a corruption and we just saw the two jumps not this",
    "start": "1261440",
    "end": "1268640"
  },
  {
    "text": "additional code and the reason for that is the check image extension only considers",
    "start": "1268640",
    "end": "1274400"
  },
  {
    "text": "uh code in the original image size so any bytes that are outside of that image size are not considered for",
    "start": "1274400",
    "end": "1281360"
  },
  {
    "text": "potential corruption so basically microsoft went to the end of executal code wrote this additional code and then just",
    "start": "1281360",
    "end": "1288240"
  },
  {
    "text": "put a reference to it to jump to it",
    "start": "1288240",
    "end": "1291840"
  },
  {
    "start": "1293000",
    "end": "1377000"
  },
  {
    "text": "okay so let's continue on this quest of reverse engineering",
    "start": "1293840",
    "end": "1299200"
  },
  {
    "text": "figure out how this patch pits formats processed and how the p loader handles",
    "start": "1299200",
    "end": "1305039"
  },
  {
    "text": "it a couple slides ago i i highlighted those bytes in",
    "start": "1305039",
    "end": "1310159"
  },
  {
    "text": "in bold for you",
    "start": "1310159",
    "end": "1313039"
  },
  {
    "text": "this number five is uh it's little endian so it's least significant first",
    "start": "1315840",
    "end": "1321440"
  },
  {
    "text": "but it's first so that's five was you know for five by corruption we see the",
    "start": "1321440",
    "end": "1327640"
  },
  {
    "text": "ef70 those were the lower 16 bits of that address",
    "start": "1327640",
    "end": "1333840"
  },
  {
    "text": "we see these are the five bytes where the expected five bytes this is another",
    "start": "1333840",
    "end": "1340880"
  },
  {
    "text": "five followed by ef70 for some reason i don't have that boxed and then these are the five bytes",
    "start": "1340880",
    "end": "1349120"
  },
  {
    "text": "that are now corrupting those original five so this is a kind of a general idea and",
    "start": "1349120",
    "end": "1356320"
  },
  {
    "text": "let's see how windows actually parses this information i should say that this this dump of hex",
    "start": "1356320",
    "end": "1362880"
  },
  {
    "text": "right here if you go back to the stb to xml tool",
    "start": "1362880",
    "end": "1367919"
  },
  {
    "text": "and grab out that base64 blob that's what it looks like it's just these bytes that's what i did there",
    "start": "1367919",
    "end": "1375840"
  },
  {
    "start": "1377000",
    "end": "1420000"
  },
  {
    "text": "okay so how does here's a very high level view of what the p loader",
    "start": "1378000",
    "end": "1384960"
  },
  {
    "text": "does when it's applying it in memory fix it it initializes the shim engine",
    "start": "1384960",
    "end": "1392320"
  },
  {
    "text": "it resolves a function within the f help dll called",
    "start": "1392320",
    "end": "1398320"
  },
  {
    "text": "scdl loaded sc stands for shim engine within that",
    "start": "1398320",
    "end": "1403600"
  },
  {
    "text": "function it calls patch key modules attempt patches and",
    "start": "1403600",
    "end": "1409679"
  },
  {
    "text": "apply patch and the apply patch function is the one that actually does the work of processing",
    "start": "1409679",
    "end": "1416400"
  },
  {
    "text": "this patch bits information",
    "start": "1416400",
    "end": "1420080"
  },
  {
    "start": "1420000",
    "end": "1501000"
  },
  {
    "text": "okay so here's some pseudo code representation of this function it takes a pointer to a patch bit",
    "start": "1422080",
    "end": "1427440"
  },
  {
    "text": "structure this is a structure i i came up with so that's my name for it i don't know what microsoft calls it",
    "start": "1427440",
    "end": "1434720"
  },
  {
    "text": "but essentially it's just going to iterate through all i kind of call them patch actions",
    "start": "1434720",
    "end": "1442080"
  },
  {
    "text": "and a patch action can be either a match or a replace action",
    "start": "1442080",
    "end": "1447440"
  },
  {
    "text": "um so if it's a a match action it's just going to do a mem compare of",
    "start": "1447440",
    "end": "1452880"
  },
  {
    "text": "the pattern specified for some module base plus an",
    "start": "1452880",
    "end": "1458640"
  },
  {
    "text": "rba for that pattern size if it if it matches it continues along just fine otherwise",
    "start": "1458640",
    "end": "1464320"
  },
  {
    "text": "it returns out if it's a replace action it's going to change the memory",
    "start": "1464320",
    "end": "1469919"
  },
  {
    "text": "permission of the area specified so go to the rva for the number of bytes specified it will make",
    "start": "1469919",
    "end": "1475840"
  },
  {
    "text": "that memory read writable it will then copy the bytes that you want into that new memory",
    "start": "1475840",
    "end": "1481679"
  },
  {
    "text": "area and then restore the persons back to original so",
    "start": "1481679",
    "end": "1486799"
  },
  {
    "text": "redux here or whatever they were and then it flushes the instruction cache",
    "start": "1486799",
    "end": "1491679"
  },
  {
    "text": "it'll continue to do this until it gets to the end essentially",
    "start": "1493200",
    "end": "1501840"
  },
  {
    "start": "1501000",
    "end": "1609000"
  },
  {
    "text": "so along with the sei apply patch function that we were just looking at the appel",
    "start": "1502400",
    "end": "1508880"
  },
  {
    "text": "dll has 195 exports microsoft has documented them somewhat at this",
    "start": "1508880",
    "end": "1516480"
  },
  {
    "text": "location they don't provide any header files for you to use",
    "start": "1516480",
    "end": "1522000"
  },
  {
    "text": "or a library to link against so it's kind of a manual process to to create those",
    "start": "1522000",
    "end": "1529679"
  },
  {
    "text": "the code that i'm releasing has all that header information in there for you with",
    "start": "1529679",
    "end": "1535520"
  },
  {
    "text": "all the function names and so save you some time uh this is this",
    "start": "1535520",
    "end": "1542080"
  },
  {
    "text": "library can be used to read and write or create sdb files um",
    "start": "1542080",
    "end": "1547679"
  },
  {
    "text": "the documentation is definitely lacking it's you know been lacking for many years",
    "start": "1547679",
    "end": "1554080"
  },
  {
    "text": "like in 2007 alex was talking about it lacking information so one problem i was having with it was",
    "start": "1554080",
    "end": "1560480"
  },
  {
    "text": "i want to extract out that patch bits area which is a binary field and",
    "start": "1560480",
    "end": "1566400"
  },
  {
    "text": "you're required to give this function a buffer and a buffer size and i'm thinking well how do i know how",
    "start": "1566400",
    "end": "1573440"
  },
  {
    "text": "big this patch fits area is where do i figure it out and i'm staring at this documentation from microsoft for",
    "start": "1573440",
    "end": "1579360"
  },
  {
    "text": "hours nothing's coming to my mind and finally i just",
    "start": "1579360",
    "end": "1584720"
  },
  {
    "text": "brought up sdp to xml and ida and figured out how they how did they do it and they're using this undocumented",
    "start": "1584720",
    "end": "1590240"
  },
  {
    "text": "function called git tag data size and that will give you the size you need",
    "start": "1590240",
    "end": "1595520"
  },
  {
    "text": "this api does not contain the code to actually parse out what these in memory patch",
    "start": "1595520",
    "end": "1600960"
  },
  {
    "text": "bits areas are so that's something we're going to get to",
    "start": "1600960",
    "end": "1606400"
  },
  {
    "text": "so the sq files themselves are binary files",
    "start": "1606799",
    "end": "1613360"
  },
  {
    "text": "um here's a very simple yar rule if you guys are searching for for files on your computer um you'll find a lot",
    "start": "1613360",
    "end": "1620960"
  },
  {
    "text": "there's a lot of default sdv files on your computer there are stp files that are packaged",
    "start": "1620960",
    "end": "1626799"
  },
  {
    "text": "with installers for old games to make sure that you know the resolution is set right so this will",
    "start": "1626799",
    "end": "1633840"
  },
  {
    "text": "get you a lot of crap by using the signature so it might be better to modify this to look for not",
    "start": "1633840",
    "end": "1641279"
  },
  {
    "text": "only this magic string sdbf but also look for these files that contain a patch",
    "start": "1641279",
    "end": "1649360"
  },
  {
    "text": "bits tag id within them as well so that's something that if you guys are",
    "start": "1649360",
    "end": "1654799"
  },
  {
    "text": "interested you can do",
    "start": "1654799",
    "end": "1657679"
  },
  {
    "start": "1659000",
    "end": "1692000"
  },
  {
    "text": "so here's the structure that i came up with first there's match operations replace",
    "start": "1660159",
    "end": "1666240"
  },
  {
    "text": "operations four and two respectively",
    "start": "1666240",
    "end": "1670559"
  },
  {
    "text": "you've got an op code which is either a match replace you've got the action size which is the total size",
    "start": "1671679",
    "end": "1679919"
  },
  {
    "text": "of this structure the pattern size for the number of bytes you want to search for or replace",
    "start": "1679919",
    "end": "1686960"
  },
  {
    "text": "the rva and then a module name",
    "start": "1686960",
    "end": "1692880"
  },
  {
    "text": "now if we take that and apply it to that same hex dump and kind of overlay it we get to start make some sense out of",
    "start": "1693360",
    "end": "1699520"
  },
  {
    "text": "this data so we see it starts with the number four which is for a match we",
    "start": "1699520",
    "end": "1705279"
  },
  {
    "text": "see 59 is the size of the first action so if we go to offset 59 in here",
    "start": "1705279",
    "end": "1713200"
  },
  {
    "text": "we see it's a 2 which would be a replace so we know that it's just patch bits or",
    "start": "1713200",
    "end": "1719120"
  },
  {
    "text": "patch action after patch action um five was that five that we had",
    "start": "1719120",
    "end": "1725520"
  },
  {
    "text": "highlighted before which is the number of bytes to search for this four bytes here is an rva",
    "start": "1725520",
    "end": "1733360"
  },
  {
    "text": "and then here is the module name which is null terminated and then after the module name which",
    "start": "1733360",
    "end": "1741120"
  },
  {
    "text": "is this pattern to search for you'll notice that there's this big block of crap",
    "start": "1741120",
    "end": "1748880"
  },
  {
    "text": "i'll call it from here to here that contains just random data",
    "start": "1748880",
    "end": "1755840"
  },
  {
    "text": "and this is kind of what i'm talking about with the simple information disclosure",
    "start": "1756080",
    "end": "1761200"
  },
  {
    "start": "1764000",
    "end": "1837000"
  },
  {
    "text": "and so that the module name field is a fixed length of 64 bytes",
    "start": "1765600",
    "end": "1772080"
  },
  {
    "text": "so 32 characters uh it contains uninitialized data from microsoft's",
    "start": "1772080",
    "end": "1777520"
  },
  {
    "text": "tools that they use to create these fix-its they don't zero it",
    "start": "1777520",
    "end": "1785039"
  },
  {
    "text": "i've told them about this and they released this last one and still had initialized data so i don't know if they",
    "start": "1785120",
    "end": "1791200"
  },
  {
    "text": "really care um i i added an option to my tool",
    "start": "1791200",
    "end": "1796799"
  },
  {
    "text": "the stash l and it will go through and grab all that uninitialized data out of each patch action um and save it to a",
    "start": "1796799",
    "end": "1804720"
  },
  {
    "text": "file for you i've done that for the four fix it that i've mentioned",
    "start": "1804720",
    "end": "1809760"
  },
  {
    "text": "at the beginning i didn't find anything useful but maybe someone can get something useful out of it it's",
    "start": "1809760",
    "end": "1815360"
  },
  {
    "text": "i don't know it's either stack or heap data and whatever tool that microsoft uses to",
    "start": "1815360",
    "end": "1820720"
  },
  {
    "text": "create these things so it's kind of neat but the fixed patches that are created using",
    "start": "1820720",
    "end": "1826640"
  },
  {
    "text": "my tool i make sure to zero this out so i've mentioned it a few times let's",
    "start": "1826640",
    "end": "1832799"
  },
  {
    "text": "start talking about my tool here",
    "start": "1832799",
    "end": "1837840"
  },
  {
    "text": "um i've already mentioned how you can go about installing sw files with my tool uh how you can print match",
    "start": "1838559",
    "end": "1845600"
  },
  {
    "text": "edit trees and how you can dump this leaked memory so we're going to focus on",
    "start": "1845600",
    "end": "1850960"
  },
  {
    "text": "what i call printing a tree printing out the patch details and creating patches so",
    "start": "1850960",
    "end": "1859600"
  },
  {
    "text": "this is the print tree option is dash t and this prints very similar information",
    "start": "1862399",
    "end": "1868960"
  },
  {
    "text": "to uh stp to xml but there's a couple additions besides it probably",
    "start": "1868960",
    "end": "1875360"
  },
  {
    "text": "looks ugly on the left of each tag",
    "start": "1875360",
    "end": "1881919"
  },
  {
    "text": "is a tag id followed by tag and this tag code here",
    "start": "1881919",
    "end": "1887760"
  },
  {
    "text": "705 means patch zero 6001 means name those numbers there",
    "start": "1887760",
    "end": "1893519"
  },
  {
    "text": "are documented by microsoft what they made but what's what i think is cool about this is now",
    "start": "1893519",
    "end": "1899519"
  },
  {
    "text": "this is the same information we had before with interexplore the matching file entries",
    "start": "1899519",
    "end": "1906000"
  },
  {
    "text": "and then the patch ref we see is 218 or hex da now we see that this is",
    "start": "1906000",
    "end": "1912720"
  },
  {
    "text": "actually di a up here so now we have that linkage between a particular",
    "start": "1912720",
    "end": "1920399"
  },
  {
    "text": "match entry and associated patch bits area so we can tie the two together",
    "start": "1920399",
    "end": "1927519"
  },
  {
    "text": "to view patches you need to use one of these five things either a",
    "start": "1928320",
    "end": "1934320"
  },
  {
    "text": "patched id or a patch bits id or patch ref id",
    "start": "1934320",
    "end": "1939840"
  },
  {
    "text": "or patch tag id or checksum and so i've highlighted them on this on this slide here",
    "start": "1939840",
    "end": "1949840"
  },
  {
    "text": "oops um so the tool has two different options for",
    "start": "1950159",
    "end": "1955519"
  },
  {
    "start": "1951000",
    "end": "2015000"
  },
  {
    "text": "displaying patches p and s p you use for",
    "start": "1955519",
    "end": "1961039"
  },
  {
    "text": "all those patch tag ids that i was talking about before s you'll have to use with the checksum",
    "start": "1961039",
    "end": "1969440"
  },
  {
    "text": "excuse me so this displays out the information nicely it shows you the module that they're",
    "start": "1971919",
    "end": "1977440"
  },
  {
    "text": "targeting for the particular action whether it was a match or replace action size parent size the rva where",
    "start": "1977440",
    "end": "1984960"
  },
  {
    "text": "this is at and then the bytes so this is going to do a match operation",
    "start": "1984960",
    "end": "1990320"
  },
  {
    "text": "at the rva these bytes and then i show the disassembly of those five bytes which is that's just um",
    "start": "1990320",
    "end": "1997360"
  },
  {
    "text": "the standard function beginning and then the second action here was a replace action",
    "start": "1997360",
    "end": "2004159"
  },
  {
    "text": "that rva and makes it a jump and that's the same thing that we saw",
    "start": "2004159",
    "end": "2009679"
  },
  {
    "text": "using the check image extension now this",
    "start": "2009679",
    "end": "2016159"
  },
  {
    "start": "2015000",
    "end": "2082000"
  },
  {
    "text": "if you give the dash i option this will dump it in a uh ida python script format",
    "start": "2016159",
    "end": "2023519"
  },
  {
    "text": "i was originally writing a ida plugin for this and i found the process not fun",
    "start": "2023519",
    "end": "2031120"
  },
  {
    "text": "and i was running out of time and i ended up just making this happen real quick so uh",
    "start": "2031120",
    "end": "2037760"
  },
  {
    "text": "basically you bring in the module that you care about into ida you you know run this tool against your",
    "start": "2037760",
    "end": "2043200"
  },
  {
    "text": "sv file copy and paste this into to ida run it um and this will print in the console",
    "start": "2043200",
    "end": "2049200"
  },
  {
    "text": "window uh that it's patching so many bytes at some address and then you can either go into",
    "start": "2049200",
    "end": "2054560"
  },
  {
    "text": "your patch bytes menu or you can just double click in the console window and it will bring you to the associated",
    "start": "2054560",
    "end": "2060320"
  },
  {
    "text": "code regions where this happens and so we can see here that these",
    "start": "2060320",
    "end": "2067520"
  },
  {
    "text": "two small ones are that's just applying that hook that's making the jump",
    "start": "2067520",
    "end": "2073040"
  },
  {
    "text": "and these big lines here that's where it's putting the additional code at the end of the",
    "start": "2073040",
    "end": "2078480"
  },
  {
    "text": "image okay so let's let's talk about how we",
    "start": "2078480",
    "end": "2084960"
  },
  {
    "start": "2082000",
    "end": "2122000"
  },
  {
    "text": "can create our own fix-its uh required information you need a target you need a",
    "start": "2084960",
    "end": "2092079"
  },
  {
    "text": "target module or modules so that could be a dll within the application that you're",
    "start": "2092079",
    "end": "2098000"
  },
  {
    "text": "targeting or it could be the application itself and a requirement because of that fixed length field",
    "start": "2098000",
    "end": "2104240"
  },
  {
    "text": "is that the name has to be less than 32 characters so 31 and it needs to have that null",
    "start": "2104240",
    "end": "2110640"
  },
  {
    "text": "terminator at the end you need to know the rbas that you're targeting for either match replaces",
    "start": "2110640",
    "end": "2117520"
  },
  {
    "text": "and the bytes that you want to put there implementation specific",
    "start": "2117520",
    "end": "2122960"
  },
  {
    "start": "2122000",
    "end": "2231000"
  },
  {
    "text": "so i created a config file that my tool processes to create these they have to",
    "start": "2123839",
    "end": "2131119"
  },
  {
    "text": "begin and end with these you know tags that i have you specify the application name",
    "start": "2131119",
    "end": "2137440"
  },
  {
    "text": "uh db name could be anything that's what will end up that will end up in your registry um",
    "start": "2137440",
    "end": "2145200"
  },
  {
    "text": "when i when i showed the screenshot before there was one that looked like a comment it was",
    "start": "2145200",
    "end": "2151119"
  },
  {
    "text": "cve you know xyz that's what will show up in db name",
    "start": "2151119",
    "end": "2156720"
  },
  {
    "text": "you can have some comments and there's really three things you can do there's p r and m r so p will define",
    "start": "2156720",
    "end": "2164640"
  },
  {
    "text": "um a new matching files entry and so within a matching files entry all",
    "start": "2164640",
    "end": "2171280"
  },
  {
    "text": "i allow you to do is give a target module which can be a dll or some type of image name and option",
    "start": "2171280",
    "end": "2179040"
  },
  {
    "text": "optionally you can have ap checksum within a p tag you can have",
    "start": "2179040",
    "end": "2185520"
  },
  {
    "text": "r or mr r does a replace action um i i think looking back i probably",
    "start": "2185520",
    "end": "2192960"
  },
  {
    "text": "should have called this um a write action it makes more sense but when i originally did this i call",
    "start": "2192960",
    "end": "2198480"
  },
  {
    "text": "this replay so it's it's all over the place now it makes more sense to just call it right",
    "start": "2198480",
    "end": "2204960"
  },
  {
    "text": "so right you have a target module again the rva and a hex string of bytes that you want",
    "start": "2204960",
    "end": "2210960"
  },
  {
    "text": "to write to that particular rba",
    "start": "2210960",
    "end": "2215839"
  },
  {
    "text": "mrrs does a match replace combo so you give it rva you give your hex",
    "start": "2217119",
    "end": "2223040"
  },
  {
    "text": "string that you want to search for and then the hex string that you want to to right there",
    "start": "2223040",
    "end": "2229838"
  },
  {
    "start": "2231000",
    "end": "2262000"
  },
  {
    "text": "okay so i created a sample target that we can go after this is included in the github",
    "start": "2231680",
    "end": "2237599"
  },
  {
    "text": "repository basically this code loads ms html dll",
    "start": "2237599",
    "end": "2243839"
  },
  {
    "text": "it does get proc addressed for this export function for html it prints out",
    "start": "2243839",
    "end": "2249839"
  },
  {
    "text": "the rba for you and prints out 15 bytes of memory starting at the rba minus five",
    "start": "2249839",
    "end": "2255599"
  },
  {
    "text": "and then uh prints out the disassembly for you so it gives it something to some target",
    "start": "2255599",
    "end": "2263040"
  },
  {
    "start": "2262000",
    "end": "2366000"
  },
  {
    "text": "now i i took that same screen from the prior slide put it here and i've got a",
    "start": "2263680",
    "end": "2270480"
  },
  {
    "text": "sample configuration for this target program i hope you guys can see this okay but",
    "start": "2270480",
    "end": "2277440"
  },
  {
    "text": "again you have your application name some type of comment then we're going to i wanted to target",
    "start": "2277440",
    "end": "2284560"
  },
  {
    "text": "this ms html dll dll within this target application",
    "start": "2284560",
    "end": "2289839"
  },
  {
    "text": "and i want to do a match replace action for this dll at this rva 50b",
    "start": "2289839",
    "end": "2297599"
  },
  {
    "text": "that's here 50b i'm going to look for these up codes which is what i've got",
    "start": "2297599",
    "end": "2303760"
  },
  {
    "text": "listed here and i'm going to replace that with cccc",
    "start": "2303760",
    "end": "2308960"
  },
  {
    "text": "then i'm going to do replace action for the same dll at 506 which is up here at the beginning",
    "start": "2308960",
    "end": "2317280"
  },
  {
    "text": "and i'm just going to put the bytes 1 2 3 4 there",
    "start": "2317280",
    "end": "2321680"
  },
  {
    "text": "so using the tool you give the dash capital c option with the configuration file that you've created",
    "start": "2324839",
    "end": "2331920"
  },
  {
    "text": "and dash o to just give an output name for the sd file that",
    "start": "2331920",
    "end": "2338000"
  },
  {
    "text": "you're creating now this is this process is the config file um it prints out some debug information",
    "start": "2338000",
    "end": "2344240"
  },
  {
    "text": "this was really for me um but it may be useful to you guys",
    "start": "2344240",
    "end": "2349280"
  },
  {
    "text": "while you're doing this as well then we take this stb file",
    "start": "2349280",
    "end": "2356480"
  },
  {
    "text": "we go back to the program again and run it with the dash r to install it or we use sdb inst if we",
    "start": "2356480",
    "end": "2362880"
  },
  {
    "text": "don't care about the add remove programs thing and we install in the system then",
    "start": "2362880",
    "end": "2368160"
  },
  {
    "start": "2366000",
    "end": "2395000"
  },
  {
    "text": "when we rerun sample target we can see that at offset b",
    "start": "2368160",
    "end": "2374640"
  },
  {
    "text": "there is cccc so it properly did the match replace and then we can see",
    "start": "2374640",
    "end": "2380720"
  },
  {
    "text": "that it did overwrite at 506 with one two three four and the disassembly there doesn't really",
    "start": "2380720",
    "end": "2387200"
  },
  {
    "text": "make sense because one two three four is something weird um so how does this all work",
    "start": "2387200",
    "end": "2394800"
  },
  {
    "start": "2395000",
    "end": "2460000"
  },
  {
    "text": "um whether you double click on something whether you run something from the command line",
    "start": "2395200",
    "end": "2400320"
  },
  {
    "text": "it's the parent processor's job to do a create process which calls create process internal",
    "start": "2400320",
    "end": "2406319"
  },
  {
    "text": "and the create process internal determines if the target needs to be shimmed it goes to the registry to that",
    "start": "2406319",
    "end": "2412400"
  },
  {
    "text": "custom folder it looks does this image name match what i'm about to run",
    "start": "2412400",
    "end": "2418000"
  },
  {
    "text": "then is there an associated shim database file for this application if it does it sets some loader flags and",
    "start": "2418000",
    "end": "2423520"
  },
  {
    "text": "lets the the child start up the child's p loader looks for a flag that's set and",
    "start": "2423520",
    "end": "2431599"
  },
  {
    "text": "determines if it should attempt to look for shims",
    "start": "2431599",
    "end": "2436880"
  },
  {
    "text": "so yeah it uses us to determine if it should look for shims uh so if it's there it will do that same go",
    "start": "2436880",
    "end": "2442400"
  },
  {
    "text": "to the registry my target yes there's a ftp file for me",
    "start": "2442400",
    "end": "2447599"
  },
  {
    "text": "apply it um this is kind of very vague what i'm saying here",
    "start": "2447599",
    "end": "2453040"
  },
  {
    "text": "but uh alex did uh gave some details about how this works he should read uh his blog",
    "start": "2453040",
    "end": "2460640"
  },
  {
    "start": "2460000",
    "end": "2530000"
  },
  {
    "text": "so for debugging this you can set this environment variable here and",
    "start": "2460640",
    "end": "2466160"
  },
  {
    "text": "this is output from sysinternals debug view and it's kind of small i apologize but",
    "start": "2466160",
    "end": "2474800"
  },
  {
    "text": "i'll just point out a couple things it has the application name here at the beginning this says st.exe",
    "start": "2474800",
    "end": "2482480"
  },
  {
    "text": "just think of that as sample target then it clears",
    "start": "2482480",
    "end": "2488720"
  },
  {
    "text": "some flags that was set then it attempts to do a patch and it",
    "start": "2488720",
    "end": "2495440"
  },
  {
    "text": "fails because ms-html dll has not been loaded yet into the process memory space",
    "start": "2495440",
    "end": "2501040"
  },
  {
    "text": "later on we see uh sc dll loaded says hey i finished loading",
    "start": "2501040",
    "end": "2507640"
  },
  {
    "text": "mshtmldll then sc i apply patch",
    "start": "2507640",
    "end": "2513200"
  },
  {
    "text": "actually does the action it does the rights it does the match does the rights and it says yes i've",
    "start": "2513200",
    "end": "2520160"
  },
  {
    "text": "successfully applied one-on-one patches",
    "start": "2520160",
    "end": "2523838"
  },
  {
    "text": "so now let's talk about maintaining persistence so very simply we can just target",
    "start": "2527119",
    "end": "2535040"
  },
  {
    "start": "2530000",
    "end": "2588000"
  },
  {
    "text": "explore.exe patch win maim hook it to create process calc so",
    "start": "2535040",
    "end": "2542560"
  },
  {
    "text": "this is a sample config file for explorer uh win764 bit",
    "start": "2542560",
    "end": "2548880"
  },
  {
    "text": "you give a p entry for explore.exe because it doesn't have to be a dll you",
    "start": "2549280",
    "end": "2555040"
  },
  {
    "text": "give the i gave it a pacific uh p checksum that i care about uh this",
    "start": "2555040",
    "end": "2560480"
  },
  {
    "text": "rva here is for win main and i overwrite the first bytes with a",
    "start": "2560480",
    "end": "2567280"
  },
  {
    "text": "jump then this is at the end of the image size that's just my show code",
    "start": "2567280",
    "end": "2574000"
  },
  {
    "text": "included in github is the configuration files for 1732-bit 64-bit and one eight 32-bit",
    "start": "2574000",
    "end": "2582720"
  },
  {
    "text": "so if you took this created used the tool with the dash c",
    "start": "2582720",
    "end": "2589520"
  },
  {
    "start": "2588000",
    "end": "2608000"
  },
  {
    "text": "and then get the output from the eye to python",
    "start": "2589520",
    "end": "2594640"
  },
  {
    "text": "script load explorer into ida this is what basically what you'll see",
    "start": "2594640",
    "end": "2599680"
  },
  {
    "text": "so before i fix it i have to fix it it just has that jump instruction that's all i'm doing",
    "start": "2599680",
    "end": "2606000"
  },
  {
    "text": "if you follow that jump this is my shell code i don't write",
    "start": "2606000",
    "end": "2611920"
  },
  {
    "start": "2608000",
    "end": "2626000"
  },
  {
    "text": "shell code for a living so don't laugh at it basically i'm just i save all the registers i",
    "start": "2611920",
    "end": "2618000"
  },
  {
    "text": "call create process restore the registers and jump back to jump back to main so what can we do",
    "start": "2618000",
    "end": "2625359"
  },
  {
    "text": "about this uh you can disable the shim engine you can do it through group policy",
    "start": "2625359",
    "end": "2631359"
  },
  {
    "start": "2626000",
    "end": "2656000"
  },
  {
    "text": "i don't recommend doing this it'll break emit it will basically make these zero day",
    "start": "2631359",
    "end": "2639599"
  },
  {
    "text": "fixes that microsoft releases pointless but it is possible",
    "start": "2639599",
    "end": "2644880"
  },
  {
    "text": "there's probably some other unintended consequences of disabling it",
    "start": "2644880",
    "end": "2652160"
  },
  {
    "text": "you should search your search your registry",
    "start": "2653680",
    "end": "2659040"
  },
  {
    "start": "2656000",
    "end": "2819000"
  },
  {
    "text": "file system for sap files use user yarmouth provided",
    "start": "2659040",
    "end": "2664640"
  },
  {
    "text": "your system is going to have ftp files they're normal they're not all bad there's lots of lots",
    "start": "2665359",
    "end": "2672400"
  },
  {
    "text": "of good good ones out there but you can use the knowledge again today how to use some of these tools to be",
    "start": "2672400",
    "end": "2677920"
  },
  {
    "text": "able to figure out what are these files actually doing on your system and then you can focus on",
    "start": "2677920",
    "end": "2683839"
  },
  {
    "text": "okay i know all these are normal this one doesn't look normal what does this actually do",
    "start": "2683839",
    "end": "2689440"
  },
  {
    "text": "auto runs from sysinternals does not consider application compatibility fixes as",
    "start": "2689440",
    "end": "2696640"
  },
  {
    "text": "as a persistence mechanism so whether they're something like i created here this in-memory patch fix it",
    "start": "2697440",
    "end": "2705200"
  },
  {
    "text": "or some of the things that mark badger talked about assistant turtles does not",
    "start": "2705200",
    "end": "2710640"
  },
  {
    "text": "consider it i told microsoft that they should add signature support to ftb files",
    "start": "2710640",
    "end": "2717200"
  },
  {
    "text": "you know my copy of explore is signed but yet it lets me have my unsigned",
    "start": "2717200",
    "end": "2723839"
  },
  {
    "text": "code patch it in memory and do weird things so maybe they should let us know that",
    "start": "2723839",
    "end": "2730240"
  },
  {
    "text": "some non-signed stb file is running or about to run",
    "start": "2730240",
    "end": "2735680"
  },
  {
    "text": "and this is a feature this is not something that's making you more vulnerable having this",
    "start": "2737440",
    "end": "2744000"
  },
  {
    "text": "default on your system someone needs to be administrator on",
    "start": "2744000",
    "end": "2749760"
  },
  {
    "text": "your box to install these so if they're that far you're already",
    "start": "2749760",
    "end": "2754880"
  },
  {
    "text": "owned but this is kind of just a new way that you might not be considering how they're maintaining persistence on your system",
    "start": "2754880",
    "end": "2762800"
  },
  {
    "text": "and this third bullet is really what is i think is awesome this provides a",
    "start": "2764000",
    "end": "2770880"
  },
  {
    "text": "great opportunity to figure out what microsoft is doing fixing things it's so much easier to look at",
    "start": "2770880",
    "end": "2778800"
  },
  {
    "text": "two changes versus hundreds of changes to try to figure out what microsoft did to try to prevent",
    "start": "2778800",
    "end": "2783839"
  },
  {
    "text": "exploitation and i don't know if i mentioned this earlier uh exodus intel guys",
    "start": "2783839",
    "end": "2790640"
  },
  {
    "text": "looked at some uh fix-its i can't remember which one it was off the top of my head but they showed",
    "start": "2790640",
    "end": "2796560"
  },
  {
    "text": "within you know probably a day or a couple hours probably that the fix it that microsoft provided for something",
    "start": "2796560",
    "end": "2802720"
  },
  {
    "text": "was totally insufficient that they could find a way around that to continue to get code exact",
    "start": "2802720",
    "end": "2808560"
  },
  {
    "text": "um and so now you guys should know about these",
    "start": "2808560",
    "end": "2814400"
  },
  {
    "text": "tools which will help you do your analysis",
    "start": "2814400",
    "end": "2819599"
  },
  {
    "start": "2819000",
    "end": "2834000"
  },
  {
    "text": "so here's some references if you guys are really interested in this you should read the the paper that's on the conference cd",
    "start": "2820480",
    "end": "2828799"
  },
  {
    "text": "lots of good information there um thanks to my wife and friends",
    "start": "2829040",
    "end": "2837359"
  },
  {
    "text": "um my wife and i just had a baby last week one week old and i had to leave which kind of sucked so thank her",
    "start": "2837359",
    "end": "2845280"
  },
  {
    "text": "thanks to microsoft eyesight and black hat and this is i can reach me",
    "start": "2845280",
    "end": "2852720"
  },
  {
    "start": "2850000",
    "end": "2966000"
  },
  {
    "text": "my email twitter and this source code link this is not on the conference cd so you can take a picture",
    "start": "2852720",
    "end": "2859680"
  },
  {
    "text": "or send me an email and i'll send it to you later and i don't know if we've got time for",
    "start": "2859680",
    "end": "2864720"
  },
  {
    "text": "questions or not anyone have questions",
    "start": "2864720",
    "end": "2873838"
  },
  {
    "text": "uh the question was does the in-memory patch invalid the signature as shown by",
    "start": "2882800",
    "end": "2890000"
  },
  {
    "text": "process explorer and i don't know the answer to that question i would guess no",
    "start": "2890000",
    "end": "2896800"
  },
  {
    "text": "anyone else",
    "start": "2897280",
    "end": "2901839"
  },
  {
    "text": "uh",
    "start": "2912839",
    "end": "2915839"
  },
  {
    "text": "right so my the question was do i plan on continuing to work on the",
    "start": "2922480",
    "end": "2927920"
  },
  {
    "text": "ida pro plug-in and probably not",
    "start": "2927920",
    "end": "2933440"
  },
  {
    "text": "and i don't think these happen often enough or it's worth my time to try to develop",
    "start": "2933440",
    "end": "2940720"
  },
  {
    "text": "one i thought it was a very painful process to do it was my first time ever trying",
    "start": "2940720",
    "end": "2946000"
  },
  {
    "text": "and i've got better things to do",
    "start": "2946000",
    "end": "2950800"
  },
  {
    "text": "anyone else",
    "start": "2952079",
    "end": "2957599"
  },
  {
    "text": "all right well thank you if you've got anything else you can come up and see me",
    "start": "2957599",
    "end": "2962078"
  },
  {
    "text": "after",
    "start": "2965160",
    "end": "2968160"
  }
]