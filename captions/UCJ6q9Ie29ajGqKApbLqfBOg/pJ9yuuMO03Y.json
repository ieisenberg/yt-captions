[
  {
    "text": "good afternoon uh my name is John Ericson this is persistent using abusing",
    "start": "240",
    "end": "5359"
  },
  {
    "text": "Microsoft fixed patches i apologize my laptop somehow does not work with the system so um I'm going to be clicking",
    "start": "5359",
    "end": "14400"
  },
  {
    "text": "this and this at the same time so it might get confusing there we go all right uh this",
    "start": "14400",
    "end": "21760"
  },
  {
    "text": "is me this my Twitter handle i don't tweet much uh but you can follow me if you want to i'm an engineer at Eyesight",
    "start": "21760",
    "end": "27920"
  },
  {
    "text": "Partners i've been there about three years now uh I focus on looking at",
    "start": "27920",
    "end": "33280"
  },
  {
    "text": "vulnerabilities uh exploits uh look at malware and a big",
    "start": "33280",
    "end": "38800"
  },
  {
    "text": "part of my job is looking at patches which is what this talk is about uh",
    "start": "38800",
    "end": "44000"
  },
  {
    "text": "every patch Tuesday look at Microsoft Adobe Oracle etc",
    "start": "44000",
    "end": "50280"
  },
  {
    "text": "um prior to Eyesight I was at the MITER Corporation for 5 years and before that",
    "start": "50280",
    "end": "55360"
  },
  {
    "text": "I was at uh in the Air Force and a couple defense contractors uh EyeSight Partners is a",
    "start": "55360",
    "end": "62719"
  },
  {
    "text": "intelligence threat provider if you would like more information about EyeSight please visit our website or come talk to me after the",
    "start": "62719",
    "end": "70960"
  },
  {
    "text": "talk okay so here's what we're going to talk about today give a little background about what these fixes",
    "start": "71080",
    "end": "76320"
  },
  {
    "text": "actually do um some tools they can use to Damn it sorry yeah that was my slide",
    "start": "76320",
    "end": "84880"
  },
  {
    "text": "for my company sorry and this is what we're talking about today um we're going to talk about some",
    "start": "84880",
    "end": "92320"
  },
  {
    "text": "tools that you can use to look at these uh fix patches some real world cases where Microsoft has utilized these fixes",
    "start": "92320",
    "end": "99200"
  },
  {
    "text": "to prevent uh exploitation um how I went about reverse engineering this fix it file format um a",
    "start": "99200",
    "end": "106560"
  },
  {
    "text": "simple information disclosure bug you might want to say that I found while doing this uh SDB",
    "start": "106560",
    "end": "112799"
  },
  {
    "text": "explorer which is the tool I wrote during the this research and how you can go about creating your own inmemory",
    "start": "112799",
    "end": "118399"
  },
  {
    "text": "patch fixit and how you can use that to maintain persistence okay so what are these",
    "start": "118399",
    "end": "126479"
  },
  {
    "text": "inmemory patch fixits they are a subset of application compatibility fixes uh",
    "start": "126479",
    "end": "132640"
  },
  {
    "text": "there's a bunch of different names out there uh they they're called shim databases they're called app compat app",
    "start": "132640",
    "end": "138800"
  },
  {
    "text": "compatibility fixes microsoft has a whole website dedicated to these fix it",
    "start": "138800",
    "end": "144400"
  },
  {
    "text": "it's the Microsoft fix it center um there's thousands out there",
    "start": "144400",
    "end": "149680"
  },
  {
    "text": "they provide a way to modify an application's behavior how it interacts",
    "start": "149680",
    "end": "155200"
  },
  {
    "text": "with Windows so um for example if you needed to modify your resolution for",
    "start": "155200",
    "end": "162319"
  },
  {
    "text": "some old program you could have a shim that does that if you wanted to uh",
    "start": "162319",
    "end": "167360"
  },
  {
    "text": "convert an old uh you know Windows NT app to make it work on Windows 7 you",
    "start": "167360",
    "end": "172720"
  },
  {
    "text": "might need to change some uh file uh locations or registry locations so you",
    "start": "172720",
    "end": "178879"
  },
  {
    "text": "can do that all with these shim databases um and emit uh Microsoft's",
    "start": "178879",
    "end": "184560"
  },
  {
    "text": "enhanc mitigation experience toolkit uh also works via this",
    "start": "184560",
    "end": "192000"
  },
  {
    "text": "mechanism so the the first public uh information I saw on this is from",
    "start": "193400",
    "end": "200519"
  },
  {
    "text": "Alex uh he made a blog back in 2007 called secrets of the application compatibility database uh I guess he",
    "start": "200519",
    "end": "208400"
  },
  {
    "text": "intended for it to be a nine-part blog series um he only did these first four",
    "start": "208400",
    "end": "213440"
  },
  {
    "text": "that I that I saw at least uh he gave a great introduction on the technology",
    "start": "213440",
    "end": "219599"
  },
  {
    "text": "some uh system shims that are built into Windows how the shim engine interacts",
    "start": "219599",
    "end": "224879"
  },
  {
    "text": "with the PE loader and um he never got to releasing his tool or this bullet",
    "start": "224879",
    "end": "232319"
  },
  {
    "text": "here uh 7 the runtime in memory patching behavior and analysis if he would have",
    "start": "232319",
    "end": "238640"
  },
  {
    "text": "released that blog entry I probably would not be here today talking about this",
    "start": "238640",
    "end": "243680"
  },
  {
    "text": "stuff um Mark Badget uh presented at DerbyCon last year uh he's mainly",
    "start": "244439",
    "end": "252319"
  },
  {
    "text": "focused on uh rootkits and doing penetration testing work so that's kind of his focus",
    "start": "252319",
    "end": "258639"
  },
  {
    "text": "he wants to do uh rootkit type things like process execution redirection and",
    "start": "258639",
    "end": "264160"
  },
  {
    "text": "API hooking and file system hiding registry hiding uh he showed how you",
    "start": "264160",
    "end": "269759"
  },
  {
    "text": "could disable security features of the OS like disabling ASLR or DEP for processes and how to execute back doors",
    "start": "269759",
    "end": "276400"
  },
  {
    "text": "he showed that you could do all this through the application compatibility framework that's built right into",
    "start": "276400",
    "end": "281560"
  },
  {
    "text": "Windows uh it's a very neat work he did not talk about inmemory patches which is",
    "start": "281560",
    "end": "287440"
  },
  {
    "text": "the focus of this talk but still cool stuff so what's the motivation why did I",
    "start": "287440",
    "end": "295520"
  },
  {
    "text": "want to get started doing this you know patch Tuesday comes out i diff the patch",
    "start": "295520",
    "end": "302160"
  },
  {
    "text": "for IE you find for for this example here 465 functions that match that means",
    "start": "302160",
    "end": "310479"
  },
  {
    "text": "you have to look through 465 functions that have there there's differences in",
    "start": "310479",
    "end": "316479"
  },
  {
    "text": "them and are those differences security related fixes are they just normal bug",
    "start": "316479",
    "end": "322400"
  },
  {
    "text": "fixes for Windows uh it's it's a hard job it takes a long time it takes a long",
    "start": "322400",
    "end": "328000"
  },
  {
    "text": "time to just load these DLS into IDA and run bendiff on them it takes hours uh if",
    "start": "328000",
    "end": "334320"
  },
  {
    "text": "you look at a fix it patch for this particular CD here there was two changes so within you know 5 minutes of",
    "start": "334320",
    "end": "341919"
  },
  {
    "text": "downloading this fix it running this tool you can see oh they changed this assembly instruction from a jump not",
    "start": "341919",
    "end": "349120"
  },
  {
    "text": "equal to a jump or they changed this to hook this function to redirect code",
    "start": "349120",
    "end": "354160"
  },
  {
    "text": "somewhere else um very cool stuff and that's what got me started in",
    "start": "354160",
    "end": "359400"
  },
  {
    "text": "this okay so now let's talk about some tools um there's a few by Microsoft",
    "start": "359400",
    "end": "367199"
  },
  {
    "text": "application compatibility toolkit STB toxml and SB inst um as well as CDD",
    "start": "367199",
    "end": "374240"
  },
  {
    "text": "which we'll talk about briefly and SD Explorer which is the tool I created uh during this",
    "start": "374240",
    "end": "380960"
  },
  {
    "text": "research damn it somebody yell at me if I forget to change the slide i believe you can look",
    "start": "382840",
    "end": "389600"
  },
  {
    "text": "at this monitor thank you okay so application compatibility",
    "start": "389600",
    "end": "395800"
  },
  {
    "text": "toolkit um this is freely available for download from Microsoft um it's a nice gooey tool that",
    "start": "395800",
    "end": "402960"
  },
  {
    "text": "allows you to point andclick and create nice application fixes however I don't",
    "start": "402960",
    "end": "408319"
  },
  {
    "text": "think it's very well documented i've got a couple examples here um that I I just made up uh pointer so I created a",
    "start": "408319",
    "end": "418599"
  },
  {
    "text": "compatibility fix here called shim via eatat which means it you're going to",
    "start": "418599",
    "end": "423919"
  },
  {
    "text": "hook a function via uh export address table entry um when you create this to",
    "start": "423919",
    "end": "430000"
  },
  {
    "text": "the guey it's nice point and click yeah I want to do a shim via eat and then it gives you a text box that says arguments",
    "start": "430000",
    "end": "437280"
  },
  {
    "text": "and it provides no documentation what's the format for that argument how do you know i I have no idea so uh it was very",
    "start": "437280",
    "end": "446240"
  },
  {
    "text": "confusing um they have fixes and they've got modes modes are a collection of fixes so I've",
    "start": "446240",
    "end": "453919"
  },
  {
    "text": "got the top one here is a compatibility fix and the bottom one's a compatibility mode uh what I really wanted to point",
    "start": "453919",
    "end": "460880"
  },
  {
    "text": "out here is the concept of matching files and so matching files for IE it",
    "start": "460880",
    "end": "468960"
  },
  {
    "text": "has to match this particular binary version company name product name etc if",
    "start": "468960",
    "end": "475599"
  },
  {
    "text": "that if those conditions are met then this compatibility fix will be applied",
    "start": "475599",
    "end": "481680"
  },
  {
    "text": "as well as the bottom if those conditions are met that compatibility mode will be",
    "start": "481680",
    "end": "487639"
  },
  {
    "text": "set um now if we take the same you know",
    "start": "487639",
    "end": "496160"
  },
  {
    "text": "toolkit guey here and bring in one of these fix it shims um we see the same",
    "start": "496160",
    "end": "501759"
  },
  {
    "text": "matching files entries like we saw in in the previous slide however there's no",
    "start": "501759",
    "end": "507599"
  },
  {
    "text": "compatibility fix listed here there's no compatibility mode listed here so how do you know what this does it's has like no",
    "start": "507599",
    "end": "516240"
  },
  {
    "text": "concept of what these inmemory fixit are or what they do so I'm guessing that",
    "start": "516240",
    "end": "522080"
  },
  {
    "text": "Microsoft has some internal version of this tool or maybe they use something a little bit different to create",
    "start": "522080",
    "end": "527320"
  },
  {
    "text": "these um okay um S3 to XML created by a",
    "start": "527320",
    "end": "534240"
  },
  {
    "text": "Microsoft employee uh back in 2007 so about the same time uh Alex was doing",
    "start": "534240",
    "end": "539680"
  },
  {
    "text": "his work um this can dump what's called patch bits information this big Oops",
    "start": "539680",
    "end": "546959"
  },
  {
    "text": "sorry this big blob of B 64 data you can also have it dump these patch bits",
    "start": "546959",
    "end": "554000"
  },
  {
    "text": "section uh into binary files on on disk",
    "start": "554000",
    "end": "559240"
  },
  {
    "text": "um now it I'm sorry if it's very small here uh",
    "start": "559240",
    "end": "566080"
  },
  {
    "text": "but you can see that this kind of has the same information that's provided in the application compatibility toolkit",
    "start": "566080",
    "end": "572640"
  },
  {
    "text": "it's got the application name it's got the matching file entries followed by here we get a little more information",
    "start": "572640",
    "end": "578399"
  },
  {
    "text": "now there's a patch ref item here so that means if this matching files entry",
    "start": "578399",
    "end": "584160"
  },
  {
    "text": "is met it will apply this patch ref and it's got a patch tag ID of",
    "start": "584160",
    "end": "590519"
  },
  {
    "text": "218 but what does 218 mean i have no idea this patch up here has no number",
    "start": "590519",
    "end": "597040"
  },
  {
    "text": "associated with it so is that 218 or is the one that's off the screen right now",
    "start": "597040",
    "end": "602720"
  },
  {
    "text": "above it or the one above that or how do you get this linkage of if that blob of",
    "start": "602720",
    "end": "608880"
  },
  {
    "text": "unknown data is for this particular uh version of uh MSHLDL",
    "start": "608880",
    "end": "616680"
  },
  {
    "text": "um CDD uh from Alex uh he never released",
    "start": "619399",
    "end": "624560"
  },
  {
    "text": "it he's got this show patches option",
    "start": "624560",
    "end": "628800"
  },
  {
    "text": "Thank you uh CDD by Alex he's got the show patches option um it's not clear if this",
    "start": "630640",
    "end": "640000"
  },
  {
    "text": "dumped out the B 64 encoded blob like STB to XML or if it um actually parsed",
    "start": "640000",
    "end": "646079"
  },
  {
    "text": "out this information uh in a in a better format but",
    "start": "646079",
    "end": "651279"
  },
  {
    "text": "um never released",
    "start": "651279",
    "end": "655000"
  },
  {
    "text": "okay so STB inst this is a file that's already on your computer it's a way for",
    "start": "656399",
    "end": "661440"
  },
  {
    "text": "you to install STB files if you were um",
    "start": "661440",
    "end": "666560"
  },
  {
    "text": "if you go to Microsoft's website and you can download the the MSI to install a",
    "start": "666560",
    "end": "672560"
  },
  {
    "text": "fix it but if you actually extract out what's in the MSI you'll end up with the STB file and this tool allows you to",
    "start": "672560",
    "end": "679560"
  },
  {
    "text": "install uh STB files via this mechanism whether they're STB files that",
    "start": "679560",
    "end": "685120"
  },
  {
    "text": "you create using the application compatibility framework or toolkit or uh ones that you download from Microsoft uh",
    "start": "685120",
    "end": "692160"
  },
  {
    "text": "you have to use the -p option when the SDV file contains uh inmemory",
    "start": "692160",
    "end": "699000"
  },
  {
    "text": "patches uh you have to be administrator to run this tool and uh we'll talk about",
    "start": "699000",
    "end": "705600"
  },
  {
    "text": "why later um also a side effect of this is that these",
    "start": "705600",
    "end": "712240"
  },
  {
    "text": "items show up in your ad remove programs dialogue um and Badget mentioned in his",
    "start": "712240",
    "end": "717600"
  },
  {
    "text": "Derbycon talk you know he's doing all these cool rootkit type things but then",
    "start": "717600",
    "end": "722959"
  },
  {
    "text": "he has to go and see that his you know rootkit fix it is in the ad programs",
    "start": "722959",
    "end": "728160"
  },
  {
    "text": "dialogue so not very not very stealthy",
    "start": "728160",
    "end": "733160"
  },
  {
    "text": "so u these are the default locations um and this is why you have to be",
    "start": "733560",
    "end": "738920"
  },
  {
    "text": "administrator because um STB inst and and my tool have to write to these uh",
    "start": "738920",
    "end": "744480"
  },
  {
    "text": "two registry locations HQ local machine um custom and uh installed SDB and so what",
    "start": "744480",
    "end": "752160"
  },
  {
    "text": "you'll find if you look at this location custom you'll find entries for applications that have shims applied so",
    "start": "752160",
    "end": "759120"
  },
  {
    "text": "you might find one for iix expplore.exe exe or for Winword or for Outlook or any",
    "start": "759120",
    "end": "764320"
  },
  {
    "text": "other program that may have had a inmemory fix it uh install one time this",
    "start": "764320",
    "end": "769839"
  },
  {
    "text": "is also uh where you'll see applications that have emit applied to them um under the entries in custom",
    "start": "769839",
    "end": "777760"
  },
  {
    "text": "there'll be a GID you follow that GID under the installed SDB folder and",
    "start": "777760",
    "end": "783200"
  },
  {
    "text": "you'll find um information like this",
    "start": "783200",
    "end": "788639"
  },
  {
    "text": "this shows you the the description which is just a comment it'll show you the database uh timestamp uh the location on",
    "start": "788639",
    "end": "796959"
  },
  {
    "text": "the file system where that SV file exists and the database type which in",
    "start": "796959",
    "end": "802240"
  },
  {
    "text": "this case this flag just means uh it's a shim database type um",
    "start": "802240",
    "end": "811519"
  },
  {
    "text": "okay i got bored and I played around with animations and that's all I got there this is kind of like my uh my cab",
    "start": "812680",
    "end": "820959"
  },
  {
    "text": "ride from the airport here it's pretty exciting um so this is my tool uh for",
    "start": "820959",
    "end": "827600"
  },
  {
    "text": "installing i'm going to talk more about my tool later but um you give the the",
    "start": "827600",
    "end": "832880"
  },
  {
    "text": "-ash r option with the stv file that you've you've got and you give you an application name uh that you want to",
    "start": "832880",
    "end": "839720"
  },
  {
    "text": "shim uh this does not show up in the ad remove programs um it does not copy the STB file to the",
    "start": "839720",
    "end": "848480"
  },
  {
    "text": "default locations i should have I should have mentioned back here actually",
    "start": "848480",
    "end": "853639"
  },
  {
    "text": "um this is the default locations that the SV in program copies the file to so",
    "start": "853639",
    "end": "861360"
  },
  {
    "text": "if you're installing a 32-bit patch it's going to put it in the app patch custom directory and if you're installing a",
    "start": "861360",
    "end": "867839"
  },
  {
    "text": "64-bit patch it's going to put it in the custom custom 64 directory",
    "start": "867839",
    "end": "874760"
  },
  {
    "text": "um my tool does not copy into these default locations so you need to be",
    "start": "874760",
    "end": "880399"
  },
  {
    "text": "aware of if you're making a patch for 65 64-bit program you need to have um",
    "start": "880399",
    "end": "888959"
  },
  {
    "text": "custom 64 somewhere in the full directory path that's how micros how Windows checks to see if you have got a",
    "start": "888959",
    "end": "896240"
  },
  {
    "text": "32-bit or 64-bit patch it just checks based on this directory name",
    "start": "896240",
    "end": "902600"
  },
  {
    "text": "um okay so let's talk about some real world cases where Microsoft has used this um the four most uh recent that",
    "start": "904519",
    "end": "912800"
  },
  {
    "text": "I've seen using the inmemory fix it type are these um just a quick note in the",
    "start": "912800",
    "end": "920000"
  },
  {
    "text": "news uh this week Microsoft put out an advisory about RTF vulnerability and in",
    "start": "920000",
    "end": "926560"
  },
  {
    "text": "their security advisor they mentioned a fix it patch that will help prevent it",
    "start": "926560",
    "end": "931600"
  },
  {
    "text": "that's not an in-memory fixit patch that will just disable word opening RTF files",
    "start": "931600",
    "end": "938880"
  },
  {
    "text": "essentially or processing them so they don't have they don't do it in memory patch",
    "start": "938880",
    "end": "945240"
  },
  {
    "text": "um so these these top three are IE fms the bottom one was a XML core services",
    "start": "945240",
    "end": "951519"
  },
  {
    "text": "bug and in all these cases the fixit were actually targeting IE so XML core",
    "start": "951519",
    "end": "961199"
  },
  {
    "text": "services is a systemwide library used by many applications such as you know word",
    "start": "961199",
    "end": "966720"
  },
  {
    "text": "and outlook um but Microsoft just released the fix fix it to pro protect",
    "start": "966720",
    "end": "972959"
  },
  {
    "text": "IE using that library not not other ones uh and we're going to focus on this",
    "start": "972959",
    "end": "979680"
  },
  {
    "text": "most recent one um for the rest of the talk",
    "start": "979680",
    "end": "985839"
  },
  {
    "text": "so this was public publicly disclosed by Fire Eye on February 11th being",
    "start": "985839",
    "end": "991519"
  },
  {
    "text": "exploited in the wild microsoft released a fix it on the 19th so that's 8 days uh",
    "start": "991519",
    "end": "998000"
  },
  {
    "text": "they already had a fix it out the door which is great so that you don't have to wait till the next uh patch cycle of",
    "start": "998000",
    "end": "1003680"
  },
  {
    "text": "patch Tuesday to be able to protect your enterprise um again using my tool which",
    "start": "1003680",
    "end": "1011920"
  },
  {
    "text": "we'll talk about later um this dash d option will essentially print out all",
    "start": "1011920",
    "end": "1018079"
  },
  {
    "text": "the matching file entries within the database so this particular um database",
    "start": "1018079",
    "end": "1025280"
  },
  {
    "text": "file there was eight different entries that they were targeting these versions",
    "start": "1025280",
    "end": "1030959"
  },
  {
    "text": "of um these versions of IE with these P",
    "start": "1030959",
    "end": "1037240"
  },
  {
    "text": "checks so IE9 and IE",
    "start": "1037240",
    "end": "1041760"
  },
  {
    "text": "10 uh and just you know a note on that if you don't have the if you didn't have",
    "start": "1044439",
    "end": "1049760"
  },
  {
    "text": "the latest versions of these DLS and installed to fix it it does nothing for",
    "start": "1049760",
    "end": "1055120"
  },
  {
    "text": "you you have to have these exact versions for this fix it to help you otherwise it it does nothing",
    "start": "1055120",
    "end": "1064120"
  },
  {
    "text": "so let's start talking about how we can figure out what this does now when I",
    "start": "1064120",
    "end": "1069280"
  },
  {
    "text": "first started research into this I didn't actually know about this um this",
    "start": "1069280",
    "end": "1074720"
  },
  {
    "text": "extension to window bug that I'm showing here and so it was a kind of a manual process i loaded up IE i did a memory",
    "start": "1074720",
    "end": "1082039"
  },
  {
    "text": "dump i installed the fix it patch i loaded IE again did another memory dump",
    "start": "1082039",
    "end": "1088080"
  },
  {
    "text": "and then did a binary compare of the two outputs to figure out where the bites",
    "start": "1088080",
    "end": "1093640"
  },
  {
    "text": "started where were they different essentially and um it was a pain in the",
    "start": "1093640",
    "end": "1099200"
  },
  {
    "text": "butt and this this um plugin here for wind debug is was very helpful so if you",
    "start": "1099200",
    "end": "1106400"
  },
  {
    "text": "want to play along at home this was the DL that I had running on my system when I ran these commands and what we see",
    "start": "1106400",
    "end": "1113080"
  },
  {
    "text": "here is before the fix it there's no corruption that's what this tool calls",
    "start": "1113080",
    "end": "1120240"
  },
  {
    "text": "um corruption or differences essentially and so if we see this memory range here",
    "start": "1120240",
    "end": "1126640"
  },
  {
    "text": "there was a five byt corruption uh if you've got symbols installed you'll see that this was it within the insert text",
    "start": "1126640",
    "end": "1133600"
  },
  {
    "text": "internal method and the expected five bytes are those",
    "start": "1133600",
    "end": "1138880"
  },
  {
    "text": "and the bytes it found there were those and there's a second",
    "start": "1138880",
    "end": "1144039"
  },
  {
    "text": "one now I've disassembled what those five bytes are the new five bytes are",
    "start": "1144039",
    "end": "1149200"
  },
  {
    "text": "down here and we can see they're both jump instructions and I don't have it on the screen but if",
    "start": "1149200",
    "end": "1155840"
  },
  {
    "text": "I would have showed the disassembly of the before fix it installed uh you would",
    "start": "1155840",
    "end": "1160960"
  },
  {
    "text": "see that it's a standard uh function prologue uh just you know move",
    "start": "1160960",
    "end": "1166360"
  },
  {
    "text": "edi push EVP etc so they're essentially hooking these two",
    "start": "1166360",
    "end": "1173919"
  },
  {
    "text": "functions and um we're going to talk about these bites",
    "start": "1174600",
    "end": "1179679"
  },
  {
    "text": "later so I bolded the things that I'm actually going to focus on later the address uh here ends in",
    "start": "1179679",
    "end": "1187160"
  },
  {
    "text": "70f there was a five byte corruption and if you can remember those",
    "start": "1187160",
    "end": "1192720"
  },
  {
    "text": "10 bytes remember them otherwise I'll remind you later okay so what's this fixet actually",
    "start": "1192720",
    "end": "1201280"
  },
  {
    "text": "do um if we look at what does that jump do we uh we see where it jumps we",
    "start": "1201280",
    "end": "1207679"
  },
  {
    "text": "disassemble that code and we can see that Microsoft has damn it",
    "start": "1207679",
    "end": "1214440"
  },
  {
    "text": "um saved all the registers called some additional function restored the registers um and then it will return",
    "start": "1214440",
    "end": "1221520"
  },
  {
    "text": "back to where um the jump came from this particular function that they're",
    "start": "1221520",
    "end": "1226559"
  },
  {
    "text": "additional function that they're calling increments a reference counter and this is a use after free bug so they are",
    "start": "1226559",
    "end": "1233600"
  },
  {
    "text": "making sure that they always increment this reference count um Microsoft actually wrote a blog about this and",
    "start": "1233600",
    "end": "1239280"
  },
  {
    "text": "they say you know we know that this produces a memory leak because we're never freeing this memory but at",
    "start": "1239280",
    "end": "1245280"
  },
  {
    "text": "least it's preventing the vulnerability from expo being exploited because we",
    "start": "1245280",
    "end": "1250320"
  },
  {
    "text": "avoid the free don't let it ever free um uh one other thing that I wanted to",
    "start": "1250320",
    "end": "1257760"
  },
  {
    "text": "point out this other code here did not show up in the check image",
    "start": "1257760",
    "end": "1264520"
  },
  {
    "text": "output as a corruption and we just saw the two jumps",
    "start": "1264520",
    "end": "1270080"
  },
  {
    "text": "not this additional code and the reason for that is the check image extension only considers uh code in the original",
    "start": "1270080",
    "end": "1277520"
  },
  {
    "text": "image size so any bytes that are outside of that image size are not considered",
    "start": "1277520",
    "end": "1282720"
  },
  {
    "text": "for potential corruption so basically Microsoft went to the end of execut",
    "start": "1282720",
    "end": "1288240"
  },
  {
    "text": "wrote this additional code and then just put a reference to it to jump to",
    "start": "1288240",
    "end": "1293760"
  },
  {
    "text": "it okay so let's continue on this quest of reverse",
    "start": "1294840",
    "end": "1299960"
  },
  {
    "text": "engineering and figure out how this patch pits formats um processed and how",
    "start": "1299960",
    "end": "1305840"
  },
  {
    "text": "the P loader handles it uh couple slides ago I I highlighted those byes in in",
    "start": "1305840",
    "end": "1312240"
  },
  {
    "text": "bold for you um this number five is uh it's little",
    "start": "1312240",
    "end": "1320880"
  },
  {
    "text": "Indian so it's least significant bit first bytes first so that's five was you",
    "start": "1320880",
    "end": "1326240"
  },
  {
    "text": "know for five byte corruption we see the EF70 those were the lower 16 bits of",
    "start": "1326240",
    "end": "1333120"
  },
  {
    "text": "that address we see these are the five bytes where",
    "start": "1333120",
    "end": "1339280"
  },
  {
    "text": "the expected five bytes this is another five followed by EF70 for some reason I",
    "start": "1339280",
    "end": "1345679"
  },
  {
    "text": "don't have that um boxed and then these are the five bytes that are now",
    "start": "1345679",
    "end": "1352159"
  },
  {
    "text": "corrupting those original five so this is a kind of a general idea",
    "start": "1352159",
    "end": "1358080"
  },
  {
    "text": "and let's see how Windows uh actually parses this information oh I should say that this this dump of hex right here if",
    "start": "1358080",
    "end": "1366080"
  },
  {
    "text": "you go back to the STB toxml tool and grab out that B 64 blob that's what it",
    "start": "1366080",
    "end": "1373200"
  },
  {
    "text": "looks like it's just these bites that's all I did",
    "start": "1373200",
    "end": "1377519"
  },
  {
    "text": "there okay so how does um here's a very high level view of what the preloader",
    "start": "1378919",
    "end": "1386880"
  },
  {
    "text": "does when it's applying inmemory uh fix it it's uh initializes the shim engine",
    "start": "1386880",
    "end": "1394240"
  },
  {
    "text": "it um resolves a function within the app help DLL called SE DLL loaded se stands",
    "start": "1394240",
    "end": "1402880"
  },
  {
    "text": "for shim engine uh within that function it calls patch new modules attempt",
    "start": "1402880",
    "end": "1408640"
  },
  {
    "text": "patches and um an apply patch",
    "start": "1408640",
    "end": "1413919"
  },
  {
    "text": "and the apply pack function is the one that actually does the work of processing this patch bits",
    "start": "1413919",
    "end": "1421519"
  },
  {
    "text": "information okay so here's some pseudo code representation of this function it takes a pointer to a patch bit structure",
    "start": "1423000",
    "end": "1430559"
  },
  {
    "text": "this is a a structure I I came up with so that's my name for it i don't know what Microsoft calls it um but",
    "start": "1430559",
    "end": "1436960"
  },
  {
    "text": "essentially it's just going to iterate through all um I I kind of call them",
    "start": "1436960",
    "end": "1442080"
  },
  {
    "text": "patch actions and a patch action can be either a match or a replace",
    "start": "1442080",
    "end": "1448280"
  },
  {
    "text": "action um so if it's a a match action it's just going to do a mem compare of",
    "start": "1448280",
    "end": "1454720"
  },
  {
    "text": "the pattern specified um for some module base plus an RVA for",
    "start": "1454720",
    "end": "1461200"
  },
  {
    "text": "that pattern size if it if it matches it continues along just fine and otherwise it returns uh out if it's a replace",
    "start": "1461200",
    "end": "1469520"
  },
  {
    "text": "action it's going to change the memory permission of the area specified so it",
    "start": "1469520",
    "end": "1474640"
  },
  {
    "text": "will go to that RVA for the number of bytes specified it will make that memory readwritable it will then copy the bytes",
    "start": "1474640",
    "end": "1482000"
  },
  {
    "text": "that you want into that new memory area and then restore the persons back to",
    "start": "1482000",
    "end": "1487039"
  },
  {
    "text": "original so readex here or whatever they were and then it flushes the instruction cache",
    "start": "1487039",
    "end": "1494039"
  },
  {
    "text": "um it'll continue to do this till it gets to um the end",
    "start": "1494039",
    "end": "1501278"
  },
  {
    "text": "essentially so along with the SEI apply patch function that we were just looking",
    "start": "1503240",
    "end": "1508880"
  },
  {
    "text": "at uh the Appel DL has 195 exports",
    "start": "1508880",
    "end": "1513919"
  },
  {
    "text": "microsoft has uh documented them somewhat at this location",
    "start": "1513919",
    "end": "1520159"
  },
  {
    "text": "um they don't provide uh any header files for you to use or a library to link against so it's kind of a a manual",
    "start": "1520159",
    "end": "1528080"
  },
  {
    "text": "process to to create those um the code that I'm releasing has all that header",
    "start": "1528080",
    "end": "1535200"
  },
  {
    "text": "information in there for you uh with all the function names and so save you some time uh this is",
    "start": "1535200",
    "end": "1543679"
  },
  {
    "text": "this library can be used to read and write or create STB files um the",
    "start": "1543679",
    "end": "1549840"
  },
  {
    "text": "documentation is definitely lacking it's you know been lacking for many",
    "start": "1549840",
    "end": "1555360"
  },
  {
    "text": "years like in 2007 Alex was talking about it lacking information so one",
    "start": "1555360",
    "end": "1561039"
  },
  {
    "text": "problem I was having with it was I want to extract out that patch bits area which is a binary field and you're",
    "start": "1561039",
    "end": "1568640"
  },
  {
    "text": "required to give this function a buffer and a buffer size and I'm thinking well",
    "start": "1568640",
    "end": "1574000"
  },
  {
    "text": "how do I know how big this patch pits area is where do I figure it out and I'm",
    "start": "1574000",
    "end": "1579120"
  },
  {
    "text": "staring at this documentation from Microsoft for hours nothing's coming to my mind and finally I just brought up",
    "start": "1579120",
    "end": "1586960"
  },
  {
    "text": "STB toxml and IDA and figured out how they how do they do it and they're using this undocumented function called get",
    "start": "1586960",
    "end": "1592960"
  },
  {
    "text": "tag data size and that will give you the the size you need uh this API does not",
    "start": "1592960",
    "end": "1598640"
  },
  {
    "text": "contain the code to actually parse out what these inmemory patch bits areas are",
    "start": "1598640",
    "end": "1604400"
  },
  {
    "text": "um so that's something we're going to get to",
    "start": "1604400",
    "end": "1610720"
  },
  {
    "text": "so the SP files themselves are binary files um here's a a very simple YAR rule",
    "start": "1611559",
    "end": "1617440"
  },
  {
    "text": "if you guys are searching for for files on your computer um you'll find a lot there's a lot of",
    "start": "1617440",
    "end": "1623760"
  },
  {
    "text": "default STB files on your computer there are STB files that are packaged with",
    "start": "1623760",
    "end": "1629360"
  },
  {
    "text": "installers for old games to make sure that you know the resolution is set",
    "start": "1629360",
    "end": "1634400"
  },
  {
    "text": "right so this will get you a lot of crap by using the signature so it might be",
    "start": "1634400",
    "end": "1640320"
  },
  {
    "text": "better to modify this to look for not only this magic uh string sdbf but also",
    "start": "1640320",
    "end": "1647039"
  },
  {
    "text": "look for these files that contain a patch bits tag ID within them as well",
    "start": "1647039",
    "end": "1654240"
  },
  {
    "text": "um so that's something that if you guys are interested in you can",
    "start": "1654240",
    "end": "1659520"
  },
  {
    "text": "do so here's the structure that I came up with uh first there's match",
    "start": "1661080",
    "end": "1667039"
  },
  {
    "text": "operations and replace operations four and two respectively",
    "start": "1667039",
    "end": "1672520"
  },
  {
    "text": "um you've got uh an op code which is either a match or replace you've got the",
    "start": "1672520",
    "end": "1677919"
  },
  {
    "text": "action size um which is the total size of this structure uh the pattern size for the",
    "start": "1677919",
    "end": "1684960"
  },
  {
    "text": "number of bytes you want to search for or replace uh the RVA",
    "start": "1684960",
    "end": "1690799"
  },
  {
    "text": "um and then a module name now if we take that and apply it to",
    "start": "1690799",
    "end": "1697200"
  },
  {
    "text": "that same hex dump and kind of overlay it we get to start make some sense out of this data so we see it starts with",
    "start": "1697200",
    "end": "1704159"
  },
  {
    "text": "the number four which is for a match we see 59 is the size of the first action",
    "start": "1704159",
    "end": "1712559"
  },
  {
    "text": "so if we go to offset 59 in here we see it's a two which would be a replace so",
    "start": "1712559",
    "end": "1718320"
  },
  {
    "text": "we know that it's just patch bits or patch action after patch action",
    "start": "1718320",
    "end": "1725000"
  },
  {
    "text": "um five was that five that we had highlighted before which is the number of bytes to search for this four bytes",
    "start": "1725000",
    "end": "1731919"
  },
  {
    "text": "here uh is an RVA and then here is the module name",
    "start": "1731919",
    "end": "1736960"
  },
  {
    "text": "which is null terminated and then after the module name which um is this pattern",
    "start": "1736960",
    "end": "1744000"
  },
  {
    "text": "to search for you'll notice that there's this big block of crap I'll call it from",
    "start": "1744000",
    "end": "1752480"
  },
  {
    "text": "here to here uh that contains just random data um and this is kind of what I'm",
    "start": "1752480",
    "end": "1759039"
  },
  {
    "text": "talking about with the simple information disclosure",
    "start": "1759039",
    "end": "1766399"
  },
  {
    "text": "um and so that that module name field is a fixed length of 64 bytes so 32",
    "start": "1766440",
    "end": "1774760"
  },
  {
    "text": "characters uh it contains uninitialized data from Microsoft's tools that they",
    "start": "1774760",
    "end": "1780240"
  },
  {
    "text": "use to create these fixit uh they don't zero it um I've told them about this and",
    "start": "1780240",
    "end": "1789840"
  },
  {
    "text": "they released this last one it still had uninitialized data so I don't know if they really care",
    "start": "1789840",
    "end": "1795320"
  },
  {
    "text": "um I I added an option to my tool this L and it will go through and grab all that",
    "start": "1795320",
    "end": "1802080"
  },
  {
    "text": "uninitialized data out of each patch action um and save it to a file for you",
    "start": "1802080",
    "end": "1807600"
  },
  {
    "text": "um I've done that for the four fix it that I've mentioned at the beginning i",
    "start": "1807600",
    "end": "1812880"
  },
  {
    "text": "didn't find anything useful but maybe someone can get something useful out of it it's I don't know it's",
    "start": "1812880",
    "end": "1818600"
  },
  {
    "text": "either stack or heap data and whatever tool that Microsoft uses to create these things so it's kind of neat but um the",
    "start": "1818600",
    "end": "1825840"
  },
  {
    "text": "fixed uh patches that are created using my tool I I make sure to zero this",
    "start": "1825840",
    "end": "1832039"
  },
  {
    "text": "out um so I've mentioned it a few times let's start talking about um my tool",
    "start": "1832039",
    "end": "1839399"
  },
  {
    "text": "here um I've already mentioned how you can go about installing STB files with",
    "start": "1839399",
    "end": "1844880"
  },
  {
    "text": "my tool uh how you can print match entries and how you can dump this leaked",
    "start": "1844880",
    "end": "1850159"
  },
  {
    "text": "memory so we're going to focus on what I call printing a tree printing out the",
    "start": "1850159",
    "end": "1855279"
  },
  {
    "text": "patch details and uh creating patches so",
    "start": "1855279",
    "end": "1862360"
  },
  {
    "text": "uh this is the print tree option it's - t and this prints very similar",
    "start": "1864080",
    "end": "1870320"
  },
  {
    "text": "information to uh http toxml uh but there's a couple additions besides it",
    "start": "1870320",
    "end": "1877039"
  },
  {
    "text": "probably looks ugly um on the left of each",
    "start": "1877039",
    "end": "1882760"
  },
  {
    "text": "tag is a tag ID followed by tag and this tag code",
    "start": "1882760",
    "end": "1889279"
  },
  {
    "text": "here 705 means patch 6001 means name those numbers there are",
    "start": "1889279",
    "end": "1895600"
  },
  {
    "text": "documented by Microsoft what they made but what's what I think is cool about this is now this is the same information",
    "start": "1895600",
    "end": "1903760"
  },
  {
    "text": "we had before with inner explorer the matching file entries and then the patch",
    "start": "1903760",
    "end": "1908799"
  },
  {
    "text": "ref we see is 218 or hex da now we see",
    "start": "1908799",
    "end": "1913840"
  },
  {
    "text": "that this is actually da up here so now we have that linkage",
    "start": "1913840",
    "end": "1919480"
  },
  {
    "text": "between a particular match entry and associated patch bits area um so we can",
    "start": "1919480",
    "end": "1926480"
  },
  {
    "text": "tie the two together um to view patches you need to",
    "start": "1926480",
    "end": "1932880"
  },
  {
    "text": "um use one of these five things either a patched ID or a patch bits ID or patch",
    "start": "1932880",
    "end": "1940320"
  },
  {
    "text": "ref ID or a patch tag ID or checks and so I've highlighted them on this on this",
    "start": "1940320",
    "end": "1946480"
  },
  {
    "text": "slide here oops",
    "start": "1946480",
    "end": "1954000"
  },
  {
    "text": "um so the tool has two different options for displaying patches p and S p you use",
    "start": "1954000",
    "end": "1961960"
  },
  {
    "text": "for all those patch tag IDs that I was talking about before s you'll have to",
    "start": "1961960",
    "end": "1967360"
  },
  {
    "text": "use with the the check",
    "start": "1967360",
    "end": "1971120"
  },
  {
    "text": "sum excuse me so this displays out the information nicely it shows you the",
    "start": "1972919",
    "end": "1978720"
  },
  {
    "text": "module that they're targeting the particular action whether it was a match or replace action size pattern size the",
    "start": "1978720",
    "end": "1985919"
  },
  {
    "text": "RVA where where this is at um and then the bytes so this is going to do a match",
    "start": "1985919",
    "end": "1991519"
  },
  {
    "text": "operation at the RVA these bytes and then I show the disassembly of those",
    "start": "1991519",
    "end": "1996559"
  },
  {
    "text": "five bytes which is that's just um the standard uh function beginning and then",
    "start": "1996559",
    "end": "2002960"
  },
  {
    "text": "the second action here was a replace action that RVA and makes it a jump and",
    "start": "2002960",
    "end": "2009279"
  },
  {
    "text": "that's the same thing that we saw uh using the check image extension um now",
    "start": "2009279",
    "end": "2017000"
  },
  {
    "text": "this if you give the dash I option this will dump it in a uh IDA Python script",
    "start": "2017000",
    "end": "2023760"
  },
  {
    "text": "format i was originally writing a IDA plugin for this and I found the process not fun",
    "start": "2023760",
    "end": "2032960"
  },
  {
    "text": "and um I was running out of time and I ended up just making this happen real quick so uh basically you bring in the",
    "start": "2032960",
    "end": "2040640"
  },
  {
    "text": "module that you care about into IDA you you know run this tool against your STB file copy and paste this into",
    "start": "2040640",
    "end": "2047679"
  },
  {
    "text": "to IDA run it um and this will print in the console window uh that it's patching",
    "start": "2047679",
    "end": "2053200"
  },
  {
    "text": "so many bytes at some address and then you can either go into your patched bytes menu or you can just double click",
    "start": "2053200",
    "end": "2058960"
  },
  {
    "text": "in the console window and it will bring you to the associated uh code regions where this happens",
    "start": "2058960",
    "end": "2064839"
  },
  {
    "text": "and so we can see here that um these two small ones are that's just applying that",
    "start": "2064839",
    "end": "2073040"
  },
  {
    "text": "hook that's making the jump and these big lines here that's where it's putting that additional code at the end of the",
    "start": "2073040",
    "end": "2080000"
  },
  {
    "text": "the image um okay so let's let's talk about how we",
    "start": "2080000",
    "end": "2086878"
  },
  {
    "text": "can create our own fixes uh required information you need a",
    "start": "2086879",
    "end": "2092118"
  },
  {
    "text": "target you need a target module or modules so that could be a DLL within",
    "start": "2092119",
    "end": "2099040"
  },
  {
    "text": "the application that you're targeting or it could be the application itself um and a requirement because of that fixed",
    "start": "2099040",
    "end": "2105359"
  },
  {
    "text": "length field is that the the name has to be less than 32 characters so 31 and it",
    "start": "2105359",
    "end": "2111839"
  },
  {
    "text": "needs to have that null terminator at the end uh you need to know the RBAS that you're",
    "start": "2111839",
    "end": "2117200"
  },
  {
    "text": "targeting for either match or replaces and the bytes that you want to put there it's implementation",
    "start": "2117200",
    "end": "2124400"
  },
  {
    "text": "specific so I created a a config file that my tool processes to create these",
    "start": "2124680",
    "end": "2131680"
  },
  {
    "text": "um they have to begin and end with these you know tags that I have you specify",
    "start": "2131680",
    "end": "2136880"
  },
  {
    "text": "the application name uh DB name could be anything that's what will end up um that will end up in",
    "start": "2136880",
    "end": "2144720"
  },
  {
    "text": "your registry um when I when I showed the the screenshot before there was one that",
    "start": "2144720",
    "end": "2150960"
  },
  {
    "text": "looked like a comment it was CVE you know XYZ that's what will show up in",
    "start": "2150960",
    "end": "2157400"
  },
  {
    "text": "DBame uh you can have some comments and there's really three things you can do there's P R and MR so P will define um a",
    "start": "2157400",
    "end": "2168079"
  },
  {
    "text": "new matching files entry and so within a matching files entry all I allow you to",
    "start": "2168079",
    "end": "2173920"
  },
  {
    "text": "do is give a target module which can be a DLL or some type of image name and",
    "start": "2173920",
    "end": "2180079"
  },
  {
    "text": "option uh optionally you can have a P checksum uh within a P tag you can have",
    "start": "2180079",
    "end": "2187560"
  },
  {
    "text": "R or MR r does a replace action um I I",
    "start": "2187560",
    "end": "2193520"
  },
  {
    "text": "think looking back I probably should have called this um a write action it makes more sense but when I originally",
    "start": "2193520",
    "end": "2199839"
  },
  {
    "text": "did this I called this replace so it's it's all over the place now makes more sense to just call it right um so write",
    "start": "2199839",
    "end": "2207520"
  },
  {
    "text": "you have a target module again the RVA and a hex string of bytes that you want",
    "start": "2207520",
    "end": "2212880"
  },
  {
    "text": "to write to that particular RVA",
    "start": "2212880",
    "end": "2217559"
  },
  {
    "text": "uh MRS does uh match replace combo so you give it RVA you give your hex string",
    "start": "2218880",
    "end": "2225200"
  },
  {
    "text": "that you want to search for and then the hex string that you want to to write",
    "start": "2225200",
    "end": "2231119"
  },
  {
    "text": "there okay so I created a sample target that we can go after uh this is included",
    "start": "2232599",
    "end": "2238320"
  },
  {
    "text": "in the GitHub repository uh basically this code uh loads MSH HTML DLL it does",
    "start": "2238320",
    "end": "2246880"
  },
  {
    "text": "uh get process for this uh exported function for HTML uh prints out the RBA",
    "start": "2246880",
    "end": "2252560"
  },
  {
    "text": "for you and prints out 15 bytes of memory starting at the RBA minus 5 and",
    "start": "2252560",
    "end": "2257760"
  },
  {
    "text": "then uh prints out the disassembly for you so it gives it something to some target",
    "start": "2257760",
    "end": "2265560"
  },
  {
    "text": "now I I took that same screen from the prior slide put it here and I've got a",
    "start": "2265599",
    "end": "2272400"
  },
  {
    "text": "sample configuration for this target program um I hope you guys can see this",
    "start": "2272400",
    "end": "2278040"
  },
  {
    "text": "okay but again you have your application name some type of comment um then we're",
    "start": "2278040",
    "end": "2284480"
  },
  {
    "text": "going to I wanted to target this MSHL DL DL within this target application and I",
    "start": "2284480",
    "end": "2292320"
  },
  {
    "text": "want to do a match replace action for this DLL at this RVA",
    "start": "2292320",
    "end": "2298599"
  },
  {
    "text": "50B that's here 50B i'm going to look for these up codes which is what I've",
    "start": "2298599",
    "end": "2305520"
  },
  {
    "text": "got listed here and I'm going to replace that with CCC then I'm going to do a replace",
    "start": "2305520",
    "end": "2312359"
  },
  {
    "text": "action for that same DL at 506 which is",
    "start": "2312359",
    "end": "2317680"
  },
  {
    "text": "up here at the beginning and I'm just going to put the bytes 1 2 3 4",
    "start": "2317680",
    "end": "2323440"
  },
  {
    "text": "there um so using the tool you give uh the dash capital C option with the",
    "start": "2325079",
    "end": "2331839"
  },
  {
    "text": "configuration file that you've created and - O to um just give an output name",
    "start": "2331839",
    "end": "2337440"
  },
  {
    "text": "for the ST file that um you're creating now this is this processes the config",
    "start": "2337440",
    "end": "2343359"
  },
  {
    "text": "file um it prints out some debug information this was really for me um but it may be useful to you guys",
    "start": "2343359",
    "end": "2351119"
  },
  {
    "text": "while you're doing this as well um then we take this STV file we go back to",
    "start": "2351119",
    "end": "2359440"
  },
  {
    "text": "the program again and run it with a dash r to install it or we use stv inst if we",
    "start": "2359440",
    "end": "2364800"
  },
  {
    "text": "don't care about the add remove programs thing and we install in the system then",
    "start": "2364800",
    "end": "2370000"
  },
  {
    "text": "when we rerun sample target we can see that at",
    "start": "2370000",
    "end": "2375160"
  },
  {
    "text": "offset B there is CCC so it properly did the match and",
    "start": "2375160",
    "end": "2380839"
  },
  {
    "text": "replace and then we can see that it did overwrite at 506 with 1 2 3 4 and the",
    "start": "2380839",
    "end": "2387680"
  },
  {
    "text": "the disassembly there doesn't really make sense because 1 2 3 4 is something weird um so how does this all",
    "start": "2387680",
    "end": "2396040"
  },
  {
    "text": "work um whether you double click on something whether you run something from the",
    "start": "2396040",
    "end": "2401359"
  },
  {
    "text": "command line it's a parent process's job to do a create process which calls",
    "start": "2401359",
    "end": "2406560"
  },
  {
    "text": "create process internal and the create process internal determines if the target needs to be shimmed it goes to",
    "start": "2406560",
    "end": "2413280"
  },
  {
    "text": "the registry to that custom uh folder it looks does this image name match what",
    "start": "2413280",
    "end": "2418480"
  },
  {
    "text": "I'm about to run then is there associated shim database file for this application if it does it sets some",
    "start": "2418480",
    "end": "2424079"
  },
  {
    "text": "loader flags and lets the the child uh start up uh the child's p loader looks",
    "start": "2424079",
    "end": "2431520"
  },
  {
    "text": "for a flag that's set and determines if it should attempt to look for",
    "start": "2431520",
    "end": "2437720"
  },
  {
    "text": "shims so yeah it uses this to determine if it should look for shims uh so if it's there it will do that same go to",
    "start": "2437720",
    "end": "2444400"
  },
  {
    "text": "the registry am I a target yes there's a STB file for me apply it",
    "start": "2444400",
    "end": "2451320"
  },
  {
    "text": "um this is kind of very vague what I'm saying here but uh Alex did a gave some",
    "start": "2451320",
    "end": "2457680"
  },
  {
    "text": "details about how this works so you should read uh his blog um so for debugging this you can",
    "start": "2457680",
    "end": "2465119"
  },
  {
    "text": "set this environment variable here and this is output from CIS internals debug",
    "start": "2465119",
    "end": "2471880"
  },
  {
    "text": "view and it's kind of small I apologize but I'll just point out a couple things",
    "start": "2471880",
    "end": "2478240"
  },
  {
    "text": "it has the application name here at the beginning this says st.exe um just think of that as sample",
    "start": "2478240",
    "end": "2485720"
  },
  {
    "text": "target um then it clears some flags that was",
    "start": "2485720",
    "end": "2493160"
  },
  {
    "text": "set then it attempts to do a patch and it fails because MSHTML DL has not been",
    "start": "2493160",
    "end": "2500160"
  },
  {
    "text": "loaded yet into the process memory space later on we see uh SE DL loaded says hey",
    "start": "2500160",
    "end": "2508400"
  },
  {
    "text": "I finished loading MSH HTML DLL then SE I apply",
    "start": "2508400",
    "end": "2514040"
  },
  {
    "text": "patch actually does the action it does the rights it does the match does the rights and it says yes I've successfully",
    "start": "2514040",
    "end": "2522560"
  },
  {
    "text": "applied one of one patches",
    "start": "2522560",
    "end": "2527200"
  },
  {
    "text": "um so now let's talk about maintaining persistence",
    "start": "2527960",
    "end": "2532960"
  },
  {
    "text": "So very simply we can just target explore.exe patch windm hook it to",
    "start": "2533119",
    "end": "2541359"
  },
  {
    "text": "create process uh calc so this is a sample config file for explorer uh wind",
    "start": "2541359",
    "end": "2547839"
  },
  {
    "text": "7 64-bit um you give a p entry for",
    "start": "2547839",
    "end": "2553720"
  },
  {
    "text": "explore.exe because it doesn't have to be a DLL you give the I gave it a specific uh p check that I care about",
    "start": "2553720",
    "end": "2561200"
  },
  {
    "text": "uh this RVA here is for win main and I",
    "start": "2561200",
    "end": "2567520"
  },
  {
    "text": "overwrite the first bytes with a jump then this is at the end of the image size that's just my show code um",
    "start": "2567520",
    "end": "2575839"
  },
  {
    "text": "included in GitHub is the configuration files for 17 32-bit 64-bit and 18 32-bit",
    "start": "2575839",
    "end": "2584560"
  },
  {
    "text": "so if you took this created used um the tool with the dash",
    "start": "2584560",
    "end": "2590440"
  },
  {
    "text": "c and then get the output from the IDA python",
    "start": "2590440",
    "end": "2596640"
  },
  {
    "text": "script loaded explorer into IDA this is what basically what you'll see so before",
    "start": "2596640",
    "end": "2602480"
  },
  {
    "text": "fix it after the fix it just has that jump instruction that's all I'm doing if",
    "start": "2602480",
    "end": "2608000"
  },
  {
    "text": "you follow that jump this is my shell code um I I don't",
    "start": "2608000",
    "end": "2613680"
  },
  {
    "text": "write shell code for a living so don't laugh at it uh basically I'm just I save all the registers i call create process",
    "start": "2613680",
    "end": "2621280"
  },
  {
    "text": "restore the registers and jump back to jump back to main so what can we do about this uh you",
    "start": "2621280",
    "end": "2629119"
  },
  {
    "text": "can disable the shim engine uh you can do it through group policy i don't recommend doing this uh it will break",
    "start": "2629119",
    "end": "2637079"
  },
  {
    "text": "emit it will basically make these zero-day fixes that Microsoft releases",
    "start": "2637079",
    "end": "2643880"
  },
  {
    "text": "pointless um but it is possible um there's probably some other unintended",
    "start": "2643880",
    "end": "2649520"
  },
  {
    "text": "uh consequences of disabling it",
    "start": "2649520",
    "end": "2654599"
  },
  {
    "text": "um you should search your search your registry",
    "start": "2654599",
    "end": "2660560"
  },
  {
    "text": "um and file system for SB files these are YAR provided",
    "start": "2660560",
    "end": "2666280"
  },
  {
    "text": "um your system is going to have FTB files they're normal um they're not all",
    "start": "2666280",
    "end": "2672119"
  },
  {
    "text": "bad there's lots of lots of good good ones out there but you can use the knowledge you gain today um how to use",
    "start": "2672119",
    "end": "2678640"
  },
  {
    "text": "some of these tools to be able to figure out what are these files actually doing on your system and then you can focus on",
    "start": "2678640",
    "end": "2685680"
  },
  {
    "text": "okay I know all these are normal this one doesn't look normal what does this actually do",
    "start": "2685680",
    "end": "2691119"
  },
  {
    "text": "um auto runs from CIS internals does not consider application compatibility fixes",
    "start": "2691119",
    "end": "2696319"
  },
  {
    "text": "as um as a persistence mechanism so whether",
    "start": "2696319",
    "end": "2702079"
  },
  {
    "text": "they're something like I created here this inmemory patch fix it um or some of",
    "start": "2702079",
    "end": "2707839"
  },
  {
    "text": "the things that Mark Badger talked about uh CIS internals does not uh consider it",
    "start": "2707839",
    "end": "2713920"
  },
  {
    "text": "um I told Microsoft that they should add signature support to STB files",
    "start": "2713920",
    "end": "2718960"
  },
  {
    "text": "um you know my copy of Explorer is signed but yet it lets me have my",
    "start": "2718960",
    "end": "2724880"
  },
  {
    "text": "unsigned code patch it in memory and do weird things so maybe they should let us",
    "start": "2724880",
    "end": "2731119"
  },
  {
    "text": "know that some non-signed STP file is running or about to",
    "start": "2731119",
    "end": "2737440"
  },
  {
    "text": "run um and this is a feature this is not",
    "start": "2737560",
    "end": "2742960"
  },
  {
    "text": "something that's making you more vulnerable having this default on your system",
    "start": "2742960",
    "end": "2749240"
  },
  {
    "text": "um someone needs to be administrator on your box to install these so if they're",
    "start": "2749240",
    "end": "2755280"
  },
  {
    "text": "that far you're you're already owned but this is kind of just a new way that you might not be considering how they're",
    "start": "2755280",
    "end": "2761200"
  },
  {
    "text": "maintaining persistence on your system um and this third bullet is really what",
    "start": "2761200",
    "end": "2770079"
  },
  {
    "text": "is I think is awesome it this provides a great opportunity to figure out what",
    "start": "2770079",
    "end": "2775359"
  },
  {
    "text": "Microsoft is doing fixing things um it's so much easier to look at two changes",
    "start": "2775359",
    "end": "2781359"
  },
  {
    "text": "versus hundreds of changes to try to figure out what Microsoft did to try to prevent exploitation and um I don't know",
    "start": "2781359",
    "end": "2788880"
  },
  {
    "text": "if I mentioned this earlier uh Exodus Intel guys looked at some uh fixit i",
    "start": "2788880",
    "end": "2795040"
  },
  {
    "text": "can't remember which one it was off the top of my head but they showed within you know probably a day or couple hours",
    "start": "2795040",
    "end": "2801040"
  },
  {
    "text": "probably that the fix it that Microsoft provided for something was totally insufficient that they could find a way",
    "start": "2801040",
    "end": "2807440"
  },
  {
    "text": "around that to continue to get code exact um and",
    "start": "2807440",
    "end": "2813839"
  },
  {
    "text": "um so now you guys should know about these tools which will help you um do your",
    "start": "2813839",
    "end": "2820960"
  },
  {
    "text": "analysis so here's some references if you guys are really interested in this you should read the the paper that's on",
    "start": "2821480",
    "end": "2827920"
  },
  {
    "text": "the conference CD um lots of good information there",
    "start": "2827920",
    "end": "2834520"
  },
  {
    "text": "um thanks to my wife and friends um my",
    "start": "2834520",
    "end": "2840319"
  },
  {
    "text": "wife and I just had a baby last week uh one week old and I had to leave which kind of sucked uh so thank her uh thanks",
    "start": "2840319",
    "end": "2847359"
  },
  {
    "text": "to Microsoft Eyesight and Black Hat and um this is how you can reach me my email",
    "start": "2847359",
    "end": "2855520"
  },
  {
    "text": "Twitter uh and this source code link this is not on the conference CD so you",
    "start": "2855520",
    "end": "2860880"
  },
  {
    "text": "can take a picture or uh send me an email and I'll send it to you later and I don't know if we've got time for",
    "start": "2860880",
    "end": "2866640"
  },
  {
    "text": "questions or not anyone have questions",
    "start": "2866640",
    "end": "2872680"
  },
  {
    "text": "process explorer after",
    "start": "2879200",
    "end": "2883640"
  },
  {
    "text": "uh the question was does the inmemory patch uh invalid the",
    "start": "2884880",
    "end": "2889960"
  },
  {
    "text": "signature uh as shown by process explorer and I don't know the answer to that question i would guess no",
    "start": "2889960",
    "end": "2899119"
  },
  {
    "text": "anyone else go ahead",
    "start": "2899119",
    "end": "2904480"
  },
  {
    "text": "uh do you have any plans to make",
    "start": "2904480",
    "end": "2910720"
  },
  {
    "text": "one with I think it's more",
    "start": "2912119",
    "end": "2918680"
  },
  {
    "text": "right uh so my my the question was do I plan on continuing to work on the IDA",
    "start": "2924400",
    "end": "2930559"
  },
  {
    "text": "Pro plugin and probably not and I don't think these",
    "start": "2930559",
    "end": "2937359"
  },
  {
    "text": "happen often enough where it's worth my time to try to develop one i thought it",
    "start": "2937359",
    "end": "2943680"
  },
  {
    "text": "was a very painful process to do it was my first time ever trying and um I've",
    "start": "2943680",
    "end": "2949760"
  },
  {
    "text": "got better things to do uh anyone",
    "start": "2949760",
    "end": "2956319"
  },
  {
    "text": "else all right well thank you if you've got anything else you can come up and see me after [Applause]",
    "start": "2958440",
    "end": "2967050"
  }
]