[
  {
    "text": "[Music]",
    "start": "1740",
    "end": "4810"
  },
  {
    "text": "hello everyone uh here in the room and uh virtually at uh",
    "start": "8320",
    "end": "13519"
  },
  {
    "text": "your home my name is uh trevor fiesel and i will talk about mac os vulnerabilities hiding in plain",
    "start": "13519",
    "end": "20480"
  },
  {
    "text": "sight a couple of words about myself um i'm currently working for offensive",
    "start": "20480",
    "end": "26640"
  },
  {
    "text": "security as a content developer and i'm the lead content developer there for the",
    "start": "26640",
    "end": "32398"
  },
  {
    "text": "for our mac os control bypasses training i used to do mac os bug hunting",
    "start": "32399",
    "end": "38239"
  },
  {
    "text": "in my free time as a hobby uh before that i was a blue and red teamer for about eight years",
    "start": "38239",
    "end": "45280"
  },
  {
    "text": "i'm married have two kids and i really like to do tray running hiking",
    "start": "45280",
    "end": "50879"
  },
  {
    "text": "in my free time so what i will talk about today",
    "start": "50879",
    "end": "56079"
  },
  {
    "text": "i will start with a short introduction about uh the whole concept uh behind this talk and then covering uh three",
    "start": "56079",
    "end": "63760"
  },
  {
    "text": "different vulnerabilities uh i found the first is a privilege escalation on macquarie",
    "start": "63760",
    "end": "70400"
  },
  {
    "text": "using the system preferences daemon the second one is a tcc privacy bypass",
    "start": "70400",
    "end": "76720"
  },
  {
    "text": "and the last one is a sandbox escape and for each of the cv or for each of",
    "start": "76720",
    "end": "82159"
  },
  {
    "text": "the vulnerabilities i will cover some technical background of the given process or or framework",
    "start": "82159",
    "end": "89119"
  },
  {
    "text": "uh then i will talk about the original vulnerability and the exploit that led me to find the new one and then",
    "start": "89119",
    "end": "95280"
  },
  {
    "text": "obviously also about the new one uh so the whole concept behind this talk is",
    "start": "95280",
    "end": "101680"
  },
  {
    "text": "we often uh say that someone can see the forest for the trees",
    "start": "101680",
    "end": "107520"
  },
  {
    "text": "and that's often because we are so focused on something uh that we don't",
    "start": "107520",
    "end": "113040"
  },
  {
    "text": "notice something behind or we or we just missed something and personally i think that's that's a",
    "start": "113040",
    "end": "119119"
  },
  {
    "text": "human nature so this is just how we work and",
    "start": "119119",
    "end": "124240"
  },
  {
    "text": "also i think nowadays there are so many articles like even technical articles",
    "start": "124240",
    "end": "131840"
  },
  {
    "text": "information that we want to consume that we simply have no time to actually",
    "start": "131840",
    "end": "137200"
  },
  {
    "text": "deep dive or many times read in-depth uh many of those articles",
    "start": "137200",
    "end": "144959"
  },
  {
    "text": "so but sometimes uh i happen to read some articles again and",
    "start": "145200",
    "end": "150319"
  },
  {
    "text": "again uh maybe because it was so interesting maybe because i forgot what was inside or i need to look up",
    "start": "150319",
    "end": "157680"
  },
  {
    "text": "some information uh again and again uh obviously we cannot remember everything",
    "start": "157680",
    "end": "164480"
  },
  {
    "text": "so this is how it happened that there were a couple of vulnerabilities that i always return to",
    "start": "164480",
    "end": "170879"
  },
  {
    "text": "and read them again again and again for some reason and eventually i found",
    "start": "170879",
    "end": "175920"
  },
  {
    "text": "some new vulnerabilities and actually he'd done inside the article except one which is a",
    "start": "175920",
    "end": "182560"
  },
  {
    "text": "little outlier but that's the the whole idea uh so let's start with the first one",
    "start": "182560",
    "end": "189040"
  },
  {
    "text": "uh which is cv 2021 1815 which is a mac os local privilege escalation in",
    "start": "189040",
    "end": "194959"
  },
  {
    "text": "preferences so what is cf preps d this is i think it",
    "start": "194959",
    "end": "201200"
  },
  {
    "text": "stands for the core foundation preferences daemon cf is core foundation uh that is where",
    "start": "201200",
    "end": "207280"
  },
  {
    "text": "the preferences api lives and basically this process is",
    "start": "207280",
    "end": "212879"
  },
  {
    "text": "responsible for setting uh application preferences on the system there are two",
    "start": "212879",
    "end": "218480"
  },
  {
    "text": "of them one is running as a user and one is running as root uh for system-wide",
    "start": "218480",
    "end": "224840"
  },
  {
    "text": "preferences and basically you can interact with this daemon through the preferences api",
    "start": "224840",
    "end": "230080"
  },
  {
    "text": "uh so the whole settings is hidden but behind the scenes the preferences",
    "start": "230080",
    "end": "236480"
  },
  {
    "text": "api uses direct xpc cores to talk with cf perhaps the xpc is an",
    "start": "236480",
    "end": "242159"
  },
  {
    "text": "inter-process communication unique to mac os or ios basically all the upper operating",
    "start": "242159",
    "end": "248640"
  },
  {
    "text": "systems so the original vulnerability was part of the",
    "start": "248640",
    "end": "255120"
  },
  {
    "text": "pawn to own 2020 mac os extroy chain",
    "start": "255120",
    "end": "261040"
  },
  {
    "text": "where the team there basically exploited mac os from safari to canada through a six step extra chain",
    "start": "261040",
    "end": "267680"
  },
  {
    "text": "i think that was a really neat uh chain with lots of great ideas and",
    "start": "267680",
    "end": "273680"
  },
  {
    "text": "one of the step was to get root privileges privileges from admin",
    "start": "273680",
    "end": "280080"
  },
  {
    "text": "and this is the original vulnerable code what we see uh on the screen",
    "start": "280080",
    "end": "285680"
  },
  {
    "text": "uh basically what happened there um the preferences daemon allowed someone to",
    "start": "285680",
    "end": "291680"
  },
  {
    "text": "uh change the ownership of an arbitrary directory to the user",
    "start": "291680",
    "end": "299199"
  },
  {
    "text": "so what they did uh in the original exploit uh they it was a raised condition",
    "start": "300000",
    "end": "306160"
  },
  {
    "text": "exploit so they raised it with a sim link and they eventually changed the ownership of the etc spam.the",
    "start": "306160",
    "end": "314080"
  },
  {
    "text": "directory the pmd directory is the plugable authentication modules",
    "start": "314080",
    "end": "320240"
  },
  {
    "text": "directory where all the pam configuration leaves and after the permission was changed",
    "start": "320240",
    "end": "327919"
  },
  {
    "text": "they basically changed the pseudoconfig file so they could get",
    "start": "327919",
    "end": "333120"
  },
  {
    "text": "root without the password and after fixed this and the team the",
    "start": "333120",
    "end": "339360"
  },
  {
    "text": "0.1 team reversed the fix and it was presented in at blackhead i think 2019",
    "start": "339360",
    "end": "346479"
  },
  {
    "text": "uh and this is the reverse fix code and this is good so it basically ensures",
    "start": "346479",
    "end": "352479"
  },
  {
    "text": "that siblings are not allowed anymore or at least they are not followed",
    "start": "352479",
    "end": "357600"
  },
  {
    "text": "thus exploitation wasn't possible anymore so it will all look nice",
    "start": "357600",
    "end": "364160"
  },
  {
    "text": "and clean however at one point it hit me that it's still not right",
    "start": "364160",
    "end": "369360"
  },
  {
    "text": "because in this code we still have uh the mkdirat function which is",
    "start": "369360",
    "end": "376319"
  },
  {
    "text": "basically creating a directory uh on the system and that is run unconditionally",
    "start": "376319",
    "end": "383199"
  },
  {
    "text": "uh okay so that means that we can create a directory somewhere and basically after that the",
    "start": "383199",
    "end": "390880"
  },
  {
    "text": "next checks will be passed again for any regular call and then the ownership of the newly",
    "start": "390880",
    "end": "397280"
  },
  {
    "text": "created directory will be set to the user so what that mean is we could create a new directory",
    "start": "397280",
    "end": "404960"
  },
  {
    "text": "somewhere on the system um with root privileges so it can be set",
    "start": "404960",
    "end": "411280"
  },
  {
    "text": "anywhere and then change to the user so this is a privilege escalation scenario",
    "start": "411280",
    "end": "418400"
  },
  {
    "text": "but it wasn't of use to actually exploit it because we can only create a directory",
    "start": "418400",
    "end": "424639"
  },
  {
    "text": "somewhere so how we can turn it to code execution",
    "start": "424639",
    "end": "429759"
  },
  {
    "text": "on mac os we have periodic scripts which are originated from bsd these are",
    "start": "429759",
    "end": "435599"
  },
  {
    "text": "maintenance scripts run on a daily weekly monthly basis they clean like the temp folder or other files and",
    "start": "435599",
    "end": "443199"
  },
  {
    "text": "do some maintenance stuff and these scripts has a configuration file",
    "start": "443199",
    "end": "449919"
  },
  {
    "text": "and this configuration file store defines a local periodic script location",
    "start": "449919",
    "end": "458000"
  },
  {
    "text": "where the user can drop their own scripts that he would like to run",
    "start": "458000",
    "end": "463520"
  },
  {
    "text": "now this location this usr local slash edc slash periodic doesn't exist by",
    "start": "463520",
    "end": "469599"
  },
  {
    "text": "default so what we can do is use this vulnerability create this directory",
    "start": "469599",
    "end": "475680"
  },
  {
    "text": "as the user again and drop our script there and since these periodic scripts are",
    "start": "475680",
    "end": "480960"
  },
  {
    "text": "executed as root and what we drop there it will be executed as root",
    "start": "480960",
    "end": "487280"
  },
  {
    "text": "the only problem with this method that it's a bit slow because those scripts are invoked",
    "start": "487759",
    "end": "493520"
  },
  {
    "text": "daily only so that's the shortest time frame we can go it can take up to a day to get root",
    "start": "493520",
    "end": "499360"
  },
  {
    "text": "but if you are on a slow engagement that's probably not a big issue also this will not work beyond the bixer",
    "start": "499360",
    "end": "506160"
  },
  {
    "text": "11.5 because epper made another patch that time",
    "start": "506160",
    "end": "511680"
  },
  {
    "text": "uh now the periodic scripts if the periodic script is owned by the user",
    "start": "511680",
    "end": "517839"
  },
  {
    "text": "it will not be executed as root but as the user so this",
    "start": "517839",
    "end": "522880"
  },
  {
    "text": "exploitation method no longer works on like monterey so here is a show",
    "start": "522880",
    "end": "529600"
  },
  {
    "text": "video of this so we can see that the usr local directory is empty",
    "start": "529600",
    "end": "537519"
  },
  {
    "text": "we run our exploit",
    "start": "537760",
    "end": "540959"
  },
  {
    "text": "and now we can see that the directory is created and we will have",
    "start": "543040",
    "end": "548560"
  },
  {
    "text": "our script there",
    "start": "548560",
    "end": "551360"
  },
  {
    "text": "and now i basically simulate the execution of the daily periodic scripts",
    "start": "557040",
    "end": "563200"
  },
  {
    "text": "and basically we will see terminal popping up as root uh we could wait for the periodic",
    "start": "563200",
    "end": "570080"
  },
  {
    "text": "scripts but then it would be a really long video so yeah we got",
    "start": "570080",
    "end": "577360"
  },
  {
    "text": "a root so i kind of think about how we could exploit",
    "start": "577360",
    "end": "584160"
  },
  {
    "text": "it um through another way and i came up with another again unperfect",
    "start": "584160",
    "end": "591200"
  },
  {
    "text": "way uh but this could be this could be another method to exploit this vulnerability",
    "start": "591200",
    "end": "596880"
  },
  {
    "text": "so on mac os there is this cease diagnosis utility which typically runs as root",
    "start": "596880",
    "end": "603370"
  },
  {
    "text": "[Music] and it tries to execute many binaries from the usr local bin",
    "start": "603370",
    "end": "610000"
  },
  {
    "text": "directory which again doesn't exist by default",
    "start": "610000",
    "end": "614639"
  },
  {
    "text": "so some of these have been remediated now but still there might be some",
    "start": "615839",
    "end": "621680"
  },
  {
    "text": "out there that we can invoke so basically what we can do in our exploit create this usr local bin directory",
    "start": "621680",
    "end": "628560"
  },
  {
    "text": "drop one of the binaries there and hopefully it will it will be invoked",
    "start": "628560",
    "end": "634560"
  },
  {
    "text": "uh although this diagnosis contains all these references it doesn't",
    "start": "634560",
    "end": "639600"
  },
  {
    "text": "always call each of these but again it's not perfect because it depends on the user",
    "start": "639600",
    "end": "646959"
  },
  {
    "text": "triggering the sysdiagnos utility so it can be either done manually so the user is typing in",
    "start": "646959",
    "end": "653680"
  },
  {
    "text": "this diagnose and enters his password to run as root uh the other way is to",
    "start": "653680",
    "end": "658720"
  },
  {
    "text": "launch feedback assistant and create a new case",
    "start": "658720",
    "end": "664000"
  },
  {
    "text": "and then feedback assistance will automatically invoke this diagnose to attach the result to the new",
    "start": "664079",
    "end": "671360"
  },
  {
    "text": "feedback ticket now i actually looked into this how feedback assistance which runs as the",
    "start": "671360",
    "end": "676880"
  },
  {
    "text": "user can invoke this diagnosis which runs as root and it turned out that feedback",
    "start": "676880",
    "end": "682240"
  },
  {
    "text": "assistant had some private entitlement that allowed it to basically invoke this",
    "start": "682240",
    "end": "687680"
  },
  {
    "text": "diagnosis and run it as roots so unfortunately we cannot achieve the same",
    "start": "687680",
    "end": "695760"
  },
  {
    "text": "if we are not feedback assistant the third way to invoke this diagnosis",
    "start": "695760",
    "end": "700959"
  },
  {
    "text": "is to use this keyboard shortcut which is command option shift control period at one time",
    "start": "700959",
    "end": "707600"
  },
  {
    "text": "and then this diagnosis will start but again if we are a more aware or pentester we cannot",
    "start": "707600",
    "end": "714839"
  },
  {
    "text": "simulate uh keyboard uh shortcuts or",
    "start": "714839",
    "end": "720399"
  },
  {
    "text": "or keyboard entries so that was the first one the next one",
    "start": "720399",
    "end": "727040"
  },
  {
    "text": "is a tcc bypass this was a shared finding with voice regular",
    "start": "727040",
    "end": "735279"
  },
  {
    "text": "with a guy from poland i often work with so what is tcc tcc is",
    "start": "735279",
    "end": "742000"
  },
  {
    "text": "the security feature on mac os which is responsible for um protecting all of the privacy related",
    "start": "742000",
    "end": "749600"
  },
  {
    "text": "resources uh on the computer so like microphone camera your photos",
    "start": "749600",
    "end": "755440"
  },
  {
    "text": "your contacts your documents the list is quite long it's basically",
    "start": "755440",
    "end": "761279"
  },
  {
    "text": "whatever apple considered private uh it will be protected",
    "start": "761279",
    "end": "766639"
  },
  {
    "text": "uh it mainly works by two sqlite databases one is located in the system",
    "start": "766639",
    "end": "772560"
  },
  {
    "text": "library application support com app.ecc slash dccdb",
    "start": "772560",
    "end": "778160"
  },
  {
    "text": "and the other one it's the same location but in the in the user home folder",
    "start": "778160",
    "end": "784240"
  },
  {
    "text": "so some of the settings like microphone and camera is set on the user home folder",
    "start": "784240",
    "end": "789600"
  },
  {
    "text": "some of the settings like full disk access is controlled through the system-wide uh database",
    "start": "789600",
    "end": "796800"
  },
  {
    "text": "so that's just a really short intro to tcc if you want to know more about it i defer to",
    "start": "796800",
    "end": "802639"
  },
  {
    "text": "our talk with voice from last year blackhead about the 20 plus ways to bypass your",
    "start": "802639",
    "end": "809120"
  },
  {
    "text": "macos privacy mechanism so what happened here uh",
    "start": "809120",
    "end": "814399"
  },
  {
    "text": "last year uh the xc set as set marvel",
    "start": "814399",
    "end": "820720"
  },
  {
    "text": "uh used the tcco day which is i think highly unusual for a",
    "start": "820720",
    "end": "825760"
  },
  {
    "text": "macos malware to to use any audi but they did one",
    "start": "825760",
    "end": "830880"
  },
  {
    "text": "and basically what happened there is that the mother enumerated the applications on the system and let's say",
    "start": "830880",
    "end": "837199"
  },
  {
    "text": "they found zoom now zoom is a video conferencing application and it very",
    "start": "837199",
    "end": "842480"
  },
  {
    "text": "likely has microphone and camera access granted by the user otherwise it couldn't work and then there is no point",
    "start": "842480",
    "end": "849839"
  },
  {
    "text": "to have zoom on your system so it likely has those permissions and then the marvel created a new",
    "start": "849839",
    "end": "856800"
  },
  {
    "text": "application bundle uh which was an apple script based application",
    "start": "856800",
    "end": "862880"
  },
  {
    "text": "and copied that application inside the zoom application bundle",
    "start": "862880",
    "end": "868720"
  },
  {
    "text": "mac os folder in the mac os folder usually you have the main executable of the application",
    "start": "868720",
    "end": "876399"
  },
  {
    "text": "so they simply copied the new application bundle into this location and started it",
    "start": "876399",
    "end": "882880"
  },
  {
    "text": "and what happened that time mac os was confused and they told that it's",
    "start": "882880",
    "end": "888480"
  },
  {
    "text": "actually zoom that is running and not this everything",
    "start": "888480",
    "end": "893519"
  },
  {
    "text": "application and it basically inherited zoom's",
    "start": "893519",
    "end": "898959"
  },
  {
    "text": "privacy permissions so it could access camera and microphone",
    "start": "898959",
    "end": "904959"
  },
  {
    "text": "so basically macos wrongly identified the bundle which would be already a hint here",
    "start": "904959",
    "end": "911440"
  },
  {
    "text": "but this was fixed and then later on uh again last year",
    "start": "911440",
    "end": "916959"
  },
  {
    "text": "mick gene from trend micro played more with this vulnerability",
    "start": "916959",
    "end": "922880"
  },
  {
    "text": "and found the bypass the tcc database contains the bundle id",
    "start": "922880",
    "end": "928800"
  },
  {
    "text": "and basically just by creating a new application with the same bundle",
    "start": "928800",
    "end": "934399"
  },
  {
    "text": "id as our target so let's keep zoom as our target",
    "start": "934399",
    "end": "939760"
  },
  {
    "text": "so he created a fake application put the same bundle id as zoom and when he executed the fake",
    "start": "939760",
    "end": "946639"
  },
  {
    "text": "application the system was confused again to think that it's zoom that is running",
    "start": "946639",
    "end": "954079"
  },
  {
    "text": "and it inherited zoom privacy permission and again the issue was that um",
    "start": "954079",
    "end": "961040"
  },
  {
    "text": "all the code signing verification and everything was done on the main zoom us",
    "start": "961040",
    "end": "966839"
  },
  {
    "text": "uh that app application and not on the fake application",
    "start": "966839",
    "end": "973279"
  },
  {
    "text": "uh which is a problem and this was the point where it hit me that",
    "start": "973279",
    "end": "978560"
  },
  {
    "text": "there is a fundamental issue here with tcc which enabled both",
    "start": "978560",
    "end": "984560"
  },
  {
    "text": "vulnerabilities and it's the fact",
    "start": "984560",
    "end": "989680"
  },
  {
    "text": "that macos didn't verify the code signing properties of the",
    "start": "989680",
    "end": "996560"
  },
  {
    "text": "running process but it verified something on the disk",
    "start": "996560",
    "end": "1001920"
  },
  {
    "text": "now the tcc database does contain the code signing requirements",
    "start": "1001920",
    "end": "1007759"
  },
  {
    "text": "for the application so it's it properly intensifies the application now obviously when we start",
    "start": "1007759",
    "end": "1014639"
  },
  {
    "text": "our fake application it will not have the same signature as zoom",
    "start": "1014639",
    "end": "1020000"
  },
  {
    "text": "in this case so if they were verifying the process it could have been identified that hey it's",
    "start": "1020000",
    "end": "1026160"
  },
  {
    "text": "not zoom but it's running but something else and",
    "start": "1026160",
    "end": "1031360"
  },
  {
    "text": "this was really shocking a bit um because on mac os you never verify",
    "start": "1031360",
    "end": "1038400"
  },
  {
    "text": "code signature on disk if you have a process running because what you can do on mac os once",
    "start": "1038400",
    "end": "1044640"
  },
  {
    "text": "the process is started and running you can basically delete that application or delete that binary and it will keep",
    "start": "1044640",
    "end": "1051039"
  },
  {
    "text": "running until it's shut down unlike on windows where you cannot",
    "start": "1051039",
    "end": "1056480"
  },
  {
    "text": "modify or delete the binary of the application",
    "start": "1056480",
    "end": "1061679"
  },
  {
    "text": "so usually every time on mac os because of this",
    "start": "1061679",
    "end": "1068559"
  },
  {
    "text": "the code signature is verified in memory well except gatekeeper when the process is not even running of course then we",
    "start": "1068559",
    "end": "1074240"
  },
  {
    "text": "have no choice also the same issue with xpc and mac message or mac connection",
    "start": "1074240",
    "end": "1082160"
  },
  {
    "text": "verification when we try to verify the connecting client we should always use",
    "start": "1082160",
    "end": "1089360"
  },
  {
    "text": "the verify the connecting process signature based on its audit token so",
    "start": "1089360",
    "end": "1095679"
  },
  {
    "text": "even like the process id is not not considered secure uh or mac os for",
    "start": "1095679",
    "end": "1100799"
  },
  {
    "text": "this and like on disk on on xpc or mac verification it doesn't really come up",
    "start": "1100799",
    "end": "1106480"
  },
  {
    "text": "uh at all as a verification step although i saw",
    "start": "1106480",
    "end": "1112160"
  },
  {
    "text": "vendors being very creative and doing this like adobe",
    "start": "1112160",
    "end": "1118880"
  },
  {
    "text": "it's fixed now but yeah so you should use audi token",
    "start": "1118880",
    "end": "1124160"
  },
  {
    "text": "and based on the auditor can verify the process also mp checks in memory integrity checks again",
    "start": "1124160",
    "end": "1131280"
  },
  {
    "text": "in memory and not not on the disk so what we could do is really simply make a",
    "start": "1131280",
    "end": "1137600"
  },
  {
    "text": "fake application with the same bundle id as our target so let's stay with zoom i",
    "start": "1137600",
    "end": "1142720"
  },
  {
    "text": "have no issues with zoom it's a great app we just use it as an example",
    "start": "1142720",
    "end": "1147840"
  },
  {
    "text": "we start our application then we take zoom and copy over our fake",
    "start": "1147840",
    "end": "1153679"
  },
  {
    "text": "application then we initiate some actions that require",
    "start": "1153679",
    "end": "1159280"
  },
  {
    "text": "privacy permissions like recording camera microphone or accessing various locations",
    "start": "1159280",
    "end": "1165600"
  },
  {
    "text": "and and it will be permitted and we bypass dcc because the bundle on the disk is verified",
    "start": "1165600",
    "end": "1173600"
  },
  {
    "text": "uh or voice check made an alteration to this so we make a fake app and",
    "start": "1173600",
    "end": "1179679"
  },
  {
    "text": "uh embed it in our donor app with the same team id start the app again copy",
    "start": "1179679",
    "end": "1184880"
  },
  {
    "text": "over the donor app over the uh the fake application",
    "start": "1184880",
    "end": "1190720"
  },
  {
    "text": "and initiate the action and again we bypass dcc so here's a",
    "start": "1190720",
    "end": "1195840"
  },
  {
    "text": "demo of this so we can see that we have zoom on the system",
    "start": "1195840",
    "end": "1202240"
  },
  {
    "text": "zoom has audio input which is microphone and comma access i'm",
    "start": "1202240",
    "end": "1208559"
  },
  {
    "text": "opening system preferences and showing that",
    "start": "1208559",
    "end": "1213039"
  },
  {
    "text": "indeed zoom is granted these permissions by the user and nothing else basically",
    "start": "1214000",
    "end": "1222000"
  },
  {
    "text": "and then i have the other fake zoom application which has no writes at all",
    "start": "1222000",
    "end": "1230158"
  },
  {
    "text": "now i start the fake zoom application",
    "start": "1230799",
    "end": "1236159"
  },
  {
    "text": "and we can see that the size of the application is growing and this is because at this stage i'm copying over",
    "start": "1236159",
    "end": "1243039"
  },
  {
    "text": "the original zoom application over the fake one and then we can see a",
    "start": "1243039",
    "end": "1249440"
  },
  {
    "text": "new move mod file uh is showing up this is like a 10 second recording with",
    "start": "1249440",
    "end": "1257280"
  },
  {
    "text": "my camera and it's done and yeah i recorded myself",
    "start": "1257280",
    "end": "1263840"
  },
  {
    "text": "so this has been fixed now luckily so based on the",
    "start": "1264159",
    "end": "1271200"
  },
  {
    "text": "tcc daemon locks we can actually confirm that finally",
    "start": "1271360",
    "end": "1277120"
  },
  {
    "text": "macos the tcc process on mac os uses the dynamic code signature of the process to",
    "start": "1277120",
    "end": "1283280"
  },
  {
    "text": "verify uh code signature so if it's done",
    "start": "1283280",
    "end": "1290960"
  },
  {
    "text": "and the last one is a sandbox escape using the disk arbitration service uh it's been fixed",
    "start": "1290960",
    "end": "1298559"
  },
  {
    "text": "so no all days but there was no cv assigned yet",
    "start": "1298559",
    "end": "1303760"
  },
  {
    "text": "so that's why all the x is so what is this arbitration uh it's",
    "start": "1303760",
    "end": "1309840"
  },
  {
    "text": "basically a service for managing disk mounting and mounting",
    "start": "1309840",
    "end": "1316400"
  },
  {
    "text": "it can also notify us if um there is new mounting happening and we",
    "start": "1316400",
    "end": "1322720"
  },
  {
    "text": "can even set uh handlers on our own programs that we maybe permit",
    "start": "1322720",
    "end": "1327760"
  },
  {
    "text": "or deny uh specific mount operations so that's",
    "start": "1327760",
    "end": "1332880"
  },
  {
    "text": "that's what it does it has an xpc service",
    "start": "1332880",
    "end": "1339120"
  },
  {
    "text": "and but under the hood it will call the the mount and unmount",
    "start": "1339120",
    "end": "1344799"
  },
  {
    "text": "regular system calls so why this arbitration is uh the demon",
    "start": "1344799",
    "end": "1352480"
  },
  {
    "text": "why we like it why is it good for us as pen testers or security researcher bug hunters so first",
    "start": "1352480",
    "end": "1359760"
  },
  {
    "text": "it runs as root which is nice it's runs on sandbox which is also nice",
    "start": "1359760",
    "end": "1366000"
  },
  {
    "text": "it has an xbc service which is accessible from the application sandbox",
    "start": "1366000",
    "end": "1372480"
  },
  {
    "text": "this is part of the application sandbox profile and we can see that the disk arbitration",
    "start": "1372480",
    "end": "1378640"
  },
  {
    "text": "service is permitted at the bottom so basically",
    "start": "1378640",
    "end": "1383919"
  },
  {
    "text": "any regular sandbox application can access this service and it's also open source so it's like",
    "start": "1383919",
    "end": "1390880"
  },
  {
    "text": "the dream combination uh at this stage",
    "start": "1390880",
    "end": "1395919"
  },
  {
    "text": "uh so again first the original exploit from 2017",
    "start": "1395919",
    "end": "1402080"
  },
  {
    "text": "uh it was also done in one of the pawn to one contest",
    "start": "1402080",
    "end": "1407120"
  },
  {
    "text": "uh by the fern hex team it was again part of an exploit chain and this was also a privilege escalation",
    "start": "1407120",
    "end": "1415200"
  },
  {
    "text": "so what this arbitration does to prevent abuse uh because it transits",
    "start": "1415200",
    "end": "1421120"
  },
  {
    "text": "route if someone calls this service it will check if the calling process has permissions to mount over a specific",
    "start": "1421120",
    "end": "1428960"
  },
  {
    "text": "directory or not obviously if this check wasn't there",
    "start": "1428960",
    "end": "1434320"
  },
  {
    "text": "then someone could mount anywhere and escalate privileges trivially",
    "start": "1434320",
    "end": "1440159"
  },
  {
    "text": "so what it did it took the pass given to the mount",
    "start": "1440159",
    "end": "1446000"
  },
  {
    "text": "location resolved it checked that can the calling process mount there",
    "start": "1446000",
    "end": "1451919"
  },
  {
    "text": "or not and if yes then it kind of proceeded did something and then it resolved the pass",
    "start": "1451919",
    "end": "1458799"
  },
  {
    "text": "again which was a problem because there there was a time of check time of use",
    "start": "1458799",
    "end": "1465600"
  },
  {
    "text": "bug because of these two resolutions and basically once the check is done",
    "start": "1465600",
    "end": "1473200"
  },
  {
    "text": "we can do something with that pass using symlinks and point it to somewhere else and",
    "start": "1473200",
    "end": "1479440"
  },
  {
    "text": "basically mount somewhere else on the system",
    "start": "1479440",
    "end": "1485360"
  },
  {
    "text": "not on the location where the check was done so this can be this could be accelerated with a race",
    "start": "1485360",
    "end": "1491279"
  },
  {
    "text": "condition a little like a race and what the",
    "start": "1491279",
    "end": "1498240"
  },
  {
    "text": "uh team did at 2017 they mounted the efi partition which is admin writable",
    "start": "1498240",
    "end": "1505440"
  },
  {
    "text": "and they mounted it over the chrome tabs directory and created a new",
    "start": "1505440",
    "end": "1512240"
  },
  {
    "text": "cron job there and escalated admin to root uh on mac os",
    "start": "1512240",
    "end": "1518880"
  },
  {
    "text": "now the new one so this is a bit outlier from the previous two this",
    "start": "1518880",
    "end": "1524880"
  },
  {
    "text": "doesn't come directly from the article but when i opened the source code of disk",
    "start": "1524880",
    "end": "1530240"
  },
  {
    "text": "arbitration the new one i realized that the same verification step there is a new one",
    "start": "1530240",
    "end": "1538159"
  },
  {
    "text": "for sandbox checking because sandbox is rich this conversation is reachable from the sandbox",
    "start": "1538159",
    "end": "1544720"
  },
  {
    "text": "this arbitration has to also ensure that the sandbox application",
    "start": "1544720",
    "end": "1550799"
  },
  {
    "text": "has rights to mount on the target location so it runs a sandbox check by audit",
    "start": "1550799",
    "end": "1557520"
  },
  {
    "text": "token which is a system called to the sandbox driver",
    "start": "1557520",
    "end": "1562880"
  },
  {
    "text": "and it will check if mounting is permitted for that process or not",
    "start": "1562880",
    "end": "1568720"
  },
  {
    "text": "now let's see how the check was done uh",
    "start": "1568720",
    "end": "1574240"
  },
  {
    "text": "on the old vulnerability for the mount point location and the new vulnerability for the",
    "start": "1574240",
    "end": "1580559"
  },
  {
    "text": "sandbox so we had the past received the same way",
    "start": "1580559",
    "end": "1585600"
  },
  {
    "text": "then we have the same if statement and then the same pass",
    "start": "1585600",
    "end": "1591600"
  },
  {
    "text": "variable is used on the old version is it was used for the",
    "start": "1591600",
    "end": "1597760"
  },
  {
    "text": "user id permission check and now the same way it's being used for the sandbox check",
    "start": "1597760",
    "end": "1603200"
  },
  {
    "text": "so it looked like the same logic issue is there but now",
    "start": "1603200",
    "end": "1609360"
  },
  {
    "text": "not for previous escalation but for a sandbox potential sandbox escape",
    "start": "1609360",
    "end": "1615279"
  },
  {
    "text": "so what i did as it's again it's a race condition and [Music]",
    "start": "1615279",
    "end": "1620880"
  },
  {
    "text": "if i were directly going to exploit it and it's not successful i",
    "start": "1620880",
    "end": "1626400"
  },
  {
    "text": "wouldn't know if it's because my exploit is wrong for any reason or it's simply not exploitable",
    "start": "1626400",
    "end": "1632559"
  },
  {
    "text": "so i created a sandbox profile which simply denied mounting over the private temp disk",
    "start": "1632559",
    "end": "1638880"
  },
  {
    "text": "directory and launched a shell with this profile and",
    "start": "1638880",
    "end": "1644720"
  },
  {
    "text": "then try to do two mountings one for disk and then disk two and the profile is working properly so like",
    "start": "1644720",
    "end": "1652000"
  },
  {
    "text": "temp disk wasn't allowed while the other one was allowed so i launched a debugger and attached it",
    "start": "1652000",
    "end": "1658720"
  },
  {
    "text": "to this arbitration d for this we need to disable zip",
    "start": "1658720",
    "end": "1664720"
  },
  {
    "text": "on the system so we can debug this arbitration and set a breakpoint on the sandbox",
    "start": "1664720",
    "end": "1670559"
  },
  {
    "text": "check by audit token and then i run",
    "start": "1670559",
    "end": "1675600"
  },
  {
    "text": "the mounting again so i wanted now to mount over temp disk 2",
    "start": "1675600",
    "end": "1681279"
  },
  {
    "text": "again and then we hit the breakpoint i set finish",
    "start": "1681279",
    "end": "1686720"
  },
  {
    "text": "on the check and i'm not sure how well it's in but basically it returned 0 which means yes",
    "start": "1686720",
    "end": "1693919"
  },
  {
    "text": "you can go ahead it's permitted of course because i want to mount over them",
    "start": "1693919",
    "end": "1700159"
  },
  {
    "text": "disk 2. but what i did at this stage i'm still holding",
    "start": "1700159",
    "end": "1706880"
  },
  {
    "text": "the service i remove the disk 2 folder and created new sim link",
    "start": "1706880",
    "end": "1713279"
  },
  {
    "text": "as disk 2 pointing to slash temp slash disk which is the original location which",
    "start": "1713279",
    "end": "1720080"
  },
  {
    "text": "wasn't allowed by the sandbox profile i continued the process and what i could",
    "start": "1720080",
    "end": "1726559"
  },
  {
    "text": "mount over this location so that at least confirmed that yes the bug is there so i can it's exploitable",
    "start": "1726559",
    "end": "1734559"
  },
  {
    "text": "now i need to really exploit it and it turned out to be not",
    "start": "1734559",
    "end": "1739679"
  },
  {
    "text": "trivial because the first question was okay what",
    "start": "1739679",
    "end": "1746000"
  },
  {
    "text": "do i mount uh efi partition is really out of question first because uh this",
    "start": "1746000",
    "end": "1752880"
  },
  {
    "text": "arbitration now has a specific check for the efi partition uh that's what we see there",
    "start": "1752880",
    "end": "1760240"
  },
  {
    "text": "so that long grid is for the it's for the efi partition",
    "start": "1760240",
    "end": "1766960"
  },
  {
    "text": "and but even if i could mount it i mean i cannot reach that location from the",
    "start": "1766960",
    "end": "1772559"
  },
  {
    "text": "sandbox so okay let's mount a custom dmg file a dmg file is a like a disk image uh or",
    "start": "1772559",
    "end": "1779840"
  },
  {
    "text": "mac os okay so i can mount i plan to mount a disk image but",
    "start": "1779840",
    "end": "1785039"
  },
  {
    "text": "the problem is that this arbitration service doesn't work with disk images it works with slash dev uh",
    "start": "1785039",
    "end": "1792559"
  },
  {
    "text": "devices so how do i get a slash dev device from my dmg",
    "start": "1792559",
    "end": "1799279"
  },
  {
    "text": "and that is what disk management daemon for",
    "start": "1799279",
    "end": "1805039"
  },
  {
    "text": "this management daemon can turn a dng or map a dmg file into a dev device",
    "start": "1805039",
    "end": "1811760"
  },
  {
    "text": "but this management demon is not reachable from the sandbox and",
    "start": "1811760",
    "end": "1818720"
  },
  {
    "text": "it happened to me that okay i cannot reach disk management d but what i can do is i can call the open",
    "start": "1818960",
    "end": "1826399"
  },
  {
    "text": "system command on the dmg file and then the system will automatically",
    "start": "1826399",
    "end": "1832399"
  },
  {
    "text": "map the dmg file into a dev device and also mount it at the same time into the",
    "start": "1832399",
    "end": "1838240"
  },
  {
    "text": "slash volumes directory which is nice because now i have a slash",
    "start": "1838240",
    "end": "1843840"
  },
  {
    "text": "dev device but it's also mounted what i don't need at this point because i want this",
    "start": "1843840",
    "end": "1849840"
  },
  {
    "text": "manager daemon this management demon to mount it for me but",
    "start": "1849840",
    "end": "1855840"
  },
  {
    "text": "i can use the disk management daemon to unmount the slash volumes",
    "start": "1855840",
    "end": "1861600"
  },
  {
    "text": "whatever name location and the dev device remains in place",
    "start": "1861600",
    "end": "1867679"
  },
  {
    "text": "so that was nice because now i can mount something an arbitrary file",
    "start": "1867679",
    "end": "1876000"
  },
  {
    "text": "and sorry create a dev device so the last question was okay where do i mount to actually achieve",
    "start": "1876000",
    "end": "1883679"
  },
  {
    "text": "code execution outside of the sandbox and there might be multiple ways to do",
    "start": "1883679",
    "end": "1888960"
  },
  {
    "text": "it my idea was to mount over the home library preferences",
    "start": "1888960",
    "end": "1895200"
  },
  {
    "text": "directory where we have all the preferences file for",
    "start": "1895200",
    "end": "1901679"
  },
  {
    "text": "all the applications that runs as the user now the terminal",
    "start": "1901679",
    "end": "1907360"
  },
  {
    "text": "has also preferences file and it has a preference that the command string",
    "start": "1907360",
    "end": "1912960"
  },
  {
    "text": "and we can put there any bash or share command and it will be executed",
    "start": "1912960",
    "end": "1919120"
  },
  {
    "text": "when we launch terminal so let's put it all together",
    "start": "1919120",
    "end": "1926559"
  },
  {
    "text": "we have we have our sandbox application we drop a dmg file",
    "start": "1926720",
    "end": "1932480"
  },
  {
    "text": "we call open on the dmg file so it will be mounted and also the dev",
    "start": "1932480",
    "end": "1938000"
  },
  {
    "text": "device is created then we unmount",
    "start": "1938000",
    "end": "1942559"
  },
  {
    "text": "the the mount point but our dev device is still in place and then we will start our race so",
    "start": "1943120",
    "end": "1949600"
  },
  {
    "text": "basically we want to mount uh over the preferences directory",
    "start": "1949600",
    "end": "1955840"
  },
  {
    "text": "and once we want to mount over uh inside a container in a folder which",
    "start": "1955840",
    "end": "1961039"
  },
  {
    "text": "is permitted and we erase it with a sim link and",
    "start": "1961039",
    "end": "1966080"
  },
  {
    "text": "eventually it will succeed so eventually we will mount over the preferences directory and once we manage to do that",
    "start": "1966080",
    "end": "1974960"
  },
  {
    "text": "we stop arrays and then we open terminal we can do that from the sec sandbox so",
    "start": "1974960",
    "end": "1980720"
  },
  {
    "text": "from the sandbox we can call the open command and launch an application and once we started terminal um",
    "start": "1980720",
    "end": "1990159"
  },
  {
    "text": "our code will be executed on sandbox because i forget to tell that terminal is not a sandbox application so",
    "start": "1990159",
    "end": "1998399"
  },
  {
    "text": "that's why it was the target so here's a another recorded demo of this",
    "start": "1998399",
    "end": "2005600"
  },
  {
    "text": "so i have the da escape application which is sandboxed it has the com apple security",
    "start": "2005600",
    "end": "2012799"
  },
  {
    "text": "app sandbox profile and i list the currently mounted locations so we can see that the",
    "start": "2012799",
    "end": "2019279"
  },
  {
    "text": "preference this directory is not mounted over",
    "start": "2019279",
    "end": "2023760"
  },
  {
    "text": "and then i simply start the application and at this point it will start",
    "start": "2024480",
    "end": "2030799"
  },
  {
    "text": "the race we can also see that some mounting happening",
    "start": "2030799",
    "end": "2037039"
  },
  {
    "text": "it's finished we launched terminal and we mounted over the",
    "start": "2037039",
    "end": "2043760"
  },
  {
    "text": "user username library preferences and now if i open the terminal profiles",
    "start": "2043760",
    "end": "2050079"
  },
  {
    "text": "and go to the shell now we can see that there is a run command setup so basically",
    "start": "2050079",
    "end": "2056158"
  },
  {
    "text": "we achieved a sandbox escape through this mode",
    "start": "2056159",
    "end": "2062158"
  },
  {
    "text": "so conclusion uh to all of this um i think it's first to read write-ups",
    "start": "2063440",
    "end": "2071040"
  },
  {
    "text": "carefully i know we have no time to do it every time uh but sometimes it's worse and and we",
    "start": "2071040",
    "end": "2078560"
  },
  {
    "text": "can find hidden gems uh there and it's virtual visiting all",
    "start": "2078560",
    "end": "2083839"
  },
  {
    "text": "documentation notes articles or code or or whatever because again we don't remember anything",
    "start": "2083839",
    "end": "2091358"
  },
  {
    "text": "and we might get new ideas uh by reading them again",
    "start": "2091359",
    "end": "2096638"
  },
  {
    "text": "also maybe when we originally read something maybe we lacked some knowledge that we",
    "start": "2096639",
    "end": "2103119"
  },
  {
    "text": "have now so when we reread something uh it's",
    "start": "2103119",
    "end": "2108720"
  },
  {
    "text": "we read it with a different context or with uh with a different knowledge set uh at that time so it's",
    "start": "2108720",
    "end": "2115920"
  },
  {
    "text": "it's worse to slow them sometimes",
    "start": "2115920",
    "end": "2121040"
  },
  {
    "text": "thank you very much i'm not sure if there are any questions",
    "start": "2121040",
    "end": "2127930"
  },
  {
    "text": "[Music]",
    "start": "2127930",
    "end": "2131000"
  },
  {
    "text": "[Music] you",
    "start": "2134840",
    "end": "2138079"
  }
]