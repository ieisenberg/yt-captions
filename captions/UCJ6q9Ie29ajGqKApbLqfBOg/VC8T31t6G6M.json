[
  {
    "start": "0",
    "end": "161000"
  },
  {
    "text": "[Music]",
    "start": "1130",
    "end": "14690"
  },
  {
    "text": "hello everyone and thank you for joining i'm only i'm from microsoft's azure",
    "start": "16560",
    "end": "21600"
  },
  {
    "text": "defender for iot group today i'll be talking about two remote code execution vulnerabilities i found",
    "start": "21600",
    "end": "28160"
  },
  {
    "text": "in a popular physical security system which you probably also know as an alarm system",
    "start": "28160",
    "end": "35440"
  },
  {
    "text": "i won't only be talking about those two vulnerabilities but i'll also be showing you a full exploit chain leading from",
    "start": "35440",
    "end": "43200"
  },
  {
    "text": "the vulnerability itself up until the point where the alarm is disarmed so we don't have a lot of time let's",
    "start": "43200",
    "end": "50079"
  },
  {
    "text": "start some general background information i",
    "start": "50079",
    "end": "55120"
  },
  {
    "text": "wasn't actually working on this specific project i was working on another project i was looking for vulnerabilities in a",
    "start": "55120",
    "end": "62239"
  },
  {
    "text": "open source network stack called lwip it's a pretty popular one mainly with the low-end",
    "start": "62239",
    "end": "69200"
  },
  {
    "text": "devices so while looking around at sudan i found a lot of devices that",
    "start": "69200",
    "end": "76159"
  },
  {
    "text": "i use lwip and are connected to the internet and i wanted to figure out what are those devices so surprisingly",
    "start": "76159",
    "end": "83840"
  },
  {
    "text": "the majority of those devices a wall from the same lwip version",
    "start": "83840",
    "end": "92079"
  },
  {
    "text": "which was super interesting to me so i looked around it and tried to figure out what are those",
    "start": "92079",
    "end": "97600"
  },
  {
    "text": "devices so looking at a some device for example from spain some endpoint you can see",
    "start": "97600",
    "end": "104560"
  },
  {
    "text": "that it has an interesting panel and it says you must activate your",
    "start": "104560",
    "end": "109920"
  },
  {
    "text": "javascript and a some login page in here so and another endpoint for example for",
    "start": "109920",
    "end": "117360"
  },
  {
    "text": "more mania a as is this a very a similar banner and a login page that",
    "start": "117360",
    "end": "124799"
  },
  {
    "text": "looks almost the same after digging for a while with with this",
    "start": "124799",
    "end": "131039"
  },
  {
    "text": "information i finally understood that uh it was a product from a company named",
    "start": "131039",
    "end": "136800"
  },
  {
    "text": "paradox paradox is a popular canadian manufacturer of physical security systems",
    "start": "136800",
    "end": "142560"
  },
  {
    "text": "and and more specifically what you saw earlier in sudan came from this",
    "start": "142560",
    "end": "148480"
  },
  {
    "text": "network model ip 150 internet model which works with the whole range of alarm",
    "start": "148480",
    "end": "155599"
  },
  {
    "text": "systems that paradox manufacture so fast forward",
    "start": "155599",
    "end": "161040"
  },
  {
    "start": "161000",
    "end": "161000"
  },
  {
    "text": "we got the equipment and this is it so what you see in here in this little",
    "start": "161040",
    "end": "166480"
  },
  {
    "text": "metal box is actually uh first the control panel and the sp 4000 control panel in the alarm system",
    "start": "166480",
    "end": "173920"
  },
  {
    "text": "jargon is the main board is the motherboard is where everything connects to",
    "start": "173920",
    "end": "179920"
  },
  {
    "text": "then we have the internet module in here with some cheap plastic on it so after peeling the",
    "start": "179920",
    "end": "186000"
  },
  {
    "text": "plastic you can see that it's quite a simple board uh in here we have an arm chip",
    "start": "186000",
    "end": "193920"
  },
  {
    "text": "on it which came from st electronics it's an stm",
    "start": "193920",
    "end": "199920"
  },
  {
    "text": "32f chip which is an arm compatible a chip",
    "start": "199920",
    "end": "206799"
  },
  {
    "text": "for embedded devices then we have this keypad in here",
    "start": "206799",
    "end": "212400"
  },
  {
    "text": "uh which you probably know it can it's in most places it's installed right next",
    "start": "212400",
    "end": "217440"
  },
  {
    "text": "to the door and you can put the code and arm the alarm system before leaving the",
    "start": "217440",
    "end": "222640"
  },
  {
    "text": "building uh and besides that we have the power supply here",
    "start": "222640",
    "end": "227920"
  },
  {
    "text": "so i cropped the image a bit so we can talk about protocols uh so first we have the internet model",
    "start": "227920",
    "end": "233920"
  },
  {
    "text": "it goes to the public internet via standard ethernet connection",
    "start": "233920",
    "end": "238959"
  },
  {
    "text": "and on the other side it connects to the a control board with a proprietary serial protocol so",
    "start": "238959",
    "end": "245840"
  },
  {
    "text": "the ip150 is actually a kind of a bridge between ethernet and serial protocol",
    "start": "245840",
    "end": "252480"
  },
  {
    "text": "a a down a on the down part we have the keypad which also connects with the same",
    "start": "252480",
    "end": "259840"
  },
  {
    "text": "serial protocol and we didn't purchase those but a generally speaking the sensors the",
    "start": "259840",
    "end": "266960"
  },
  {
    "text": "silence would connect also to the control board that's how it looks like on my desk",
    "start": "266960",
    "end": "273360"
  },
  {
    "text": "there is the laptop in here it connects directly and we'll later see how and why",
    "start": "273360",
    "end": "280479"
  },
  {
    "text": "so let's start with the fun a in those kind of project the first thing that you that i want to do",
    "start": "280479",
    "end": "287280"
  },
  {
    "start": "282000",
    "end": "282000"
  },
  {
    "text": "is normally getting female updates because i want the female itself and that's the easiest way to go",
    "start": "287280",
    "end": "292639"
  },
  {
    "text": "so i got this device it's called this a software sorry it's called infield uh paradox supplies it",
    "start": "292639",
    "end": "299759"
  },
  {
    "text": "to the clients in order to a install female updates on the whole range of",
    "start": "299759",
    "end": "306720"
  },
  {
    "text": "devices so this is actually an older version of infield than the current one it shows",
    "start": "306720",
    "end": "313520"
  },
  {
    "text": "that because it gives me the option to select what i want to download and download it locally",
    "start": "313520",
    "end": "320400"
  },
  {
    "text": "so i chose the internet model and got the file uh which is named ip150 the version and dot",
    "start": "320400",
    "end": "327840"
  },
  {
    "text": "path i suspect that the path is a paradox update file maybe paradox",
    "start": "327840",
    "end": "333840"
  },
  {
    "text": "update format uh anyways i asked minwork to check it for me and",
    "start": "333840",
    "end": "340560"
  },
  {
    "text": "didn't get any result and looking at the entropy it's pretty clear why",
    "start": "340560",
    "end": "346560"
  },
  {
    "text": "uh it seemed to be encrypted or might be compressed but i guess that encrypted",
    "start": "346560",
    "end": "353360"
  },
  {
    "text": "so let's just take a quick look on the firmware itself uh it's a comparison between version 4",
    "start": "353360",
    "end": "360080"
  },
  {
    "text": "and version 3 of the female 4 the same device we can see that most of the data in here",
    "start": "360080",
    "end": "367440"
  },
  {
    "text": "is a actually the same between both versions uh we can see that we have the version",
    "start": "367440",
    "end": "373919"
  },
  {
    "text": "id probably the version id here and in here and that we have the data itself that",
    "start": "373919",
    "end": "381120"
  },
  {
    "text": "encrypted all compass data in here which is a different [Music]",
    "start": "381120",
    "end": "388800"
  },
  {
    "text": "so at that point i want i wanted to either decrypt or decompress the data",
    "start": "388800",
    "end": "395120"
  },
  {
    "text": "i assumed it it might be sold or some simple encryption simple standard encryption because of this repeated a",
    "start": "395120",
    "end": "402400"
  },
  {
    "text": "pattern which most of the time indicate it's a simple so encryption but wasn't very",
    "start": "402400",
    "end": "409120"
  },
  {
    "text": "successful with that i fought with that for a week and doing the fast forward thing again",
    "start": "409120",
    "end": "416319"
  },
  {
    "text": "i finally looked online and i was able to find in some github",
    "start": "416319",
    "end": "423759"
  },
  {
    "text": "a post for mega form a guy girl which goes by the name of nes mogos",
    "start": "423759",
    "end": "428880"
  },
  {
    "text": "uh which did excellent work decrypting uh the firmware uh and he actually uploaded for everyone",
    "start": "428880",
    "end": "437199"
  },
  {
    "text": "who wants to play with reverse engineering uh in 2018 so i actually reached him uh because",
    "start": "437199",
    "end": "444000"
  },
  {
    "text": "it's an old post i reached him and i asked and he suggested that he'll decrypt the",
    "start": "444000",
    "end": "450160"
  },
  {
    "text": "newer version for me and finally i got the decryption decrypted a",
    "start": "450160",
    "end": "457360"
  },
  {
    "start": "454000",
    "end": "454000"
  },
  {
    "text": "femwell which strings looks like that",
    "start": "457360",
    "end": "463360"
  },
  {
    "text": "so we have the ad there we have some server in here and we have a lot of",
    "start": "463360",
    "end": "469120"
  },
  {
    "text": "some kind of data so what is that that data it's actually x intel hex encoded",
    "start": "469120",
    "end": "475680"
  },
  {
    "text": "and intellects works like that so we have the separator in here and in each",
    "start": "475680",
    "end": "483599"
  },
  {
    "text": "a part describes a some kind of data and where it should",
    "start": "483680",
    "end": "489360"
  },
  {
    "text": "it should go uh a checksum in the byte count the size",
    "start": "489360",
    "end": "495680"
  },
  {
    "text": "so i just took a quickly took a a python library fixed some bugs in there until it worked",
    "start": "495680",
    "end": "502000"
  },
  {
    "text": "and finally i got the decrypted payload which the firmware actually loads only",
    "start": "502000",
    "end": "507919"
  },
  {
    "text": "in memory and did some strings on it and we can see immediately that there is something",
    "start": "507919",
    "end": "513919"
  },
  {
    "text": "interesting in here although it's not quite the firmware there's no no a lot of strings in here and the editor seems",
    "start": "513919",
    "end": "520560"
  },
  {
    "text": "to indicate that it might be some kind of internet bootloader",
    "start": "520560",
    "end": "525680"
  },
  {
    "text": "so now starting with reverse engineering i loaded everything to a jira and",
    "start": "525839",
    "end": "531440"
  },
  {
    "text": "immediately spotted that there is something in here those other cells that seem to make",
    "start": "531440",
    "end": "537600"
  },
  {
    "text": "sense are taking into account that most um firmwares start with a vector table",
    "start": "537600",
    "end": "544959"
  },
  {
    "text": "which describes the initial stack pointer the main function which goes by",
    "start": "544959",
    "end": "550160"
  },
  {
    "text": "the name of reset and and some other interrupt handlers so that seems pretty good taking into",
    "start": "550160",
    "end": "556320"
  },
  {
    "text": "account that uh the memory ranges in here that's uh an image taken from the data sheet of",
    "start": "556320",
    "end": "563200"
  },
  {
    "text": "the stm chip the memory ranges of the ram matched the stack pointer address",
    "start": "563200",
    "end": "570000"
  },
  {
    "text": "and the flash the the film itself matched those addresses so that must be our main function",
    "start": "570000",
    "end": "576959"
  },
  {
    "text": "which is a really good indication so i just went over and and reverse",
    "start": "576959",
    "end": "582080"
  },
  {
    "text": "engineered the film well i needed to guess the base address so",
    "start": "582080",
    "end": "587120"
  },
  {
    "text": "things would come along like nicely and it seems like there is no operating",
    "start": "587120",
    "end": "593440"
  },
  {
    "text": "system no real-time operating system just a plain female",
    "start": "593440",
    "end": "599120"
  },
  {
    "text": "and it it seems that it does all it does a only a fetching",
    "start": "599360",
    "end": "606480"
  },
  {
    "text": "a female former remote server using some proprietary protocol and",
    "start": "606480",
    "end": "612079"
  },
  {
    "text": "which is also encrypted so taking a deep",
    "start": "612079",
    "end": "617120"
  },
  {
    "text": "breath will start i set it up a man in the middle",
    "start": "617120",
    "end": "622160"
  },
  {
    "text": "where the device the alarm system connects to my laptop which dumps the",
    "start": "622160",
    "end": "627360"
  },
  {
    "text": "network traffic with wildshark when it goes to the server",
    "start": "627360",
    "end": "632959"
  },
  {
    "text": "and on the other hand i used infield in the vm uh to i tell him to start that's a newer version",
    "start": "632959",
    "end": "640160"
  },
  {
    "text": "and just tell the device going and start update then i was able to dump the old communication with wild shock",
    "start": "640160",
    "end": "647040"
  },
  {
    "start": "647000",
    "end": "647000"
  },
  {
    "text": "and i got that so on a brief look i was able to spot the",
    "start": "647040",
    "end": "653120"
  },
  {
    "text": "encrypted firmware because it started with eb 619c",
    "start": "653120",
    "end": "658800"
  },
  {
    "text": "which i knew from exploring the puff file that is the beginning of the encrypted data",
    "start": "658800",
    "end": "666079"
  },
  {
    "text": "and for a fairly good reason eb 1699c is always this header ip150",
    "start": "666079",
    "end": "673279"
  },
  {
    "text": "on the decrypted path so that's pretty good news it seems to",
    "start": "673279",
    "end": "679040"
  },
  {
    "text": "be decrypted and encrypted so with the same encryption algorithm using the pathfile",
    "start": "679040",
    "end": "684640"
  },
  {
    "text": "and there is some some header in here so the header itself is is made up of a",
    "start": "684640",
    "end": "692640"
  },
  {
    "start": "689000",
    "end": "689000"
  },
  {
    "text": "magic number a that is just compared a packet size",
    "start": "692640",
    "end": "698240"
  },
  {
    "text": "which is little endian encoded and a checksum which is a really simple",
    "start": "698240",
    "end": "703440"
  },
  {
    "text": "cumulative checksum they just count all of the bytes together and get",
    "start": "703440",
    "end": "709839"
  },
  {
    "text": "two bytes check some and regarding the encryption um i did a",
    "start": "709839",
    "end": "716720"
  },
  {
    "text": "quick python script which is just a python version of the",
    "start": "716720",
    "end": "721839"
  },
  {
    "text": "encryption algorithm from the firmware decryption algorithm so it looks pretty similar",
    "start": "721839",
    "end": "728639"
  },
  {
    "text": "the encryption itself is not i think it's a proprietary encryption it's not very complex",
    "start": "728639",
    "end": "734880"
  },
  {
    "text": "but not very simple either [Music] so i just did the script and i tried to",
    "start": "734880",
    "end": "740720"
  },
  {
    "text": "decrypt the data and those are the strings that i got so you can see",
    "start": "740720",
    "end": "746639"
  },
  {
    "text": "that we have some kind of an html file in here and that we have several other html",
    "start": "746639",
    "end": "752639"
  },
  {
    "text": "files by name some memory manager exceptions some registers in here seems pretty good",
    "start": "752639",
    "end": "759200"
  },
  {
    "text": "seems like the the actual a firmware to me",
    "start": "759200",
    "end": "764000"
  },
  {
    "text": "so just to summarize up in this point we got the device",
    "start": "764639",
    "end": "769680"
  },
  {
    "text": "we decrypted the path with the help of our friend decrypted the x encoded in memory",
    "start": "769680",
    "end": "775120"
  },
  {
    "text": "payload reversing engineered it and using the main individual setup dumped",
    "start": "775120",
    "end": "781360"
  },
  {
    "text": "the a female form network and decrypted it",
    "start": "781360",
    "end": "786399"
  },
  {
    "text": "and now we'll get into this point to the point where we can actually",
    "start": "786399",
    "end": "792639"
  },
  {
    "text": "investigate how the web interface works this login page",
    "start": "792639",
    "end": "800320"
  },
  {
    "text": "and we know there is some involvement of lwip in here and there is some web server",
    "start": "800320",
    "end": "805839"
  },
  {
    "text": "but that now we're in the state in the state where we really want to",
    "start": "805839",
    "end": "811519"
  },
  {
    "text": "explore that part so lw ip as i said is a pretty popular",
    "start": "811519",
    "end": "819279"
  },
  {
    "text": "open source um each vendor has to implement only the network interface and then we",
    "start": "819279",
    "end": "825600"
  },
  {
    "text": "have like the ip layer and the tcp and high level protocols",
    "start": "825600",
    "end": "830880"
  },
  {
    "text": "such as dns and applications like web servers",
    "start": "830880",
    "end": "836000"
  },
  {
    "text": "specifically the web server that comes along with lwip",
    "start": "836000",
    "end": "840959"
  },
  {
    "text": "is a pretty nice web server and it's a static one also so the way that that works is that as a",
    "start": "841199",
    "end": "848800"
  },
  {
    "text": "programmer if i want to use index.html for example i'll a go and a use",
    "start": "848800",
    "end": "857040"
  },
  {
    "text": "a make fs data utility that comes along with lwip and that utility will will",
    "start": "857040",
    "end": "862639"
  },
  {
    "text": "actually take the data from index.html and encode it as an as a variable in a",
    "start": "862639",
    "end": "869199"
  },
  {
    "text": "c file so afterwards on the actual device i could use fso pen which is an",
    "start": "869199",
    "end": "875680"
  },
  {
    "text": "implementation of a virtual file system that will go back to that c file",
    "start": "875680",
    "end": "881920"
  },
  {
    "text": "and fetch the data and supply it to the application to the web server so it could send it back as a",
    "start": "881920",
    "end": "888160"
  },
  {
    "text": "get response and everything is pretty tight it's the",
    "start": "888160",
    "end": "893600"
  },
  {
    "text": "implementation is simple the http dot c holds all of the web server",
    "start": "893600",
    "end": "899839"
  },
  {
    "text": "itself and then we have the make fs data utility",
    "start": "900079",
    "end": "905839"
  },
  {
    "text": "uh and that's just an example of files that you can use so that's like the fsdata.c that",
    "start": "905839",
    "end": "912320"
  },
  {
    "text": "comes along with the project there is some index.html encoded in here and you can see",
    "start": "912320",
    "end": "917920"
  },
  {
    "text": "that it also includes like the http address and the a server adder",
    "start": "917920",
    "end": "923279"
  },
  {
    "text": "content length and the data itself",
    "start": "923279",
    "end": "927800"
  },
  {
    "start": "928000",
    "end": "928000"
  },
  {
    "text": "so let's talk about the vulnerability itself um at this point we have like as the user",
    "start": "928320",
    "end": "936000"
  },
  {
    "text": "we have the a connection page which behind the scenes uses javascript some",
    "start": "936000",
    "end": "942399"
  },
  {
    "text": "legacy function called login encrypt which",
    "start": "942399",
    "end": "948160"
  },
  {
    "text": "actually encrypts the a user code with lc4 then it hashes it",
    "start": "948160",
    "end": "954480"
  },
  {
    "text": "with md5 and x encoded so it could be safely passed as a username and password",
    "start": "954480",
    "end": "960560"
  },
  {
    "text": "i think the username and password split is for legacy purposes",
    "start": "960560",
    "end": "966320"
  },
  {
    "text": "so it just encrypts hashes and xm codes and everything is passed as a get",
    "start": "966320",
    "end": "971680"
  },
  {
    "text": "parameters uh to the server now on the server side what paradox did",
    "start": "971680",
    "end": "977920"
  },
  {
    "text": "they actually took the stock server from lwip and they added uh",
    "start": "977920",
    "end": "985120"
  },
  {
    "text": "verification functions so the user must be logged in so that's just some general function",
    "start": "985120",
    "end": "991360"
  },
  {
    "text": "that uses um [Music] that handles the cgi calls and you can see there is like a loop in here and",
    "start": "991360",
    "end": "997680"
  },
  {
    "text": "there's the extract ui parameters and on the other end we have um the firmware",
    "start": "997680",
    "end": "1003440"
  },
  {
    "text": "so we have the same function here's the loop and here's the extract ui parameters only with a check to see if the user is",
    "start": "1003440",
    "end": "1010959"
  },
  {
    "text": "connected uh is so that that's what they did and",
    "start": "1010959",
    "end": "1016959"
  },
  {
    "text": "and what we care about is the actual authentication functions on the server",
    "start": "1016959",
    "end": "1022560"
  },
  {
    "text": "function only on the server side so paradox login as i tagged it",
    "start": "1022560",
    "end": "1030240"
  },
  {
    "start": "1028000",
    "end": "1028000"
  },
  {
    "text": "and and now we reach our first remote code execution",
    "start": "1030240",
    "end": "1035438"
  },
  {
    "text": "vulnerability so labeled under a cv 2020 25 189",
    "start": "1035439",
    "end": "1043760"
  },
  {
    "text": "uh it's actually a bunch of buffer overflow vulnerabilities in the same function",
    "start": "1043760",
    "end": "1049280"
  },
  {
    "text": "the same login function so a first thing you can see in here the stl copy",
    "start": "1049280",
    "end": "1054799"
  },
  {
    "text": "actually what happens is that they get parameters in here opacity is a list of strings",
    "start": "1054799",
    "end": "1061840"
  },
  {
    "text": "and for each one they take the data in the parameter and they copy it to a local uh",
    "start": "1061840",
    "end": "1069440"
  },
  {
    "text": "a buffer with a length of 100 100 bytes",
    "start": "1069440",
    "end": "1074559"
  },
  {
    "text": "and that is done obviously in an unsafe matter which leads to a buffer overflow",
    "start": "1074559",
    "end": "1080640"
  },
  {
    "text": "now the more interesting part the more interest in buffer overflow is another one",
    "start": "1080640",
    "end": "1086320"
  },
  {
    "text": "which happens on the x decoding logic so what they did in here because they",
    "start": "1086320",
    "end": "1092080"
  },
  {
    "text": "passed everything next xd coding they actually go two bytes at a time and",
    "start": "1092080",
    "end": "1097760"
  },
  {
    "text": "use scanf to decode the hex into one byte so",
    "start": "1097760",
    "end": "1104480"
  },
  {
    "text": "the thing is that the loop only stops when it's null so it's essentially the same kind of",
    "start": "1104480",
    "end": "1110240"
  },
  {
    "text": "buffer overflow we can put as many data as we want and then decode it",
    "start": "1110240",
    "end": "1115280"
  },
  {
    "text": "to a limited size buffer local buffer which leads us to another buffer",
    "start": "1115280",
    "end": "1121280"
  },
  {
    "text": "overflow and there's another with the password also obviously",
    "start": "1121280",
    "end": "1127520"
  },
  {
    "text": "a and that's our first and major uh remote code execution vulnerability",
    "start": "1127520",
    "end": "1133600"
  },
  {
    "text": "the other one is actually in a pretty similar function but",
    "start": "1133600",
    "end": "1139360"
  },
  {
    "text": "it's not the same function it's also an authentication function but it's used when you",
    "start": "1139360",
    "end": "1145200"
  },
  {
    "text": "already authenticated and they want to kind of re-verify authentication",
    "start": "1145200",
    "end": "1150880"
  },
  {
    "text": "because it's like a high privilege function and in here",
    "start": "1150880",
    "end": "1156559"
  },
  {
    "text": "you can see those it's pretty similar but only there is some more buffers",
    "start": "1156559",
    "end": "1162559"
  },
  {
    "text": "and that's exactly the same like the username and password uh in the linear",
    "start": "1162559",
    "end": "1168160"
  },
  {
    "text": "[Music] but besides the username and password we also have in this function the pnl and",
    "start": "1168160",
    "end": "1173600"
  },
  {
    "text": "pnp and some other um possible get parameter names i think",
    "start": "1173600",
    "end": "1178880"
  },
  {
    "text": "i suspect it's for um like an api kind of authentication maybe",
    "start": "1178880",
    "end": "1185200"
  },
  {
    "text": "or for legacy purposes so that's great we got two remote code",
    "start": "1185200",
    "end": "1190640"
  },
  {
    "text": "execution availabilities on the device now it's time to exploit them so",
    "start": "1190640",
    "end": "1197760"
  },
  {
    "text": "we need to decide what we want to do the obvious thing in those situations would be that we want to override the",
    "start": "1197760",
    "end": "1204960"
  },
  {
    "text": "allow the return pointer so when the function ends it will pop back the",
    "start": "1204960",
    "end": "1210159"
  },
  {
    "text": "program counter and then we get a control over the",
    "start": "1210159",
    "end": "1215280"
  },
  {
    "text": "next instruction the instruction pointer essentially so we could execute our shell code as",
    "start": "1215280",
    "end": "1222320"
  },
  {
    "text": "strictly so we could execute the shell code directly from stack",
    "start": "1222320",
    "end": "1229280"
  },
  {
    "text": "but the only problem in here is that we can't do it because in these specific",
    "start": "1229280",
    "end": "1235760"
  },
  {
    "text": "arm chips from st electronics what happens is that the memory lies in an address range",
    "start": "1235760",
    "end": "1242640"
  },
  {
    "text": "which starts with a hexa 20 which in asca encoding means a white",
    "start": "1242640",
    "end": "1249440"
  },
  {
    "text": "space and because we are working with get parameters we can't have white space in",
    "start": "1249440",
    "end": "1255440"
  },
  {
    "text": "there if we'll send white space what happens is that the server won't the vulnerability won't be triggered on the",
    "start": "1255440",
    "end": "1261360"
  },
  {
    "text": "server so that's that's kind of a problem and the way",
    "start": "1261360",
    "end": "1267919"
  },
  {
    "text": "that i solved it uh overcomed it was using an opt-chain",
    "start": "1267919",
    "end": "1272960"
  },
  {
    "start": "1269000",
    "end": "1269000"
  },
  {
    "text": "the idea with the option is to use um a existing parts of",
    "start": "1272960",
    "end": "1279039"
  },
  {
    "text": "the femur the female chord each part is called a gadget and we assemble them together we jump from",
    "start": "1279039",
    "end": "1286240"
  },
  {
    "text": "first gadget to the second gather and and the nice thing is that the film relies in the memory area that it starts",
    "start": "1286240",
    "end": "1293200"
  },
  {
    "text": "with a xr80 so we don't have a problem to jump",
    "start": "1293200",
    "end": "1298480"
  },
  {
    "text": "over there and in here the important stuff is the loading of the stack pointer address",
    "start": "1298480",
    "end": "1304720"
  },
  {
    "text": "well shellcode lies uh into a register",
    "start": "1304720",
    "end": "1309760"
  },
  {
    "text": "and then eventually into r1 and eventually we can we jump using blx the",
    "start": "1309760",
    "end": "1315280"
  },
  {
    "text": "branch instruction the jump instruction you know we jump to this address",
    "start": "1315280",
    "end": "1320960"
  },
  {
    "text": "and after doing some setup in here and all of that so um",
    "start": "1320960",
    "end": "1326960"
  },
  {
    "text": "we start with the buffer overflow we go to the firmware and form the firmware we go back to the shell code",
    "start": "1326960",
    "end": "1334880"
  },
  {
    "text": "i just wrapped it a bit so it would be nicer to use you can see it's a python code that",
    "start": "1335039",
    "end": "1341039"
  },
  {
    "text": "handles all of the exploitation and process so except the program counter we are",
    "start": "1341039",
    "end": "1348000"
  },
  {
    "text": "also overriding all of these registers and the exploit function would create a",
    "start": "1348000",
    "end": "1355679"
  },
  {
    "text": "get request to the alarm system which actually puts um",
    "start": "1355679",
    "end": "1361360"
  },
  {
    "text": "a a all of the data that we need to override",
    "start": "1361360",
    "end": "1366400"
  },
  {
    "text": "um in in the user parameter and the password parameter is specified in here",
    "start": "1366400",
    "end": "1372799"
  },
  {
    "text": "uh and i wrapped everything with a function that i called safe exec that just takes code binary code and",
    "start": "1372799",
    "end": "1380480"
  },
  {
    "text": "execute it in the memory of the device leveraging the vulnerability",
    "start": "1380480",
    "end": "1387360"
  },
  {
    "text": "and their rope gadgets so all of the gadget addresses in the firmware are encoded",
    "start": "1387360",
    "end": "1394960"
  },
  {
    "text": "and and also the code is x encoded so it be would be x decoded afterwards on the",
    "start": "1394960",
    "end": "1402159"
  },
  {
    "text": "device and it's best as the a password",
    "start": "1402159",
    "end": "1407360"
  },
  {
    "text": "a get parameter so in that point",
    "start": "1407360",
    "end": "1412559"
  },
  {
    "text": "we have the vulnerability we know how to exploit it we're using a rock chain uh to safely jump back to the shell code",
    "start": "1412559",
    "end": "1420480"
  },
  {
    "text": "and now the only thing left is to a um decide how we want to exploit it",
    "start": "1420480",
    "end": "1426400"
  },
  {
    "text": "so we said that the final goal is to disarm the alarm uh and the easiest way in my opinion to",
    "start": "1426400",
    "end": "1433120"
  },
  {
    "text": "do so is using an api and for that api we need the password",
    "start": "1433120",
    "end": "1438880"
  },
  {
    "text": "so the shell code idea is to dump the password and send it back to the cnc back to us",
    "start": "1438880",
    "end": "1445120"
  },
  {
    "text": "as the attacker and it it could be very very complex",
    "start": "1445120",
    "end": "1450480"
  },
  {
    "text": "because think about it the firmware is just it's a plain firmware uh there was no operating system there",
    "start": "1450480",
    "end": "1456400"
  },
  {
    "text": "was no api and i really didn't didn't want to mess with all of those those things so",
    "start": "1456400",
    "end": "1462640"
  },
  {
    "text": "creating a reverse shell for example would require a lot of work so the idea was to leverage what the",
    "start": "1462640",
    "end": "1468799"
  },
  {
    "text": "code that we already have in the funeral and and the way that i did it is um by",
    "start": "1468799",
    "end": "1475760"
  },
  {
    "text": "changing the original code flow so originally uh the user would request a",
    "start": "1475760",
    "end": "1482240"
  },
  {
    "text": "to login uh and then the function would the login function would check okay the username",
    "start": "1482240",
    "end": "1487360"
  },
  {
    "text": "and password is valid yes yes okay now it would open some a41 page",
    "start": "1487360",
    "end": "1494400"
  },
  {
    "text": "and it would set it to be the page that the device should return so the idea was that we'll change the",
    "start": "1494400",
    "end": "1501120"
  },
  {
    "text": "flow here we have the exploit and it's instead of opening uh and of simply opening and",
    "start": "1501120",
    "end": "1509039"
  },
  {
    "text": "returning on that html page will modify the behavior",
    "start": "1509039",
    "end": "1515840"
  },
  {
    "text": "so that the html page um actually a a",
    "start": "1515919",
    "end": "1521279"
  },
  {
    "text": "would point to some a address in memory that we know",
    "start": "1521279",
    "end": "1527520"
  },
  {
    "text": "that the password is is at so every html page every page that you",
    "start": "1527520",
    "end": "1534640"
  },
  {
    "text": "open with the fs function open fs open function uh actually returns a descriptor which",
    "start": "1534640",
    "end": "1540720"
  },
  {
    "text": "says okay that's the file that's the file name that's where the data is that's the",
    "start": "1540720",
    "end": "1546400"
  },
  {
    "text": "length of the data so we'll open some whatever page",
    "start": "1546400",
    "end": "1552400"
  },
  {
    "text": "and then we'll edit the pointer to the data and set it to so the device would return that new modified",
    "start": "1552400",
    "end": "1560000"
  },
  {
    "text": "page which is essentially the password for memory that's how the fs open function the",
    "start": "1560000",
    "end": "1566240"
  },
  {
    "text": "original function from lwp looks like you can see it sets all of this data in the descriptor right here",
    "start": "1566240",
    "end": "1573440"
  },
  {
    "text": "and all of what we want to do is modify this pointer and that's the shell code uh which",
    "start": "1573440",
    "end": "1580240"
  },
  {
    "start": "1578000",
    "end": "1578000"
  },
  {
    "text": "modifies the pointer that some initialization stuff not interesting default html password a",
    "start": "1580240",
    "end": "1587360"
  },
  {
    "text": "password so string in the firmware so that's the address in the firmware",
    "start": "1587360",
    "end": "1593039"
  },
  {
    "text": "uh fs open the function in the firmware which handles the opening of the file from the",
    "start": "1593039",
    "end": "1598240"
  },
  {
    "text": "vfs uh which lies in that address um we just call it like branch to it",
    "start": "1598240",
    "end": "1605120"
  },
  {
    "text": "and then changing a a the data pointer to our new data",
    "start": "1605120",
    "end": "1612640"
  },
  {
    "text": "which is the password in memory you can see that's a ram address",
    "start": "1612640",
    "end": "1619279"
  },
  {
    "text": "and then we'll continue in with the normal execution which essentially leads to",
    "start": "1619279",
    "end": "1625440"
  },
  {
    "text": "the behavior where the device returns the password it dumps it for memory and",
    "start": "1625440",
    "end": "1631039"
  },
  {
    "text": "returns it to us on the same get request that we created to exploit the device",
    "start": "1631039",
    "end": "1638480"
  },
  {
    "text": "now we exploited the device we got a password now the question is how do we disarm it so for that there is a bunch",
    "start": "1638559",
    "end": "1646159"
  },
  {
    "text": "of products in github i chose to use pai paradox alarm interface which is a really nice project",
    "start": "1646159",
    "end": "1653440"
  },
  {
    "text": "it's just like for automation purposes for guys who want to um do like home automation stuff with the",
    "start": "1653440",
    "end": "1659840"
  },
  {
    "text": "alarm system and the thing with pai is that um is the",
    "start": "1659840",
    "end": "1665200"
  },
  {
    "start": "1663000",
    "end": "1663000"
  },
  {
    "text": "way that it works so we exploited um a port 80 like the web interface which",
    "start": "1665200",
    "end": "1672480"
  },
  {
    "text": "should be open uh from the public internet but pai works as this management software called",
    "start": "1672480",
    "end": "1679600"
  },
  {
    "text": "babywell babywear is paradox management a software for a",
    "start": "1679600",
    "end": "1685200"
  },
  {
    "text": "the alarm systems and it's used to set up different tools different areas different sensors all of",
    "start": "1685200",
    "end": "1692159"
  },
  {
    "text": "these things but it's used locally so a port a 10 000 would normally be open",
    "start": "1692159",
    "end": "1699600"
  },
  {
    "text": "only on their local network and we're on the internet",
    "start": "1699600",
    "end": "1704960"
  },
  {
    "text": "so what can we do with that um and my idea was to create another shell",
    "start": "1704960",
    "end": "1710799"
  },
  {
    "text": "code which would switch the ports uh so after the first exploitation",
    "start": "1710799",
    "end": "1717440"
  },
  {
    "text": "uh and and after we have the password we'll exploit it again",
    "start": "1717440",
    "end": "1723200"
  },
  {
    "text": "and tell it okay a switch between port 10 000 between the service that goes on",
    "start": "1723200",
    "end": "1728880"
  },
  {
    "text": "paul 10 000 and the service that goes with port 80. so for that i created this shell code",
    "start": "1728880",
    "end": "1736240"
  },
  {
    "text": "which essentially used an update config function which is built in in the firmware",
    "start": "1736240",
    "end": "1742159"
  },
  {
    "text": "and tells it to switch uh the services so now um",
    "start": "1742159",
    "end": "1748799"
  },
  {
    "text": "what we get is that uh port 10 000 like the management port is actually port 80",
    "start": "1748799",
    "end": "1754960"
  },
  {
    "text": "and it would be open to the public internet",
    "start": "1754960",
    "end": "1760240"
  },
  {
    "text": "and and that's pretty much it so um we just to summarize what we we did",
    "start": "1761360",
    "end": "1767760"
  },
  {
    "text": "up until this point uh we decrypted the path with the help of our friend nesmogos we decoded the xenx",
    "start": "1767760",
    "end": "1776240"
  },
  {
    "text": "intellects encoded payload we did a man in the middle attack uh grabbed damped the network a traffic",
    "start": "1776240",
    "end": "1784000"
  },
  {
    "text": "uh reversed engineered the intellect payload uh with that knowledge from the reverse",
    "start": "1784000",
    "end": "1790000"
  },
  {
    "text": "engineering we decrypted we understood and decrypted the female from the network",
    "start": "1790000",
    "end": "1795919"
  },
  {
    "text": "afterwards we reverse engineered and found the vulnerability in the login a handling",
    "start": "1795919",
    "end": "1802559"
  },
  {
    "text": "function we exploited this vulnerability using an op chain that led us back to the first",
    "start": "1802559",
    "end": "1809600"
  },
  {
    "text": "shell code [Music] which is a password dumper it just dumped the password for us for memory",
    "start": "1809600",
    "end": "1816240"
  },
  {
    "text": "and returned it on the same get request then we",
    "start": "1816240",
    "end": "1821360"
  },
  {
    "text": "exploited the device the vulnerability again switched the ports and now we have bought 10 000 open",
    "start": "1821360",
    "end": "1828559"
  },
  {
    "text": "uh to the public internet and we have the device password together with the python pai library",
    "start": "1828559",
    "end": "1835039"
  },
  {
    "text": "uh and and then we disarm the device",
    "start": "1835039",
    "end": "1840159"
  },
  {
    "text": "uh and that's pretty much it so now it's demo time okay guys so it's demo time and i want",
    "start": "1840159",
    "end": "1847360"
  },
  {
    "text": "to do this demo really quick so we'll have enough time for the live q and a",
    "start": "1847360",
    "end": "1852559"
  },
  {
    "text": "session so let's start first thing you can see my screen with the jupiter notebook and",
    "start": "1852559",
    "end": "1859039"
  },
  {
    "text": "all of the exploitation code in it so we're just gonna go and execute it step by step",
    "start": "1859039",
    "end": "1866159"
  },
  {
    "text": "uh so you will get a real clear view of what's going on and if you notice you can also see the",
    "start": "1866159",
    "end": "1872480"
  },
  {
    "text": "camera view with the alarm system itself so here",
    "start": "1872480",
    "end": "1877519"
  },
  {
    "text": "we have the actual control panel uh which is used",
    "start": "1877519",
    "end": "1882559"
  },
  {
    "text": "to control the alarm system uh and you can see we have two rooms one is the hallway the other one is the",
    "start": "1882559",
    "end": "1887840"
  },
  {
    "text": "kitchen both are system off which means the alarm is off so i just go ahead and arm",
    "start": "1887840",
    "end": "1893440"
  },
  {
    "text": "it code um area number one",
    "start": "1893440",
    "end": "1898640"
  },
  {
    "text": "um area number two and we'll give it a second okay and now it's on",
    "start": "1898640",
    "end": "1906399"
  },
  {
    "text": "so uh if we'll go back to the jupiter notebook um you'll probably notice in here",
    "start": "1906399",
    "end": "1913039"
  },
  {
    "text": "the exploit function and save exact form stack which we talked about earlier both are responsible to execute to",
    "start": "1913039",
    "end": "1920559"
  },
  {
    "text": "exploit the actual device have some utility functions in here which are not really interesting",
    "start": "1920559",
    "end": "1928320"
  },
  {
    "text": "and target ip so in this specific case in this demo i just connected the alarm directly to my",
    "start": "1928320",
    "end": "1934640"
  },
  {
    "text": "laptop but obviously in in real life we want to access it to attack it from the public internet and there's probably",
    "start": "1934640",
    "end": "1940960"
  },
  {
    "text": "gonna be some router with some portfolio configured on it so we need to keep that in mind",
    "start": "1940960",
    "end": "1948799"
  },
  {
    "text": "let's go ahead shotgun number one is the memory dumper which we also talked about",
    "start": "1948799",
    "end": "1954080"
  },
  {
    "text": "so we can see that it was pretty quick and we got like the http response back",
    "start": "1954080",
    "end": "1959679"
  },
  {
    "text": "those are the http headers this is the actual law memory dump",
    "start": "1959679",
    "end": "1965760"
  },
  {
    "text": "as you can see it's pretty well there's like url in here there's some hex values in here um pretty nice",
    "start": "1965760",
    "end": "1972559"
  },
  {
    "text": "and in here if you notice you'll see paradox which is our password so we'll go ahead and decode it",
    "start": "1972559",
    "end": "1979760"
  },
  {
    "text": "paradox this is actually the the default management password for the",
    "start": "1979760",
    "end": "1985200"
  },
  {
    "text": "device so now we got a password the other thing that we want to achieve is to switch the",
    "start": "1985200",
    "end": "1991360"
  },
  {
    "text": "ports so as we said in real life the ports",
    "start": "1991360",
    "end": "1997200"
  },
  {
    "text": "the management ports probably won't be accessible from the public internet so we need to switch the",
    "start": "1997200",
    "end": "2003039"
  },
  {
    "text": "management and web interface uh so now uh it seemed to",
    "start": "2003039",
    "end": "2008960"
  },
  {
    "text": "be successful so um the management port is actually opened on port 80 instead of 10 000 and",
    "start": "2008960",
    "end": "2017360"
  },
  {
    "text": "the web port is on a port 10 000 instead of 80. so we got pretty much everything that we",
    "start": "2017360",
    "end": "2024399"
  },
  {
    "text": "wanted um we have the the management password and we can access the management port",
    "start": "2024399",
    "end": "2031440"
  },
  {
    "text": "so we'll go ahead and use paradox allow interface which is the library too that we're using to connect",
    "start": "2031440",
    "end": "2038080"
  },
  {
    "text": "to the device you can see there's some configuration that we need to do so here",
    "start": "2038080",
    "end": "2043840"
  },
  {
    "text": "is the device ip here is the password that we dumped using the shell code from the device",
    "start": "2043840",
    "end": "2050480"
  },
  {
    "text": "memory and we'll go ahead and try to connect to it you can ignore those errors though",
    "start": "2050480",
    "end": "2057440"
  },
  {
    "text": "it's just a kind of an unstable device and we got two which means that we are",
    "start": "2057440",
    "end": "2064398"
  },
  {
    "text": "now connected to the device so we'll do a quick refresh and get the partitions",
    "start": "2064399",
    "end": "2069919"
  },
  {
    "text": "so what are those partitions um there are actually the representation",
    "start": "2069919",
    "end": "2075358"
  },
  {
    "text": "of the areas um that uh you saw so hallway and kitchen",
    "start": "2075359",
    "end": "2082158"
  },
  {
    "text": "you can also see them on the camera view always kitchen uh and what we care about is actually",
    "start": "2082159",
    "end": "2088079"
  },
  {
    "text": "the key which is the internal id for those areas and we really need to know it so we can",
    "start": "2088079",
    "end": "2094480"
  },
  {
    "text": "uh disarm those partition those areas",
    "start": "2094480",
    "end": "2100400"
  },
  {
    "text": "so in here we're just gonna go ahead and try to disarm the first partition the first area which is hallway",
    "start": "2100400",
    "end": "2107520"
  },
  {
    "text": "and you can see uh that we got hallway and we got system off which means",
    "start": "2107520",
    "end": "2113839"
  },
  {
    "text": "that now the alarm in in the hallway is disabled is disarmed",
    "start": "2113839",
    "end": "2119760"
  },
  {
    "text": "so we'll just proceed and we'll try to disarm the other partition",
    "start": "2119760",
    "end": "2125359"
  },
  {
    "text": "and you should look at the camera view and you'll see that kitchen switch to system",
    "start": "2125359",
    "end": "2131839"
  },
  {
    "text": "off so that's it everything is this sound and now our guys can go and breach the",
    "start": "2131839",
    "end": "2139040"
  },
  {
    "text": "actual physical building and they don't need to worry at all about the alarm system",
    "start": "2139040",
    "end": "2145920"
  },
  {
    "text": "and and that's it so thank you for watching and i'll see you in a second in the live",
    "start": "2145920",
    "end": "2152960"
  },
  {
    "text": "q a session let's see it",
    "start": "2152960",
    "end": "2157560"
  }
]