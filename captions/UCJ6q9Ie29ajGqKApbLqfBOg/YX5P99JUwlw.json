[
  {
    "text": "hello everyone welcome to my session I'm baring the power",
    "start": "2760",
    "end": "8120"
  },
  {
    "text": "engine so my name is y chudo and I work for SEC works and I provide R services",
    "start": "8719",
    "end": "15639"
  },
  {
    "text": "for mainly Enterprises in Japan so today's presentation is mainly about",
    "start": "15639",
    "end": "21519"
  },
  {
    "text": "Microsoft inun but first let me talk about what Microsoft engine is and what",
    "start": "21519",
    "end": "26760"
  },
  {
    "text": "is it so Eng is I think you might know about",
    "start": "26760",
    "end": "33000"
  },
  {
    "text": "um endpoint man endpoint management solution and it is very useful for managing devices and Enterprise and it",
    "start": "33000",
    "end": "41480"
  },
  {
    "text": "has a lot of features such as configuration management and application deployment and so",
    "start": "41480",
    "end": "47840"
  },
  {
    "text": "on and if you look at Enterprise device management these days we have seen a lot",
    "start": "47879",
    "end": "53079"
  },
  {
    "text": "a lot of companies using active directory and group policy and also sgcm",
    "start": "53079",
    "end": "58719"
  },
  {
    "text": "I mean coping man meure however more and more companies have started using enter ID and enter ID",
    "start": "58719",
    "end": "67119"
  },
  {
    "text": "isal access and also Microsoft inun so I think Microsoft inun has a lot of",
    "start": "67119",
    "end": "72880"
  },
  {
    "text": "features and I think it is becoming the main component of the um endpoint management so I thought inun might be a",
    "start": "72880",
    "end": "79600"
  },
  {
    "text": "great Target for my research this is why I started researching in chune and try to understand how in Chun is working",
    "start": "79600",
    "end": "86479"
  },
  {
    "text": "internally and how attackers can abuse it",
    "start": "86479",
    "end": "91920"
  },
  {
    "text": "so today I'd like to share some of the findings from my research and also I'd",
    "start": "93000",
    "end": "98040"
  },
  {
    "text": "like to share some of the findings from our the team engagements first I'd like to take a",
    "start": "98040",
    "end": "103439"
  },
  {
    "text": "look at the overview of the mechanism of Microsoft in chune then I will talk about some attack techniques abusing in",
    "start": "103439",
    "end": "111320"
  },
  {
    "text": "chune and also I'd like to introduce a new tool with demo finary takeaways",
    "start": "111320",
    "end": "120320"
  },
  {
    "text": "so let's dive into the internal working of Microsoft vun here I'd like to mainly look at two",
    "start": "120640",
    "end": "128119"
  },
  {
    "text": "components about Microsoft vun first I like to talk about the device enrollment",
    "start": "128119",
    "end": "133520"
  },
  {
    "text": "which means how device is enrolled in chune and then I directly look at device",
    "start": "133520",
    "end": "138840"
  },
  {
    "text": "management which means how in Chun manage the device after the device",
    "start": "138840",
    "end": "144640"
  },
  {
    "text": "enrollment so let's take a look at the um device enrollment first",
    "start": "144640",
    "end": "151360"
  },
  {
    "text": "so I'm going I'm going to talk about the steps of the device enrollment and if you want to enoll your device first you",
    "start": "151879",
    "end": "158000"
  },
  {
    "text": "need to install the in company Port app in your smartphone and once you install your app",
    "start": "158000",
    "end": "165879"
  },
  {
    "text": "and open it you need to log to enter ID I think you might have seen this",
    "start": "165879",
    "end": "172440"
  },
  {
    "text": "before but um you type your email and password into this uh practice",
    "start": "172440",
    "end": "179280"
  },
  {
    "text": "and once the app receives the credentials the app sends login request to enter ID and this is the um example",
    "start": "180440",
    "end": "187959"
  },
  {
    "text": "of the Ling request and what we want to look at here is that the client it has",
    "start": "187959",
    "end": "193440"
  },
  {
    "text": "the client ID of inine company Port app which means that this login is made by",
    "start": "193440",
    "end": "199000"
  },
  {
    "text": "the in application and after the successful",
    "start": "199000",
    "end": "204400"
  },
  {
    "text": "ring insurent application receives access token from enter ID and with the",
    "start": "204400",
    "end": "210640"
  },
  {
    "text": "acquired token the app sends this discovery request to know which server",
    "start": "210640",
    "end": "215760"
  },
  {
    "text": "to talk with for device enrollment and here is the um example of",
    "start": "215760",
    "end": "223120"
  },
  {
    "text": "the request to discover the enrollment",
    "start": "223120",
    "end": "227480"
  },
  {
    "text": "endpoint then it receives Json responses like this and it has the URL for the",
    "start": "228879",
    "end": "234680"
  },
  {
    "text": "device enrollment service of inun and this URL is used for enrolling device in",
    "start": "234680",
    "end": "241720"
  },
  {
    "text": "later but before enrolling device to inun the device needs to be registered to enter ID by talking to the enter ID's",
    "start": "242400",
    "end": "250760"
  },
  {
    "text": "device registration service so once device is registered to",
    "start": "250760",
    "end": "256359"
  },
  {
    "text": "enter ID you can see the device practice in the a p however the device is not",
    "start": "256359",
    "end": "262280"
  },
  {
    "text": "registered to in yet and to Enad the device to inur the device have to send an",
    "start": "262280",
    "end": "268840"
  },
  {
    "text": "insurance device certificate to the enrollment service",
    "start": "268840",
    "end": "274320"
  },
  {
    "text": "subvention and this is the um example of the request for eling device to inurance",
    "start": "274320",
    "end": "279560"
  },
  {
    "text": "by Android device and the request has the access",
    "start": "279560",
    "end": "284800"
  },
  {
    "text": "token received from enter ID and also the request has signing request of the",
    "start": "284800",
    "end": "291000"
  },
  {
    "text": "insurance device certificate for this enement request RSA key pair is",
    "start": "291000",
    "end": "296600"
  },
  {
    "text": "generated and ened inun for the device indication",
    "start": "296600",
    "end": "301639"
  },
  {
    "text": "then inun application receives sign device certificate that can be used to authenticate to",
    "start": "302759",
    "end": "307800"
  },
  {
    "text": "inun also it gets DM server URL which is the inurance management server URL in",
    "start": "307800",
    "end": "314080"
  },
  {
    "text": "this response after the enrollment request",
    "start": "314080",
    "end": "320560"
  },
  {
    "text": "device is finally enrolled inun so after the after the device",
    "start": "320560",
    "end": "327560"
  },
  {
    "text": "enrollment process the device object is created in entro ID and also in Microsoft inun and both objects are",
    "start": "327560",
    "end": "335440"
  },
  {
    "text": "linked via device ID ex extracted from the access token in the certificate",
    "start": "335440",
    "end": "340560"
  },
  {
    "text": "enrollment request so if device information is changed in in June then it is syn to",
    "start": "340560",
    "end": "347880"
  },
  {
    "text": "enter ID since both objects are linked be a device",
    "start": "347880",
    "end": "352919"
  },
  {
    "text": "ID now let's take a look at the how in manage its device",
    "start": "353080",
    "end": "360400"
  },
  {
    "text": "so once the device is ened in chune the device communicates to the inun management server through omadm",
    "start": "361080",
    "end": "368440"
  },
  {
    "text": "protocol and during the protocol the management server can identify device through the unload",
    "start": "368440",
    "end": "375199"
  },
  {
    "text": "certificate as for Windows you might have seen this sync button and if you press this button you can you can start",
    "start": "375199",
    "end": "381440"
  },
  {
    "text": "a communication manually and this is also called",
    "start": "381440",
    "end": "386280"
  },
  {
    "text": "checking and during the communication man management server sends a request",
    "start": "386840",
    "end": "392080"
  },
  {
    "text": "called syncml request this request defines what device should do like",
    "start": "392080",
    "end": "397759"
  },
  {
    "text": "sending OS bu information to in chune or configur configuring registry settings",
    "start": "397759",
    "end": "403560"
  },
  {
    "text": "and once this syncml request is received then the device sends back synl response",
    "start": "403560",
    "end": "410120"
  },
  {
    "text": "which contains the result of the request and in the syn ml pay the DM",
    "start": "410120",
    "end": "418479"
  },
  {
    "text": "protocol commands are defined to issue some orders to the device and there are",
    "start": "418479",
    "end": "423840"
  },
  {
    "text": "several commands defined in the protocol for example um get command is to query",
    "start": "423840",
    "end": "429319"
  },
  {
    "text": "some data from that device and exact command can be used to run some executable in the",
    "start": "429319",
    "end": "436199"
  },
  {
    "text": "device and when ordering the command the URI is also specified to indicate which",
    "start": "437479",
    "end": "442840"
  },
  {
    "text": "settings needs to be configured and this URI is called Oma URI",
    "start": "442840",
    "end": "449680"
  },
  {
    "text": "so through this protocol the device and insurance management server communicates and exchange information and this is",
    "start": "449680",
    "end": "455960"
  },
  {
    "text": "basically how in manage device so we briefly looked at the",
    "start": "455960",
    "end": "461280"
  },
  {
    "text": "overview of how inun handles a device so let's look into how attackers can abuse",
    "start": "461280",
    "end": "468918"
  },
  {
    "text": "inun so for this presentation I'd like to talk about totally four attack techniques found through the research",
    "start": "469840",
    "end": "476280"
  },
  {
    "text": "and two of them are related to the enrollment process of in June and the other two are related to the management",
    "start": "476280",
    "end": "484240"
  },
  {
    "text": "process let's look at the first one which is about bypassing con",
    "start": "484720",
    "end": "490478"
  },
  {
    "text": "access so you might already know but um access to the Clow can be controlled by the entry ID connection access and one",
    "start": "491039",
    "end": "498000"
  },
  {
    "text": "of the common policy configured in many Enterprise I see is require compliant device and the policy can allow access",
    "start": "498000",
    "end": "505759"
  },
  {
    "text": "from device that is marked as compliant and the policy can Brock access from",
    "start": "505759",
    "end": "511080"
  },
  {
    "text": "untrusted device but how is this compliance data",
    "start": "511080",
    "end": "517680"
  },
  {
    "text": "decided so in Microsoft inun it admins can Define compliance policy such as",
    "start": "517680",
    "end": "524120"
  },
  {
    "text": "disk encryption or password requirements and so on then inun evaluate each device",
    "start": "524120",
    "end": "530720"
  },
  {
    "text": "information and inun will Mark compliant based on the compliance policy so if the device is not Market as",
    "start": "530720",
    "end": "538440"
  },
  {
    "text": "compliant then the access from the device is blocked by the condition access",
    "start": "538440",
    "end": "544519"
  },
  {
    "text": "policy and this is the example of the token token request by the tool called",
    "start": "545600",
    "end": "550720"
  },
  {
    "text": "Ro TX and as you can see it is blocked by the policy so as you can see the access to",
    "start": "550720",
    "end": "557920"
  },
  {
    "text": "resources like Microsoft graph can be brocked from the uned device like",
    "start": "557920",
    "end": "564880"
  },
  {
    "text": "this however getting back to the device enrollment proc C the insur application",
    "start": "565600",
    "end": "571120"
  },
  {
    "text": "first needs to log in and make a API code to the Microsoft graph right so if",
    "start": "571120",
    "end": "576839"
  },
  {
    "text": "the conditional access policy requires compliant device then this might break the enrollment process because the",
    "start": "576839",
    "end": "583040"
  },
  {
    "text": "device is not Market as compliant before the device enrollment so I check to see",
    "start": "583040",
    "end": "588480"
  },
  {
    "text": "if the access can be brocked by the policy and I found out the actually the",
    "start": "588480",
    "end": "594880"
  },
  {
    "text": "access is not brocked by the policy and I specified in up client ID in the login",
    "start": "594880",
    "end": "601399"
  },
  {
    "text": "option to make the login request looks like it is from ancient application and by doing this we can see",
    "start": "601399",
    "end": "607880"
  },
  {
    "text": "that we can acquire the access token for Microsoft graph and this means by using the inin",
    "start": "607880",
    "end": "614839"
  },
  {
    "text": "application the access is not blocked even when the access is from non-compliant device and we can acquire",
    "start": "614839",
    "end": "622480"
  },
  {
    "text": "a token to access Microsoft graph and make a API request to Microsoft graph to steal some data in the clowd",
    "start": "622480",
    "end": "630480"
  },
  {
    "text": "however the token acquires through this approach has limited scope as you can see in the decod access token and it can",
    "start": "630480",
    "end": "637680"
  },
  {
    "text": "already query some of the data in the crowd with this acquired access",
    "start": "637680",
    "end": "643120"
  },
  {
    "text": "token however this approach also allow us to acquire access token for a graph",
    "start": "643120",
    "end": "649040"
  },
  {
    "text": "which is the former version of Microsoft graph and as you can see that scope of",
    "start": "649040",
    "end": "654519"
  },
  {
    "text": "the access token here is user impersonation which means that we can",
    "start": "654519",
    "end": "659720"
  },
  {
    "text": "make a graph API request on behalf of the signed in user and this allow us to",
    "start": "659720",
    "end": "665079"
  },
  {
    "text": "access more data comparing with the Microsoft graph token by using the aid graph token we",
    "start": "665079",
    "end": "672760"
  },
  {
    "text": "can steal data on the croud r croud r employees all of the employees information or all of the device",
    "start": "672760",
    "end": "679040"
  },
  {
    "text": "information from the untrusted device by using load Recon which is one of the",
    "start": "679040",
    "end": "684240"
  },
  {
    "text": "eneration tool using that tool you could even dump all the configurations from the access",
    "start": "684240",
    "end": "690760"
  },
  {
    "text": "policy so from from this we know that we can bypass the required compliant policy",
    "start": "690760",
    "end": "696639"
  },
  {
    "text": "through Imp personating in application then what happens if require",
    "start": "696639",
    "end": "703600"
  },
  {
    "text": "Microsoft entra hybrid joint device policy is also enabled with the required compliant device",
    "start": "703600",
    "end": "709600"
  },
  {
    "text": "policy in this policy you would imagine that with these requirements you need",
    "start": "709600",
    "end": "715200"
  },
  {
    "text": "active directory and also enter ID joint device that is marked as compliant by inun to access data on the crowd based",
    "start": "715200",
    "end": "723040"
  },
  {
    "text": "on this policy and when this polic is enabled",
    "start": "723040",
    "end": "728440"
  },
  {
    "text": "the usual login request is blocked and it says that you need a domain joint",
    "start": "728440",
    "end": "733720"
  },
  {
    "text": "device however if the request is from in application then the access is granted",
    "start": "733720",
    "end": "739880"
  },
  {
    "text": "and you can acquire the access token to steal data on the cloud so we can acquire access token for",
    "start": "739880",
    "end": "748320"
  },
  {
    "text": "Microsoft graph and also Azure graph by using the Microsoft engine company portal client ID and you can bypass the",
    "start": "748320",
    "end": "756120"
  },
  {
    "text": "device restriction polies in conditional access so in our R team engagement we",
    "start": "756120",
    "end": "762000"
  },
  {
    "text": "have abused this many times to extract information out of enter ID by using the",
    "start": "762000",
    "end": "767120"
  },
  {
    "text": "stor and credentials without any access to the Target corporate",
    "start": "767120",
    "end": "772959"
  },
  {
    "text": "device I I submitted this issue to Microsoft and of course they said this is by Design because they don't want to",
    "start": "773639",
    "end": "780079"
  },
  {
    "text": "break the device enrollment process so thanks to the insurance device enrollment process we can bypass the",
    "start": "780079",
    "end": "786720"
  },
  {
    "text": "conditional access policy and also here they recommended to enable at policy",
    "start": "786720",
    "end": "792040"
  },
  {
    "text": "like MFA so okay I enabled the MFA and if MFA",
    "start": "792040",
    "end": "798360"
  },
  {
    "text": "is require required then even with the insurance company B up the access is is",
    "start": "798360",
    "end": "804760"
  },
  {
    "text": "blocked only with just email and password this could entirely block the access even when credential is laked to",
    "start": "804760",
    "end": "811880"
  },
  {
    "text": "attackers right however there is a case where this MFA also can be",
    "start": "811880",
    "end": "818839"
  },
  {
    "text": "bypass so we have seen many Enterprises exclude Microsoft in tune in Target",
    "start": "819800",
    "end": "825240"
  },
  {
    "text": "resources from the con access policy like MFA because they don't want to force",
    "start": "825240",
    "end": "830560"
  },
  {
    "text": "employees to do MFA when low in device with this exclusion it seems that",
    "start": "830560",
    "end": "837240"
  },
  {
    "text": "access to only Microsoft in soon can be excluded from the policy that's what I",
    "start": "837240",
    "end": "844320"
  },
  {
    "text": "thought of course access to a graph only with just email and password is blocked",
    "start": "844320",
    "end": "850639"
  },
  {
    "text": "since the as we have seen the AO ID graph is not excluded from the MFA",
    "start": "850639",
    "end": "856199"
  },
  {
    "text": "requirement policy however with the inur application ID token is acquired without",
    "start": "856199",
    "end": "864600"
  },
  {
    "text": "MFA so what this means is that attackers can access graph API using the inun",
    "start": "865440",
    "end": "871560"
  },
  {
    "text": "application ID without MFA when Microsoft inun is excluded in",
    "start": "871560",
    "end": "877320"
  },
  {
    "text": "Target resources we have seen this configuration in many Enterprises and in",
    "start": "877320",
    "end": "884040"
  },
  {
    "text": "our R te engagements this helped us to access graph API AS Global administrator",
    "start": "884040",
    "end": "889440"
  },
  {
    "text": "user without MFA and we could entirely compromise it",
    "start": "889440",
    "end": "894800"
  },
  {
    "text": "tenant I submitted this issue to Microsoft and of course this is also by Design and what they said is that when",
    "start": "894880",
    "end": "901839"
  },
  {
    "text": "you exclude some resource in con access policy then dependencies are also",
    "start": "901839",
    "end": "908199"
  },
  {
    "text": "excluded at the same time so when you exclude Microsoft in tune then accessing",
    "start": "908199",
    "end": "914120"
  },
  {
    "text": "to graph API is also excluded from the policy internally so this is why MFA could be",
    "start": "914120",
    "end": "921000"
  },
  {
    "text": "bypassed as we have seen before so for this attack what I",
    "start": "921000",
    "end": "927480"
  },
  {
    "text": "recommend is the device restriction policy could be bypassed so MFA enforcement policy",
    "start": "927480",
    "end": "933319"
  },
  {
    "text": "should also be added however MFA enforcement policy can also be bypassed when some exclusion is",
    "start": "933319",
    "end": "940839"
  },
  {
    "text": "added so try not to add any exclusion to policies for high PR",
    "start": "940839",
    "end": "946079"
  },
  {
    "text": "users or you could also consider applying application filters to Target a graph with the same",
    "start": "946079",
    "end": "953439"
  },
  {
    "text": "control so let's take a look at another attack related to enrollment process which is to delete device objects",
    "start": "954680",
    "end": "960959"
  },
  {
    "text": "through enrollment process looking at the certificate",
    "start": "960959",
    "end": "966319"
  },
  {
    "text": "enrollment request in each platform I found that there are differences in the format and the parameters included in",
    "start": "966319",
    "end": "973199"
  },
  {
    "text": "the enrollment request and in the previous example we have seen Androids based Androids XML",
    "start": "973199",
    "end": "979440"
  },
  {
    "text": "based requests but on the other hand we not send Json based request with different parameters and Apple device",
    "start": "979440",
    "end": "985480"
  },
  {
    "text": "sends XML with pkcs7 sign",
    "start": "985480",
    "end": "990920"
  },
  {
    "text": "and looking into Android request I noticed that it doesn't need access token without device it doesn't need",
    "start": "991000",
    "end": "997920"
  },
  {
    "text": "access token containing device ID also device ID can be specified in the a ID",
    "start": "997920",
    "end": "1004440"
  },
  {
    "text": "parameter so what I thought was that what happens when other device device ID is specified in the err",
    "start": "1004440",
    "end": "1012399"
  },
  {
    "text": "request so the scenario is that there is already other users device object",
    "start": "1012399",
    "end": "1017440"
  },
  {
    "text": "registered in the enter ID and also in chune and attacker try to enroll device",
    "start": "1017440",
    "end": "1023000"
  },
  {
    "text": "to inun with the existing device ID and by sending the enrollment request with the other users device ID what",
    "start": "1023000",
    "end": "1030480"
  },
  {
    "text": "happens is that the existing device object is deleted from the inun",
    "start": "1030480",
    "end": "1035839"
  },
  {
    "text": "service and when the object is deleted from the in it admin cannot access and manage the device anymore like",
    "start": "1035839",
    "end": "1043640"
  },
  {
    "text": "this if I have access to the Target tenant then I can query all the user",
    "start": "1043640",
    "end": "1049440"
  },
  {
    "text": "device IDs so through this vulnerability I could destroy all the device in The Targets in",
    "start": "1049440",
    "end": "1056320"
  },
  {
    "text": "June and I submitted this issue to Microsoft and they said that this is not by Design and it is already part this",
    "start": "1056520",
    "end": "1063679"
  },
  {
    "text": "year so with this Banner abilities Banner ability attackers can delete the",
    "start": "1063679",
    "end": "1068880"
  },
  {
    "text": "best object in Microsoft in tune by abusing Android start enrollment and the point and it is already passed but what",
    "start": "1068880",
    "end": "1076880"
  },
  {
    "text": "I what I want to point out here is that Insurance supports multiplatform and they are different from each other and",
    "start": "1076880",
    "end": "1083440"
  },
  {
    "text": "to to complicated so there should be more abuse by using the differences of M",
    "start": "1083440",
    "end": "1089880"
  },
  {
    "text": "platform so let's talk about attack technique in the device management process the first one is about",
    "start": "1091240",
    "end": "1097080"
  },
  {
    "text": "establishing a foot for through omadm protocol so Microsoft enging can",
    "start": "1097080",
    "end": "1102880"
  },
  {
    "text": "configure device setting by creating a profile it can manage various device configuration like network settings and",
    "start": "1102880",
    "end": "1110799"
  },
  {
    "text": "a lot of Enterprises utilize this function for setting up corporate",
    "start": "1110799",
    "end": "1116000"
  },
  {
    "text": "device and looking into the in application I found that the device",
    "start": "1116000",
    "end": "1121159"
  },
  {
    "text": "configuration is delivered through the communication between device and in management sofware and if you look at the DM sync",
    "start": "1121159",
    "end": "1128280"
  },
  {
    "text": "message the other command contains the device configuration and this example shows the address of the internal",
    "start": "1128280",
    "end": "1135880"
  },
  {
    "text": "PPN and also the Wi-Fi settings like say SS ID and passwort are also delivered",
    "start": "1135880",
    "end": "1141440"
  },
  {
    "text": "through the DM sync message so these configurations are great resource for attackers to break",
    "start": "1141440",
    "end": "1147440"
  },
  {
    "text": "into internal network of the target Enterprise So based on the research i s",
    "start": "1147440",
    "end": "1153080"
  },
  {
    "text": "that if we can steal victim is credential or if we can steal tokens through device called fishing and if we",
    "start": "1153080",
    "end": "1160240"
  },
  {
    "text": "can replicate all the steps in na handles then we can steal the configuration data such as bpn and",
    "start": "1160240",
    "end": "1167280"
  },
  {
    "text": "Wi-Fi so that's what I did and by emulating Eng application successfully I",
    "start": "1167280",
    "end": "1172720"
  },
  {
    "text": "could steal the network information like VPN and also Wi-Fi",
    "start": "1172720",
    "end": "1177640"
  },
  {
    "text": "credential also through the research I found installer files for line of business applications are downloaded",
    "start": "1178120",
    "end": "1184400"
  },
  {
    "text": "during the session and we have seen many it admins deliver installer files for PPN client",
    "start": "1184400",
    "end": "1191520"
  },
  {
    "text": "like T Scala or ciso so replicating in application help attackers to access the",
    "start": "1191520",
    "end": "1196960"
  },
  {
    "text": "internet work and attacking the resources there however I figured out out that we",
    "start": "1196960",
    "end": "1202880"
  },
  {
    "text": "could steal more so I think you might have heard of autopilot and this helps employees to",
    "start": "1202880",
    "end": "1210039"
  },
  {
    "text": "set up their device by themselves and register the device to enter ID and in",
    "start": "1210039",
    "end": "1216000"
  },
  {
    "text": "June and this autopilot also allows employees to automatically join the",
    "start": "1216000",
    "end": "1221320"
  },
  {
    "text": "device to active directory this is called hybrid opop pirate and the process is the first you Eno your device",
    "start": "1221320",
    "end": "1228360"
  },
  {
    "text": "to and then in will send the device information to the system called inun",
    "start": "1228360",
    "end": "1235480"
  },
  {
    "text": "connector and in connector create a computer account and receives an offline",
    "start": "1235480",
    "end": "1241280"
  },
  {
    "text": "domain join BL from active directory and it sends back the domain joint BR to inun and in chune sends",
    "start": "1241280",
    "end": "1248880"
  },
  {
    "text": "domain join BR to the device so this domain join BR has a computer account",
    "start": "1248880",
    "end": "1254320"
  },
  {
    "text": "credential so by using the computer account credential that device can be a domain joint",
    "start": "1254320",
    "end": "1260840"
  },
  {
    "text": "device and looking at the communication between autop pirate device and the management server I found that the",
    "start": "1261360",
    "end": "1267159"
  },
  {
    "text": "device sends the hardware hash information through the DM DM sync",
    "start": "1267159",
    "end": "1273278"
  },
  {
    "text": "message and once the device sends the hardware has in and loads the device as aut P device and sends back the offine",
    "start": "1273320",
    "end": "1281400"
  },
  {
    "text": "to man as you can see here in the response so by rep replicating this step",
    "start": "1281400",
    "end": "1288600"
  },
  {
    "text": "as well I found out that we can impersonate aut pirate device and leak active directories account",
    "start": "1288600",
    "end": "1295400"
  },
  {
    "text": "credential so in summary we can Enad a fake device to in and communicate with the management server through omadm",
    "start": "1295960",
    "end": "1303559"
  },
  {
    "text": "protocol then we can wak the device configurations related to internet Network like bpn Ori Wi-Fi and also we",
    "start": "1303559",
    "end": "1312320"
  },
  {
    "text": "can steal the domain computer credential depending on how the environment is configured so this approach is useful",
    "start": "1312320",
    "end": "1319039"
  },
  {
    "text": "for attackers to establish an initial foot for theing in",
    "start": "1319039",
    "end": "1324120"
  },
  {
    "text": "June but I recommend here is that you need to block log device enrollment through device filtering and enrollment",
    "start": "1325080",
    "end": "1331520"
  },
  {
    "text": "restriction settings and enter ID additionally this might be bypassed",
    "start": "1331520",
    "end": "1336840"
  },
  {
    "text": "so you also want to block credential fishing and device call fishing through conditional access",
    "start": "1336840",
    "end": "1343120"
  },
  {
    "text": "policies now let me talk about the last one which is about side",
    "start": "1345720",
    "end": "1351440"
  },
  {
    "text": "car first let's take a look at application management as for Windows we have seen",
    "start": "1351600",
    "end": "1357320"
  },
  {
    "text": "install files for LOF business applications are delivered via omadm",
    "start": "1357320",
    "end": "1362640"
  },
  {
    "text": "station on the other hand paral scripts and wised apps such as exe and bch files",
    "start": "1362640",
    "end": "1368159"
  },
  {
    "text": "are downloaded through what is called in management extension also known as side",
    "start": "1368159",
    "end": "1374360"
  },
  {
    "text": "car and card is installed through om DM session after enoll to in June and once",
    "start": "1375520",
    "end": "1381799"
  },
  {
    "text": "that car is installed to the system this allows it admins to push and manage wi2",
    "start": "1381799",
    "end": "1387720"
  },
  {
    "text": "applications and partial scripts and wi2 apps like exe files are",
    "start": "1387720",
    "end": "1393200"
  },
  {
    "text": "pucked into a file code in wi file when derived and cyard unpack the in wi file",
    "start": "1393200",
    "end": "1399799"
  },
  {
    "text": "and install them into the system so as a r tea these in-house",
    "start": "1399799",
    "end": "1404919"
  },
  {
    "text": "applications are always great targets because they usually contain some cred I so I decided to research on this as",
    "start": "1404919",
    "end": "1412559"
  },
  {
    "text": "well so let's take a look at the app deployments recy during the omadm session management",
    "start": "1412559",
    "end": "1421279"
  },
  {
    "text": "server ask device to install sore and when installation is ordered DM",
    "start": "1421279",
    "end": "1427080"
  },
  {
    "text": "Client download cocard from the CDN server and inser it into the system then cyar starts communica with",
    "start": "1427080",
    "end": "1434720"
  },
  {
    "text": "communicating with the cyar Gateway service and and if there are any apps to",
    "start": "1434720",
    "end": "1439960"
  },
  {
    "text": "be installed then this service asks cyard to install the apps then cyard downloads encrypted in",
    "start": "1439960",
    "end": "1448120"
  },
  {
    "text": "one file and decrypt it by the engin device certificate and install it to the",
    "start": "1448120",
    "end": "1454640"
  },
  {
    "text": "system as for the communication between cocar and Gateway service the Json data is exchanged for",
    "start": "1455000",
    "end": "1461919"
  },
  {
    "text": "communication and the Cur is authenticated to the Gateway service via the Enad inance device certificate",
    "start": "1461919",
    "end": "1470360"
  },
  {
    "text": "and the Json data contains the Gateway API to query data from the cloud I mean",
    "start": "1470600",
    "end": "1476159"
  },
  {
    "text": "from the Gateway service and this is the example of the request from the cyar and it specifies",
    "start": "1476159",
    "end": "1483360"
  },
  {
    "text": "the Gateway API depending on what kind of information cyar",
    "start": "1483360",
    "end": "1488919"
  },
  {
    "text": "wants for example cyar can download partial scripts through policy request",
    "start": "1488919",
    "end": "1494039"
  },
  {
    "text": "API the following is a response of the policy request API and it contains purchas scripts in the Json data as you",
    "start": "1494039",
    "end": "1500720"
  },
  {
    "text": "can see below and as for another API called get",
    "start": "1500720",
    "end": "1506640"
  },
  {
    "text": "content info this API returns decrypt info that contains in wi file URL for",
    "start": "1506640",
    "end": "1512399"
  },
  {
    "text": "download and also a key for",
    "start": "1512399",
    "end": "1516520"
  },
  {
    "text": "decryption and once cyard receives the required information the cocar downloads the in file and decrypt it to install",
    "start": "1517640",
    "end": "1524480"
  },
  {
    "text": "them into the system by replicating cyoc car downloading",
    "start": "1524480",
    "end": "1530559"
  },
  {
    "text": "process I was able to download and decrypt the wi to apps like this so attackers can impersonate the",
    "start": "1530559",
    "end": "1538080"
  },
  {
    "text": "sidey car and they can steal your par scripts or wi apps delivered from inun",
    "start": "1538080",
    "end": "1543360"
  },
  {
    "text": "and those customers apps are always great Target for attackers since they contain they sometimes contain juicy",
    "start": "1543360",
    "end": "1549559"
  },
  {
    "text": "information such as local administrator passwords or domain even administrator",
    "start": "1549559",
    "end": "1554720"
  },
  {
    "text": "passwords so this might be stolen from this attack",
    "start": "1554720",
    "end": "1560240"
  },
  {
    "text": "so this might be sometimes hard to implement but I like you not to Del apps that contain Secrets I have I have seen",
    "start": "1560600",
    "end": "1568159"
  },
  {
    "text": "many Enterprises deliver applications with secrets and in engagement we have seen",
    "start": "1568159",
    "end": "1575440"
  },
  {
    "text": "deliv delivering apps only to a particular Dynamic device group but this could be bypassed by entirely faking in",
    "start": "1575440",
    "end": "1582600"
  },
  {
    "text": "protocol for example I have seen delivering a even service principal certificate to device whose name start",
    "start": "1582600",
    "end": "1589520"
  },
  {
    "text": "with admin and it was bypassed so you want to avoid deling apps with credentials if",
    "start": "1589520",
    "end": "1597000"
  },
  {
    "text": "possible so now let me introduce a new tool with the demo so I Implement a tool called pyune",
    "start": "1597000",
    "end": "1605080"
  },
  {
    "text": "that could execute the attack techniques I talked about in this presentation and this to can enoll a fake device with",
    "start": "1605080",
    "end": "1611600"
  },
  {
    "text": "multiplatform and talk to in like it it's real let me show you how it works",
    "start": "1611600",
    "end": "1619440"
  },
  {
    "text": "so this is the um attackers machine and I have the Pyon script right",
    "start": "1620960",
    "end": "1626960"
  },
  {
    "text": "here and I will start start attack with device called fishing by executing Lo TX",
    "start": "1627080",
    "end": "1634880"
  },
  {
    "text": "here I will specify the device registration Service as Target resource and once you execute it you get",
    "start": "1634880",
    "end": "1642399"
  },
  {
    "text": "the code to send to the victim",
    "start": "1642399",
    "end": "1647200"
  },
  {
    "text": "now here is the victim's machine and employ Z One accounts is logging into",
    "start": "1649240",
    "end": "1654520"
  },
  {
    "text": "the system and through the fishing the",
    "start": "1654520",
    "end": "1660159"
  },
  {
    "text": "victim goes to the device code authentication page like this and type the code sent by the",
    "start": "1660159",
    "end": "1668279"
  },
  {
    "text": "attacker and the victim follows the authentication",
    "start": "1670000",
    "end": "1675080"
  },
  {
    "text": "Pro and as you can see the authenication is done then once the authenication is",
    "start": "1676840",
    "end": "1682919"
  },
  {
    "text": "done the attacker receives the access token and also refresh",
    "start": "1682919",
    "end": "1689120"
  },
  {
    "text": "token and let me save the token in the variables and first with the token we",
    "start": "1692440",
    "end": "1699760"
  },
  {
    "text": "will in this attack we will register the fake device to enter ID by executing",
    "start": "1699760",
    "end": "1706559"
  },
  {
    "text": "enter join command inion",
    "start": "1706559",
    "end": "1710120"
  },
  {
    "text": "and F device is named as Windows Pon and we will provide access token and once it",
    "start": "1713000",
    "end": "1718080"
  },
  {
    "text": "executed as you can see the fake device is Enad to entro ID and also if the if it is successful",
    "start": "1718080",
    "end": "1727640"
  },
  {
    "text": "then the Pyon will receive the device certificate for enter ID but the fake device is not enroll to",
    "start": "1727640",
    "end": "1734559"
  },
  {
    "text": "in yet so we will execute the enroll in command to en our fake device to",
    "start": "1734559",
    "end": "1741679"
  },
  {
    "text": "inun and we will provide OS information and also the device name and we will provide a refresh toen acquired the",
    "start": "1741679",
    "end": "1748240"
  },
  {
    "text": "device code fishing and we will provide the enter ID's device",
    "start": "1748240",
    "end": "1753559"
  },
  {
    "text": "certificate and once you executed Pon will talk to inun and enable a device to",
    "start": "1755840",
    "end": "1761159"
  },
  {
    "text": "inun like this and once the device is enered in",
    "start": "1761159",
    "end": "1766600"
  },
  {
    "text": "chune then Pyon will receives the insurance device",
    "start": "1766600",
    "end": "1772200"
  },
  {
    "text": "certificate so since we Enad our fake device to inun we will start the check",
    "start": "1776760",
    "end": "1781880"
  },
  {
    "text": "with the device certificate through checkin command inion we will provide the engine device",
    "start": "1781880",
    "end": "1788880"
  },
  {
    "text": "certificate here and here we will provide the hardware har to Enad our",
    "start": "1788880",
    "end": "1794720"
  },
  {
    "text": "fake device as autop pirate device and once you execute it then python will",
    "start": "1794720",
    "end": "1801120"
  },
  {
    "text": "start the communication with the management",
    "start": "1801120",
    "end": "1805880"
  },
  {
    "text": "server so you can see the Pyon will correct the configuration profiles and",
    "start": "1814919",
    "end": "1822080"
  },
  {
    "text": "here you can see the bpn configurations uh derived of course this is just like",
    "start": "1822080",
    "end": "1828039"
  },
  {
    "text": "example but you can see some of the internal bpn conf configurations and also you can see",
    "start": "1828039",
    "end": "1835159"
  },
  {
    "text": "Wi-Fi settings like this and you can see the Wi-Fi password",
    "start": "1835159",
    "end": "1842480"
  },
  {
    "text": "and SS ID like",
    "start": "1842480",
    "end": "1845559"
  },
  {
    "text": "this so now let's do the checkin again",
    "start": "1848200",
    "end": "1853639"
  },
  {
    "text": "so it's done and this time we can see that the pythron is successfully",
    "start": "1865399",
    "end": "1871159"
  },
  {
    "text": "downloaded the msf file from inun you can see the MS MSI file in the",
    "start": "1871159",
    "end": "1879240"
  },
  {
    "text": "folder like this this is just a example of the M file but we have seen a lot of",
    "start": "1879240",
    "end": "1884639"
  },
  {
    "text": "Enterprises deliver install files for PPN client so this might be very useful for accessing",
    "start": "1884639",
    "end": "1891120"
  },
  {
    "text": "to the internal Network right and as you can see here we sucessfully acquir the",
    "start": "1891120",
    "end": "1897000"
  },
  {
    "text": "domain CH Pro and we can acquire the computer account name and also the computer password so with this",
    "start": "1897000",
    "end": "1904600"
  },
  {
    "text": "information we can start attacking the internal Network and active directory so finally in the demo let's",
    "start": "1904600",
    "end": "1912240"
  },
  {
    "text": "do the let's download the wi applications and also partial scripts",
    "start": "1912240",
    "end": "1918519"
  },
  {
    "text": "we can do this through the download apps commands in Python and once you executed the python",
    "start": "1918519",
    "end": "1925399"
  },
  {
    "text": "will download the partial script if there is any and this is just the example but sometimes we see the local",
    "start": "1925399",
    "end": "1934159"
  },
  {
    "text": "admin password like this and",
    "start": "1934159",
    "end": "1939360"
  },
  {
    "text": "also Pon will download the wi applications and we see several in wi",
    "start": "1939360",
    "end": "1945720"
  },
  {
    "text": "file delived to the fake",
    "start": "1945720",
    "end": "1950240"
  },
  {
    "text": "device so you can see the downloaded in file and in file is just a zip file so",
    "start": "1960240",
    "end": "1967960"
  },
  {
    "text": "you can see the original EXT file is downloaded and also we have also another",
    "start": "1967960",
    "end": "1976000"
  },
  {
    "text": "Ms engine file and we we can see the custom bch files are downloaded like",
    "start": "1976000",
    "end": "1982919"
  },
  {
    "text": "this so that is all for the demo let's move on to the",
    "start": "1982919",
    "end": "1991320"
  },
  {
    "text": "takeaways so Microsoft inun offers lots of useful features but at the same time",
    "start": "1991440",
    "end": "1997519"
  },
  {
    "text": "we have seen many opportunities for attackers and by leveraging inun attackers could break into your internet",
    "start": "1997519",
    "end": "2004000"
  },
  {
    "text": "Network and croud resources so I recommend it I recommend",
    "start": "2004000",
    "end": "2009200"
  },
  {
    "text": "to review and Harden configurations such as conal access or inance device settings so that attacks become harder",
    "start": "2009200",
    "end": "2014960"
  },
  {
    "text": "and harder so this is all for my presentation and if you have any questions I'll be around here so you can",
    "start": "2014960",
    "end": "2021840"
  },
  {
    "text": "talk to me after the session or you could you can send some DMS to Twitter or LinkedIn so that's all thank you very",
    "start": "2021840",
    "end": "2028360"
  },
  {
    "text": "much for listening",
    "start": "2028360",
    "end": "2031679"
  }
]