[
  {
    "text": "all right uh welcome to black hat everyone um this is Sean metf with beyond the MCS active directory for the",
    "start": "40",
    "end": "7080"
  },
  {
    "text": "security [Applause]",
    "start": "7080",
    "end": "17119"
  },
  {
    "text": "professional good morning black hat thank you as Chris mentioned this is",
    "start": "17119",
    "end": "23760"
  },
  {
    "text": "beyond the mcsc active directory for the security professional and I am Sean metf the founder of trar a security company",
    "start": "23760",
    "end": "30480"
  },
  {
    "text": "Microsoft certified master and active directory one of about 100 in the world and a Microsoft MVP security consultant and researcher",
    "start": "30480",
    "end": "38200"
  },
  {
    "text": "and I own and operate adc.org this is my second year speaking at black",
    "start": "38200",
    "end": "43280"
  },
  {
    "text": "hat I'm very excited to talk about ad security here so what are we going to talk about we're going to cover some key",
    "start": "43280",
    "end": "50039"
  },
  {
    "text": "ad security components of active directory that I think every security professional should know we're going to",
    "start": "50039",
    "end": "57039"
  },
  {
    "text": "then move into the most common 80 security issues that I see when I do active directory security assessments",
    "start": "57039",
    "end": "62079"
  },
  {
    "text": "for companies we're going to briefly cover what you get when you raise your domain",
    "start": "62079",
    "end": "67080"
  },
  {
    "text": "controller to the more recent version of Windows give you an overview of Windows",
    "start": "67080",
    "end": "72920"
  },
  {
    "text": "10 2016 security features and then wrap it up with the security Pros",
    "start": "72920",
    "end": "78719"
  },
  {
    "text": "checklist so there are differing views of active directory the administrator sees active directory differently than",
    "start": "78840",
    "end": "85040"
  },
  {
    "text": "the security professional who sees it differently than the attacker but none of these have a really",
    "start": "85040",
    "end": "91320"
  },
  {
    "text": "good complete picture of what ad looks like except maybe the attacker that's been on your network for eight",
    "start": "91320",
    "end": "96399"
  },
  {
    "text": "years the ad administrator an engineer their focus of active directory",
    "start": "96399",
    "end": "102159"
  },
  {
    "text": "is through their admin consoles active directory users of computers domains and Trust Group Policy sites and services",
    "start": "102159",
    "end": "110159"
  },
  {
    "text": "Powershell so they're focused on the operation and reliability and performance of active directory security",
    "start": "110159",
    "end": "116479"
  },
  {
    "text": "professional I'm sure these look familiar right you've got your tool your vulnerability Management console vent",
    "start": "116479",
    "end": "124360"
  },
  {
    "text": "viewer the attacker has a ton of different tools look very different than the others",
    "start": "124360",
    "end": "130720"
  },
  {
    "text": "right they don't necessarily care about event logging except for killing the event logs they don't really care about",
    "start": "130720",
    "end": "136760"
  },
  {
    "text": "the operational reliability of active directory other than making sure they can get access to the domain controller so we have to identify what",
    "start": "136760",
    "end": "144400"
  },
  {
    "text": "these different perspectives are and figure out the best way to identify how to protect active directory from the attacker and what they are trying to",
    "start": "144400",
    "end": "151920"
  },
  {
    "text": "do so let's talk about active directory security I don't think anyone has chucked Norris on staff so we have to do",
    "start": "151920",
    "end": "158319"
  },
  {
    "text": "the best we can to protect our environment active directory is created when the first domain controller is",
    "start": "158319",
    "end": "164480"
  },
  {
    "text": "promoted and the default configuration is well less than ideal from a security",
    "start": "164480",
    "end": "170239"
  },
  {
    "text": "perspective the standard ad configuration focuses more on the ease of operation and not much has changed in",
    "start": "170239",
    "end": "176800"
  },
  {
    "text": "the 16 years since active directory has been out this is what most people think of when",
    "start": "176800",
    "end": "182440"
  },
  {
    "text": "they think of active directory right domain ous groups",
    "start": "182440",
    "end": "187799"
  },
  {
    "text": "accounts but behind all those OS and objects there's a standard looking database ad80 is a database with tables",
    "start": "187799",
    "end": "195040"
  },
  {
    "text": "and rows much like any other this information is abstracted and",
    "start": "195040",
    "end": "200680"
  },
  {
    "text": "presented in the friendly manner we see an active director users of computers and domains and trusts and all the other admin",
    "start": "200680",
    "end": "205760"
  },
  {
    "text": "tools the ACT directory domain data is stored in this database and this ntds.dit file on all the domain",
    "start": "205760",
    "end": "212439"
  },
  {
    "text": "controllers in the domain and they replicated the database file storage user computers trust passwords all of",
    "start": "212439",
    "end": "219920"
  },
  {
    "text": "which can be extracted if the attacker gets access to this database file be it on a domain controller or elsewhere on",
    "start": "219920",
    "end": "225319"
  },
  {
    "text": "the network your active directory force is a complete instance of active directory",
    "start": "225319",
    "end": "231319"
  },
  {
    "text": "with a single schema directory configuration and Global catalog keep in mind that the forest is the security",
    "start": "231319",
    "end": "237799"
  },
  {
    "text": "boundary for active directory the ad information stays within that Forest boundary by default and all the",
    "start": "237799",
    "end": "245799"
  },
  {
    "text": "domains in the forest implicitly trust each other through automatic two-way",
    "start": "245799",
    "end": "250920"
  },
  {
    "text": "Trust of the parent and the child domain the first domain in the forest is the forest name and called the forest",
    "start": "250920",
    "end": "257239"
  },
  {
    "text": "root domain so the domain what is that the domain boundary is",
    "start": "257239",
    "end": "262680"
  },
  {
    "text": "not what you think of when you think of the forest the domain is just a partition of the forest it's a domain",
    "start": "262680",
    "end": "269680"
  },
  {
    "text": "boundary of authentication a boundary of domain level security policies a domain boundary of replication and as you can",
    "start": "269680",
    "end": "277280"
  },
  {
    "text": "see the forest is the security boundary because there's a lot of communication among the domains within that Forest I",
    "start": "277280",
    "end": "283840"
  },
  {
    "text": "think it's fairly obvious that a domain in a forest is not a security boundary but we've been treating it that way for years the domain is effectively an",
    "start": "283840",
    "end": "290720"
  },
  {
    "text": "administrative boundary does not provide isolation from malicious domain admins any domain admin",
    "start": "290720",
    "end": "298720"
  },
  {
    "text": "in any of these domains can Elevate their rights to be a forest administrator through numberous means",
    "start": "298720",
    "end": "305360"
  },
  {
    "text": "one is to link a group policy to a site that contains domain controllers from multiple domains another is to leverage",
    "start": "305360",
    "end": "312400"
  },
  {
    "text": "s history to jump from one domain to another and if you have trust you're extending that authentication boundary",
    "start": "312400",
    "end": "319919"
  },
  {
    "text": "authentication ntlm and keros version five is what's used across that trust if you create a trust make sure that you",
    "start": "319919",
    "end": "327000"
  },
  {
    "text": "check the box to enable keros a yes and trusts are automatic between domains in",
    "start": "327000",
    "end": "332800"
  },
  {
    "text": "an active directory Forest but trust can exist between a forest domains within a",
    "start": "332800",
    "end": "338039"
  },
  {
    "text": "forest or domains in different forests and it's entirely possible to exploit a trusted domain and jump the",
    "start": "338039",
    "end": "345280"
  },
  {
    "text": "trust to leverage access in fact will har jooy has covered this quite extensively at harjo",
    "start": "345280",
    "end": "351720"
  },
  {
    "text": "Donnet but let's step away from the Microsoft Graphics because what we're talking",
    "start": "351720",
    "end": "357000"
  },
  {
    "text": "about here is how this trust how domains and Forest can be exploited right so",
    "start": "357000",
    "end": "362520"
  },
  {
    "text": "let's say that an active directory force is like the ufp from Star Tre and in this analogy every Starship is a domain",
    "start": "362520",
    "end": "369680"
  },
  {
    "text": "joined to the ufp forest and the executive officers on the ship are domain admins for their ship or",
    "start": "369680",
    "end": "377280"
  },
  {
    "text": "domain and if the ship's executive officer their domain admin is compromised so is the ship their domain",
    "start": "377280",
    "end": "384440"
  },
  {
    "text": "in the case of the USS Reliant since all the federations St",
    "start": "384440",
    "end": "389560"
  },
  {
    "text": "ships are part of the forest they are all implicitly trusted so when two Starships meet it's not a problem we",
    "start": "389560",
    "end": "395440"
  },
  {
    "text": "don't raise Shields because we're all one happy Federation",
    "start": "395440",
    "end": "401160"
  },
  {
    "text": "however since they're trusted an officer on one ship can control the critical",
    "start": "401160",
    "end": "407199"
  },
  {
    "text": "systems on another like Shields and as Khan realized admins in one domain can",
    "start": "407199",
    "end": "414199"
  },
  {
    "text": "control another domain in the forest don't be like Khan so when we're talking about active",
    "start": "414199",
    "end": "421199"
  },
  {
    "text": "directory we're talking about what's on the left side traditionally our on premises active directory environment",
    "start": "421199",
    "end": "426599"
  },
  {
    "text": "which has all the goodness that we're used to for 16 years if you are moving into Office 365 or have already moved in",
    "start": "426599",
    "end": "433680"
  },
  {
    "text": "Office 365 you're looking at what's on the right Azure ad which was designed for cloud multi-tenant identity there's",
    "start": "433680",
    "end": "441520"
  },
  {
    "text": "no ntlm no keros no Group Policy just saml oaf",
    "start": "441520",
    "end": "448319"
  },
  {
    "text": "Etc but if you want all the standard ad stuff in Azure you can get that there's",
    "start": "448319",
    "end": "453960"
  },
  {
    "text": "a preview version and Microsoft will manage active directory in Azure for you",
    "start": "453960",
    "end": "459000"
  },
  {
    "text": "DC is a service if you're with Amazon same thing the simple version of samb 4 and the",
    "start": "459000",
    "end": "466280"
  },
  {
    "text": "premium version is active directory as we know it with some caveats although there's no synchronization or Federation",
    "start": "466280",
    "end": "473960"
  },
  {
    "text": "for Amazon hosted ad it's a proxy service",
    "start": "473960",
    "end": "481319"
  },
  {
    "text": "so we're talking about Cloud we're often talking about Federation you have two organizations",
    "start": "482520",
    "end": "488599"
  },
  {
    "text": "supplier and a purchaser the supplier has a web app in the cloud the purchaser",
    "start": "488599",
    "end": "493960"
  },
  {
    "text": "has their standard organization and there's a user that needs to go to that web app to purchase some products so",
    "start": "493960",
    "end": "499919"
  },
  {
    "text": "with Federation what they do is that user authenticates to their local active directory as normal and then they attempt to hit that web app they get",
    "start": "499919",
    "end": "506639"
  },
  {
    "text": "bounced back from that web app back to their Federation server on their premises which then identifies what that",
    "start": "506639",
    "end": "512599"
  },
  {
    "text": "web app is identifies and creates a token typically SLE with some attributes",
    "start": "512599",
    "end": "518360"
  },
  {
    "text": "that are useful for authenticating and identifying what access that user should have or at least from its own",
    "start": "518360",
    "end": "524959"
  },
  {
    "text": "organization then that user bounces back to that web app and provides that token which is evaluated by that web app to",
    "start": "524959",
    "end": "531560"
  },
  {
    "text": "authenticate and determine access so what does this mean traditionally we've",
    "start": "531560",
    "end": "536720"
  },
  {
    "text": "created trust we've created a lot of trust what is a",
    "start": "536720",
    "end": "541839"
  },
  {
    "text": "trust well a trust is like if I give you my car key or I give you my house key I",
    "start": "541839",
    "end": "547519"
  },
  {
    "text": "trust you I'm in Vegas I have no idea what you're doing but I trust you",
    "start": "547519",
    "end": "552839"
  },
  {
    "text": "federation's a little bit different it's more like I have a locker with a key and I put something in there and I give you",
    "start": "552839",
    "end": "557959"
  },
  {
    "text": "the key to the locker but you have no access to anything else the nice thing about Federation is",
    "start": "557959",
    "end": "563000"
  },
  {
    "text": "we don't have to open up that trust to other organizations which we may actually compete with in certain scenarios and partner with on",
    "start": "563000",
    "end": "569760"
  },
  {
    "text": "others the other nice thing about Federation is we don't have to manage and maintain all those user accounts",
    "start": "569760",
    "end": "575880"
  },
  {
    "text": "because we don't know if that user has moved on to another organization so in active directory our",
    "start": "575880",
    "end": "581000"
  },
  {
    "text": "domain controllers are critical servers we take a server we run DC promo it",
    "start": "581000",
    "end": "586279"
  },
  {
    "text": "becomes a domain controller effectively has a template nts. file then it pulls",
    "start": "586279",
    "end": "591680"
  },
  {
    "text": "replication from other domain controllers to add the domain specific information to that file and then it continues to replicate",
    "start": "591680",
    "end": "598880"
  },
  {
    "text": "with the the domain controllers in its domain information that updates on itself but it's the key authentication",
    "start": "598880",
    "end": "605640"
  },
  {
    "text": "and directory Services component server for active directory for clients and",
    "start": "605640",
    "end": "610800"
  },
  {
    "text": "applications and the security settings of the domain controller Define active directory security hosts and uh the",
    "start": "610800",
    "end": "618600"
  },
  {
    "text": "netlog share and the CIS fall share CIS fall stores group policy information netlog traditional net logon",
    "start": "618600",
    "end": "624279"
  },
  {
    "text": "traditionally stores the log on script information and you need DN ask for",
    "start": "624279",
    "end": "629440"
  },
  {
    "text": "active directory to work and most of the time you're running DNS services on active directory domain controllers and",
    "start": "629440",
    "end": "634880"
  },
  {
    "text": "if it's ad integrated where you've taken that DS DNS information and put it in active directory so it replicates that",
    "start": "634880",
    "end": "640160"
  },
  {
    "text": "way and you can update it on any domain controller typically that's ad integrated ad integrated puts that DNS",
    "start": "640160",
    "end": "647519"
  },
  {
    "text": "information in the ad and replicates it so Microsoft looked at this and they said all right we have this act",
    "start": "647519",
    "end": "653079"
  },
  {
    "text": "directory forest with multiple domains and the domain controllers in each domain only know about their own domain",
    "start": "653079",
    "end": "658600"
  },
  {
    "text": "so how do we enable an application like exchange to send email from a user in",
    "start": "658600",
    "end": "664720"
  },
  {
    "text": "one domain to another we have the gal the global address list we're used to that many most organizations have exchanged the",
    "start": "664720",
    "end": "671399"
  },
  {
    "text": "gal is effectively an abstracted version of the global catalog it's a replica of",
    "start": "671399",
    "end": "676680"
  },
  {
    "text": "all of the objects in the ACT directory Force but a very small subset of the attributes so we have all the objects",
    "start": "676680",
    "end": "682079"
  },
  {
    "text": "and some of the attributes which enables very rapid searching of objects in the",
    "start": "682079",
    "end": "687959"
  },
  {
    "text": "forest you can flip a bit on an attribute so that it will be part of the global",
    "start": "687959",
    "end": "694000"
  },
  {
    "text": "catalog but you want to make sure that as with any attribute that you understand what the what the consequences of that are because they",
    "start": "694000",
    "end": "700160"
  },
  {
    "text": "can be quickly and rapidly searched throughout any domain in the forest just by connecting to the global catalog",
    "start": "700160",
    "end": "705959"
  },
  {
    "text": "service on the DC most domain controllers are Global catalog these days in 2008 Microsoft provided readon",
    "start": "705959",
    "end": "715200"
  },
  {
    "text": "to main controllers and there was much rejoicing however readon domain controllers are not the Panacea they're",
    "start": "715200",
    "end": "721240"
  },
  {
    "text": "not a silver bullet you can't just deploy them everywhere unfortunately why is that well they're read only domain",
    "start": "721240",
    "end": "727399"
  },
  {
    "text": "controllers you can't make any changes on them it has to chain those requests or refer those requests up to a writable",
    "start": "727399",
    "end": "732920"
  },
  {
    "text": "this includes password changes so readon are not going to store",
    "start": "732920",
    "end": "737959"
  },
  {
    "text": "any passwords unless you explicitly say these users can have their passwords on this readon domain",
    "start": "737959",
    "end": "743920"
  },
  {
    "text": "controller and we can explicitly deny certain users and groups from having their password storage on the",
    "start": "743920",
    "end": "752160"
  },
  {
    "text": "readon if we want a user in a site with a readon domain controller to",
    "start": "752199",
    "end": "757240"
  },
  {
    "text": "authenticate to that readon we have to add their account to that allowed readon",
    "start": "757240",
    "end": "762440"
  },
  {
    "text": "password group because by default when that user first authenticates to a read",
    "start": "762440",
    "end": "767800"
  },
  {
    "text": "only that read only has no information of the password so it Changs that authentication request up to the writable the writable handles that",
    "start": "767800",
    "end": "774320"
  },
  {
    "text": "authentication and sends it back down so then the read only goes please send me that password so I can handle",
    "start": "774320",
    "end": "780040"
  },
  {
    "text": "that authentication myself Daddy I want to be able to do that and the writable will check if it's allowed or disallowed",
    "start": "780040",
    "end": "786600"
  },
  {
    "text": "and make a decision off of that if it's allowed the password gets replicated down to the read only but at that point",
    "start": "786600",
    "end": "792160"
  },
  {
    "text": "that user still can't authenticate to the read only unless the computer account for that user is also has its",
    "start": "792160",
    "end": "798160"
  },
  {
    "text": "password stored on the readon so a few different caveats and applications like Exchange hate readon domain controllers",
    "start": "798160",
    "end": "804760"
  },
  {
    "text": "why because it can't make changes on it the use case for readon are typically",
    "start": "804760",
    "end": "811000"
  },
  {
    "text": "when you want to put a domain controller in a place that's not physically secure not a good idea so you use a readon or",
    "start": "811000",
    "end": "817000"
  },
  {
    "text": "you have a local admin at a site not a domain admin and they need to be delegated access to that read only which",
    "start": "817000",
    "end": "822519"
  },
  {
    "text": "is fine there's several readon attributes so the first two determine",
    "start": "822519",
    "end": "829560"
  },
  {
    "text": "and control which user account passwords and computer account passwords can be replicated to that readon domain",
    "start": "829560",
    "end": "835320"
  },
  {
    "text": "controller the last two are more interesting because we we can identify who's actually authenticated to a readon",
    "start": "835320",
    "end": "841399"
  },
  {
    "text": "domain controller so that would typically be the user accounts in that site we can also identify what passwords",
    "start": "841399",
    "end": "847079"
  },
  {
    "text": "are stored on that readon domain controller so if that readon is compromised we can tell those users to",
    "start": "847079",
    "end": "852959"
  },
  {
    "text": "change your passwords and if you have custom delegation which you should custom admin",
    "start": "852959",
    "end": "858759"
  },
  {
    "text": "groups which you should and you have readon domain controllers you should add them this to this group because it prevents those passwords from being",
    "start": "858759",
    "end": "864839"
  },
  {
    "text": "stored on read read only domain controllers so DS RM directory Services",
    "start": "864839",
    "end": "870240"
  },
  {
    "text": "restore mode is the default administrator account on domain controllers it is a rid 500 account it",
    "start": "870240",
    "end": "875680"
  },
  {
    "text": "exists on every domain controller when the active directory admin DC promos up",
    "start": "875680",
    "end": "881240"
  },
  {
    "text": "a new domain controller they type in a password for the dsrm password 1 2 3 4",
    "start": "881240",
    "end": "886560"
  },
  {
    "text": "they click next next next next next I have a domain controller ticket closed I can go on to do other things problem is",
    "start": "886560",
    "end": "893240"
  },
  {
    "text": "this password rarely changes organizations few organizations actually have a process by which this",
    "start": "893240",
    "end": "900040"
  },
  {
    "text": "gets changed automatically and often times set this registry key dsrm admin log on Behavior",
    "start": "900040",
    "end": "906519"
  },
  {
    "text": "to two which means that I don't have to reboot in dsrm uh mode in order to log",
    "start": "906519",
    "end": "913120"
  },
  {
    "text": "in with this account I don't have to stop the active directory service on the domain controller to log in with it I",
    "start": "913120",
    "end": "918279"
  },
  {
    "text": "can log in over RDP so we have a local admin account on",
    "start": "918279",
    "end": "923519"
  },
  {
    "text": "the domain controller and we know that the password is typically not a great password",
    "start": "923519",
    "end": "929120"
  },
  {
    "text": "and if we set that Reg registry key it is possible to actually pass the hash",
    "start": "929120",
    "end": "934279"
  },
  {
    "text": "using that account if we can guess what that dsrm account password is or if we",
    "start": "934279",
    "end": "940360"
  },
  {
    "text": "discover knowledge of that password this is beautiful persistence if I'm an attacker and I've been on your",
    "start": "940360",
    "end": "946800"
  },
  {
    "text": "network and you changed every other password and you forgot about dsrm because I can pass the hash I can",
    "start": "946800",
    "end": "953160"
  },
  {
    "text": "connect to the C dollar I can run DC sync from mimik cats using this local admin account on the domain",
    "start": "953160",
    "end": "959959"
  },
  {
    "text": "controller so please make sure that you have a process to change your dsrm account passwords but how do clients find their",
    "start": "959959",
    "end": "966959"
  },
  {
    "text": "domain controllers well we have our network devices that have subnets so we",
    "start": "966959",
    "end": "972279"
  },
  {
    "text": "want to take that information and put it in actual directory with an active directory subnet we're going to associate that with a site this is how",
    "start": "972279",
    "end": "978720"
  },
  {
    "text": "active directory knows where things are in the real world so when a client starts up for the",
    "start": "978720",
    "end": "985079"
  },
  {
    "text": "first time it's going to query DNS and go what are the domain controllers in this environment in this domain tell me",
    "start": "985079",
    "end": "990519"
  },
  {
    "text": "who they are and it's going to get a list and it's going to ultimately pick one of them and then say what's my site",
    "start": "990519",
    "end": "996720"
  },
  {
    "text": "and the domain controller is going to look at that client IP address figure out what subnet It's associated with",
    "start": "996720",
    "end": "1002120"
  },
  {
    "text": "figure out what site that's associated with and then say you're in site Las Vegas but what happens if that client IP",
    "start": "1002120",
    "end": "1011000"
  },
  {
    "text": "information does not map to a subnet and AD the client says DC what side am I in",
    "start": "1011000",
    "end": "1018480"
  },
  {
    "text": "DC says I don't know don't bother me talk to someone else client tries again what side am I in DC over here I don't",
    "start": "1018480",
    "end": "1024798"
  },
  {
    "text": "know try again this happen several times and eventually the client goes you know what I'm tired of getting brushed off by",
    "start": "1024799",
    "end": "1030160"
  },
  {
    "text": "the domain controllers I'm going to pick one and Murphy's law says that its client is going to pick a domain",
    "start": "1030160",
    "end": "1035319"
  },
  {
    "text": "controller in London when we're in Las Vegas so what kind of impact does that have well obviously it's a performance",
    "start": "1035319",
    "end": "1040600"
  },
  {
    "text": "impact on the user and they may connect to DFS shares that are in London as well but if we're trying to track user",
    "start": "1040600",
    "end": "1048079"
  },
  {
    "text": "activity through our Sim tool we're typically going to Target domain controllers that are local to that user since we don't",
    "start": "1048079",
    "end": "1054919"
  },
  {
    "text": "want to search the whole thing because that's going to take a lot of time especially if we have a large number of domain controllers but if this user is",
    "start": "1054919",
    "end": "1060640"
  },
  {
    "text": "now connecting to a DC in London we're not going to see that activity until we expand our search to be to include all",
    "start": "1060640",
    "end": "1066640"
  },
  {
    "text": "of the domain controllers but when we talk about active directory we're usually talking",
    "start": "1066640",
    "end": "1072120"
  },
  {
    "text": "about objects in their properties users groups computers and there's some interesting",
    "start": "1072120",
    "end": "1078120"
  },
  {
    "text": "things that can be in these attributes like passwords or social security",
    "start": "1078120",
    "end": "1084720"
  },
  {
    "text": "numbers there are attributes that are protected from regular users on the network viewing them it's called a",
    "start": "1084720",
    "end": "1090840"
  },
  {
    "text": "confidential attribute if you need to put soci Security numbers into your active directory not that I'm recommending that but if you need to do",
    "start": "1090840",
    "end": "1097000"
  },
  {
    "text": "it that's the way to do it because by default only domain admins have access to this and the extension attributes often",
    "start": "1097000",
    "end": "1103240"
  },
  {
    "text": "have some interesting information so you want to check that there's another attribute I want to call out it history",
    "start": "1103240",
    "end": "1109880"
  },
  {
    "text": "so this is for migration scenarios you have an old domain with an old user account new domain new user account you",
    "start": "1109880",
    "end": "1116799"
  },
  {
    "text": "copy the old user Sid you put it into the new user Sid history attribute and when that new user logs on their token",
    "start": "1116799",
    "end": "1123799"
  },
  {
    "text": "contains all their SIDS including the SIDS that are contained in Sid history it's effectively cloning the access of",
    "start": "1123799",
    "end": "1129400"
  },
  {
    "text": "the old user this works for users within the same domain as well as throughout",
    "start": "1129400",
    "end": "1135200"
  },
  {
    "text": "the forest and across trust Sid filtering is not enabled and you can easily get a report of your",
    "start": "1135200",
    "end": "1141480"
  },
  {
    "text": "users and their attributes by using the active directory Powershell module I highly recommend this and I've called out specific attributes that I typically",
    "start": "1141480",
    "end": "1147720"
  },
  {
    "text": "look at last log on date when did they last log on password last set when did they change their password admin count",
    "start": "1147720",
    "end": "1154520"
  },
  {
    "text": "if it's set to one they could be a domain admin we'll cover that in a bit Sid history custom attributes service",
    "start": "1154520",
    "end": "1161120"
  },
  {
    "text": "principal name so if you run this and you find data in this service principal name attribute this is a service account",
    "start": "1161120",
    "end": "1168280"
  },
  {
    "text": "for keros same thing with computers my favorite sort of Look At",
    "start": "1168280",
    "end": "1173600"
  },
  {
    "text": "Last log on date which is the last time the computer rebooted most cases Windows specific the password last set so by",
    "start": "1173600",
    "end": "1181559"
  },
  {
    "text": "default Windows computers change your passwords about 30 days it's a guideline not a",
    "start": "1181559",
    "end": "1187640"
  },
  {
    "text": "rule so if you have a computer or computers that haven't updated their",
    "start": "1187640",
    "end": "1193240"
  },
  {
    "text": "passwords in 60 or 90 or 120 days they're probably offline but a more interesting scenario is if you have a",
    "start": "1193240",
    "end": "1199679"
  },
  {
    "text": "last log on date which is 180 days and the password last set date is within 60",
    "start": "1199679",
    "end": "1205080"
  },
  {
    "text": "days that means you have a computer that's active in online but it's not getting rebooted for patches we can also identify operating",
    "start": "1205080",
    "end": "1212240"
  },
  {
    "text": "systems so you can find what operating systems are in your active directory including wind uh non- Windows devices such as Linux and mac and storage",
    "start": "1212240",
    "end": "1219520"
  },
  {
    "text": "devices like net apppp service principal names this the keros Enterprise services that are on",
    "start": "1219520",
    "end": "1225600"
  },
  {
    "text": "there and then any delegation that those computer accounts have group policy is",
    "start": "1225600",
    "end": "1232039"
  },
  {
    "text": "very popular in most organizations because it's a click click click finish approach to getting standardized user",
    "start": "1232039",
    "end": "1238840"
  },
  {
    "text": "and computer security settings and policies to find we create a group policy we configure the settings when we",
    "start": "1238840",
    "end": "1244679"
  },
  {
    "text": "link it to an OU so when a computer boots up for the first time it's going to query act a",
    "start": "1244679",
    "end": "1250760"
  },
  {
    "text": "directory for its OU location for its Associated computer account in ad it's going to find the group policies that",
    "start": "1250760",
    "end": "1257080"
  },
  {
    "text": "apply to it through that OU location and it's going to look in that group policy",
    "start": "1257080",
    "end": "1262799"
  },
  {
    "text": "object for a link to the CIS fall location where those settings files are the group policy template and copy those",
    "start": "1262799",
    "end": "1269159"
  },
  {
    "text": "down from cisv fall and then the client component of group policy is actually going to apply that same thing happens",
    "start": "1269159",
    "end": "1275440"
  },
  {
    "text": "with the user the user logs on the computer is looking for that user's OU identifies the group policies looks to",
    "start": "1275440",
    "end": "1282240"
  },
  {
    "text": "CIS fall pulls that down applies it to the user so there's an issue there because",
    "start": "1282240",
    "end": "1288400"
  },
  {
    "text": "if we can insert ourself into that process where the computer is pulling",
    "start": "1288400",
    "end": "1293520"
  },
  {
    "text": "the settings files to actually apply the group policy settings then we can have the computer apply things that are a",
    "start": "1293520",
    "end": "1301080"
  },
  {
    "text": "little less altruistic so last year there were two vulnerabilities that were patched by Microsoft that were effectively man-",
    "start": "1301080",
    "end": "1307480"
  },
  {
    "text": "in-the middle for group policy 04 could reset Group Policy",
    "start": "1307480",
    "end": "1313760"
  },
  {
    "text": "configuration on a system to nothing 01 you could actually have group policy",
    "start": "1313760",
    "end": "1320000"
  },
  {
    "text": "clients connect to your machine your attacker machine CIS fall share instead of the domain controllers you hopefully",
    "start": "1320000",
    "end": "1326320"
  },
  {
    "text": "have applied all of these and if you have I highly recommend that you check to make sure that you have enabled UNCC",
    "start": "1326320",
    "end": "1331400"
  },
  {
    "text": "hardening because if you have not you have not fully made mitigated Ms 1511 the other part of this is if I as",
    "start": "1331400",
    "end": "1338600"
  },
  {
    "text": "an attacker can modify the group policy object in act a directory or if I can modify the group policy template in CIS",
    "start": "1338600",
    "end": "1344400"
  },
  {
    "text": "fall I can also take over your computers because I can change the way that they process and the information that they",
    "start": "1344400",
    "end": "1350360"
  },
  {
    "text": "actually apply so let's talk about authentication for a minute because that's kind of key",
    "start": "1350360",
    "end": "1355840"
  },
  {
    "text": "to how active directory works and I love Bane so",
    "start": "1355840",
    "end": "1361840"
  },
  {
    "text": "ntlm been around forever right the bane of our existence as",
    "start": "1361840",
    "end": "1366880"
  },
  {
    "text": "admins I had to work that in somehow you have a user authenticates their password",
    "start": "1366880",
    "end": "1372919"
  },
  {
    "text": "is converted to an ntlm password hash they want to connect to the server say server I want to connect to the service",
    "start": "1372919",
    "end": "1378520"
  },
  {
    "text": "the server sends a challenge the user takes this challenge encrypts it with its password hash sends it back to the server server goes I don't know what to",
    "start": "1378520",
    "end": "1385279"
  },
  {
    "text": "do with this sends it to the main controller and says hey DC I've got this user named this I've got I sent him this",
    "start": "1385279",
    "end": "1391600"
  },
  {
    "text": "challenge I got this challenge response what's up are they a real user is this",
    "start": "1391600",
    "end": "1397279"
  },
  {
    "text": "the right person the main controller says okay hold on I'm busy I'll take care of that looks up the user finds",
    "start": "1397279",
    "end": "1402880"
  },
  {
    "text": "their password hash takes the Challenge from the server encrypts the challenge with the user's password hash and",
    "start": "1402880",
    "end": "1408679"
  },
  {
    "text": "Compares that value to the challenge response I got from the server they match the demain controller says yep",
    "start": "1408679",
    "end": "1414880"
  },
  {
    "text": "we're good go ahead that user's fine there are several problems with the way ntlm works it's an older protocol",
    "start": "1414880",
    "end": "1422240"
  },
  {
    "text": "and there's a ton of attacks that have been covered many many times if you're not familiar with this I highly recommend you look them up many of them",
    "start": "1422240",
    "end": "1429360"
  },
  {
    "text": "involve man- in the- Middle because someone can insert themselves between the server and the client and man in the",
    "start": "1429360",
    "end": "1435200"
  },
  {
    "text": "middle of that communication and steal credentials or they can wait for a client to broadcast and go yep that's me",
    "start": "1435200",
    "end": "1441760"
  },
  {
    "text": "I'm the server and inject itself into that process that way and of course we know",
    "start": "1441760",
    "end": "1447320"
  },
  {
    "text": "pass the hash is an issue because if an attacker can get access to the user's hash they can impersonate that user",
    "start": "1447320",
    "end": "1453520"
  },
  {
    "text": "until that user changes its password so Microsoft says applications are",
    "start": "1453520",
    "end": "1458679"
  },
  {
    "text": "generally advised not to use ntlm because it does not use recent strong",
    "start": "1458679",
    "end": "1463840"
  },
  {
    "text": "cryptographic implementations like AES and sha 256 so we've got cerberos right so the user",
    "start": "1463840",
    "end": "1471919"
  },
  {
    "text": "authenticates to the domain controller proves identity says I need a TGT a ticket granting ticket authentication",
    "start": "1471919",
    "end": "1477320"
  },
  {
    "text": "ticket the domain controller looks up the user's group membership information looks up their restrictions writes that",
    "start": "1477320",
    "end": "1483799"
  },
  {
    "text": "into the ticket encrypts it signs it and encrypts it using the curb TGT domain keros account sends it back to the user",
    "start": "1483799",
    "end": "1491200"
  },
  {
    "text": "says I'm done with you the user wants to connect to this application server so it",
    "start": "1491200",
    "end": "1497000"
  },
  {
    "text": "identifies what the service principal name is for the Cerro service on that server then goes to a domain controller",
    "start": "1497000",
    "end": "1503120"
  },
  {
    "text": "same one or different one says here's my TGT and here's the service principal name of the server I want to access I",
    "start": "1503120",
    "end": "1509080"
  },
  {
    "text": "need a TGs ticket granting service or service ticket the domain controller takes that service principal name looks",
    "start": "1509080",
    "end": "1515720"
  },
  {
    "text": "it up in active directory and identifies what account what service account is associated with that service principal",
    "start": "1515720",
    "end": "1522559"
  },
  {
    "text": "name and takes copies the information from that TGT actively puts it into a",
    "start": "1522559",
    "end": "1529240"
  },
  {
    "text": "new ticket called a TGs and encrypts it with that service account password hash sends it back to the user user says okay",
    "start": "1529240",
    "end": "1535440"
  },
  {
    "text": "great sends it over to the application server the application server opens up that ticket looks at the group membership says okay you're good come on",
    "start": "1535440",
    "end": "1542679"
  },
  {
    "text": "in sometimes that application server will actually validate that that group membership data is is correct in that",
    "start": "1542679",
    "end": "1549080"
  },
  {
    "text": "ticket through pack validation and sometimes the computer",
    "start": "1549080",
    "end": "1556320"
  },
  {
    "text": "the user is on will mutually authenticate that connection to that application server but there's some",
    "start": "1556320",
    "end": "1562120"
  },
  {
    "text": "issues with curos as well originally replay attack then pass the ticket being able to take a ticket reuse it overpass",
    "start": "1562120",
    "end": "1569360"
  },
  {
    "text": "a ticket take an nlm password hash use that to get a new krose ticket to impersonate that user offline password",
    "start": "1569360",
    "end": "1576159"
  },
  {
    "text": "cracking of the TGs forging tickets golden silver Etc",
    "start": "1576159",
    "end": "1582039"
  },
  {
    "text": "but let's talk about ms14 on ms1 14068 for a minute this has been out for",
    "start": "1582039",
    "end": "1587679"
  },
  {
    "text": "almost two years the patch for this major vulnerability with Microsoft keros but I still find organizations that are",
    "start": "1587679",
    "end": "1593640"
  },
  {
    "text": "not patched with this this is a big deal because the domain controller does not",
    "start": "1593640",
    "end": "1599320"
  },
  {
    "text": "properly validate the pack check sum which means a regular user could change",
    "start": "1599320",
    "end": "1604480"
  },
  {
    "text": "their cerbos ticket to say they're a domain admin this is much like you go to the airport you have your boarding pass",
    "start": "1604480",
    "end": "1610200"
  },
  {
    "text": "and you write pilot on it you hand it over to the flight attendant you get escorted to the cockpit it is that bad",
    "start": "1610200",
    "end": "1615679"
  },
  {
    "text": "so please please please make sure that before you run DC promo or before your admins run DC promo that they're",
    "start": "1615679",
    "end": "1621679"
  },
  {
    "text": "making sure that all of the patches are applied on your member servers so there's a number of",
    "start": "1621679",
    "end": "1627520"
  },
  {
    "text": "weaknesses with ntlm and Kerberos involving encryption involving not having Mutual",
    "start": "1627520",
    "end": "1634440"
  },
  {
    "text": "authentication the keros side of things if it's using rc4 encryption then it's using the ntlm password hash to encrypt",
    "start": "1634440",
    "end": "1641080"
  },
  {
    "text": "that ticket and if we can steal the credential information we can reuse it with either of these pretty much",
    "start": "1641080",
    "end": "1646840"
  },
  {
    "text": "anywhere on the in the environment on the network so Microsoft said okay we have a problem we know we've been using",
    "start": "1646840",
    "end": "1652240"
  },
  {
    "text": "protocols from 30 or 40 years ago so let's update it to Microsoft passport passport is a two-factor authentication",
    "start": "1652240",
    "end": "1658720"
  },
  {
    "text": "system that combines a pin with encrypted keys from a user's device to provide two-factor authentication all",
    "start": "1658720",
    "end": "1664720"
  },
  {
    "text": "right that's a lot what does that actually mean well it's still in beta when 2016 comes out in September we'll",
    "start": "1664720",
    "end": "1670360"
  },
  {
    "text": "have a much better idea of how this works but broad Strokes are on a Windows 10 device we have a TPM chip that",
    "start": "1670360",
    "end": "1676880"
  },
  {
    "text": "generates the user public private key pair specific to that device for that user and the public key is added to the",
    "start": "1676880",
    "end": "1684519"
  },
  {
    "text": "user's attribute in active directory the user's device specific",
    "start": "1684519",
    "end": "1690039"
  },
  {
    "text": "Secrets associated with that credential are stored in vssm the secure world that lock boox in Windows 10 where even if",
    "start": "1690039",
    "end": "1698080"
  },
  {
    "text": "you compromise Windows 10's kernel you can't easily get access to it and the",
    "start": "1698080",
    "end": "1703399"
  },
  {
    "text": "Machine data and the user credential information are combined and sent to the domain control for the user TGT that",
    "start": "1703399",
    "end": "1709039"
  },
  {
    "text": "ticket granting ticket or authentication ticket and since credential guard owns the system private",
    "start": "1709039",
    "end": "1714799"
  },
  {
    "text": "key to get that TGT if you turn off credential guard this whole process doesn't work so Microsoft has really",
    "start": "1714799",
    "end": "1721440"
  },
  {
    "text": "thought through this and again when this comes out in a few months we'll get a much better idea what this looks like",
    "start": "1721440",
    "end": "1726519"
  },
  {
    "text": "but if you want to roll it out in a few months there's some requirements which may get updated in September the key",
    "start": "1726519",
    "end": "1731919"
  },
  {
    "text": "here is you're going to have to deploy some 2016 infrastructure which makes a lot of sense and if you have key based",
    "start": "1731919",
    "end": "1737000"
  },
  {
    "text": "or p passord based authentication you're going to have to deploy some 2016",
    "start": "1737000",
    "end": "1742600"
  },
  {
    "text": "DCs so now the fun stuff the most common ad security issues",
    "start": "1743279",
    "end": "1749159"
  },
  {
    "text": "as I've seen them in active directory security assessments and as I've heard from other people in the security industry a lot of organizations still",
    "start": "1749159",
    "end": "1756200"
  },
  {
    "text": "have multiple domains in a forest because they thought that was the right way to do things and to be fair",
    "start": "1756200",
    "end": "1761440"
  },
  {
    "text": "originally when ad came out that seemed to be the way to do it we have relived since then it's not",
    "start": "1761440",
    "end": "1767840"
  },
  {
    "text": "these older forests have multiple domains for security we can't really trust this environment or we have different business divisions that don't",
    "start": "1767840",
    "end": "1775200"
  },
  {
    "text": "really trust or like each other so we put them in separate domains and the problems solve but then if we have trust",
    "start": "1775200",
    "end": "1780919"
  },
  {
    "text": "outside of those those extend the boundary and may introduce exploit paths if you are running under the",
    "start": "1780919",
    "end": "1787919"
  },
  {
    "text": "default settings which means that you don't have policies that are applied to your de domain controllers or workstations or servers you're running",
    "start": "1787919",
    "end": "1794559"
  },
  {
    "text": "at the lowest common denominator in the world I recommend you don't do that",
    "start": "1794559",
    "end": "1800240"
  },
  {
    "text": "domain controllers need these security policies because your active directory securi Baseline is based off of your",
    "start": "1800240",
    "end": "1805760"
  },
  {
    "text": "domain controller security posture and if you're not if you haven't config enhanced auditing or subcategory",
    "start": "1805760",
    "end": "1814240"
  },
  {
    "text": "auditing you really want to do that at least on your domain controllers if not on everything because it goes from nine",
    "start": "1814240",
    "end": "1820679"
  },
  {
    "text": "categories of auditing to 53 categories of auditing and you'll get a lot more granular information about what's going",
    "start": "1820679",
    "end": "1826640"
  },
  {
    "text": "on in your envir you can run this audit Paul command to get good information about how auditing",
    "start": "1826640",
    "end": "1832320"
  },
  {
    "text": "is configured on that system one caveat here if you think you've enabled subcategory auditing but",
    "start": "1832320",
    "end": "1840080"
  },
  {
    "text": "you have standard auditing already configured in your environment and you haven't checked the box and group policy",
    "start": "1840080",
    "end": "1845240"
  },
  {
    "text": "that says override the setting to use subcategory auditing you're still using the standard auditing and only getting",
    "start": "1845240",
    "end": "1851440"
  },
  {
    "text": "those nine categories unpatch systems attackers are",
    "start": "1851440",
    "end": "1856480"
  },
  {
    "text": "not often using zero days not all the time and we know that if we haven't",
    "start": "1856480",
    "end": "1864000"
  },
  {
    "text": "patched our environment properly there's privilege escalations that are local or",
    "start": "1864000",
    "end": "1869760"
  },
  {
    "text": "rcees these are Big deals we'll patch the rcees very very quickly right but we",
    "start": "1869760",
    "end": "1875279"
  },
  {
    "text": "may not work on a local privilege escalation but we want to make sure we deploy those patches to our end points",
    "start": "1875279",
    "end": "1880880"
  },
  {
    "text": "we want to make sure dcar patch as rapidly as possible and preferably with a patching system separate than the rest",
    "start": "1880880",
    "end": "1886559"
  },
  {
    "text": "of our organiz running old and unsupported operating",
    "start": "1886559",
    "end": "1892919"
  },
  {
    "text": "systems can leave you open to a lot of vulnerabilities unless you're paying Microsoft and writing them a huge check",
    "start": "1892919",
    "end": "1899960"
  },
  {
    "text": "every I don't know every month now every year you're not getting patches for 2003 and there's some things that",
    "start": "1899960",
    "end": "1905960"
  },
  {
    "text": "architecturally Microsoft cannot patch in 2003 in Windows XP so you need to isolate those systems if you cannot get",
    "start": "1905960",
    "end": "1912159"
  },
  {
    "text": "them up to a newer version of the operating system if your DCS aren't running to",
    "start": "1912159",
    "end": "1917320"
  },
  {
    "text": "2008 you don't have Dez Kerberos encryption I'm sorry you have you have Dez Kerberos encryption you don't have",
    "start": "1917320",
    "end": "1923440"
  },
  {
    "text": "AES keros encryption you can't trust or expect a",
    "start": "1923440",
    "end": "1928960"
  },
  {
    "text": "10-year-old operating system to protect itself from a one-year-old",
    "start": "1928960",
    "end": "1934840"
  },
  {
    "text": "exploit so we mentioned dsrm we need to make sure that these",
    "start": "1934840",
    "end": "1940320"
  },
  {
    "text": "dsrm passwords get updated regularly and automatically the simple way to do that is to create a user account in active",
    "start": "1940320",
    "end": "1946039"
  },
  {
    "text": "directory and tell all our domain controllers to sync with that account every so often and have that password",
    "start": "1946039",
    "end": "1951360"
  },
  {
    "text": "update on a regular basis so over permission accounts we all have them right it's kind of like the",
    "start": "1951360",
    "end": "1957120"
  },
  {
    "text": "Dirty Little Secret of every Network we have service accounts and domain admins or with rights that they don't need or",
    "start": "1957120",
    "end": "1962360"
  },
  {
    "text": "more highly privileged that they should be we've got accounts and admin groups just because managers have accounts and",
    "start": "1962360",
    "end": "1968639"
  },
  {
    "text": "domain admins or admin groups why because if all of my Consultants all of my admins are not here I need to be able",
    "start": "1968639",
    "end": "1975519"
  },
  {
    "text": "to fix it well that's what a safe safest for sorry managers you should not have domain admin in your",
    "start": "1975519",
    "end": "1982440"
  },
  {
    "text": "environment user accounts in admin groups by mistake by group nesting or",
    "start": "1982480",
    "end": "1989639"
  },
  {
    "text": "just because it's easier computer accounts in admin groups so if you put a computer account in an",
    "start": "1989639",
    "end": "1995760"
  },
  {
    "text": "admin group and that computer account gets compromised then that attacker has the",
    "start": "1995760",
    "end": "2001440"
  },
  {
    "text": "same rights as that admin group but groups within groups within groups within groups is the reason why",
    "start": "2001440",
    "end": "2007559"
  },
  {
    "text": "we have an issue or at least part of the reason so how many domain admins do you have in your environment probably",
    "start": "2007559",
    "end": "2013760"
  },
  {
    "text": "thinking of a number hopefully it's less than 50 200 that's too",
    "start": "2013760",
    "end": "2019960"
  },
  {
    "text": "high how many domain administrators that administrators group in the domain what",
    "start": "2019960",
    "end": "2025039"
  },
  {
    "text": "about Enterprise admins what about accounts with delegated domain admin",
    "start": "2025039",
    "end": "2032799"
  },
  {
    "text": "rights are you sure you really want to know what your admins are who your admins are and where",
    "start": "2034120",
    "end": "2040600"
  },
  {
    "text": "they are because we have situations like this all the time we have Ada admins which is in domain admins which has",
    "start": "2040600",
    "end": "2046279"
  },
  {
    "text": "critical server admins and Ada admins which has server admins I don't know who",
    "start": "2046279",
    "end": "2051398"
  },
  {
    "text": "put server admins and critical server admins but yeah sure whatever and then before you know it Wesley is a domain",
    "start": "2051399",
    "end": "2057358"
  },
  {
    "text": "admin or you have someone else that's a domain admin they don't know they're a domain admin and they never should have been a domain",
    "start": "2057359",
    "end": "2063200"
  },
  {
    "text": "admin so what groups have 0 admin rights there's three right domain admins",
    "start": "2063200",
    "end": "2068398"
  },
  {
    "text": "Enterprise admins domain administrators three no more than three oh wait sorry four four groups that have ad0 admin",
    "start": "2068399",
    "end": "2075760"
  },
  {
    "text": "rights because there's custom delegation at the Domain or the OU level which gives them rights yes okay so",
    "start": "2075760",
    "end": "2081440"
  },
  {
    "text": "four five five groups with ad80 admin rights the groups that have the ability",
    "start": "2081440",
    "end": "2088240"
  },
  {
    "text": "to log on your domain controllers are effectively 0 admins also what are they well account operators if you're using",
    "start": "2088240",
    "end": "2095280"
  },
  {
    "text": "account operators to provide delegation to your help desk admins by adding help desk into account operators it's not a",
    "start": "2095280",
    "end": "2102520"
  },
  {
    "text": "good way to do it because account operators is way over privileged now these are default rights so you can",
    "start": "2102520",
    "end": "2108079"
  },
  {
    "text": "actually change this and remove account operators which should be a good start but the rest of them backup operators",
    "start": "2108079",
    "end": "2113800"
  },
  {
    "text": "print operators server operators can log on to your DCS remote desktop users can RDP to your DCS doesn't mean that they",
    "start": "2113800",
    "end": "2120320"
  },
  {
    "text": "can actually get into it but I don't think these are properly named so let's rename them okay DC backup operators DC",
    "start": "2120320",
    "end": "2128960"
  },
  {
    "text": "print operators DC remote desktop users and DC server operators because these",
    "start": "2128960",
    "end": "2134200"
  },
  {
    "text": "are specific to The Domain controllers but I see a lot of environments that are like oh look it's remote desktop users",
    "start": "2134200",
    "end": "2139880"
  },
  {
    "text": "let's add domain users to that that sounds like a good idea we have credentials in cisa files",
    "start": "2139880",
    "end": "2145480"
  },
  {
    "text": "with passwords we have scripts with passwords we have group policy preferences with credentials you have an",
    "start": "2145480",
    "end": "2151240"
  },
  {
    "text": "XML file in CIS ball and you see a c password attribute with all that goly g",
    "start": "2151240",
    "end": "2157319"
  },
  {
    "text": "that's a password it can be decrypted and the credentials can be stolen custom Group Policy object",
    "start": "2157319",
    "end": "2165480"
  },
  {
    "text": "delegation if you've delegated Group Policy object creation to a group or",
    "start": "2165480",
    "end": "2171000"
  },
  {
    "text": "user and that user creates a great group policy called Full auditing who doesn't love full auditing well maybe the people",
    "start": "2171000",
    "end": "2177319"
  },
  {
    "text": "that have to manage your Splunk instance but n forget about that so full auditing sounds great so domain admin says I like",
    "start": "2177319",
    "end": "2183520"
  },
  {
    "text": "this group policy I'm going to link it to the domain that way system gets full auditing we're good the problem is they",
    "start": "2183520",
    "end": "2190599"
  },
  {
    "text": "have just potentially compromised their entire active directory environment by doing that because they did not remove",
    "start": "2190599",
    "end": "2196440"
  },
  {
    "text": "that user from having modify rights on that group policy group policies can do just about anything I can add admin add",
    "start": "2196440",
    "end": "2204200"
  },
  {
    "text": "I can add local administrator accounts I can modify the security I can run scripts I can deploy",
    "start": "2204200",
    "end": "2211720"
  },
  {
    "text": "malware if I want to so one of the things you want to check is look at all your group Poli policies look at the",
    "start": "2211720",
    "end": "2217720"
  },
  {
    "text": "delegation identify who has modify rights they're not a domain admin you really need to scrutinize where that",
    "start": "2217720",
    "end": "2223839"
  },
  {
    "text": "group policy is linked in what it can do custom domain and OU delegation this",
    "start": "2223839",
    "end": "2228920"
  },
  {
    "text": "is a very tough thing to do I'm not up here to tell you this is an easy thing but this is the one that will bite most",
    "start": "2228920",
    "end": "2235079"
  },
  {
    "text": "organizations in the butt time and time again why because let's say you hire a domain admin he's a nice guy but just",
    "start": "2235079",
    "end": "2242960"
  },
  {
    "text": "not up to the tasks been on board for three months he had a project he worked on he left he made a mistake he added",
    "start": "2242960",
    "end": "2249800"
  },
  {
    "text": "something to the noou delegation he shouldn't have who caught it nobody caught it looking at this it's difficult",
    "start": "2249800",
    "end": "2256640"
  },
  {
    "text": "this is what it looks like when you're looking at an ACL on an active directory object I'll help you out he added domain",
    "start": "2256640",
    "end": "2263480"
  },
  {
    "text": "computers to this OU to have full control for this object and all",
    "start": "2263480",
    "end": "2268720"
  },
  {
    "text": "subobjects so he basically just said you know what all of my domain computers are now OU admins they have all rights",
    "start": "2268720",
    "end": "2274160"
  },
  {
    "text": "inside this OU I don't know why okay this means that an attacker just",
    "start": "2274160",
    "end": "2279880"
  },
  {
    "text": "needs to compromise one computer in this environment just one and get system rights on it and once they have system",
    "start": "2279880",
    "end": "2287280"
  },
  {
    "text": "rights they own the computer account in ad and have these rights on this OU",
    "start": "2287280",
    "end": "2292920"
  },
  {
    "text": "which is full so will har jooy wrote a great Powershell module called Power viiew",
    "start": "2292920",
    "end": "2299599"
  },
  {
    "text": "which has a lot of great functionality for red team but also for blue team members and one of the function is called functions is called invoke ACL",
    "start": "2299599",
    "end": "2306119"
  },
  {
    "text": "scanner where you can scan your domain looking for custom permissions in your",
    "start": "2306119",
    "end": "2311920"
  },
  {
    "text": "environment I'm actually going to be working with hit will to update powerview in the next few months so that way we can have some templates for blue",
    "start": "2311920",
    "end": "2317800"
  },
  {
    "text": "team members so you can just run some very easy commands and get a good idea of what you have delegate in your",
    "start": "2317800",
    "end": "2324520"
  },
  {
    "text": "environment so I mentioned admin count equals one earlier so the admin SD",
    "start": "2324520",
    "end": "2330160"
  },
  {
    "text": "holder object is a system object that hosts permissions just a template of",
    "start": "2330160",
    "end": "2335400"
  },
  {
    "text": "permissions for highly protected and highly privileged groups and accounts in active directory they look like these",
    "start": "2335400",
    "end": "2342400"
  },
  {
    "text": "and every 60 Minutes the PDC emulator has a process that runs that enumerates the membership of all these groups takes",
    "start": "2342400",
    "end": "2350040"
  },
  {
    "text": "all of the objects stamps them with the permissions from the admin SD holder",
    "start": "2350040",
    "end": "2355839"
  },
  {
    "text": "object and removes security inheritance so they don't get overwritten sets admin count to one it doesn't go back and",
    "start": "2355839",
    "end": "2362119"
  },
  {
    "text": "clear it out so this means admin count equals one is going to be on these these uh objects so if you've set a custom group",
    "start": "2362119",
    "end": "2370079"
  },
  {
    "text": "or user on admin estd holder about 60 minutes later your domain admins group",
    "start": "2370079",
    "end": "2377040"
  },
  {
    "text": "is going to have these permissions on it and you won't be able to override this so you want to check your admin SD",
    "start": "2377040",
    "end": "2382200"
  },
  {
    "text": "holder object and scrutinize the membership and custom permissions so active directory security",
    "start": "2382200",
    "end": "2388240"
  },
  {
    "text": "enhancements by operating system so with 2008 domain controllers we get keros AES",
    "start": "2388240",
    "end": "2394119"
  },
  {
    "text": "and we get fine grain password policy fine grain password policy lets us override the default domain password",
    "start": "2394119",
    "end": "2401160"
  },
  {
    "text": "policy which means that for our admins and our service accounts we can have more stringent controls over them we can",
    "start": "2401160",
    "end": "2407400"
  },
  {
    "text": "say they have to use longer passwords we can also support Legacy users that uh",
    "start": "2407400",
    "end": "2413839"
  },
  {
    "text": "say they need to support a main main uh Mainframe environment so they may need an eight character password hopefully",
    "start": "2413839",
    "end": "2420200"
  },
  {
    "text": "not we have managed service accounts where active directory manages the password for those accounts",
    "start": "2420200",
    "end": "2426440"
  },
  {
    "text": "authentication mechanism Assurance where active directory tracks if a user authenticates using a smart card or a",
    "start": "2426440",
    "end": "2432480"
  },
  {
    "text": "password and my favorite is the ability to audit ntlm authentication I highly",
    "start": "2432480",
    "end": "2437680"
  },
  {
    "text": "recommend you enable this you get a really good understanding of where and",
    "start": "2437680",
    "end": "2442760"
  },
  {
    "text": "what and how ntlm is used in your environment you can also restrict ntlm",
    "start": "2442760",
    "end": "2448119"
  },
  {
    "text": "which is the next step say no ntlm authentication except for these specific",
    "start": "2448119",
    "end": "2454880"
  },
  {
    "text": "systems in 2012 we get some constrained delegation enhancements we get group",
    "start": "2455319",
    "end": "2462040"
  },
  {
    "text": "managed service accounts where managed service counts is a one to one a one managed service count to one computer",
    "start": "2462040",
    "end": "2468599"
  },
  {
    "text": "group managed service counts you have group managed service count for multiple computers ad again is managing that",
    "start": "2468599",
    "end": "2475440"
  },
  {
    "text": "password compound authentication takes the user credential and the computer",
    "start": "2475440",
    "end": "2480520"
  },
  {
    "text": "credential combines them for a stronger authentication and determination of where that user is coming from and",
    "start": "2480520",
    "end": "2486839"
  },
  {
    "text": "dynamic Access Control can actually leverage that to say only an HR user with Department equals HR on an HR",
    "start": "2486839",
    "end": "2493839"
  },
  {
    "text": "computer can access this resource and Powershell G leverages this",
    "start": "2493839",
    "end": "2500520"
  },
  {
    "text": "also in 2012 R2 we have LSA protection which can actually stop a lot of the",
    "start": "2500520",
    "end": "2506520"
  },
  {
    "text": "credential theft techniques from pulling data from Elsas now mimicat you can just install a",
    "start": "2506520",
    "end": "2512280"
  },
  {
    "text": "driver and bypass that protection but that's a little noisier and it's a digital step",
    "start": "2512280",
    "end": "2517319"
  },
  {
    "text": "and the Powershell version may have some problems with that protected users is a security group",
    "start": "2517319",
    "end": "2523280"
  },
  {
    "text": "that's created when the PTC emulator is set to or configured with a 2012 R2",
    "start": "2523280",
    "end": "2529160"
  },
  {
    "text": "version of Windows with protected users we add admin accounts to this protected User",
    "start": "2529160",
    "end": "2534920"
  },
  {
    "text": "Group they are not allowed to authenticate using ntlm they are not allowed to authenticate using curos rc4",
    "start": "2534920",
    "end": "2541920"
  },
  {
    "text": "or Dez their passwords are not cached on that system they're only allowed to authenticate",
    "start": "2541920",
    "end": "2548200"
  },
  {
    "text": "using keros AES and their keros ticket lifetime is only four hours authentication policies and silos",
    "start": "2548200",
    "end": "2554720"
  },
  {
    "text": "where you can say these users can only authenticate and log on to these systems some additional protections around ceros",
    "start": "2554720",
    "end": "2561359"
  },
  {
    "text": "delegation so with Windows 10 and 2016 there's some nice really nice new features especially in auditing the",
    "start": "2561359",
    "end": "2568480"
  },
  {
    "text": "first I call mimic cats auditing where we can log and audit what's interacting with",
    "start": "2568480",
    "end": "2574440"
  },
  {
    "text": "Elsas we have the ability to to log and get events when something is interacting",
    "start": "2574440",
    "end": "2580000"
  },
  {
    "text": "with our Sam account database on the local system group membership enumeration and some new fields in the",
    "start": "2580000",
    "end": "2585960"
  },
  {
    "text": "log on events so that way we have a much better understanding of what's",
    "start": "2585960",
    "end": "2590839"
  },
  {
    "text": "Happening 2016 is a host of new features that are going to be useful to a lot of people if you're running hyperv you can",
    "start": "2591119",
    "end": "2597040"
  },
  {
    "text": "get shielded virtual machines which means that the virtual machines and the storage associated with them are encrypted so the hyperv admins",
    "start": "2597040",
    "end": "2603920"
  },
  {
    "text": "themselves can't even access that data justtin time Administration limits the",
    "start": "2603920",
    "end": "2609280"
  },
  {
    "text": "time in which an account or group is a member of a group and has that",
    "start": "2609280",
    "end": "2614720"
  },
  {
    "text": "Administration access just enough in administration G provides controls when",
    "start": "2614720",
    "end": "2621559"
  },
  {
    "text": "you Powershell remote into a system you can only run whitelisted",
    "start": "2621559",
    "end": "2627680"
  },
  {
    "text": "commands so in active directory 2016 we have a new optional feature much like the recycle bin called privilege access",
    "start": "2628319",
    "end": "2634800"
  },
  {
    "text": "management once we enable this we have the ability to set time to",
    "start": "2634800",
    "end": "2640599"
  },
  {
    "text": "live when we add a new group or account to an existing group so let's say we",
    "start": "2640599",
    "end": "2645960"
  },
  {
    "text": "have an info security SC vulnerability scanning account that we need to be in domain admins for 3 days well at the end",
    "start": "2645960",
    "end": "2652680"
  },
  {
    "text": "of three days that account is removed automatically and as we can see there's a TTL associated with that membership in",
    "start": "2652680",
    "end": "2658800"
  },
  {
    "text": "that group we also have a new Bastion Forest where we have an admin Forest support",
    "start": "2658800",
    "end": "2665640"
  },
  {
    "text": "baked into active directory 2016 we have Shadow security groups",
    "start": "2665640",
    "end": "2673160"
  },
  {
    "text": "where it's kind of like Sid history where the Sid from the production Forest is used for that shadow Security Group",
    "start": "2673160",
    "end": "2680000"
  },
  {
    "text": "which supports that tempal membership which also supports uh keros ticket",
    "start": "2680000",
    "end": "2685359"
  },
  {
    "text": "lifetime shortening so if a group is a member of another group for four hours",
    "start": "2685359",
    "end": "2692079"
  },
  {
    "text": "then your keros tickets only going to be good for four hours so again still in beta but in",
    "start": "2692079",
    "end": "2698079"
  },
  {
    "text": "September we'll see what this looks like because it looks very",
    "start": "2698079",
    "end": "2702440"
  },
  {
    "text": "interesting so to wrap up there's some interesting ad facts I want to share with you all authenticated users have",
    "start": "2703160",
    "end": "2708760"
  },
  {
    "text": "read access to pretty much all objects in active directory and pretty much all their attributes and they can view",
    "start": "2708760",
    "end": "2715800"
  },
  {
    "text": "pretty much all the contents in cisa even across",
    "start": "2715800",
    "end": "2721520"
  },
  {
    "text": "trust and a regular user account could have full admin right in the environment",
    "start": "2721520",
    "end": "2726960"
  },
  {
    "text": "through the magic Sid history even if it's not a member of any admin group could be able to modify the",
    "start": "2726960",
    "end": "2733599"
  },
  {
    "text": "membership of groups or modify accounts if it's delegated from years ago in a",
    "start": "2733599",
    "end": "2739040"
  },
  {
    "text": "group that's forgotten about or potentially that account gets popped and the whole environment gets compromised",
    "start": "2739040",
    "end": "2745319"
  },
  {
    "text": "because that group policy object has improper delegation on it so your security pro checklist who has admin",
    "start": "2745319",
    "end": "2752200"
  },
  {
    "text": "rights to The Domain in Forest who can log on to your DCS who is an admin of your virtual",
    "start": "2752200",
    "end": "2759559"
  },
  {
    "text": "environment if you have virtual DCS check your permissions in your active directory domain OU admin Esty",
    "start": "2759559",
    "end": "2767000"
  },
  {
    "text": "holder group policies for permissions that should not be there your domain admins need to be",
    "start": "2767000",
    "end": "2773040"
  },
  {
    "text": "protected at the highest level which means they should only be logging on to trusted admin workstations admin servers",
    "start": "2773040",
    "end": "2778599"
  },
  {
    "text": "and domain controllers and nothing else because if a domain admin gets popped there goes your Forest you also want to",
    "start": "2778599",
    "end": "2786040"
  },
  {
    "text": "limit your service account rights that have highly privileged access like",
    "start": "2786040",
    "end": "2792480"
  },
  {
    "text": "da so in conclusion regularly audit your active directory admin groups and your delegated rights because the keys to",
    "start": "2792480",
    "end": "2799440"
  },
  {
    "text": "active directory security is isolating admin credentials and isolating your critical",
    "start": "2799440",
    "end": "2804680"
  },
  {
    "text": "resources if you get active directory security right many of the common attacks are mitigated and far less",
    "start": "2804680",
    "end": "2810880"
  },
  {
    "text": "effective thank you very much",
    "start": "2810880",
    "end": "2817800"
  },
  {
    "text": "I have about three minutes for questions anyone has questions over there",
    "start": "2820920",
    "end": "2828680"
  },
  {
    "text": "yes don't have requ Services okay so the question is how often do I see domains",
    "start": "2831520",
    "end": "2837520"
  },
  {
    "text": "that don't require nlm Services uh rarely to never but we're trying to get",
    "start": "2837520",
    "end": "2842800"
  },
  {
    "text": "better right um security is a journey instead of a destination we're always trying to improve and if we can identify",
    "start": "2842800",
    "end": "2849240"
  },
  {
    "text": "by auditing ntlm we can get a better understanding of how it's being used okay any other questions over",
    "start": "2849240",
    "end": "2856279"
  },
  {
    "text": "there power viiew Power view by Will Schroeder AKA will",
    "start": "2856599",
    "end": "2863440"
  },
  {
    "text": "haroy yeah the slides are actually um going to be posted to adc.org like 5 minutes automatically so",
    "start": "2864359",
    "end": "2871559"
  },
  {
    "text": "there's a new post that should have them see any other questions",
    "start": "2871559",
    "end": "2876920"
  },
  {
    "text": "I'm looking yes right there what groups should you put your",
    "start": "2876920",
    "end": "2883359"
  },
  {
    "text": "help desk again that's a great question um I wouldn't recommend putting it into account operators unless you're a very",
    "start": "2883359",
    "end": "2888760"
  },
  {
    "text": "small environment and you don't have the resources to really do proper delegation But ultimately you should have an OU",
    "start": "2888760",
    "end": "2894599"
  },
  {
    "text": "that has your accounts in it you should do custom delegation and identify what the roles are required typically you",
    "start": "2894599",
    "end": "2900359"
  },
  {
    "text": "have a tiered uh levels of help Des help Des one 2 three help one will have the",
    "start": "2900359",
    "end": "2906760"
  },
  {
    "text": "ability to reset passwords help Des two probably more rights so it's really going to be specific to your environment",
    "start": "2906760",
    "end": "2911960"
  },
  {
    "text": "but they should be custom tuned to that because your help Des accounts are at",
    "start": "2911960",
    "end": "2917000"
  },
  {
    "text": "risk uh any others",
    "start": "2917000",
    "end": "2920920"
  },
  {
    "text": "yes great question thank you so much so the prize for the best question is we",
    "start": "2925960",
    "end": "2931680"
  },
  {
    "text": "see vendors that say we need to have domain admins and I love this question because most of the time vendors are",
    "start": "2931680",
    "end": "2938359"
  },
  {
    "text": "going to say that the account needs domain admins why it's easier to develop it's easier to test it's easier to",
    "start": "2938359",
    "end": "2943440"
  },
  {
    "text": "support often times the vendor's account only needs domain admin rights when it's",
    "start": "2943440",
    "end": "2949200"
  },
  {
    "text": "installed and then beyond that it doesn't or it needs to be able to reset the passwords on users or it needs very",
    "start": "2949200",
    "end": "2954960"
  },
  {
    "text": "specific uh delegated permissions which can be delegated so the question back to the vendor is okay what are the rights",
    "start": "2954960",
    "end": "2961240"
  },
  {
    "text": "that are required that you're saying it needs domain admins because domain admins is is not a requirement it's a",
    "start": "2961240",
    "end": "2966680"
  },
  {
    "text": "solution so tell me what the requirements are what are the permissions that are actually required and we can go from there friend of mine",
    "start": "2966680",
    "end": "2972440"
  },
  {
    "text": "had a VPN vendor said the service account needed to be a domain admin uh it turns out it just needed delegated",
    "start": "2972440",
    "end": "2978079"
  },
  {
    "text": "access to change the password for the user if their password had expired but the vendor didn't want to do that so and",
    "start": "2978079",
    "end": "2985000"
  },
  {
    "text": "I think I am out of time so I'll uh be here for a few minutes and then we can go to the back if there's further",
    "start": "2985000",
    "end": "2990520"
  },
  {
    "text": "questions so thank you very much",
    "start": "2990520",
    "end": "2994720"
  }
]