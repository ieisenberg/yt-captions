[
  {
    "start": "0",
    "end": "71000"
  },
  {
    "text": "welcome all welcome to the presentation Microsoft Office in Wonderland's my name",
    "start": "30",
    "end": "5910"
  },
  {
    "text": "is Peter this is Stan we will taking you",
    "start": "5910",
    "end": "10950"
  },
  {
    "text": "along on a journey into office we are red teamers or for outflank a small",
    "start": "10950",
    "end": "16560"
  },
  {
    "text": "company in the Meadowlands we perform adversary simulation at phones pen testing and in that process we often use",
    "start": "16560",
    "end": "24480"
  },
  {
    "text": "Microsoft Office one to write reports but also to send malicious documents to",
    "start": "24480",
    "end": "29939"
  },
  {
    "text": "our clients to our targets and in the process we always rely on standard",
    "start": "29939",
    "end": "35550"
  },
  {
    "text": "tricks like office macros and dde for code execution but we've",
    "start": "35550",
    "end": "41969"
  },
  {
    "text": "investigated office for in a broader perspective and flipped into other features of the office suite we can",
    "start": "41969",
    "end": "47280"
  },
  {
    "text": "abuse and how we can just bring this further just taking Word and Excel and",
    "start": "47280",
    "end": "53520"
  },
  {
    "text": "see what other malicious uses we can take from in our in our attacks so the",
    "start": "53520",
    "end": "60539"
  },
  {
    "text": "first question is if we take dde and",
    "start": "60539",
    "end": "65540"
  },
  {
    "text": "macros we always look into code execution but do we actually need code execution so what can we do with a",
    "start": "65540",
    "end": "73770"
  },
  {
    "start": "71000",
    "end": "155000"
  },
  {
    "text": "system if we don't do code execution for that let's let's look into one of them",
    "start": "73770",
    "end": "79710"
  },
  {
    "text": "the demos let's let's try to steal credentials so this is our web server",
    "start": "79710",
    "end": "92280"
  },
  {
    "text": "running and on the web server it only gives a basic authentication response and then so that's my attacker system",
    "start": "92280",
    "end": "101640"
  },
  {
    "text": "and then on the user system I send the user a specific backdoor document or a malformed document and then the user",
    "start": "101640",
    "end": "111060"
  },
  {
    "text": "will see we have the following behavior",
    "start": "111060",
    "end": "117180"
  },
  {
    "text": "so he opens his document which was just sent by email and the user suddenly gets",
    "start": "117180",
    "end": "122579"
  },
  {
    "text": "a prompt our username password prompt and it says well this server reports",
    "start": "122579",
    "end": "128789"
  },
  {
    "text": "that it needs a password for outflank and the user just types in his passwords his username and in my attacker system I do get the",
    "start": "128789",
    "end": "136470"
  },
  {
    "text": "username in the password being provided so from a user perspective this looks just very standard this looks like",
    "start": "136470",
    "end": "142680"
  },
  {
    "text": "SharePoint asking for the youth for the passwords but something different was happening here because as an attacker I",
    "start": "142680",
    "end": "147720"
  },
  {
    "text": "just stole the passwords so what happened here is a trick which relies on",
    "start": "147720",
    "end": "157379"
  },
  {
    "start": "155000",
    "end": "395000"
  },
  {
    "text": "fields and for fields we need to dive into a deeper a bit deeper into into office so if we go into words there are",
    "start": "157379",
    "end": "166349"
  },
  {
    "text": "some hidden old-school gems and one of the old-school gems is if you go to in",
    "start": "166349",
    "end": "172620"
  },
  {
    "text": "the insert mode there's this quick parts",
    "start": "172620",
    "end": "177810"
  },
  {
    "text": "button and if you just start clicking around a word which is kind of what our research is we just click around a word",
    "start": "177810",
    "end": "183450"
  },
  {
    "text": "and we try to find nice features you'll see there is a fields button and this",
    "start": "183450",
    "end": "189840"
  },
  {
    "text": "fields button it has a lot of additional options and feature here you see you can",
    "start": "189840",
    "end": "196079"
  },
  {
    "text": "have the author of the document as a field you can have an include picture",
    "start": "196079",
    "end": "201200"
  },
  {
    "text": "you can include all other interesting things so one of the interesting things",
    "start": "201200",
    "end": "206700"
  },
  {
    "text": "you can include is an include picture and what you can say is I want to have a picture of my my malicious host so just",
    "start": "206700",
    "end": "214019"
  },
  {
    "text": "an HTTP URL you can type it in here and on the HTTP URL you can say well I want",
    "start": "214019",
    "end": "220049"
  },
  {
    "text": "to have this include picture to be dynamic so I don't want this picture to be stored within the document I want",
    "start": "220049",
    "end": "225629"
  },
  {
    "text": "this picture to be a dynamic look a retrieval of this of this URL and with",
    "start": "225629",
    "end": "232169"
  },
  {
    "text": "that in words next time a user opens a document it will load the picture well that already is a very simple trick for",
    "start": "232169",
    "end": "238230"
  },
  {
    "text": "us to use as a water watermarking so we know as a tracking pixel we know when a",
    "start": "238230",
    "end": "243569"
  },
  {
    "text": "user opens a document so that's kind of also where this research towards we were just playing with these fields and there",
    "start": "243569",
    "end": "251160"
  },
  {
    "text": "are quite some interesting fields in this one so we have include picture to retrieve a remote content or to retrieve",
    "start": "251160",
    "end": "258150"
  },
  {
    "text": "a picture from a remote location we have a user named user addresses all kind of",
    "start": "258150",
    "end": "264800"
  },
  {
    "text": "attributes and they are typically used in the old-school way of how to use templates",
    "start": "264800",
    "end": "270680"
  },
  {
    "text": "invert or in mail merges so if a user opens a document you will these fields",
    "start": "270680",
    "end": "277160"
  },
  {
    "text": "will get updated so include picture I",
    "start": "277160",
    "end": "286190"
  },
  {
    "text": "just mentioned that's very valuable for tracking a user whether we open the document or not but if we do go into the",
    "start": "286190",
    "end": "292550"
  },
  {
    "text": "demo I just I just demonstrated it this is about credential theft so how does that work well this is a combination of",
    "start": "292550",
    "end": "298100"
  },
  {
    "text": "multiple layers of fields in within each other and this is a CVE Microsoft",
    "start": "298100",
    "end": "303470"
  },
  {
    "text": "patched is in January so we reported it took them a couple of months before they",
    "start": "303470",
    "end": "309500"
  },
  {
    "text": "could patch it so what this this is this is an include picture just the same as",
    "start": "309500",
    "end": "315889"
  },
  {
    "text": "as this standard picture we often use as attackers but in this picture we said",
    "start": "315889",
    "end": "321410"
  },
  {
    "text": "this URL contains this username field and the user name field is dynamic and",
    "start": "321410",
    "end": "328120"
  },
  {
    "text": "we don't store this in a docx file but we store this in a dot X file or in a dot file which is a template so when the",
    "start": "328120",
    "end": "334400"
  },
  {
    "text": "user double clicks it the user named string gets updated by doing that update",
    "start": "334400",
    "end": "339590"
  },
  {
    "text": "the URL gets updated and by doing that suddenly the request of the web server",
    "start": "339590",
    "end": "345889"
  },
  {
    "text": "does process basic authentication responses so so where normally if you",
    "start": "345889",
    "end": "351110"
  },
  {
    "text": "would have an include picture with a basic authentication response it would just ignore it word was just ignore this",
    "start": "351110",
    "end": "356120"
  },
  {
    "text": "by doing this trick so it should be in the header it should be a dynamic URL and we do this by including this",
    "start": "356120",
    "end": "362599"
  },
  {
    "text": "username field and we and we use a dot X file we suddenly have this nice",
    "start": "362599",
    "end": "370430"
  },
  {
    "text": "credential pop-up and the nice thing is as long as we as an attacker keep giving",
    "start": "370430",
    "end": "375770"
  },
  {
    "text": "failed authentication responses and ask for new credentials the user will keep getting prompts so the user can't open",
    "start": "375770",
    "end": "382250"
  },
  {
    "text": "word until it just gave the last ten passwords ever used so this is CVE",
    "start": "382250",
    "end": "389300"
  },
  {
    "text": "of a five for zero we have another one which also relies on fields so",
    "start": "389300",
    "end": "396969"
  },
  {
    "start": "395000",
    "end": "675000"
  },
  {
    "text": "credential stealing without markers and without execution is noise but maybe you want to steal files as well and for that there",
    "start": "396969",
    "end": "404749"
  },
  {
    "text": "was this - mm - there was this this this CVE in word which used a quote and then",
    "start": "404749",
    "end": "414560"
  },
  {
    "text": "a filename and an includes text and this include text field you can use it to",
    "start": "414560",
    "end": "420020"
  },
  {
    "text": "include text from a text file on disk so you can say include text see the semi",
    "start": "420020",
    "end": "425479"
  },
  {
    "text": "colon slash - and a text file the patch Microsoft made was - well to just not",
    "start": "425479",
    "end": "434300"
  },
  {
    "text": "update this field anymore and our challenge was how can we get this include text to update and again by",
    "start": "434300",
    "end": "444949"
  },
  {
    "text": "using these fields which is like real legacy old-school stuff we managed to do",
    "start": "444949",
    "end": "451729"
  },
  {
    "text": "that so this is again my web server",
    "start": "451729",
    "end": "464599"
  },
  {
    "text": "running on the back end which just has runs a standard web server in this time",
    "start": "464599",
    "end": "470210"
  },
  {
    "text": "so this guitar it's not running this basic authentication responses just a standard simple HTTP server and we said",
    "start": "470210",
    "end": "478460"
  },
  {
    "text": "the user the following double click to see the monkey dance and if the user",
    "start": "478460",
    "end": "485680"
  },
  {
    "text": "does that it'll click the file well actually nothing happens but if we now",
    "start": "485680",
    "end": "492919"
  },
  {
    "text": "look into our web server something interesting has happens we just got this huge blob back and if we look carefully",
    "start": "492919",
    "end": "499279"
  },
  {
    "text": "this is just the URL encoded version of the attenti file of that specific system",
    "start": "499279",
    "end": "505069"
  },
  {
    "text": "so in this non this case there were no clear text passwords in it in a tense file but we just stole this in a tent",
    "start": "505069",
    "end": "510500"
  },
  {
    "text": "file by just a user double clicking amount and again this relies on fields",
    "start": "510500",
    "end": "517518"
  },
  {
    "text": "and a combination of fields for multiple layers",
    "start": "517519",
    "end": "522310"
  },
  {
    "text": "so how this one is built up is is it's multiple layers so we have an include",
    "start": "525900",
    "end": "531520"
  },
  {
    "text": "picture with a monkey but next to that we see another include picture which",
    "start": "531520",
    "end": "538720"
  },
  {
    "text": "points to a malicious web server and then includes text so if this field this",
    "start": "538720",
    "end": "545590"
  },
  {
    "text": "include picture field so this picture would be updated we would send the text",
    "start": "545590",
    "end": "551440"
  },
  {
    "text": "of the intent file to this malicious web server but now we just need to force it",
    "start": "551440",
    "end": "557260"
  },
  {
    "text": "to update this Microsoft's patch said well we want to update this include text anymore and for that we use yet another",
    "start": "557260",
    "end": "563560"
  },
  {
    "text": "field and that field is named a macro button a macro buttons have not not really something to do with macros as we",
    "start": "563560",
    "end": "569920"
  },
  {
    "text": "know it from VBA this is just a field and it's just a button it doesn't look",
    "start": "569920",
    "end": "575800"
  },
  {
    "text": "like a button but in in the word context it says is it a button and what that means is if you select it you select the",
    "start": "575800",
    "end": "582460"
  },
  {
    "text": "full the full macro button so you can't select something in it so as you see when we run you're double clicking",
    "start": "582460",
    "end": "588390"
  },
  {
    "text": "you'll see that there's a bigger building block selected which is the button kind of the context and we want",
    "start": "588390",
    "end": "594700"
  },
  {
    "text": "you to double click that one all the contact of this macro button is being updated which then updates the monkey",
    "start": "594700",
    "end": "600670"
  },
  {
    "text": "picture not that interesting and it updates this web server and it's an attempt file a census in a tenth file so",
    "start": "600670",
    "end": "607570"
  },
  {
    "text": "this is again a way how we just by ingeniously combining this very legacy",
    "start": "607570",
    "end": "612760"
  },
  {
    "text": "fields building them into each other trying to take different events how we",
    "start": "612760",
    "end": "618040"
  },
  {
    "text": "could steal arbitrary files by just a user double-clicking something in Word",
    "start": "618040",
    "end": "624000"
  },
  {
    "text": "we've submitted this again to Microsoft again took them three to four months for patching because they had to change",
    "start": "624000",
    "end": "630130"
  },
  {
    "text": "something deeper into into words and the mitigation of Microsoft turned out to be",
    "start": "630130",
    "end": "636450"
  },
  {
    "text": "an additional security warning so anybody who is now using an up-to-date",
    "start": "636450",
    "end": "641860"
  },
  {
    "text": "version of Office has this new warning feature introduced that this document contains fields that can share data with",
    "start": "641860",
    "end": "648880"
  },
  {
    "text": "external parties and it is important that you only open such a file from a trusted location so",
    "start": "648880",
    "end": "656760"
  },
  {
    "text": "two things we already did in words which like legacy features no code execution",
    "start": "656760",
    "end": "663360"
  },
  {
    "text": "and still we can do stuff which we really don't want to happen to your users these were the legacy features but",
    "start": "663360",
    "end": "671870"
  },
  {
    "text": "sometimes we just get new features being",
    "start": "671870",
    "end": "677220"
  },
  {
    "text": "added to excel and words and for that we need to meet em and they get and",
    "start": "677220",
    "end": "682710"
  },
  {
    "text": "transform abuse so one today I was opening my excel and I saw this pop-up",
    "start": "682710",
    "end": "692030"
  },
  {
    "text": "need to import data we just have this new feature it's cool to get and transform wizards or we get them",
    "start": "692030",
    "end": "698580"
  },
  {
    "text": "transform feature turns out to be that Microsoft has ported various features of",
    "start": "698580",
    "end": "703830"
  },
  {
    "text": "power bi into excel and they named it getting transform but it's very much",
    "start": "703830",
    "end": "711810"
  },
  {
    "text": "relating to power bi and in power bi you have the scripting language which called M so therefore meet M this is like the",
    "start": "711810",
    "end": "721800"
  },
  {
    "text": "newest features of words in Excel so that's also very interesting from a research perspective to look into world",
    "start": "721800",
    "end": "727800"
  },
  {
    "text": "how can we make abuse cases out of this one let me go here so this is again my",
    "start": "727800",
    "end": "741270"
  },
  {
    "text": "simple web server I read and I open just",
    "start": "741270",
    "end": "747240"
  },
  {
    "text": "a standard excel file it will give me a security warning and if we go into the",
    "start": "747240",
    "end": "753300"
  },
  {
    "text": "Excel menu we can see which warning this is this is not about macros this is",
    "start": "753300",
    "end": "760410"
  },
  {
    "text": "about a web service and about external data connections so we think we open an excel sheet which just opens external",
    "start": "760410",
    "end": "767040"
  },
  {
    "text": "data connections that's hopefully where we convinced our ever we need to convince our user to click that or the",
    "start": "767040",
    "end": "772590"
  },
  {
    "text": "victim to click that or do believe that this needs an external data connection but it's way less invasive than a macro",
    "start": "772590",
    "end": "777840"
  },
  {
    "text": "warning what now happens is the following there's a get in transform feature and a get in transform feature",
    "start": "777840",
    "end": "784710"
  },
  {
    "text": "can import from text files and well if you can import from a text file",
    "start": "784710",
    "end": "790670"
  },
  {
    "text": "well then I can read from any text file which includes for example this in a tense file and then we need to submit it",
    "start": "790670",
    "end": "798379"
  },
  {
    "text": "so on this screen we'll see that all the data has been submitted this is again the intent file which has just been",
    "start": "798379",
    "end": "804170"
  },
  {
    "text": "stolen by an attacker by a malicious web server how this one works so we have a",
    "start": "804170",
    "end": "817310"
  },
  {
    "text": "get in transform this new feature of of excel and we have this definition in",
    "start": "817310",
    "end": "822470"
  },
  {
    "text": "this M language which as well your excel can you please read this file C and a",
    "start": "822470",
    "end": "829759"
  },
  {
    "text": "tenth and consider it a CSV file and put",
    "start": "829759",
    "end": "835370"
  },
  {
    "text": "everything in the first column of this specific excel sheet and that's what happens the first column is getting",
    "start": "835370",
    "end": "841100"
  },
  {
    "text": "filled with with the data of my own attend file but then as an attacker I want to steal that data and I want to",
    "start": "841100",
    "end": "846980"
  },
  {
    "text": "send it away so that brings the second layer of attack which takes this field",
    "start": "846980",
    "end": "852110"
  },
  {
    "text": "from a1 and just sends it with a web service request and this web service request can has a maximum length so we",
    "start": "852110",
    "end": "857810"
  },
  {
    "text": "can't post this one in a 10 file in one go because it's too big but we just take line by line we post that data away this",
    "start": "857810",
    "end": "866509"
  },
  {
    "text": "was a very naive example of stealing in an attempt file there is a so this get in transform wizard has a lot of",
    "start": "866509",
    "end": "872810"
  },
  {
    "text": "features one of them is it can import text files just txt and this is what I",
    "start": "872810",
    "end": "878180"
  },
  {
    "text": "use in this in this demo but you can also use it to parse to retrieve XML and you can just really define like an XPath",
    "start": "878180",
    "end": "884870"
  },
  {
    "text": "query and only get a very specific value which makes it much faster and much less less in-your-face and furthermore there",
    "start": "884870",
    "end": "892220"
  },
  {
    "text": "are so many more features in this in his new feet in his new wizard in this new get and transform stuff so you can make",
    "start": "892220",
    "end": "898670"
  },
  {
    "text": "database connections from an excel sheet you can make connections to Azure",
    "start": "898670",
    "end": "904180"
  },
  {
    "text": "connections into the Active Directory so it's ongoing research but I really",
    "start": "904180",
    "end": "909680"
  },
  {
    "text": "believe there's a lot of potential here to not a code execution or maybe use this feature to get into code execution",
    "start": "909680",
    "end": "916339"
  },
  {
    "text": "but do something besides the dde and besides the standard VBA tree",
    "start": "916339",
    "end": "922550"
  },
  {
    "text": "so these were three tricks to do so that that has nothing to do with code",
    "start": "922550",
    "end": "927840"
  },
  {
    "text": "execution systems but already stealing files getting credentials from users so that's already quite quite nice",
    "start": "927840",
    "end": "935310"
  },
  {
    "text": "achievements but what the next part is do we actually need vba for markers do",
    "start": "935310",
    "end": "942660"
  },
  {
    "start": "937000",
    "end": "960000"
  },
  {
    "text": "we need that and that's where Stan comes in yeah so what we're gonna do is we're gonna have a look at the go-to technique",
    "start": "942660",
    "end": "948690"
  },
  {
    "text": "for most attackers in abusing MS Office which is still mattress but we are going",
    "start": "948690",
    "end": "953760"
  },
  {
    "text": "to get it to the next level because there is so much happening in the hood of macros and we're gonna have a look at",
    "start": "953760",
    "end": "959250"
  },
  {
    "text": "that so we're going down the rabbit hole of macros and the first thing that I have to explain to you is that macros is",
    "start": "959250",
    "end": "966330"
  },
  {
    "start": "960000",
    "end": "1110000"
  },
  {
    "text": "not just VBA most people think when they hear macros in Emma's office at this",
    "start": "966330",
    "end": "971670"
  },
  {
    "text": "Visual Basic for applications but there's all our languages that are supported as well and the most important",
    "start": "971670",
    "end": "976920"
  },
  {
    "text": "one there is Excel for macros or Excel and macros which I will be dealing it in",
    "start": "976920",
    "end": "984120"
  },
  {
    "text": "in a minute and the really interesting difference between VBA macros and Excel",
    "start": "984120",
    "end": "990780"
  },
  {
    "text": "em across is that VBA is a separate engine is a separate DLL which can be blocked by a blocker for example but",
    "start": "990780",
    "end": "997950"
  },
  {
    "text": "Excel and macros are processed within Excel of the exe itself it's not a separate engine it's within the exe of",
    "start": "997950",
    "end": "1003710"
  },
  {
    "text": "Excel so that will be really hard to to get rid of in your environment and then",
    "start": "1003710",
    "end": "1010330"
  },
  {
    "text": "VBA is not VBA there is stuff happening under the hood there's intermediary",
    "start": "1010330",
    "end": "1016160"
  },
  {
    "text": "languages under the hood of VBA P code and execute I will not go into Xcode but",
    "start": "1016160",
    "end": "1021740"
  },
  {
    "text": "P code we will dive into in a few minutes which is really interesting as well so that is what we are going to do",
    "start": "1021740",
    "end": "1027530"
  },
  {
    "text": "in the next 20 minutes let's start with excellent macros excellent macros they",
    "start": "1027530",
    "end": "1034010"
  },
  {
    "text": "exist in Excel since 1992 and if you've never seen it this is how it works I",
    "start": "1034010",
    "end": "1039709"
  },
  {
    "text": "just go to Excel right click insert and",
    "start": "1039709",
    "end": "1045949"
  },
  {
    "text": "I actually choose I'm going to use this one ms excel 4.0 macro all of a",
    "start": "1045949",
    "end": "1057210"
  },
  {
    "text": "sudden I get a new sheet and this is a so-called macro sheet and this language is completely different from from VBA so",
    "start": "1057210",
    "end": "1064020"
  },
  {
    "text": "let me write an example exact calculator and then hold the macro after that and",
    "start": "1064020",
    "end": "1072950"
  },
  {
    "text": "if we run this then there's my calculator that's how it works and if I",
    "start": "1072950",
    "end": "1079440"
  },
  {
    "text": "want to auto open this function upon opening this file I just have to rename",
    "start": "1079440",
    "end": "1084600"
  },
  {
    "text": "this cell to out to open and then it just behaves it's a regular auto open event in VBA macros but again a",
    "start": "1084600",
    "end": "1090330"
  },
  {
    "text": "completely different language which is being ran by a different engine and if you want to hide your macro right mouse",
    "start": "1090330",
    "end": "1097890"
  },
  {
    "text": "click hide and it's actually gone from the GUI so this is some basic stuff",
    "start": "1097890",
    "end": "1104280"
  },
  {
    "text": "which we already demonstrated at there become last year but it gets more interesting if you go deeper into this",
    "start": "1104280",
    "end": "1111500"
  },
  {
    "start": "1110000",
    "end": "1146000"
  },
  {
    "text": "so I just started calculator with a simple exec function but I found out",
    "start": "1111500",
    "end": "1117090"
  },
  {
    "text": "that you can actually call Windows 32 API methods as well so this is an",
    "start": "1117090",
    "end": "1123390"
  },
  {
    "text": "example of shell code injection into the current Excel process by calling Virtual",
    "start": "1123390",
    "end": "1129690"
  },
  {
    "text": "L log write process memory and create trap it's a basic proof of concept you",
    "start": "1129690",
    "end": "1135750"
  },
  {
    "text": "can make it much more advanced but it does show you the power Excel for PTO macros are almost as powerful as the",
    "start": "1135750",
    "end": "1142830"
  },
  {
    "text": "regular VBA macros are and if you want to hide your markers even better then",
    "start": "1142830",
    "end": "1150030"
  },
  {
    "start": "1146000",
    "end": "1281000"
  },
  {
    "text": "let's have a look at the active file format specifications of Microsoft so if",
    "start": "1150030",
    "end": "1156570"
  },
  {
    "text": "you look at the file from a specification of a sheet so you have a regular sheet but there's also a macro",
    "start": "1156570",
    "end": "1161580"
  },
  {
    "text": "sheet but each sheet has a few options and they are being set in this bound sheet 8 record which is in an excel file",
    "start": "1161580",
    "end": "1170159"
  },
  {
    "text": "and there's the option which I highlighted on the bottom so there's a regular sheet which is visible there is",
    "start": "1170159",
    "end": "1176520"
  },
  {
    "text": "a hidden sheet which I just made hidden with a right mouse click but actually if",
    "start": "1176520",
    "end": "1181860"
  },
  {
    "text": "I want to unhide it then I just go back and there should be an anti button here",
    "start": "1181860",
    "end": "1187220"
  },
  {
    "text": "and then all of a sudden my macro is back but apparently there's also a",
    "start": "1187220",
    "end": "1192379"
  },
  {
    "text": "specification which says very hidden and it took a little bit of googling but",
    "start": "1192379",
    "end": "1199009"
  },
  {
    "text": "actually this can be achieved really easily so you just first write your Excel for macro then open the VBA editor",
    "start": "1199009",
    "end": "1205820"
  },
  {
    "text": "just run a single line of code and set this sheet to very hidden and then all",
    "start": "1205820",
    "end": "1210980"
  },
  {
    "text": "of a sudden you cannot unhide it from the GUI then you remove this VBA code save the file and now all of a sudden",
    "start": "1210980",
    "end": "1216470"
  },
  {
    "text": "you have a completely invisible macro and it didn't take very long after our",
    "start": "1216470",
    "end": "1226070"
  },
  {
    "text": "derbycon presentation before these things started popping up in the wild and actually we had to find out of this",
    "start": "1226070",
    "end": "1232279"
  },
  {
    "text": "specific setting by abuse of of this feature in the wild and this is the",
    "start": "1232279",
    "end": "1239480"
  },
  {
    "text": "actual sample that's that's there if you look this sample up it does process",
    "start": "1239480",
    "end": "1245570"
  },
  {
    "text": "injection it has a very hidden sheet and",
    "start": "1245570",
    "end": "1250720"
  },
  {
    "text": "this was after our disclosure at there become but still 0 out of 59 detections",
    "start": "1250720",
    "end": "1256460"
  },
  {
    "text": "at fires total so current visibility of virtually all virus scanners into this",
    "start": "1256460",
    "end": "1262700"
  },
  {
    "text": "really old 1992 technology is pretty pretty poor this sample was pointed out",
    "start": "1262700",
    "end": "1267859"
  },
  {
    "text": "to the excellent team from from mnemonic by the way look at the hash it's a",
    "start": "1267859",
    "end": "1273919"
  },
  {
    "text": "really cool example it's way better than our proof of concept that we released this is the stuff that we're seeing in a wild Excel macros are not just exposed",
    "start": "1273919",
    "end": "1284450"
  },
  {
    "start": "1281000",
    "end": "1386000"
  },
  {
    "text": "via Excel files via workbooks and sheets that they are also exposed via something",
    "start": "1284450",
    "end": "1291980"
  },
  {
    "text": "called silk and if you're not familiar with silk silk is a text-based file format from the 1980s they are still",
    "start": "1291980",
    "end": "1301669"
  },
  {
    "text": "being used in Excel or day-day they are still allowed in Excel by default to be",
    "start": "1301669",
    "end": "1307070"
  },
  {
    "text": "open and even the Sok file extension is by default connected with Excel it's a",
    "start": "1307070",
    "end": "1314299"
  },
  {
    "text": "completely text-based file format and because of that it does not open in the protected mode sandbox so you might",
    "start": "1314299",
    "end": "1321980"
  },
  {
    "text": "be familiar that after downloading a regular excel file in the in the default setting you have to click enable editing",
    "start": "1321980",
    "end": "1328100"
  },
  {
    "text": "to get out of this protected few sandbox because silk files are completely sq",
    "start": "1328100",
    "end": "1333350"
  },
  {
    "text": "based Microsoft has decided that they do not open in the protected view it protected",
    "start": "1333350",
    "end": "1338540"
  },
  {
    "text": "few sandbox so that's a good thing to begin with and that actually what you",
    "start": "1338540",
    "end": "1343760"
  },
  {
    "text": "see there is less than a hundred bytes it's 99 bytes to to pop calculator via",
    "start": "1343760",
    "end": "1350900"
  },
  {
    "text": "Excel 4.0 macros within a SLK file then",
    "start": "1350900",
    "end": "1355940"
  },
  {
    "text": "the team the MD sec team from the UK they took my sample code and they",
    "start": "1355940",
    "end": "1361850"
  },
  {
    "text": "actually embedded this into their tools sharpshooter which I think many of you are familiar with and they now fully",
    "start": "1361850",
    "end": "1367640"
  },
  {
    "text": "weaponize this and I've heard from various teams that this technique is pretty successful and that current",
    "start": "1367640",
    "end": "1374690"
  },
  {
    "text": "feasibility of antivirus into this is pretty poor so we've now seen Excel for",
    "start": "1374690",
    "end": "1380660"
  },
  {
    "text": "macros in regular Excel we have seen them being exposed to silk but there's more places where Excel for macros are",
    "start": "1380660",
    "end": "1388610"
  },
  {
    "text": "being exposed to one of the interesting part is come and decom so you have this",
    "start": "1388610",
    "end": "1395690"
  },
  {
    "text": "method execute Excel for macro which is exposed fire come and fire decom and",
    "start": "1395690",
    "end": "1401710"
  },
  {
    "text": "this means that if we open it fire decom we can actually run Excel for macros",
    "start": "1401710",
    "end": "1408050"
  },
  {
    "text": "without touching disk on a remote system that's the whole principle of comm of decomp so what you see here is a few",
    "start": "1408050",
    "end": "1416180"
  },
  {
    "text": "lines of code a simple proof of concept and what we do here in the first line is",
    "start": "1416180",
    "end": "1421400"
  },
  {
    "text": "we instantiate excel on another system on server a1 that's just default Deacon",
    "start": "1421400",
    "end": "1429380"
  },
  {
    "text": "functionality and then we have an interface with excel on that other system so we're going to use this for",
    "start": "1429380",
    "end": "1434990"
  },
  {
    "text": "lateral movement and then by just executing excel for macro calls that",
    "start": "1434990",
    "end": "1442750"
  },
  {
    "text": "subsequently call windows api calls we can now inject shell code on a remote",
    "start": "1442750",
    "end": "1448910"
  },
  {
    "text": "system with ever touching discs which is a big place over many other decom based lateral",
    "start": "1448910",
    "end": "1456049"
  },
  {
    "text": "movement methods that are currently out there there is one there's one be calm",
    "start": "1456049",
    "end": "1461090"
  },
  {
    "text": "it's pretty slow so injecting a shellcode of a thousand bytes it's staging shellcode will take you",
    "start": "1461090",
    "end": "1466879"
  },
  {
    "text": "about one to two minutes but if you have that time then this is a really great",
    "start": "1466879",
    "end": "1471980"
  },
  {
    "text": "method to actually inject shell codes do not rely on any lobe in and inject it",
    "start": "1471980",
    "end": "1476990"
  },
  {
    "text": "into Excel Big C on a remote system without touching disk code in PowerShell",
    "start": "1476990",
    "end": "1482990"
  },
  {
    "text": "and the cobol strike implementation is that at that github repository so that",
    "start": "1482990",
    "end": "1490850"
  },
  {
    "start": "1489000",
    "end": "1614000"
  },
  {
    "text": "was Excel for macros now let's go back to VBA macros and if you look at the",
    "start": "1490850",
    "end": "1497450"
  },
  {
    "text": "specification of CBA Marcos you get stuff like this this is what Microsoft released and if you have no clue what",
    "start": "1497450",
    "end": "1504320"
  },
  {
    "text": "this stuff is then let me open up a word file for you so I have a dot docx file",
    "start": "1504320",
    "end": "1511490"
  },
  {
    "text": "here and if I open it with a compound file editor then I see this so what is",
    "start": "1511490",
    "end": "1518509"
  },
  {
    "text": "this is this is the compound file binary format CF bf also called compound files",
    "start": "1518509",
    "end": "1526100"
  },
  {
    "text": "and they are like a file system in a single file this is the default file",
    "start": "1526100",
    "end": "1532220"
  },
  {
    "text": "format for word files until 2003 and after 2003 they switch to a zip and",
    "start": "1532220",
    "end": "1538490"
  },
  {
    "text": "excellent xml-based format but even if you open the newer formats like doc m",
    "start": "1538490",
    "end": "1544190"
  },
  {
    "text": "and xlsm in a zip in a zip archive in",
    "start": "1544190",
    "end": "1549350"
  },
  {
    "text": "program then you will see a file there VBA project bin which actually contains some macros and that in turn is a",
    "start": "1549350",
    "end": "1555799"
  },
  {
    "text": "compound file like this one and you can open it for example with flex hex so what you see here I'll zoom in a bit is",
    "start": "1555799",
    "end": "1562090"
  },
  {
    "text": "there's a storage called macros another",
    "start": "1562090",
    "end": "1567470"
  },
  {
    "text": "storage called VBA and within here there are several streams I'll quickly explain",
    "start": "1567470",
    "end": "1574460"
  },
  {
    "text": "these streams project basically informs the GUI on what to display the Phoebe a GUI editor VPP a project",
    "start": "1574460",
    "end": "1582659"
  },
  {
    "text": "forms the VBA engine not the GUI but the actual engine about what kind of Phoebe",
    "start": "1582659",
    "end": "1588210"
  },
  {
    "text": "project this is then there's a deer which is a like a like a layout of the",
    "start": "1588210",
    "end": "1594720"
  },
  {
    "text": "project and there are module streams like module one and this document in this case and for example if you look at",
    "start": "1594720",
    "end": "1601950"
  },
  {
    "text": "module one module one then it's just hack stuff like this well I'll stop",
    "start": "1601950",
    "end": "1611369"
  },
  {
    "text": "scrolling and this module stream that is what is being specified here so this is",
    "start": "1611369",
    "end": "1619950"
  },
  {
    "start": "1614000",
    "end": "1698000"
  },
  {
    "text": "the MSO vba specification and this specifies the module stream and it basically consists of two parts the last",
    "start": "1619950",
    "end": "1626970"
  },
  {
    "text": "part is compressed source code which is a proprietary compression method that",
    "start": "1626970",
    "end": "1632909"
  },
  {
    "text": "just compresses the vba source code but there's also the first part performance cache and performance cache is",
    "start": "1632909",
    "end": "1639690"
  },
  {
    "text": "completely undocumented and microsoft actually says it must be ignored on read",
    "start": "1639690",
    "end": "1645109"
  },
  {
    "text": "well clearly word and excel they don't ignore this on read they're doing",
    "start": "1645109",
    "end": "1650789"
  },
  {
    "text": "something different here and that is P code there is a layer under VBA for the",
    "start": "1650789",
    "end": "1656220"
  },
  {
    "text": "V V for the VBA engine where there's some sort of intermediary code and if",
    "start": "1656220",
    "end": "1661499"
  },
  {
    "text": "the file version of the excel or word file matches the version of the word or",
    "start": "1661499",
    "end": "1668460"
  },
  {
    "text": "excel host then the VBA code is completely ignored and the P code is being ran instead and order become",
    "start": "1668460",
    "end": "1677159"
  },
  {
    "text": "presentation we have some details about this but we have now actually weaponized this and we're here by introducing evil",
    "start": "1677159",
    "end": "1683940"
  },
  {
    "text": "clipping so we brought Clippy back it was time for him to revive and Clippy",
    "start": "1683940",
    "end": "1690929"
  },
  {
    "text": "will help you with creating malicious documents especially around abusing p code so immediately after a presentation",
    "start": "1690929",
    "end": "1697019"
  },
  {
    "text": "we will upload the code to github and what evil Clippy does it can hide markers from the GUI editor it can do P",
    "start": "1697019",
    "end": "1704460"
  },
  {
    "start": "1698000",
    "end": "2209000"
  },
  {
    "text": "code abuse etc and I will give you a few demos to so that this all makes makes",
    "start": "1704460",
    "end": "1709889"
  },
  {
    "text": "more sense where shall I start yeah I'm gonna start",
    "start": "1709889",
    "end": "1716070"
  },
  {
    "text": "right here so this is Kabul strike which some of you might be familiar with it's a situ framework and it has a",
    "start": "1716070",
    "end": "1723059"
  },
  {
    "text": "implant called beacon and it also has some basic attack techniques for example",
    "start": "1723059",
    "end": "1728759"
  },
  {
    "text": "if I do packages ms-office macro I can generate a malicious macro here copy macro copy macro yep and if I look at",
    "start": "1728759",
    "end": "1739590"
  },
  {
    "text": "the contents of this macro insert module",
    "start": "1739590",
    "end": "1749359"
  },
  {
    "text": "this is the actual macro it's really basic it doesn't do any evasion I would",
    "start": "1749359",
    "end": "1755580"
  },
  {
    "text": "not recommend you to ever use this on an engagement and what it does is it kicks off run DLL 32 and then fight a win API",
    "start": "1755580",
    "end": "1762869"
  },
  {
    "text": "it injects shell codes into this into this process really basic techniques which are clearly malicious so if we",
    "start": "1762869",
    "end": "1770340"
  },
  {
    "text": "upload this file to virustotal which i just did before the presentation",
    "start": "1770340",
    "end": "1777179"
  },
  {
    "text": "then we can see that all major antivirus engines that they do detect this file as",
    "start": "1777179",
    "end": "1782669"
  },
  {
    "text": "being malicious obviously so now let's write what we can achieve which is",
    "start": "1782669",
    "end": "1788419"
  },
  {
    "text": "obviously malicious macro by abusing this functionality which is under the",
    "start": "1788419",
    "end": "1794489"
  },
  {
    "text": "hood of EBA this peacott stuff so we're going to evil Clippy you see philippi",
    "start": "1794489",
    "end": "1800070"
  },
  {
    "text": "and the first thing that we are going to do is we're gonna have I'm going to copy",
    "start": "1800070",
    "end": "1805799"
  },
  {
    "text": "the original file CS original and we're going to copy it to CS hidden I'm going",
    "start": "1805799",
    "end": "1812999"
  },
  {
    "text": "to say evil Clippy please hide the macro from the GUI",
    "start": "1812999",
    "end": "1818789"
  },
  {
    "text": "editor yep so we now have a new file and if I open that file",
    "start": "1818789",
    "end": "1827599"
  },
  {
    "text": "and I real macros then I should see a new connection coming in at my cobalt",
    "start": "1831850",
    "end": "1838030"
  },
  {
    "text": "strike team server or is it yep so I do have a command control session right now",
    "start": "1838030",
    "end": "1843190"
  },
  {
    "text": "the macro successfully execute it but if I go to the macro editor the macro has completely disappeared it's not there",
    "start": "1843190",
    "end": "1850480"
  },
  {
    "text": "anymore even clip you achieve this by editing the project stream in a CF bf",
    "start": "1850480",
    "end": "1856390"
  },
  {
    "text": "file which instructs the GUI on what to display so it's hidden from the GUI",
    "start": "1856390",
    "end": "1861550"
  },
  {
    "text": "editor but the macro is still there and we can easily see that with a tool called only Phoebe a for example the",
    "start": "1861550",
    "end": "1870430"
  },
  {
    "text": "macro is still there it's just not being displayed in the GUI so let's feature one now let's try to get rid of the",
    "start": "1870430",
    "end": "1880030"
  },
  {
    "text": "macro as well so we're going to say we're gonna have some fake code this is",
    "start": "1880030",
    "end": "1887290"
  },
  {
    "text": "some fake code just a simple sub fake with a message box and I'm going to say evil Clippy first of all I need to copy",
    "start": "1887290",
    "end": "1896230"
  },
  {
    "text": "the file black head original 2 P code",
    "start": "1896230",
    "end": "1901740"
  },
  {
    "text": "evil Clippy do not just hide a file but please also remove the compressed Phoebe",
    "start": "1901740",
    "end": "1908470"
  },
  {
    "text": "a code while still leaving the P code intact and do that on this file",
    "start": "1908470",
    "end": "1916030"
  },
  {
    "text": "CSP code ok so if we now run only VBA on",
    "start": "1916030",
    "end": "1921040"
  },
  {
    "text": "this file we will see that only VBA",
    "start": "1921040",
    "end": "1928000"
  },
  {
    "text": "things that the code in this file is hi this is fake code but if we open the",
    "start": "1928000",
    "end": "1933190"
  },
  {
    "text": "file on this system",
    "start": "1933190",
    "end": "1936090"
  },
  {
    "text": "we do enable content we've run the macros and we go back to our COBOL strike team server then we see a second",
    "start": "1943520",
    "end": "1950660"
  },
  {
    "text": "connection coming in so it's not the code the VBA code is being executed now it's a peacoat because the version of",
    "start": "1950660",
    "end": "1956690"
  },
  {
    "text": "this file matches the version of Word and Excel as well with even clipping you",
    "start": "1956690",
    "end": "1962690"
  },
  {
    "text": "can actually set the target version of Office to target like 2016 2030 in 2010",
    "start": "1962690",
    "end": "1968660"
  },
  {
    "text": "whatever is there but but there's a big but there are tools that can analyze P",
    "start": "1968660",
    "end": "1975200"
  },
  {
    "text": "code and the most famous one is Pico dump from dr. bunch F and if I run P",
    "start": "1975200",
    "end": "1981770"
  },
  {
    "text": "code dump on this file then peak Odum still sees that there is a peacoat macro",
    "start": "1981770",
    "end": "1988970"
  },
  {
    "text": "in here you see the starting run DLL and doing all the bad stuff so this can",
    "start": "1988970",
    "end": "1994700"
  },
  {
    "text": "still be detected then how can we get rid of Pico dump as well for that we we",
    "start": "1994700",
    "end": "2001300"
  },
  {
    "text": "dived into the specifications of how markers are stored in a file and it",
    "start": "2001300",
    "end": "2006580"
  },
  {
    "text": "turns out that Microsoft often has two names pointing to similar objects and if",
    "start": "2006580",
    "end": "2015040"
  },
  {
    "text": "an object is a module stream then it keeps track of the module stream in two",
    "start": "2015040",
    "end": "2020550"
  },
  {
    "text": "variables one is an esky variable and another one is a Unicode variable so",
    "start": "2020550",
    "end": "2026530"
  },
  {
    "text": "there's two different names pointing to the same object well what could go wrong",
    "start": "2026530",
    "end": "2032490"
  },
  {
    "text": "thing is that what Microsoft Office uses is the Unicode name of the module stream",
    "start": "2032490",
    "end": "2038260"
  },
  {
    "text": "whereas most security analyst tools use the s key name so what we can do is we",
    "start": "2038260",
    "end": "2045400"
  },
  {
    "text": "can edit the file with evil Clippy set a completely random name for the module",
    "start": "2045400",
    "end": "2051100"
  },
  {
    "text": "stream and s key while still leaving a Unicode name intact and that's exactly what I'm going to do now so I'm copy it again random dot doc",
    "start": "2051100",
    "end": "2058419"
  },
  {
    "text": "don't say evil Clippy evil Clippy yes",
    "start": "2058419",
    "end": "2063908"
  },
  {
    "text": "hide it from the GUI set some fake code in there but now also do random random",
    "start": "2063909",
    "end": "2073000"
  },
  {
    "text": "module names for the for the S key specification see is random okay it did that it said",
    "start": "2073000",
    "end": "2080230"
  },
  {
    "text": "random sq names are still even unicode names intact and if I now run C as a",
    "start": "2080230",
    "end": "2085870"
  },
  {
    "text": "random I'm going to show you that it's all still working fine in Emma's office",
    "start": "2085870",
    "end": "2093210"
  },
  {
    "text": "enable content and we should see another connection popping in there's another",
    "start": "2094110",
    "end": "2100690"
  },
  {
    "text": "connection popping in so that's working just fine but if we now launch Pico dump on this",
    "start": "2100690",
    "end": "2105910"
  },
  {
    "text": "file picker them all of a sudden says",
    "start": "2105910",
    "end": "2110920"
  },
  {
    "text": "error file not found because that uses the s key name there's plenty of more",
    "start": "2110920",
    "end": "2115990"
  },
  {
    "text": "stuff that you can do here but this was just a basic demo of what what evil clip you can do and question is how effective",
    "start": "2115990",
    "end": "2122560"
  },
  {
    "text": "is this so we started with 34 engines detecting this obviously bad macro and I",
    "start": "2122560",
    "end": "2131530"
  },
  {
    "text": "just uploaded the last version to virustotal as well and then there's we get rid of all major antivirus engines",
    "start": "2131530",
    "end": "2139630"
  },
  {
    "text": "there's only one which is siren which actually triggers on a string which is still in the peacoats and that wouldn't",
    "start": "2139630",
    "end": "2145570"
  },
  {
    "text": "be too difficult to get rid of as well so antivirus is really poor visibility into P code and I can understand why",
    "start": "2145570",
    "end": "2153700"
  },
  {
    "text": "because there is no official specification of P code so that would be really difficult to get proper optics",
    "start": "2153700",
    "end": "2160180"
  },
  {
    "text": "into this there's one other thing which is interesting that's happening if you",
    "start": "2160180",
    "end": "2165730"
  },
  {
    "text": "look at the details of the original file then virus total detects that there's markers in here but virus total also",
    "start": "2165730",
    "end": "2173620"
  },
  {
    "text": "suffers from this s key versus Unicode bug because if we go to details here it",
    "start": "2173620",
    "end": "2180070"
  },
  {
    "text": "doesn't see any markers because this is processing the S key module stream names instead of the unicode body street names",
    "start": "2180070",
    "end": "2186630"
  },
  {
    "text": "cool stuff so this was a journey down the rabbit hole of macros but on modern",
    "start": "2186630",
    "end": "2194400"
  },
  {
    "text": "instances of Word and Excel on Windows 10 you might run into modern defenses",
    "start": "2194400",
    "end": "2199930"
  },
  {
    "text": "like MZ and ASR and we're going to show you some basics on how to bypass these",
    "start": "2199930",
    "end": "2206080"
  },
  {
    "text": "as well so Peter we'll start off with MZ and take over with a czar so MZ is the",
    "start": "2206080",
    "end": "2213230"
  },
  {
    "start": "2209000",
    "end": "2416000"
  },
  {
    "text": "anti-malware scanning interface introduced in Windows 10 Microsoft hooked up a lot of script interpreters",
    "start": "2213230",
    "end": "2219020"
  },
  {
    "text": "like C script PowerShell into this interface and the script engines sends",
    "start": "2219020",
    "end": "2224240"
  },
  {
    "text": "all their events that they execute to this MZ interface an antivirus vendor",
    "start": "2224240",
    "end": "2229370"
  },
  {
    "text": "can subscribe to that and any PowerShell commands you execute gets first being",
    "start": "2229370",
    "end": "2234950"
  },
  {
    "text": "approved by the AV then there or the AV the AV products can then intercept if they want in September Microsoft",
    "start": "2234950",
    "end": "2241100"
  },
  {
    "text": "announced that they were also doing MZ for VBA and as of January this is part",
    "start": "2241100",
    "end": "2246890"
  },
  {
    "text": "of this semiannual release so that means that in most of the office 365 deployments this is now life and working",
    "start": "2246890",
    "end": "2255160"
  },
  {
    "text": "in the design of the VBA for the VBA mzn",
    "start": "2255160",
    "end": "2261200"
  },
  {
    "text": "interface they made slightly different to design them for the powershell and c script versions so what they do is they",
    "start": "2261200",
    "end": "2269810"
  },
  {
    "text": "say well we maintain a lock of all suspicious calls being that the",
    "start": "2269810",
    "end": "2274820"
  },
  {
    "text": "suspicious calls being being common methods and win32 api s-- they say well we will just look all of these requests",
    "start": "2274820",
    "end": "2282080"
  },
  {
    "text": "being made in runtime so anytime you create a new word instance in a macro",
    "start": "2282080",
    "end": "2287840"
  },
  {
    "text": "that is being locked that's just a log file a behavior log which kind of keep",
    "start": "2287840",
    "end": "2293120"
  },
  {
    "text": "track in like a stack trace and then they said well there are a couple of suspicious events and once we encounter",
    "start": "2293120",
    "end": "2301100"
  },
  {
    "text": "a suspicious events then we go into a trigger mode and at that point in time we will take this stack this this law",
    "start": "2301100",
    "end": "2308240"
  },
  {
    "text": "from word from the VBA engine and send it to the MZ provider or to the MZ",
    "start": "2308240",
    "end": "2314600"
  },
  {
    "text": "engine and then the AV can be saw it on the design microsoft said this is about",
    "start": "2314600",
    "end": "2322490"
  },
  {
    "text": "vba when testing it it turns out to be that p code is also intercepted by MZ so",
    "start": "2322490",
    "end": "2328910"
  },
  {
    "text": "stands tricks on peak out and removing the VBA code this MZ engine would being",
    "start": "2328910",
    "end": "2335270"
  },
  {
    "text": "a runtime engine it takes the peak out and provides that to MZ one additional",
    "start": "2335270",
    "end": "2341390"
  },
  {
    "text": "detail they describe in their September blog about the design is that there's this micro runtime scope so Microsoft was worried about",
    "start": "2341390",
    "end": "2348110"
  },
  {
    "text": "performance and how this would affect regular markers being executed in businesses so what they said is well",
    "start": "2348110",
    "end": "2354830"
  },
  {
    "text": "we'll have three versions of this of this free mode where this engine can run one it can be disabled it can be enabled",
    "start": "2354830",
    "end": "2363530"
  },
  {
    "text": "on low trusted documents and it can be enabled on all documents and low trusted",
    "start": "2363530",
    "end": "2369530"
  },
  {
    "text": "documents they said well we will just exclude documents that are in a trusted location or that you looked at it before",
    "start": "2369530",
    "end": "2376580"
  },
  {
    "text": "so trust the document so that document you open before it was then analyzed and the next time you open it we won't",
    "start": "2376580",
    "end": "2382460"
  },
  {
    "text": "analyze it again if you look at me this signs so these kind of things they say",
    "start": "2382460",
    "end": "2387740"
  },
  {
    "text": "well if it's that then we'll just exclude it from MZ so that keeps performance intact we will only check it",
    "start": "2387740",
    "end": "2392840"
  },
  {
    "text": "the first time into it it runs and this low trust document mode is the default",
    "start": "2392840",
    "end": "2398270"
  },
  {
    "text": "so if you don't configure this setting by default the first time you open the document it will be sent to a mess so in",
    "start": "2398270",
    "end": "2407990"
  },
  {
    "text": "terms of this is how Microsoft designed it and there are quite some fundamental bypass approaches in how they set this",
    "start": "2407990",
    "end": "2414740"
  },
  {
    "text": "up so first of all how to bypass MZ well",
    "start": "2414740",
    "end": "2420560"
  },
  {
    "start": "2416000",
    "end": "2604000"
  },
  {
    "text": "let's just don't do don't do VBA so where we started the presentation fields",
    "start": "2420560",
    "end": "2426860"
  },
  {
    "text": "abuse power a power query or this get in transform it's not code execution so it",
    "start": "2426860",
    "end": "2433790"
  },
  {
    "text": "won't be picked but also the excel for the log macros ten demonstrates they are not in the VBA engine this is a separate",
    "start": "2433790",
    "end": "2440000"
  },
  {
    "text": "engine so that engine is just not hooked up to mg so doing excel for that Omar Kraus is fully bypassing MZ then there",
    "start": "2440000",
    "end": "2449570"
  },
  {
    "text": "was this feature with this macro runtime scope and trusted documents well if we can write our document into a trusted",
    "start": "2449570",
    "end": "2456080"
  },
  {
    "text": "location we can just drop our code there and then we reopen our own file from the",
    "start": "2456080",
    "end": "2461150"
  },
  {
    "text": "location where we just saved it and MZ will say well you're now from a safe location so no worry to check this one",
    "start": "2461150",
    "end": "2467030"
  },
  {
    "text": "so again a very simple way to do bypass and then there's this decision not to",
    "start": "2467030",
    "end": "2474520"
  },
  {
    "text": "said everything from coal mine 132 to two days empty engine but only build up",
    "start": "2474520",
    "end": "2480580"
  },
  {
    "text": "this stack within the vba engine and send it on specific malicious keywords well it appears that this list of",
    "start": "2480580",
    "end": "2487510"
  },
  {
    "text": "malicious keywords is just if it contains the word shell or execute execute then it's being sent to MZ and",
    "start": "2487510",
    "end": "2493390"
  },
  {
    "text": "if so if you have comm methods that don't contain the words shell or execute",
    "start": "2493390",
    "end": "2498670"
  },
  {
    "text": "you may be able to you can run them and it won't be sent to MZ it will still be",
    "start": "2498670",
    "end": "2503860"
  },
  {
    "text": "in this law but it will just never be sent to your to the AV product so examples of that are execute execute",
    "start": "2503860",
    "end": "2510070"
  },
  {
    "text": "excelled for a tomar el DD e initialize or W my spawn instance there are all",
    "start": "2510070",
    "end": "2516220"
  },
  {
    "text": "words which don't contain the word shell or execute and then a fourth category",
    "start": "2516220",
    "end": "2521950"
  },
  {
    "text": "exists that is there are features in Word and Excel that don't that are not",
    "start": "2521950",
    "end": "2528700"
  },
  {
    "text": "per se calm or not word min 32 so how about we create a file in words a macro",
    "start": "2528700",
    "end": "2535840"
  },
  {
    "text": "and the only thing the macro does is write something in the in in a word file save it as a text file but in a text",
    "start": "2535840",
    "end": "2543580"
  },
  {
    "text": "file format but with the extension dobot and the extension don't react and if we",
    "start": "2543580",
    "end": "2548650"
  },
  {
    "text": "do that in a small way we dropped it in the startup directory then suddenly we have we just drop a bad file which has",
    "start": "2548650",
    "end": "2555610"
  },
  {
    "text": "imported raffle and then the left file we say disable the mz9 or set this macro",
    "start": "2555610",
    "end": "2560620"
  },
  {
    "text": "runtime scope to disabled and the next and this is all stored in hte current",
    "start": "2560620",
    "end": "2565660"
  },
  {
    "text": "user so that's that's very nice for us we can write so the next time the system reboots we just disabled MZ forwards and",
    "start": "2565660",
    "end": "2571540"
  },
  {
    "text": "we can go along and have a lot of fun without MZ intercepting so what we're",
    "start": "2571540",
    "end": "2577120"
  },
  {
    "text": "seeing is that the MZ implementation for VBA is weaker than the MZ implementation",
    "start": "2577120",
    "end": "2583180"
  },
  {
    "text": "for powershell for example and that is just by design because it works with logging and triggers whereas the",
    "start": "2583180",
    "end": "2589180"
  },
  {
    "text": "powershell MZ this catches the whole script this is completely different and we already see that there is a few basic",
    "start": "2589180",
    "end": "2595810"
  },
  {
    "text": "techniques by which we can bypass this but on a properly hardened system you",
    "start": "2595810",
    "end": "2601960"
  },
  {
    "text": "might also run into a text surface reduction and a text surface reduction",
    "start": "2601960",
    "end": "2607120"
  },
  {
    "text": "our rule that are enforced by Windows Defender exploit guard which is the successor to",
    "start": "2607120",
    "end": "2612250"
  },
  {
    "text": "Amit and there's a few rules which can harden office in Excel and other MS",
    "start": "2612250",
    "end": "2620950"
  },
  {
    "text": "Office programs that are running and the most famous rules are the rules to block",
    "start": "2620950",
    "end": "2626560"
  },
  {
    "text": "Windows 32 API calls and the rule to block office applications like Word and",
    "start": "2626560",
    "end": "2632410"
  },
  {
    "text": "Excel from creating child processes so block them from create starting other programs it's not that difficult to get",
    "start": "2632410",
    "end": "2640420"
  },
  {
    "text": "to bypass these two the first rule block windows 32 api calls it's a static rule",
    "start": "2640420",
    "end": "2647170"
  },
  {
    "text": "so Windows Defender export guard just scans a macro if there are any VBA",
    "start": "2647170",
    "end": "2652810"
  },
  {
    "text": "signatures for forbidden windows 32 API calls so how can we bypass this well we",
    "start": "2652810",
    "end": "2659020"
  },
  {
    "text": "can actually go from VBA to excel for macros and thereby call the windows 32",
    "start": "2659020",
    "end": "2666940"
  },
  {
    "text": "API call dynamically without having to have a VBA signature for the windows 32 API function you see a few lines of code",
    "start": "2666940",
    "end": "2674920"
  },
  {
    "text": "that that do just that for shell execute a with calc for the other rule that's",
    "start": "2674920",
    "end": "2681550"
  },
  {
    "text": "their block application block office application from creating child processes that's a dynamic rule so",
    "start": "2681550",
    "end": "2686770"
  },
  {
    "text": "that's enforced during runtime is not a scan of the VBA code and the whole trick",
    "start": "2686770",
    "end": "2692710"
  },
  {
    "text": "there is to let the dirty job of starting another process to be done by",
    "start": "2692710",
    "end": "2697900"
  },
  {
    "text": "an order program for example of running instance of explorative the exe so what this code example on the bottom does it",
    "start": "2697900",
    "end": "2703960"
  },
  {
    "text": "just creates a common interface to shell browser window which happens to be a part of Explorer dot exe the running",
    "start": "2703960",
    "end": "2712000"
  },
  {
    "text": "instance of explorer dot exe the actual shell and then we can abuse the methods",
    "start": "2712000",
    "end": "2717460"
  },
  {
    "text": "shall execute which explorer offers viacom to have explorer start Calvert",
    "start": "2717460",
    "end": "2723460"
  },
  {
    "text": "exe so now Word or Excel interfaced with Explorer dot exe no process creation",
    "start": "2723460",
    "end": "2730900"
  },
  {
    "text": "there because explore Dixie was already running and we have explored at exe spawn a child process well you can do",
    "start": "2730900",
    "end": "2737050"
  },
  {
    "text": "this kind of freaks both with calm and WMI but these are the most famous ways to to bypass bypass ASR this",
    "start": "2737050",
    "end": "2745650"
  },
  {
    "start": "2745000",
    "end": "3030000"
  },
  {
    "text": "concludes our presentation and what we have shown you is that there's both archaic features like excel for put o",
    "start": "2745650",
    "end": "2754260"
  },
  {
    "text": "mark roads and fields that can be abused but also new features like power query",
    "start": "2754260",
    "end": "2760800"
  },
  {
    "text": "with the M language which are really promising for abuse as well and we've",
    "start": "2760800",
    "end": "2767280"
  },
  {
    "text": "also shown you that these features can be abused in all stages of an attack",
    "start": "2767280",
    "end": "2772500"
  },
  {
    "text": "from code execution antivirus back pass but we've also shown that it can be",
    "start": "2772500",
    "end": "2777840"
  },
  {
    "text": "really interesting for lateral movement and bypasses a lot of defenses like mg and ASR we pretty much love Emma's",
    "start": "2777840",
    "end": "2786180"
  },
  {
    "text": "office from a offensive perspective we've only scratched the surface and we",
    "start": "2786180",
    "end": "2791880"
  },
  {
    "text": "really hope that you we've given you some insights not only on how to abuse this kind of stuff but also provides",
    "start": "2791880",
    "end": "2797970"
  },
  {
    "text": "interesting angles for future research because really there is so much more",
    "start": "2797970",
    "end": "2803580"
  },
  {
    "text": "both old features and new features being added is basically a goldmine so thank",
    "start": "2803580",
    "end": "2810630"
  },
  {
    "text": "you all for listening if there are any questions I do think that we have a few minutes to answer them I see a hand",
    "start": "2810630",
    "end": "2819780"
  },
  {
    "text": "there I don't know if there's a microphone if not we'll just repeat the question",
    "start": "2819780",
    "end": "2824420"
  },
  {
    "text": "ah would daresay bling markers actually stop all this yes and no yes as in both",
    "start": "2827630",
    "end": "2837769"
  },
  {
    "text": "peacoat and excel for markers they do adhere to the 2d settings and you're",
    "start": "2837769",
    "end": "2843259"
  },
  {
    "text": "actually talking about the trust settings so if you go to file where do",
    "start": "2843259",
    "end": "2850519"
  },
  {
    "text": "we have it options and then go to the trust Center",
    "start": "2850519",
    "end": "2856249"
  },
  {
    "text": "trust Center settings these settings can be managed for GPOs if you want to so if",
    "start": "2856249",
    "end": "2862220"
  },
  {
    "text": "you set disable all markers without notification then yes P code and Excel for both all markers do",
    "start": "2862220",
    "end": "2869329"
  },
  {
    "text": "adhere to this setting but a common misconception is that this setting",
    "start": "2869329",
    "end": "2874460"
  },
  {
    "text": "actually blocks all macros which it says it doesn't and if you're really",
    "start": "2874460",
    "end": "2881150"
  },
  {
    "text": "interested into this stuff I advise you to watch our derby comm presentation of last year and our troopers presentation",
    "start": "2881150",
    "end": "2888049"
  },
  {
    "text": "of last week which are complementary to what we told today but the basic summary is that trusted documents trusted",
    "start": "2888049",
    "end": "2895069"
  },
  {
    "text": "locations and trusted publishers always go have priority over this macro setting",
    "start": "2895069",
    "end": "2902499"
  },
  {
    "text": "so if you can have a document to be either a trusted document which is just",
    "start": "2902499",
    "end": "2908359"
  },
  {
    "text": "a registry setting somewhere which you can abused or whether it is a only trusted location or signed by a trusted",
    "start": "2908359",
    "end": "2913999"
  },
  {
    "text": "publisher then it will always run so that's why there's my answer yes or no there is a big caveat here and in the",
    "start": "2913999",
    "end": "2921349"
  },
  {
    "text": "presentations that I mentioned we show some angles on how you can abuse that does it answer your question cool thanks",
    "start": "2921349",
    "end": "2930910"
  },
  {
    "text": "that's a really good one so the question is what is our experience with office fire processors which are in various",
    "start": "2944869",
    "end": "2952050"
  },
  {
    "text": "projects both open source and and closed source I don't think we've ever seriously looked into that No so",
    "start": "2952050",
    "end": "2958890"
  },
  {
    "text": "interestingly so I started with these fields and these CVS we submitted them forwards the patch",
    "start": "2958890",
    "end": "2965280"
  },
  {
    "text": "came out for SharePoint as well so we already saw that way we didn't really look into that what we saw that",
    "start": "2965280",
    "end": "2971460"
  },
  {
    "text": "apparently that was for SharePoint as well so processors are in different areas as well so it's interesting",
    "start": "2971460",
    "end": "2977760"
  },
  {
    "text": "research yeah my good feeling is the specifications of the office file formats but also of the markers they are",
    "start": "2977760",
    "end": "2984030"
  },
  {
    "text": "so difficult that's one they are ambiguous like Unicode versus s key etc that's two and they are also",
    "start": "2984030",
    "end": "2990960"
  },
  {
    "text": "largely undocumented while still those undocumented parts are being used by word in Excel so from my perspective",
    "start": "2990960",
    "end": "2998750"
  },
  {
    "text": "it's it's it's a recipe for a mess form a processing perspective although I",
    "start": "2998750",
    "end": "3004730"
  },
  {
    "text": "don't know really really interesting angle I'm not sure which processors support macros but that's thanks for the",
    "start": "3004730",
    "end": "3010040"
  },
  {
    "text": "life we have some time work to do take a look into that thing all right if",
    "start": "3010040",
    "end": "3017150"
  },
  {
    "text": "there's any other questions feel free to call me over here or we'll be happy to answer them during the rest of the EFT conference thank you again for your",
    "start": "3017150",
    "end": "3023650"
  },
  {
    "text": "attention and we hope to see you again bye [Applause]",
    "start": "3023650",
    "end": "3031899"
  }
]