[
  {
    "start": "0",
    "end": "103000"
  },
  {
    "text": "all right everybody welcome to processes no one hunting for token manipulation my",
    "start": "0",
    "end": "5819"
  },
  {
    "text": "name is jarred Atkinson and I'm the adversary detection technical lead at a cybersecurity startup called Spectre UPS",
    "start": "5819",
    "end": "11010"
  },
  {
    "text": "I do a lot of development in my spare time so a couple things that I'm really interested in is PowerShell so I'm a",
    "start": "11010",
    "end": "16980"
  },
  {
    "text": "Microsoft MVP for my work in PowerShell digital forensics I work on a project",
    "start": "16980",
    "end": "22109"
  },
  {
    "text": "called power forensics which allows you to do NTFS parsing from within power show and",
    "start": "22109",
    "end": "27779"
  },
  {
    "text": "a couple other projects that we work that we put together from PowerShell my background is I got my start in the US",
    "start": "27779",
    "end": "33750"
  },
  {
    "text": "Air Force on the hunt team there and then I worked for various groups adaptive threat division before respector ups and I'll let Robbie",
    "start": "33750",
    "end": "40260"
  },
  {
    "text": "introduce himself yeah I'm Robbie Winchester I also work at Spectre ops I work with Jared for",
    "start": "40260",
    "end": "46800"
  },
  {
    "text": "that the ACE tool we presented it yesterday at Arsenal also worked on a dr. Ives version of ELQ used to be Air",
    "start": "46800",
    "end": "54270"
  },
  {
    "text": "Force as well on the red side and then transitioned over after I got out of the military to do more of the the hunt",
    "start": "54270",
    "end": "59879"
  },
  {
    "text": "approach which is going to be the focus of this conversation and I also used to work at the adaptive threat division so",
    "start": "59879",
    "end": "67439"
  },
  {
    "text": "what are we going to talk about today obviously the title is about detecting the access token and manipulation but",
    "start": "67439",
    "end": "74790"
  },
  {
    "text": "first we're gonna go into kind of a background of what is hunt it's kind of a buzzword a lot of times of different",
    "start": "74790",
    "end": "80490"
  },
  {
    "text": "people mean different things so we're gonna identify first at the beginning what we consider to be hunt talk about",
    "start": "80490",
    "end": "86040"
  },
  {
    "text": "how adversary tactics techniques and procedures are an important part of understanding what hunting is and then",
    "start": "86040",
    "end": "91619"
  },
  {
    "text": "how we do hypothesis driven hunting specifically then doing a case study for this of how to use this hypothesis",
    "start": "91619",
    "end": "99090"
  },
  {
    "text": "process to go through and detect the access token manipulation in the environment so we're gonna start on our",
    "start": "99090",
    "end": "104909"
  },
  {
    "start": "103000",
    "end": "183000"
  },
  {
    "text": "quest to understand the hunting next slide so what what is hunting when we",
    "start": "104909",
    "end": "110189"
  },
  {
    "text": "say hunting we mean you're actively searching your environment for the presence of some malicious activity that",
    "start": "110189",
    "end": "115740"
  },
  {
    "text": "you're current in place defenses have not detected the assumed breach mentality has kind of become more",
    "start": "115740",
    "end": "121740"
  },
  {
    "text": "popular at mark russinovich has talked about it at different conferences among other people and so the concept here is",
    "start": "121740",
    "end": "127829"
  },
  {
    "text": "that a security breach is not something that may happen is something that will happen is just a matter of time",
    "start": "127829",
    "end": "133319"
  },
  {
    "text": "if you're a significant enough target you're gonna be targeted",
    "start": "133319",
    "end": "139200"
  },
  {
    "text": "it only takes that one chance for someone to gain that initial code execution and so for for some level of",
    "start": "139200",
    "end": "145650"
  },
  {
    "text": "compromise or some type of malicious activity to occur in your network is a very likely event what we're focusing on",
    "start": "145650",
    "end": "152010"
  },
  {
    "text": "is that post exploitation activity where after the code execution has occurred",
    "start": "152010",
    "end": "157530"
  },
  {
    "text": "how can we detect the adversary activity in the environment most of the traditional network defense appliances",
    "start": "157530",
    "end": "163799"
  },
  {
    "text": "or defense appliances such as like firewalls and antivirus they're really focusing on stopping that initial",
    "start": "163799",
    "end": "169439"
  },
  {
    "text": "execution and so we want to look where a lot of times there is not effort kind of inside the network and look at focus on",
    "start": "169439",
    "end": "176010"
  },
  {
    "text": "that other half and that's and that's what we're going to talk about during this brief so what is a normal Hunt",
    "start": "176010",
    "end": "181919"
  },
  {
    "text": "cycle look like so kind of the generic beginning level hunt process a lot of",
    "start": "181919",
    "end": "186930"
  },
  {
    "start": "183000",
    "end": "197000"
  },
  {
    "text": "times that we would see is kind of two part where you gather data and then you hunt for bad and you're trying to find",
    "start": "186930",
    "end": "192000"
  },
  {
    "text": "that apt in your environment the problem with this next slide is kind of two",
    "start": "192000",
    "end": "198090"
  },
  {
    "text": "parts so when you're gathering data it's it's not a normal data is equal and not all data is really is useful so what",
    "start": "198090",
    "end": "205049"
  },
  {
    "text": "data should you be collecting and why are you collecting that data is there a purpose behind gathering every event log",
    "start": "205049",
    "end": "211260"
  },
  {
    "text": "or every process if you're not actually performing any type of analytics on it are you just bogging down and paying",
    "start": "211260",
    "end": "217319"
  },
  {
    "text": "extra money to a provider you know first say like Splunk or loading up your your",
    "start": "217319",
    "end": "222780"
  },
  {
    "text": "sim and so there's a cost there of gathering the data and then additionally when you're hunting for 'bad it's really",
    "start": "222780",
    "end": "230069"
  },
  {
    "text": "difficult if you sit down in front of your sim and have a million or a billion",
    "start": "230069",
    "end": "236220"
  },
  {
    "text": "events and just try and look for something without a direction and so a lot of times there's a focus that's very",
    "start": "236220",
    "end": "242970"
  },
  {
    "text": "vague or very broad and so you have to baseline your activity you have to know",
    "start": "242970",
    "end": "248189"
  },
  {
    "text": "what's good and this this is just a really a nuance problem and without kind of taking a bite-size approach it can",
    "start": "248189",
    "end": "254129"
  },
  {
    "text": "easily become overwhelming additionally as you have this data coming in a lot of times you're gonna have more data",
    "start": "254129",
    "end": "260340"
  },
  {
    "text": "flowing in than you have time to look at it so the amount of data to look at is growing faster than you're able to",
    "start": "260340",
    "end": "266150"
  },
  {
    "text": "parse through it so it just kind of becomes a big problem so the kind of the new approach and what we we prescribed",
    "start": "266150",
    "end": "273770"
  },
  {
    "start": "271000",
    "end": "304000"
  },
  {
    "text": "to you is the hypothesis driven hunting so and rather than just gathering data and looking for something that's bad the",
    "start": "273770",
    "end": "279169"
  },
  {
    "text": "first step is you create this hunt hypothesis which is what you're gonna specifically look for in the environment",
    "start": "279169",
    "end": "286039"
  },
  {
    "text": "and then you gather the data in support of that hypothesis so there's a purpose behind it you're actually you're",
    "start": "286039",
    "end": "291320"
  },
  {
    "text": "choosing the things that you want so that you know you can use them and they're gonna help you in that targeted hunting for bad activity so it's it's",
    "start": "291320",
    "end": "298310"
  },
  {
    "text": "now not just an open-ended question you're trying to solve iterative problems over time some of the benefits",
    "start": "298310",
    "end": "305090"
  },
  {
    "start": "304000",
    "end": "359000"
  },
  {
    "text": "of this well first it's focused data collection so you're not just having data come in and getting more and more",
    "start": "305090",
    "end": "311300"
  },
  {
    "text": "events more and more activity without a purpose it's also going to give you a goal so if you have a team you can tell",
    "start": "311300",
    "end": "318349"
  },
  {
    "text": "them a specific thing you're you're looking for and that's gonna let you have that focus and not have the",
    "start": "318349",
    "end": "323510"
  },
  {
    "text": "analysis paralysis of this this vague concept that is a little hard to quantify again also if you're you're",
    "start": "323510",
    "end": "331970"
  },
  {
    "text": "tracking these if you have a targeted focus then over time you can identify where you've been hunting what you've",
    "start": "331970",
    "end": "337580"
  },
  {
    "text": "been hunting for and it's really helpful for trends and we're gonna talk about this a little bit later but basically",
    "start": "337580",
    "end": "342620"
  },
  {
    "text": "this hypothesis approach really helps to clarify a lot of things and and make it",
    "start": "342620",
    "end": "348260"
  },
  {
    "text": "a more focused effort that is actually causing improvement rather than just starting to hunt which is just gathering",
    "start": "348260",
    "end": "355820"
  },
  {
    "text": "data and and not necessarily getting a tangible result so next slide so awesome",
    "start": "355820",
    "end": "361280"
  },
  {
    "start": "359000",
    "end": "410000"
  },
  {
    "text": "hopefully everyone agrees hypothesis-driven hunting sounds like the way to go how do you make a",
    "start": "361280",
    "end": "366650"
  },
  {
    "text": "hypothesis and what should on hypothesis be this is kind of the problem that we had that inspired us to start doing",
    "start": "366650",
    "end": "372740"
  },
  {
    "text": "these briefings there's very vague guidance or people will talk about a hypothesis driven hunt but not really",
    "start": "372740",
    "end": "379190"
  },
  {
    "text": "what that hypothesis should be how you should make those and it's kind of all over the board so we really wanted to",
    "start": "379190",
    "end": "385159"
  },
  {
    "text": "have a process internally where we could track it over time have it be iterative",
    "start": "385159",
    "end": "390229"
  },
  {
    "text": "and and work as consultants with clients to develop their programs so we're gonna walk you through our our process here",
    "start": "390229",
    "end": "399159"
  },
  {
    "text": "of how to kind of do that process in an iterative fashion that's gonna really increase the sophistication ideally of",
    "start": "399159",
    "end": "406149"
  },
  {
    "text": "your program but before we get into that we're gonna cover a little bit of background so slide everyone's familiar",
    "start": "406149",
    "end": "412209"
  },
  {
    "start": "410000",
    "end": "441000"
  },
  {
    "text": "with some type of hacker methodology lifecycle we're gonna reference mitre both from the cyber tech lifecycle and",
    "start": "412209",
    "end": "418089"
  },
  {
    "text": "then attack matrix on the next slide but in general there's always some type of",
    "start": "418089",
    "end": "423219"
  },
  {
    "text": "attack paths that is gonna take place from a recon all the way through kind of a whatever your end goal exploitation or",
    "start": "423219",
    "end": "430349"
  },
  {
    "text": "exfiltration of data or achieving effect so like I said at the beginning we're gonna really focus on that kind of post",
    "start": "430349",
    "end": "436599"
  },
  {
    "text": "exploitation control execute maintain next slide and for us the best reference",
    "start": "436599",
    "end": "443830"
  },
  {
    "start": "441000",
    "end": "488000"
  },
  {
    "text": "we've found is the miter attack framework if you haven't ever seen that mitre is a United States federal",
    "start": "443830",
    "end": "450039"
  },
  {
    "text": "contractor that produces a lot of open information the attack framework being kind of most popular and our personal",
    "start": "450039",
    "end": "456849"
  },
  {
    "text": "favorite and so it's a huge body of knowledge that has a lot of different attacker attack tactics techniques and",
    "start": "456849",
    "end": "462249"
  },
  {
    "text": "procedures kind of correlates to the different things in the attack cycle but really has a lot of that post exploitation focus that we're hoping for",
    "start": "462249",
    "end": "468819"
  },
  {
    "text": "and it also addresses both Windows Mac and OSX so that's something really",
    "start": "468819",
    "end": "473889"
  },
  {
    "text": "helpful if you've never seen it slide this is what it looks like I do not expect you to read that this is just the",
    "start": "473889",
    "end": "479319"
  },
  {
    "text": "highlight there's a lot of stuff here everything on there is a hyperlink so if you click it you're gonna get more information so why is this important",
    "start": "479319",
    "end": "487679"
  },
  {
    "text": "slide so first TTP's or tactics techniques and procedures as we said in",
    "start": "487679",
    "end": "492849"
  },
  {
    "start": "488000",
    "end": "589000"
  },
  {
    "text": "the introduction we're both prior military and so for us TTP's have a very",
    "start": "492849",
    "end": "499300"
  },
  {
    "text": "specific meaning and so I'm gonna kind of walk through what what that means and why that's important because we often",
    "start": "499300",
    "end": "504459"
  },
  {
    "text": "see it misused and I'm gonna kind of use an analogy of taking care of your car to highlight what this means so the tactics",
    "start": "504459",
    "end": "511209"
  },
  {
    "text": "are from a United States joint publication military doctrine the",
    "start": "511209",
    "end": "516279"
  },
  {
    "text": "employment and ordered arrangement of forces in relation to each other so what does that mean this is a real high level of general guidance so when we're",
    "start": "516279",
    "end": "523240"
  },
  {
    "text": "talking about for example owning a car there's a lot of different things you want to do as part of that and so like a high level thing would be preventive",
    "start": "523240",
    "end": "529420"
  },
  {
    "text": "maintenance that's that's not telling you exactly what to do but it's a cat Gouri of stuff that you want to take",
    "start": "529420",
    "end": "535180"
  },
  {
    "text": "care of if you want to have a full of functioning collar long-term so if you go down to the next level you have",
    "start": "535180",
    "end": "541420"
  },
  {
    "text": "techniques and that's the non-prescriptive ways or methods used to perform missions functions or tasks so",
    "start": "541420",
    "end": "547149"
  },
  {
    "text": "for the car analogy if preventive maintenance is the high level changing",
    "start": "547149",
    "end": "553149"
  },
  {
    "text": "your oil would be an example of a technique so we're not saying how to do it or what how frequently any of that type of",
    "start": "553149",
    "end": "559480"
  },
  {
    "text": "information it's just in general for the majority of cars you would want to change the oil and so non-prescriptive",
    "start": "559480",
    "end": "565620"
  },
  {
    "text": "general method of making sure that your engine your car is functioning well and then finally you get into procedures",
    "start": "565620",
    "end": "571899"
  },
  {
    "text": "which are the actual standard detailed steps of how to do something so this is",
    "start": "571899",
    "end": "577389"
  },
  {
    "text": "going to be in that manufacturer's for your specific car you know if you have a BMW you're going to do this if you have",
    "start": "577389",
    "end": "582730"
  },
  {
    "text": "a Toyota you're going to do this what types of oil to use what types of filter it's going to be those detailed steps so",
    "start": "582730",
    "end": "589529"
  },
  {
    "start": "589000",
    "end": "648000"
  },
  {
    "text": "all of that also applies to what we're talking about here today and the mitre",
    "start": "589529",
    "end": "595000"
  },
  {
    "text": "attack matrix is a good way to break that down so the tactics on that miter attack matrix are those column headers",
    "start": "595000",
    "end": "601509"
  },
  {
    "text": "so those are kind of those big buckets like persistence and credential access and discovery the big buckets that are",
    "start": "601509",
    "end": "607000"
  },
  {
    "text": "gonna group things into those categories it's gonna be really useful for tracking your focus over time areas where you",
    "start": "607000",
    "end": "614170"
  },
  {
    "text": "have or do not have coverage those techniques the non-prescriptive methods",
    "start": "614170",
    "end": "619360"
  },
  {
    "text": "those are gonna be all of those entries in the actual column right now there's",
    "start": "619360",
    "end": "625689"
  },
  {
    "text": "about two hundred and twenty different techniques that are represented in the attack matrix and like I said it's",
    "start": "625689",
    "end": "631269"
  },
  {
    "text": "across both Windows Linux and Mac OS so those are going to be those those behavioral it's not going to tell you",
    "start": "631269",
    "end": "637810"
  },
  {
    "text": "how something is being done but it is going to tell you for example like credential dumping is a technique that",
    "start": "637810",
    "end": "643060"
  },
  {
    "text": "is used as part of the credential access tactic and then finally you have",
    "start": "643060",
    "end": "649540"
  },
  {
    "start": "648000",
    "end": "684000"
  },
  {
    "text": "procedures so now the procedures are going to be those detailed specific information with relation to the mitre",
    "start": "649540",
    "end": "655540"
  },
  {
    "text": "attack matrix if you click on one of those techniques it's going to pull you pull up into something like this and",
    "start": "655540",
    "end": "660850"
  },
  {
    "text": "it's going to have a lot of times examples that's where you're gonna be able to find those like threat intelligence feeds write-ups about technical",
    "start": "660850",
    "end": "667470"
  },
  {
    "text": "write-ups about what's going on this is going to be the actual kind of nitty-gritty what tools were actually",
    "start": "667470",
    "end": "673200"
  },
  {
    "text": "being used what were the command lines being run what what were the specific things that they were doing in order to",
    "start": "673200",
    "end": "681030"
  },
  {
    "text": "achieve the effect on the environment so slightly so why is this useful well it's",
    "start": "681030",
    "end": "687000"
  },
  {
    "start": "684000",
    "end": "782000"
  },
  {
    "text": "important to understand all these different concepts because a lot of the kind of traditional focus especially if",
    "start": "687000",
    "end": "692610"
  },
  {
    "text": "threat intelligence has been more at the procedure level on the hashes and looking for c2 IPS and kind of that",
    "start": "692610",
    "end": "698400"
  },
  {
    "text": "blacklist approach and the problem with that as we've experienced is those kind of our brittle indicators that are",
    "start": "698400",
    "end": "704100"
  },
  {
    "text": "fairly easy for an attacker to change and if that's change then you you miss whatever that next iteration is and",
    "start": "704100",
    "end": "710040"
  },
  {
    "text": "you're fighting a losing battle so with that in mind we always recommend",
    "start": "710040",
    "end": "715110"
  },
  {
    "text": "focusing on that technique and that more behavioral level so you're you're able to focus on what is being done and what",
    "start": "715110",
    "end": "721890"
  },
  {
    "text": "is the process that they're trying to achieve rather than how they're specifically doing it with that in mind",
    "start": "721890",
    "end": "728790"
  },
  {
    "text": "you can reference the attack matrix throughout your hypothesis process and we're going to be doing that shortly",
    "start": "728790",
    "end": "735740"
  },
  {
    "text": "additionally in your environment if you have some type if you don't have any type of model that you're representing",
    "start": "735740",
    "end": "741360"
  },
  {
    "text": "of where you're collecting data where you have coverage and where you don't this is a really good example of you can",
    "start": "741360",
    "end": "746730"
  },
  {
    "text": "map out where you currently have visibility with your standard in place tool set and then you can focus your",
    "start": "746730",
    "end": "752010"
  },
  {
    "text": "hunt efforts and your additional effort in those areas where you don't have that current focus so from a planning and",
    "start": "752010",
    "end": "758640"
  },
  {
    "text": "focusing of resources perspective it's really helpful and then additionally that's going to identify those areas",
    "start": "758640",
    "end": "764280"
  },
  {
    "text": "where you don't currently have coverage if say for example you you realize in",
    "start": "764280",
    "end": "770280"
  },
  {
    "text": "mapping things you don't have anything that's actually looking for the abuse of credential access that's then maybe an",
    "start": "770280",
    "end": "775560"
  },
  {
    "text": "area where you'd want to focus either a technology solution or a personnel effort to get coverage in that area so",
    "start": "775560",
    "end": "781950"
  },
  {
    "text": "we've covered the background now we're gonna go on to the fun part get into how",
    "start": "781950",
    "end": "787620"
  },
  {
    "start": "782000",
    "end": "793000"
  },
  {
    "text": "do we actually what is this process how are we building the hunt hypothesis in order to investigate that so we have a",
    "start": "787620",
    "end": "794490"
  },
  {
    "start": "793000",
    "end": "854000"
  },
  {
    "text": "five steps five step process we're gonna walk through the intention here is",
    "start": "794490",
    "end": "799649"
  },
  {
    "text": "that you you make a very focused actionable hunt hypothesis that you can investigate for specific behavior",
    "start": "799649",
    "end": "806670"
  },
  {
    "text": "specific attacker activity in your environment and we intend that this is something that you would be creating",
    "start": "806670",
    "end": "812309"
  },
  {
    "text": "these hypotheses that would be executed over a one-week period of time that's",
    "start": "812309",
    "end": "817679"
  },
  {
    "text": "just gonna allow for you to iteratively be solving these small problems and and",
    "start": "817679",
    "end": "823709"
  },
  {
    "text": "actually having an effect in your environment a lot of times we have experience where you'll start down a",
    "start": "823709",
    "end": "829379"
  },
  {
    "text": "path and either get too far down a rabbit hole of research before trying to solve a problem and then you are not",
    "start": "829379",
    "end": "836249"
  },
  {
    "text": "actually taking it to completion or it becomes an overwhelming problem of breath and so you're worried about every",
    "start": "836249",
    "end": "843029"
  },
  {
    "text": "aspect of a certain attack and so nothing gets accomplished and so we're trying to combat that by really focusing",
    "start": "843029",
    "end": "848220"
  },
  {
    "text": "things down and having a set of steps where you can walk through and get a tangible result so the first part is",
    "start": "848220",
    "end": "856649"
  },
  {
    "start": "854000",
    "end": "934000"
  },
  {
    "text": "identifying the tactic in technique so back to the miter attack matrix the tactics are those those broad column",
    "start": "856649",
    "end": "861779"
  },
  {
    "text": "headers so this is that high-level what you're gonna look for the initiating",
    "start": "861779",
    "end": "867420"
  },
  {
    "text": "event kind of the instigation for this can come from any any source really it may be your CEO is worried about some",
    "start": "867420",
    "end": "874230"
  },
  {
    "text": "type of attack you are reading threat intelligence about other other industry",
    "start": "874230",
    "end": "879689"
  },
  {
    "text": "vertical type threats that are occurring and you're worried about something occurring if you know after say want to",
    "start": "879689",
    "end": "885120"
  },
  {
    "text": "cry you're worried about ransomware those types of things can drive this but the focus here is take that initial idea",
    "start": "885120",
    "end": "891569"
  },
  {
    "text": "and and refine it down to for this hunt hypothesis what is the tactic we want to",
    "start": "891569",
    "end": "897540"
  },
  {
    "text": "look at and then what is the technique beneath that there's rarely if ever",
    "start": "897540",
    "end": "903149"
  },
  {
    "text": "gonna only be a single technique involved in attack chain inherently these attacks are are chained together",
    "start": "903149",
    "end": "910170"
  },
  {
    "text": "and it's a series of different things occurring and so we're trying to take advantage of that where we don't need to",
    "start": "910170",
    "end": "916290"
  },
  {
    "text": "find every evidence of activity we just need to find something and if we find something then that can potentially",
    "start": "916290",
    "end": "921540"
  },
  {
    "text": "unravel the whole chain it's it's changing that dynamic to instead of the the defenders dilemma of always having",
    "start": "921540",
    "end": "927389"
  },
  {
    "text": "to be right you can switch it to the attacker dilemma to where they have to be evading all of these really good in",
    "start": "927389",
    "end": "932610"
  },
  {
    "text": "place defenses so this point yeah you have a tactic and technique and you're gonna be focused on one specific thing you're looking for",
    "start": "932610",
    "end": "939480"
  },
  {
    "start": "934000",
    "end": "1007000"
  },
  {
    "text": "however for that technique like it's a non prescriptive Broadway so there's gonna be some some nuances and some",
    "start": "939480",
    "end": "945779"
  },
  {
    "text": "tools and specific things so phase two is identifying the procedures so these are that you're going to use those",
    "start": "945779",
    "end": "951899"
  },
  {
    "text": "threat reports and look at tech write-ups and you want to understand what are the tools that are being used",
    "start": "951899",
    "end": "956970"
  },
  {
    "text": "how are those tools being used and not just what are they but from a behavioral",
    "start": "956970",
    "end": "962040"
  },
  {
    "text": "perspective what is the what is the objective so for example it would be",
    "start": "962040",
    "end": "967079"
  },
  {
    "text": "worth understanding like Mimi Katz is being used to dump credentials but you need to understand more than just their",
    "start": "967079",
    "end": "972180"
  },
  {
    "text": "running Mimi Katz you should understand how they're leveraging the back end in internals of Windows to do that because",
    "start": "972180",
    "end": "979259"
  },
  {
    "text": "you can recompile or write your own version so it's understanding what can and can't be easily changed across all",
    "start": "979259",
    "end": "986639"
  },
  {
    "text": "of that are there are there similar behavior similar patterns and this is gonna require research to go through and",
    "start": "986639",
    "end": "991949"
  },
  {
    "text": "understand a lot of times this is the the benefit of the biggest benefit is at the end of this you'll have had to spend",
    "start": "991949",
    "end": "997620"
  },
  {
    "text": "that time and research to identify how this all works and you're gonna walk away with a really good understanding so",
    "start": "997620",
    "end": "1003889"
  },
  {
    "text": "once we have the taxes techniques and then the procedures that are used the next phase is really the bulk of the",
    "start": "1003889",
    "end": "1009199"
  },
  {
    "text": "effort and this is where you're gonna want to take those tools take that actual technical intelligence and",
    "start": "1009199",
    "end": "1015130"
  },
  {
    "text": "research it yourself ideally in your own environment so deploy the malware deploy the behavior emulate that behavior and",
    "start": "1015130",
    "end": "1022209"
  },
  {
    "text": "identify for yourself what those indicators are from a behavioral perspective so we're all again we're not",
    "start": "1022209",
    "end": "1028668"
  },
  {
    "text": "looking for hashes we're looking for for things that we can find that are going to be difficult to change in order to be",
    "start": "1028669",
    "end": "1035030"
  },
  {
    "text": "more consistent with the actual process additionally where this is really helpful is you can baseline and set this",
    "start": "1035030",
    "end": "1041178"
  },
  {
    "text": "for your environment so we always recommend using like a gold image type system because that's going to help you",
    "start": "1041179",
    "end": "1047959"
  },
  {
    "text": "know what is going to potentially be high false positives in your environment and then at the end of this you should have a POC basically of hey this is the",
    "start": "1047959",
    "end": "1054860"
  },
  {
    "text": "data that we need to collect in order to detect these types of behaviors that we can then go take to the enterprise so",
    "start": "1054860",
    "end": "1060919"
  },
  {
    "text": "you have a very focused collection effort next slide the next step is identifying the scope so there's two",
    "start": "1060919",
    "end": "1067140"
  },
  {
    "start": "1064000",
    "end": "1104000"
  },
  {
    "text": "Factor's time and the number of data sources because this may be you know network subnets rather than just",
    "start": "1067140",
    "end": "1072950"
  },
  {
    "text": "endpoint hosts and so we recommend a week for the time just because it really",
    "start": "1072950",
    "end": "1078000"
  },
  {
    "text": "puts a good constraint and the perspective of we want to focus our effort and the number of data sources",
    "start": "1078000",
    "end": "1083310"
  },
  {
    "text": "that you can collect is going to be really dependent upon the your environment what the data collection process and analysis entails and what",
    "start": "1083310",
    "end": "1090060"
  },
  {
    "text": "your your permissions are and there you may find that your scope may be limited due to the collection capability you may",
    "start": "1090060",
    "end": "1097020"
  },
  {
    "text": "have problems with credentials and so this is really leading into kind of the",
    "start": "1097020",
    "end": "1102930"
  },
  {
    "text": "last point which is the most important is documenting everything up until that point that you've excluded so this is",
    "start": "1102930",
    "end": "1109770"
  },
  {
    "start": "1104000",
    "end": "1167000"
  },
  {
    "text": "what's gonna really make this be a cycle rather than a one-off event what things are you not able to do so if you're",
    "start": "1109770",
    "end": "1115380"
  },
  {
    "text": "looking at an apt report and you're focusing on one technique what are the other techniques that were included that",
    "start": "1115380",
    "end": "1120390"
  },
  {
    "text": "you you put to the side those aren't forgotten forever those are just fodder for a next hypothesis and so",
    "start": "1120390",
    "end": "1127140"
  },
  {
    "text": "you can use this to identify if you have technical limitations that you're identifying over this process for",
    "start": "1127140",
    "end": "1133050"
  },
  {
    "text": "collection that's gonna be really good to inform those technology purchases so when a vendor comes and says you should",
    "start": "1133050",
    "end": "1138150"
  },
  {
    "text": "buy our tool you can identify the areas where you need coverage and and they can identify then okay you're covering",
    "start": "1138150",
    "end": "1144060"
  },
  {
    "text": "things that I already have or this is really meeting a requirement that I need and it also can help for if if you're",
    "start": "1144060",
    "end": "1150840"
  },
  {
    "text": "constantly having things excluded from the scope for like production systems this can help quantify overtime you have",
    "start": "1150840",
    "end": "1156420"
  },
  {
    "text": "not been able to look at these all these types of things on those production systems so it can kind of help for",
    "start": "1156420",
    "end": "1161640"
  },
  {
    "text": "leadership to understand what the scope limitations may be impacting so at the",
    "start": "1161640",
    "end": "1168360"
  },
  {
    "start": "1167000",
    "end": "1189000"
  },
  {
    "text": "end of this what do we have well you should have a specific behavior that you understand that you're you you know what",
    "start": "1168360",
    "end": "1173970"
  },
  {
    "text": "the technique is you have a better understanding because you spent the time digging into this one aspect of it and then the knowledge of what data you need",
    "start": "1173970",
    "end": "1180240"
  },
  {
    "text": "to collect specifically to detect that activity and that's really where you would then transition over and perform",
    "start": "1180240",
    "end": "1186060"
  },
  {
    "text": "that hunt app you've done this next slide so what's the benefit of this like",
    "start": "1186060",
    "end": "1191220"
  },
  {
    "start": "1189000",
    "end": "1237000"
  },
  {
    "text": "I said at the beginning it really focuses and at the end you would have a specific targeted tactic technique and",
    "start": "1191220",
    "end": "1197430"
  },
  {
    "text": "per set of procedures and you will be able to at the end say yes this is this was found or was not found",
    "start": "1197430",
    "end": "1204649"
  },
  {
    "text": "in my environment you can transfer those high confidence low false positive alerts over to your sock and then use",
    "start": "1204649",
    "end": "1210679"
  },
  {
    "text": "this to kind of iteratively bring your entire detection baseline forward and the biggest thing that we like is if you",
    "start": "1210679",
    "end": "1217639"
  },
  {
    "text": "have a you have this all documented out and a new attack report comes out a new apt if you go and you match this up",
    "start": "1217639",
    "end": "1224450"
  },
  {
    "text": "against we're currently looking for this set of techniques if you can map the techniques and these new reports that",
    "start": "1224450",
    "end": "1230029"
  },
  {
    "text": "come out you're gonna already know areas where you're either vulnerable to missing detection Zoar where you can potentially find them slide so with that",
    "start": "1230029",
    "end": "1238700"
  },
  {
    "text": "that's the background process Jarrod's now going to walk through an actual implementation of this for detecting",
    "start": "1238700",
    "end": "1244339"
  },
  {
    "text": "access token manipulation cool Thank You Robbie so we're going to for the case study we're going to use a notional",
    "start": "1244339",
    "end": "1250489"
  },
  {
    "text": "company which the situation that they're going to be kind of operating under is a conglomeration of all the different some",
    "start": "1250489",
    "end": "1257269"
  },
  {
    "text": "of the shortcomings that we've seen in security programs and so the general idea to kick off this hypothesis is that",
    "start": "1257269",
    "end": "1263299"
  },
  {
    "text": "our CISO went to DEFCON and black had a couple years ago and saw a presentation about PowerShell Empire right and so he",
    "start": "1263299",
    "end": "1270769"
  },
  {
    "text": "saw PowerShell Empire he came back and he said hey guys can we detect PowerShell Empire right and so when he",
    "start": "1270769",
    "end": "1277460"
  },
  {
    "text": "asked that question he's really kind of asking three things right so it's there's a couple implicit questions one",
    "start": "1277460",
    "end": "1282710"
  },
  {
    "text": "is can we detect PowerShell Empire whatever that means can we stop it and have we are we currently affected by",
    "start": "1282710",
    "end": "1289309"
  },
  {
    "text": "somebody using PowerShell Empire to give you a background of kind of the situation of our notional company we",
    "start": "1289309",
    "end": "1295639"
  },
  {
    "text": "have a very small security budget right so that means we don't have these expensive tools on the endpoints we",
    "start": "1295639",
    "end": "1301309"
  },
  {
    "text": "don't have any like agent based monitoring we also have poor lateral Network visibility so we're not able to",
    "start": "1301309",
    "end": "1307190"
  },
  {
    "text": "see that host-to-host communication going on we can only see network traffic as it's exiting the the network and",
    "start": "1307190",
    "end": "1313119"
  },
  {
    "text": "everybody in the company is a local administrator on their own machine right everybody kind of I saw some people",
    "start": "1313119",
    "end": "1319009"
  },
  {
    "text": "giggle but that's a real situation and lots of companies so the reality is is",
    "start": "1319009",
    "end": "1324139"
  },
  {
    "text": "that this is o--'s he's focusing on Empire right Empire is just a tool but what he really wants to know is like can",
    "start": "1324139",
    "end": "1331190"
  },
  {
    "text": "we detect the capabilities that Empire employing right and so we go to the next slide we're going to kind of break down",
    "start": "1331190",
    "end": "1337610"
  },
  {
    "start": "1336000",
    "end": "1396000"
  },
  {
    "text": "the tactics and techniques that are built into Empire and so for those that aren't familiar Empire is a powershell",
    "start": "1337610",
    "end": "1343310"
  },
  {
    "text": "remote access toolkit and it employs pretty much the entire gamut of attack techniques and so we've list that we ran",
    "start": "1343310",
    "end": "1350300"
  },
  {
    "text": "out of slide space but we generally listed out some of the tactics and techniques that it employs and things like privilege escalation right so",
    "start": "1350300",
    "end": "1356090"
  },
  {
    "text": "access token manipulation bypassing user account control there's a DLL injection",
    "start": "1356090",
    "end": "1361280"
  },
  {
    "text": "component to it it also has a Mimi katz component so you could do credential dumping you could pass the hash using",
    "start": "1361280",
    "end": "1367550"
  },
  {
    "text": "using Empire you can also do things like golden and silver tickets and you can literally move via WM IPS exec all those",
    "start": "1367550",
    "end": "1374870"
  },
  {
    "text": "types of common techniques now as as you probably assumed from the title of the talk we're going to just select access",
    "start": "1374870",
    "end": "1381980"
  },
  {
    "text": "token manipulation as the single technique that we're going to look for because if we look for all of this we're",
    "start": "1381980",
    "end": "1388370"
  },
  {
    "text": "just going to be in over our heads right that's too much for an individual to look at at one time to try to detect and so we're going to focus on one thing and",
    "start": "1388370",
    "end": "1395090"
  },
  {
    "text": "the reason why we focus on it is who here has done something like this right so or seen this right so the very first",
    "start": "1395090",
    "end": "1402140"
  },
  {
    "start": "1396000",
    "end": "1533000"
  },
  {
    "text": "command like everybody's first meterpreter command is get system right and what get system does is it's going",
    "start": "1402140",
    "end": "1407870"
  },
  {
    "text": "to steal the system token and apply it to your current process so that you can execute as if you're in the system user",
    "start": "1407870",
    "end": "1414920"
  },
  {
    "text": "context right and so that is an example of access token manipulation and because",
    "start": "1414920",
    "end": "1420950"
  },
  {
    "text": "of that that's something that we decided that we wanted to focus on all right so when we talk about the procedures we",
    "start": "1420950",
    "end": "1426980"
  },
  {
    "text": "have this general technique access token manipulation but we want to understand like how is access token manipulation",
    "start": "1426980",
    "end": "1434150"
  },
  {
    "text": "actually executed are there different ways that an attacker can employ this technique and so if we go to the next slide we want the like a general",
    "start": "1434150",
    "end": "1441560"
  },
  {
    "text": "understanding so we can go to that mitre attack framework and we can query say like what is it access token",
    "start": "1441560",
    "end": "1447560"
  },
  {
    "text": "manipulation and it will say basically windows uses access tokens to determine",
    "start": "1447560",
    "end": "1452750"
  },
  {
    "text": "the security context of a process or thread that's running on a system however there is this concept in Windows",
    "start": "1452750",
    "end": "1459080"
  },
  {
    "text": "called token impersonation or impersonation in general that allows a process to apply a different user",
    "start": "1459080",
    "end": "1465650"
  },
  {
    "text": "security context at the thread level and so basically a process can operate as a different user",
    "start": "1465650",
    "end": "1472080"
  },
  {
    "text": "for certain context and so attackers have found out that they can use this impersonation concept to basically",
    "start": "1472080",
    "end": "1478710"
  },
  {
    "text": "operate as a different user to achieve some effect that they want so in this case if I'm a admin user but I want to",
    "start": "1478710",
    "end": "1484920"
  },
  {
    "text": "do something on behalf of the system or like the the Windows root account then I would be able to steal the system token",
    "start": "1484920",
    "end": "1491220"
  },
  {
    "text": "and then kind of assume that identity and so as we're going through we have a lot of red teamers that work with us and",
    "start": "1491220",
    "end": "1497400"
  },
  {
    "text": "so we kind of talk through some of the different token techniques or procedures that they're using and we kind of broken",
    "start": "1497400",
    "end": "1503520"
  },
  {
    "text": "into three three groups so there's token impersonation or theft this is that get system token kind of kind of attack",
    "start": "1503520",
    "end": "1510540"
  },
  {
    "text": "where you literally just steal a currently residing access token from a different process create a process with",
    "start": "1510540",
    "end": "1517200"
  },
  {
    "text": "a token which is you still a token and then you create a brand new process with that token and then make an impersonate",
    "start": "1517200",
    "end": "1522960"
  },
  {
    "text": "token this is where the token isn't readily available to you but you have something like a username and password and so you would then go ahead and",
    "start": "1522960",
    "end": "1529110"
  },
  {
    "text": "create a token and then go ahead and steal that and impersonate it so next",
    "start": "1529110",
    "end": "1534180"
  },
  {
    "start": "1533000",
    "end": "1623000"
  },
  {
    "text": "slide - to understand how all of this works and maybe the type of information that we need to gather we really need to",
    "start": "1534180",
    "end": "1541140"
  },
  {
    "text": "understand how Windows authentication works in general right and so generally speaking when a user sits at a computer",
    "start": "1541140",
    "end": "1547800"
  },
  {
    "text": "and authenticates to that to that system if it's a Windows operating system it's going to instantiate a logon session and",
    "start": "1547800",
    "end": "1553680"
  },
  {
    "text": "these logon sessions are are managed by the local security authority or as most of us know like the L SAS process right",
    "start": "1553680",
    "end": "1560370"
  },
  {
    "text": "and so your credentials are going to be stored in else a sexy and that's why I like Mimi Kats works right it pulls",
    "start": "1560370",
    "end": "1566730"
  },
  {
    "text": "those credentials from LS s and those credentials are used for single sign-on so like when you try to access your",
    "start": "1566730",
    "end": "1573000"
  },
  {
    "text": "network file shares it's not going to prompt you for your username and password every time because you've already stored those inside of else s",
    "start": "1573000",
    "end": "1579600"
  },
  {
    "text": "and so when I say credentials just for clarification I don't just mean user name and password I mean things like",
    "start": "1579600",
    "end": "1585300"
  },
  {
    "text": "ntlm hashes Kerberos tickets plaintext passwords so on and so forth now every",
    "start": "1585300",
    "end": "1591750"
  },
  {
    "text": "single every single process and thread is going to have an access token associated with it and that access token",
    "start": "1591750",
    "end": "1597330"
  },
  {
    "text": "is going to be related to the logon session right so I'll as the jared user account i create a",
    "start": "1597330",
    "end": "1602520"
  },
  {
    "text": "logon session for that user and then there's an access token which is going to be granted to every process that's",
    "start": "1602520",
    "end": "1608160"
  },
  {
    "text": "spawned from that logon session and so a general kind of flow here is you put in",
    "start": "1608160",
    "end": "1613950"
  },
  {
    "text": "your credential a logon session that's created which has an access token which is then given to threads or processes",
    "start": "1613950",
    "end": "1619500"
  },
  {
    "text": "that are created on that logon sessions behalf next slide all right so generally speaking when",
    "start": "1619500",
    "end": "1626160"
  },
  {
    "text": "we're talking about access token manipulation a lot of people kind of have like a misunderstanding of the",
    "start": "1626160",
    "end": "1631470"
  },
  {
    "text": "difference between like delegation and impersonation tokens and network logons and non network logons and so we see a",
    "start": "1631470",
    "end": "1638670"
  },
  {
    "text": "lot of guidance that says things like oh when you're if you're an attacker if you're trying to impersonate a token",
    "start": "1638670",
    "end": "1644190"
  },
  {
    "text": "make sure that it's a delegation token and not an impersonation token and so we won't get into that right now but that",
    "start": "1644190",
    "end": "1650640"
  },
  {
    "text": "that advice is incorrect the thing that really matters is the type of logon remember the credentials are stored in",
    "start": "1650640",
    "end": "1656640"
  },
  {
    "text": "the logon session not in the access token so the type of access token doesn't necessarily matter it's really",
    "start": "1656640",
    "end": "1662790"
  },
  {
    "text": "how the logon session was created and so generally speaking if a logon session is",
    "start": "1662790",
    "end": "1668280"
  },
  {
    "text": "of a network type meaning something like WM I win RM which is powershell remoting",
    "start": "1668280",
    "end": "1673830"
  },
  {
    "text": "then the the actual credentials are not passed the remote system and thus those",
    "start": "1673830",
    "end": "1679560"
  },
  {
    "text": "credentials aren't available for credential dumping attacks or access token like token theft on the other hand",
    "start": "1679560",
    "end": "1685830"
  },
  {
    "text": "if you do a non-network or interactive logon something like console access so sitting at the computer or RDP then",
    "start": "1685830",
    "end": "1692400"
  },
  {
    "text": "you're actually passing your credentials to the remote system you're passing that creating a new access token and thus an",
    "start": "1692400",
    "end": "1697890"
  },
  {
    "text": "attacker can take advantage of that instill that so the implication here is that as a as a defender or an admin you",
    "start": "1697890",
    "end": "1704250"
  },
  {
    "text": "want to make sure that you're using those network logon types so type such logon session type 3 whenever you're",
    "start": "1704250",
    "end": "1710340"
  },
  {
    "text": "doing remote administration to be as secure as possible all right so I've mentioned access token a few times what",
    "start": "1710340",
    "end": "1717330"
  },
  {
    "start": "1714000",
    "end": "1788000"
  },
  {
    "text": "is what is an access token well an access token is a data structure that's stored in the in the kernel and it",
    "start": "1717330",
    "end": "1723540"
  },
  {
    "text": "basically provides or describes the security context of a process or thread to which it's applied the types of",
    "start": "1723540",
    "end": "1730410"
  },
  {
    "text": "information that are inside of an access token are like the user user security identifiers or CID the group",
    "start": "1730410",
    "end": "1737200"
  },
  {
    "text": "said so what groups does this user belong to are they a domain admin are they a local administrator so on and so",
    "start": "1737200",
    "end": "1742510"
  },
  {
    "text": "forth a list of prist of privileges for the users and groups so does this user have",
    "start": "1742510",
    "end": "1747940"
  },
  {
    "text": "like se debug privilege do they have the ability to shut down the computer can they can they perform impersonation the",
    "start": "1747940",
    "end": "1755140"
  },
  {
    "text": "token integrity level so a lot of times attackers will talk about like bypass UAC and you know the the USC prompt that",
    "start": "1755140",
    "end": "1761559"
  },
  {
    "text": "pops up and says do you want to be an administrator the integrity level is going to basically dictate whether that",
    "start": "1761559",
    "end": "1767679"
  },
  {
    "text": "token has the ability to act on the behalf of an administrator and in the impersonation level and a couple a list",
    "start": "1767679",
    "end": "1774580"
  },
  {
    "text": "of restricting SIDS so let's say I have an it I have an administrator account but I don't want to provide that that",
    "start": "1774580",
    "end": "1782110"
  },
  {
    "text": "access to the full access of that administrator account to a process you can restrict some of its privileges and",
    "start": "1782110",
    "end": "1787600"
  },
  {
    "text": "capabilities and then going back to kind of that delegation versus an",
    "start": "1787600",
    "end": "1792790"
  },
  {
    "start": "1788000",
    "end": "1842000"
  },
  {
    "text": "impersonation concept there's two two types of tokens so there's primary tokens and those are tokens that are",
    "start": "1792790",
    "end": "1799120"
  },
  {
    "text": "applied at the process level and then there's so every process is going to have a primary token and then there's",
    "start": "1799120",
    "end": "1805360"
  },
  {
    "text": "what they call impersonation tokens and these are tokens that are created via impersonation that concept I talked",
    "start": "1805360",
    "end": "1811570"
  },
  {
    "text": "about and these are going to be applied at the thread level so an impersonation token only dictates the security context",
    "start": "1811570",
    "end": "1818200"
  },
  {
    "text": "of an individual thread not an entire process and then there's a within kind of the subcategory of impersonation",
    "start": "1818200",
    "end": "1824559"
  },
  {
    "text": "there's these four different impersonation levels from the top is anonymous all the way down to delegation",
    "start": "1824559",
    "end": "1829870"
  },
  {
    "text": "and I'll let you kind of take a look at that but generally from the top it's the most restrictive and the bottom is the",
    "start": "1829870",
    "end": "1834910"
  },
  {
    "text": "least restrictive so delegation would allow that access token to pass its information to another system next slide",
    "start": "1834910",
    "end": "1841809"
  },
  {
    "text": "all right so again just a general overview every process has a primary token and that describes again the",
    "start": "1841809",
    "end": "1848590"
  },
  {
    "start": "1842000",
    "end": "1865000"
  },
  {
    "text": "security context of the user by default threads are going to inherent inherit",
    "start": "1848590",
    "end": "1854470"
  },
  {
    "text": "that primary token from the process but you can do impersonation which will give",
    "start": "1854470",
    "end": "1860260"
  },
  {
    "text": "the thread a completely different user context next slide all right so let's",
    "start": "1860260",
    "end": "1867160"
  },
  {
    "start": "1865000",
    "end": "1934000"
  },
  {
    "text": "talk about token impersonation right this is like the most common thing that uh that that you",
    "start": "1867160",
    "end": "1872230"
  },
  {
    "text": "would ever come across so if you've ever used meterpreter or PowerShell Empire and you've done like steal token that",
    "start": "1872230",
    "end": "1877360"
  },
  {
    "text": "type of attack this is this is what I'm talking about right so there's a user let's say your runt you you fish into a",
    "start": "1877360",
    "end": "1883990"
  },
  {
    "text": "system and you gain access running as you know Bob the guy in HR or something like that Bob doesn't have a lot of",
    "start": "1883990",
    "end": "1890140"
  },
  {
    "text": "privilege but there's probably somebody you know or like a system account being",
    "start": "1890140",
    "end": "1895150"
  },
  {
    "text": "run somewhere so like LSS is running that system when log on so on and so forth and so if I want to become system",
    "start": "1895150",
    "end": "1900610"
  },
  {
    "text": "all I have to do is impersonate that access token apply it to myself and now everything I do from that threads",
    "start": "1900610",
    "end": "1906490"
  },
  {
    "text": "context is going to be running as a system account to do this from the API level you're going to use get a handle",
    "start": "1906490",
    "end": "1913450"
  },
  {
    "text": "to that process using an open process then you could call duplicate token or duplicate token e^x to get a copy of",
    "start": "1913450",
    "end": "1920470"
  },
  {
    "text": "that actual token itself and then you could use either impersonate logged on user or set thread token to apply that",
    "start": "1920470",
    "end": "1926530"
  },
  {
    "text": "token at that thread level and so I'm sure a lot of people know malware unicorn she helped me kind of build some",
    "start": "1926530",
    "end": "1932590"
  },
  {
    "text": "visualizations of how this actually works and so here we are PowerShell at exe is basically opening a process",
    "start": "1932590",
    "end": "1938560"
  },
  {
    "start": "1934000",
    "end": "1958000"
  },
  {
    "text": "handle to win log on here and then we're going to call duplicate Oken to duplicate that system token into our",
    "start": "1938560",
    "end": "1944470"
  },
  {
    "text": "powershell exe context and notice I'm running as like John Doe inside a PowerShell then I call set threaded",
    "start": "1944470",
    "end": "1950710"
  },
  {
    "text": "token and I apply that system token to my thread and then that thread starts running as system right so that's the",
    "start": "1950710",
    "end": "1956350"
  },
  {
    "text": "general idea there all right so the next situation would be create a process",
    "start": "1956350",
    "end": "1962200"
  },
  {
    "start": "1958000",
    "end": "2043000"
  },
  {
    "text": "where they token and so a reason why an attacker might want to do this is let's say let's say that your security program",
    "start": "1962200",
    "end": "1968620"
  },
  {
    "text": "locks everything down to where only Internet Explorer or other web browsers are allowed to make like port 80 or port",
    "start": "1968620",
    "end": "1974800"
  },
  {
    "text": "443 traffic right or communicate with the web proxy well as an attacker I want",
    "start": "1974800",
    "end": "1981070"
  },
  {
    "text": "to basically make sure that I'm living within one of those browser processes but they're kind of fickle because a",
    "start": "1981070",
    "end": "1986380"
  },
  {
    "text": "user controls a browser right so at any time they could just kill that browser and I'll lose my access but what I might",
    "start": "1986380",
    "end": "1991750"
  },
  {
    "text": "want to do is create a brand new Internet Explorer process kind of in the background move into that so that I get",
    "start": "1991750",
    "end": "1997480"
  },
  {
    "text": "by the security the security feature but also the user isn't going to just kill this internet explorer process that I created",
    "start": "1997480",
    "end": "2004020"
  },
  {
    "text": "and so I could do pretty much the same same thing that I did with the previous attack except after I duplicate my token",
    "start": "2004020",
    "end": "2010590"
  },
  {
    "text": "I'm going to use create process with token W to create a brand new process using that token the caveat here is that",
    "start": "2010590",
    "end": "2017610"
  },
  {
    "text": "that token is going to be applied at the process level not at the thread level like the previous attack and so we have",
    "start": "2017610",
    "end": "2023309"
  },
  {
    "text": "another kind of demonstration here so PowerShell dot exe opens the process to explorer.exe then it's going to",
    "start": "2023309",
    "end": "2030360"
  },
  {
    "text": "duplicate that domain admin token and then we're going to create a new process",
    "start": "2030360",
    "end": "2035790"
  },
  {
    "text": "called malicious dot exe whatever you want to call it and apply that domain admin token to it so now we have a new",
    "start": "2035790",
    "end": "2041940"
  },
  {
    "text": "process running as domain admin next slide so another really cool attack is",
    "start": "2041940",
    "end": "2047100"
  },
  {
    "start": "2043000",
    "end": "2125000"
  },
  {
    "text": "this make an impersonate token so up until now we've only been able to duplicate or impersonate tokens for",
    "start": "2047100",
    "end": "2053460"
  },
  {
    "text": "users that are currently logged on to the system that we have access to right in this case there may be a situation",
    "start": "2053460",
    "end": "2059190"
  },
  {
    "text": "that you come across credentials kind of in your attacker life cycle or whatever that you that you want to use but you",
    "start": "2059190",
    "end": "2066210"
  },
  {
    "text": "don't have that user logged in so you can't necessarily impersonate that user let's say you're like combing through",
    "start": "2066210",
    "end": "2071610"
  },
  {
    "text": "file shares and you find an admin who's left their passwords in a text file somewhere or a batch script now I have",
    "start": "2071610",
    "end": "2077580"
  },
  {
    "text": "those credentials I can use the logon user function and set the DW logon type",
    "start": "2077580",
    "end": "2083070"
  },
  {
    "text": "parameter to logon 30 to logon new credentials which is a type 9 logon and",
    "start": "2083070",
    "end": "2088290"
  },
  {
    "text": "pass those credentials to create a completely new logon session has anybody anybody familiar with like run a slash",
    "start": "2088290",
    "end": "2094679"
  },
  {
    "text": "net only like that that type of being able to run as a separate user this is the same functionality that that's",
    "start": "2094679",
    "end": "2100230"
  },
  {
    "text": "performing at the API level and so what this does is it creates a new logon",
    "start": "2100230",
    "end": "2105270"
  },
  {
    "text": "session of type new credentials which is kind of important and it's going to create a token that's kind of a dual",
    "start": "2105270",
    "end": "2111780"
  },
  {
    "text": "token so locally I'm going to run as the original user that I was that I called logon user as but on the network I'm",
    "start": "2111780",
    "end": "2119250"
  },
  {
    "text": "going to be able to authenticate using the credentials that I pass through the logon user function right and so if we",
    "start": "2119250",
    "end": "2125460"
  },
  {
    "start": "2125000",
    "end": "2192000"
  },
  {
    "text": "go ahead and go to the next slide this will hopefully make more sense so I'm going to call logon user and pass this domain admin username and password right",
    "start": "2125460",
    "end": "2132120"
  },
  {
    "text": "it's going to create a new logon potential session or new credentials logon session with a John Doe local user",
    "start": "2132120",
    "end": "2138859"
  },
  {
    "text": "and a domain admin network user and then that's going to be applied to my thread and everything if if you just query the",
    "start": "2138859",
    "end": "2145369"
  },
  {
    "text": "access token it will appear to be running as John Doe but then when I make my network connection I'll be running as domain",
    "start": "2145369",
    "end": "2150710"
  },
  {
    "text": "admin so it's it's kind of a little still a little more stealthy and than just stealing the token next slide all",
    "start": "2150710",
    "end": "2156890"
  },
  {
    "text": "right so we've identified some procedures three different procedures but in my mind there's one that kind of",
    "start": "2156890",
    "end": "2163849"
  },
  {
    "text": "stands out as being different than the others and so that create a process with token kind of attack is doing a process",
    "start": "2163849",
    "end": "2170750"
  },
  {
    "text": "level token impersonation right instead of that applying the token at the thread level and because of that the detection",
    "start": "2170750",
    "end": "2177200"
  },
  {
    "text": "will be slightly different and so for that reason we've just decided to put that off kind of as an excluded factor",
    "start": "2177200",
    "end": "2182839"
  },
  {
    "text": "for now we'll come back to that maybe next week or at some some time later and so we're gonna focus on token",
    "start": "2182839",
    "end": "2188089"
  },
  {
    "text": "impersonation or token theft and create an impersonate token going forward in this hypothesis all right so our",
    "start": "2188089",
    "end": "2195170"
  },
  {
    "start": "2192000",
    "end": "2237000"
  },
  {
    "text": "collection requirements at this point we want to start determining what type of information do we need like what do we",
    "start": "2195170",
    "end": "2200690"
  },
  {
    "text": "need to collect in order to determine that this activity has happened in our environment so there's a few like open",
    "start": "2200690",
    "end": "2205849"
  },
  {
    "text": "source tools that perform access token manipulations so one is incognito that's kind of the the old standard right and",
    "start": "2205849",
    "end": "2211789"
  },
  {
    "text": "that that's built into meterpreter invoke token manipulation is a PowerShell implementation that's built",
    "start": "2211789",
    "end": "2216799"
  },
  {
    "text": "into power sploit or PowerShell Empire and then like a cobalt strike is an example of a a paid product that has",
    "start": "2216799",
    "end": "2223630"
  },
  {
    "text": "token manipulation capabilities and so at this point we want to collect all of our relevant data points and the first",
    "start": "2223630",
    "end": "2229730"
  },
  {
    "text": "thing that comes to mind is we probably want to collect the access tokens right from every process and every every thread and so we'll start there and kind",
    "start": "2229730",
    "end": "2236180"
  },
  {
    "text": "of see what we can do from there alright so collecting access tokens you do you do your research and you come up",
    "start": "2236180",
    "end": "2242329"
  },
  {
    "start": "2237000",
    "end": "2285000"
  },
  {
    "text": "with kind of this this functionality to collect them right and so PowerShell for",
    "start": "2242329",
    "end": "2247640"
  },
  {
    "text": "I'm a PowerShell fanboy PowerShell does not have a capability natively to collect access tokens and so we had to",
    "start": "2247640",
    "end": "2254270"
  },
  {
    "text": "go through and actually write our own script and basically what we do is we iterate through every process and every",
    "start": "2254270",
    "end": "2259940"
  },
  {
    "text": "thread on the machine and call open process or open thread depending on whether it's the processor thread that",
    "start": "2259940",
    "end": "2265369"
  },
  {
    "text": "returns a handle to us then we call open or open thread token which gives us a handle to the token and then we could",
    "start": "2265369",
    "end": "2272030"
  },
  {
    "text": "call get token information which allows us to query like who's the user that this token belongs to who is what groups",
    "start": "2272030",
    "end": "2278840"
  },
  {
    "text": "does it belong to what are the privileges so on and so forth and we regain that context about what's happening next slide and so at the end",
    "start": "2278840",
    "end": "2286100"
  },
  {
    "start": "2285000",
    "end": "2308000"
  },
  {
    "text": "we end up with a powershell script called get access token which is available on github and we end up having",
    "start": "2286100",
    "end": "2292070"
  },
  {
    "text": "things like what is the process context so this is application frame host what's the username that this is running as in",
    "start": "2292070",
    "end": "2298490"
  },
  {
    "text": "this case just a tester user the groups are here like it's a primary token and",
    "start": "2298490",
    "end": "2304250"
  },
  {
    "text": "so on and so forth and you have all this context about what's happening with that token so if we go to the next slide and",
    "start": "2304250",
    "end": "2309590"
  },
  {
    "start": "2308000",
    "end": "2372000"
  },
  {
    "text": "so when we start to look at impersonation impersonations a legitimate thing in the Windows",
    "start": "2309590",
    "end": "2315110"
  },
  {
    "text": "operating system so we can't just say oh if it's I'm using an impersonation that it's bad we need to kill it but",
    "start": "2315110",
    "end": "2320630"
  },
  {
    "text": "generally speaking impersonation is used for very specific reasons and so that's those reasons would be something like",
    "start": "2320630",
    "end": "2327490"
  },
  {
    "text": "SVC host which is a like a service hosting process right which has two",
    "start": "2327490",
    "end": "2333590"
  },
  {
    "text": "hosts multiple different services and some of those services may want to run as a different user and so in that case",
    "start": "2333590",
    "end": "2339530"
  },
  {
    "text": "SB CEOs would use impersonation to allow a portion of its basically memory space",
    "start": "2339530",
    "end": "2345800"
  },
  {
    "text": "to be run run as a separate user than what it was initially started as and so at the bottom we see the primary user so",
    "start": "2345800",
    "end": "2353480"
  },
  {
    "text": "SVC OS was started as system but it later on impersonates and one of its threads the",
    "start": "2353480",
    "end": "2358880"
  },
  {
    "text": "tester user and so generally speaking we see that we're going from the system mandatory level to the medium mandatory",
    "start": "2358880",
    "end": "2365030"
  },
  {
    "text": "level and in this case we're going from like a higher privileged user to a lower privileged user which generally is kind",
    "start": "2365030",
    "end": "2370760"
  },
  {
    "text": "of a safe a safe concept but when somebody runs get system this is what this looks like so the primary user name",
    "start": "2370760",
    "end": "2377330"
  },
  {
    "start": "2372000",
    "end": "2400000"
  },
  {
    "text": "is tester right so a lower privileged user and the impersonated user at the top here is empty Authority system and",
    "start": "2377330",
    "end": "2383540"
  },
  {
    "text": "so this would be a situation where somebody has basically escalated their privilege level based on token",
    "start": "2383540",
    "end": "2389990"
  },
  {
    "text": "impersonation and so we can kind of identify that especially when it's running from something like powershell XE which has no there's no reason why",
    "start": "2389990",
    "end": "2396620"
  },
  {
    "text": "powershell should be impersonating different users all right so",
    "start": "2396620",
    "end": "2401720"
  },
  {
    "start": "2400000",
    "end": "2436000"
  },
  {
    "text": "at Derby con Robbie and I talked about detecting golden ticket attacks and so one of the things that we kind of",
    "start": "2401720",
    "end": "2407090"
  },
  {
    "text": "stumbled upon is a way to help detect that second situation where an attacker makes a token and then then impersonates",
    "start": "2407090",
    "end": "2413540"
  },
  {
    "text": "it and so one thing that we would want to collect in this case is ticket granting ticket so Kerberos ticket",
    "start": "2413540",
    "end": "2419480"
  },
  {
    "text": "granting ticket and so the way that you do this is by querying all the LSA functions so basically you query the the",
    "start": "2419480",
    "end": "2426440"
  },
  {
    "text": "logon sessions and then every logon session you query and ask hey do you have a Kerberos ticket granting ticket if it does it returns and then you can",
    "start": "2426440",
    "end": "2433160"
  },
  {
    "text": "analyze it from there all right and then you have a script called get Kerberos",
    "start": "2433160",
    "end": "2438830"
  },
  {
    "start": "2436000",
    "end": "2487000"
  },
  {
    "text": "ticket granting ticket and generally speaking you're going to have at the bottom the information about the logon session that that ticket belongs to and",
    "start": "2438830",
    "end": "2445130"
  },
  {
    "text": "you're going to at the top the information about the ticket itself again in general when I log on to a system I'm going to log on as the jared",
    "start": "2445130",
    "end": "2452359"
  },
  {
    "text": "user account and then i'm going to i'm going to request a Kerberos ticket granting ticket for my user account",
    "start": "2452359",
    "end": "2457880"
  },
  {
    "text": "right like generally speaking I don't log in and then get his Kerberos ticket granting ticket that just doesn't make",
    "start": "2457880",
    "end": "2463460"
  },
  {
    "text": "sense and so we kind of compare the logon session user to the actual the",
    "start": "2463460",
    "end": "2469250"
  },
  {
    "text": "actual ticket user itself so next slide but not an example of a benign ticket would be down here we have a logon",
    "start": "2469250",
    "end": "2476150"
  },
  {
    "text": "session for the local admin user and the citadel doc over deist a local domain and at the top we have the client of the",
    "start": "2476150",
    "end": "2482750"
  },
  {
    "text": "ticket is local admin and the domain is citadel a cover yourself ocol again that's what we expect next slide now",
    "start": "2482750",
    "end": "2489050"
  },
  {
    "start": "2487000",
    "end": "2517000"
  },
  {
    "text": "this is evidence of kind of that make token attack so we see the new credentials logon type at the bottom and",
    "start": "2489050",
    "end": "2494630"
  },
  {
    "text": "we see that the user of the session is just this local local user named John right but at the top we see that they",
    "start": "2494630",
    "end": "2501320"
  },
  {
    "text": "had John requested a ticket for mmm writes underscore a which presumably is like an admin account right or some sort",
    "start": "2501320",
    "end": "2508040"
  },
  {
    "text": "of domain admin account at Citadel Dhaka various all local and like that John has no business having that ticket in his",
    "start": "2508040",
    "end": "2513859"
  },
  {
    "text": "logon session so we're going to investigate that going forward all right so from here we would want to we have",
    "start": "2513859",
    "end": "2519890"
  },
  {
    "start": "2517000",
    "end": "2559000"
  },
  {
    "text": "kind of an idea of what we want to collect Kerberos ticket Grant Achatz and access tokens for processes and threads",
    "start": "2519890",
    "end": "2524930"
  },
  {
    "text": "and then we want to go forward and identify what the scope of our kind of analysis or collection will be and so",
    "start": "2524930",
    "end": "2530180"
  },
  {
    "text": "again we have one week that's kind of what we're giving ourselves now you could determine whether that's efficient time or maybe too much time we",
    "start": "2530180",
    "end": "2537020"
  },
  {
    "text": "have three domains that we want to gather information from on those three domains we have one Linux server which is non domain join and Linux doesn't do",
    "start": "2537020",
    "end": "2544340"
  },
  {
    "text": "authentication in the same way so we're going to kind of exclude that we have nine Windows workstations and two",
    "start": "2544340",
    "end": "2549620"
  },
  {
    "text": "Windows servers we have no sensitive production system so we're able to query all eleven of those systems and so our",
    "start": "2549620",
    "end": "2556220"
  },
  {
    "text": "scope ends up being three domains eleven workstations next slide and then for excluded factors we're just",
    "start": "2556220",
    "end": "2562490"
  },
  {
    "start": "2559000",
    "end": "2595000"
  },
  {
    "text": "going to go through that list of tactics techniques kind of that we came up with during phase one of what Empire employs",
    "start": "2562490",
    "end": "2569120"
  },
  {
    "text": "kind of put those in the side document that we aren't currently looking at those and maybe we want to revisit them going forward and then kind of document",
    "start": "2569120",
    "end": "2576080"
  },
  {
    "text": "that we're not looking at that Linux server and as you're going to see one of the system's didn't allow us to query information from it because we couldn't",
    "start": "2576080",
    "end": "2582500"
  },
  {
    "text": "escalate to system it's kind of strange in order to query access tokens you have",
    "start": "2582500",
    "end": "2587570"
  },
  {
    "text": "and Kerberos ticket you have to become system yourself and so we're impersonating to detect",
    "start": "2587570",
    "end": "2592760"
  },
  {
    "text": "impersonation which is kind of a like a meta thing I guess all right so now we have a demo we're going to teach you how",
    "start": "2592760",
    "end": "2598340"
  },
  {
    "start": "2595000",
    "end": "3205000"
  },
  {
    "text": "to be a faceless man I guess and so here we go so I have a PowerShell prompt and I'm",
    "start": "2598340",
    "end": "2604220"
  },
  {
    "text": "going to establish a PowerShell remoting session with this training lab that we have so we teach a red team class which",
    "start": "2604220",
    "end": "2610340"
  },
  {
    "text": "I thought was like a perfect perfect place to look for these types of attacks and so we're going to establish that",
    "start": "2610340",
    "end": "2615860"
  },
  {
    "text": "session and we ended up having eleven sessions eleven PowerShell remoting sessions and maybe this isn't how you",
    "start": "2615860",
    "end": "2622070"
  },
  {
    "text": "want to collect the data it just is the easiest for me so you could determine what the best way to collect this data would be for you",
    "start": "2622070",
    "end": "2628100"
  },
  {
    "text": "all right so PowerShell has a command called invoke command which allows you to take a PowerShell remoting session and then execute arbitrary code or",
    "start": "2628100",
    "end": "2635390"
  },
  {
    "text": "arbitrary scripts against those sessions and so we're going to run this get access token script and we're going to",
    "start": "2635390",
    "end": "2641360"
  },
  {
    "text": "store that in a dollar token variable and so here you see that one system said hey you're not able to impersonate",
    "start": "2641360",
    "end": "2647270"
  },
  {
    "text": "anti-authority system and so we're going to get some subset of information from that from that system alright and so we",
    "start": "2647270",
    "end": "2656270"
  },
  {
    "text": "ended up with six hundred and thirty three different tokens that we're dealing with right and so we got to figure out how we're going to determine",
    "start": "2656270",
    "end": "2661880"
  },
  {
    "text": "where the bad tokens are within that again we're going to do the same thing but this time we're going to collect Kerberos ticket granting ticket from",
    "start": "2661880",
    "end": "2667790"
  },
  {
    "text": "across those eleven and so we have a gate Kerberos ticket granting ticket script that will run",
    "start": "2667790",
    "end": "2673280"
  },
  {
    "text": "against them and that comes back same situation with the system token there",
    "start": "2673280",
    "end": "2679910"
  },
  {
    "text": "and so that one system we don't have all that we only have a subset of the",
    "start": "2679910",
    "end": "2685040"
  },
  {
    "text": "tickets and tokens and so we end up with 76 tickets across 11 systems all right",
    "start": "2685040",
    "end": "2693170"
  },
  {
    "text": "so now let's let's take a look at what a token looks like I kind of show this already we have like the token for the con host process just kind of as an",
    "start": "2693170",
    "end": "2700910"
  },
  {
    "text": "example it's running as this MS sequel FD launcher user and we see that the",
    "start": "2700910",
    "end": "2706340"
  },
  {
    "text": "primary tows this is a primary token so we wanted to expect that field to be any different but how can we start whittling",
    "start": "2706340",
    "end": "2712460"
  },
  {
    "text": "down on these 633 different results right that's that's too much information",
    "start": "2712460",
    "end": "2717580"
  },
  {
    "text": "imagine if you ran it across thousands of computers and you know if it's just going to be an egregious amount and so",
    "start": "2717580",
    "end": "2724480"
  },
  {
    "text": "first things first we can exclude all primary tokens by definition a primary token is not an impersonation token and",
    "start": "2724480",
    "end": "2731390"
  },
  {
    "text": "thus we're not worried about them in the context of searching for token impersonation and so PowerShell has this",
    "start": "2731390",
    "end": "2738290"
  },
  {
    "text": "filtering commandlets called where object which allows you to filter out different objects based on some you know",
    "start": "2738290",
    "end": "2743750"
  },
  {
    "text": "some scripts so I'm saying where the token type is not token in token primary",
    "start": "2743750",
    "end": "2748850"
  },
  {
    "text": "so that reduces it down to 104 so we've reduced by you know 80 or 85 percent or",
    "start": "2748850",
    "end": "2756260"
  },
  {
    "text": "so and so now let's see what else we could do so now I want to look where the",
    "start": "2756260",
    "end": "2761660"
  },
  {
    "text": "primary the user account for the primary token is not the same as the user account for the impersonation token",
    "start": "2761660",
    "end": "2768230"
  },
  {
    "text": "right and so there are situations too where impersonation is used to impersonate the same user account because you want to either add or remove",
    "start": "2768230",
    "end": "2775040"
  },
  {
    "text": "privileges from that user but in this case we go down to 49 so now we could start maybe we could deal with that a",
    "start": "2775040",
    "end": "2781010"
  },
  {
    "text": "little bit better sorry for my slow typing here but there's what it is I",
    "start": "2781010",
    "end": "2786980"
  },
  {
    "text": "guess and so again we're going to query the same exact thing but this time I want to see the actual context of those",
    "start": "2786980",
    "end": "2793310"
  },
  {
    "text": "49 results and so again looking for non non primary tokens where a primary user",
    "start": "2793310",
    "end": "2800390"
  },
  {
    "text": "name and user name do not matter and then we're going to look at what process what process do these tokens",
    "start": "2800390",
    "end": "2805880"
  },
  {
    "text": "belong to what is the process ID what is the primary user accounts of what was what is that was that process spawned as",
    "start": "2805880",
    "end": "2813110"
  },
  {
    "text": "and then what is the user name so who is it impersonating and then we'll look at the computer that it's associated with",
    "start": "2813110",
    "end": "2818390"
  },
  {
    "text": "and if you notice and of course this is a lab so your your mileage may vary a little bit every single process is going",
    "start": "2818390",
    "end": "2824720"
  },
  {
    "text": "to be SVC host which is kind of what we expect that does not mean that because it's SVC host it's good it just means",
    "start": "2824720",
    "end": "2831020"
  },
  {
    "text": "that if it's not SVC host in this case we might be interested in it and what we noticed is that there's basically every",
    "start": "2831020",
    "end": "2838160"
  },
  {
    "text": "system kind of has one one process that's impersonating what looks like a DA so it's going from system to domain",
    "start": "2838160",
    "end": "2845000"
  },
  {
    "text": "admin so we might want to investigate that and so kind of check it out we're going to go ahead and look at this",
    "start": "2845000",
    "end": "2851180"
  },
  {
    "text": "particular process here so it's on 10.1 31 52 and it's process ID 920 and so",
    "start": "2851180",
    "end": "2859040"
  },
  {
    "text": "PowerShell remoting is awesome in my opinion because it allows you to get kind of like a remote shell on a system",
    "start": "2859040",
    "end": "2864260"
  },
  {
    "text": "and so what we're going to do is query use enter PS session to enter a",
    "start": "2864260",
    "end": "2869510"
  },
  {
    "text": "powershell get a PowerShell shell on that that 152 system and so you'll see",
    "start": "2869510",
    "end": "2877580"
  },
  {
    "text": "that you'll notice that the prompt is going to change to indicate that we are now running on a remote system and then",
    "start": "2877580",
    "end": "2883430"
  },
  {
    "text": "we could query I'm going to just SVC host as a hosting process which has a lot of services that belong to it and so",
    "start": "2883430",
    "end": "2890180"
  },
  {
    "text": "let's let's kind of check out what services there are so we see like I key I extension XE or something like that",
    "start": "2890180",
    "end": "2897650"
  },
  {
    "text": "IP help service land man server those those are the types of things that are running in within that particular SBC",
    "start": "2897650",
    "end": "2905090"
  },
  {
    "text": "host and that may help us identify if we do some research on those why it's using",
    "start": "2905090",
    "end": "2910190"
  },
  {
    "text": "the domain admin account but because we see that this is kind of a uniform pattern across all of our systems maybe",
    "start": "2910190",
    "end": "2915560"
  },
  {
    "text": "we want to go see and go check and make sure that that actual like kind of activity is really normal across all the",
    "start": "2915560",
    "end": "2921650"
  },
  {
    "text": "systems and not coincidental and so again we're going to do the same thing but on a separate system and we're going",
    "start": "2921650",
    "end": "2928880"
  },
  {
    "text": "to enter a session again on session ID 24 and just verify that that's kind of",
    "start": "2928880",
    "end": "2936110"
  },
  {
    "text": "normal activity in real life outside of a nine-minute demo you would go and like actually look up what those services are",
    "start": "2936110",
    "end": "2941540"
  },
  {
    "text": "and make sure that that type of impersonation is something that you would expect right that's kind of the general idea so here we're seeing 780 we",
    "start": "2941540",
    "end": "2951230"
  },
  {
    "text": "see that it's the same exact SVC host hosting the same exact services and so maybe this is something that's normal in",
    "start": "2951230",
    "end": "2957320"
  },
  {
    "text": "our environment and so we kind of leave the access token from the perspective of",
    "start": "2957320",
    "end": "2963890"
  },
  {
    "text": "you know all of these processes on every single system look like they're kind of doing the same thing you would want to",
    "start": "2963890",
    "end": "2969650"
  },
  {
    "text": "do a little bit more checking but generally speaking I think it's relatively safe to say that there is no",
    "start": "2969650",
    "end": "2975380"
  },
  {
    "text": "like malicious access token impersonation occurring here so let's let's look for the other attack",
    "start": "2975380",
    "end": "2981800"
  },
  {
    "text": "technique that we're interested in all right so let's query those Kerberos",
    "start": "2981800",
    "end": "2988280"
  },
  {
    "text": "tickets that we collected remember there's I think there's like 76 of them and so we could start to look at those",
    "start": "2988280",
    "end": "2994520"
  },
  {
    "text": "and see if there's any evidence of that make and impersonate kind of attack right so make make token and impersonate",
    "start": "2994520",
    "end": "3000340"
  },
  {
    "text": "and so the first thing that we're going to do is we're going to start whittling down on those 76 tickets by looking for",
    "start": "3000340",
    "end": "3007120"
  },
  {
    "text": "anything where the session username does not equal the client name right and again I said this was a training lab",
    "start": "3007120",
    "end": "3013870"
  },
  {
    "text": "from a red team class that we taught and so this is going to come back and have a ton of results that are evidence of like",
    "start": "3013870",
    "end": "3020680"
  },
  {
    "text": "malicious stuff not necessarily specifically what we're looking for and so we saw we whittled down from 76 to 26",
    "start": "3020680",
    "end": "3029080"
  },
  {
    "text": "and now we're going to look at the actual context here and we're going to look at I think the session ID or a",
    "start": "3029080",
    "end": "3035380"
  },
  {
    "text": "session logon ID the username of the like who logged in now on the session and then some information about the",
    "start": "3035380",
    "end": "3041470"
  },
  {
    "text": "ticket itself and of course the computer that that ticket is is on so we can",
    "start": "3041470",
    "end": "3047920"
  },
  {
    "text": "investigate further and so I think in going through this every single one of these happen to be malicious kind of in",
    "start": "3047920",
    "end": "3054160"
  },
  {
    "text": "their own right the the ones that we're kind of focusing on are the ones at the top the a Robin's da to Matt Nelson da",
    "start": "3054160",
    "end": "3061030"
  },
  {
    "text": "but for instance we see that John user kind of becoming Mike right there which",
    "start": "3061030",
    "end": "3066190"
  },
  {
    "text": "is pretty suspicious we see John user becoming sequel service which that's that's extremely strange in",
    "start": "3066190",
    "end": "3072130"
  },
  {
    "text": "my opinion but here we're seeing like it Andy Robbins da or a Robbins da becoming",
    "start": "3072130",
    "end": "3078370"
  },
  {
    "text": "an M Nelson da account and maybe doing something strange there and so let's go",
    "start": "3078370",
    "end": "3084070"
  },
  {
    "text": "check that out one of our colleagues Lee Christianson wrote a script that allows you to query query a list of processes",
    "start": "3084070",
    "end": "3091840"
  },
  {
    "text": "based on the logon session so given a logon session ID you're able to say what processes belong to this logon session",
    "start": "3091840",
    "end": "3099100"
  },
  {
    "text": "and so we could go in and start kind of querying specific processes within a logon session to determine what what the",
    "start": "3099100",
    "end": "3106030"
  },
  {
    "text": "context of that logon session is and that helps us determine whether something malicious is happening and so",
    "start": "3106030",
    "end": "3111690"
  },
  {
    "text": "here I've run that I've made sure that that script is available within my power shell remoting session and now we're",
    "start": "3111690",
    "end": "3118150"
  },
  {
    "text": "going to go ahead and enter that session and try to investigate some of these kind of weird weird Kerberos tickets all",
    "start": "3118150",
    "end": "3127780"
  },
  {
    "text": "right and our prompt is going to change indicate we're on that remote system and now I could do get logon session processes pass it a logon session ID",
    "start": "3127780",
    "end": "3135270"
  },
  {
    "text": "this is some pretty old activity so not all of these are going to have processes associated with them they're kind of",
    "start": "3135270",
    "end": "3140350"
  },
  {
    "text": "like dangling logon sessions and so we'll kind of work through them iteratively until we find something that's that's interesting for us all",
    "start": "3140350",
    "end": "3149020"
  },
  {
    "text": "right so the first one came back but there's no processes associated with that logon session second one same thing",
    "start": "3149020",
    "end": "3155370"
  },
  {
    "text": "but the third one I think is where we kind of strike gold and anybody that has",
    "start": "3155370",
    "end": "3160930"
  },
  {
    "text": "use PowerShell Empire might recognize this this is PowerShell with an encoded command and this is like a base64 blob",
    "start": "3160930",
    "end": "3168490"
  },
  {
    "text": "of like code so it could be shellcode it could be anything and generally speaking",
    "start": "3168490",
    "end": "3173970"
  },
  {
    "text": "this is bad right and so you could go back and you can actually like decode that blob you could do it in PowerShell",
    "start": "3173970",
    "end": "3180610"
  },
  {
    "text": "you go online to find some basics for decoder or whatever whatever you fancy and you can figure out what's going on",
    "start": "3180610",
    "end": "3186550"
  },
  {
    "text": "there turns out that ended up being meterpreter payload and so remember we",
    "start": "3186550",
    "end": "3192760"
  },
  {
    "text": "were initially focused on PowerShell Empire and we eventually came back to finding meterpreter which is a different",
    "start": "3192760",
    "end": "3198310"
  },
  {
    "text": "implementation of kind of the same attack so that that in my mind kind of justifies",
    "start": "3198310",
    "end": "3203800"
  },
  {
    "text": "this process a little bit all right so at this point we've unmasked the the masked man I guess after they if you",
    "start": "3203800",
    "end": "3210670"
  },
  {
    "start": "3205000",
    "end": "3245000"
  },
  {
    "text": "know the context of that picture after they killed everybody but that's pretty much our presentation we're happy to",
    "start": "3210670",
    "end": "3216040"
  },
  {
    "text": "take questions at this point if anybody has has anything for us so thank you for",
    "start": "3216040",
    "end": "3221440"
  },
  {
    "text": "coming out definitely thank you and if",
    "start": "3221440",
    "end": "3229000"
  },
  {
    "text": "you have a question go ahead and raise your hand and they have a microphone that they're going to bring around and please keep your question until you get",
    "start": "3229000",
    "end": "3235480"
  },
  {
    "text": "the microphone all right yep thank you",
    "start": "3235480",
    "end": "3240820"
  },
  {
    "text": "very much thanks guys Thanks [Applause]",
    "start": "3240820",
    "end": "3246930"
  }
]