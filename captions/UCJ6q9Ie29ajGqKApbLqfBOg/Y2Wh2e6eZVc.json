[
  {
    "text": "welcome to delegate to the top abusing cameras for arbitrary impersonations and",
    "start": "30",
    "end": "5640"
  },
  {
    "text": "remote code execution delegation is the",
    "start": "5640",
    "end": "11219"
  },
  {
    "text": "assignment of authority to another person to carry out specific activities it is",
    "start": "11219",
    "end": "18090"
  },
  {
    "text": "one of the core concepts of management leadership while delegation is being",
    "start": "18090",
    "end": "24119"
  },
  {
    "text": "used as very powerful and effective feature if you delegate too much it",
    "start": "24119",
    "end": "31800"
  },
  {
    "text": "could lead for devastating results computer security is not different and",
    "start": "31800",
    "end": "39270"
  },
  {
    "text": "the fact is the delegation is very risky while being used in almost every",
    "start": "39270",
    "end": "45989"
  },
  {
    "text": "enterprise that manually knows how it works so if you're on the defensive side",
    "start": "45989",
    "end": "51770"
  },
  {
    "text": "you should know the implications of using delegation in the field offensive",
    "start": "51770",
    "end": "57329"
  },
  {
    "text": "side you should add the legation to hacking arsenal since it enables many",
    "start": "57329",
    "end": "63270"
  },
  {
    "text": "escalation opportunities which will stay under the radar so my name is matt on",
    "start": "63270",
    "end": "72270"
  },
  {
    "text": "Hart I am a security researcher at cyber work previously I was a forensic",
    "start": "72270",
    "end": "77970"
  },
  {
    "text": "investigator and a malware analyst in the Israeli Air Force and Israeli",
    "start": "77970",
    "end": "83009"
  },
  {
    "text": "Defense Forces but now my focus is on Kerberos and Active Directory security",
    "start": "83009",
    "end": "91340"
  },
  {
    "text": "you might disagree with me but I think that PowerShell is the best scripting language in Windows today and if you",
    "start": "91579",
    "end": "98939"
  },
  {
    "text": "didn't notice yet I am a huge fan of the TV show mr. robot so in this",
    "start": "98939",
    "end": "106470"
  },
  {
    "text": "presentation I'll explain what is delegation and how it's been performed in Windows networks we will deep dive",
    "start": "106470",
    "end": "113070"
  },
  {
    "text": "into the different delegation types and configurations that's available in the Windows Active Directory and discuss the",
    "start": "113070",
    "end": "121590"
  },
  {
    "text": "limitations and the security risks introduced using a tool I've built in a demo I will",
    "start": "121590",
    "end": "128670"
  },
  {
    "text": "show how an attacker can impersonate another user and escalate privileges and",
    "start": "128670",
    "end": "134000"
  },
  {
    "text": "then maybe even get remote code execution through unintended services",
    "start": "134000",
    "end": "140090"
  },
  {
    "text": "finally I will share some guidance and defense strategies to detect and",
    "start": "140090",
    "end": "145620"
  },
  {
    "text": "mitigate malicious delegation activity but let's just start with the problem",
    "start": "145620",
    "end": "152870"
  },
  {
    "text": "double hop is the act of maintaining credentials between two or more",
    "start": "152870",
    "end": "157950"
  },
  {
    "text": "connections in the typical scenario when a user access server such as a web",
    "start": "157950",
    "end": "164910"
  },
  {
    "text": "service and that web service needs to access a remote resource such as a",
    "start": "164910",
    "end": "170610"
  },
  {
    "text": "database in order to retrieve data back to the user the front-end service will",
    "start": "170610",
    "end": "176430"
  },
  {
    "text": "use these own credentials to access that resource those credentials are basically",
    "start": "176430",
    "end": "182010"
  },
  {
    "text": "the account which runs under the front-end service this imposes two",
    "start": "182010",
    "end": "189840"
  },
  {
    "text": "limitations which are very problematic first there is no way to audit who is",
    "start": "189840",
    "end": "196080"
  },
  {
    "text": "the first user to access and retrieve the data from the resource because the front-end will be logged as the account",
    "start": "196080",
    "end": "203989"
  },
  {
    "text": "who took that information from that resource another problem is that",
    "start": "203989",
    "end": "209489"
  },
  {
    "text": "sometimes this resource needs to be accessed by the original user to comply",
    "start": "209489",
    "end": "214800"
  },
  {
    "text": "with several restrictions and authorization rules",
    "start": "214800",
    "end": "219950"
  },
  {
    "text": "Kerberos delegation solves this problem by allowing the front-end service to",
    "start": "220970",
    "end": "227040"
  },
  {
    "text": "obtain Kerberos tickets on behalf of the user and access with them to act on",
    "start": "227040",
    "end": "232170"
  },
  {
    "text": "behalf of the user and access the resource so when the resource get those",
    "start": "232170",
    "end": "238440"
  },
  {
    "text": "tickets you'll authorize and get and and be accessed by the user himself",
    "start": "238440",
    "end": "246860"
  },
  {
    "text": "unconstrained Legation was the first delegation that introduced back in Windows 2000",
    "start": "247250",
    "end": "253190"
  },
  {
    "text": "and it allowed the user to put the front-end service to fully impress innate the user to access the resource",
    "start": "253190",
    "end": "260019"
  },
  {
    "text": "it required two things first the user has to forward his own ticket running",
    "start": "260019",
    "end": "266780"
  },
  {
    "text": "ticket to the front end to reuse it and second the front end has to be",
    "start": "266780",
    "end": "273520"
  },
  {
    "text": "trusted for delegation in the domain controller let's look how it looked",
    "start": "273520",
    "end": "280700"
  },
  {
    "text": "behind the scenes if you are not very familiar with scabrous it's fine you'll get there so first the",
    "start": "280700",
    "end": "286310"
  },
  {
    "text": "user obtains a forward tick and running ticket using his own ticket rolling",
    "start": "286310",
    "end": "291380"
  },
  {
    "text": "ticket basically it's the same ticket but now he has defaulted flag which",
    "start": "291380",
    "end": "296450"
  },
  {
    "text": "allows him to fold it to the front end then the client will receive another ticket to access the front end then the",
    "start": "296450",
    "end": "305600"
  },
  {
    "text": "client would generate a session key encrypts the ticket granting ticket and put that session key inside the service",
    "start": "305600",
    "end": "312830"
  },
  {
    "text": "ticket the client and presents those two tickets to the front end so the front",
    "start": "312830",
    "end": "319070"
  },
  {
    "text": "end is being able to decrypt the service ticket with his own key extract the session key and then decrypt the ticket",
    "start": "319070",
    "end": "325430"
  },
  {
    "text": "granting ticket when the front end have this ticket we can go to the domain",
    "start": "325430",
    "end": "331520"
  },
  {
    "text": "controller and ask for service ticket on behalf of the user the domain controller checks with the fondant service is",
    "start": "331520",
    "end": "338870"
  },
  {
    "text": "trusted for delegation and if he does it brings back a session a service ticket",
    "start": "338870",
    "end": "343910"
  },
  {
    "text": "to the front end to access the resource and finally the front end service use",
    "start": "343910",
    "end": "350450"
  },
  {
    "text": "the ticket to access the resource and act on behalf of the user the Kerberos unconstant Legation has two",
    "start": "350450",
    "end": "358430"
  },
  {
    "text": "major limitations first is only can be used with carriers because this client",
    "start": "358430",
    "end": "364790"
  },
  {
    "text": "has to move is still running ticket to the front end so if the client is",
    "start": "364790",
    "end": "370160"
  },
  {
    "text": "outside of their domain or using or you are using a different kind of fundoplication such as token RSA you",
    "start": "370160",
    "end": "378080"
  },
  {
    "text": "won't be able to delegate access another issue is that the cable of unconstraint",
    "start": "378080",
    "end": "384380"
  },
  {
    "text": "Legation is black-and-white kind of delegation full impersonation or no possession at all",
    "start": "384380",
    "end": "390050"
  },
  {
    "text": "and there is no way to restrict the access and make these privileges with",
    "start": "390050",
    "end": "396020"
  },
  {
    "text": "this kind of delegation the only way to limit access is to much specific users",
    "start": "396020",
    "end": "401150"
  },
  {
    "text": "do not to be able to not be trusted for delegation which means there is no",
    "start": "401150",
    "end": "407450"
  },
  {
    "text": "specific way you can delegate access to specific service for that user also if",
    "start": "407450",
    "end": "417620"
  },
  {
    "text": "you compromise the front-end server you can easily use tools such as mimic ads",
    "start": "417620",
    "end": "423470"
  },
  {
    "text": "to obtain those cash taken running tickets that the front-end already",
    "start": "423470",
    "end": "428720"
  },
  {
    "text": "received so basically the unconstrained delegation is already considered to be",
    "start": "428720",
    "end": "433730"
  },
  {
    "text": "unsafe this is why Microsoft introduced",
    "start": "433730",
    "end": "440120"
  },
  {
    "text": "in Windows 2003 the constraint negation which allowed the legation to specific",
    "start": "440120",
    "end": "445700"
  },
  {
    "text": "services and limit the exposure that is done by the unconstrained delegation it",
    "start": "445700",
    "end": "452840"
  },
  {
    "text": "does so by extending the Kerberos protocol with stealing extensions the services are to self and the service to",
    "start": "452840",
    "end": "459710"
  },
  {
    "text": "user to proxy using the service filter to self it solves the first problem of",
    "start": "459710",
    "end": "464720"
  },
  {
    "text": "being able to use only Kerberos model and the front end service to acquire service ticket itself on behalf of the",
    "start": "464720",
    "end": "472760"
  },
  {
    "text": "user and you think the service related proxy the service can use a service",
    "start": "472760",
    "end": "478430"
  },
  {
    "text": "ticket and obtain additional service tickets to access the resource instead",
    "start": "478430",
    "end": "485150"
  },
  {
    "text": "of using the original taken running ticket in the unconcern delegation so",
    "start": "485150",
    "end": "491990"
  },
  {
    "text": "basically the constraint arrogation has major advantages first in the security aspect it's now able to make a granular",
    "start": "491990",
    "end": "500870"
  },
  {
    "text": "kind of delegation and restrict the access to specific services which limit",
    "start": "500870",
    "end": "506120"
  },
  {
    "text": "the exposure of the being of the delegation it also not is not required to fold the whole thing running ticket",
    "start": "506120",
    "end": "512990"
  },
  {
    "text": "to the front end which means it's it's safer in his ability aspect it's also improved",
    "start": "512990",
    "end": "520719"
  },
  {
    "text": "because there is now support to protocol transition so we can use another kind of authentication protocol and then access",
    "start": "520720",
    "end": "528520"
  },
  {
    "text": "the resource using using delegation enter burrows the only ones the only",
    "start": "528520",
    "end": "535470"
  },
  {
    "text": "downside in the consolidation is that is limited to a single domain so the front",
    "start": "535470",
    "end": "541030"
  },
  {
    "text": "end and the back end needs to be at the same domain so let's look how it look how it's been",
    "start": "541030",
    "end": "549340"
  },
  {
    "text": "seen behind the scenes so first the client authenticate to the front end using another boss want it",
    "start": "549340",
    "end": "555940"
  },
  {
    "text": "occasion because we can use protocol transmission then the front end uses the",
    "start": "555940",
    "end": "562780"
  },
  {
    "text": "service user to self extension to acquire a service ticket on behalf of the user to himself later with that",
    "start": "562780",
    "end": "571030"
  },
  {
    "text": "ticket we can use the service related proxy to obtain additional service ticket to access the back end and",
    "start": "571030",
    "end": "578790"
  },
  {
    "text": "finally without ticket we can access the resource to act on behalf of the user",
    "start": "578790",
    "end": "586240"
  },
  {
    "text": "there is one scenario which was problematic for me in that case there",
    "start": "586240",
    "end": "591850"
  },
  {
    "text": "basically no communication between the client and the domain controller at all so I was cused to know how the domain",
    "start": "591850",
    "end": "599290"
  },
  {
    "text": "controller is being able to verify that the client is legitimate and is really",
    "start": "599290",
    "end": "604600"
  },
  {
    "text": "authenticated to the front end service so I read in the Microsoft documentation",
    "start": "604600",
    "end": "610720"
  },
  {
    "text": "and I found out that it basically does not the domain controller fully trust",
    "start": "610720",
    "end": "616570"
  },
  {
    "text": "the fondant service to authenticate the user and basically that front end needs",
    "start": "616570",
    "end": "623110"
  },
  {
    "text": "to supply only the user name in order to impersonate the user which means it can",
    "start": "623110",
    "end": "628210"
  },
  {
    "text": "appreciate whoever you want don't worry I didn't invented something it's a",
    "start": "628210",
    "end": "633670"
  },
  {
    "text": "feature Microsoft invented it's not a bug which allows the front-end service",
    "start": "633670",
    "end": "638800"
  },
  {
    "text": "to make any kind of arbitrary impersonations in order to get access to",
    "start": "638800",
    "end": "644410"
  },
  {
    "text": "the allowed service so it's also not going to be changed soon",
    "start": "644410",
    "end": "649650"
  },
  {
    "text": "because it's expected behavior Microsoft implemented however Microsoft does",
    "start": "649650",
    "end": "657270"
  },
  {
    "text": "mention that the combination of the service user to self and the serviceability proxy allows to the",
    "start": "657270",
    "end": "664140"
  },
  {
    "text": "services that allows for delegation a degree of power which is similar to the",
    "start": "664140",
    "end": "669150"
  },
  {
    "text": "domain controller itself at that moment I was curious to see how we can leverage",
    "start": "669150",
    "end": "679170"
  },
  {
    "text": "this kind of authentication and maybe gain more than what it expects expected",
    "start": "679170",
    "end": "684600"
  },
  {
    "text": "to have so let's see how those services are being restricted in the Kerberos",
    "start": "684600",
    "end": "689940"
  },
  {
    "text": "consolidation so Service principal names uniquely identifies a service in the",
    "start": "689940",
    "end": "695580"
  },
  {
    "text": "domain and I use like the Kerberos protocol to map and associate a service",
    "start": "695580",
    "end": "703230"
  },
  {
    "text": "to a service log on account and without them Kerberos is unable to issue service",
    "start": "703230",
    "end": "708870"
  },
  {
    "text": "tickets those service principal names basically contains the service type on a",
    "start": "708870",
    "end": "715080"
  },
  {
    "text": "specific server and sometimes even can provide a port some examples of those service principal names are HTTP for web",
    "start": "715080",
    "end": "722640"
  },
  {
    "text": "services SMTP and pop free for mega services and tips for printing and file-sharing but",
    "start": "722640",
    "end": "729600"
  },
  {
    "text": "basically there are many many SPNs that you can use those services that are",
    "start": "729600",
    "end": "736830"
  },
  {
    "text": "trusted for delegation are running under account which has been configured to use",
    "start": "736830",
    "end": "742200"
  },
  {
    "text": "delegation you can configure this account whether is a computer a user in the Active Directory and set the service",
    "start": "742200",
    "end": "749880"
  },
  {
    "text": "principle names that are allowed for delegation you can configure this configuration only by domain",
    "start": "749880",
    "end": "755100"
  },
  {
    "text": "administrator and you first this account must be associated with a service",
    "start": "755100",
    "end": "761070"
  },
  {
    "text": "principle name in order to enable protocol transitioning you also need to",
    "start": "761070",
    "end": "766230"
  },
  {
    "text": "set the account to act as part of the operation system which by default is only granted to the system account",
    "start": "766230",
    "end": "774140"
  },
  {
    "text": "so now that we know how the legation works now we can configure it I started",
    "start": "775110",
    "end": "780510"
  },
  {
    "text": "to think how it's possible to gain this account and then use it to make",
    "start": "780510",
    "end": "788190"
  },
  {
    "text": "malicious activity but first we need these dis privileges so let's see how",
    "start": "788190",
    "end": "793770"
  },
  {
    "text": "it's possible to get this account in the network so the Firdos account from the",
    "start": "793770",
    "end": "799650"
  },
  {
    "text": "standard user account in your network because they're easily discovered through the Active Directory you just",
    "start": "799650",
    "end": "805110"
  },
  {
    "text": "need to filter so those account and then check where the service principle is located so we know the servers are using",
    "start": "805110",
    "end": "815810"
  },
  {
    "text": "they're also very accessible and exposed by the service that they host so if it's",
    "start": "815810",
    "end": "822480"
  },
  {
    "text": "a web service and you have some kind of exploitation to is you might get this",
    "start": "822480",
    "end": "827820"
  },
  {
    "text": "account as well because as a Content some kind of a service accounts they are",
    "start": "827820",
    "end": "833100"
  },
  {
    "text": "usually unmanaged with no password policy in whatever and they often",
    "start": "833100",
    "end": "838620"
  },
  {
    "text": "neglected so it's easier to find them and exploit them than the usual accounts",
    "start": "838620",
    "end": "843920"
  },
  {
    "text": "another interesting point is that if you're familiar with Kerberos those accounts are by default are able to be",
    "start": "843920",
    "end": "851970"
  },
  {
    "text": "exploited within that way because they must be registered with service principle names and if they have a weak",
    "start": "851970",
    "end": "857430"
  },
  {
    "text": "password they probably could be obtained a service ticket to him to them and then",
    "start": "857430",
    "end": "863430"
  },
  {
    "text": "try to brute force the ticket offline to extract the password again and if you",
    "start": "863430",
    "end": "868620"
  },
  {
    "text": "already compromised the server which are in you will probably find the",
    "start": "868620",
    "end": "873660"
  },
  {
    "text": "credentials of those account in memory because those accounts are always logged on with the service and they and the",
    "start": "873660",
    "end": "881340"
  },
  {
    "text": "credential will be cached in memory I wanted to look how in different",
    "start": "881340",
    "end": "888840"
  },
  {
    "text": "configurations and how many products and solutions use this kind of configuration the constraint delegation with protocol",
    "start": "888840",
    "end": "896070"
  },
  {
    "text": "transition and I was amazed to see how many vendors especially security vendors",
    "start": "896070",
    "end": "901310"
  },
  {
    "text": "need that kind of configuration but basically it's it makes sense because",
    "start": "901310",
    "end": "908830"
  },
  {
    "text": "any kind of solution which is placed outside of the domain such as a firewall",
    "start": "908830",
    "end": "913840"
  },
  {
    "text": "but needs to have access to a service that is in the domain and its use this",
    "start": "913840",
    "end": "919630"
  },
  {
    "text": "kind of configuration let's look for one example how a major vendor that I guess",
    "start": "919630",
    "end": "926350"
  },
  {
    "text": "most of you use which I can say the name is using consolidation with protocol",
    "start": "926350",
    "end": "932500"
  },
  {
    "text": "transition to allow single sign-on with smart card when the clients are not joining the domain what I see that is",
    "start": "932500",
    "end": "939850"
  },
  {
    "text": "their best practice put configuration they request that each domain controller",
    "start": "939850",
    "end": "945600"
  },
  {
    "text": "must be have me delegated to with the six as up and protected storage service",
    "start": "945600",
    "end": "951730"
  },
  {
    "text": "principle names and which was only modified a year ago so it's not like legacy thing so now it let me know the",
    "start": "951730",
    "end": "961000"
  },
  {
    "text": "web account which there in the security considerations they don't say that is variants privileged so I don't know how",
    "start": "961000",
    "end": "967390"
  },
  {
    "text": "they they secure it but is able to delegate access with the active directory so that moment I started to",
    "start": "967390",
    "end": "976810"
  },
  {
    "text": "think what is the attack surface an attacker can have once we have this kind of account how we can leverage those",
    "start": "976810",
    "end": "985210"
  },
  {
    "text": "privileges to gain malicious intentions",
    "start": "985210",
    "end": "990960"
  },
  {
    "text": "so first our pad surface is determined by the attribute in the active directory",
    "start": "990960",
    "end": "996940"
  },
  {
    "text": "which is called allowed to delegate to which contains the lead list of service principle names that that service is",
    "start": "996940",
    "end": "1004650"
  },
  {
    "text": "allowed to delegate so the common service principle names I've seen that a",
    "start": "1004650",
    "end": "1010290"
  },
  {
    "text": "use of delegation are HTTP for web services mssql SVC for SQL databases",
    "start": "1010290",
    "end": "1017070"
  },
  {
    "text": "host for computer management six for file servers and LDAP for the domain",
    "start": "1017070",
    "end": "1022650"
  },
  {
    "text": "controllers so we know that we have a lot of attack surface are many servers",
    "start": "1022650",
    "end": "1029339"
  },
  {
    "text": "that use this kind of delegation so at that moment I started to think how we",
    "start": "1029339",
    "end": "1036420"
  },
  {
    "text": "can stretch and make malicious activity above the original and intended",
    "start": "1036420",
    "end": "1044540"
  },
  {
    "text": "functionality and because service principal names are only restrict service and not a specific usage or two",
    "start": "1044540",
    "end": "1051780"
  },
  {
    "text": "application is not so hard to find ways to make more than what the application",
    "start": "1051780",
    "end": "1058980"
  },
  {
    "text": "should have do so some examples I thought about it first except on the",
    "start": "1058980",
    "end": "1065970"
  },
  {
    "text": "fact that we can elevate privileges by making arbitrary impersonations with this account we can also make data",
    "start": "1065970",
    "end": "1073350"
  },
  {
    "text": "exfiltration just by making accessing the application the file share database",
    "start": "1073350",
    "end": "1079799"
  },
  {
    "text": "that has been allowed to delegate to and extract the data but now but more interesting is how we can gain remote",
    "start": "1079799",
    "end": "1085770"
  },
  {
    "text": "code execution so database says I should be used only to retrieve and update data",
    "start": "1085770",
    "end": "1093090"
  },
  {
    "text": "but actually if I can impersonate the DBA nothing stops me from enabling xp seem",
    "start": "1093090",
    "end": "1099690"
  },
  {
    "text": "this show and then running command through it so while the application should be only used for SQL you can run",
    "start": "1099690",
    "end": "1106470"
  },
  {
    "text": "command to that machine also a nice example is that web services use the",
    "start": "1106470",
    "end": "1112200"
  },
  {
    "text": "HTTP service but also PowerShell use it because PowerShell is also running",
    "start": "1112200",
    "end": "1118260"
  },
  {
    "text": "commands through HTTP service which means that even if you have a web service or is you can use PowerShell to",
    "start": "1118260",
    "end": "1124740"
  },
  {
    "text": "execute arbitrary commands host is the computer management which means that you",
    "start": "1124740",
    "end": "1130679"
  },
  {
    "text": "can do whatever you want with it at the example I showed before when you",
    "start": "1130679",
    "end": "1136860"
  },
  {
    "text": "have a leader LDAP delegation to the domain controller you can basically run the decision Kotak to replicate accounts",
    "start": "1136860",
    "end": "1144150"
  },
  {
    "text": "hashes and do whatever you want you basically have a domain compromise at that moment so let's make a quick recap",
    "start": "1144150",
    "end": "1153780"
  },
  {
    "text": "first in order to make the attack slow we need to hand an account with the trusted for that delegation the constant",
    "start": "1153780",
    "end": "1160440"
  },
  {
    "text": "irrigation with provo transition find it in active directory find a way to get to",
    "start": "1160440",
    "end": "1166020"
  },
  {
    "text": "this account you are the hackers here find a way and then when you have the account impersonate arbitrary users that",
    "start": "1166020",
    "end": "1172809"
  },
  {
    "text": "as for delegation my default only to do the default domain administrator cannot be delegated cannot be delegated so it",
    "start": "1172809",
    "end": "1180909"
  },
  {
    "text": "can be the CEO to access a specific file or it just can be a domain administrator",
    "start": "1180909",
    "end": "1186990"
  },
  {
    "text": "to elevate privileges and gain and gain access to somewhere in doesn't really",
    "start": "1186990",
    "end": "1192759"
  },
  {
    "text": "matter at the end you just need to access the service with the ticket and",
    "start": "1192759",
    "end": "1198159"
  },
  {
    "text": "do whatever you want because you can be whoever you want so I made a tool and I",
    "start": "1198159",
    "end": "1204879"
  },
  {
    "text": "call it mystic on the comics character in Marvel which could change your shape",
    "start": "1204879",
    "end": "1210309"
  },
  {
    "text": "and you person ate another person with mystic you can find a count which are trusted for delegation like wearing the",
    "start": "1210309",
    "end": "1217090"
  },
  {
    "text": "active directory as well as read the location flag that attribute and most importantly if you have the",
    "start": "1217090",
    "end": "1223330"
  },
  {
    "text": "consolidation with protocol transition user you can use it to impersonate",
    "start": "1223330",
    "end": "1229299"
  },
  {
    "text": "arbitrary users just by supplying the user name you can find this too in the",
    "start": "1229299",
    "end": "1236710"
  },
  {
    "text": "blackhat website as well as in the Gita page below this tool is using only",
    "start": "1236710",
    "end": "1242769"
  },
  {
    "text": "built-in functionalities in Windows so please you can use it both for the",
    "start": "1242769",
    "end": "1249429"
  },
  {
    "text": "defensive side and the offensive side don't make it a virus I would like to",
    "start": "1249429",
    "end": "1255789"
  },
  {
    "text": "show you a demo how I can leverage a web service to gain remote code execution",
    "start": "1255789",
    "end": "1261190"
  },
  {
    "text": "with PowerShell and then use mimic ads to make a dish using attack and replicate the Kapiti GT",
    "start": "1261190",
    "end": "1267340"
  },
  {
    "text": "which can be used and to make golden ticket",
    "start": "1267340",
    "end": "1272398"
  },
  {
    "text": "it's working it's working okay so first",
    "start": "1278360",
    "end": "1285210"
  },
  {
    "text": "we can use the fine delegation accounts function in Mystic to list all the",
    "start": "1285210",
    "end": "1291810"
  },
  {
    "text": "account that are trusted for delegation as you can see we have one account here which is trusted for protocol transition",
    "start": "1291810",
    "end": "1298020"
  },
  {
    "text": "and it can delegate access to the HTTP service on web server and LDAP to the",
    "start": "1298020",
    "end": "1305670"
  },
  {
    "text": "domain controller we can see that the SPN is located of the account on a",
    "start": "1305670",
    "end": "1311880"
  },
  {
    "text": "machine called victim luckily somehow we find this account and we are running through it now if we",
    "start": "1311880",
    "end": "1323340"
  },
  {
    "text": "strive is the account as is to invoke a command using PowerShell - that web",
    "start": "1323340",
    "end": "1329550"
  },
  {
    "text": "service through HTTP let's see what",
    "start": "1329550",
    "end": "1335130"
  },
  {
    "text": "happens let's die let's try to make who am i and list you see directory",
    "start": "1335130",
    "end": "1342770"
  },
  {
    "text": "as you can see I have an access denied error which basically means we don't",
    "start": "1347540",
    "end": "1352860"
  },
  {
    "text": "have the sufficient access let's try to get the gate current identity which is",
    "start": "1352860",
    "end": "1359760"
  },
  {
    "text": "another function in mistake to show the windows token by running with who easy",
    "start": "1359760",
    "end": "1364950"
  },
  {
    "text": "so we can see that we're running with the web service and in our group membership we are only member of the",
    "start": "1364950",
    "end": "1370410"
  },
  {
    "text": "domain users group so maybe this is the reason why we cannot execute code",
    "start": "1370410",
    "end": "1375990"
  },
  {
    "text": "command on the web server but because we are trusted for the constant Legation",
    "start": "1375990",
    "end": "1381510"
  },
  {
    "text": "with protocol transition we can basically impersonate another user let's try to impersonate another user using",
    "start": "1381510",
    "end": "1389070"
  },
  {
    "text": "the new impersonation command wait and make new one yeah and let's say that we",
    "start": "1389070",
    "end": "1395220"
  },
  {
    "text": "know the name of the web administrator which is called web admin likely so now",
    "start": "1395220",
    "end": "1402540"
  },
  {
    "text": "we just impersonating him if we use the gate current identity again not this one",
    "start": "1402540",
    "end": "1409460"
  },
  {
    "text": "this one we can see that now we are using the web admin and we good membership we can see that we are a",
    "start": "1409460",
    "end": "1416280"
  },
  {
    "text": "member of the web admins group let's try",
    "start": "1416280",
    "end": "1421650"
  },
  {
    "text": "to invoke the same command again to try to run command to the web server and as",
    "start": "1421650",
    "end": "1429930"
  },
  {
    "text": "you can see the command works we can see that in the room I that we are really",
    "start": "1429930",
    "end": "1435330"
  },
  {
    "text": "the web admin and we can release the C directory let's go back to our original",
    "start": "1435330",
    "end": "1442740"
  },
  {
    "text": "account and try to invoke mimikatz with",
    "start": "1442740",
    "end": "1448110"
  },
  {
    "text": "the DC sync attack",
    "start": "1448110",
    "end": "1450980"
  },
  {
    "text": "so what's our basically trying is to replicate the cavity DT account wait",
    "start": "1464840",
    "end": "1471878"
  },
  {
    "text": "under working",
    "start": "1474490",
    "end": "1477480"
  },
  {
    "text": "[Music]",
    "start": "1486860",
    "end": "1490490"
  },
  {
    "text": "so we are trying to execute the command trying to replicate the KBT GT hash and",
    "start": "1496429",
    "end": "1501929"
  },
  {
    "text": "we see that we have an error which basically means we don't have sufficient access again we know that this is ink",
    "start": "1501929",
    "end": "1509340"
  },
  {
    "text": "works with domain admin privileges let's use the read delegated flag function in",
    "start": "1509340",
    "end": "1514950"
  },
  {
    "text": "mistake and map all the user groups all",
    "start": "1514950",
    "end": "1520860"
  },
  {
    "text": "the accounts in the domain admin group in domain admins which allowed for",
    "start": "1520860",
    "end": "1528440"
  },
  {
    "text": "delegation in order to impersonate so we",
    "start": "1528440",
    "end": "1533880"
  },
  {
    "text": "see that we have two accounts we are a member of the domain admins let's try to",
    "start": "1533880",
    "end": "1540179"
  },
  {
    "text": "take one and impersonate him",
    "start": "1540179",
    "end": "1543890"
  },
  {
    "text": "so we successfully impersonated the user let's try to invoke mimikatz now again with the right access privileges so as",
    "start": "1546909",
    "end": "1561710"
  },
  {
    "text": "you can see we successfully replicated the account and we have the cabbage GD t hashes and now we can make golden",
    "start": "1561710",
    "end": "1568279"
  },
  {
    "text": "tickets okay so if I already convinced",
    "start": "1568279",
    "end": "1578179"
  },
  {
    "text": "you that delegation could be abused for more than what he thinks I might surprise you and it's not over yet",
    "start": "1578179",
    "end": "1586149"
  },
  {
    "text": "because after my blackhat submission was accepted another researcher started to",
    "start": "1586149",
    "end": "1591830"
  },
  {
    "text": "look inside a table of delegation and put brilliant researchers Alberto",
    "start": "1591830",
    "end": "1598070"
  },
  {
    "text": "Cellino the authors in packet and Benjamin Delfy the author of Munich at signs found out that basically there is",
    "start": "1598070",
    "end": "1606950"
  },
  {
    "text": "no service principle in validation at all which means that the all concept of",
    "start": "1606950",
    "end": "1613179"
  },
  {
    "text": "the consolidation is not true there is a service principal name another security",
    "start": "1613179",
    "end": "1620539"
  },
  {
    "text": "boundary which means there is no service restriction so what we do have",
    "start": "1620539",
    "end": "1625570"
  },
  {
    "text": "turbulence protocol is all about tickets and secret key cryptography so a service",
    "start": "1625570",
    "end": "1631580"
  },
  {
    "text": "validate a service ticket by making sure it's been encrypted with the right secret key that key is basically the",
    "start": "1631580",
    "end": "1638480"
  },
  {
    "text": "password hash of the service account which runs under the service on the remote server this means if you think",
    "start": "1638480",
    "end": "1647509"
  },
  {
    "text": "about it that every every ticket that is being encrypted with the same secret key",
    "start": "1647509",
    "end": "1653860"
  },
  {
    "text": "the same hash means that they are fully interchangeable it doesn't really matter",
    "start": "1653860",
    "end": "1659240"
  },
  {
    "text": "if it's for the safe for file sharing or host for all the computer management",
    "start": "1659240",
    "end": "1665440"
  },
  {
    "text": "because computer accounts are already have multiplied Espeon registered",
    "start": "1665440",
    "end": "1671929"
  },
  {
    "text": "automatically and there are many accounts that have multiplied experience",
    "start": "1671929",
    "end": "1677119"
  },
  {
    "text": "associated to the set to that account this that are all interchangeable even more",
    "start": "1677119",
    "end": "1684450"
  },
  {
    "text": "if you have two different accounts but they have the same password hash and",
    "start": "1684450",
    "end": "1689679"
  },
  {
    "text": "user account by default use rc4 encryption which is unsalted means that",
    "start": "1689679",
    "end": "1695950"
  },
  {
    "text": "if you have the same password they have the same password hash so if you use some kind of imaging to duplicate",
    "start": "1695950",
    "end": "1702970"
  },
  {
    "text": "accounts or you have a default password in organization this means that even if you delegate access to a specific",
    "start": "1702970",
    "end": "1709420"
  },
  {
    "text": "service it means that it could also go to the other account which might be on a",
    "start": "1709420",
    "end": "1715630"
  },
  {
    "text": "different server let's see an example so let's say that we are the attacker and",
    "start": "1715630",
    "end": "1721870"
  },
  {
    "text": "you already compromised the front-end but we see that we can delegate access only to the SIV service on the backend",
    "start": "1721870",
    "end": "1728559"
  },
  {
    "text": "but we want to gain remote code execution I don't know a way how we can",
    "start": "1728559",
    "end": "1733870"
  },
  {
    "text": "make a code multiple execution to the SIP service however what we can do is to",
    "start": "1733870",
    "end": "1738910"
  },
  {
    "text": "use the service with the proxy to get that ticket with the SIF and then present that ticket to the back end but",
    "start": "1738910",
    "end": "1747010"
  },
  {
    "text": "requesting the hot service it works because it works when the backend has",
    "start": "1747010",
    "end": "1754510"
  },
  {
    "text": "the same two services associated to this account it doesn't really matter it",
    "start": "1754510",
    "end": "1760059"
  },
  {
    "text": "doesn't really care about what is the service principal name that is associated with this account all the matters is if it's encrypted with the",
    "start": "1760059",
    "end": "1767530"
  },
  {
    "text": "same key moreover with another service which uses the same account under it we",
    "start": "1767530",
    "end": "1775390"
  },
  {
    "text": "can use the same ticket and request access using any kind of service we want",
    "start": "1775390",
    "end": "1781929"
  },
  {
    "text": "as long as they are both under the same account Microsoft in Windows 2012 do",
    "start": "1781929",
    "end": "1791290"
  },
  {
    "text": "realize that the service principle names are not security boundary and invented",
    "start": "1791290",
    "end": "1798610"
  },
  {
    "text": "the resource based constraint Legation with a new attribute very long allowed to act on behalf of other identity which",
    "start": "1798610",
    "end": "1805750"
  },
  {
    "text": "basically means that are now changing from restricting by per service",
    "start": "1805750",
    "end": "1811210"
  },
  {
    "text": "principle name to the delegating account this attribute is assigned to the back end in front instead of the front end",
    "start": "1811210",
    "end": "1817559"
  },
  {
    "text": "which means that I can now have control and decide who is the accounting that cannot delegate access however it's it's",
    "start": "1817559",
    "end": "1827639"
  },
  {
    "text": "not long works with the service principle name another big advantage is now that the resource based",
    "start": "1827639",
    "end": "1833730"
  },
  {
    "text": "consolidation in support allegation across domains and forests so you can have a back-end in another branch and",
    "start": "1833730",
    "end": "1841110"
  },
  {
    "text": "you can still that I get access to it the only requirement in the resource",
    "start": "1841110",
    "end": "1846119"
  },
  {
    "text": "based consul delegation is that the server the front-end should use Windows 2012 as well as the DC's that are",
    "start": "1846119",
    "end": "1854519"
  },
  {
    "text": "between I'm not sure if this is a good",
    "start": "1854519",
    "end": "1860220"
  },
  {
    "text": "thing or a very bad thing the resource based concert Legation when we talk about security because now there is no",
    "start": "1860220",
    "end": "1866609"
  },
  {
    "text": "service restriction at all and if the backend already trusts the front-end and",
    "start": "1866609",
    "end": "1871710"
  },
  {
    "text": "we know that the front-end cannot be trusted the attacker can do whatever you want to that's back end and because now we can",
    "start": "1871710",
    "end": "1878369"
  },
  {
    "text": "delegate access to another domain or forest this enables an attacker very",
    "start": "1878369",
    "end": "1883649"
  },
  {
    "text": "interesting opportunities to for lateral movement and escalation we've all that",
    "start": "1883649",
    "end": "1890909"
  },
  {
    "text": "said let's talk about defense so first I advice for you for the blue team to use",
    "start": "1890909",
    "end": "1897690"
  },
  {
    "text": "mystic to list all the accounts that are trusted for delegation in organization",
    "start": "1897690",
    "end": "1902999"
  },
  {
    "text": "if you use for some reason the unconsidered aggression change it understand the services that you",
    "start": "1902999",
    "end": "1910080"
  },
  {
    "text": "delegate to and change the constraint irrigation if you use protocol transition check why you need the",
    "start": "1910080",
    "end": "1915899"
  },
  {
    "text": "protocol transition if you don't have to don't use it another important",
    "start": "1915899",
    "end": "1921149"
  },
  {
    "text": "suggestion is is that you need to think that the security level of the front-end should be at least is the same as the",
    "start": "1921149",
    "end": "1928859"
  },
  {
    "text": "services that you access you delegate access to so if you delegate access to a",
    "start": "1928859",
    "end": "1933989"
  },
  {
    "text": "domain controller that server should be at the same level of security of the",
    "start": "1933989",
    "end": "1939869"
  },
  {
    "text": "domain controller and help it's a good enough detecting this kind of activity through",
    "start": "1939869",
    "end": "1948700"
  },
  {
    "text": "the event logs could be only available from Windows 8 and Windows 2000 and Microsoft improved the successful gonna",
    "start": "1948700",
    "end": "1957220"
  },
  {
    "text": "vent manure impersonation level attribute so now you can see the",
    "start": "1957220",
    "end": "1964480"
  },
  {
    "text": "delegating account as well as the delegated account this log is both on",
    "start": "1964480",
    "end": "1970540"
  },
  {
    "text": "the front end as well as the back end you can also detect it through network",
    "start": "1970540",
    "end": "1976870"
  },
  {
    "text": "if you listen to the traffic that comes from or to the domain controller by seeing the teacher's request and Jesus",
    "start": "1976870",
    "end": "1983440"
  },
  {
    "text": "replies in the service area to proxy extension you can detect the service as",
    "start": "1983440",
    "end": "1989800"
  },
  {
    "text": "well as the account that was delegated access as well as the account",
    "start": "1989800",
    "end": "1995410"
  },
  {
    "text": "we've been delegated so we have multiple choices here to detect to mitigate",
    "start": "1995410",
    "end": "2003090"
  },
  {
    "text": "attacks except from the recommendations I gave before you can you should configure services especially in the",
    "start": "2003090",
    "end": "2010860"
  },
  {
    "text": "backend with a dedicated service account don't use the same account for multiple",
    "start": "2010860",
    "end": "2016320"
  },
  {
    "text": "services or for other auto for other usages also don't use the computer",
    "start": "2016320",
    "end": "2022950"
  },
  {
    "text": "account because is mapped with multiply service principal names and very hard to",
    "start": "2022950",
    "end": "2029340"
  },
  {
    "text": "limit that access also to avoid attacks such as Kerberos you should use a",
    "start": "2029340",
    "end": "2035370"
  },
  {
    "text": "password policy with rotation and complexity another option is to set",
    "start": "2035370",
    "end": "2042960"
  },
  {
    "text": "unique service principal name that could be allowed for delegation don't use the built-in ones because as the depower",
    "start": "2042960",
    "end": "2049379"
  },
  {
    "text": "shell example one SPN could be used for multiple uses so if you have I a server",
    "start": "2049380",
    "end": "2054659"
  },
  {
    "text": "which is under the computer account it could also be used for PowerShell",
    "start": "2054660",
    "end": "2060450"
  },
  {
    "text": "remoting also you can specify specific port number and set the application to",
    "start": "2060450",
    "end": "2065730"
  },
  {
    "text": "listen only at port number and then in that way make sure there is no other",
    "start": "2065730",
    "end": "2072290"
  },
  {
    "text": "applications that could be delegated other Microsoft options that you can",
    "start": "2072290",
    "end": "2078898"
  },
  {
    "text": "consider is to first they use the privilege the accountant if sensitive it",
    "start": "2078899",
    "end": "2083908"
  },
  {
    "text": "cannot be delegated to set to the previous account in your network however this restricts the ability to",
    "start": "2083909",
    "end": "2089070"
  },
  {
    "text": "dig it in at all so if you have a domain administrator that you know that you cannot delegate",
    "start": "2089070",
    "end": "2094470"
  },
  {
    "text": "access to it that you don't want to delegate access to it you can set it also you can use the resource based",
    "start": "2094470",
    "end": "2100290"
  },
  {
    "text": "consider Legation if you don't really know and follow which are the front end the delegate access to develop those",
    "start": "2100290",
    "end": "2107640"
  },
  {
    "text": "back ends we can set this restriction in the back end and you don't need domain administrator privilege for it and also",
    "start": "2107640",
    "end": "2114180"
  },
  {
    "text": "if for some reason you still using the unconcerned allegation for unnecessary reasons at least enforced first boundary",
    "start": "2114180",
    "end": "2121980"
  },
  {
    "text": "restriction to avoid impersonation between forests so for in conclusion",
    "start": "2121980",
    "end": "2131450"
  },
  {
    "text": "Kerberos delegation is very powerful feature and with great power comes great",
    "start": "2131450",
    "end": "2137040"
  },
  {
    "text": "responsibility you should know that if I'm talking here",
    "start": "2137040",
    "end": "2142260"
  },
  {
    "text": "today about several delegation and now it could be abused somebody else is",
    "start": "2142260",
    "end": "2147690"
  },
  {
    "text": "already doing it already also service and service accounts are always a weak",
    "start": "2147690",
    "end": "2154110"
  },
  {
    "text": "point in any organization you should know that the risk we introduce are more than what you think so you should try to",
    "start": "2154110",
    "end": "2160320"
  },
  {
    "text": "limit them as as much as you can because it's very hard to expect and to know what the real power and lastly if you",
    "start": "2160320",
    "end": "2170790"
  },
  {
    "text": "are in the Blue team here i really suggest to check what kind of delegation",
    "start": "2170790",
    "end": "2175800"
  },
  {
    "text": "using a network and try to harden it as much as you can I know it's hard but it is possible and it's rewarding questions",
    "start": "2175800",
    "end": "2187670"
  },
  {
    "text": "yes this",
    "start": "2187670",
    "end": "2190880"
  },
  {
    "text": "yes so the question is why I should",
    "start": "2195710",
    "end": "2205589"
  },
  {
    "text": "change the password regularly in Kerberos that's the question okay so",
    "start": "2205589",
    "end": "2211440"
  },
  {
    "text": "basically a service account when they have SPN if you use if they're based on",
    "start": "2211440",
    "end": "2218579"
  },
  {
    "text": "user account we have a weak password and encryption you can get a ticket for it and because Kerberos is using secret key",
    "start": "2218579",
    "end": "2226349"
  },
  {
    "text": "cryptography if the password is weak you can take that ticket and try to brute force the ticket offline it's matter of",
    "start": "2226349",
    "end": "2234680"
  },
  {
    "text": "maximum days you can use tools like hash cat and John the Ripper to do it for you",
    "start": "2234680",
    "end": "2240079"
  },
  {
    "text": "so if you have a long password it's a make it infeasible so this is why we",
    "start": "2240079",
    "end": "2247109"
  },
  {
    "text": "should change it to regularly with complex password ok yes yes",
    "start": "2247109",
    "end": "2257420"
  },
  {
    "text": "okay so the question is how mystic knows who what are the accounts were adjusted",
    "start": "2265240",
    "end": "2270950"
  },
  {
    "text": "per delegation so yes it queries the Active Directory with the specific filter which check the user account",
    "start": "2270950",
    "end": "2277790"
  },
  {
    "text": "controls and attributes to map those accounts and then get another attributes",
    "start": "2277790",
    "end": "2284480"
  },
  {
    "text": "to give you a good view of of the account and what it is capable of it also has been updated with the",
    "start": "2284480",
    "end": "2291670"
  },
  {
    "text": "revelations of measurement OSI and Alberto Cellino to also show the extra",
    "start": "2291670",
    "end": "2298370"
  },
  {
    "text": "vulnerable services that might have been because of those accounts okay for",
    "start": "2298370",
    "end": "2307520"
  },
  {
    "text": "questions yes",
    "start": "2307520",
    "end": "2311260"
  },
  {
    "text": "I'm not hearing you",
    "start": "2313000",
    "end": "2316890"
  },
  {
    "text": "so the question if certificate-based kind of indications of this problem so",
    "start": "2322690",
    "end": "2327980"
  },
  {
    "text": "basically its not really kara's related it's different I'm not sure what statistic you are talking about which",
    "start": "2327980",
    "end": "2333950"
  },
  {
    "text": "you can come later it's it's different kind in the domain we could use Kerberos",
    "start": "2333950",
    "end": "2342230"
  },
  {
    "text": "it's not using certificates but we can talk about it later okay elevation I think not okay good so I'd",
    "start": "2342230",
    "end": "2355040"
  },
  {
    "text": "like to saying cyber-ark for letting me research stuff that nobody cared about and Microsoft Resource Center for",
    "start": "2355040",
    "end": "2363380"
  },
  {
    "text": "answering some weird questions and of course for Benjamin Delfy and Alberto Cellino for the great addition to the",
    "start": "2363380",
    "end": "2370810"
  },
  {
    "text": "consolidation exploitation and finally to all of you for taking the regression",
    "start": "2370810",
    "end": "2377240"
  },
  {
    "text": "seriously thank you [Applause]",
    "start": "2377240",
    "end": "2384969"
  }
]