[
  {
    "text": "good morning welcome to black hat USA 2015 day two hopefully you're in the right place",
    "start": "399",
    "end": "7600"
  },
  {
    "text": "this is Mandalay Bay BCD the talk here is going to be repurposing onion",
    "start": "7600",
    "end": "13799"
  },
  {
    "text": "Duke with Joshua pittz I have a couple of announcements",
    "start": "13799",
    "end": "20400"
  },
  {
    "text": "to give you just before we get started first we want to remind you that you can stop by the business Hall which",
    "start": "20400",
    "end": "26640"
  },
  {
    "text": "is located in Shoreline a for sponsored sessions in theater A and B be sure to check out our black hat",
    "start": "26640",
    "end": "33920"
  },
  {
    "text": "Arsenal and Breakers djk and we have sponsored workshops in",
    "start": "33920",
    "end": "40600"
  },
  {
    "text": "Mandalay J K and L thanks for putting your phone on",
    "start": "40600",
    "end": "45960"
  },
  {
    "text": "vibrate so that it doesn't disrupt the session we really appreciate your help with all of this and without further Ado",
    "start": "45960",
    "end": "53079"
  },
  {
    "text": "I present you Josh Pitts [Applause]",
    "start": "53079",
    "end": "59600"
  },
  {
    "text": "morning can everybody hear me awesome thanks for coming I know it's early well",
    "start": "61239",
    "end": "67960"
  },
  {
    "text": "9:45 in Vegas is early so I appreciate it so like they said I'm Josh",
    "start": "67960",
    "end": "73920"
  },
  {
    "text": "pittz I'm director of security research at npac uh before that I was at Leviathan security and if you're",
    "start": "73920",
    "end": "80560"
  },
  {
    "text": "following along in the OPM database I was at Booz Allen and then U PWC and if",
    "start": "80560",
    "end": "87439"
  },
  {
    "text": "you have the OPM database you don't need anything more so I'll keep going with that all right so I wrote BDF and BDF",
    "start": "87439",
    "end": "95280"
  },
  {
    "text": "proxy that is called it's short or it's short for the back door Factory so what it does it's a set of code it's written",
    "start": "95280",
    "end": "103320"
  },
  {
    "text": "in Python in assembly that patches payloads into pelf and Mao",
    "start": "103320",
    "end": "109600"
  },
  {
    "text": "formats and BDF proxy is Factor Factory and M proxy and so it patches uh",
    "start": "109600",
    "end": "116560"
  },
  {
    "text": "binaries during download so it's kind of fun and and and I'm actually going to take onion",
    "start": "116560",
    "end": "121680"
  },
  {
    "text": "Duke today and put that into BDF so everyone can use",
    "start": "121680",
    "end": "127000"
  },
  {
    "text": "it so today uh real quick I'm going to talk about repurposing of maare in the media and then we're going to talk about",
    "start": "127000",
    "end": "133959"
  },
  {
    "text": "how I discovered un Duke we're going to reverse engineer the Packer we're going to repurpose it and then I have two",
    "start": "133959",
    "end": "141560"
  },
  {
    "text": "demos so repurposing is what we do as humans is",
    "start": "141560",
    "end": "147160"
  },
  {
    "text": "why we're alive it just makes it saves us time uh and our and our industry is",
    "start": "147160",
    "end": "153800"
  },
  {
    "text": "based on repurposing we share ideas and really if you think about it ideas",
    "start": "153800",
    "end": "159480"
  },
  {
    "text": "travel really fast and no amount of Regulation is going to stop that and and",
    "start": "159480",
    "end": "164800"
  },
  {
    "text": "really as you're going to see after this presentation nation state weapons really are not special or magical they're just",
    "start": "164800",
    "end": "172120"
  },
  {
    "text": "developed in private and then once we get to see them you know everybody is up",
    "start": "172120",
    "end": "177599"
  },
  {
    "text": "to a higher level as far as what they know and how they can defend against those attacks so we're going to look at some",
    "start": "177599",
    "end": "184360"
  },
  {
    "text": "reputable media sources um and we're going to see how malware has been reused um in the media",
    "start": "184360",
    "end": "192200"
  },
  {
    "text": "so we have the Sony attack of 2014 in that attack the malware was named D",
    "start": "192200",
    "end": "197680"
  },
  {
    "text": "Stover and it had a a feature that was delayed hard drive deletion it had",
    "start": "197680",
    "end": "203239"
  },
  {
    "text": "similar SE command and control as a piece of M used in South Korea called vulgamore and that was in 2014",
    "start": "203239",
    "end": "210480"
  },
  {
    "text": "it had similar file names and a time delay before deleting the hard drive that was similar to JRA in 2013 also",
    "start": "210480",
    "end": "217280"
  },
  {
    "text": "used in South Korea and toover used similar non-malicious drivers as those",
    "start": "217280",
    "end": "223480"
  },
  {
    "text": "in the shamun attacks in 2012 and I think that was against petroleum targets or or energy companies in Saudi",
    "start": "223480",
    "end": "230239"
  },
  {
    "text": "Arabia and Via leaked documents n even developed their own called wiper I'm",
    "start": "230239",
    "end": "235959"
  },
  {
    "text": "surprised it didn't have a different name like slow melon or something um but that was in",
    "start": "235959",
    "end": "242480"
  },
  {
    "text": "2012 so the equation group in the NSA do you guys do you guys remember in 2009 when Google asked NSA for help with the",
    "start": "242480",
    "end": "249439"
  },
  {
    "text": "Aurora intrusion so this gave NSA access to parts of Google's infrastructure and",
    "start": "249439",
    "end": "254799"
  },
  {
    "text": "also the Mau samples you guys remember that well in 2015 kerski releases the",
    "start": "254799",
    "end": "261560"
  },
  {
    "text": "equation group report where the group used several prior Known Zero days including the roar exploit and two",
    "start": "261560",
    "end": "266960"
  },
  {
    "text": "exploits associated with stet so according to a report that was",
    "start": "266960",
    "end": "272720"
  },
  {
    "text": "released by dur Spiegel uh the NSA supposedly leveraged South Korea",
    "start": "272720",
    "end": "277759"
  },
  {
    "text": "implants against North Korea they leveraged existing bot Nets to deploy their own implants against other targets",
    "start": "277759",
    "end": "283240"
  },
  {
    "text": "and they repurposed a captur zero day exploit found in passive collection in 2012 so you got to ask yourself who's",
    "start": "283240",
    "end": "289199"
  },
  {
    "text": "reusing who malware and exploits so going to the criminal side of the house there was a report released",
    "start": "289199",
    "end": "296360"
  },
  {
    "text": "in 2012 titled by S active called cyber per is Infamous 5 of 2014 in there there",
    "start": "296360",
    "end": "302600"
  },
  {
    "text": "were five pieces of malware that reuse different components and there was a quote from that recycling malware for",
    "start": "302600",
    "end": "309160"
  },
  {
    "text": "reuse is quick and cost effective for every dollar spent by black hack hackers",
    "start": "309160",
    "end": "314240"
  },
  {
    "text": "people that are in this room I guess hundreds of dollars are spent by the it security industry and if you've ever",
    "start": "314240",
    "end": "320160"
  },
  {
    "text": "done instant response you know that's true because Mandan is not cheap so and then you have the hacking",
    "start": "320160",
    "end": "327759"
  },
  {
    "text": "team that happened one month ago one month ago when their documents were uh dropped on the internet and it didn't take long for pin testers to reuse uh",
    "start": "327759",
    "end": "334800"
  },
  {
    "text": "some of the components this was the flash of zero day and then also criminals and this is the angler exploit",
    "start": "334800",
    "end": "343800"
  },
  {
    "text": "kid so here's some backstory on how I",
    "start": "343800",
    "end": "349080"
  },
  {
    "text": "discovered onion duke it was um September 2014 at derbycon and I made a side comment that I believe that man and",
    "start": "349080",
    "end": "354720"
  },
  {
    "text": "mil patch into binaries on the internet was happening uh for certain reasons you can you can Google Google this this name",
    "start": "354720",
    "end": "360680"
  },
  {
    "text": "and you'll find the story it was actually uh pretty interesting so I I stated that then the CEO of Leviathan",
    "start": "360680",
    "end": "367639"
  },
  {
    "text": "where I worked Frank height he's like PC or GTFO and I was like okay I I will PC",
    "start": "367639",
    "end": "373919"
  },
  {
    "text": "because I don't feel like leaving right now um so I said you know what tour is going to give me the best opportunity to",
    "start": "373919",
    "end": "380240"
  },
  {
    "text": "find the men and the patching activity because it's in many countries where this could happen and basically when you",
    "start": "380240",
    "end": "386160"
  },
  {
    "text": "set up a tour exit node you are you you are an ISP essentially so I used a",
    "start": "386160",
    "end": "392560"
  },
  {
    "text": "module called exit map by Philip winter and I wrote a a module that was actually wrote a module that was called patching",
    "start": "392560",
    "end": "398840"
  },
  {
    "text": "check and after I wrote it it took less than an hour to find the man- in the middle node that was patching binaries",
    "start": "398840",
    "end": "405599"
  },
  {
    "text": "uh during download so I collected about nine samples over over 5 days and I",
    "start": "405599",
    "end": "410960"
  },
  {
    "text": "repeatedly downloaded the same files to see if they would change any of their techniques they didn't and they only",
    "start": "410960",
    "end": "418479"
  },
  {
    "text": "they only uh patched or wrapped uh their M around x6p",
    "start": "418479",
    "end": "424240"
  },
  {
    "text": "files and later on F secure tied onion Duke to the Russian government well they called it R onion Duke they tied it to",
    "start": "424240",
    "end": "431240"
  },
  {
    "text": "the Russian government and other possibly Russian back crime",
    "start": "431240",
    "end": "436879"
  },
  {
    "text": "syndicates however the first sample of onion Duke to hit virus total was 10",
    "start": "436879",
    "end": "442280"
  },
  {
    "text": "months before I found it um and if you look into the details",
    "start": "442280",
    "end": "447400"
  },
  {
    "text": "the user added tags to this when they uploaded it so they found that someone",
    "start": "447400",
    "end": "453840"
  },
  {
    "text": "knew that that something was happening on tour that was malicious and they didn't do anything about it for and this",
    "start": "453840",
    "end": "460840"
  },
  {
    "text": "was happening for 10 months and how I found it is I looked at I Googled for",
    "start": "460840",
    "end": "466039"
  },
  {
    "text": "the md5 hash of the text section and so they were actually using the same",
    "start": "466039",
    "end": "472560"
  },
  {
    "text": "techniques for 10 months before it was it was caught so it's pretty this was actually a pretty effective attack",
    "start": "472560",
    "end": "479879"
  },
  {
    "text": "so when you're when you're going into repurposing software well in this case malware you got to look at it different",
    "start": "479879",
    "end": "485720"
  },
  {
    "text": "from instant response you aren't looking for indicators of compromise exactly what you're doing is think of it as",
    "start": "485720",
    "end": "492120"
  },
  {
    "text": "reverse engineering a competitor's product for the implicit purpose of stealing their intellectual capital and",
    "start": "492120",
    "end": "498280"
  },
  {
    "text": "repackaging it for your use or you want to make it look like they've moved on to different targets",
    "start": "498280",
    "end": "504599"
  },
  {
    "text": "you want to steal their command and control or even steal their Bots so you need to understand",
    "start": "504599",
    "end": "510440"
  },
  {
    "text": "everything about the malware what software protections exist and what features you think are novel for",
    "start": "510440",
    "end": "515479"
  },
  {
    "text": "reusing in fact there is little risk of legal retribution from the original authors for example the agency's",
    "start": "515479",
    "end": "522360"
  },
  {
    "text": "responsible for stuck net and and its deployment are not going to sue you for reusing their",
    "start": "522360",
    "end": "528240"
  },
  {
    "text": "ideas um that would out them right so the only thing you do need to worry about is probably a metal",
    "start": "528240",
    "end": "535160"
  },
  {
    "text": "pipe so all right so so let's take a look at",
    "start": "535160",
    "end": "541519"
  },
  {
    "text": "the onion Duke manal method and to me sorry let me go back for me the most",
    "start": "541519",
    "end": "547839"
  },
  {
    "text": "important feature is the Packer not necessarily the Mau that was deployed",
    "start": "547839",
    "end": "553320"
  },
  {
    "text": "with onion Duke because if you reverse engineer the Packer and you write and you and you can use it then you can",
    "start": "553320",
    "end": "559240"
  },
  {
    "text": "deploy any malare you want and so can we take it reverse engineer and incorporate into open",
    "start": "559240",
    "end": "564920"
  },
  {
    "text": "source Tools in fact I think before the the bis changed her mind on their current recommendations they had an open",
    "start": "564920",
    "end": "571720"
  },
  {
    "text": "source uh Clause so if you open- Source your research then it's okay so should",
    "start": "571720",
    "end": "577720"
  },
  {
    "text": "we open source all nation state malware so this is how onion worked the",
    "start": "577720",
    "end": "584920"
  },
  {
    "text": "victim downloads a binary from the server going through malicious node on the internet in this case tour the",
    "start": "584920",
    "end": "591440"
  },
  {
    "text": "malicious exit node wraps the binary with the Packer the user executes said malware because it has the same icons as",
    "start": "591440",
    "end": "598760"
  },
  {
    "text": "the expect program after unpacking the original binary and M A dis with a batch file the",
    "start": "598760",
    "end": "606120"
  },
  {
    "text": "batch file is executed then the malare is executed when the malare has executed infected",
    "start": "606120",
    "end": "612360"
  },
  {
    "text": "the host the batch file replaces the onion Duke Packer with the original file",
    "start": "612360",
    "end": "618240"
  },
  {
    "text": "and executes the original file so it's it's essentially a shell game so",
    "start": "618240",
    "end": "623839"
  },
  {
    "text": "everything's dropped into temp file.exe was the onion duuk malware and that never changed CH throughout the",
    "start": "623839",
    "end": "630480"
  },
  {
    "text": "campaign original file.exe dorg let's say you have process explorer.exe org",
    "start": "630480",
    "end": "636880"
  },
  {
    "text": "that would be the name excuse me and then you have a batch",
    "start": "636880",
    "end": "642880"
  },
  {
    "text": "file that would have four random integers between unor Ms and",
    "start": "642880",
    "end": "649079"
  },
  {
    "text": "dobat so I wanted to see what was different because something was something different was happening so I",
    "start": "649120",
    "end": "654720"
  },
  {
    "text": "looked at the md5 hashes of the sections uh through virus total virus total file",
    "start": "654720",
    "end": "659920"
  },
  {
    "text": "provides this information so you'll notice that the text sections are the same the the r data sections are the",
    "start": "659920",
    "end": "666440"
  },
  {
    "text": "same and also the relocation sections are the same you'll",
    "start": "666440",
    "end": "671920"
  },
  {
    "text": "see that the dot data sections are the same size but they have different hashes",
    "start": "671920",
    "end": "677880"
  },
  {
    "text": "so I wanted to look at the data sections and do a a diff on them to see what was changing and by doing that and you also",
    "start": "677880",
    "end": "685680"
  },
  {
    "text": "notice that the rsource sections the rsource section were just completely different in size and hash",
    "start": "685680",
    "end": "694440"
  },
  {
    "text": "right all right so what I did is I cut out using DD I just cut out the data",
    "start": "695279",
    "end": "700399"
  },
  {
    "text": "sections for two files and and compared them and this led me to this block of data and you'll see PS exact. ae.org and",
    "start": "700399",
    "end": "709399"
  },
  {
    "text": "you'll see a lot of null bytes and that is basically the size of the of the file",
    "start": "709399",
    "end": "714600"
  },
  {
    "text": "name that it supported um you'll also see file.exe right after that and then there were two",
    "start": "714600",
    "end": "722800"
  },
  {
    "text": "there were a couple 4 byte blocks that were little Indian and I I looked at the",
    "start": "722800",
    "end": "728000"
  },
  {
    "text": "malware when it was loaded in memory and noticed that what was loaded in memory was not the same size as the file what",
    "start": "728000",
    "end": "733839"
  },
  {
    "text": "was loaded on disk so I was looking at the at these numbers and I figured out that the first the first four bytes",
    "start": "733839",
    "end": "741680"
  },
  {
    "text": "there is the location of the first file that is compressed and and encoded and",
    "start": "741680",
    "end": "747320"
  },
  {
    "text": "appended on the end of the binary the second four bytes is the size of that file after it's been compressed and",
    "start": "747320",
    "end": "755279"
  },
  {
    "text": "encoded and you'll see again another two 4 by blocks this is the Malu file",
    "start": "755279",
    "end": "761440"
  },
  {
    "text": "location and size same concept now as far as the resource",
    "start": "761440",
    "end": "767560"
  },
  {
    "text": "section Felix grober and all wrote a paper called software distribution malware infection Vector uh AKA man-",
    "start": "767560",
    "end": "775959"
  },
  {
    "text": "in-the-middle patching in 2008 and there in in there they described a method for patching man M binaries however there's",
    "start": "775959",
    "end": "782760"
  },
  {
    "text": "one drawback the icons would change because he did not develop a method to inherit",
    "start": "782760",
    "end": "788399"
  },
  {
    "text": "the icons from the incoming file onion Duke solves this issue by appending the",
    "start": "788399",
    "end": "793600"
  },
  {
    "text": "original binary AR Source or resource section behind the Packer stub it removes any padding and fixes up the",
    "start": "793600",
    "end": "800519"
  },
  {
    "text": "relative V virtual addresses based on the onion Duke stub now a side note BDF",
    "start": "800519",
    "end": "806160"
  },
  {
    "text": "BDF proxy never had this issue because I just infect inside the file and I don't modify the size",
    "start": "806160",
    "end": "813000"
  },
  {
    "text": "generally so and also in the same paper this was kind of funny um they said that",
    "start": "813000",
    "end": "818480"
  },
  {
    "text": "tour could be used as a countermeasure to protect against man in-the-middle patching U it's more actually it's more",
    "start": "818480",
    "end": "824959"
  },
  {
    "text": "of a game of rushing roulette so this is the Packer layout",
    "start": "824959",
    "end": "831120"
  },
  {
    "text": "you'll notice that um you have a you have a part that's loaded into memory",
    "start": "831120",
    "end": "837040"
  },
  {
    "text": "okay you have the data modifications that go into the Packer stub the rsource section the",
    "start": "837040",
    "end": "844199"
  },
  {
    "text": "resource section that's loaded in the memory you have the compressed original binary that's appended on the end and",
    "start": "844199",
    "end": "849759"
  },
  {
    "text": "then the compressed malware so it's really not too",
    "start": "849759",
    "end": "854440"
  },
  {
    "text": "complicated so the stub was compiled with Visual Studio it uses the GS",
    "start": "855480",
    "end": "860639"
  },
  {
    "text": "security buffer check of course is written in C++ it captures command line",
    "start": "860639",
    "end": "866600"
  },
  {
    "text": "arguments the I thought it would pass it on to the uh batch file but it does not",
    "start": "866600",
    "end": "872440"
  },
  {
    "text": "I could not get that functionality to work um it supports both Anie and",
    "start": "872440",
    "end": "878440"
  },
  {
    "text": "unicode based file names and paths so that's actually pretty cool because they actually plan to hire to to actually",
    "start": "878440",
    "end": "885079"
  },
  {
    "text": "support multiple languages and being if if you're you're attacking tour you need to do that because you'll have one one L",
    "start": "885079",
    "end": "893160"
  },
  {
    "text": "language is you know Anie and then the other is going to be Unicode so uh they wanted to make sure that they were able",
    "start": "893160",
    "end": "898759"
  },
  {
    "text": "to propagate everywhere so they supported it does support x64 PE",
    "start": "898759",
    "end": "904440"
  },
  {
    "text": "binaries but however they did not use I I could not get any of the binaries uh",
    "start": "904440",
    "end": "910199"
  },
  {
    "text": "64-bit uh test binaries to be uh wrapped or patched because you know think about",
    "start": "910199",
    "end": "916160"
  },
  {
    "text": "this was early 2014 uh XP was still supported and so",
    "start": "916160",
    "end": "921560"
  },
  {
    "text": "they did not want to wrap a 64-bit binary that might have been accidentally run on an XP machine which it wouldn't",
    "start": "921560",
    "end": "927399"
  },
  {
    "text": "run anyway so I I'm kind of I'm kind of surprised they did not support X x64 bit",
    "start": "927399",
    "end": "932839"
  },
  {
    "text": "um I never at least it works it works fine so um now the zor the exor each",
    "start": "932839",
    "end": "940079"
  },
  {
    "text": "file is exor after compression the static key is that and it never changed it was always it was always that",
    "start": "940079",
    "end": "947319"
  },
  {
    "text": "number and here's just a a quick glimpse of the stub and and highlighted is the",
    "start": "947319",
    "end": "952560"
  },
  {
    "text": "xor key now the compression was kind of interesting um it took me some time to",
    "start": "952560",
    "end": "959880"
  },
  {
    "text": "find because sometimes I'm I'm not very smart and I was actually consider",
    "start": "959880",
    "end": "965920"
  },
  {
    "text": "considering looking at the assembly output because it was written in assembly a lot of it was written in assembly and porting it over to assembly",
    "start": "965920",
    "end": "973440"
  },
  {
    "text": "python but before I got too far into that I uh I did some better searching",
    "start": "973440",
    "end": "978959"
  },
  {
    "text": "and that led me to a blog post from Ron Bose which was a former cooworker at",
    "start": "978959",
    "end": "984519"
  },
  {
    "text": "Leviathan and who works now at Google and his post led me to the AP compression library and so it's it's a",
    "start": "984519",
    "end": "992279"
  },
  {
    "text": "pretty cool compression Library it only supports x86 x64 only and just a little",
    "start": "992279",
    "end": "997399"
  },
  {
    "text": "side note the hacking team had some had had some code that was called inject proxy as part of their RCS and they",
    "start": "997399",
    "end": "1003880"
  },
  {
    "text": "developed it back in 20072 2008 however they appended only one file on the end of a binary and they use the exact same",
    "start": "1003880",
    "end": "1011399"
  },
  {
    "text": "compression library and so I whenever I was searching through all their stuff yes I did and I found I was really",
    "start": "1011399",
    "end": "1019000"
  },
  {
    "text": "excited that they use the same compression I almost thought that they wrote onion duuk but they didn't I mean I wanted to find that so bad but they",
    "start": "1019000",
    "end": "1025678"
  },
  {
    "text": "they did not do that so so all the samples that were captured",
    "start": "1025679",
    "end": "1033640"
  },
  {
    "text": "and analyzed only deployed a PE executable binary but looking through",
    "start": "1033640",
    "end": "1040319"
  },
  {
    "text": "the assembly I noticed that they supported two ways to deploy a dll via run 32 dll it was via",
    "start": "1040319",
    "end": "1049120"
  },
  {
    "text": "the print message export and then by ordinal number no number was",
    "start": "1049120",
    "end": "1054240"
  },
  {
    "text": "pre-populated and there was a reason for that now however F secure discovered an on Duke DL U but did not recover the",
    "start": "1054240",
    "end": "1061799"
  },
  {
    "text": "associated Packer because it's deleted after execution so it been kind of cool to find that so here's the here's the um",
    "start": "1061799",
    "end": "1069400"
  },
  {
    "text": "here here are the functions that are responsible for the choices in binary execution with the Run d u instructions",
    "start": "1069400",
    "end": "1076720"
  },
  {
    "text": "on the left and middle and on the right is the flow for the binary",
    "start": "1076720",
    "end": "1082640"
  },
  {
    "text": "execution so going back to that same dat section there are two 4 byte areas you",
    "start": "1082640",
    "end": "1089679"
  },
  {
    "text": "can't see it here but looking at the code I was able to find that this first 4 byte section if you have a 01 there",
    "start": "1089679",
    "end": "1097720"
  },
  {
    "text": "this denotes that the malware is a dlll that you going to deploy the next 4 byte",
    "start": "1097720",
    "end": "1103159"
  },
  {
    "text": "section um is the ordinal if the ordinal is blank is going to use the print",
    "start": "1103159",
    "end": "1109200"
  },
  {
    "text": "message export so it's kind of cool so it had some it had some really",
    "start": "1109200",
    "end": "1114840"
  },
  {
    "text": "interesting features but they didn't vary at all because well they didn't think they were going",
    "start": "1114840",
    "end": "1120880"
  },
  {
    "text": "to get caught so there men in the middle of patching framework I believe it was written in C++ because uh I did not see",
    "start": "1120880",
    "end": "1128240"
  },
  {
    "text": "any delay on tour itself I believe you know you could tell that it was modular",
    "start": "1128240",
    "end": "1133280"
  },
  {
    "text": "but they never they never used any of that functionality uh from what we could tell it was campaign you can have a",
    "start": "1133280",
    "end": "1138799"
  },
  {
    "text": "campaign based session and I think that it's going to be seen again at least the the the Mana patching framework CU they",
    "start": "1138799",
    "end": "1145640"
  },
  {
    "text": "could recompile onion Duke and change uh some of the settings and probably get it",
    "start": "1145640",
    "end": "1150760"
  },
  {
    "text": "down to zero uh detections again so their opsec wasn't very good when I",
    "start": "1150760",
    "end": "1156679"
  },
  {
    "text": "first found it I was using the python user agent right so they they just patched everything uh and so I think now",
    "start": "1156679",
    "end": "1164640"
  },
  {
    "text": "what they're going to do is focus on particular distros of Windows they'll say say you know we only want Windows 7",
    "start": "1164640",
    "end": "1170840"
  },
  {
    "text": "or above uh we're going to Target this particular binary it can't be over this",
    "start": "1170840",
    "end": "1176520"
  },
  {
    "text": "size I mean they could they can make the um the rules very specific to get a very specific Target um so if if you can",
    "start": "1176520",
    "end": "1185880"
  },
  {
    "text": "catch the next time they're using this I will buy you a six-pack of beer or even",
    "start": "1185880",
    "end": "1191240"
  },
  {
    "text": "more um now onto reusing the Packer now",
    "start": "1191240",
    "end": "1196280"
  },
  {
    "text": "what what do I want to keep when it comes down to this well I want to keep all of it I think that it was pretty it",
    "start": "1196280",
    "end": "1201919"
  },
  {
    "text": "was pretty novel um at least at least for you know patching biners man in the middle but there there's a there's a",
    "start": "1201919",
    "end": "1208679"
  },
  {
    "text": "specific problem the uh detection rate is really high the stub of onion Duke is",
    "start": "1208679",
    "end": "1214840"
  },
  {
    "text": "about 70 kilobytes so AVS have a lot of leeway to tag and flag the St so I'm",
    "start": "1214840",
    "end": "1223720"
  },
  {
    "text": "going to have to um get a little creative so what do going to how we",
    "start": "1223720",
    "end": "1229320"
  },
  {
    "text": "going to do this well I'm going to randomize the exort key the drop file names and the section hashes it is going",
    "start": "1229320",
    "end": "1236799"
  },
  {
    "text": "to be a different binary at least from a hash a hash perspective every single time it goes through uh",
    "start": "1236799",
    "end": "1244280"
  },
  {
    "text": "BDF now I have to re I had to reimplement the rsource uh stealing and",
    "start": "1244280",
    "end": "1249600"
  },
  {
    "text": "updating so I wrote my own rsource parser to update the rvas so if you if",
    "start": "1249600",
    "end": "1254640"
  },
  {
    "text": "you know what a what the resource section is you have uh branches you have",
    "start": "1254640",
    "end": "1259760"
  },
  {
    "text": "leaves and then at the very end of those leaves it's a link list pretty much uh you have the address relative virgal",
    "start": "1259760",
    "end": "1267039"
  },
  {
    "text": "address based on where it's loaded in memory and so I wrote a parer to update that now we have to compress and zor the",
    "start": "1267039",
    "end": "1276799"
  },
  {
    "text": "incoming file and user provided malware the author of AP lib was kind enough to provide um OSX um unreleased OSX U",
    "start": "1276799",
    "end": "1286440"
  },
  {
    "text": "libraries to support this so I was able to to support OSX and Linux uh and then finally we're going to",
    "start": "1286440",
    "end": "1295880"
  },
  {
    "text": "update the PE header the data section and the exor keys within the stub itself",
    "start": "1295880",
    "end": "1301960"
  },
  {
    "text": "so this is what we're rebuilding essentially right okay so this brings us",
    "start": "1301960",
    "end": "1308159"
  },
  {
    "text": "to the",
    "start": "1308159",
    "end": "1311200"
  },
  {
    "text": "demo all right",
    "start": "1316159",
    "end": "1320400"
  },
  {
    "text": "all right so I'm I'm using back door Factory itself right now I'm going to patch proc Explorer use",
    "start": "1329360",
    "end": "1336600"
  },
  {
    "text": "unuk method and I'm providing a binary that is x64bit",
    "start": "1336600",
    "end": "1342120"
  },
  {
    "text": "executable okay so I'm compressing right now you",
    "start": "1342120",
    "end": "1347799"
  },
  {
    "text": "can see this compressed with ap lib I have a a u a random exor",
    "start": "1347799",
    "end": "1355520"
  },
  {
    "text": "key and then it checks to see if it's a d and if it's not a dll it just continues",
    "start": "1362720",
    "end": "1370159"
  },
  {
    "text": "through and on the bottom left I have an interpreter session x64 bit interpreter",
    "start": "1370159",
    "end": "1375240"
  },
  {
    "text": "session now you'll notice that the binary itself is uh x86 so you can deploy x86 or 32 bit with",
    "start": "1375240",
    "end": "1385720"
  },
  {
    "text": "this there you go got a connection back now one thing",
    "start": "1393120",
    "end": "1399559"
  },
  {
    "text": "with on duuk is that the original malware would infect and then die uh it",
    "start": "1399559",
    "end": "1405440"
  },
  {
    "text": "would it would get a persistance location and then die so you have to migrate to another process for the other",
    "start": "1405440",
    "end": "1410520"
  },
  {
    "text": "process to pop up immediately now you can do this with metas you can automate",
    "start": "1410520",
    "end": "1415559"
  },
  {
    "text": "it but I just want to go through the steps to doing that so there you go I have the",
    "start": "1415559",
    "end": "1420960"
  },
  {
    "text": "migration you could see the icon Flash and then you have um just normal process",
    "start": "1420960",
    "end": "1427600"
  },
  {
    "text": "Explorer now one one nice thing about this feature is that if the user thinks",
    "start": "1427600",
    "end": "1433159"
  },
  {
    "text": "that something is wrong they'll go back and check the binary right they can right click see if it was signed after",
    "start": "1433159",
    "end": "1440159"
  },
  {
    "text": "it executes and they're going to find the original binary and my younger self had problems",
    "start": "1440159",
    "end": "1447960"
  },
  {
    "text": "closing this I want to apologize the guy doesn't write very good code",
    "start": "1447960",
    "end": "1455320"
  },
  {
    "text": "either so now I'm going to deploy a dll and I'm going to use the r flag the r flag is a new feature for BDF it um it",
    "start": "1455320",
    "end": "1463440"
  },
  {
    "text": "part it parses the resource section the Manifest file and and finds the requested execution level and if that",
    "start": "1463440",
    "end": "1469919"
  },
  {
    "text": "exists in the Manifest file it will patch it to highest",
    "start": "1469919",
    "end": "1475159"
  },
  {
    "text": "available okay so you can see that it it checked to see if it was a DL and it said yes it is a dll and then it patched",
    "start": "1475159",
    "end": "1482279"
  },
  {
    "text": "highest available in the P manifest now what this does it invokes UAC so now the",
    "start": "1482279",
    "end": "1488039"
  },
  {
    "text": "Mau is going to you know execute as admin",
    "start": "1488039",
    "end": "1492960"
  },
  {
    "text": "you can see the icon denoting that it needs to be executed as",
    "start": "1506480",
    "end": "1511840"
  },
  {
    "text": "admin USC prompt and then a connect back from",
    "start": "1512320",
    "end": "1519159"
  },
  {
    "text": "interpreter we get system",
    "start": "1519520",
    "end": "1526919"
  },
  {
    "text": "successfully and then we're going to migrate to a system",
    "start": "1526919",
    "end": "1532320"
  },
  {
    "text": "process you see the icon change back to non UAC so that's a red",
    "start": "1544880",
    "end": "1550240"
  },
  {
    "text": "flag but if the user right clicks and checks you'll see that it's signed so it's kind of a cool kind of cool",
    "start": "1550240",
    "end": "1559799"
  },
  {
    "text": "and then look at the digital signature it is signed by",
    "start": "1559799",
    "end": "1565360"
  },
  {
    "text": "Microsoft all right so that's the first demo",
    "start": "1572039",
    "end": "1576880"
  },
  {
    "text": "all right so this is BDF proxy config file now now what I'm going to do is",
    "start": "1594360",
    "end": "1599399"
  },
  {
    "text": "this this is how you patch man inthe middle binaries like you man in Middle patching the binaries with BDF proxy this is the config and what I'm doing is",
    "start": "1599399",
    "end": "1606440"
  },
  {
    "text": "I'm using the unuk method I'm going to patch run as admin for the U prompt and then I'm using x64bit uh binary with",
    "start": "1606440",
    "end": "1614720"
  },
  {
    "text": "32-bit binaries as they come across and then I'm going going to do the same thing with x64bit and I'm going to use",
    "start": "1614720",
    "end": "1620960"
  },
  {
    "text": "the x64bit interpeter reverse TCP SH now um let me zoom out of",
    "start": "1620960",
    "end": "1628000"
  },
  {
    "text": "that so I started BDF proxy and then now what I'm going to do there there's",
    "start": "1628000",
    "end": "1633399"
  },
  {
    "text": "through BDF proxy when you execute it a resour a met msf console resource file",
    "start": "1633399",
    "end": "1638919"
  },
  {
    "text": "is output it's written to this and then you can use that to launch uh metas",
    "start": "1638919",
    "end": "1645039"
  },
  {
    "text": "sploits and it will populate all the handlers that you use automatically so now I'm going to go",
    "start": "1645039",
    "end": "1650880"
  },
  {
    "text": "through and download uh executables from CIS internals now CIS internals you can",
    "start": "1650880",
    "end": "1657000"
  },
  {
    "text": "either use HTTP or https it's your choice secure or non-secure and now I'm going to go",
    "start": "1657000",
    "end": "1663279"
  },
  {
    "text": "through and uh update the config file to change it to a dll and the next request",
    "start": "1663279",
    "end": "1671000"
  },
  {
    "text": "that comes through dlls will be served because the uh config updates on the Fly",
    "start": "1671000",
    "end": "1677440"
  },
  {
    "text": "I'm going to zoom in on the I'm going to zoom in on this here so you'll see that the Mau is a DL",
    "start": "1682880",
    "end": "1691039"
  },
  {
    "text": "or not a DL and as I click on a piece of M or executable from a",
    "start": "1691039",
    "end": "1697039"
  },
  {
    "text": "website and now it is a dll",
    "start": "1697039",
    "end": "1701600"
  },
  {
    "text": "so there you go you can see that it's actually quite quick for smaller binaries",
    "start": "1704080",
    "end": "1709640"
  },
  {
    "text": "and so I uploaded a u onion Duke original on Duke binary to a file sharing site and I'm going to download",
    "start": "1709640",
    "end": "1716840"
  },
  {
    "text": "it and show you a feature that I added that's I thought was kind of neat",
    "start": "1716840",
    "end": "1723480"
  },
  {
    "text": "if I'm and what you're going to see next in the video is I'm going to execute a couple binaries and as that's going on",
    "start": "1723480",
    "end": "1729279"
  },
  {
    "text": "I'm going to kind of voice track the changes um so what I added was a feature",
    "start": "1729279",
    "end": "1734799"
  },
  {
    "text": "if it sees onion Duke come across so I have a signature that's pretty I think it's pretty solid for finding",
    "start": "1734799",
    "end": "1740240"
  },
  {
    "text": "onion Duke um if I see onion Duke come across I will rip off the original",
    "start": "1740240",
    "end": "1745519"
  },
  {
    "text": "malware and then put the user supplied Mal on the end thereby hijacking the original intent uh so you could either",
    "start": "1745519",
    "end": "1752440"
  },
  {
    "text": "you could either put just a popup box saying you you should not be downloading over HTTP or or you can put your own",
    "start": "1752440",
    "end": "1760240"
  },
  {
    "text": "malare right and so it takes a while for that",
    "start": "1760240",
    "end": "1766399"
  },
  {
    "text": "site to deliver the file because because they're serving ads and collecting information on",
    "start": "1766399",
    "end": "1772960"
  },
  {
    "text": "me let me pause it real",
    "start": "1775159",
    "end": "1779640"
  },
  {
    "text": "quick so you can see here where it says attempting to patch an unu graph",
    "start": "1783120",
    "end": "1788279"
  },
  {
    "text": "binary it went through and it remove the original",
    "start": "1788279",
    "end": "1793640"
  },
  {
    "text": "malare from the binary and then Rea it compressed using the same xor key that was supplied so if it's a different XR",
    "start": "1793640",
    "end": "1800880"
  },
  {
    "text": "key it'll it'll still work with it even if it's even if it's BDF patching it so if you have someone patching the output",
    "start": "1800880",
    "end": "1807120"
  },
  {
    "text": "coming out of BDF you could keep this going and they'll just they'll just replace the other malware as it keeps",
    "start": "1807120",
    "end": "1813200"
  },
  {
    "text": "going so it's kind of a kind of a",
    "start": "1813200",
    "end": "1817398"
  },
  {
    "text": "fun that's not what I wanted",
    "start": "1818279",
    "end": "1822840"
  },
  {
    "text": "so it is a dll as before removes the original M from the binary like I explained",
    "start": "1834480",
    "end": "1841240"
  },
  {
    "text": "earlier I'm going to go ahead and execute the file and you'll see that I will get a connect back proving that I",
    "start": "1841240",
    "end": "1848320"
  },
  {
    "text": "re that I remove the Mal successfully and I added run as admin to",
    "start": "1848320",
    "end": "1854559"
  },
  {
    "text": "it so I improved it",
    "start": "1854559",
    "end": "1858760"
  },
  {
    "text": "so it does take a little while for it to pop up because the VM is being overworked right now but you get the",
    "start": "1868080",
    "end": "1873559"
  },
  {
    "text": "picture",
    "start": "1873559",
    "end": "1876559"
  },
  {
    "text": "all right so after all that work the best that I could do with the AV evasion",
    "start": "1888240",
    "end": "1894840"
  },
  {
    "text": "was 20 out of 55 now I did not do any uh",
    "start": "1894840",
    "end": "1900000"
  },
  {
    "text": "large xoring of the text section I did not use any encryption uh I just changed",
    "start": "1900000",
    "end": "1905600"
  },
  {
    "text": "where file names were dropped for example McAfee sofos Microsoft trim micro micro and semantic they all keyed",
    "start": "1905600",
    "end": "1913480"
  },
  {
    "text": "off the file.exe just that file name so",
    "start": "1913480",
    "end": "1918600"
  },
  {
    "text": "um if you if you're targeting specific AV such as uh a AVG you can write",
    "start": "1918600",
    "end": "1925880"
  },
  {
    "text": "specific signatures for those antiviruses um as you see",
    "start": "1925880",
    "end": "1931679"
  },
  {
    "text": "fit so uh I flip these slides so just real three three points so nation state",
    "start": "1931679",
    "end": "1938279"
  },
  {
    "text": "malware is effective but it's not magical it's because it's developed in private um reusing of ideas techniques",
    "start": "1938279",
    "end": "1944760"
  },
  {
    "text": "and software are going to continue and the wasar agreement is not really going to do much to slow that down so any",
    "start": "1944760",
    "end": "1953080"
  },
  {
    "text": "questions well I thank you for coming so early I appreciate it and a special thanks to Travis Morrow Matt Graber",
    "start": "1957320",
    "end": "1963480"
  },
  {
    "text": "Jason Butterfield Chris chuner and will Scher I appreciate it thank you",
    "start": "1963480",
    "end": "1969639"
  },
  {
    "text": "[Applause]",
    "start": "1970890",
    "end": "1975069"
  }
]