[
  {
    "text": "hello everyone and thanks for coming today I'm Zach waserman this is my",
    "start": "3199",
    "end": "8800"
  },
  {
    "text": "co-presenter Marcos oo I'm the CTO at Fleet device management and one of the",
    "start": "8800",
    "end": "14280"
  },
  {
    "text": "co-creators of osquery which we'll talk a little bit more about today Marcos is a senior software engineer on our team",
    "start": "14280",
    "end": "21160"
  },
  {
    "text": "security researcher osquery maintainer an all-around Windows",
    "start": "21160",
    "end": "26720"
  },
  {
    "text": "expert so what brings us here to speak with you today about this topic well at",
    "start": "26720",
    "end": "32040"
  },
  {
    "text": "Fleet we're building a crossplatform MDM Solution that's intended to allow it",
    "start": "32040",
    "end": "38120"
  },
  {
    "text": "teams to manage their devices and while doing this we've been looking into the protocols and the implementations on Mac",
    "start": "38120",
    "end": "45160"
  },
  {
    "text": "OS and windows and a bit on Linux as well and being curious hackers we were",
    "start": "45160",
    "end": "52079"
  },
  {
    "text": "digging fairly deeply into what the what the protocols look like on Windows and when we did that we found some very",
    "start": "52079",
    "end": "58960"
  },
  {
    "text": "interesting things So today we're here to tell you the story of how to use abuse and exploit",
    "start": "58960",
    "end": "65720"
  },
  {
    "text": "the windows MDM stack now there's going to be a lot of technical details in this talk that we're going to go through very",
    "start": "65720",
    "end": "71759"
  },
  {
    "text": "quickly but there is a white paper and Associated resources and code that we'll be sharing at the end so stick around",
    "start": "71759",
    "end": "77920"
  },
  {
    "text": "for the link at the end to all of those resources as well there will be a cve number for the vulnerability that we",
    "start": "77920",
    "end": "86439"
  },
  {
    "text": "found and let's begin so command and control C2 is the process of attackers",
    "start": "86439",
    "end": "93880"
  },
  {
    "text": "being able to control the machines that they have exploited so typically an",
    "start": "93880",
    "end": "99439"
  },
  {
    "text": "agent is going to be installed on the machine that agent's going to communicate with the central server and",
    "start": "99439",
    "end": "104840"
  },
  {
    "text": "that's going to allow the attackers to control the machines that they've",
    "start": "104840",
    "end": "110320"
  },
  {
    "text": "compromised and now these typical agent-based approaches come with a few challenges in particular this is a well",
    "start": "110320",
    "end": "118439"
  },
  {
    "text": "understood portion of of detection for Defenders so the kind of persistence",
    "start": "118439",
    "end": "125520"
  },
  {
    "text": "techniques that are used the agent behaviors like unusual Network traffic",
    "start": "125520",
    "end": "130599"
  },
  {
    "text": "strange processes unrecognized processes changes to files and registry entries",
    "start": "130599",
    "end": "136120"
  },
  {
    "text": "that aren't usually done make a lot of opportunities for detection again the persistence becomes",
    "start": "136120",
    "end": "143879"
  },
  {
    "text": "an issue as well attackers have to find ways to persist across system reboots uh",
    "start": "143879",
    "end": "149200"
  },
  {
    "text": "update user logouts and that can attract further attention from",
    "start": "149200",
    "end": "155480"
  },
  {
    "text": "Defenders and then this cat and mouse game leads to Defenders having to do",
    "start": "155480",
    "end": "161280"
  },
  {
    "text": "constant updates to the tools to try to attackers having to do constant updates",
    "start": "161280",
    "end": "167200"
  },
  {
    "text": "to the tools to try to evade Defenders and build new functionality as the",
    "start": "167200",
    "end": "172480"
  },
  {
    "text": "landscape changes and so we wanted to look at how we could live off the land on window",
    "start": "172480",
    "end": "180440"
  },
  {
    "text": "using this MDM functionality to be more effective",
    "start": "180440",
    "end": "186040"
  },
  {
    "text": "attackers and so to do this we wanted to repurpose the existing features of the Windows operating",
    "start": "186040",
    "end": "192280"
  },
  {
    "text": "system and the legitimate Services built into it so we wanted to achieve better",
    "start": "192280",
    "end": "198239"
  },
  {
    "text": "operational Simplicity without having to develop new agents keep those agents up",
    "start": "198239",
    "end": "203440"
  },
  {
    "text": "to date we wanted to shift the Battleground from the typical detections of the agent",
    "start": "203440",
    "end": "210159"
  },
  {
    "text": "that's installed to something new a new paradigm that Defenders are less prepared",
    "start": "210159",
    "end": "216000"
  },
  {
    "text": "for and we wanted to use built-in persistence mechanisms in the operating system so that we would stand out less",
    "start": "216000",
    "end": "223640"
  },
  {
    "text": "to The Defenders with the control that we were bringing and we think that by living off",
    "start": "223640",
    "end": "229040"
  },
  {
    "text": "the land and abusing the legitimate Windows features that it can be easier for an attacker to get and maintain",
    "start": "229040",
    "end": "236640"
  },
  {
    "text": "control of the system",
    "start": "236640",
    "end": "241680"
  },
  {
    "text": "don't worry as we go through this talk you'll hear a lot about how things can be abused and broken at the end we will",
    "start": "241840",
    "end": "247799"
  },
  {
    "text": "be coming back to detections so I'm going to hand it off to Marcos now to talk about how he developed the concept",
    "start": "247799",
    "end": "254360"
  },
  {
    "text": "and all of the implications thank you s thank you Sak",
    "start": "254360",
    "end": "259519"
  },
  {
    "text": "yeah so we basically want to have a list of technologies that could be repurpose",
    "start": "259519",
    "end": "265160"
  },
  {
    "text": "for regionless control we thought about uh",
    "start": "265160",
    "end": "270280"
  },
  {
    "text": "having a component builtin a buil-in component on the Windows OS that can act",
    "start": "270280",
    "end": "275720"
  },
  {
    "text": "as a C2 allowing us to remotely control the device from a C2",
    "start": "275720",
    "end": "281240"
  },
  {
    "text": "server and we we have we initially started with a list of uh technologies",
    "start": "281240",
    "end": "286639"
  },
  {
    "text": "that could be suitable for this job we knew that MDM had a a lot of potential",
    "start": "286639",
    "end": "292039"
  },
  {
    "text": "here but we really wanted to to be sure that it was the right choice so we ended",
    "start": "292039",
    "end": "297199"
  },
  {
    "text": "up creating a selection criteria that allow us to classify different Technologies and escore those",
    "start": "297199",
    "end": "303560"
  },
  {
    "text": "Technologies to determine if those were suitable for this kind of a purpose so a",
    "start": "303560",
    "end": "309919"
  },
  {
    "text": "good component for uh for this should follow a client server architecture this",
    "start": "309919",
    "end": "315639"
  },
  {
    "text": "will allow us to have a bidirectional control between the the client and the server it should use HT https transport",
    "start": "315639",
    "end": "324560"
  },
  {
    "text": "because this helps to evade detections and also it's a a good transport",
    "start": "324560",
    "end": "330080"
  },
  {
    "text": "mechanism to use on2 it should have an extensible communication protocol and",
    "start": "330080",
    "end": "335440"
  },
  {
    "text": "this was key because we wanted to build our C2 protocol on top of uh the",
    "start": "335440",
    "end": "340720"
  },
  {
    "text": "protocol of this uh functionality of this uh Windows technology we wanted uh",
    "start": "340720",
    "end": "346440"
  },
  {
    "text": "the client component of this technology to be uh persistent and to run in a",
    "start": "346440",
    "end": "352120"
  },
  {
    "text": "privilege uh uh context that allow us to survive SE events like uh reboots",
    "start": "352120",
    "end": "360120"
  },
  {
    "text": "and of course as any other C2 we wanted to have a the ability and the",
    "start": "360120",
    "end": "365199"
  },
  {
    "text": "flexibility to execute the second stage payloads to have a full control of uh of",
    "start": "365199",
    "end": "372120"
  },
  {
    "text": "the of the endpoint and we also have like a list of uh good to have features that were not",
    "start": "372120",
    "end": "379720"
  },
  {
    "text": "like a hard requirements so I would the component",
    "start": "379720",
    "end": "384960"
  },
  {
    "text": "should be always running it should have a way to identify the connecting client",
    "start": "384960",
    "end": "390319"
  },
  {
    "text": "and it it will also uh expose access to management",
    "start": "390319",
    "end": "395400"
  },
  {
    "text": "interfaces so this is a list that we initially uh came up",
    "start": "395400",
    "end": "400800"
  },
  {
    "text": "with we started with a group policy Group Policy is the technology that uh empowers uh the so-called gpos and it",
    "start": "400800",
    "end": "408639"
  },
  {
    "text": "has a lot of uh good and bad uh for this uh purpose but uh the main drawback of a",
    "start": "408639",
    "end": "414160"
  },
  {
    "text": "group policy was the fact that it only works on a local network environment",
    "start": "414160",
    "end": "419520"
  },
  {
    "text": "that does not have a https uh transport support buil-in transport support so we",
    "start": "419520",
    "end": "425840"
  },
  {
    "text": "kind of discard discard group policy and move into wmi which suffers the same",
    "start": "425840",
    "end": "431240"
  },
  {
    "text": "issue it only works locally uh on the machine it it has the client and and",
    "start": "431240",
    "end": "437560"
  },
  {
    "text": "server uh architecture uh built in but it only works locally so then we we move",
    "start": "437560",
    "end": "443639"
  },
  {
    "text": "into winm which is the windows Remote Management which was quite interesting because Microsoft Microsoft has open uh",
    "start": "443639",
    "end": "451120"
  },
  {
    "text": "the specification for this technology the main issue with the winm was the",
    "start": "451120",
    "end": "456800"
  },
  {
    "text": "fact that the client is not exposed by default to the network so there there are some uh um issues and limitations",
    "start": "456800",
    "end": "463800"
  },
  {
    "text": "there so we Ender up discing Wim mostly because of that sorry uh and then we uh",
    "start": "463800",
    "end": "471120"
  },
  {
    "text": "analyze wns which is the notification system or or the push notification system as",
    "start": "471120",
    "end": "477520"
  },
  {
    "text": "Microsoft call it that um that allows a remote server to send uh messages to the",
    "start": "477520",
    "end": "484080"
  },
  {
    "text": "to a device but the the main issue with the this technology was the the fact that having a custom payloads or second",
    "start": "484080",
    "end": "490879"
  },
  {
    "text": "St second stage payloads was really difficult so we also uh dis discover",
    "start": "490879",
    "end": "498800"
  },
  {
    "text": "this this technology and then we move into MDM which really the only limitation was the fact that the mdn",
    "start": "498800",
    "end": "506240"
  },
  {
    "text": "client on the device was not always running but then we we got to to to find",
    "start": "506240",
    "end": "512120"
  },
  {
    "text": "that uh we can indirectly indirectly control when the M clients runs and",
    "start": "512120",
    "end": "518200"
  },
  {
    "text": "we're going to see that in the following slides so knowing that MDM was the a",
    "start": "518200",
    "end": "523719"
  },
  {
    "text": "good candidate for this uh purpose let let's now think on how to repurpose MDM",
    "start": "523719",
    "end": "531760"
  },
  {
    "text": "for our for our goals so MDM it's um it's a client and server",
    "start": "531760",
    "end": "540959"
  },
  {
    "text": "uh uh protocol uh Microsoft has Shi uh the MDM client as part of the Windows 10",
    "start": "540959",
    "end": "548600"
  },
  {
    "text": "since it's first version uh and the mdn client functionality is uh building on",
    "start": "548600",
    "end": "556200"
  },
  {
    "text": "the OS and it's ready to be consumed there is also besides the MDM client there is also the MDM server which",
    "start": "556200",
    "end": "563640"
  },
  {
    "text": "Microsoft does not provide an open implementation uh to it but it does provide the a specific ations to build a",
    "start": "563640",
    "end": "571320"
  },
  {
    "text": "an MDM server so they provide uh the protocols that can be used to build a",
    "start": "571320",
    "end": "578200"
  },
  {
    "text": "third party MDM server they do have also a a commercial offerings which is called",
    "start": "578200",
    "end": "584000"
  },
  {
    "text": "InTune but that if we want to build our own uh MDM server we will have to go",
    "start": "584000",
    "end": "591200"
  },
  {
    "text": "through the protocol specifications and make sure to implement all the required end points to to achieve the to achieve",
    "start": "591200",
    "end": "597920"
  },
  {
    "text": "the the work so the MDM client is basically composed by two uh set of functionalities you have a",
    "start": "597920",
    "end": "605720"
  },
  {
    "text": "enrollment logic which is the one in charge of uh registering the device into",
    "start": "605720",
    "end": "611360"
  },
  {
    "text": "the MDM server so that registration process involve exchanging mul",
    "start": "611360",
    "end": "617160"
  },
  {
    "text": "authentication and also receiving a provision information from the mdn server and also the identity certificate",
    "start": "617160",
    "end": "624959"
  },
  {
    "text": "that will enable further communication uh through the management logic so the",
    "start": "624959",
    "end": "631760"
  },
  {
    "text": "management logic is the the this the logic that takes in once the enrollment",
    "start": "631760",
    "end": "637959"
  },
  {
    "text": "already happens it's and it's really the one that received the the the MDM commands from the server and enforce",
    "start": "637959",
    "end": "644360"
  },
  {
    "text": "those commands locally through a series of management objects so this is how the MDR",
    "start": "644360",
    "end": "651279"
  },
  {
    "text": "enrollment uh work so it's uh this uh uh uh specification is defined by this",
    "start": "651279",
    "end": "657519"
  },
  {
    "text": "protocol MS smd2 so everything start with a call into the mdn client so any application can call",
    "start": "657519",
    "end": "664360"
  },
  {
    "text": "into the mdn client and trigger a programatic enrollment so then the MDM client will uh talk to the MDM server",
    "start": "664360",
    "end": "672800"
  },
  {
    "text": "through a series of https soap base calls and it will start by retrieving",
    "start": "672800",
    "end": "679120"
  },
  {
    "text": "the endpoints that URLs URLs are going to be used through the enrollment process and it will then uh ask the MDM",
    "start": "679120",
    "end": "686920"
  },
  {
    "text": "server for the encryption policies that should be used to generate the",
    "start": "686920",
    "end": "693120"
  },
  {
    "text": "Certificate request that is going to be sent to the server through the",
    "start": "693120",
    "end": "698600"
  },
  {
    "text": "enrollment step so during this enrollment steps is really where the actual registration of the device",
    "start": "698600",
    "end": "703920"
  },
  {
    "text": "happened so the the the client is sending this Certificate request to the",
    "start": "703920",
    "end": "709320"
  },
  {
    "text": "server and asking the server to provide a signed certificate along with the some",
    "start": "709320",
    "end": "715600"
  },
  {
    "text": "provision information that the client is going to end up enforcing on the OS so",
    "start": "715600",
    "end": "721480"
  },
  {
    "text": "once as I mentioned once that the enrollment is done we then move into the",
    "start": "721480",
    "end": "726680"
  },
  {
    "text": "management piece so at this point the device is already provisioned it already has an identity and it already has a a",
    "start": "726680",
    "end": "734440"
  },
  {
    "text": "mul authentication with the server so the management flow is uh uh can be a started through a",
    "start": "734440",
    "end": "744199"
  },
  {
    "text": "sched task which is also configured during the enrollment or it can be started through a push notification from",
    "start": "744199",
    "end": "750279"
  },
  {
    "text": "the server so when the management flow starts it's going to call into the MDM",
    "start": "750279",
    "end": "757240"
  },
  {
    "text": "server and it's going to ask the MDM server to provide a series of uh uh MDM",
    "start": "757240",
    "end": "762519"
  },
  {
    "text": "commands to execute and those commands are going to be received by the client and are going to be enforced through a",
    "start": "762519",
    "end": "768839"
  },
  {
    "text": "series of management objects and the results of those command execution are going to be sent back to the",
    "start": "768839",
    "end": "776760"
  },
  {
    "text": "server so the those management objects that I've been mentioning are really the",
    "start": "776760",
    "end": "783720"
  },
  {
    "text": "backbone of uh MDM they're really the ones that provides the key functionality to the mdn management protocol and the",
    "start": "783720",
    "end": "791959"
  },
  {
    "text": "the the management objects are called configuration service providers uh csps",
    "start": "791959",
    "end": "797680"
  },
  {
    "text": "for short and they provide a more modern and Cloud friendly way to configure",
    "start": "797680",
    "end": "803920"
  },
  {
    "text": "settings on the device these are like uh the um the the altern natives the modern",
    "start": "803920",
    "end": "809680"
  },
  {
    "text": "alternatives to to gpos and there are a lot of them already there on the uh",
    "start": "809680",
    "end": "815399"
  },
  {
    "text": "Windows OS most of them are documented there are few of them that are not documented but most of them are",
    "start": "815399",
    "end": "821760"
  },
  {
    "text": "documented and well documented by by Microsoft and there are implemented through uh dlls there is a a a a",
    "start": "821760",
    "end": "829639"
  },
  {
    "text": "component called configuration manager config manager 2 which is the one that uh loads these DLS and expose those DLS",
    "start": "829639",
    "end": "838320"
  },
  {
    "text": "to the MDM client as an example of uh CSP that",
    "start": "838320",
    "end": "845320"
  },
  {
    "text": "manage the security features of a Windows operative system we have the",
    "start": "845320",
    "end": "850639"
  },
  {
    "text": "account CSP which allows MDM server to configure local account it this uh CSP",
    "start": "850639",
    "end": "857880"
  },
  {
    "text": "can be used to create new accounts set passwords to the to the accounts and assign groups to to a new account we",
    "start": "857880",
    "end": "865399"
  },
  {
    "text": "have a Defender CP which control all the different uh configuration aspect of Microsoft Defender we have the firewall",
    "start": "865399",
    "end": "872839"
  },
  {
    "text": "CSP that does the same for firewall it allow us to uh configure different",
    "start": "872839",
    "end": "877959"
  },
  {
    "text": "firewall rules and to enable or disable firewall profiles and we have a a bunch",
    "start": "877959",
    "end": "883519"
  },
  {
    "text": "of them that are really useful for security purposes so how these uh configuration",
    "start": "883519",
    "end": "890639"
  },
  {
    "text": "service providers can be actually configure so for that we have a syncml so syncml is really the protocol that go",
    "start": "890639",
    "end": "898720"
  },
  {
    "text": "goes through uh the management flow and it's a an open protocol again that is",
    "start": "898720",
    "end": "904560"
  },
  {
    "text": "based on an all specification called omad DM so this protocol is XML based",
    "start": "904560",
    "end": "912199"
  },
  {
    "text": "and it's Expos a different set of actions that can be performed on a given",
    "start": "912199",
    "end": "919440"
  },
  {
    "text": "CSP uh so when we were thinking about abusing this protocol we really we",
    "start": "919519",
    "end": "927160"
  },
  {
    "text": "really thought that this will make detection hard because it will be",
    "start": "927160",
    "end": "933160"
  },
  {
    "text": "difficult to identify legitimate traffic from malicious traffic so we were we",
    "start": "933160",
    "end": "939120"
  },
  {
    "text": "were we thought that uh having examples on how this could be abuse will help us",
    "start": "939120",
    "end": "945240"
  },
  {
    "text": "to make the this point so this is an example of H how a synl payot looks like",
    "start": "945240",
    "end": "954360"
  },
  {
    "text": "so we have a a verb this in this case the get verb and we have a a a Target",
    "start": "954360",
    "end": "961440"
  },
  {
    "text": "URI that identifies the target CSP and the property of that CSP so this comma",
    "start": "961440",
    "end": "967519"
  },
  {
    "text": "request is uh basically retrieving the value of this device ID uh property and",
    "start": "967519",
    "end": "976160"
  },
  {
    "text": "the response for that request is uh this one over here so you get the value you get the origin of the request and you",
    "start": "976160",
    "end": "983600"
  },
  {
    "text": "get the The Verve for that response which is a results easy right so through",
    "start": "983600",
    "end": "989040"
  },
  {
    "text": "this uh simple XML we can already do a lot of stuff on on the on the endpoint",
    "start": "989040",
    "end": "994920"
  },
  {
    "text": "so this already provides living off the land capabilities so someone that could",
    "start": "994920",
    "end": "1000680"
  },
  {
    "text": "Implement a MDM server and register the device into that Rog MDM server it will",
    "start": "1000680",
    "end": "1007440"
  },
  {
    "text": "be able to configure different and multiple security aspect of on the",
    "start": "1007440",
    "end": "1012959"
  },
  {
    "text": "endpoint and this is an example of that so this XML simple XML could be used to",
    "start": "1012959",
    "end": "1019600"
  },
  {
    "text": "add an exclusion to Windows Defender and by doing that restrict the ability to",
    "start": "1019600",
    "end": "1025600"
  },
  {
    "text": "Defender to detect a malicious payload running from that directory this could",
    "start": "1025600",
    "end": "1031000"
  },
  {
    "text": "be done through the policy CSP another example to the same CSP is uh this one",
    "start": "1031000",
    "end": "1037079"
  },
  {
    "text": "which will disable Windows updates then we have another example to",
    "start": "1037079",
    "end": "1042120"
  },
  {
    "text": "disable firewall this case we are just disabling the public profile of the",
    "start": "1042120",
    "end": "1047240"
  },
  {
    "text": "firewall just by sending a simple XML that that's the beauty of this approach",
    "start": "1047240",
    "end": "1052840"
  },
  {
    "text": "I mean that everything is reachable and configurable through XML payload that could be sent from the server to the",
    "start": "1052840",
    "end": "1058960"
  },
  {
    "text": "client then we have another one to create a VOR on the system by uh uh",
    "start": "1058960",
    "end": "1065600"
  },
  {
    "text": "creating a new privilege user and then we have another one which",
    "start": "1065600",
    "end": "1071720"
  },
  {
    "text": "it's uh really useful to deploy the payLo so it's basically a capability to",
    "start": "1071720",
    "end": "1078240"
  },
  {
    "text": "uh install arbitrary msis on on the system through the Enterprise desktop",
    "start": "1078240",
    "end": "1085440"
  },
  {
    "text": "apps App Management CSP good so while going through the CSP",
    "start": "1085440",
    "end": "1092960"
  },
  {
    "text": "documentation we found a lot of uh interesting uh stuff there are really a",
    "start": "1092960",
    "end": "1098360"
  },
  {
    "text": "lot of things that could be abused for uh malicious or even red teaming uh",
    "start": "1098360",
    "end": "1106240"
  },
  {
    "text": "purposes and this one really caught my attention so there is one CSP called",
    "start": "1106240",
    "end": "1111799"
  },
  {
    "text": "diagnostic log CSP which provides a lot of uh uh diagnostic capability to the",
    "start": "1111799",
    "end": "1118520"
  },
  {
    "text": "MDM server it allows the MDM server to execute the arbitrary commands on the",
    "start": "1118520",
    "end": "1124919"
  },
  {
    "text": "device such as ip config and then it allows the mdn server",
    "start": "1124919",
    "end": "1130240"
  },
  {
    "text": "to provide a URL where the execution results of uh sorry where the result of",
    "start": "1130240",
    "end": "1137480"
  },
  {
    "text": "those execution will be sent so you end up sending the command that you want to",
    "start": "1137480",
    "end": "1143880"
  },
  {
    "text": "execute then you put the URL where you are going to receive the output of those",
    "start": "1143880",
    "end": "1149440"
  },
  {
    "text": "commands and you send that payLo to the to the endpoint so while trying this out I got to see that there were also a tag",
    "start": "1149440",
    "end": "1159440"
  },
  {
    "text": "called folder and files that are on the example commentation contains contains the path to an ETL and that c uh got me",
    "start": "1159440",
    "end": "1168000"
  },
  {
    "text": "think on why this was uh asking for uh etls so by looking into the CSP I got to",
    "start": "1168000",
    "end": "1176360"
  },
  {
    "text": "see that there is also a way to abuse etw through this CSP so you can",
    "start": "1176360",
    "end": "1183480"
  },
  {
    "text": "configure and manage the life cycle of a etw tracing session which and and add",
    "start": "1183480",
    "end": "1189640"
  },
  {
    "text": "any etw provider to that tracing s which basically expose the ability to remotely",
    "start": "1189640",
    "end": "1197120"
  },
  {
    "text": "Trace uh Remote device so that's that was kind of uh surprising because uh",
    "start": "1197120",
    "end": "1204360"
  },
  {
    "text": "having this uh ability will give anyone that uh has uh control on that uh enroll",
    "start": "1204360",
    "end": "1211080"
  },
  {
    "text": "device the capability to listen to any ew provider good so at this point we got",
    "start": "1211080",
    "end": "1218080"
  },
  {
    "text": "to we we got enough of Aion we already Pro that this can be abused in different",
    "start": "1218080",
    "end": "1225320"
  },
  {
    "text": "ways and uh we started to think that okay is there a way to break this",
    "start": "1225320",
    "end": "1230480"
  },
  {
    "text": "because we we got to find that one big limitation for our goal was the fact",
    "start": "1230480",
    "end": "1235960"
  },
  {
    "text": "that the MDM enrollment can only be triggered from a privileged context and",
    "start": "1235960",
    "end": "1241400"
  },
  {
    "text": "by privileged context I meant that uh the user performing the MDM enrollment",
    "start": "1241400",
    "end": "1247919"
  },
  {
    "text": "the programmatic MDM enrollment should be an an administrator user doesn't have to uh like run the",
    "start": "1247919",
    "end": "1255880"
  },
  {
    "text": "programmatic enrollment from a elevated context it just to needs to have administrator as part of a this uh",
    "start": "1255880",
    "end": "1263919"
  },
  {
    "text": "groups so um so we wanted to find a way to achieve the same but not having to",
    "start": "1263919",
    "end": "1270760"
  },
  {
    "text": "rely on having administrator uh uh privileges so for that we uh started to",
    "start": "1270760",
    "end": "1279039"
  },
  {
    "text": "look into the en Roman FR because this is really the the entry point for uh this work uh so we we analyze the the M",
    "start": "1279039",
    "end": "1288360"
  },
  {
    "text": "client stock we did a lot of reverse engineering on the different companies on the client stock our idea was to find",
    "start": "1288360",
    "end": "1294880"
  },
  {
    "text": "basically a a vulnerability that allow us to perform this device enrollment from an unprivileged non-admin user",
    "start": "1294880",
    "end": "1303200"
  },
  {
    "text": "context so for that we need to take you through the MDM enrollment execution",
    "start": "1303200",
    "end": "1309039"
  },
  {
    "text": "flow so everything start with an application calling into the mdn client functionality then mdn client",
    "start": "1309039",
    "end": "1315200"
  },
  {
    "text": "functionality is exposed by a a Windows a runtime class win RT class living",
    "start": "1315200",
    "end": "1321679"
  },
  {
    "text": "inside of a service so the client so the application is a asking the dcom",
    "start": "1321679",
    "end": "1327200"
  },
  {
    "text": "activator to activate this winnert class and and return an interface pointer that",
    "start": "1327200",
    "end": "1332240"
  },
  {
    "text": "can be consumed the application will then use that to call into the CL into the uh winnert class then the winnert",
    "start": "1332240",
    "end": "1339799"
  },
  {
    "text": "class will use uh the enrollment engine functionality living in a dll to",
    "start": "1339799",
    "end": "1346600"
  },
  {
    "text": "actually perform the enrollment process process and then after that enrollment process is done the the settings will be",
    "start": "1346600",
    "end": "1352960"
  },
  {
    "text": "provisioned and the scale task that will trigger the local management activities",
    "start": "1352960",
    "end": "1358320"
  },
  {
    "text": "will will be achieved so something that we get to see over here after hours and",
    "start": "1358320",
    "end": "1364679"
  },
  {
    "text": "hours of uh uh reverse engine is that first of all we were interested on",
    "start": "1364679",
    "end": "1370840"
  },
  {
    "text": "on finding logical vulnerabilities we are really a big fan of uh logical bags we are not that into memory corruption",
    "start": "1370840",
    "end": "1377720"
  },
  {
    "text": "with we thought that there is a lot of Beauty on finding logical abilities so after hours and hours of research we got",
    "start": "1377720",
    "end": "1384640"
  },
  {
    "text": "to see that there was a way to access enroll engine uh functionality to",
    "start": "1384640",
    "end": "1390960"
  },
  {
    "text": "perform device enrollment related to asure ID that could be abuse for this",
    "start": "1390960",
    "end": "1397480"
  },
  {
    "text": "purpose so we uh uh ended up creating an exploit for this the exploit got",
    "start": "1397480",
    "end": "1404039"
  },
  {
    "text": "assigned with the CB and this uh CB really all us to uh",
    "start": "1404039",
    "end": "1409480"
  },
  {
    "text": "perform something that we call Deep which is uh really an exploitation",
    "start": "1409480",
    "end": "1414720"
  },
  {
    "text": "primitive to enroll a device into a a remote MDM server uh so once you enroll the device",
    "start": "1414720",
    "end": "1423039"
  },
  {
    "text": "into DM server there's really a lot of use cases that you can do after that we",
    "start": "1423039",
    "end": "1428640"
  },
  {
    "text": "prototyped two use cases uh the an arbitrary payload that Deploy on the system and a local priv privilege",
    "start": "1428640",
    "end": "1435480"
  },
  {
    "text": "escalation we disclosed this vulnerability to Microsoft back in April and after some back and forth to um uh",
    "start": "1435480",
    "end": "1442720"
  },
  {
    "text": "help them to uh demonstrate the impact this vulnerability was patch on",
    "start": "1442720",
    "end": "1448240"
  },
  {
    "text": "yesterday uh patch release so be sure to patch your Fleet because this was just",
    "start": "1448240",
    "end": "1455760"
  },
  {
    "text": "patch and the use case for local privilege escalation looks like this so",
    "start": "1455760",
    "end": "1461240"
  },
  {
    "text": "once the is uh uh executed and the enrollment is performed on the device",
    "start": "1461240",
    "end": "1466360"
  },
  {
    "text": "the NDM server can send uh a synl command to in this case create",
    "start": "1466360",
    "end": "1471720"
  },
  {
    "text": "a privileged user on the system which the exploit can uh take profit uh and",
    "start": "1471720",
    "end": "1477200"
  },
  {
    "text": "use it to execute a a CMD on a privilege uh context and the same for payload",
    "start": "1477200",
    "end": "1484559"
  },
  {
    "text": "deployment the same thing here we are enrolling the device and then receiving a an arbitrary synl to deploy an MSI on",
    "start": "1484559",
    "end": "1492960"
  },
  {
    "text": "the system so we are going to see that demo really quick so this is the demo of",
    "start": "1492960",
    "end": "1501480"
  },
  {
    "text": "uh of Deep In Action so on one side we have a a Windows Pock NDM server which",
    "start": "1501480",
    "end": "1508679"
  },
  {
    "text": "is running with the commands that we wanted and then we have the exploit on the other side which is going to um",
    "start": "1508679",
    "end": "1515919"
  },
  {
    "text": "Target that mdn server so I'm Sting with the just checking that uh everything",
    "start": "1515919",
    "end": "1521360"
  },
  {
    "text": "runs from an unprivileged context and then after running the exploit there is going to be some exchange with the then",
    "start": "1521360",
    "end": "1528080"
  },
  {
    "text": "server to enroll the device and receive the syncml command which will then finish with a uh a privileged CMD",
    "start": "1528080",
    "end": "1536240"
  },
  {
    "text": "running a system and then just for you to see this is uh the synl command that",
    "start": "1536240",
    "end": "1543200"
  },
  {
    "text": "it's uh going that was also delivered on this demo that is going to end up running uh a Powershell uh payload from",
    "start": "1543200",
    "end": "1552480"
  },
  {
    "text": "a enemy side on the system so we get to see the tree here",
    "start": "1552480",
    "end": "1559480"
  },
  {
    "text": "there you go yeah",
    "start": "1559480",
    "end": "1564720"
  },
  {
    "text": "okay yeah that that's the poers shell runting in here okay good so back to the",
    "start": "1565320",
    "end": "1573679"
  },
  {
    "text": "slide so we thought that this will be really useful for someone like a national state so we we thought that it",
    "start": "1573679",
    "end": "1581320"
  },
  {
    "text": "will be kind of cool to came up with a a proof of concept Asian Le C2 system that",
    "start": "1581320",
    "end": "1586640"
  },
  {
    "text": "anyone can use and and with a really basic functionality but it will",
    "start": "1586640",
    "end": "1592080"
  },
  {
    "text": "demonstrate the purpose that it will allows uh Defenders to come up with the detection strategies for this so that's",
    "start": "1592080",
    "end": "1600080"
  },
  {
    "text": "why we ended up creating Matador so Matador is a a proof of concept aess suu",
    "start": "1600080",
    "end": "1606520"
  },
  {
    "text": "system that they use and has built-in support for MS smdm m Ms md2 which are",
    "start": "1606520",
    "end": "1613520"
  },
  {
    "text": "the M uh the MDM protocols this has a beoning support buil-in beoning support",
    "start": "1613520",
    "end": "1619600"
  },
  {
    "text": "through Ms smdm and it's also have an an extensible uh C2",
    "start": "1619600",
    "end": "1625080"
  },
  {
    "text": "protocol which provides support for second stage payloads so this is a a",
    "start": "1625080",
    "end": "1630880"
  },
  {
    "text": "quite uh high level look on on how the the C2 protocol looks like so so we are",
    "start": "1630880",
    "end": "1636720"
  },
  {
    "text": "basically using a a custom URI that uh relies on the uh a custom CSP so we",
    "start": "1636720",
    "end": "1644240"
  },
  {
    "text": "ended up reversing the CSP interface to up with a a proof of concept CSP that",
    "start": "1644240",
    "end": "1650880"
  },
  {
    "text": "allow us to deploy this CSP on the system and execute execute second stage",
    "start": "1650880",
    "end": "1656480"
  },
  {
    "text": "payloads on on the device and this is the demo of",
    "start": "1656480",
    "end": "1662559"
  },
  {
    "text": "Matador so we are going to see that right now so that there there are two sections on the",
    "start": "1662559",
    "end": "1669320"
  },
  {
    "text": "demo this first section uh is going to Showcase uh how the Met can be used for",
    "start": "1669320",
    "end": "1675960"
  },
  {
    "text": "abuse purposes so we are just relying on this legitimate CSP and just",
    "start": "1675960",
    "end": "1681880"
  },
  {
    "text": "uh disabling security functionality on the endpoint so Matador is a go",
    "start": "1681880",
    "end": "1687279"
  },
  {
    "text": "Application is a which uh end UPS being a buil-in",
    "start": "1687279",
    "end": "1692480"
  },
  {
    "text": "binary a selfcontain binary sorry so where we are seeing over here is a a",
    "start": "1692480",
    "end": "1698120"
  },
  {
    "text": "Windows 11 device using buildin MDM client functionality so not sure if you",
    "start": "1698120",
    "end": "1706080"
  },
  {
    "text": "manag to see that but here we are going to settings then",
    "start": "1706080",
    "end": "1713120"
  },
  {
    "text": "accounts then access work of school and then setting over there the email that",
    "start": "1714679",
    "end": "1720480"
  },
  {
    "text": "we want to use at the entry point for infection so the email contains a domain which uh implements a discovery uh",
    "start": "1720480",
    "end": "1729480"
  },
  {
    "text": "protocol that allows uh the the MDM client to register that device into MDM",
    "start": "1729480",
    "end": "1735399"
  },
  {
    "text": "so we're not using any uh agent here we're not using any estage",
    "start": "1735399",
    "end": "1740960"
  },
  {
    "text": "zero here we're just relying on functionality buildin on device to enroll that device into the Rock MDM C2",
    "start": "1740960",
    "end": "1750519"
  },
  {
    "text": "server so once we do that uh the enroll device will appear on meta dashbo we can",
    "start": "1750519",
    "end": "1756840"
  },
  {
    "text": "then go and manage the different device settings we have a the information from",
    "start": "1756840",
    "end": "1762600"
  },
  {
    "text": "that device that was retrieved from uh the manage through the man protocol we",
    "start": "1762600",
    "end": "1768600"
  },
  {
    "text": "have a we have a sorry we have a access to the security functionality on the device so we can go ahead and disabling",
    "start": "1768600",
    "end": "1775799"
  },
  {
    "text": "things such as a Windows Defender so we are going to check first here that Defender is enabled on the system we can",
    "start": "1775799",
    "end": "1784960"
  },
  {
    "text": "get to see that everything is on same as a firewall okay so I going to speed up a",
    "start": "1784960",
    "end": "1794200"
  },
  {
    "text": "bit and then we can uh go ahead and check on uh",
    "start": "1794200",
    "end": "1800080"
  },
  {
    "text": "Matador and make sure that",
    "start": "1800080",
    "end": "1805600"
  },
  {
    "text": "we disable this functionality from The Matador",
    "start": "1805960",
    "end": "1811799"
  },
  {
    "text": "dashboard and and once the the next beoning GES in which happens every",
    "start": "1811799",
    "end": "1817760"
  },
  {
    "text": "minute we will get to see that that functionality was uh already disabled on",
    "start": "1817760",
    "end": "1823240"
  },
  {
    "text": "the on the system there you go that was the the beoning part and then if we go",
    "start": "1823240",
    "end": "1828440"
  },
  {
    "text": "back to the to the device we will see that uh those features are now uh",
    "start": "1828440",
    "end": "1835720"
  },
  {
    "text": "disabled so for example that's a firewall everything is off and the same for a",
    "start": "1838760",
    "end": "1847360"
  },
  {
    "text": "Defender so Defender was disabled through a simple XML command so that's a",
    "start": "1850840",
    "end": "1855919"
  },
  {
    "text": "beautiful disa approach so if we go to see another demo really quick this is a",
    "start": "1855919",
    "end": "1863120"
  },
  {
    "text": "a demo that use the custom cfp to provide an arbitrary shell to the to the",
    "start": "1863120",
    "end": "1870600"
  },
  {
    "text": "device so the shell is waiting for the next beon in session and then when that process",
    "start": "1870600",
    "end": "1876559"
  },
  {
    "text": "ends we will see that got connection to that device and then",
    "start": "1876559",
    "end": "1883600"
  },
  {
    "text": "we can execute the commands on on the device good",
    "start": "1883600",
    "end": "1888840"
  },
  {
    "text": "okay going back to the slide I'm going to give a sack now",
    "start": "1888840",
    "end": "1896279"
  },
  {
    "text": "the access to the slide so he can present the implications and detections thank you Marcos so now that we've",
    "start": "1896279",
    "end": "1903519"
  },
  {
    "text": "discussed the ways that you can use abuse and exploit this we want to talk about some opportunities for",
    "start": "1903519",
    "end": "1911519"
  },
  {
    "text": "detection what can you do as a Defender so this is normal fun functionality",
    "start": "1911519",
    "end": "1917600"
  },
  {
    "text": "that's built into the OS so it's a little bit trickier than normal detection might be because we might be",
    "start": "1917600",
    "end": "1923480"
  },
  {
    "text": "using this within our organizations for legitimate purposes but we can do things like identify unusual MDM enrollments we",
    "start": "1923480",
    "end": "1932080"
  },
  {
    "text": "can analyze the relevant event log and etw events that are coming through",
    "start": "1932080",
    "end": "1938159"
  },
  {
    "text": "that we can track changes to the csps so for example we can detect things like",
    "start": "1938159",
    "end": "1943960"
  },
  {
    "text": "this shell plug-in that was installed through The Matador",
    "start": "1943960",
    "end": "1949159"
  },
  {
    "text": "demo and we can monitor the scheduled tasks which are the normal scheduled",
    "start": "1949159",
    "end": "1954200"
  },
  {
    "text": "tasks that would be there for MDM but they're only normal if you're actually using the MDM functionality and so as we go to explain",
    "start": "1954200",
    "end": "1963080"
  },
  {
    "text": "some detection ideas we're a bit biased being both folks who work on osquery and",
    "start": "1963080",
    "end": "1968440"
  },
  {
    "text": "so we're going to give you these detections in osquery format but",
    "start": "1968440",
    "end": "1973559"
  },
  {
    "text": "something that I want you all to remember is that what osquery is accessing is is just it's just an easier interface on everything that's already",
    "start": "1973559",
    "end": "1980440"
  },
  {
    "text": "there and available in the operating system and osquery itself is of course open source and free so if you're not",
    "start": "1980440",
    "end": "1986760"
  },
  {
    "text": "already using it feel free to install it and start using it for these kind of detections but if you're not using it",
    "start": "1986760",
    "end": "1993120"
  },
  {
    "text": "and you don't want to you can do these kind of detections with any sort of EDR or forensics",
    "start": "1993120",
    "end": "2000080"
  },
  {
    "text": "tools so the first thing that we that we look for is looking for artifacts of the",
    "start": "2000080",
    "end": "2005440"
  },
  {
    "text": "MDM enrollment so we can look for the certificates that are provisioned by",
    "start": "2005440",
    "end": "2010720"
  },
  {
    "text": "that enrollment process that Marcos discussed and so in this case we use the certificates table in osquery to look",
    "start": "2010720",
    "end": "2017399"
  },
  {
    "text": "under the specific path where the where the MDM client certificate will be",
    "start": "2017399",
    "end": "2024600"
  },
  {
    "text": "stored next we can look at the information about active MDM enrollments",
    "start": "2025200",
    "end": "2030559"
  },
  {
    "text": "and this is stored in the Windows registry I think with both of these it's",
    "start": "2030559",
    "end": "2035600"
  },
  {
    "text": "really important again to remember remember that there may be many legitimate use cases in which MDM is",
    "start": "2035600",
    "end": "2041880"
  },
  {
    "text": "being used on these systems so just because you have something here because",
    "start": "2041880",
    "end": "2047080"
  },
  {
    "text": "this query returns something does not mean you're infected but what this does give us is the URL of the management",
    "start": "2047080",
    "end": "2054000"
  },
  {
    "text": "server and if this isn't the management server that your organization typically uses or your organization isn't using",
    "start": "2054000",
    "end": "2060480"
  },
  {
    "text": "MDM then this is probably a big problem so something that you should be looking out for and of course because this is",
    "start": "2060480",
    "end": "2066679"
  },
  {
    "text": "just looking for specific values in the registry almost any Windows defensive tool would allow you to to find",
    "start": "2066679",
    "end": "2075559"
  },
  {
    "text": "this and the Windows Event log will also include events around this so you can",
    "start": "2076040",
    "end": "2082919"
  },
  {
    "text": "see everything that's happening in terms of enrollments and beaconing going through the the MDM management client",
    "start": "2082919",
    "end": "2090919"
  },
  {
    "text": "and this is the particular Channel you can see down there at the bottom where those event log entries will be",
    "start": "2090919",
    "end": "2099480"
  },
  {
    "text": "stored and then there are the scheduled tasks that come from the MDM again this",
    "start": "2100560",
    "end": "2106040"
  },
  {
    "text": "is another place where yes scheduled tasks are a very common persistence mechanism but you might not be used to",
    "start": "2106040",
    "end": "2111839"
  },
  {
    "text": "looking out for these because these may very well be legitimate use cases again so if you're using MDM intentionally the",
    "start": "2111839",
    "end": "2119720"
  },
  {
    "text": "fact that these scheduled task exists probably doesn't tell you much but if you're not using MDM then I'd be really",
    "start": "2119720",
    "end": "2125240"
  },
  {
    "text": "concerned if you had scheduled task associated with the certain roller and the omad DM",
    "start": "2125240",
    "end": "2132760"
  },
  {
    "text": "Client and then we can look in the registry again for the registration of",
    "start": "2134079",
    "end": "2139960"
  },
  {
    "text": "these custom csps again this is what was used for that last demo where there was the interactive shell so we didn't",
    "start": "2139960",
    "end": "2146839"
  },
  {
    "text": "actually have to install an agent for that we just installed a dll in that case that put that functionality into a",
    "start": "2146839",
    "end": "2153240"
  },
  {
    "text": "custom CSP and you can look in this path with in the registry to find any",
    "start": "2153240",
    "end": "2159119"
  },
  {
    "text": "registrations of custom csps and then another thing that you can",
    "start": "2159119",
    "end": "2166119"
  },
  {
    "text": "do as Defenders is especially if you're not using the MDM stack well then you",
    "start": "2166119",
    "end": "2171560"
  },
  {
    "text": "can disable the windows service that provides the MDM enrollment and this is",
    "start": "2171560",
    "end": "2177040"
  },
  {
    "text": "probably going to make it a bit harder for attackers to do the enrollment",
    "start": "2177040",
    "end": "2182800"
  },
  {
    "text": "they'll have to make changes to the service uh in particular if you haven't yet patched that patch that came out",
    "start": "2182800",
    "end": "2189599"
  },
  {
    "text": "again yesterday the privilege escalation issue with the enrollment client then",
    "start": "2189599",
    "end": "2195520"
  },
  {
    "text": "this might be a good mitigation to use although of course as is usual recommendations in security practice get",
    "start": "2195520",
    "end": "2201880"
  },
  {
    "text": "those patches done because uh that's a a ripe opportunity for",
    "start": "2201880",
    "end": "2208000"
  },
  {
    "text": "abuse so to recap on the implications of of what we found there are built-in",
    "start": "2208960",
    "end": "2215119"
  },
  {
    "text": "Windows features that are super super useful for it and security teams of",
    "start": "2215119",
    "end": "2220680"
  },
  {
    "text": "course at our company we're looking at using these for good for controlling computers intentionally within our",
    "start": "2220680",
    "end": "2227359"
  },
  {
    "text": "organizations but powerful built-in features can be repurposed and so this is an opportunity both for attackers and",
    "start": "2227359",
    "end": "2234200"
  },
  {
    "text": "Defenders to think outside the box a bit and look at how those features can be",
    "start": "2234200",
    "end": "2239480"
  },
  {
    "text": "repurposed to live off the land it reinforces the need for robust",
    "start": "2239480",
    "end": "2245560"
  },
  {
    "text": "defenses so so again don't expect that everything is going to be done through",
    "start": "2245560",
    "end": "2250960"
  },
  {
    "text": "agents or any particular mechanism is going to be used it's not necessarily going to be u a buffer overflow",
    "start": "2250960",
    "end": "2259680"
  },
  {
    "text": "vulnerability or or memory exploitation there's logical errors lingering in all",
    "start": "2259680",
    "end": "2265119"
  },
  {
    "text": "complex pieces of software that allow",
    "start": "2265119",
    "end": "2269760"
  },
  {
    "text": "exploitation and then this kind of agentless C2 approach just opens up new avenues for Advanced attacks I think",
    "start": "2270800",
    "end": "2277720"
  },
  {
    "text": "it's going to take some time for folks to start using this as an offensive",
    "start": "2277720",
    "end": "2283119"
  },
  {
    "text": "methodology then it's going to take more time for the standard defensive tools to catch up with detecting these kind of",
    "start": "2283119",
    "end": "2289440"
  },
  {
    "text": "things so now that you know you have the opportunity to put these kind of detections into place and for you",
    "start": "2289440",
    "end": "2295520"
  },
  {
    "text": "attackers red teamers have fun out there with",
    "start": "2295520",
    "end": "2300280"
  },
  {
    "text": "this thank you very much and we actually can't take questions in here but as was",
    "start": "2300560",
    "end": "2306079"
  },
  {
    "text": "said earlier we will be taking questions in a breakout room uh and we'll be",
    "start": "2306079",
    "end": "2311920"
  },
  {
    "text": "hearing the name of that room again in a moment the white paper the code and the",
    "start": "2311920",
    "end": "2317720"
  },
  {
    "text": "resources are all available at this URL here Fleet dm.com black hat 2023 so go",
    "start": "2317720",
    "end": "2324800"
  },
  {
    "text": "there to check out the resources and any more questions we'll be taking in that breakout room thank",
    "start": "2324800",
    "end": "2331410"
  },
  {
    "text": "[Applause] you",
    "start": "2331410",
    "end": "2338520"
  }
]