[
  {
    "text": "the next talk is Marina Simha cough and urine Zener finding a needle in an",
    "start": "60",
    "end": "5819"
  },
  {
    "text": "encrypted haystack leveraging cryptographic abilities to detect the most prevalent attacks on Active",
    "start": "5819",
    "end": "11340"
  },
  {
    "text": "Directory guys thank you hi everyone and thank you for joining our talk I were in",
    "start": "11340",
    "end": "17400"
  },
  {
    "text": "a cynical and today I'm here with Iran Zener we're both security researchers from preempt and today we want to talk",
    "start": "17400",
    "end": "24269"
  },
  {
    "text": "to you about some of the vulnerabilities that we were able to discover this year we have a lot of information for you",
    "start": "24269",
    "end": "30300"
  },
  {
    "text": "today let's see the agenda we'll begin with a short introduction to Active Directory and some of the common attacks who focused a lot on the ntlm protocol",
    "start": "30300",
    "end": "38190"
  },
  {
    "text": "it's a design we can assess the ntlm relay attack and some of the offering creations that we have against this",
    "start": "38190",
    "end": "43980"
  },
  {
    "text": "attack technique then we'll move on to discuss some vulnerabilities we'll see some of the known ones and some of the",
    "start": "43980",
    "end": "50370"
  },
  {
    "text": "new ones that we discovered this year allowing us to bypass all present litigations against ntlm relay last but",
    "start": "50370",
    "end": "58410"
  },
  {
    "text": "not least we'll talk to you about detection and we're quite excited to present the first deterministic ntlm",
    "start": "58410",
    "end": "64198"
  },
  {
    "text": "relay detection today and we'll finish with some takeaways okay so I guess most",
    "start": "64199",
    "end": "69600"
  },
  {
    "text": "of you are probably familiar with Active Directory well I'll give just a brief introduction just in case so Active",
    "start": "69600",
    "end": "75330"
  },
  {
    "text": "Directory is the main secret storage of the domain it stores the password hashes of all the accounts and it is in charge",
    "start": "75330",
    "end": "82229"
  },
  {
    "text": "of syndicating accounts against domain resources this can be done using three different protocols LDAP and TLM or",
    "start": "82229",
    "end": "89340"
  },
  {
    "text": "Kerberos and today we'll be focusing on the ntlm protocol and specifically on",
    "start": "89340",
    "end": "94350"
  },
  {
    "text": "the ntlm relay attack technique so you might be scratching your heads thinking",
    "start": "94350",
    "end": "100350"
  },
  {
    "text": "is ntlm even still relevant well actually the answer is yes even",
    "start": "100350",
    "end": "106560"
  },
  {
    "text": "though it's technology from the stone Age's still many environments use it or using it so even though we've had",
    "start": "106560",
    "end": "112799"
  },
  {
    "text": "Kerberos for quite a while we still haven't seen a single environment which disables ntlm completely so this is",
    "start": "112799",
    "end": "120060"
  },
  {
    "text": "quite relevant to most organizations today let's see a short overview of how",
    "start": "120060",
    "end": "125939"
  },
  {
    "text": "the ntlm protocol works let's say we have a client that wants to connect him to some domain server let's see the",
    "start": "125939",
    "end": "131670"
  },
  {
    "text": "authentication flow so client would send an ntlm negotiate message to the server and the server",
    "start": "131670",
    "end": "136800"
  },
  {
    "text": "would respond with an ntlm challenge now the client would need to encrypt that challenge using the password hash of the",
    "start": "136800",
    "end": "143970"
  },
  {
    "text": "user's account and responding the ntlm authenticated message now since this target server is not",
    "start": "143970",
    "end": "150060"
  },
  {
    "text": "aware of the password hash of the user it is not able to verify that the challenge was encrypted using the",
    "start": "150060",
    "end": "155550"
  },
  {
    "text": "correct password hash so it would send a natural message to the domain controller which has the ability to verify whether",
    "start": "155550",
    "end": "162840"
  },
  {
    "text": "the challenge was encrypted correctly and respond with an approve or reject message accordingly one of the problems",
    "start": "162840",
    "end": "170370"
  },
  {
    "text": "with this protocol is that the authentication is not bound to the target server so if this target server",
    "start": "170370",
    "end": "176700"
  },
  {
    "text": "gets compromised attackers can simply really the authentication and use it to attack another server in the domain this",
    "start": "176700",
    "end": "183780"
  },
  {
    "text": "is exactly what happens in the ntlm really attack and let's see this flow so we have a client connecting using ntlm",
    "start": "183780",
    "end": "190380"
  },
  {
    "text": "to a compromised server so this can be by attackers compromising a server that",
    "start": "190380",
    "end": "195390"
  },
  {
    "text": "usually accounts connect to or by sending a phishing email to a lot of users and some user clicks on the link",
    "start": "195390",
    "end": "201360"
  },
  {
    "text": "and an NT level syndication begins now attackers choose a target in the domain",
    "start": "201360",
    "end": "206580"
  },
  {
    "text": "which they want to attack and relay that ntlm negotiate message to the target they receive the challenge and relayed",
    "start": "206580",
    "end": "213480"
  },
  {
    "text": "back to the client now the client will encrypt the challenge using the password hash of the user and send it back to the",
    "start": "213480",
    "end": "220110"
  },
  {
    "text": "compromised server and all the attackers need to do now is simply relayed back to the attack target so when the target",
    "start": "220110",
    "end": "226620"
  },
  {
    "text": "would verify whether the challenge was indeed encrypted correctly since the client was the one that encrypted the",
    "start": "226620",
    "end": "232530"
  },
  {
    "text": "challenge the domain controller would prove the request and the attackers now have an authenticated session using the",
    "start": "232530",
    "end": "239130"
  },
  {
    "text": "users permissions on the attacked server but notice that at any stage the attackers did not need to know the",
    "start": "239130",
    "end": "244709"
  },
  {
    "text": "password of the user all they did is relay messages back and forth between the client and the attack target so that",
    "start": "244709",
    "end": "251340"
  },
  {
    "text": "user is a local admin on the target machine attackers can now run code on",
    "start": "251340",
    "end": "256890"
  },
  {
    "text": "the target they can dump files and entirely compromise that computer this",
    "start": "256890",
    "end": "262979"
  },
  {
    "text": "is a pretty serious attack vector this is why we few mitigations against this attack",
    "start": "262979",
    "end": "268500"
  },
  {
    "text": "technique the most critical mitigations our session signing we have SMB and LDAP",
    "start": "268500",
    "end": "274139"
  },
  {
    "text": "signing and we have EPA and channel binding those are the ones that we'll be focusing on today and we'll show you how",
    "start": "274139",
    "end": "280590"
  },
  {
    "text": "we were able to bypass both of them let's begin with session signing what",
    "start": "280590",
    "end": "286620"
  },
  {
    "text": "the session signing requirement means is that after the ntlm authentication is",
    "start": "286620",
    "end": "291690"
  },
  {
    "text": "completed all the communication between the client and the server needs to be signed and the session signing key is",
    "start": "291690",
    "end": "298889"
  },
  {
    "text": "derived from the authenticating users password hash so the client knows this",
    "start": "298889",
    "end": "304290"
  },
  {
    "text": "password hash so it's simply computed independently now the target doesn't store the password hashes of their",
    "start": "304290",
    "end": "310710"
  },
  {
    "text": "counsel it would simply get the session signing key from the domain controller as a response to the net logon request",
    "start": "310710",
    "end": "317100"
  },
  {
    "text": "and if you have an attacker in the middle with really capabilities that",
    "start": "317100",
    "end": "322229"
  },
  {
    "text": "attackers would simply they would not have a way to retrieve the session signing key they would not be able to",
    "start": "322229",
    "end": "327840"
  },
  {
    "text": "sign any additional packets and the attack would fail I so let's see an illustration of this one so the client",
    "start": "327840",
    "end": "333990"
  },
  {
    "text": "would send an ntlm negotiate machine message to the compromised server the",
    "start": "333990",
    "end": "339060"
  },
  {
    "text": "server would really that to the attack target again we really the challenge and the response and now in the attack",
    "start": "339060",
    "end": "345270"
  },
  {
    "text": "targets ends the Navigon message to the domain controller to verify whether the user entered the correct password the",
    "start": "345270",
    "end": "352139"
  },
  {
    "text": "domain controller would also respond with the session signing key and the client would calculate the session key",
    "start": "352139",
    "end": "357840"
  },
  {
    "text": "by himself now the relay at the middle simply has no way to retrieve the",
    "start": "357840",
    "end": "362880"
  },
  {
    "text": "session key it cannot send any additional packets to the attack target and the attack would fail this is a very",
    "start": "362880",
    "end": "370410"
  },
  {
    "text": "critical litigation against ntlm really and unfortunately not enough servers",
    "start": "370410",
    "end": "375840"
  },
  {
    "text": "enforce a signing by default the second mitigation that we want to discuss with",
    "start": "375840",
    "end": "382080"
  },
  {
    "text": "you is BPA enhanced protection for authentication here the goal is to protect ntlm authentication from being",
    "start": "382080",
    "end": "389669"
  },
  {
    "text": "relayed to a TLS session and we want to bind the ntlm authentication to the TLS",
    "start": "389669",
    "end": "395580"
  },
  {
    "text": "session over which the packets are transferred and the implementation of this is by adding an additional field",
    "start": "395580",
    "end": "401850"
  },
  {
    "text": "to the final ntlm authenticated message called channel bindings now this field",
    "start": "401850",
    "end": "407790"
  },
  {
    "text": "contains a hash of the target service certificate and also it is signed using",
    "start": "407790",
    "end": "412890"
  },
  {
    "text": "the user's password hash so it cannot be modified by attackers and if you have an",
    "start": "412890",
    "end": "418290"
  },
  {
    "text": "attacker with really capabilities in the middle it would be necessarily using a different certificate then the attack",
    "start": "418290",
    "end": "424920"
  },
  {
    "text": "target so the value provided by the client in the channel binding field would be based on the certificate of the",
    "start": "424920",
    "end": "431940"
  },
  {
    "text": "compromised server so if attackers try to relay this message to any other server which enforces EPA this field",
    "start": "431940",
    "end": "439170"
  },
  {
    "text": "would simply be not valid and the attack would fail ok let's see an illustration again just to make things a bit more",
    "start": "439170",
    "end": "444660"
  },
  {
    "text": "clear so we have a client initiating until accession against the compromised server and sending an mplm negotiate",
    "start": "444660",
    "end": "450810"
  },
  {
    "text": "message now attackers target some server in the domain which enforces APA established and a different TLS session",
    "start": "450810",
    "end": "458070"
  },
  {
    "text": "and really that ntlm negotiated message we really the challenge in the same way",
    "start": "458070",
    "end": "463950"
  },
  {
    "text": "and now the last ntlm authentication message also contains this channel binding field which includes the hash of",
    "start": "463950",
    "end": "471840"
  },
  {
    "text": "the target certificate of that compromised server now attackers cannot modify this field as we've said the user",
    "start": "471840",
    "end": "478140"
  },
  {
    "text": "signs it using the password hash of the user and if they try to relay that message to the attack target it will",
    "start": "478140",
    "end": "484860"
  },
  {
    "text": "look into the channel binding field and see that the value is not based on its own certificate and the attack will fail",
    "start": "484860",
    "end": "491160"
  },
  {
    "text": "so will not even need to verify the credentials against the domain controller and so those were the two",
    "start": "491160",
    "end": "497760"
  },
  {
    "text": "most critical mitigations that we have today again ntlm relay and now you are on speak about some of the",
    "start": "497760",
    "end": "503550"
  },
  {
    "text": "vulnerabilities and show you how we're able to bypass both those mitigations",
    "start": "503550",
    "end": "508970"
  },
  {
    "text": "thanks marina so all of these attackers have found many vulnerabilities allowing",
    "start": "508970",
    "end": "516169"
  },
  {
    "text": "attackers to exploit ntlm alike to exploit the vulnerabilities and launch",
    "start": "516169",
    "end": "521570"
  },
  {
    "text": "ntlm relay attacks let's review the most recent one so the first vulnerability i",
    "start": "521570",
    "end": "527850"
  },
  {
    "text": "want to talk about is LDAP s relay the vulnerability was discovered by our team",
    "start": "527850",
    "end": "533560"
  },
  {
    "text": "back in 2017 and we have found that LDAP servers was somewhat vulnerable two and",
    "start": "533560",
    "end": "540880"
  },
  {
    "text": "three LM really attacks so as marina mentioned until M is not inherently",
    "start": "540880",
    "end": "546640"
  },
  {
    "text": "protected for ntlm really if you want to protect an aunty LM session you'll need",
    "start": "546640",
    "end": "552100"
  },
  {
    "text": "to either enable server signing auto enable EPA there is a special GPO",
    "start": "552100",
    "end": "557880"
  },
  {
    "text": "enabling stealth observer signing on the domain controllers and if that GPO is",
    "start": "557880",
    "end": "563770"
  },
  {
    "text": "enabled the DC would accept only requests the Thelda progressed that are",
    "start": "563770",
    "end": "569260"
  },
  {
    "text": "signed with gssapi but it would also request any LDAP request over a TLS",
    "start": "569260",
    "end": "575380"
  },
  {
    "text": "Channel this means that if we really credentials to an LDAP s session will be",
    "start": "575380",
    "end": "582190"
  },
  {
    "text": "able to completely point that session so we've disclosed this issue to Microsoft",
    "start": "582190",
    "end": "587380"
  },
  {
    "text": "back in 2017 and they've fixed it by an abling EPA on LDAP s it is important to",
    "start": "587380",
    "end": "593860"
  },
  {
    "text": "note that LDAP is still vulnerable by default since the GPO for enabling LDAP",
    "start": "593860",
    "end": "599890"
  },
  {
    "text": "server signing is not enabled by default and EPA is also not enabled by default",
    "start": "599890",
    "end": "605880"
  },
  {
    "text": "the second vulnerability I want to talk about was disclosed in 2015 by Alberto",
    "start": "605880",
    "end": "612250"
  },
  {
    "text": "Selina from call security and that was a generic bypass of all ntlm session",
    "start": "612250",
    "end": "618100"
  },
  {
    "text": "requirements so let's review out the attack worked the initial part was just",
    "start": "618100",
    "end": "624400"
  },
  {
    "text": "like any ntlm relay and since the attack target is support enforces server",
    "start": "624400",
    "end": "629830"
  },
  {
    "text": "signing when it sends the ntlm message it receives a session key now if we",
    "start": "629830",
    "end": "635950"
  },
  {
    "text": "don't have a session key we can't use the session and send and sign any SMB requests but as it turned out before v",
    "start": "635950",
    "end": "644440"
  },
  {
    "text": "this was fixed any machine in the network if it knew the challenge and the challenge response could spoof its own",
    "start": "644440",
    "end": "652150"
  },
  {
    "text": "network own message with with these fields and receive its own session key",
    "start": "652150",
    "end": "658210"
  },
  {
    "text": "once the attacker has a session key it can send requests over the SMB Channel",
    "start": "658210",
    "end": "664660"
  },
  {
    "text": "and completely pawned that machine so now it gets a bit trickier I want to",
    "start": "664660",
    "end": "671019"
  },
  {
    "text": "discuss how Microsoft fixed that issue so in order to understand we need to",
    "start": "671019",
    "end": "676509"
  },
  {
    "text": "dive a bit deeper into the ntlm protocol the second message the ntlm challenge as",
    "start": "676509",
    "end": "682240"
  },
  {
    "text": "a target info field the target info field as special construct named AV",
    "start": "682240",
    "end": "687819"
  },
  {
    "text": "pairs these fields should identify the target the field I'm going to focus on is the net balance computer name the net",
    "start": "687819",
    "end": "695439"
  },
  {
    "text": "buyers computer name identifies the net bias of the target server machine in",
    "start": "695439",
    "end": "700600"
  },
  {
    "text": "this case it's test - oh one the ntlm client when it receives this target in",
    "start": "700600",
    "end": "707980"
  },
  {
    "text": "for AV pairs would echo all the fields that it received in the echo peers so we",
    "start": "707980",
    "end": "713019"
  },
  {
    "text": "see that the client echoed the net bulbs computer name test - a one but the",
    "start": "713019",
    "end": "718149"
  },
  {
    "text": "important part is that all AV players in the ntlm authenticate message sign with",
    "start": "718149",
    "end": "723550"
  },
  {
    "text": "the panty proof STR where the secret key is the user's nth so an attacker with no",
    "start": "723550",
    "end": "730209"
  },
  {
    "text": "knowledge of the use of smth cannot modify or temporarily this message so",
    "start": "730209",
    "end": "737319"
  },
  {
    "text": "what Microsoft essentially did was to compare the NetBIOS computer name in the",
    "start": "737319",
    "end": "742509"
  },
  {
    "text": "authenticate message with the machine that originated the net Logan so let's review again the tag target which is the",
    "start": "742509",
    "end": "750069"
  },
  {
    "text": "legitimate target sends a net logon message and it receives a session key now the server would initiate a similar",
    "start": "750069",
    "end": "756699"
  },
  {
    "text": "spoofed met Logan session the anti authenticate and the net Lebon would contain the net buyers computer name",
    "start": "756699",
    "end": "763420"
  },
  {
    "text": "which identifies the attack target and the network originator is the compromised server the DISA can see the",
    "start": "763420",
    "end": "770860"
  },
  {
    "text": "discrepancy and just reject the request since the rejected since the request is rejected we didn't receive any session",
    "start": "770860",
    "end": "778269"
  },
  {
    "text": "key and were unable to sign the SMB session now I want to move on to the new",
    "start": "778269",
    "end": "784750"
  },
  {
    "text": "vulnerabilities we have found so I'm going to so we're going to present three",
    "start": "784750",
    "end": "790329"
  },
  {
    "text": "vulnerabilities for you today the first your session key is my session key is another generic bypass of ntlm",
    "start": "790329",
    "end": "797680"
  },
  {
    "text": "sir signing the second drop the meek is a vulnerability by passing another ntlm",
    "start": "797680",
    "end": "804370"
  },
  {
    "text": "security mechanism the message integrity code which we will discuss later and the",
    "start": "804370",
    "end": "809410"
  },
  {
    "text": "third one of ability api bypass bypassing EPA and channel binding that's",
    "start": "809410",
    "end": "814990"
  },
  {
    "text": "correct during our research we were able to bypass all major antenna mitigations",
    "start": "814990",
    "end": "820710"
  },
  {
    "text": "let's talk about the first vulnerability your session key is my session key so if",
    "start": "820710",
    "end": "827290"
  },
  {
    "text": "we look back at the fixed Microsoft need in 2015 comparing the net logon originator to",
    "start": "827290",
    "end": "833380"
  },
  {
    "text": "the NetBIOS computer name in the authenticate message we thought to ourselves what would happen if we'll",
    "start": "833380",
    "end": "839800"
  },
  {
    "text": "simply remove the network's computer name so if we look at the ntlm challenge",
    "start": "839800",
    "end": "845290"
  },
  {
    "text": "message the NetBIOS computer name is an AV pair and since we're double layer and we have control of the entire",
    "start": "845290",
    "end": "851680"
  },
  {
    "text": "communication we can create a modified ntlm challenge message with no net miles",
    "start": "851680",
    "end": "857260"
  },
  {
    "text": "computer name what happens is that the ntlm client receives this malformed",
    "start": "857260",
    "end": "863860"
  },
  {
    "text": "request and since and apparently it's just accept the request with no NetBIOS",
    "start": "863860",
    "end": "869650"
  },
  {
    "text": "computer name creating an entry level authentication message that obviously does not have the net computer name the",
    "start": "869650",
    "end": "876760"
  },
  {
    "text": "ntlm server would also accept the ntlm authenticate with no net balance computer name and would generate a",
    "start": "876760",
    "end": "883150"
  },
  {
    "text": "network own message we've known that both computer name the third surprising",
    "start": "883150",
    "end": "888160"
  },
  {
    "text": "thing is that the DC would receive a net logon message with no net buyers computer name we've known that both",
    "start": "888160",
    "end": "894940"
  },
  {
    "text": "computer name is unable to perform the validation that the net Logan is spoofed or not and would simply approve the",
    "start": "894940",
    "end": "901540"
  },
  {
    "text": "request so there is one last obstacle will need to overcome and that's the",
    "start": "901540",
    "end": "906970"
  },
  {
    "text": "message integrity code the message integrity code is a cryptographic signature signing all three until a",
    "start": "906970",
    "end": "913510"
  },
  {
    "text": "message in the same session the antibellum negotiate ntlm challenge and antenna authenticate the cryptographic",
    "start": "913510",
    "end": "921640"
  },
  {
    "text": "key for the make is the ntlm session signing key and impossibly already",
    "start": "921640",
    "end": "928390"
  },
  {
    "text": "understand the solution we can spoof a net one message retrieve the ntlm session",
    "start": "928390",
    "end": "934020"
  },
  {
    "text": "key and simply recalculate the mick let's look at that tech flow I know it",
    "start": "934020",
    "end": "939750"
  },
  {
    "text": "was a bit complex so we'll run over it again detect out the attack the compromised server receives an anti lamp",
    "start": "939750",
    "end": "946590"
  },
  {
    "text": "challenge message and Templars with this message removing the net bugs computer name the",
    "start": "946590",
    "end": "953160"
  },
  {
    "text": "ntlm client accepts this message and sends an ntlm authenticate message that",
    "start": "953160",
    "end": "958260"
  },
  {
    "text": "does not contain a net buyers computer name we are creating a spoofing we're",
    "start": "958260",
    "end": "963390"
  },
  {
    "text": "creating a spoofed net logo message and this e cannot really date whether we are",
    "start": "963390",
    "end": "968400"
  },
  {
    "text": "the correct target or not and simply returns a session key now that we have a",
    "start": "968400",
    "end": "974520"
  },
  {
    "text": "session key we are recalculating the make and sending a message will the make that the attack target expects obviously",
    "start": "974520",
    "end": "983190"
  },
  {
    "text": "the attack target would create a very similar net logon message and receive the same session key that we have now",
    "start": "983190",
    "end": "990510"
  },
  {
    "text": "that we have a session key and as in an anti level 10 ticketed session we can perform any SMB command that we like now",
    "start": "990510",
    "end": "998280"
  },
  {
    "text": "I want to stress the importance of this issue ntlm server signing is the only",
    "start": "998280",
    "end": "1003880"
  },
  {
    "text": "mitigation protecting domain controllers from the authentication so if we're able",
    "start": "1003880",
    "end": "1010550"
  },
  {
    "text": "to capture an antelope session from a domain admin there is no mitigation we",
    "start": "1010550",
    "end": "1016250"
  },
  {
    "text": "could relate this ntlm session to a domain controller dumping hashes running",
    "start": "1016250",
    "end": "1022760"
  },
  {
    "text": "code on the domain controller completely compromising that machine so now I want",
    "start": "1022760",
    "end": "1029300"
  },
  {
    "text": "to present a demo okay so I'm using ion",
    "start": "1029300",
    "end": "1036110"
  },
  {
    "text": "packet which is an open source tool for performing ntlm relay attacks and the first attack is not using our",
    "start": "1036110",
    "end": "1042410"
  },
  {
    "text": "vulnerability as you can see no session",
    "start": "1042410",
    "end": "1047959"
  },
  {
    "text": "signing key was able to be retrieved and the SM the domain controller rejected",
    "start": "1047959",
    "end": "1053510"
  },
  {
    "text": "our SMB session since it is not signed now let's look at the network traffic we",
    "start": "1053510",
    "end": "1060290"
  },
  {
    "text": "can see that the anterior authenticate message contains a NetBIOS compute to name so we are unable to spoof a net",
    "start": "1060290",
    "end": "1068500"
  },
  {
    "text": "look on request and the SM this session is not signed you can see that the",
    "start": "1068500",
    "end": "1074950"
  },
  {
    "text": "signature finding zeros and that's why the server rejected our request now",
    "start": "1074950",
    "end": "1082210"
  },
  {
    "text": "let's try try running the same attack without modified exploit okay so you see",
    "start": "1082210",
    "end": "1095919"
  },
  {
    "text": "we are running this command with two additional fields one is the Machine compute the computer accounts edge and",
    "start": "1095919",
    "end": "1102610"
  },
  {
    "text": "the second is the remove target removing the the network's name from the ntlm",
    "start": "1102610",
    "end": "1108159"
  },
  {
    "text": "challenge now we'll go into the other",
    "start": "1108159",
    "end": "1113590"
  },
  {
    "text": "machine where a privileged account is performing browsing session and you can",
    "start": "1113590",
    "end": "1119380"
  },
  {
    "text": "see that we were able to retrieve a session signing key it is the session",
    "start": "1119380",
    "end": "1124600"
  },
  {
    "text": "signing key and we were able to create an SMB session through the domain controller dumping some hashes from the",
    "start": "1124600",
    "end": "1131890"
  },
  {
    "text": "domain controller we could have run any other command and compromise the domain now let's look again at the network",
    "start": "1131890",
    "end": "1137950"
  },
  {
    "text": "traffic so you can see the original net logon until a message that contain the",
    "start": "1137950",
    "end": "1143350"
  },
  {
    "text": "NetBIOS computer name you can see on the HTTP channel we've modified the ntlm",
    "start": "1143350",
    "end": "1149799"
  },
  {
    "text": "challenge removing the NetBIOS computer name and you can see that the mouse that send us",
    "start": "1149799",
    "end": "1155590"
  },
  {
    "text": "back an anti la message with no NetBIOS computer name so we relate that message you can't see",
    "start": "1155590",
    "end": "1163960"
  },
  {
    "text": "the net logon sense is encrypted but we've retrieved the session key and now you can see that the SMB session is sad",
    "start": "1163960",
    "end": "1172440"
  },
  {
    "text": "so just to summarize we have presented a novel attack allowing any attacker in",
    "start": "1175530",
    "end": "1181360"
  },
  {
    "text": "the network to retrieve ntlm session keys and make any ntlm relay attack",
    "start": "1181360",
    "end": "1186460"
  },
  {
    "text": "walk now I want to discuss the fix so we",
    "start": "1186460",
    "end": "1192820"
  },
  {
    "text": "have disclosed this issue to Microsoft a while back and Microsoft acknowledged the issue",
    "start": "1192820",
    "end": "1198010"
  },
  {
    "text": "and send a fix in the Juliet release the fixed microsoft did was to for ntlm",
    "start": "1198010",
    "end": "1205270"
  },
  {
    "text": "servers target servers to authenticate whether the ntlm authenticate message",
    "start": "1205270",
    "end": "1210460"
  },
  {
    "text": "contains a net buyers computer name and if no NetBIOS computer name is present",
    "start": "1210460",
    "end": "1216010"
  },
  {
    "text": "then they'll simply reject that request there are a few caveats with the fix",
    "start": "1216010",
    "end": "1221350"
  },
  {
    "text": "that we want to talk about the first probably the most interesting is that",
    "start": "1221350",
    "end": "1226919"
  },
  {
    "text": "repairs are feature of ntlm v2 this means that if an attacker gets his hands",
    "start": "1226919",
    "end": "1232570"
  },
  {
    "text": "on an ant Island v1 session there was no mitigation in for him to stop willing",
    "start": "1232570",
    "end": "1237760"
  },
  {
    "text": "that session so if you really can't tell everyone you will probably get relayed",
    "start": "1237760",
    "end": "1242860"
  },
  {
    "text": "the second is that the fix is applied on ntlm servers and not domain controllers",
    "start": "1242860",
    "end": "1248169"
  },
  {
    "text": "this means that any order windows version like Windows XP is still vulnerable and other windows OS that",
    "start": "1248169",
    "end": "1255460"
  },
  {
    "text": "receives ntlm of indications are also vulnerable to this issue this probably a",
    "start": "1255460",
    "end": "1261640"
  },
  {
    "text": "small tidbit is that caching as always is not enough in order for patch to work",
    "start": "1261640",
    "end": "1267010"
  },
  {
    "text": "you need to restart your machine and since the patch is not applied centrally",
    "start": "1267010",
    "end": "1272080"
  },
  {
    "text": "on the DC disapproving hold net logon messages any restarted machine in your",
    "start": "1272080",
    "end": "1278350"
  },
  {
    "text": "network is still vulnerable to this attack with that I'm going to pass the",
    "start": "1278350",
    "end": "1283929"
  },
  {
    "text": "stage back to marina to present it to additional vulnerabilities we found okay thank you you're on I hope you're",
    "start": "1283929",
    "end": "1289870"
  },
  {
    "text": "concentrated enough to see more to more vulnerabilities that we found the first is drop the make the message integrity",
    "start": "1289870",
    "end": "1296770"
  },
  {
    "text": "code the message integrity code is an H Mac md5 using the session key on the",
    "start": "1296770",
    "end": "1303730"
  },
  {
    "text": "three ntlm messages and the goal of this message integrity code is to verify that attackers did not tamper with any of the",
    "start": "1303730",
    "end": "1310840"
  },
  {
    "text": "ntlm messages let's see an example of why we might make this Mik field let's",
    "start": "1310840",
    "end": "1316179"
  },
  {
    "text": "say we have a client connecting to a car for my server using ntlm and let's say",
    "start": "1316179",
    "end": "1321970"
  },
  {
    "text": "that it wants to establish sign communication so this is done by setting the negotiate sign flag that you can see",
    "start": "1321970",
    "end": "1328299"
  },
  {
    "text": "up on the screen in the ntlm message now if attackers try to relay",
    "start": "1328299",
    "end": "1333470"
  },
  {
    "text": "this message as is to another server that supports signing all they would get is a signed session now let's assume",
    "start": "1333470",
    "end": "1340190"
  },
  {
    "text": "that all the servers are patched and attackers have no way to retrieve the signing key so they would not be able to",
    "start": "1340190",
    "end": "1346190"
  },
  {
    "text": "sign any communication to the attack server and the attack would fail however what they might try to do is unset this",
    "start": "1346190",
    "end": "1353570"
  },
  {
    "text": "signing flag in order to create an unsigned session against the target however even changing a single bit in",
    "start": "1353570",
    "end": "1360740"
  },
  {
    "text": "one of those three ntlm messages would make the message integrity code no longer valid and the attack would fail",
    "start": "1360740",
    "end": "1367129"
  },
  {
    "text": "so that would not be possible as Samba clients turn all the signing negotiate",
    "start": "1367129",
    "end": "1372500"
  },
  {
    "text": "flag by default and also the user make this is why it was considered very hard or even impossible to perform and tell",
    "start": "1372500",
    "end": "1379279"
  },
  {
    "text": "them really from SMB to any other protocol simply because the attackers would need to sign the session and they",
    "start": "1379279",
    "end": "1385370"
  },
  {
    "text": "would not be able to retrieve the signing key this is in contrast to other protocols such as HTTP which do not set",
    "start": "1385370",
    "end": "1391879"
  },
  {
    "text": "this flag so it's much it's much easier to perform until and relay from HTTP to",
    "start": "1391879",
    "end": "1397669"
  },
  {
    "text": "SMB or LDAP to domain controllers however let's say our attackers are persistent and they want to perform an",
    "start": "1397669",
    "end": "1405350"
  },
  {
    "text": "TL m relay to an aunty LM authentication over SMB how can they remove the signing",
    "start": "1405350",
    "end": "1410570"
  },
  {
    "text": "requirement we started in order to modify the message integrity code attackers need to have knowledge of the",
    "start": "1410570",
    "end": "1416659"
  },
  {
    "text": "signing key but we assume that they cannot retrieve it in any way what they can do is simply remove the make from",
    "start": "1416659",
    "end": "1423740"
  },
  {
    "text": "the message so we just needed to remove the myth and the version and also modify",
    "start": "1423740",
    "end": "1429529"
  },
  {
    "text": "some of the negotiation flags but it was simple as that we just removed the make from the message in order to bypass its",
    "start": "1429529",
    "end": "1436519"
  },
  {
    "text": "protection and it's a funny story of how we discovered this vulnerability we were working on a completely unrelated",
    "start": "1436519",
    "end": "1442940"
  },
  {
    "text": "vulnerability and this Mik was interfering with what we're trying to do so we remove the make and moved on to",
    "start": "1442940",
    "end": "1449360"
  },
  {
    "text": "discover that vulnerability so after finishing we had to look back and think wait did we just find on something else",
    "start": "1449360",
    "end": "1455419"
  },
  {
    "text": "do we need to disclose that one as well and it turns out that we did so by removing the make it allows attackers to",
    "start": "1455419",
    "end": "1461779"
  },
  {
    "text": "tamper with any of the ntlm authentication so this is pretty serious as you can see an",
    "start": "1461779",
    "end": "1467860"
  },
  {
    "text": "original aunty LM authenticate message that has version and message integrity code and our modified message simply",
    "start": "1467860",
    "end": "1474400"
  },
  {
    "text": "missing those two fields okay so let's see an overview of this attack a client",
    "start": "1474400",
    "end": "1480280"
  },
  {
    "text": "would connect to a compromised server by sending an ntlm negotiate message stating that he supports signing now",
    "start": "1480280",
    "end": "1487630"
  },
  {
    "text": "attackers cannot relay this message because they would not be able to retrieve the signing key what they can",
    "start": "1487630",
    "end": "1493000"
  },
  {
    "text": "do is unset the signing flag and relay the message to another attack target receive the challenge and now if the",
    "start": "1493000",
    "end": "1500770"
  },
  {
    "text": "attack target does not enforce signing they would respond with the challenge and state that no signing was negotiated",
    "start": "1500770",
    "end": "1507730"
  },
  {
    "text": "now attackers need to really this back to the client and usually clients don't",
    "start": "1507730",
    "end": "1513100"
  },
  {
    "text": "enforce session signing so the client would accept this message and reply with an mplm authenticated message which",
    "start": "1513100",
    "end": "1519070"
  },
  {
    "text": "includes a message integrity code now notice this message integrity code is",
    "start": "1519070",
    "end": "1524310"
  },
  {
    "text": "assigning the three ntlm messages between the client and the compromised server so the first ntlm negotiate",
    "start": "1524310",
    "end": "1531100"
  },
  {
    "text": "message state signing is supported since attackers did not really this message",
    "start": "1531100",
    "end": "1536200"
  },
  {
    "text": "they cannot use this message integrity code so they simply remove it from the message all that is left is to verify",
    "start": "1536200",
    "end": "1542560"
  },
  {
    "text": "the credentials we had the original client encrypt the challenge so we're good in that way and now attackers have",
    "start": "1542560",
    "end": "1549730"
  },
  {
    "text": "established an unsigned session against the attack target of their choice which does not enforce signing this is why",
    "start": "1549730",
    "end": "1556630"
  },
  {
    "text": "enforcing signing on as many machines in your domain is very important let's",
    "start": "1556630",
    "end": "1563830"
  },
  {
    "text": "discuss what enabled this vulnerability to even happen as it turns out there is",
    "start": "1563830",
    "end": "1568900"
  },
  {
    "text": "an AV pair called flags in the last ntlm authenticate message and if the second",
    "start": "1568900",
    "end": "1574600"
  },
  {
    "text": "bit of this flag field is turned on it means that the client states that it is providing a make and the challenge sorry",
    "start": "1574600",
    "end": "1582130"
  },
  {
    "text": "in the authenticate method so the client is stating I am providing a make in the",
    "start": "1582130",
    "end": "1587710"
  },
  {
    "text": "message and also Adamek however the server upon receiving this request even",
    "start": "1587710",
    "end": "1593710"
  },
  {
    "text": "if the flag states that the client providing a milk doesn't actually verify",
    "start": "1593710",
    "end": "1599440"
  },
  {
    "text": "that a makers present so it doesn't matter what that field states okay so",
    "start": "1599440",
    "end": "1604480"
  },
  {
    "text": "this is what enable us simply remove the milk from the ntlm authenticate message",
    "start": "1604480",
    "end": "1609720"
  },
  {
    "text": "let's talk about the fix now that we know what the Flex does it's pretty easy",
    "start": "1609720",
    "end": "1614830"
  },
  {
    "text": "to understand how Microsoft fix the issue so all they needed to do is for a server when receiving an ntlm",
    "start": "1614830",
    "end": "1621220"
  },
  {
    "text": "authentication message that states in the flag that I make is present just verify that I make its present still",
    "start": "1621220",
    "end": "1628510"
  },
  {
    "text": "some issues with this because some clients don't add a message integrity code by default such as Firefox on Linux",
    "start": "1628510",
    "end": "1635170"
  },
  {
    "text": "or Mac OS machines so those clients would still be vulnerable to ntlm session tampering simply because they",
    "start": "1635170",
    "end": "1641890"
  },
  {
    "text": "don't provide a make and attackers can still remove the negotiate signing flag and the more serious issue is that we",
    "start": "1641890",
    "end": "1648490"
  },
  {
    "text": "were already able to bypass this fix as well and we have a vulnerability you like to call drop to make to however",
    "start": "1648490",
    "end": "1655240"
  },
  {
    "text": "Microsoft hasn't patched this one yet so we'll not be discussing it today but we'll have a blob in a few days",
    "start": "1655240",
    "end": "1661450"
  },
  {
    "text": "discussing this issue so stay tuned if you want to hear more about this one all",
    "start": "1661450",
    "end": "1667750"
  },
  {
    "text": "right less variability that we have for you today is the EPA bypass as I've",
    "start": "1667750",
    "end": "1672940"
  },
  {
    "text": "mentioned in the beginning the goal of the EPA security feature is to buy the ntlm authentication to the TLS session",
    "start": "1672940",
    "end": "1680410"
  },
  {
    "text": "over which the authentication happens some of the servers that can be protected by EPA include a DFS",
    "start": "1680410",
    "end": "1687450"
  },
  {
    "text": "LDS or other HTTP servers which support Windows integrated authentication so if",
    "start": "1687450",
    "end": "1693370"
  },
  {
    "text": "attackers are able to really credentials to a TFS servers they might be able to take over your cloud resources as well",
    "start": "1693370",
    "end": "1699220"
  },
  {
    "text": "if they're able to relate to or they can real users emails or send emails on his",
    "start": "1699220",
    "end": "1704680"
  },
  {
    "text": "behalf and if they're able to relate to elder pass on domain controllers if that",
    "start": "1704680",
    "end": "1709690"
  },
  {
    "text": "relayed user has enough privileges they can perform malicious modifications to Active Directory objects unfortunately",
    "start": "1709690",
    "end": "1717700"
  },
  {
    "text": "by default EPA is not enabled on any of those servers so all those servers by",
    "start": "1717700",
    "end": "1723580"
  },
  {
    "text": "default are vulnerable to the simplest ntlm relay attack the attackers would not even need to work hard",
    "start": "1723580",
    "end": "1729760"
  },
  {
    "text": "as the EPA feature however let's the suit let's assume you have a very secure environment and you've enabled EPA and",
    "start": "1729760",
    "end": "1736450"
  },
  {
    "text": "all of those servers let's see how we'd be able to bypass that as well I've",
    "start": "1736450",
    "end": "1743050"
  },
  {
    "text": "discussed that the implementation of EPA is by adding a channel bindings field to the last ntlm authenticate method and",
    "start": "1743050",
    "end": "1750280"
  },
  {
    "text": "this field is based on the certificate of the target server and also signed by the anti proof STR so it cannot be",
    "start": "1750280",
    "end": "1757780"
  },
  {
    "text": "modified and again since attackers would be it would be using a different certificate they would not be able to",
    "start": "1757780",
    "end": "1763630"
  },
  {
    "text": "relay this message to an attack target which enforces EPA so attackers have no",
    "start": "1763630",
    "end": "1768640"
  },
  {
    "text": "way to modify the ntlm authenticate message to include the channel bindings field that they would like to be there",
    "start": "1768640",
    "end": "1775060"
  },
  {
    "text": "what can they do let's look at the ntlm challenge message we know that when a",
    "start": "1775060",
    "end": "1781420"
  },
  {
    "text": "client receives an mplm challenge it echos the fields that it receives in the a/v pairs into the ntlm authenticate",
    "start": "1781420",
    "end": "1788380"
  },
  {
    "text": "message so what we try doing is calculating the channel binding field in in advance we can do this because it is",
    "start": "1788380",
    "end": "1796510"
  },
  {
    "text": "based on public and attributes of the certificate so we can just calculate it in advance and inject it into the ntlm",
    "start": "1796510",
    "end": "1803710"
  },
  {
    "text": "challenge so we're sending a client and ntlm challenge with the channel bindings",
    "start": "1803710",
    "end": "1808720"
  },
  {
    "text": "that could contains the value that we want for our target to accept our message so let's see what the client",
    "start": "1808720",
    "end": "1815560"
  },
  {
    "text": "will do turns out that the client would add or crafted field into the ntlm",
    "start": "1815560",
    "end": "1821350"
  },
  {
    "text": "authentication method and sign it however it would also add an additional",
    "start": "1821350",
    "end": "1826540"
  },
  {
    "text": "channel bindings field which would be set to all zeros so we haven't the field that we want in the message but we have",
    "start": "1826540",
    "end": "1832630"
  },
  {
    "text": "an additional one the only question left is what will the target server the one that enforces EPA will do when receiving",
    "start": "1832630",
    "end": "1839770"
  },
  {
    "text": "such a message so he has to channel bindings what will the server do turns out that it will take the first field",
    "start": "1839770",
    "end": "1845800"
  },
  {
    "text": "the one we injected in advance to fit what it expects and simply accept our",
    "start": "1845800",
    "end": "1851380"
  },
  {
    "text": "syndication last obstacle that we might have we just modify the ntlm challenge",
    "start": "1851380",
    "end": "1858160"
  },
  {
    "text": "message the make is no longer valid well we know how to overcome this one already we simply drop the mick from the",
    "start": "1858160",
    "end": "1864580"
  },
  {
    "text": "ntlm authenticate message okay so let's see a detailed flow because it contained",
    "start": "1864580",
    "end": "1870130"
  },
  {
    "text": "many different things that we had to do so we have a client connecting using ntlm to a compromised server now",
    "start": "1870130",
    "end": "1877750"
  },
  {
    "text": "attackers are establishing a TLS session against an attack target which enforces epa and relaying this ntlm negotiate",
    "start": "1877750",
    "end": "1885400"
  },
  {
    "text": "message to the attack target receiving a challenge and also calculating the",
    "start": "1885400",
    "end": "1891850"
  },
  {
    "text": "channel binding field we need to inject in order to bypass EPA on the server and simply inject it into the ntlm challenge",
    "start": "1891850",
    "end": "1899290"
  },
  {
    "text": "that we relay back to the client the client encrypts the challenge adds a rogue Channel binding into the message",
    "start": "1899290",
    "end": "1906430"
  },
  {
    "text": "and also add a message integrity code we've already discussed that we cannot",
    "start": "1906430",
    "end": "1911470"
  },
  {
    "text": "relay this message integrity code back to the attack target because we just modify the challenge so we just remove",
    "start": "1911470",
    "end": "1918160"
  },
  {
    "text": "the child which sorry remove the message integrity code from the message and since the message includes the channel",
    "start": "1918160",
    "end": "1924610"
  },
  {
    "text": "bindings field that we calculated in advance to fit what the server expects would be able to bypass EPA and of",
    "start": "1924610",
    "end": "1931210"
  },
  {
    "text": "course since the challenge was computed using the correct password hash the domain controller would approve our",
    "start": "1931210",
    "end": "1936520"
  },
  {
    "text": "request and now we can do anything we want on their attack target which can be again in a DFS or or even a domain",
    "start": "1936520",
    "end": "1943870"
  },
  {
    "text": "controller all right let's see a demo of this one as well so what we'll see here",
    "start": "1943870",
    "end": "1949630"
  },
  {
    "text": "is will have an HTTP server an HTTP relay server which a client would connect to and we'll try to relate the",
    "start": "1949630",
    "end": "1956680"
  },
  {
    "text": "ntlm authentication over Elda pass to a domain controller which enforces Elda",
    "start": "1956680",
    "end": "1961870"
  },
  {
    "text": "pass channel binding so we'll see in the first scenario we're not using our vulnerability we would fail and then",
    "start": "1961870",
    "end": "1968200"
  },
  {
    "text": "when we implement our vulnerability the domain controller would allow us to do what we want so what we're trying to do",
    "start": "1968200",
    "end": "1974590"
  },
  {
    "text": "is to take a user called test user and add it to the enterprise admins group as",
    "start": "1974590",
    "end": "1981040"
  },
  {
    "text": "you can see I hope you can see if not we'll upload this later the test user is not an administrative account we're",
    "start": "1981040",
    "end": "1987190"
  },
  {
    "text": "running our HTTP relay server and trying to connect using a client to a rogue",
    "start": "1987190",
    "end": "1993420"
  },
  {
    "text": "HTTP relay server now you can see that the authentication failed we were not able to authenticate",
    "start": "1993420",
    "end": "1999760"
  },
  {
    "text": "to the domain controller via Elda pass and you can see that there is no channel binding in the challenge and then in the",
    "start": "1999760",
    "end": "2008400"
  },
  {
    "text": "authenticate message we can see that we have a channel binding but it is set to all zeros so this is the one that we",
    "start": "2008400",
    "end": "2014309"
  },
  {
    "text": "relay back to the domain controller and the domain controller does not accept our message this is not the channel",
    "start": "2014309",
    "end": "2020820"
  },
  {
    "text": "binding field that it is expecting all",
    "start": "2020820",
    "end": "2025220"
  },
  {
    "text": "right now we'll try to run it again but this time we'll add new more two and new",
    "start": "2025910",
    "end": "2031400"
  },
  {
    "text": "parameters first of all we'll be removing the milk and second will be injecting or channel binding into the",
    "start": "2031400",
    "end": "2037920"
  },
  {
    "text": "challenge message okay so let's run this one again and connect using the client",
    "start": "2037920",
    "end": "2044010"
  },
  {
    "text": "to a rogue HTTP server and see what happens this time so in the in the",
    "start": "2044010",
    "end": "2051720"
  },
  {
    "text": "console we can see that the authentication was successful and that we were able to add our test user to the",
    "start": "2051720",
    "end": "2058378"
  },
  {
    "text": "enterprise admins group let's look at what happened in the trap so the",
    "start": "2058379",
    "end": "2064500"
  },
  {
    "text": "original challenge that we got from the domain controller did not have a channel binding however the one we're sending",
    "start": "2064500",
    "end": "2071158"
  },
  {
    "text": "back to the client does contain the channel binding that we computed in advance okay so the client signs our",
    "start": "2071159",
    "end": "2078810"
  },
  {
    "text": "rogue channel binding you can see it here and adds an additional one set which is set to all zeros we relay this",
    "start": "2078810",
    "end": "2086820"
  },
  {
    "text": "message back to the domain controller you can see again that we have our channel binding and an additional one",
    "start": "2086820",
    "end": "2092730"
  },
  {
    "text": "set to all zeros and also there is no making the message what the original message did include emic so we were able",
    "start": "2092730",
    "end": "2100140"
  },
  {
    "text": "to bypass all the best channel binding of that server by injecting our malicious channel binding into the",
    "start": "2100140",
    "end": "2106800"
  },
  {
    "text": "challenge message you can see now that the test user is an enterprise admin and attackers can do anything they want and",
    "start": "2106800",
    "end": "2113609"
  },
  {
    "text": "completely compromise their domain ok so",
    "start": "2113609",
    "end": "2119270"
  },
  {
    "text": "thank you so that was our channel binding bypass",
    "start": "2119270",
    "end": "2125619"
  },
  {
    "text": "and it's also the last vulnerability that we'll see let's discuss the fix for a second the fix is based on detecting a",
    "start": "2125619",
    "end": "2132640"
  },
  {
    "text": "signature of this attack so if a server receives an authenticated message that has two Channel bindings it would simply",
    "start": "2132640",
    "end": "2139779"
  },
  {
    "text": "deny the request still some problems with this fix because some clients don't support EPA and don't admit those are",
    "start": "2139779",
    "end": "2147670"
  },
  {
    "text": "the same you want the same ones that I've discussed previously so attackers would still be able to",
    "start": "2147670",
    "end": "2152740"
  },
  {
    "text": "inject the channel binding to those clients and since those don't support EPA they would not add an additional one",
    "start": "2152740",
    "end": "2159250"
  },
  {
    "text": "and attackers would be able to target those two real a sent occasional to domain controllers for example okay so",
    "start": "2159250",
    "end": "2168099"
  },
  {
    "text": "we've seen many vulnerabilities we've just seen how we're able to bypass all the most critical mitigations against",
    "start": "2168099",
    "end": "2174460"
  },
  {
    "text": "ntlm really now let's see some of the detection let's see some of the detections that we have in order to",
    "start": "2174460",
    "end": "2179650"
  },
  {
    "text": "detect the attack techniques that I've just presented thanks marina so by now I",
    "start": "2179650",
    "end": "2185920"
  },
  {
    "text": "think you've all understood that ntlm is risky and tell'em is risky not only due",
    "start": "2185920",
    "end": "2191440"
  },
  {
    "text": "to the vulnerabilities we have discovered but also due to bad configurations and insecure default",
    "start": "2191440",
    "end": "2197440"
  },
  {
    "text": "values so we believe at the terminus tic algorithm to detect ntlm really is",
    "start": "2197440",
    "end": "2202630"
  },
  {
    "text": "critically needed before I'll talk about the ntlm relay detection I want to take",
    "start": "2202630",
    "end": "2208809"
  },
  {
    "text": "a bird's eye view and discuss Active Directory attack detection most research",
    "start": "2208809",
    "end": "2214779"
  },
  {
    "text": "on detecting Active Directory infrastructure attacks focuses on two paradigms the first analyzing network",
    "start": "2214779",
    "end": "2221680"
  },
  {
    "text": "traffic and the second analyzing logs if you consider analyzing network traffic",
    "start": "2221680",
    "end": "2227770"
  },
  {
    "text": "there was not a lot of research on analyzing encrypted traffic if we look",
    "start": "2227770",
    "end": "2233470"
  },
  {
    "text": "at some typical examples we can see that for instance golden and silver tickets most common detection methods include",
    "start": "2233470",
    "end": "2241410"
  },
  {
    "text": "analyzing the encryption algorithm ticket lifetime and other creation attributes we argued that if you'll",
    "start": "2241410",
    "end": "2248440"
  },
  {
    "text": "decrypt the Kerberos tickets and validate that the fields are not malicious",
    "start": "2248440",
    "end": "2253680"
  },
  {
    "text": "you'll be able to create a better detection for golden tickets and silver tickets the second attempt to is",
    "start": "2253680",
    "end": "2259530"
  },
  {
    "text": "performing reconnaissance such as Vlad and doing same rol derp reconnaissance",
    "start": "2259530",
    "end": "2265460"
  },
  {
    "text": "mostly caught by analyzing the LDAP track or color queries that they do",
    "start": "2265460",
    "end": "2272150"
  },
  {
    "text": "while analyzing logs such as etw can create detections if we want to enforce",
    "start": "2272150",
    "end": "2279090"
  },
  {
    "text": "traffic in real-time we have to have network based detections while these tools often include are encrypted making",
    "start": "2279090",
    "end": "2285930"
  },
  {
    "text": "network based detection harder if will the kill the traffic will be able to do to have a much better detection the",
    "start": "2285930",
    "end": "2293940"
  },
  {
    "text": "third is ntlm relay up till this point no aunty LM relay detection it existed",
    "start": "2293940",
    "end": "2300890"
  },
  {
    "text": "except from analyzing anomalous ntlm activity so what we want to do is to",
    "start": "2300890",
    "end": "2307110"
  },
  {
    "text": "present the first ntlm relay detection in order to do that",
    "start": "2307110",
    "end": "2312150"
  },
  {
    "text": "I'm going to do another deep dive into the ntlm authenticate message so as you",
    "start": "2312150",
    "end": "2317670"
  },
  {
    "text": "recall the ntlm authenticate message has av pairs some of them are echoed from",
    "start": "2317670",
    "end": "2323130"
  },
  {
    "text": "the target info others are created by the ntlm client identifying the server",
    "start": "2323130",
    "end": "2329730"
  },
  {
    "text": "that it wanted to connect to the end one of these fields that I'm going to focus about is the target name the target name",
    "start": "2329730",
    "end": "2336900"
  },
  {
    "text": "is very similar to SP n in care boss and in this example it's six slash 10.1.1.1",
    "start": "2336900",
    "end": "2344670"
  },
  {
    "text": "meaning the ntlm client originally connected to an SMB server with that",
    "start": "2344670",
    "end": "2350130"
  },
  {
    "text": "relevant IP as with any other AV pair this IV / is part of the antipasto and",
    "start": "2350130",
    "end": "2356310"
  },
  {
    "text": "now attacker can modify all temper with this field so as we know once the entire",
    "start": "2356310",
    "end": "2363960"
  },
  {
    "text": "server receives an aunt LM authenticate message it would follow this message copying it",
    "start": "2363960",
    "end": "2369930"
  },
  {
    "text": "entirely in the net local message along with all the AV pills so how can we use this fact to detect the ntlm relay what",
    "start": "2369930",
    "end": "2377850"
  },
  {
    "text": "we can do is simply compare the ntlm relay to the antenna the network and",
    "start": "2377850",
    "end": "2383790"
  },
  {
    "text": "originator to the target name provided in the message in favilla a the code the tech target would be",
    "start": "2383790",
    "end": "2391480"
  },
  {
    "text": "identified as the net logon originator and the relay which is different will be identified by the AVP",
    "start": "2391480",
    "end": "2398490"
  },
  {
    "text": "identifying the target name so I was how such an attraction device can work the",
    "start": "2398490",
    "end": "2404080"
  },
  {
    "text": "detection device would analyze all and all traffic in coming to the DC looking",
    "start": "2404080",
    "end": "2410890"
  },
  {
    "text": "for net local messages after will decrypt this network on messages we can",
    "start": "2410890",
    "end": "2415900"
  },
  {
    "text": "find out we can find ntlm authenticate message and competency if the ntlm",
    "start": "2415900",
    "end": "2423040"
  },
  {
    "text": "server that originated the net logon is the same machine that is identified in",
    "start": "2423040",
    "end": "2428230"
  },
  {
    "text": "the target server SPN so i know this is a bit complex so let's review it again",
    "start": "2428230",
    "end": "2435090"
  },
  {
    "text": "so we begin with a regular ntlm relay attack the client receiving the ntlm",
    "start": "2435090",
    "end": "2441790"
  },
  {
    "text": "challenge would create an aunty LM authenticate message and this message would contain a target server AVP we",
    "start": "2441790",
    "end": "2449500"
  },
  {
    "text": "cannot modify this target server a VPS attackers so we simply relay that until",
    "start": "2449500",
    "end": "2454600"
  },
  {
    "text": "an authenticated message with the target server the attack target would initiate a net local session and since it wants",
    "start": "2454600",
    "end": "2462010"
  },
  {
    "text": "to enforce server signing it sorry my bad my mistake so the attack target",
    "start": "2462010",
    "end": "2469180"
  },
  {
    "text": "would initiate a net logon message now the net local message is originated by",
    "start": "2469180",
    "end": "2474430"
  },
  {
    "text": "the attack target and the dissing knows that the attack target originated the dead logon message but if we'll inspect",
    "start": "2474430",
    "end": "2480760"
  },
  {
    "text": "the target server AVP we can detect that it was a discrepancy the target name",
    "start": "2480760",
    "end": "2487720"
  },
  {
    "text": "identifies the compromised server and the network on originator is that tech",
    "start": "2487720",
    "end": "2492880"
  },
  {
    "text": "target if we see that this discrepancy exists this must have been an mplm relay",
    "start": "2492880",
    "end": "2498310"
  },
  {
    "text": "attack and we can block this message completely blocking the attempt regardless if server signing is enabled",
    "start": "2498310",
    "end": "2504790"
  },
  {
    "text": "or disabled so what are the requirements to do so we need to monitor all DC",
    "start": "2504790",
    "end": "2512140"
  },
  {
    "text": "traffic and we need to keep track of our computer accounts hashes since net logon",
    "start": "2512140",
    "end": "2517210"
  },
  {
    "text": "messages are encrypted once we once we decrypt the net logon",
    "start": "2517210",
    "end": "2522369"
  },
  {
    "text": "message we can simply compare the SPN present in the net local message to the net logon originator this defects all",
    "start": "2522369",
    "end": "2529990"
  },
  {
    "text": "ntlm relay attacks done with until env2 except one small scenario",
    "start": "2529990",
    "end": "2535299"
  },
  {
    "text": "man-in-the-middle the reason we don't detect many in the middle is since many men in the middle",
    "start": "2535299",
    "end": "2541680"
  },
  {
    "text": "detect the compromised device directs the ntlm authentication message to the",
    "start": "2541680",
    "end": "2548770"
  },
  {
    "text": "same server the client originally wanted to connect to we believe this scenario",
    "start": "2548770",
    "end": "2555339"
  },
  {
    "text": "is less important from a couple of reasons first many in the middle attacks attacks are harder to accomplish than",
    "start": "2555339",
    "end": "2562089"
  },
  {
    "text": "ntlm relay attacks second if session signing is not enabled",
    "start": "2562089",
    "end": "2568809"
  },
  {
    "text": "it can be done with care boss and third you can only attack a single target which the client originally wanted to",
    "start": "2568809",
    "end": "2575290"
  },
  {
    "text": "connect to decrypting network on traffic does not only help with generic ntlm",
    "start": "2575290",
    "end": "2582309"
  },
  {
    "text": "relay detection we can detect the two vulnerabilities we have found we can",
    "start": "2582309",
    "end": "2587619"
  },
  {
    "text": "detect the first vulnerability if we look at the net logon message and see",
    "start": "2587619",
    "end": "2592660"
  },
  {
    "text": "that the a/v pairs does not contain a net balance computer name this means someone try to exploit your session key",
    "start": "2592660",
    "end": "2598990"
  },
  {
    "text": "is my session key vulnerability the second one of ability can also be detected we can detect EP a bypass if we",
    "start": "2598990",
    "end": "2606940"
  },
  {
    "text": "see an end a net logon message with an anti authenticate that contains two channel bindings AV pills",
    "start": "2606940",
    "end": "2613599"
  },
  {
    "text": "we know someone tried to exploit the EP a bypass vulnerability and ferb probably",
    "start": "2613599",
    "end": "2618910"
  },
  {
    "text": "the most critical as I've mentioned until + v1 is not protected at all but",
    "start": "2618910",
    "end": "2624760"
  },
  {
    "text": "if we can look at all metal burn messages if we will see two net local",
    "start": "2624760",
    "end": "2630010"
  },
  {
    "text": "messages that contain the same challenge and challenge response we know someone",
    "start": "2630010",
    "end": "2635049"
  },
  {
    "text": "tried to pass the challenge and do a spoof networking session even with your say session case my session key or the",
    "start": "2635049",
    "end": "2641710"
  },
  {
    "text": "previous 2015 vulnerability other than just detecting vulnerabilities it will",
    "start": "2641710",
    "end": "2648339"
  },
  {
    "text": "decrypt net logon message there was a real treasure for routines we can look at the net logon",
    "start": "2648339",
    "end": "2653670"
  },
  {
    "text": "data the decrypted net lagoon data and create reports about the security configuration in the network for",
    "start": "2653670",
    "end": "2660210"
  },
  {
    "text": "instance if we see messages that don't contain the Ava flag signaling the meek",
    "start": "2660210",
    "end": "2666900"
  },
  {
    "text": "presence we know that there are computers in the network that same ntlm",
    "start": "2666900",
    "end": "2672540"
  },
  {
    "text": "authenticate messages with nomic we can detect weak encryption methods like LM",
    "start": "2672540",
    "end": "2678060"
  },
  {
    "text": "and ntlm v1 and probably the list which is the most interesting in my opinion we",
    "start": "2678060",
    "end": "2683700"
  },
  {
    "text": "can detect ntlm authentication inside net logins that don't have a channel bindings field if we can see such",
    "start": "2683700",
    "end": "2690480"
  },
  {
    "text": "messages this means these web servers don't strictly enforce APA and hence",
    "start": "2690480",
    "end": "2695760"
  },
  {
    "text": "vulnerable to ntlm relay attacks so what the data always we think you should",
    "start": "2695760",
    "end": "2701160"
  },
  {
    "text": "leave this session with the first obviously you need to patch all your",
    "start": "2701160",
    "end": "2706170"
  },
  {
    "text": "machines the second ntlm is risky you need to reduce it and while you don't finally",
    "start": "2706170",
    "end": "2713130"
  },
  {
    "text": "eradicate that protocol you need to enable server signing and EPA on all",
    "start": "2713130",
    "end": "2718620"
  },
  {
    "text": "machines in the network the third one I take away is that you should stop using",
    "start": "2718620",
    "end": "2723840"
  },
  {
    "text": "ntlm v1 it was previously published that all until MV one can sessions can be",
    "start": "2723840",
    "end": "2731490"
  },
  {
    "text": "cracked we have now presented that all ntlm v1 sessions can be relayed seriously just",
    "start": "2731490",
    "end": "2737670"
  },
  {
    "text": "stop using ntlm v1 so the last part is",
    "start": "2737670",
    "end": "2743580"
  },
  {
    "text": "that sense I know that mitigating all ntlm vulnerabilities is a process we",
    "start": "2743580",
    "end": "2749220"
  },
  {
    "text": "believe that the ntlm detection algorithms we were just presented can go a long way in making networks more",
    "start": "2749220",
    "end": "2755220"
  },
  {
    "text": "secure some credits are in do first they all come in session felt from the",
    "start": "2755220",
    "end": "2761730"
  },
  {
    "text": "preempt research team have also contributed to this research second alberto Selina from alpena's integrate",
    "start": "2761730",
    "end": "2768210"
  },
  {
    "text": "our tech code into iron packet and 4i a packet in general which is an awesome",
    "start": "2768210",
    "end": "2773910"
  },
  {
    "text": "tool that we use all the time in fact all the attack all the demos you've seen today were using iron packet so model",
    "start": "2773910",
    "end": "2783330"
  },
  {
    "text": "commendation is that you using ntlm altogether but if you can't resist",
    "start": "2783330",
    "end": "2788339"
  },
  {
    "text": "I hope the lessons you've learned today would help you not get relayed thank you",
    "start": "2788339",
    "end": "2795950"
  },
  {
    "text": "[Applause]",
    "start": "2795950",
    "end": "2800219"
  }
]