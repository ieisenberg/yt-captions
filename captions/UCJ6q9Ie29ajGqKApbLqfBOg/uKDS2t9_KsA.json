[
  {
    "text": "[Music] foreign",
    "start": "1730",
    "end": "6720"
  },
  {
    "text": "welcome to my session back dooring and hijacking Azure ID accounts by abusing external identities I'm dirky monama and",
    "start": "7880",
    "end": "14580"
  },
  {
    "text": "I'm very happy to to be here and see all of you in person um very short bit about me I'm dirkian",
    "start": "14580",
    "end": "20580"
  },
  {
    "text": "I'm from the Netherlands this year I started my own company focusing on Azure ad and active directory consultancy and",
    "start": "20580",
    "end": "26340"
  },
  {
    "text": "research I also like to write blogs about this topic and tools and if you",
    "start": "26340",
    "end": "32099"
  },
  {
    "text": "want you can follow me on on Twitter at underscore dear Keon now before we dive into the details uh",
    "start": "32099",
    "end": "38520"
  },
  {
    "text": "let's start with some definitions some important Concepts so this talk is about Azure active directory not related to",
    "start": "38520",
    "end": "45360"
  },
  {
    "text": "on-prem active directory and Azure ID is really the central identity platform for everything in Azure be it Microsoft 365",
    "start": "45360",
    "end": "52620"
  },
  {
    "text": "as your resource manager or any third-party SAS servers you would like to connect to it and use it as your",
    "start": "52620",
    "end": "58739"
  },
  {
    "text": "authentication so we're not talking about VMS or networks here we're really talking about the identity parts of",
    "start": "58739",
    "end": "65158"
  },
  {
    "text": "azure and if you're looking at Azure um one of the important things to uh in",
    "start": "65159",
    "end": "71400"
  },
  {
    "text": "security perspective is a tenant so a tenant is like a separate instance of azure ID for one organization",
    "start": "71400",
    "end": "78240"
  },
  {
    "text": "um most organizations will have one primary tenant for example linked to their Microsoft 365 Services they may",
    "start": "78240",
    "end": "84360"
  },
  {
    "text": "have multiple tenants but it's an important security boundary in Azure ad so you're not supposed to be able to",
    "start": "84360",
    "end": "90600"
  },
  {
    "text": "access data in a different tenant because that doesn't belong to you now if we're talking about tenants we're",
    "start": "90600",
    "end": "96720"
  },
  {
    "text": "also talking about collaboration here and in that sense there's also external identities so an external identity is",
    "start": "96720",
    "end": "103560"
  },
  {
    "text": "really easy it's any identity that's not managed in your tenants so it can be an",
    "start": "103560",
    "end": "109020"
  },
  {
    "text": "identity that's native to another tenant or even a different identity provider so it could be a personal Microsoft account",
    "start": "109020",
    "end": "115740"
  },
  {
    "text": "a Google account or even just like a virtual account based on only an email address as we'll see later",
    "start": "115740",
    "end": "122340"
  },
  {
    "text": "Chinese talk um we'll be talking about external collaboration so collaboration between two tenants",
    "start": "122340",
    "end": "128340"
  },
  {
    "text": "and I've set up some well some blocks over here so usually we'll be talking about tenant a and tenant B and the",
    "start": "128340",
    "end": "135599"
  },
  {
    "text": "Tenant on the left is the tenant a and that's kind of the the primary tenant",
    "start": "135599",
    "end": "140819"
  },
  {
    "text": "that we're looking at so that's the tenant of the organization that we're either attacking or defending and tenant",
    "start": "140819",
    "end": "146760"
  },
  {
    "text": "B may be an external party or a Tracker control tenant in the case that we're exploiting something",
    "start": "146760",
    "end": "153300"
  },
  {
    "text": "so in terms of external collaboration there's a tenant there's the home tenant",
    "start": "153300",
    "end": "159120"
  },
  {
    "text": "of the order organization and that account we want to give access to our",
    "start": "159120",
    "end": "164220"
  },
  {
    "text": "tenant so in tenant a so to talk in terms of the other organization the user",
    "start": "164220",
    "end": "169920"
  },
  {
    "text": "there is called the home tenants and the account is in the home tenants and for that the perspective from the",
    "start": "169920",
    "end": "175620"
  },
  {
    "text": "perspective of 10 and B tenant a is called the resource tenants because it's an external tenant now if we have an",
    "start": "175620",
    "end": "182099"
  },
  {
    "text": "external account a guest account is created in tenant a and that's somehow linked to the to the account in the home",
    "start": "182099",
    "end": "190200"
  },
  {
    "text": "tenant so in tenant B so there's a link between those two and the accounts are are interconnected and we'll look at how",
    "start": "190200",
    "end": "196860"
  },
  {
    "text": "that works a bit later on so in this setup I have two tenants the primary tenants the tenant a is the",
    "start": "196860",
    "end": "203480"
  },
  {
    "text": "image.cloud which is where you usually do my research and for this I also set up a secondary tenant called cross",
    "start": "203480",
    "end": "210239"
  },
  {
    "text": "tenant Dev and in this scenario we're all looking at default settings so",
    "start": "210239",
    "end": "215280"
  },
  {
    "text": "there's no uh specific weakening of specific settings that would make certain attacks possible it is all",
    "start": "215280",
    "end": "221700"
  },
  {
    "text": "possible by default and we're also not using any specific B2B trust that would",
    "start": "221700",
    "end": "227340"
  },
  {
    "text": "Grant more privileges to a certain tenant so let's start having a look at how the",
    "start": "227340",
    "end": "233580"
  },
  {
    "text": "invite flow looks from a GUI perspective so if we're in our tenant in the I'm in",
    "start": "233580",
    "end": "239159"
  },
  {
    "text": "your Cloud tenant we can add a new user and say hey this is an external user and we want to invite them to our tenants so",
    "start": "239159",
    "end": "245340"
  },
  {
    "text": "I send this invite to the invite me email address and that user will get an email so the",
    "start": "245340",
    "end": "251640"
  },
  {
    "text": "email will contain an invite acceptance link and if they click on it they'll be prompted written with an acceptance",
    "start": "251640",
    "end": "258239"
  },
  {
    "text": "screen and if they click accept then an account is created in the I'm in your Cloud tenant and they're signed in with",
    "start": "258239",
    "end": "265440"
  },
  {
    "text": "their accounts but in a different tenant so at this point the invite me user it",
    "start": "265440",
    "end": "271560"
  },
  {
    "text": "still exists in the cross tenant depth but it's accessing resources in the I'm in your Cloud tenant and if they look at",
    "start": "271560",
    "end": "277800"
  },
  {
    "text": "the organization's view um you see that the account exists in two possible tenants and you can switch",
    "start": "277800",
    "end": "283020"
  },
  {
    "text": "kind of switch between them so that's how it looks to an end user now",
    "start": "283020",
    "end": "288240"
  },
  {
    "text": "um we want to start looking at how this looks under the hoods and we have several options for that so if we look at Azure ad kind of low",
    "start": "288240",
    "end": "295740"
  },
  {
    "text": "level stuff or other information there's various options so the first one and the officially supported one is the",
    "start": "295740",
    "end": "302220"
  },
  {
    "text": "Microsoft graph which is the official API for everything in Microsoft 365 and",
    "start": "302220",
    "end": "307919"
  },
  {
    "text": "also including Azure ID there's a lot of things you can query from there but it doesn't always contain all the",
    "start": "307919",
    "end": "313560"
  },
  {
    "text": "information um so there's also an API that's near more closer to the actual representation",
    "start": "313560",
    "end": "320759"
  },
  {
    "text": "of azure ID and that's the Azure ID graph so it's kind of lower level it only covers Azure ad so no other",
    "start": "320759",
    "end": "327120"
  },
  {
    "text": "services and it's sometimes also possible to use an official internal versions to gather a bit more",
    "start": "327120",
    "end": "333539"
  },
  {
    "text": "information than is supported in production environments so this one is deprecated but it's as it's more",
    "start": "333539",
    "end": "340860"
  },
  {
    "text": "interesting for us as researchers I usually prefer to use the Azure ID graph lastly there's of course also the portal",
    "start": "340860",
    "end": "347280"
  },
  {
    "text": "in which we're also doing various demos and this may use the Microsoft graph or the Azure ad graph depending on which",
    "start": "347280",
    "end": "353820"
  },
  {
    "text": "feature you're using and in the stock we'll use a mix of both the actual ID graph and the Microsoft",
    "start": "353820",
    "end": "359940"
  },
  {
    "text": "graph and also use my tool rodrigon which is part of row tools and that's kind of a front end for the AED graph so",
    "start": "359940",
    "end": "366840"
  },
  {
    "text": "it allows you to gather all the information offline and then view it from a GUI perspective",
    "start": "366840",
    "end": "373680"
  },
  {
    "text": "so looking at some of the lower level things and I usually like to go to the audit log first because any action in",
    "start": "373680",
    "end": "381539"
  },
  {
    "text": "Azure ad will create an audit log event and we can actually see what properties were changed so this this is the event",
    "start": "381539",
    "end": "387960"
  },
  {
    "text": "for the invite Redemption so when the guest account the infight was redeemed and we see that some properties are",
    "start": "387960",
    "end": "394740"
  },
  {
    "text": "updated and the most interesting one is probably the alternative security ID property so",
    "start": "394740",
    "end": "401340"
  },
  {
    "text": "we see that some data was added here and if we look at the results from the Azure",
    "start": "401340",
    "end": "406740"
  },
  {
    "text": "ID graph in row tools we also see that the alternative security IDs property is",
    "start": "406740",
    "end": "411840"
  },
  {
    "text": "now populated and it says something about an identity provider a key and a",
    "start": "411840",
    "end": "418020"
  },
  {
    "text": "type so there's probably here a link to the user account somewhere now I looked a bit at what that key",
    "start": "418020",
    "end": "424680"
  },
  {
    "text": "could be because it's a64 encoded but you probably would have guessed from this um and actually if we decode that and we",
    "start": "424680",
    "end": "432300"
  },
  {
    "text": "re-encode it into um into hex formats and we got kind of hexadecimal number",
    "start": "432300",
    "end": "438600"
  },
  {
    "text": "and if we look at the tenants where the user resides that we invite it we see that this has the same ID so this",
    "start": "438600",
    "end": "445560"
  },
  {
    "text": "property is called the netid and this is kind of what links the two accounts together so the guest account has a",
    "start": "445560",
    "end": "451319"
  },
  {
    "text": "property in the alternative security IDs and that links back to the netid",
    "start": "451319",
    "end": "457440"
  },
  {
    "text": "property of the account in the home tenant all right so this was how it looked in",
    "start": "457440",
    "end": "463680"
  },
  {
    "text": "the in the GUI and what was the result so I wondered can we also invite people uh from a programmatic perspective I",
    "start": "463680",
    "end": "470819"
  },
  {
    "text": "found some interesting um interesting documentation or characters on third-party projects uh",
    "start": "470819",
    "end": "476639"
  },
  {
    "text": "which was from a long time ago and it basically says hey you can redeem invites uh using this tool and using",
    "start": "476639",
    "end": "482520"
  },
  {
    "text": "some post requests and with Json payload I was like hey this sounds interesting especially because it's it it features",
    "start": "482520",
    "end": "490319"
  },
  {
    "text": "the same same property so the outsec IDS which could be the alternative",
    "start": "490319",
    "end": "495479"
  },
  {
    "text": "Securities property and some other properties such as a invite ticket which",
    "start": "495479",
    "end": "500639"
  },
  {
    "text": "also seemed familiar to me so if we want to use this programmatically and we would use the",
    "start": "500639",
    "end": "506400"
  },
  {
    "text": "net ID of the external user well that we can query so we can query that in the in",
    "start": "506400",
    "end": "511979"
  },
  {
    "text": "the home tenant and we can query it using sad graph and we can also extract that from any access tokens that are",
    "start": "511979",
    "end": "518399"
  },
  {
    "text": "issued to the user so if you have an access token for that user there will be a puid claim and that's to say netid",
    "start": "518399",
    "end": "525240"
  },
  {
    "text": "that belongs to the account and we also need the infight tickets because that's like a kind of secret",
    "start": "525240",
    "end": "531480"
  },
  {
    "text": "information that's linked to the invite that we can that we need but it turns",
    "start": "531480",
    "end": "536760"
  },
  {
    "text": "out that we can actually just query these invites since it's a property of the user that is invited in the AED",
    "start": "536760",
    "end": "543420"
  },
  {
    "text": "graph so then we end up with this simple post request we redeem the invite by the API",
    "start": "543420",
    "end": "550320"
  },
  {
    "text": "and we can specify our own identity so the netid and also the email and using",
    "start": "550320",
    "end": "556860"
  },
  {
    "text": "the invite tickets that we queried earlier now I started looking into this and I",
    "start": "556860",
    "end": "562140"
  },
  {
    "text": "quickly ran into some issues so you would expect that you need some",
    "start": "562140",
    "end": "567540"
  },
  {
    "text": "privileged role to modify accounts in this way but turns out that's not true so any user in the tenants could redeem",
    "start": "567540",
    "end": "574560"
  },
  {
    "text": "an invite for any invited user which is a bit weird um also none of the information that is",
    "start": "574560",
    "end": "581100"
  },
  {
    "text": "supplied in the post request is actually verified um so I could use any accepted as email I could pretend I'm someone working in a",
    "start": "581100",
    "end": "588420"
  },
  {
    "text": "completely different organization and I also can link it to any external account in any directory because it's just based",
    "start": "588420",
    "end": "594720"
  },
  {
    "text": "on that net ID parameter which is not checked and last but not least all the infight",
    "start": "594720",
    "end": "601500"
  },
  {
    "text": "tickets so the secret kind of secret parts that's needed to redeem the invite can also be queried by any user in the",
    "start": "601500",
    "end": "607620"
  },
  {
    "text": "tenant so if we have this nice request for the AED graph we apply a filter which says",
    "start": "607620",
    "end": "614700"
  },
  {
    "text": "user State equals pending acceptance so those are all the users that have not read yet redeemed their invite and then",
    "start": "614700",
    "end": "621240"
  },
  {
    "text": "we select the invite ticket from the AED graph so this nicely gives us the um the",
    "start": "621240",
    "end": "626880"
  },
  {
    "text": "email address for the user and also the invite ticket that's needed to redeem this invite",
    "start": "626880",
    "end": "632519"
  },
  {
    "text": "and we can of course also query the netid from the target account so in this case I'm querying it for the",
    "start": "632519",
    "end": "640080"
  },
  {
    "text": "new low pref user in my other tenant and you see that the netid for that user is",
    "start": "640080",
    "end": "646260"
  },
  {
    "text": "shown as output of the query of course we can convert this using a simple cyber Chef recipe back to the",
    "start": "646260",
    "end": "652740"
  },
  {
    "text": "base64 representation and if we put it all in the post request you saw earlier using the invite ticket and the net ID",
    "start": "652740",
    "end": "659160"
  },
  {
    "text": "we get a response and it says hey I this invite was accepted as guest at outside",
    "start": "659160",
    "end": "665000"
  },
  {
    "text": "security.net which is not the email address of the legitimate account that we linked it to and we see the",
    "start": "665000",
    "end": "671459"
  },
  {
    "text": "alternative security IDs back and it links to the net ID of the Rogue accounts and if you then switch to the tenant I",
    "start": "671459",
    "end": "679140"
  },
  {
    "text": "hope this is a bit readable so on the right top you see this is the new low priv user Independence and on the bottom",
    "start": "679140",
    "end": "685680"
  },
  {
    "text": "you say see that this is now linked to the guest at the outside security Delta now email from which we kind of stole",
    "start": "685680",
    "end": "693000"
  },
  {
    "text": "the invite and also an interesting part is that there's no way to actually see this so",
    "start": "693000",
    "end": "699899"
  },
  {
    "text": "if you're an Azure admin and someone hijacked your invites and linked it to some arbitrary accounts you could never",
    "start": "699899",
    "end": "706200"
  },
  {
    "text": "find out because it's just been linked based on this binary property but you",
    "start": "706200",
    "end": "711779"
  },
  {
    "text": "cannot see the net IDs in a different tenant and all it shows you here in the GUI is that that it's an external Azure",
    "start": "711779",
    "end": "718620"
  },
  {
    "text": "ID um but not switch account is actually linked to",
    "start": "718620",
    "end": "723959"
  },
  {
    "text": "start a short version basically every user in your tenants could query for inviting but not redeemed or just if you",
    "start": "723959",
    "end": "731640"
  },
  {
    "text": "repeat that often enough just be quicker than the user is actually inside it and they could redeem the invite without any",
    "start": "731640",
    "end": "738060"
  },
  {
    "text": "validation on the information that was provided and it was also no way for uh",
    "start": "738060",
    "end": "743279"
  },
  {
    "text": "Azure ID administrators to actually find out which account it was linked to",
    "start": "743279",
    "end": "748320"
  },
  {
    "text": "now some impact scenarios if you're not familiar with external accounts um they're they are often used for external",
    "start": "748320",
    "end": "755700"
  },
  {
    "text": "suppliers for example which need some kind of access be it in Azure 80 itself or to manage Azure subscriptions or",
    "start": "755700",
    "end": "762300"
  },
  {
    "text": "resources but it could also be that an account is invited and immediately granted a privileged role in Azure ID",
    "start": "762300",
    "end": "769320"
  },
  {
    "text": "because there's a UI when you invite it it says hey which role Studios account get so if I invite someone from one",
    "start": "769320",
    "end": "775560"
  },
  {
    "text": "supplier and I give their guest account Globe admin privileges for example someone could immediately hijack that",
    "start": "775560",
    "end": "781980"
  },
  {
    "text": "invite and be Global admin in my tenant there's also bypasses the allow list of",
    "start": "781980",
    "end": "787680"
  },
  {
    "text": "external collaboration domains because as we saw before the domain is not actually verified so you could send an",
    "start": "787680",
    "end": "794279"
  },
  {
    "text": "invite to an allowed domain and then link it to an account in a completely different tenant",
    "start": "794279",
    "end": "799320"
  },
  {
    "text": "and lastly of course because any user could do this if an account is compromised an attacker could hijack a",
    "start": "799320",
    "end": "806220"
  },
  {
    "text": "different guest accounts and if their account is then discovered and remediated they still have access to",
    "start": "806220",
    "end": "811680"
  },
  {
    "text": "their guest accounts and any resource that has been granted access to so how could you figure this out",
    "start": "811680",
    "end": "818820"
  },
  {
    "text": "um so if you're an Azure admin and you want to know hey this has happened to me um there are some traces of this so if",
    "start": "818820",
    "end": "825660"
  },
  {
    "text": "you look at the audit log on the left side we'll see the the regular invite flow and then the invite is Redeemed by",
    "start": "825660",
    "end": "832560"
  },
  {
    "text": "an application it's called the Microsoft invitation acceptance portal and that's",
    "start": "832560",
    "end": "837839"
  },
  {
    "text": "done as as an application using a certain ID on the right side we see the Rogue",
    "start": "837839",
    "end": "843360"
  },
  {
    "text": "Redemption and in this case the invite is Redeemed by a user namely the user",
    "start": "843360",
    "end": "848579"
  },
  {
    "text": "that authenticated and performs the the post request to redeem the invite file the API",
    "start": "848579",
    "end": "854639"
  },
  {
    "text": "now you can of course try the query for this and I wrote a kql query that you can use to hunt for this in your tenants",
    "start": "854639",
    "end": "861240"
  },
  {
    "text": "and if you find any results I hope you don't but if you find any you may have",
    "start": "861240",
    "end": "867060"
  },
  {
    "text": "an invite that was stolen by someone else all right so so far we looked at the GUI",
    "start": "867060",
    "end": "873779"
  },
  {
    "text": "flow and we also looked at how guest accounts are represented in the Azure ID",
    "start": "873779",
    "end": "879120"
  },
  {
    "text": "graph now that leaves the Microsoft graph so external identities have an interesting",
    "start": "879120",
    "end": "884940"
  },
  {
    "text": "property in a Microsoft graph which is called the identities property",
    "start": "884940",
    "end": "890160"
  },
  {
    "text": "um it's a bit less there's a little bit less information in there so we don't see the binary good for example",
    "start": "890160",
    "end": "896279"
  },
  {
    "text": "um but the interesting part about this versus the actual ad graph is that the Microsoft graph actually allows you to",
    "start": "896279",
    "end": "902040"
  },
  {
    "text": "modify these identities property so in the Azure ID graph you can't modify the alt security identity IDs property not",
    "start": "902040",
    "end": "909540"
  },
  {
    "text": "even as Global admin but in a Microsoft graph you can actually do this so I was wondering okay suppose we can",
    "start": "909540",
    "end": "916440"
  },
  {
    "text": "modify a user's identities with the correct privileges now what could we do with it like what values could we input",
    "start": "916440",
    "end": "923760"
  },
  {
    "text": "there that would would give us something interesting so I looked at what identity providers there are",
    "start": "923760",
    "end": "929820"
  },
  {
    "text": "Now by default you have other Azure active directories which are a valid",
    "start": "929820",
    "end": "935519"
  },
  {
    "text": "identity provider and you also have Microsoft accounts you could add like a Google or Facebook or another IDP here",
    "start": "935519",
    "end": "942420"
  },
  {
    "text": "but that's not default but one that stood out for me is the email one-time",
    "start": "942420",
    "end": "947459"
  },
  {
    "text": "passcode and that's kind of a new one and it's an interesting one because it allows you to send an invite to a user",
    "start": "947459",
    "end": "954660"
  },
  {
    "text": "that doesn't have an Azure ID account or a Microsoft account and it allows to them to sign in solely based on their",
    "start": "954660",
    "end": "960839"
  },
  {
    "text": "email address so there's no real account here it's kind of a weird virtual account that may or may not exist in",
    "start": "960839",
    "end": "968040"
  },
  {
    "text": "some tenant that's managed by Microsoft but it's it's a very simple way of",
    "start": "968040",
    "end": "973380"
  },
  {
    "text": "representing an identity um so here we look at the Microsoft",
    "start": "973380",
    "end": "979260"
  },
  {
    "text": "graph for a user that I invited that doesn't have any accounts so it will",
    "start": "979260",
    "end": "985019"
  },
  {
    "text": "sign in with the email we'll call the email OTP and we see that in this case the",
    "start": "985019",
    "end": "991199"
  },
  {
    "text": "identity simply says sign-in type Federated the issuer is Mill which is",
    "start": "991199",
    "end": "996600"
  },
  {
    "text": "the issuer type for email OTP and the issuer assigned ID is simply the email address",
    "start": "996600",
    "end": "1002480"
  },
  {
    "text": "if we look at the Azure ID graph we see something very similar identity provider is Mill and the key simply is the email",
    "start": "1002480",
    "end": "1009440"
  },
  {
    "text": "address but then base64 encoded now I was looking at okay who can modify",
    "start": "1009440",
    "end": "1015139"
  },
  {
    "text": "these identities attributes because if we can modify this we may be able to link accounts to some other external",
    "start": "1015139",
    "end": "1020779"
  },
  {
    "text": "identity so it turns out of course Globe admins can do this user administrators can do",
    "start": "1020779",
    "end": "1026780"
  },
  {
    "text": "this and apps with the correct privileges can do it and but the surprising one is that users can modify",
    "start": "1026780",
    "end": "1033140"
  },
  {
    "text": "their own identities and I know what is needed I have a feeling it's for some b2c scenarios but",
    "start": "1033140",
    "end": "1040160"
  },
  {
    "text": "I figured this out because I was looking at the Azure 80 user's role definition and if you look at this it has all the",
    "start": "1040160",
    "end": "1046520"
  },
  {
    "text": "things that the user can do based on the condition that the resource itself and",
    "start": "1046520",
    "end": "1051860"
  },
  {
    "text": "here it says well it can update the identities property but only for their own accounts",
    "start": "1051860",
    "end": "1057140"
  },
  {
    "text": "so let's give some interesting attack scenarios so if we have temporary access",
    "start": "1057140",
    "end": "1062539"
  },
  {
    "text": "to an account or we have a scope limited access token with the correct delegated",
    "start": "1062539",
    "end": "1067580"
  },
  {
    "text": "permissions we could backdoor these accounts by modifying the identities parameter and just link it to some",
    "start": "1067580",
    "end": "1072799"
  },
  {
    "text": "external accounts that we control on as an attacker some of these scenarios would be if you",
    "start": "1072799",
    "end": "1079280"
  },
  {
    "text": "have temporary account access for example you have a malware attack and yours temporary in someone's laptop you",
    "start": "1079280",
    "end": "1085100"
  },
  {
    "text": "could link the account to your own account another scenario is if you for example use device code fishing you'll get some",
    "start": "1085100",
    "end": "1092120"
  },
  {
    "text": "refresh and access tokens but you can't just do anything with the accounts but you could convert that by updating the",
    "start": "1092120",
    "end": "1099200"
  },
  {
    "text": "identity's property lastly if you somehow take over an application with the correct privileges",
    "start": "1099200",
    "end": "1105799"
  },
  {
    "text": "a user signing into you could also obtain these access tokens that have enough privileges to modify these",
    "start": "1105799",
    "end": "1112160"
  },
  {
    "text": "attributes so let's look at us how this attack works so first we look at the original ones so",
    "start": "1112160",
    "end": "1120380"
  },
  {
    "text": "we're looking at the new low profuser and we see that the identities are only the",
    "start": "1120380",
    "end": "1126440"
  },
  {
    "text": "um the normal one so it signs in with the user principal name um and that's just native in our tenants",
    "start": "1126440",
    "end": "1133700"
  },
  {
    "text": "so let's create um let's backdoor these identities so I've invited an OTP account",
    "start": "1133700",
    "end": "1141200"
  },
  {
    "text": "and this one is the mill OTP in outside the select.def and you see that this",
    "start": "1141200",
    "end": "1147320"
  },
  {
    "text": "account is is signed into the cross tenant death tenant so I invited this",
    "start": "1147320",
    "end": "1152539"
  },
  {
    "text": "account in my attacker tenant and I'm going to link it to the tenant of the",
    "start": "1152539",
    "end": "1157700"
  },
  {
    "text": "organization that we're attacking so I patched this using the account",
    "start": "1157700",
    "end": "1162860"
  },
  {
    "text": "access and I say hey now my sign-in type is Federated from this mail address and",
    "start": "1162860",
    "end": "1168440"
  },
  {
    "text": "the email address Ismail OTP if we look at the same identity again we",
    "start": "1168440",
    "end": "1173600"
  },
  {
    "text": "see that there's now two identities and so first is the user principal name but the second identity is that email OTP",
    "start": "1173600",
    "end": "1181220"
  },
  {
    "text": "information that we just linked to now if I go to that email OTP account I",
    "start": "1181220",
    "end": "1186320"
  },
  {
    "text": "can simply switch tenants so I can say I'm already signed in here I'm switching to I'm your Cloud tenant and it says hey",
    "start": "1186320",
    "end": "1193220"
  },
  {
    "text": "I found an identity you can use here which is called the mill OTP user and if",
    "start": "1193220",
    "end": "1198799"
  },
  {
    "text": "you click on that you notice that you sign in as the new low pref user using",
    "start": "1198799",
    "end": "1204679"
  },
  {
    "text": "the email address that we control so we just re-linked this new low breath",
    "start": "1204679",
    "end": "1210320"
  },
  {
    "text": "account to an email address on the control of the attacker and we're now signed in into the I'm in your Cloud",
    "start": "1210320",
    "end": "1215539"
  },
  {
    "text": "tenant so this does require some pre-existing access but it's really easy to modify",
    "start": "1215539",
    "end": "1222740"
  },
  {
    "text": "this and Link it to an external account and it's also very easy to switch it back so we can do the same post requests",
    "start": "1222740",
    "end": "1229520"
  },
  {
    "text": "but with just with an empty parameter and that will switch back the account to only the normal sign-in name and we can",
    "start": "1229520",
    "end": "1237440"
  },
  {
    "text": "even use this old access token and now the account is completely normal again",
    "start": "1237440",
    "end": "1243200"
  },
  {
    "text": "all right so users can do this by themselves but there are some more interesting scenarios",
    "start": "1243200",
    "end": "1249260"
  },
  {
    "text": "so as an extra bonus um we get this privilege escalation because user administrators by",
    "start": "1249260",
    "end": "1255980"
  },
  {
    "text": "definition cannot reset password for example from higher privileged accounts so user administrator can't reset the",
    "start": "1255980",
    "end": "1263299"
  },
  {
    "text": "password of a global administrator because that would be an elevation of privilege but they can modify the",
    "start": "1263299",
    "end": "1268580"
  },
  {
    "text": "identity attributes of the global admin or basically any other user and this way they could take over the",
    "start": "1268580",
    "end": "1274820"
  },
  {
    "text": "accounts of a higher privileged user in the tenants there's also even an easier way to do",
    "start": "1274820",
    "end": "1280820"
  },
  {
    "text": "this so if you're a user administrator like I said you cannot reset the password but this is very nice button",
    "start": "1280820",
    "end": "1287179"
  },
  {
    "text": "which says convert account to B2B account and that you can do so you can",
    "start": "1287179",
    "end": "1292640"
  },
  {
    "text": "even do this from the GUI you can simply convert a global admin to a B2B account using a B2B email address that you",
    "start": "1292640",
    "end": "1298940"
  },
  {
    "text": "control and then you're the global admin yourself so just how that works",
    "start": "1298940",
    "end": "1305720"
  },
  {
    "text": "um like I said this is completely in the GUI so we have this Global admin account we modified the email address to point",
    "start": "1305720",
    "end": "1312260"
  },
  {
    "text": "to the Rogue at crossten and Dev and then we invite them to B2B so we",
    "start": "1312260",
    "end": "1317840"
  },
  {
    "text": "convert this account to an external account and then we sign in with the external accounts and we see that there's only a",
    "start": "1317840",
    "end": "1324080"
  },
  {
    "text": "global administrator so the short version user administrator",
    "start": "1324080",
    "end": "1329419"
  },
  {
    "text": "can convert any account to B2B accounts including higher privileged accounts",
    "start": "1329419",
    "end": "1334820"
  },
  {
    "text": "you can do this via the query or with two simple post requests to the Microsoft graph and of course if we",
    "start": "1334820",
    "end": "1341480"
  },
  {
    "text": "combine this with what we saw earlier you don't even need to redeem the invite with the real account you could just use",
    "start": "1341480",
    "end": "1347419"
  },
  {
    "text": "those the um the API to redeem the invite and Link it to any external account and it will be completely",
    "start": "1347419",
    "end": "1353480"
  },
  {
    "text": "invisible so there's a downside to this it doesn't work for accounts with the mailbox because then Azure ID refuses to update",
    "start": "1353480",
    "end": "1360620"
  },
  {
    "text": "the email address but then you could switch back to modifying the identities attributes and you could still link an",
    "start": "1360620",
    "end": "1366679"
  },
  {
    "text": "account to an email OTP user now there's a caveat with this so if you",
    "start": "1366679",
    "end": "1373700"
  },
  {
    "text": "convert an account or you batch their identities you're only changing the primary authentication so you could sign",
    "start": "1373700",
    "end": "1380000"
  },
  {
    "text": "in with an email address instead of with the password but if there's MFA configured and required for the accounts",
    "start": "1380000",
    "end": "1385820"
  },
  {
    "text": "this would still kick in so NFA would save the day in this case or at least",
    "start": "1385820",
    "end": "1391640"
  },
  {
    "text": "you'd think so um because I also had a look at how guest tenants and NFA work so if we have this",
    "start": "1391640",
    "end": "1401360"
  },
  {
    "text": "um if we have to set up with the victim account which is MFA configured an attacker account which is MFA configured",
    "start": "1401360",
    "end": "1407900"
  },
  {
    "text": "then if we link those so if we hijack the accounts by modifying the identities",
    "start": "1407900",
    "end": "1413659"
  },
  {
    "text": "or we convert to B2B account if we sign in the NFA methods we'll still be the",
    "start": "1413659",
    "end": "1419000"
  },
  {
    "text": "ones of the victim account so the original one so just signing in with our own MFA methods in our own tenants",
    "start": "1419000",
    "end": "1425059"
  },
  {
    "text": "wouldn't give us fa access to the to the victim tenants",
    "start": "1425059",
    "end": "1430820"
  },
  {
    "text": "let's there are some observations that I had with MFA so of course if you perform",
    "start": "1430820",
    "end": "1437000"
  },
  {
    "text": "MFA in a sign-in session you don't have to do that like with every app you sign in because then you would be entering",
    "start": "1437000",
    "end": "1442700"
  },
  {
    "text": "MFA information continuously so this is just there is some caching of",
    "start": "1442700",
    "end": "1447740"
  },
  {
    "text": "when you did MFA in a login session and it also holds for activity in tenants",
    "start": "1447740",
    "end": "1453620"
  },
  {
    "text": "where we're guests so if I have my primary accounts I've signed into another tenant and I have my own MFA",
    "start": "1453620",
    "end": "1459620"
  },
  {
    "text": "methods there I don't need to redo this whole on facing all the time so this suggests that the MFA",
    "start": "1459620",
    "end": "1466700"
  },
  {
    "text": "information is cached somewhere in the session and it keeps dragged of which tenants we actually did MFA in or not",
    "start": "1466700",
    "end": "1475179"
  },
  {
    "text": "um So based on these assumptions I tried something new and I'm calling this account rebinding because it sounds cool",
    "start": "1475340",
    "end": "1483140"
  },
  {
    "text": "um basically we have the attacker account which has the own MFA methods and you should you should always",
    "start": "1483140",
    "end": "1488900"
  },
  {
    "text": "remember that if we're doing cross tenant things it's always the source identity that we're looking at so in",
    "start": "1488900",
    "end": "1494960"
  },
  {
    "text": "this case this session is from the attacker and it doesn't really matter which account that's linked to because",
    "start": "1494960",
    "end": "1501320"
  },
  {
    "text": "it's always the attacker account which may be performing authentication in understandings but That Remains the Same",
    "start": "1501320",
    "end": "1507620"
  },
  {
    "text": "Source identity so what we could do what it did is I",
    "start": "1507620",
    "end": "1513679"
  },
  {
    "text": "first invite the attacker to the tenant legitimately so the attacker now has a guest account and with that they can",
    "start": "1513679",
    "end": "1520280"
  },
  {
    "text": "configure their own MFA methods now if we delete this account so the guest account is gone and the attacker",
    "start": "1520280",
    "end": "1527720"
  },
  {
    "text": "accounts still exists but it doesn't have access in the victim tenant anymore but if you keep the same sign in session",
    "start": "1527720",
    "end": "1533480"
  },
  {
    "text": "and you link the victim account to the attacker account guess what happens it",
    "start": "1533480",
    "end": "1538580"
  },
  {
    "text": "caches the MFA information so if we link this account the Decker could still have",
    "start": "1538580",
    "end": "1545419"
  },
  {
    "text": "the MFA information in the sign in session and you can actually authenticate SD victim accounts and",
    "start": "1545419",
    "end": "1552200"
  },
  {
    "text": "Azure ID will think oh you already did MFA but it doesn't look at which account you did multi-factor authentication for",
    "start": "1552200",
    "end": "1557419"
  },
  {
    "text": "so if you have a login session you could simply do MFA in a completely different",
    "start": "1557419",
    "end": "1562520"
  },
  {
    "text": "tenant so there's quite some things we can do with this using all the techniques that",
    "start": "1562520",
    "end": "1568940"
  },
  {
    "text": "we had but I created a nice little video and in this case I'm doing an attack using a",
    "start": "1568940",
    "end": "1575299"
  },
  {
    "text": "user administrator and there's also the other scenarios that I talked about but the nice thing about this is that all",
    "start": "1575299",
    "end": "1582440"
  },
  {
    "text": "this this whole attack can be done only by clicking in the GUI so you don't need any any graph calls or something",
    "start": "1582440",
    "end": "1589220"
  },
  {
    "text": "so let's go from the start so we're first attacking the attacker accounts",
    "start": "1589220",
    "end": "1595460"
  },
  {
    "text": "and that's one is basically it's on the right so we invite this Rogue account and we",
    "start": "1595460",
    "end": "1602960"
  },
  {
    "text": "created a guest account for it and it will get an email saying hey you're invited to this tenant",
    "start": "1602960",
    "end": "1609679"
  },
  {
    "text": "so now there's a guest account in the image cloud and we accept this invitation so we're linking that guest",
    "start": "1609679",
    "end": "1615799"
  },
  {
    "text": "account to our identity in the attacker tenant so we have to approve it it takes a",
    "start": "1615799",
    "end": "1621740"
  },
  {
    "text": "little while to convert the account and then we're we have a guest account",
    "start": "1621740",
    "end": "1627679"
  },
  {
    "text": "because MFA is required it will ask us to register NFA information for our newly created guest accounts so in this",
    "start": "1627679",
    "end": "1634820"
  },
  {
    "text": "case using the Microsoft authenticator app and using virtual one because I want to",
    "start": "1634820",
    "end": "1640279"
  },
  {
    "text": "use my phone all the time but basically we're now registering MFA information for this account",
    "start": "1640279",
    "end": "1645679"
  },
  {
    "text": "all right so that's done so now we're signed in using our attacker account as",
    "start": "1645679",
    "end": "1651140"
  },
  {
    "text": "a guest in the victim tenant and we can actually see this and now",
    "start": "1651140",
    "end": "1657140"
  },
  {
    "text": "what we do is we can actually leave the the guest tenant again and that will",
    "start": "1657140",
    "end": "1662299"
  },
  {
    "text": "delete our guest accounts so you can do this as a guest yourself you could just say leave and the guest account will be",
    "start": "1662299",
    "end": "1669080"
  },
  {
    "text": "deleted but we're still signed into it so what we do here is now we convert our victim",
    "start": "1669080",
    "end": "1674480"
  },
  {
    "text": "accounts to B2B accounts we're basically linking it to the Rogue user so I'm",
    "start": "1674480",
    "end": "1680059"
  },
  {
    "text": "updating the email address first and then using the convert to beat beat feature and this will convert the",
    "start": "1680059",
    "end": "1686960"
  },
  {
    "text": "account and Link it to the email address of the attacker this might fail",
    "start": "1686960",
    "end": "1692299"
  },
  {
    "text": "sometimes because it's still updating in the back end and now it's converted and we'll get an email",
    "start": "1692299",
    "end": "1698659"
  },
  {
    "text": "so now we accept the invite for the converted account we click accept again",
    "start": "1698659",
    "end": "1705500"
  },
  {
    "text": "and it will take a while to actually link our accounts and then it signs Us in so we didn't see",
    "start": "1705500",
    "end": "1713000"
  },
  {
    "text": "any MFA prompt um but we're still signed in and we're now the the other user that we it was a",
    "start": "1713000",
    "end": "1719720"
  },
  {
    "text": "victim user and we can see this in the Azure portal so in this case I'm still signed in in",
    "start": "1719720",
    "end": "1726020"
  },
  {
    "text": "the attacker tenant but you can switch tenants and here it still only shows the attacker tenant but once we refresh it",
    "start": "1726020",
    "end": "1733220"
  },
  {
    "text": "then we'll actually see that the victim tenant is now also possible and we can just switch to there",
    "start": "1733220",
    "end": "1739340"
  },
  {
    "text": "so now we're signed in in the victim tenant and we can go to the our account in",
    "start": "1739340",
    "end": "1745820"
  },
  {
    "text": "Azure active directory to see that it's actually the same user so on the left you see the user ID way to do it and on",
    "start": "1745820",
    "end": "1753500"
  },
  {
    "text": "the right you see that we're signed into the exact same user so we now kind of took over the account",
    "start": "1753500",
    "end": "1758919"
  },
  {
    "text": "without needing to do MFA and Azure ID still thinks we did in the Theo",
    "start": "1758919",
    "end": "1764179"
  },
  {
    "text": "authentication so if we go to the sign in logs we see that we authenticate it",
    "start": "1764179",
    "end": "1771320"
  },
  {
    "text": "and the account name changed of course because we accepted the invite but you see that the requirement here",
    "start": "1771320",
    "end": "1776840"
  },
  {
    "text": "was multi-factor authentication but you also see that the NFA requirement was",
    "start": "1776840",
    "end": "1782299"
  },
  {
    "text": "already satisfied because our token contained the MFA claim that Azure ad customers when we did the Authentication",
    "start": "1782299",
    "end": "1790039"
  },
  {
    "text": "so this way you could bypass MFA as long as you change the account identities and",
    "start": "1790039",
    "end": "1795679"
  },
  {
    "text": "you can do it all just by clicking in the GUI and having a sign in session open",
    "start": "1795679",
    "end": "1801140"
  },
  {
    "text": "now of course after we took over this account we signed in with MFA so we can",
    "start": "1801140",
    "end": "1807200"
  },
  {
    "text": "add our own MFA method to the account to make the bypass permanent and now if",
    "start": "1807200",
    "end": "1812360"
  },
  {
    "text": "your user administrator you can change the password of the account and you have the MFA information needed that's",
    "start": "1812360",
    "end": "1818559"
  },
  {
    "text": "required to sign in so short version of this whole attack",
    "start": "1818559",
    "end": "1825620"
  },
  {
    "text": "so the MFA information seemed cached in the sign-in session based on your identity in your home tenant plus the",
    "start": "1825620",
    "end": "1832399"
  },
  {
    "text": "combination of the target tenant there was no link to the actual account you",
    "start": "1832399",
    "end": "1837620"
  },
  {
    "text": "did mfa4 it only looked at a tenant level so if you first created a new",
    "start": "1837620",
    "end": "1844100"
  },
  {
    "text": "account you registered your own MFA information and you keep signing in into the same session",
    "start": "1844100",
    "end": "1850940"
  },
  {
    "text": "um you could delete the guest account by leaving the organization but it still would cash in your session that you were",
    "start": "1850940",
    "end": "1857179"
  },
  {
    "text": "signed in using MFA in that tenant so if you re-link the account and you can do that either by converting it to a B2B",
    "start": "1857179",
    "end": "1864140"
  },
  {
    "text": "account as we saw in the in the video or you can do it via email OTP by",
    "start": "1864140",
    "end": "1869600"
  },
  {
    "text": "converting the by patching the identities attribute you can just rebind those accounts and",
    "start": "1869600",
    "end": "1875840"
  },
  {
    "text": "you can bypass MFA and Azure ID won't prompt you for it anymore because you already did it for your adjustment",
    "start": "1875840",
    "end": "1881480"
  },
  {
    "text": "account um so some attack scenarios here if you",
    "start": "1881480",
    "end": "1886520"
  },
  {
    "text": "had limited account access such as an access token with the right scope you could convert it into full persistent",
    "start": "1886520",
    "end": "1892520"
  },
  {
    "text": "access including MFA where it was needed if you only had access to the account",
    "start": "1892520",
    "end": "1897559"
  },
  {
    "text": "password you may also be able to bypass NFA and conditional access if it's not",
    "start": "1897559",
    "end": "1904220"
  },
  {
    "text": "required for all applications so let's not put something I see very often is that people require MFA for example of",
    "start": "1904220",
    "end": "1911559"
  },
  {
    "text": "365 but you could still sign into the Azure ID Powershell module using only a",
    "start": "1911559",
    "end": "1917779"
  },
  {
    "text": "password and if you then have the token for that you could patch the identities",
    "start": "1917779",
    "end": "1922820"
  },
  {
    "text": "attributes bypass the MFA register MFA information and you could sign into any other application you want",
    "start": "1922820",
    "end": "1930140"
  },
  {
    "text": "and of course as a user administrator account you could elevate your privileges to Global admin including",
    "start": "1930140",
    "end": "1936140"
  },
  {
    "text": "bypassing their MFA and you put bypass MFA for any other use in the tenant as well",
    "start": "1936140",
    "end": "1941659"
  },
  {
    "text": "now I hear some of you thinking I'm not actually using external identities no one can invite guests so am I safe here",
    "start": "1941659",
    "end": "1950000"
  },
  {
    "text": "well no um so there's some alternatives to this and instead of inviting a guest account",
    "start": "1950000",
    "end": "1955940"
  },
  {
    "text": "you could also temporarily link your own account to some external account first",
    "start": "1955940",
    "end": "1962360"
  },
  {
    "text": "so let's say you have your own account such as user administrator you link that",
    "start": "1962360",
    "end": "1967399"
  },
  {
    "text": "to an email OTP account you create it in a different tenant and so that the user is already invited",
    "start": "1967399",
    "end": "1972799"
  },
  {
    "text": "so you don't need to invite it yourself um that you register the MFA information then you unlink it then you link it to a",
    "start": "1972799",
    "end": "1979820"
  },
  {
    "text": "different account and then you have bypass the MFA without needing the guest account user",
    "start": "1979820",
    "end": "1986240"
  },
  {
    "text": "so this removes the requirement to actually invite an external user and this basically bypasses all these",
    "start": "1986240",
    "end": "1992419"
  },
  {
    "text": "security controls that there are for external collaboration so I try to put everything to the most Quick Settings I",
    "start": "1992419",
    "end": "1998779"
  },
  {
    "text": "like blocking users from sending invites even explicitly blocking external accounts disabling the email OTP methods",
    "start": "1998779",
    "end": "2006399"
  },
  {
    "text": "didn't really matter the attack was still possible because we were already signed in with email OTP and at the",
    "start": "2006399",
    "end": "2013059"
  },
  {
    "text": "point we did the accounts which actually ad didn't check anymore whether email OTP was even enabled in the tenants",
    "start": "2013059",
    "end": "2020518"
  },
  {
    "text": "um so of course I reported these things to Microsoft and our report is this four separate issues in March this year so",
    "start": "2020799",
    "end": "2027940"
  },
  {
    "text": "the guest invite Redemption without validation was tricked pretty fast within a few weeks",
    "start": "2027940",
    "end": "2033519"
  },
  {
    "text": "the elevation from usual admin to Globe admin by converting their account to B2B",
    "start": "2033519",
    "end": "2038740"
  },
  {
    "text": "was fixed in April and the MFA bypass via account rebinding",
    "start": "2038740",
    "end": "2043980"
  },
  {
    "text": "was a fixed yesterday so quite last minute",
    "start": "2043980",
    "end": "2050260"
  },
  {
    "text": "and the vectoring account identities is still something they're working on so I know they they're paying attention to",
    "start": "2050260",
    "end": "2056800"
  },
  {
    "text": "this and they are working on on the fix but at least you can still so you can",
    "start": "2056800",
    "end": "2062138"
  },
  {
    "text": "still modify these identities and Link it to an email OTP account but you can no longer bypass bypass MFA using using",
    "start": "2062139",
    "end": "2070300"
  },
  {
    "text": "this technique um so some recommendations to ants",
    "start": "2070300",
    "end": "2075638"
  },
  {
    "text": "um if you're a Defender just remove those accounts which haven't redeemed their invites they're kind of laying",
    "start": "2075639",
    "end": "2081700"
  },
  {
    "text": "around there and if someone finds a bypass again um they could take over those accounts",
    "start": "2081700",
    "end": "2087339"
  },
  {
    "text": "and most tenants I analyzed that did have some external users they were always users laying around for years",
    "start": "2087339",
    "end": "2092800"
  },
  {
    "text": "that just didn't redeem their invites you can lock down guest invite rights",
    "start": "2092800",
    "end": "2097900"
  },
  {
    "text": "and guest access settings in Azure ID so certainly don't give your guest users",
    "start": "2097900",
    "end": "2103119"
  },
  {
    "text": "permissions that your normal users have because then they can well enumerate everything in the tenant and view all",
    "start": "2103119",
    "end": "2108820"
  },
  {
    "text": "kind of information and you typically don't want your users to just invite whoever they want and give them access",
    "start": "2108820",
    "end": "2115119"
  },
  {
    "text": "to to your ayur edit tenants because that enables a lot more scenarios",
    "start": "2115119",
    "end": "2121240"
  },
  {
    "text": "of course if you're using this feature I'd recommend you lock down which tenants can actually be used in which",
    "start": "2121240",
    "end": "2127720"
  },
  {
    "text": "domains invites can be sent to and there are some new features that can that allow you to restrict which apps guests",
    "start": "2127720",
    "end": "2134380"
  },
  {
    "text": "can access and all that other things of course you might want to look in your",
    "start": "2134380",
    "end": "2140079"
  },
  {
    "text": "audit logs if anyone did do this so you can use the query that I posted on my my",
    "start": "2140079",
    "end": "2146619"
  },
  {
    "text": "gist on my GitHub that has a kql query for the invite hijack and of course you",
    "start": "2146619",
    "end": "2152500"
  },
  {
    "text": "can also search for users modifying their own identities property because",
    "start": "2152500",
    "end": "2157660"
  },
  {
    "text": "that's also logged in the audit logs and lastly enforce MFA across all apps",
    "start": "2157660",
    "end": "2163839"
  },
  {
    "text": "instead of selectively because if there's this scenario that you could bypass MFA using some certain token that",
    "start": "2163839",
    "end": "2170740"
  },
  {
    "text": "you can obtain without anything that would leave a hole in in your defenses",
    "start": "2170740",
    "end": "2176200"
  },
  {
    "text": "so thank you for your attention if there's any questions be happy to take",
    "start": "2176200",
    "end": "2181599"
  },
  {
    "text": "them and otherwise you can always send me a DM on Twitter or send me an email with your questions",
    "start": "2181599",
    "end": "2188640"
  },
  {
    "text": "[Music]",
    "start": "2190320",
    "end": "2193429"
  },
  {
    "text": "[Music]",
    "start": "2197280",
    "end": "2200369"
  }
]