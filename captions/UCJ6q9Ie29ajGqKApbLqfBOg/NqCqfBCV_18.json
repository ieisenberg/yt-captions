[
  {
    "start": "0",
    "end": "440000"
  },
  {
    "text": "foreign",
    "start": "1979",
    "end": "4159"
  },
  {
    "text": "UK how we doing how we doing great okay good so uh Welcome to our",
    "start": "8360",
    "end": "16560"
  },
  {
    "text": "talk about writing your old ticket to the cloud like apt and we are here like",
    "start": "16560",
    "end": "23160"
  },
  {
    "text": "my name is stuck my history Cinema and I work for CQ works and I'm the senior",
    "start": "23160",
    "end": "28260"
  },
  {
    "text": "principles security researcher and I have a another talker here my name is",
    "start": "28260",
    "end": "34500"
  },
  {
    "text": "Roberto Rodriguez I'm a principal uh security researcher at Microsoft and I'm part of the Microsoft security research",
    "start": "34500",
    "end": "41280"
  },
  {
    "text": "organization and I collaborate a lot with this guy so now I have to see him in conferences too and talk to him yeah",
    "start": "41280",
    "end": "48600"
  },
  {
    "text": "so let's start with the quote that kind of our presentation is based on so we",
    "start": "48600",
    "end": "54300"
  },
  {
    "text": "think it's a Chong Lambert he's a great guy from Microsoft he said that Defenders thinks uh in lists and",
    "start": "54300",
    "end": "60840"
  },
  {
    "text": "attackers think in graphs and as long as this is through the bad guys are going",
    "start": "60840",
    "end": "65939"
  },
  {
    "text": "to win and this is a kind of how we build our presentation so",
    "start": "65939",
    "end": "71820"
  },
  {
    "text": "this is based on on the talk I gave earlier this year in Troopers in Germany",
    "start": "71820",
    "end": "77400"
  },
  {
    "text": "I think it was June or something and it was called Eight ways to compromise adfs",
    "start": "77400",
    "end": "83340"
  },
  {
    "text": "but in this talk uh there's not gonna be like any new attack vectors or anything like that so sorry about that so it's",
    "start": "83340",
    "end": "89040"
  },
  {
    "text": "more like defending but anyways here's what we're going to talk about so short introduction then we're gonna introduce you adfs",
    "start": "89040",
    "end": "96240"
  },
  {
    "text": "attack and defense graphs and finally we're gonna wrap up that how you can protect protect against a cold Ensemble",
    "start": "96240",
    "end": "103079"
  },
  {
    "text": "attacks so well we have a user right",
    "start": "103079",
    "end": "109200"
  },
  {
    "text": "and then we have a service provider and I'm talking about identity variation Concepts so not that Federation that we",
    "start": "109200",
    "end": "115259"
  },
  {
    "text": "covered with Keynotes so that's a little different different one but anyways um we have service provider which in this",
    "start": "115259",
    "end": "121619"
  },
  {
    "text": "case is azure ID and user wants to access that service we have identity provider which in this",
    "start": "121619",
    "end": "128459"
  },
  {
    "text": "case it's adfs and the adafs is trusting the user when",
    "start": "128459",
    "end": "133739"
  },
  {
    "text": "the user provides some kind of proof of identity then the ADF is trust that and also the other lady is trusting the",
    "start": "133739",
    "end": "141120"
  },
  {
    "text": "identity provider but how can we like prove that who the user is so here comes",
    "start": "141120",
    "end": "147660"
  },
  {
    "text": "the technical part so we have security token in this case it's called saml or",
    "start": "147660",
    "end": "152700"
  },
  {
    "text": "security asset multiple language token which is signed by the adfs",
    "start": "152700",
    "end": "158160"
  },
  {
    "text": "and then when the user is accessing as a ready it is trusting that ticket and and",
    "start": "158160",
    "end": "163560"
  },
  {
    "text": "that's how the user can prove who or who he or she is and",
    "start": "163560",
    "end": "169940"
  },
  {
    "text": "one slide about Golden summer attack so that's how I think it is so it is using",
    "start": "169940",
    "end": "176940"
  },
  {
    "text": "two my three techniques so first we're gonna steal certificates and then with",
    "start": "176940",
    "end": "182099"
  },
  {
    "text": "those certificates we are going to create uh or we can afford sample tokens",
    "start": "182099",
    "end": "188220"
  },
  {
    "text": "so in order to do this to work you need to have the token significant from that",
    "start": "188220",
    "end": "193920"
  },
  {
    "text": "identity provider regardless what it is and in this case we are going to focus the first one so how can we steal that",
    "start": "193920",
    "end": "201120"
  },
  {
    "text": "certificate so there are different ways to do that and now I'm going here because I want to get the numbers right so is it this",
    "start": "201120",
    "end": "206760"
  },
  {
    "text": "important so how many of you is using adfs or any other declaration yeah",
    "start": "206760",
    "end": "213900"
  },
  {
    "text": "and probably the rest of you are just lying or you don't know that so a legal statistic so from last year",
    "start": "213900",
    "end": "223319"
  },
  {
    "text": "about a year ago from Fortune 500 organization 88 was using as already and",
    "start": "223319",
    "end": "229560"
  },
  {
    "text": "from those 68 was using Federation and about six months ago from Top UCO UK",
    "start": "229560",
    "end": "236099"
  },
  {
    "text": "60 organizations 86 was using as ready and from those 60 has at least one or",
    "start": "236099",
    "end": "243060"
  },
  {
    "text": "more Federated domains so this is still a thing right",
    "start": "243060",
    "end": "248220"
  },
  {
    "text": "and here's at adfs attack list quite easy you start you export stuff",
    "start": "248220",
    "end": "254099"
  },
  {
    "text": "and you're good to go and I think it was like four years ago when doc bienstock",
    "start": "254099",
    "end": "259919"
  },
  {
    "text": "introduced the adfs dump that was two yes and and if you like protected your",
    "start": "259919",
    "end": "266220"
  },
  {
    "text": "environment using that it's not enough so there's more to this",
    "start": "266220",
    "end": "272418"
  },
  {
    "text": "so let's start with some adfs details so first of all for token sign certificates",
    "start": "272840",
    "end": "278460"
  },
  {
    "text": "you have two options so you can have them managed with the default one and then that so a dedicated stored in",
    "start": "278460",
    "end": "285720"
  },
  {
    "text": "configuration database and it is encrypted using a key that is stored in ad so you have like two ingredients",
    "start": "285720",
    "end": "292320"
  },
  {
    "text": "and the second option is to use custom certificates which means that the yellow just normal certificates which are",
    "start": "292320",
    "end": "298740"
  },
  {
    "text": "stored in certificate store of each adfs server so you have these two options and now",
    "start": "298740",
    "end": "306060"
  },
  {
    "text": "this attack graph is going to look more like graph right so we have a couple of options and we need to cover all of",
    "start": "306060",
    "end": "312780"
  },
  {
    "text": "those but it's it's not that easy there's more so you can store sorry you",
    "start": "312780",
    "end": "320220"
  },
  {
    "text": "have a couple of options for storage thing that configuration and the first one is Windows internal",
    "start": "320220",
    "end": "326520"
  },
  {
    "text": "database or WID th I think it's also known as SQL Express at some point of time but",
    "start": "326520",
    "end": "332580"
  },
  {
    "text": "anyways in this configuration one of those adfs servers is a primary node",
    "start": "332580",
    "end": "337860"
  },
  {
    "text": "and the others are secondary nodes right and each of those servers have their own",
    "start": "337860",
    "end": "343139"
  },
  {
    "text": "copy of that data in that database however if you try to make like configuration senses only primary node",
    "start": "343139",
    "end": "350639"
  },
  {
    "text": "can do that so the secondary nodes are synchronizing the data from the primary node I think",
    "start": "350639",
    "end": "356820"
  },
  {
    "text": "it was like every once in five minutes or so so there's a service that allows you to pull the configuration",
    "start": "356820",
    "end": "363720"
  },
  {
    "text": "okay and the second option is to use microsql servers to store that data which means",
    "start": "363720",
    "end": "369600"
  },
  {
    "text": "that there's no primary nodes anymore or secondary nodes because every single server can connect to that you know",
    "start": "369600",
    "end": "375660"
  },
  {
    "text": "centralized SQL Server however that service that allows you to synchronize the configuration is still there",
    "start": "375660",
    "end": "383660"
  },
  {
    "text": "so now that we have the graph so we have different ways to you know store data",
    "start": "384180",
    "end": "391500"
  },
  {
    "text": "there's different ways that we can use as certificates and this is the whole whole stuff and",
    "start": "391500",
    "end": "396539"
  },
  {
    "text": "now we're going to go through each of these steps so I'm going to tell how you can compromise those and then my friend",
    "start": "396539",
    "end": "403020"
  },
  {
    "text": "Roberto is going to tell you how you can detect that maybe even mitigate or prevent that right some of that yeah so",
    "start": "403020",
    "end": "409380"
  },
  {
    "text": "let's see let's start with the access configuration database and that was the part of the original adfs dump and we're",
    "start": "409380",
    "end": "417240"
  },
  {
    "text": "gonna start with local so we can see here's a local and we have a couple of different methods and by local I mean",
    "start": "417240",
    "end": "424500"
  },
  {
    "text": "that you need to compromise that adfs server and now the exponentification database it simply means that when you have a",
    "start": "424500",
    "end": "432060"
  },
  {
    "text": "compromised computer you're accessing the database which is usually like a that local database",
    "start": "432060",
    "end": "438780"
  },
  {
    "text": "so how can we react that so one of the things that is very important from uh you know defense",
    "start": "438780",
    "end": "445199"
  },
  {
    "text": "perspective is to be able to understand that there is a couple specific things that are",
    "start": "445199",
    "end": "451020"
  },
  {
    "text": "happening under the hood and you have to be able to describe all those little things so that you can start mapping",
    "start": "451020",
    "end": "457020"
  },
  {
    "text": "things such as data sources mitigations detections Etc and I think that that's the part where the graph comes into",
    "start": "457020",
    "end": "463560"
  },
  {
    "text": "place because graph is not only to talk about identities how they connect to each other how they have access to",
    "start": "463560",
    "end": "469319"
  },
  {
    "text": "certain things we can actually apply those Concepts to what we want to build you know detections in general right so",
    "start": "469319",
    "end": "475560"
  },
  {
    "text": "in in this presentation we're going to cover the concepts of operations things that are executed by a tool right used",
    "start": "475560",
    "end": "483900"
  },
  {
    "text": "by a thread actor artifacts are going to be things that are going to be created things that are going to be used as part",
    "start": "483900",
    "end": "490080"
  },
  {
    "text": "of the execution and then also we're going to talk about data sources uh and also some mitigations uh you know later",
    "start": "490080",
    "end": "495780"
  },
  {
    "text": "on so when we talk about accessing the configuration database right there is going to be two specific actions that",
    "start": "495780",
    "end": "502919"
  },
  {
    "text": "are going to be you know repeated across some of the variations of these",
    "start": "502919",
    "end": "508020"
  },
  {
    "text": "techniques right we have the connection to the database and then we have also the action to read the adfs",
    "start": "508020",
    "end": "513959"
  },
  {
    "text": "configuration when we start talking about connecting to the database by default the connection happens over a",
    "start": "513959",
    "end": "520919"
  },
  {
    "text": "name pipe and that name pipe the the format of the name pipe will change a",
    "start": "520919",
    "end": "526200"
  },
  {
    "text": "little bit depending on the version of your server right and then if you're actually using SQL a SQL Server by",
    "start": "526200",
    "end": "533279"
  },
  {
    "text": "default you also have name pipe connections as an option right to connect to that locally so there we also",
    "start": "533279",
    "end": "541080"
  },
  {
    "text": "there is also a way to connect actually locally to that database and now this can happen of course via the apis and",
    "start": "541080",
    "end": "548519"
  },
  {
    "text": "this could be done by any tool that you write right it could be Powershell c-sharp I mean you can do a lot just to",
    "start": "548519",
    "end": "555480"
  },
  {
    "text": "get to the same kind of like artifacts right you're going to be using some apis to connect to this somehow",
    "start": "555480",
    "end": "562200"
  },
  {
    "text": "then there is of course if there is a connection there needs to be some type of authentication a user needs to log on",
    "start": "562200",
    "end": "568800"
  },
  {
    "text": "to that SQL Server right and then in this variation talks about that once you",
    "start": "568800",
    "end": "574380"
  },
  {
    "text": "have a connection to the database then you can run SQL query so that you can start accessing the adfs configuration",
    "start": "574380",
    "end": "581519"
  },
  {
    "text": "and this is one example of that basic SQL query but there is different ways to",
    "start": "581519",
    "end": "587640"
  },
  {
    "text": "do this and thread actors are actually good at this because they they kind of monitor what is the normal way that this",
    "start": "587640",
    "end": "594300"
  },
  {
    "text": "happens and they can probably replicate some of that right and when we start thinking about data sources from a name",
    "start": "594300",
    "end": "600779"
  },
  {
    "text": "pipe connection perspective at that I would say step in the operational flow",
    "start": "600779",
    "end": "606360"
  },
  {
    "text": "of this we have something such as system locks which monitors name pipe connections and then you also have",
    "start": "606360",
    "end": "612360"
  },
  {
    "text": "application logs that will allow you to audit users logging into the SQL database and also the queries that are",
    "start": "612360",
    "end": "619380"
  },
  {
    "text": "going to be executed to gather information from the database just to give you some more context and",
    "start": "619380",
    "end": "626100"
  },
  {
    "start": "623000",
    "end": "733000"
  },
  {
    "text": "some of this is going to be of course in some of the resources that we're going to be sharing at the end of the presentation but this event is going to",
    "start": "626100",
    "end": "632760"
  },
  {
    "text": "tell you more about name pipe connections you do have the context of a user of the process that did it in the",
    "start": "632760",
    "end": "638940"
  },
  {
    "text": "name pipe and one thing that you need to consider here is that there are so many different processes that are actually",
    "start": "638940",
    "end": "645000"
  },
  {
    "text": "doing this that you will have to based on your environment you will have to do some type of Stack counting like trying",
    "start": "645000",
    "end": "651779"
  },
  {
    "text": "to understand what normal is but at the same time think about that thread actors do the same thing and they will try to",
    "start": "651779",
    "end": "657480"
  },
  {
    "text": "probably be able to impersonate some of those users or you know processes or",
    "start": "657480",
    "end": "662640"
  },
  {
    "text": "inject their own sessions into whatever is normal so think about that as well when you do this and these are just two",
    "start": "662640",
    "end": "669360"
  },
  {
    "text": "examples of those Name by connections when we talk about logging",
    "start": "669360",
    "end": "674820"
  },
  {
    "text": "actually logging into the database this is one example of the event this is",
    "start": "674820",
    "end": "679980"
  },
  {
    "text": "going to be sent to the application logs and this is how you actually can enable it manually by default only the um",
    "start": "679980",
    "end": "688740"
  },
  {
    "text": "so you have the successful logins and you also have the failed login so fail",
    "start": "688740",
    "end": "694079"
  },
  {
    "text": "logins is usually what is enabled by default right and then if you want to um you know audit those queries you will",
    "start": "694079",
    "end": "701220"
  },
  {
    "text": "have to actually create a surveyed audit and database audit specification and that would allow you to specifically",
    "start": "701220",
    "end": "707459"
  },
  {
    "text": "query anyone actually reading your avfs configuration the settings in that table",
    "start": "707459",
    "end": "713399"
  },
  {
    "text": "that exist in this database right so same thing as before I would actually try to see how this is done and this is",
    "start": "713399",
    "end": "720959"
  },
  {
    "text": "one example of how this is accomplished and this is done by tools like aad",
    "start": "720959",
    "end": "726060"
  },
  {
    "text": "internals created by nestoria so just kind of keep an eye on those uh you know SQL statements right there",
    "start": "726060",
    "end": "732540"
  },
  {
    "text": "okay okay and the next one is a dotnet reflection",
    "start": "732540",
    "end": "739800"
  },
  {
    "start": "733000",
    "end": "875000"
  },
  {
    "text": "and that attack is based on the fact that well you have the like relative command called get adfs product",
    "start": "739800",
    "end": "746279"
  },
  {
    "text": "properties which is returning a an object that has the welcome setting",
    "start": "746279",
    "end": "751500"
  },
  {
    "text": "of The adfs but that has also like hidden properties and methods which you can call using.net reflection so",
    "start": "751500",
    "end": "758160"
  },
  {
    "text": "basically you ask ADF said hey give me the configuration and it will get you the configuration so",
    "start": "758160",
    "end": "763860"
  },
  {
    "text": "you don't need to do the access to the configuration database and I think it was first introduced like a couple of",
    "start": "763860",
    "end": "769740"
  },
  {
    "text": "years ago in adfs Mike racing tool or something like that yeah it was 2014 13.",
    "start": "769740",
    "end": "775980"
  },
  {
    "text": "yeah so it has been there a long time ago but but we just uh you know spotted",
    "start": "775980",
    "end": "781320"
  },
  {
    "text": "that like a year ago or something like that but a very interesting way so when it's using the dotnet reflection",
    "start": "781320",
    "end": "787139"
  },
  {
    "text": "so you really can't see anything right because that's like a quite stealthy way",
    "start": "787139",
    "end": "792720"
  },
  {
    "text": "because ADF is doing that or can you do something yeah so there are a couple things you can do of course but",
    "start": "792720",
    "end": "798540"
  },
  {
    "text": "um first important to understand what's going on right so similar to our previous example in this scenario we're",
    "start": "798540",
    "end": "804540"
  },
  {
    "text": "not creating a new connection we're actually using what's already established but we're still going to",
    "start": "804540",
    "end": "810000"
  },
  {
    "text": "query that information and similar to when a story was saying so in order to do this we need to get the abfs settings",
    "start": "810000",
    "end": "816720"
  },
  {
    "text": "as a net object and you can actually accomplish this by using a built-in avfs",
    "start": "816720",
    "end": "822300"
  },
  {
    "text": "commandlet this will give you that avfs settings as a.net object but the",
    "start": "822300",
    "end": "828839"
  },
  {
    "text": "properties available in this object are actually public objects I'm sorry properties so the goal is to access",
    "start": "828839",
    "end": "836040"
  },
  {
    "text": "private properties in this data object so you can accomplish that actually by",
    "start": "836040",
    "end": "841620"
  },
  {
    "text": "trying to get a specific private property called service settings data and then you can get the value of the",
    "start": "841620",
    "end": "849600"
  },
  {
    "text": "that net settings object uh pointing to that private you know property and",
    "start": "849600",
    "end": "855180"
  },
  {
    "text": "that's pretty much how you can get the adfs configuration from a database and",
    "start": "855180",
    "end": "861300"
  },
  {
    "text": "of course if you're using Powershell all this can be accomplished with Powershell but if that's not available you also can",
    "start": "861300",
    "end": "867440"
  },
  {
    "text": "explore all that information through MC right which is the anti the anti-malware scan interface",
    "start": "867440",
    "end": "875160"
  },
  {
    "start": "875000",
    "end": "1070000"
  },
  {
    "text": "and when you think about Powershell so you have to also make sure that you understand the version of Powershell that you have in your system so version",
    "start": "875160",
    "end": "882180"
  },
  {
    "text": "3 plus would give you something like this event the 800 this is a classic",
    "start": "882180",
    "end": "887760"
  },
  {
    "text": "Powershell lock that does not have actually process information it lacks of",
    "start": "887760",
    "end": "893760"
  },
  {
    "text": "user information but it could actually show you that the commandlet was executed right this is kind of one",
    "start": "893760",
    "end": "900120"
  },
  {
    "text": "example in there 4103 it's a pipeline execution type of log available on version 5 plus and this",
    "start": "900120",
    "end": "909060"
  },
  {
    "text": "one will give you process context so you can actually correlate that with other events it will give you user context so",
    "start": "909060",
    "end": "915060"
  },
  {
    "text": "you'll know exactly who's executing this and then you can correlate that with something else right",
    "start": "915060",
    "end": "921360"
  },
  {
    "text": "you also have 4104 which is script block logging but you do have to enable what is called",
    "start": "921360",
    "end": "927899"
  },
  {
    "text": "Global Powershell script lock logging by default this actually is enabled but",
    "start": "927899",
    "end": "933480"
  },
  {
    "text": "only to capture events that are triggering because there is suspicious",
    "start": "933480",
    "end": "939600"
  },
  {
    "text": "strings being passed through the Powershell pipeline execution execution pipeline if you want to capture more",
    "start": "939600",
    "end": "945480"
  },
  {
    "text": "than that then you need to enable the global Powershell script log now MC is an interface that allows",
    "start": "945480",
    "end": "953220"
  },
  {
    "text": "applications to send data right to for example anti-malware vendors right and",
    "start": "953220",
    "end": "958980"
  },
  {
    "text": "and that information could be file scanning or memory scanning information right content from for example",
    "start": "958980",
    "end": "966240"
  },
  {
    "text": "Powershell execution all the way to maybe a PE file or a binary being loaded",
    "start": "966240",
    "end": "971519"
  },
  {
    "text": "into memory for example so this is like some built-in Windows feature yes it's a",
    "start": "971519",
    "end": "976740"
  },
  {
    "text": "built-in feature and these are some of the apps that are designed to actually send content to ANSI this is just for",
    "start": "976740",
    "end": "982920"
  },
  {
    "text": "reference of course if we're going to focus on the Powershell one for now so now you really don't need to buy",
    "start": "982920",
    "end": "988920"
  },
  {
    "text": "anything extra to use that nothing extra just okay just if you want to do a research this is how you actually would",
    "start": "988920",
    "end": "995160"
  },
  {
    "text": "enable it right so you can just use logman start a trace and then execute",
    "start": "995160",
    "end": "1001040"
  },
  {
    "text": "your attack and then it stop the trace and you're gonna get events but the problem is that you won't be able to",
    "start": "1001040",
    "end": "1006920"
  },
  {
    "text": "read them because the content cannot be interpreted but thanks to researchers",
    "start": "1006920",
    "end": "1012380"
  },
  {
    "text": "like Matt Graver from Red Canary a company that shares a lot of content with the community he put together this",
    "start": "1012380",
    "end": "1019279"
  },
  {
    "text": "Powershell script that allows you to actually parse those MC logs and you will be able to get to for example as a",
    "start": "1019279",
    "end": "1026900"
  },
  {
    "text": "basic proof of concept to all the the code that was passed through for example Powershell right",
    "start": "1026900",
    "end": "1033199"
  },
  {
    "text": "now as I mentioned before 4104 is a discrete block logging and",
    "start": "1033199",
    "end": "1038900"
  },
  {
    "text": "this is enabled by default only for warning uh events okay and this for",
    "start": "1038900",
    "end": "1045558"
  },
  {
    "text": "example trigger on this step of our dotnet reflection technique and that's",
    "start": "1045559",
    "end": "1051140"
  },
  {
    "text": "because there is actually a lot of strings that are considered malicious so it would actually scan the contents of",
    "start": "1051140",
    "end": "1057980"
  },
  {
    "text": "whatever is passing through the Powershell execution Pipeline and then trigger so in this case we had",
    "start": "1057980",
    "end": "1063679"
  },
  {
    "text": "properties being pulled out the properties that were actually non-public so that's what this event actually",
    "start": "1063679",
    "end": "1069320"
  },
  {
    "text": "executed and that's how I would approach some of that uh detection yeah thank you",
    "start": "1069320",
    "end": "1074600"
  },
  {
    "start": "1070000",
    "end": "1234000"
  },
  {
    "text": "so quite interesting that you are actually using totally proact dot dot net reflection and you're still going to",
    "start": "1074600",
    "end": "1080480"
  },
  {
    "text": "pull that amount of data so that's amazing what you can do nowadays okay but then we input something else called",
    "start": "1080480",
    "end": "1087740"
  },
  {
    "text": "synchronous Json config and what this does is so this is liberating the the",
    "start": "1087740",
    "end": "1093200"
  },
  {
    "text": "first option that that you are using the internet databases so this liberating the same uh",
    "start": "1093200",
    "end": "1099500"
  },
  {
    "text": "synchronization like a process if you will or or a protocol",
    "start": "1099500",
    "end": "1105320"
  },
  {
    "text": "that they are using so this requires that you have like credentials that have",
    "start": "1105320",
    "end": "1111020"
  },
  {
    "text": "permissions to read that configuration data so that's usually it's like ready as a service user or then the local",
    "start": "1111020",
    "end": "1117919"
  },
  {
    "text": "admin of that AWS server but you can do this remotely and this is using the port 80 actually so it's not uh",
    "start": "1117919",
    "end": "1125900"
  },
  {
    "text": "it's not encrypted but the content of those messages are so even though that's like a port 80 like 80db the the slope",
    "start": "1125900",
    "end": "1133280"
  },
  {
    "text": "messages are actually encrypted or yeah so what can we do with this one then it",
    "start": "1133280",
    "end": "1138980"
  },
  {
    "text": "has a lot to do here there is so much information that I actually didn't even know about so let's just dive into that",
    "start": "1138980",
    "end": "1145280"
  },
  {
    "text": "thing um so following our first example they're gonna be once again a similar",
    "start": "1145280",
    "end": "1150559"
  },
  {
    "text": "operational flow we need to connect as the story set we're connecting to Port 80 and that's because there is actually",
    "start": "1150559",
    "end": "1158000"
  },
  {
    "text": "a service that is going to be used on the adfs server that would allows us to then interact with the configuration by",
    "start": "1158000",
    "end": "1165140"
  },
  {
    "text": "simply syncing like replicating contact back to us right and this service is called the policy store transfer it's a",
    "start": "1165140",
    "end": "1172520"
  },
  {
    "text": "WCF uh service which is a Windows communication Foundation service and in",
    "start": "1172520",
    "end": "1178039"
  },
  {
    "text": "here you can start actually the basics right what data what logs will give you",
    "start": "1178039",
    "end": "1183200"
  },
  {
    "text": "network connections but at the same time what it is is that you can use to validate that those connections were",
    "start": "1183200",
    "end": "1189559"
  },
  {
    "text": "actually performed so that you can interact with the specific service right the policy transfer service",
    "start": "1189559",
    "end": "1197179"
  },
  {
    "text": "and in this scenario there is actually a mitigation that you can apply so in the previous one in the previous way to get",
    "start": "1197179",
    "end": "1204080"
  },
  {
    "text": "the configuration most of those operations actually are part of the functionality of adfs so technically you",
    "start": "1204080",
    "end": "1211580"
  },
  {
    "text": "can blend in you cannot block that right if you compromise the idfs service account you simply can operate as if it",
    "start": "1211580",
    "end": "1219260"
  },
  {
    "text": "was regular businesses but in here if you do not have other abfs servers that",
    "start": "1219260",
    "end": "1225020"
  },
  {
    "text": "are communicating with your avfs primary server to do a synchronization job then",
    "start": "1225020",
    "end": "1232340"
  },
  {
    "text": "there is something you can do right network connection very simple this is",
    "start": "1232340",
    "end": "1237620"
  },
  {
    "start": "1234000",
    "end": "1672000"
  },
  {
    "text": "just one example and here with this one and other similar Telemetry you get user",
    "start": "1237620",
    "end": "1242780"
  },
  {
    "text": "context once again process context source and Target but not enough until",
    "start": "1242780",
    "end": "1247820"
  },
  {
    "text": "like why am I why is this connection even even happening 5156 from security auditing something",
    "start": "1247820",
    "end": "1254360"
  },
  {
    "text": "you can use as well you miss the user context but in this scenario it doesn't matter because this connection is",
    "start": "1254360",
    "end": "1260960"
  },
  {
    "text": "handled by system so we're not expecting a different user right and here's when",
    "start": "1260960",
    "end": "1266960"
  },
  {
    "text": "we start getting into adfs logs this log is actually a lock that can be consumed",
    "start": "1266960",
    "end": "1272900"
  },
  {
    "text": "you can actually see it through abfs tracing but this is something that will also be populated in your security event",
    "start": "1272900",
    "end": "1279559"
  },
  {
    "text": "log the link at the bottom is going to be a link that will show you how to actually enable all of this and in here",
    "start": "1279559",
    "end": "1286039"
  },
  {
    "text": "we're actually getting information about the the service model which is going to",
    "start": "1286039",
    "end": "1291080"
  },
  {
    "text": "be part of the WCF actually context so you can see that there is some authentication happening in here in",
    "start": "1291080",
    "end": "1298159"
  },
  {
    "text": "regards of the WCF service 501 is something that you can actually",
    "start": "1298159",
    "end": "1303679"
  },
  {
    "text": "correlate with a previous one so that you can then understand who the caller was that performed this operation right",
    "start": "1303679",
    "end": "1311000"
  },
  {
    "text": "and the reason why this is important is because you you might have a thread actor that might have modified maybe the",
    "start": "1311000",
    "end": "1316820"
  },
  {
    "text": "rules on the adfs database to be able to access it with a different account to maintain persistence so then you can",
    "start": "1316820",
    "end": "1323240"
  },
  {
    "text": "start tracking that type of activity and for 624 it's something that will",
    "start": "1323240",
    "end": "1328340"
  },
  {
    "text": "have to trigger because in order to interact with this service you need to authenticate",
    "start": "1328340",
    "end": "1334340"
  },
  {
    "text": "and this one was very interesting because I did not understand why in my logs I had something such as company SVC",
    "start": "1334340",
    "end": "1341299"
  },
  {
    "text": "adfs when that was not the account that I used to set up my abfs servers and I",
    "start": "1341299",
    "end": "1348320"
  },
  {
    "text": "didn't know what it was to be honest and I was just trying to read as many documents as possible and then and that",
    "start": "1348320",
    "end": "1354200"
  },
  {
    "text": "was something that actually came from the stories uh tool yeah actually that",
    "start": "1354200",
    "end": "1359960"
  },
  {
    "text": "is hard coded in ad internal so if you are using that tool it's always that same name I just wanted to make it easy",
    "start": "1359960",
    "end": "1365600"
  },
  {
    "text": "for you guys too exactly so yeah but they make it hard because I had to read like four hours and figure out what's",
    "start": "1365600",
    "end": "1371900"
  },
  {
    "text": "going on but um so in here this is a plain signature you can actually see",
    "start": "1371900",
    "end": "1377539"
  },
  {
    "text": "that these 4624 event was a network connection network login session but it",
    "start": "1377539",
    "end": "1383120"
  },
  {
    "text": "doesn't have a source like we don't know where this actually came from and if you go to a the internal source code if you",
    "start": "1383120",
    "end": "1390140"
  },
  {
    "text": "get to the section where you can test how WCF is actually use the story",
    "start": "1390140",
    "end": "1396140"
  },
  {
    "text": "creates its own ticket its own TGT and all he uses is a hash of the account and",
    "start": "1396140",
    "end": "1403880"
  },
  {
    "text": "then he simply starts creating his own ticket and then he passes that to the service in order to communicate so",
    "start": "1403880",
    "end": "1410720"
  },
  {
    "text": "that's why we do have that specific event so if you go back to your company or right now and you check for 624s for",
    "start": "1410720",
    "end": "1417020"
  },
  {
    "text": "that name I would I would be a little uh concerned right probably he was doing",
    "start": "1417020",
    "end": "1422900"
  },
  {
    "text": "consulting or somebody's using his tool now this is very interesting that I did",
    "start": "1422900",
    "end": "1428840"
  },
  {
    "text": "not know that existed to be honest because I skipped probably probably the documentation but there is actually a",
    "start": "1428840",
    "end": "1435020"
  },
  {
    "text": "way to enable additional WCF or services that are built with that framework in",
    "start": "1435020",
    "end": "1442340"
  },
  {
    "text": "ibfs you have to find this configuration which is usually on the root of adfs",
    "start": "1442340",
    "end": "1448640"
  },
  {
    "text": "which would be by default see Windows adfs directory once you find this",
    "start": "1448640",
    "end": "1453919"
  },
  {
    "text": "configuration there is a section that allows you to modify it so that you can then enable additional telemetry",
    "start": "1453919",
    "end": "1462320"
  },
  {
    "text": "in this Telemetry you can start either interacting with that through the abfs tracing debug analytic views in in",
    "start": "1462320",
    "end": "1469840"
  },
  {
    "text": "Windows Event Viewer or you can actually use logman to create a a",
    "start": "1469840",
    "end": "1476000"
  },
  {
    "text": "etw trace and then you can analyze it on the site offline right and as you can see when I did that then all these",
    "start": "1476000",
    "end": "1482480"
  },
  {
    "text": "events started populating that were not populating when I started testing the capabilities of the service to access",
    "start": "1482480",
    "end": "1490220"
  },
  {
    "text": "and synchronize information from adfs this is one of the first events that",
    "start": "1490220",
    "end": "1496039"
  },
  {
    "text": "that triggered 121 gives you information about the connection this is the first time that you see a network connection",
    "start": "1496039",
    "end": "1503380"
  },
  {
    "text": "mapped to the service that allows the synchronization when you are looking at",
    "start": "1503380",
    "end": "1508940"
  },
  {
    "text": "system before there is not additional context that will tell you this is exactly what happened this will tell you",
    "start": "1508940",
    "end": "1515659"
  },
  {
    "text": "that this actually happened right so it's something that could be consumed it's something that you can also explore",
    "start": "1515659",
    "end": "1521720"
  },
  {
    "text": "other events like 998 would start giving you information about the URL used to",
    "start": "1521720",
    "end": "1529039"
  },
  {
    "text": "communicate with the service you also have more 121s but they start",
    "start": "1529039",
    "end": "1534440"
  },
  {
    "text": "giving you more context such as for example there was a message that was received and there is also information",
    "start": "1534440",
    "end": "1540799"
  },
  {
    "text": "about for example the user agent that was used to perform this type of",
    "start": "1540799",
    "end": "1546500"
  },
  {
    "text": "communication something that I had not seen in other event log and since we",
    "start": "1546500",
    "end": "1551720"
  },
  {
    "text": "were using AED internals which is used with Powershell you can find user agent Powershell information in the logs as",
    "start": "1551720",
    "end": "1558140"
  },
  {
    "text": "well so something really cool to dive into and see what's going on right",
    "start": "1558140",
    "end": "1563720"
  },
  {
    "text": "then you start getting into understanding the negotiation process when you start interacting with avfs so",
    "start": "1563720",
    "end": "1571159"
  },
  {
    "text": "this is just more information telling you how this is actually happening all the bay all the way to telling you that",
    "start": "1571159",
    "end": "1577159"
  },
  {
    "text": "this completed and then you can start seeing for example that there is a message now being sent back to the user",
    "start": "1577159",
    "end": "1584659"
  },
  {
    "text": "so this is definitely a lot of good information there is even more events I didn't go through all of them but these",
    "start": "1584659",
    "end": "1591020"
  },
  {
    "text": "are kind of like the the main ones especially the ones that really tell you that the network connection actually was",
    "start": "1591020",
    "end": "1596840"
  },
  {
    "text": "performed for that specific service so the technique can be directly be mapped",
    "start": "1596840",
    "end": "1604340"
  },
  {
    "text": "to the first 121 event for example then it's also good to turn that on just",
    "start": "1604340",
    "end": "1609559"
  },
  {
    "text": "for you know getting the forensic data exactly exactly so from a mitigation's perspective you can then for example use",
    "start": "1609559",
    "end": "1616820"
  },
  {
    "text": "these two commands one could be to modify a a current maybe a rule that you",
    "start": "1616820",
    "end": "1622520"
  },
  {
    "text": "have to restrict access to this port or you can create a rule if it's not",
    "start": "1622520",
    "end": "1627919"
  },
  {
    "text": "created and you only point to your adfs servers and also your proxies right I think that you were mentioned in the",
    "start": "1627919",
    "end": "1633380"
  },
  {
    "text": "adfs proxies should also be part of this uh rule and that concludes that one piece on the",
    "start": "1633380",
    "end": "1641360"
  },
  {
    "text": "top right and just to go quick on this part we were actually going through a",
    "start": "1641360",
    "end": "1647059"
  },
  {
    "text": "couple of different variations different operations executed depending on the way",
    "start": "1647059",
    "end": "1652520"
  },
  {
    "text": "how we wanted to for example get the configuration and then we can actually",
    "start": "1652520",
    "end": "1657740"
  },
  {
    "text": "start mapping multiple data sources that would tell you that something is actually happening in this um you know",
    "start": "1657740",
    "end": "1664520"
  },
  {
    "text": "specific flow of operations and then how are you going to start blocking one specific path for example",
    "start": "1664520",
    "end": "1671840"
  },
  {
    "text": "okay so now we covered how to get the the different ways how you can get the",
    "start": "1671840",
    "end": "1676940"
  },
  {
    "start": "1672000",
    "end": "1939000"
  },
  {
    "text": "configuration which contains the encrypted tokens on a certificate and",
    "start": "1676940",
    "end": "1682700"
  },
  {
    "text": "now we go into the key part so how can we get the key and the first one is again the dot net reflection so you need",
    "start": "1682700",
    "end": "1688520"
  },
  {
    "text": "to compromise ads server and then run it there and here you just instantiate the",
    "start": "1688520",
    "end": "1693940"
  },
  {
    "text": "certain dotnet object and then again call the uh hidden private parameters",
    "start": "1693940",
    "end": "1700340"
  },
  {
    "text": "and sorry properties and and methods and you basically ask that adfs that hey",
    "start": "1700340",
    "end": "1705559"
  },
  {
    "text": "could you give me the key please and then adfs goes there and picks that up",
    "start": "1705559",
    "end": "1711020"
  },
  {
    "text": "so it is the totally same thing that adfs when it starts up it gets the key",
    "start": "1711020",
    "end": "1716720"
  },
  {
    "text": "so the network traffic is all the same and all the you know access to objects on ads same so I bet you really can't",
    "start": "1716720",
    "end": "1723980"
  },
  {
    "text": "find this out so this is going to be tricky but uh it kind of follows a similar pattern as the",
    "start": "1723980",
    "end": "1730820"
  },
  {
    "text": "previous.net reflection and there is a lot of that net happening in here so that could also be a way if you're if",
    "start": "1730820",
    "end": "1737779"
  },
  {
    "text": "you are actually collecting multiple operations like getting methods Fields",
    "start": "1737779",
    "end": "1743059"
  },
  {
    "text": "properties that are private that's that's what this all takes like a lot of iterations so this is probably the graph",
    "start": "1743059",
    "end": "1750140"
  },
  {
    "text": "that you were expecting so this kind of walks you through all the flow step by step and because of the time we can go",
    "start": "1750140",
    "end": "1756080"
  },
  {
    "text": "through all that but the idea is to go all the way from an adfs configuration setting as a.net object and then utilize",
    "start": "1756080",
    "end": "1764120"
  },
  {
    "text": "existing dlls that would expose specific like assemblies and classes that you can",
    "start": "1764120",
    "end": "1770059"
  },
  {
    "text": "then use to iterate to private Fields private properties to get to a private",
    "start": "1770059",
    "end": "1775520"
  },
  {
    "text": "method that would allow you to enumerate keys in the adfs server and that key is",
    "start": "1775520",
    "end": "1781580"
  },
  {
    "text": "the idfs dkm key right now the interesting part once again you can use",
    "start": "1781580",
    "end": "1786679"
  },
  {
    "text": "right for example Powershell Ramsey logs to capture all this there are different evrs or xdr Solutions already capturing",
    "start": "1786679",
    "end": "1794299"
  },
  {
    "text": "some of this information for example so they can actually do something about that net reflection it's really tricky",
    "start": "1794299",
    "end": "1800559"
  },
  {
    "text": "and in this case as I mentioned before if if you are executing this attack step",
    "start": "1800559",
    "end": "1806480"
  },
  {
    "text": "by step which could actually be done interactively instead of doing a full script you can actually run each command",
    "start": "1806480",
    "end": "1812659"
  },
  {
    "text": "if you have a session and then this would actually be start triggering a lot of different the default 4104 events and",
    "start": "1812659",
    "end": "1820820"
  },
  {
    "text": "that's because once again it has all these suspicious um you know strings that are being",
    "start": "1820820",
    "end": "1826580"
  },
  {
    "text": "executed just to get to the uh private like non-public method that will give",
    "start": "1826580",
    "end": "1831679"
  },
  {
    "text": "you the keys and as I mentioned before you can use something like that script that would",
    "start": "1831679",
    "end": "1837500"
  },
  {
    "text": "allow you to go through and find all these strings that were executed right now the interesting part besides the",
    "start": "1837500",
    "end": "1843860"
  },
  {
    "text": "dotnet reflection piece because that's just that net that you have to find through some Telemetry is that actually",
    "start": "1843860",
    "end": "1851179"
  },
  {
    "text": "there is there is always unintended consequences when a red teamer or threat",
    "start": "1851179",
    "end": "1856820"
  },
  {
    "text": "actor or offensive security researcher in general right when they do something on a box there will be things that they",
    "start": "1856820",
    "end": "1863840"
  },
  {
    "text": "expect that happen and that they have control over but there are three things that they don't don't have control over",
    "start": "1863840",
    "end": "1870140"
  },
  {
    "text": "one of the things that they don't have control over is that when they start executing these steps where they invoke",
    "start": "1870140",
    "end": "1876440"
  },
  {
    "text": "the enumeration of keys then they start actually making a lot of ldap connections because they're actually",
    "start": "1876440",
    "end": "1882020"
  },
  {
    "text": "going to the domain controller retrieving the key and then giving it to you but locally it looks like you're",
    "start": "1882020",
    "end": "1887840"
  },
  {
    "text": "interacting with simply.net objects locally but there is going to be connections that are going to happen",
    "start": "1887840",
    "end": "1893480"
  },
  {
    "text": "right so that's an unintended consequence and you can actually start tracking this by using this event",
    "start": "1893480",
    "end": "1900679"
  },
  {
    "text": "provider with log n and you will be able to get to this specific ldap query that",
    "start": "1900679",
    "end": "1907580"
  },
  {
    "text": "by default adfs service under the hood is actually executing so for those that",
    "start": "1907580",
    "end": "1912860"
  },
  {
    "text": "maybe want to replicate that and look similar then that's the query that happens when that regulation is used in",
    "start": "1912860",
    "end": "1919580"
  },
  {
    "text": "in this scenario and that's just uh proves it that the query that is being executed is actually",
    "start": "1919580",
    "end": "1925580"
  },
  {
    "text": "trying to get to that object in in active directory and that's the abfs dkm",
    "start": "1925580",
    "end": "1930919"
  },
  {
    "text": "uh container that has an ad object that contains information about the ABF sdkm",
    "start": "1930919",
    "end": "1937399"
  },
  {
    "text": "key yep okay thank you so we actually tried to squeeze 60",
    "start": "1937399",
    "end": "1942740"
  },
  {
    "start": "1939000",
    "end": "2079000"
  },
  {
    "text": "Minutes presentations 40 minutes we need to keep it up a bit okay but anyways then the remote method so actually you",
    "start": "1942740",
    "end": "1950840"
  },
  {
    "text": "can remotely access also 80 and and ask find that container Roberto mentioned",
    "start": "1950840",
    "end": "1956899"
  },
  {
    "text": "and then find that contact object actually it's a lot of contact and then there's a one certain property that",
    "start": "1956899",
    "end": "1963799"
  },
  {
    "text": "contains the key so that was actually also the part of the original PDF stump tool so they access the",
    "start": "1963799",
    "end": "1970940"
  },
  {
    "text": "configuration database and then they you know query the ID and of course you can",
    "start": "1970940",
    "end": "1976279"
  },
  {
    "text": "do something at the yeah so just to go um quick on this one since we already covered with a previous example there is",
    "start": "1976279",
    "end": "1983179"
  },
  {
    "text": "going to be access to an object that is going to use ldap right queries where it's going to be authentication of users",
    "start": "1983179",
    "end": "1989659"
  },
  {
    "text": "against the domain controller and there is going to be data that will be",
    "start": "1989659",
    "end": "1994940"
  },
  {
    "text": "triggering the access attempts to those objects right and of course data for our",
    "start": "1994940",
    "end": "2001059"
  },
  {
    "text": "user authentication as well and you can use either etw tracing which a lot of EDR Solutions will use on the client",
    "start": "2001059",
    "end": "2008019"
  },
  {
    "text": "side and they would also uh client and server and then also some Network",
    "start": "2008019",
    "end": "2013120"
  },
  {
    "text": "packets if you're using some type of network you know data source you can actually uh you can actually",
    "start": "2013120",
    "end": "2020140"
  },
  {
    "text": "enable Telemetry by adding in a entry to the cycle of the ad object that contains",
    "start": "2020140",
    "end": "2028539"
  },
  {
    "text": "this key right so you can actually do it by adding the for example who's reading",
    "start": "2028539",
    "end": "2034120"
  },
  {
    "text": "or who is listing this property 4662 is the event that will trigger telling you that this actually was",
    "start": "2034120",
    "end": "2040899"
  },
  {
    "text": "accessed and there is going to be a property that is going to map directly to the thumbnail photo attribute of the",
    "start": "2040899",
    "end": "2048878"
  },
  {
    "text": "object which is where the key is going to be stored right and then you can actually correlate this with",
    "start": "2048879",
    "end": "2054878"
  },
  {
    "text": "authentication locks and you'll be able to know exactly where the client is if this is coming from an adfs server you",
    "start": "2054879",
    "end": "2061898"
  },
  {
    "text": "will see the adfs server IP if not you will see another um",
    "start": "2061899",
    "end": "2067240"
  },
  {
    "text": "your computer and then as mentioned before you can enable the ldap etw",
    "start": "2067240",
    "end": "2072339"
  },
  {
    "text": "tracing to start collecting some of that information and then this is one example of that ldap search query",
    "start": "2072339",
    "end": "2080138"
  },
  {
    "text": "okay and then the last one of this path attack part to",
    "start": "2080139",
    "end": "2086138"
  },
  {
    "text": "get the key so because that's stored in ad then you can access the 80 also using",
    "start": "2086139",
    "end": "2092800"
  },
  {
    "text": "a thing called DC think which is a protocol that domain controllers are using to synchronize data from from",
    "start": "2092800",
    "end": "2098440"
  },
  {
    "text": "other domain controllers and that requires that you have some permissions to do",
    "start": "2098440",
    "end": "2104140"
  },
  {
    "text": "that so of course the ADF is uh but service account is a good one and another one is that if you can",
    "start": "2104140",
    "end": "2109839"
  },
  {
    "text": "compromise Azure ID connect server you can use that account that it is using to",
    "start": "2109839",
    "end": "2115240"
  },
  {
    "text": "you know synchronous data from from on-premity to Azure ID",
    "start": "2115240",
    "end": "2121900"
  },
  {
    "text": "but that's a normal traffic right so you can't do anything right I mean if this if this of course happens",
    "start": "2121900",
    "end": "2128920"
  },
  {
    "text": "um from different domain from a non-domain controller host then that would be kind of easy to detect uh if it",
    "start": "2128920",
    "end": "2136119"
  },
  {
    "text": "happens directly from a domain controller good luck there is not much Telemetry out there but the idea is that",
    "start": "2136119",
    "end": "2142300"
  },
  {
    "text": "we want to access the object in an indirect way so there is not a cycle",
    "start": "2142300",
    "end": "2149020"
  },
  {
    "text": "that will help you here because there is not a direct access to the ad object and",
    "start": "2149020",
    "end": "2154300"
  },
  {
    "text": "we're gonna of course start linking this information with uh you know login information and let's go directly to the",
    "start": "2154300",
    "end": "2161980"
  },
  {
    "text": "events oh and there is actually mitigation so there is now it is becoming a thing to be able to do RPC uh",
    "start": "2161980",
    "end": "2169720"
  },
  {
    "text": "filtering and there are some solutions out there that are accomplishing this on your domain controller so that you can",
    "start": "2169720",
    "end": "2175060"
  },
  {
    "text": "uh so so that you can actually start restricting who can access your domain",
    "start": "2175060",
    "end": "2181359"
  },
  {
    "text": "controller using the director replication Services remote protocol so is it kind of a pliable for RPC I think",
    "start": "2181359",
    "end": "2188980"
  },
  {
    "text": "it is yeah it is viable it it definitely works I've seen some some companies using the the one that I'm about to",
    "start": "2188980",
    "end": "2194560"
  },
  {
    "text": "share 4662 will show you not an access directly to the object the key but",
    "start": "2194560",
    "end": "2201040"
  },
  {
    "text": "actually the interaction to access the um the what's called The Domain DNS class",
    "start": "2201040",
    "end": "2208060"
  },
  {
    "text": "object and if it uses an extender right that is related to synchronizing",
    "start": "2208060",
    "end": "2213700"
  },
  {
    "text": "information from the domain controller there is when you can start saying that this could be a suspicious DCC potential",
    "start": "2213700",
    "end": "2221020"
  },
  {
    "text": "attack and you can actually correlate this with authentication events so you understand",
    "start": "2221020",
    "end": "2226180"
  },
  {
    "text": "where this is actually coming from and as I mentioned before there is actually RPC filtering that you can um",
    "start": "2226180",
    "end": "2233079"
  },
  {
    "text": "use in order to restrict who can actually use this RPC protocol or",
    "start": "2233079",
    "end": "2238839"
  },
  {
    "text": "interface um with the domain controller so really good projects J security Johnny Johnson",
    "start": "2238839",
    "end": "2244599"
  },
  {
    "text": "from Specter Ops actually has some really cool cool you know ideas in his",
    "start": "2244599",
    "end": "2250000"
  },
  {
    "text": "Repository and that would just take us to the last I would say part which this is what",
    "start": "2250000",
    "end": "2257020"
  },
  {
    "text": "explains some of the variations of getting the abfs key and some of the",
    "start": "2257020",
    "end": "2262599"
  },
  {
    "text": "data that is available to explore this and some of them to potentially build detections and also mitigate and this is",
    "start": "2262599",
    "end": "2269079"
  },
  {
    "text": "important because you need to understand at what layer you are mitigating this and as you can see it is at one attack",
    "start": "2269079",
    "end": "2275440"
  },
  {
    "text": "path but you cannot just mitigate the whole thing so that's what is important to build these graphs as well",
    "start": "2275440",
    "end": "2282700"
  },
  {
    "start": "2282000",
    "end": "2527000"
  },
  {
    "text": "yeah and actually now that we have those two ingredients we have the configuration database which has the",
    "start": "2282700",
    "end": "2287980"
  },
  {
    "text": "encrypted certificate and then we have the key we can decrypt that and just to speed up uh you can detect that of",
    "start": "2287980",
    "end": "2295000"
  },
  {
    "text": "course because that was fast because that's like a you know make offline so uh let's try to speed up a",
    "start": "2295000",
    "end": "2303520"
  },
  {
    "text": "bit so actually you can mitigate all these problems uh we have showed you by using the custom certificates because",
    "start": "2303520",
    "end": "2309820"
  },
  {
    "text": "they are stored in your computer so you can access the configuration database and so on and we have two options so if",
    "start": "2309820",
    "end": "2316480"
  },
  {
    "text": "that's if the the key private key is not marked as well sorry if that is marked",
    "start": "2316480",
    "end": "2322900"
  },
  {
    "text": "as exportable you can just go to MMC and Export that if not then you need to use some tools like a internals or mimikats",
    "start": "2322900",
    "end": "2331000"
  },
  {
    "text": "or whatever you like to use and for that the well it's a bit noisy I would say",
    "start": "2331000",
    "end": "2337900"
  },
  {
    "text": "because it's using um it's using a DP API or as we call it depopy the puppy yeah",
    "start": "2337900",
    "end": "2346599"
  },
  {
    "text": "so if you have a local system access a local admin access system you can be the",
    "start": "2346599",
    "end": "2352720"
  },
  {
    "text": "system and then you can do the encryption by yourselves right so that's kind of a",
    "start": "2352720",
    "end": "2359500"
  },
  {
    "text": "yeah so the idea here would be a couple of slides to understand that you can actually mitigate this by executing the",
    "start": "2359500",
    "end": "2366040"
  },
  {
    "text": "think at the bottom and you can mitigate the thing at the bottom by using things such as HSM when you're actually using a",
    "start": "2366040",
    "end": "2373900"
  },
  {
    "text": "custom certificate so there are ways to actually do this type of um you know preventions and just as an",
    "start": "2373900",
    "end": "2380140"
  },
  {
    "text": "additional I would say information there is actually solutions that would provide detections across some of this from mde",
    "start": "2380140",
    "end": "2387460"
  },
  {
    "text": "and MDI just think about the mde covers client side things an MDI Defender for",
    "start": "2387460",
    "end": "2392980"
  },
  {
    "text": "identity will cover things at the server side so that's that's something that we have worked together for a couple years",
    "start": "2392980",
    "end": "2398619"
  },
  {
    "text": "uh two years already to try to create detections around this and of course uh just remember that this",
    "start": "2398619",
    "end": "2405820"
  },
  {
    "text": "is just part of an attack sequence this is not the whole sequence right so there are different opportunities and if they",
    "start": "2405820",
    "end": "2412119"
  },
  {
    "text": "succeed at this they can get a token right they can get a sample token you",
    "start": "2412119",
    "end": "2417339"
  },
  {
    "text": "can actually enable MFA right people might say enable MFA but they can actually add MFA to their token but then",
    "start": "2417339",
    "end": "2424000"
  },
  {
    "text": "there is other things that you can do such as for example rejecting the MFA",
    "start": "2424000",
    "end": "2429099"
  },
  {
    "text": "claim that came from the the IDP and that that's something that Azure ID is",
    "start": "2429099",
    "end": "2434740"
  },
  {
    "text": "providing so something that you can read about and will block The Next Step yeah so that this is a slightly slide",
    "start": "2434740",
    "end": "2442000"
  },
  {
    "text": "actually so how to mitigate so first of all create all adfs servers as a ts0 so you need to protect them as well as you",
    "start": "2442000",
    "end": "2447820"
  },
  {
    "text": "protect your automate controllers second configure that setting that uh Roberto mentioned that you rechecked all the MFA",
    "start": "2447820",
    "end": "2455200"
  },
  {
    "text": "claims coming from uh private identity providers and if you are using adfs managed",
    "start": "2455200",
    "end": "2460599"
  },
  {
    "text": "certificates you need to block that Port 80 and also read SQL Server if you are",
    "start": "2460599",
    "end": "2465700"
  },
  {
    "text": "using that as a tier zero and if you are using custom certificates block it already again and then use HSM",
    "start": "2465700",
    "end": "2474040"
  },
  {
    "text": "or Hardware security model and that's actually the safest way to do that so please do that yes yes so there's a",
    "start": "2474040",
    "end": "2480579"
  },
  {
    "text": "little bit better of management but yeah and then",
    "start": "2480579",
    "end": "2486339"
  },
  {
    "text": "takeaways so there's going to be a link to GitHub page where the satellites and",
    "start": "2486339",
    "end": "2491920"
  },
  {
    "text": "all the other material are and we have links for tools like Aid internals and 80 at the stump there's no link for",
    "start": "2491920",
    "end": "2498579"
  },
  {
    "text": "mimic ads because if you can't find it you are on the wrong business [Laughter] sounds good hey thank you very much",
    "start": "2498579",
    "end": "2505540"
  },
  {
    "text": "everyone appreciate it thank you I guess",
    "start": "2505540",
    "end": "2510820"
  },
  {
    "text": "because we have no time for questions but you can you know ask ask for much",
    "start": "2510820",
    "end": "2516700"
  },
  {
    "text": "cool foreign",
    "start": "2516700",
    "end": "2522299"
  },
  {
    "text": "[Music]",
    "start": "2526110",
    "end": "2529199"
  }
]