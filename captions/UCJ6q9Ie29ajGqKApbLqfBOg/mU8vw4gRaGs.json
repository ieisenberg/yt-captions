[
  {
    "start": "0",
    "end": "280000"
  },
  {
    "text": "you are in room Lagoon K and you are here to see make sure I get it right",
    "start": "80",
    "end": "5759"
  },
  {
    "text": "here Paul Stone and Alex Chapman and their talk W suspect compromising the windows Enterprise via Windows update I",
    "start": "5759",
    "end": "12360"
  },
  {
    "text": "turn it over to you gentlemen thank you hello can uh can everyone hear me",
    "start": "12360",
    "end": "17560"
  },
  {
    "text": "all right yep good good okay I'll make a start then so we're going to be talking about",
    "start": "17560",
    "end": "24000"
  },
  {
    "text": "Windows update and the the kind of focus of that of our talk is Windows update in kind of an Enterprise scenario so just a",
    "start": "24000",
    "end": "30279"
  },
  {
    "text": "kind of brief overview of what we're going to be looking at uh so first of all we're gonna just talk bit about why",
    "start": "30279",
    "end": "36200"
  },
  {
    "text": "we decided to look at Windows update um we're going to explore some of the attack surface of Windows update um the",
    "start": "36200",
    "end": "41879"
  },
  {
    "text": "things we might be able to do with it um then we're going to talk about drivers um look at which what drives are",
    "start": "41879",
    "end": "48000"
  },
  {
    "text": "available via Windows update and then we're going to move on to to wus which is um the kind of the Enterprise variant",
    "start": "48000",
    "end": "53520"
  },
  {
    "text": "of of Windows update so we're going to uh delve into wsas U I'm going to talk a bit about how to compromise it in",
    "start": "53520",
    "end": "58920"
  },
  {
    "text": "certain situations and because we like to be responsible we're going to tell you how to fix those problems as",
    "start": "58920",
    "end": "65879"
  },
  {
    "text": "well so brief introductions well I guess we've already been introduced but uh I'm Paul this is Alex uh we both are",
    "start": "66799",
    "end": "72560"
  },
  {
    "text": "researchers uh we work for context information security we're based in the",
    "start": "72560",
    "end": "77840"
  },
  {
    "text": "UK so first question why I look at when this update well one one question we had",
    "start": "78159",
    "end": "84040"
  },
  {
    "text": "which apparently lots of people share the same question is why is it so damn slow um but more seriously um from a",
    "start": "84040",
    "end": "90119"
  },
  {
    "text": "security perspective why are we looking at Windows update well one of the interesting things about Windows update is it's a",
    "start": "90119",
    "end": "95960"
  },
  {
    "text": "very privileged service so updates um can be downloaded and installed by normal users by non-privileged users um",
    "start": "95960",
    "end": "103280"
  },
  {
    "text": "so there's potential there potential for elevation of privilege",
    "start": "103280",
    "end": "108360"
  },
  {
    "text": "vulnerabilities the other thing about Windows update is it both increases and decreases the windows ATT Tax Service so",
    "start": "108360",
    "end": "115040"
  },
  {
    "text": "uh in the sense that it's um it downloads and runs codes over the Internet which can be a dangerous thing",
    "start": "115040",
    "end": "120759"
  },
  {
    "text": "to do if it's not done properly um and obviously U you know it's it's a necessary thing so you know every",
    "start": "120759",
    "end": "126439"
  },
  {
    "text": "software all software needs patching um and Windows update lets um you know Windows patch itself against",
    "start": "126439",
    "end": "132720"
  },
  {
    "text": "vulnerabilities and and other bugs and so on and the other interesting thing about",
    "start": "132720",
    "end": "138000"
  },
  {
    "text": "Windows update um the thing which um kind of really P Pi our interests to start with is that not only is there",
    "start": "138000",
    "end": "144480"
  },
  {
    "text": "Microsoft code available by Windows update but there was also a lot of third party code um notably in drivers",
    "start": "144480",
    "end": "150800"
  },
  {
    "text": "um so with with drivers we're talking about um you know code running in the kernel um and other privileged um stuff",
    "start": "150800",
    "end": "158599"
  },
  {
    "text": "going on so these are good reasons to to look at Windows update and and finally",
    "start": "158599",
    "end": "163879"
  },
  {
    "text": "um it seems that very few people have actually looked at Windows update in the past we couldn't find that much uh kind of research on it out there so um we",
    "start": "163879",
    "end": "170720"
  },
  {
    "text": "thought we would have a look okay so just a kind of brief",
    "start": "170720",
    "end": "176120"
  },
  {
    "text": "overview of the various different components uh of Windows update so windows up update is Windows service um that runs there's an",
    "start": "176120",
    "end": "183560"
  },
  {
    "text": "executable called WT I have no idea what it stands for um",
    "start": "183560",
    "end": "189000"
  },
  {
    "text": "but that's a thing that runs periodically and actually checks for updates uh contacts Microsoft servers to see see if there's anything downloads",
    "start": "189000",
    "end": "195080"
  },
  {
    "text": "updates and so on um there's a whole bunch of registry keys um which control things like how often updates um checked",
    "start": "195080",
    "end": "201640"
  },
  {
    "text": "for when they get applied um which what Serv to talk to and so",
    "start": "201640",
    "end": "207120"
  },
  {
    "text": "on um and the actual protocol itself the actual um the way that the your computer talks to to Microsoft servers so that's",
    "start": "207120",
    "end": "214120"
  },
  {
    "text": "actually a soap web service um that goes over https um and we're going to take a look",
    "start": "214120",
    "end": "219720"
  },
  {
    "text": "at that in detail later on um there's a there's a local database um that's that keeps track of what what updates you've",
    "start": "219720",
    "end": "226280"
  },
  {
    "text": "installed uh and so on um and there's this uh C Windows software distribution",
    "start": "226280",
    "end": "233079"
  },
  {
    "text": "that's where a lot of the stuff happens so updates get downloaded and extracted there and so on um and also um if you're",
    "start": "233079",
    "end": "239400"
  },
  {
    "text": "kind of looking into this area doing the research in this area the the windows update. log that's really useful because",
    "start": "239400",
    "end": "245079"
  },
  {
    "text": "that shows you what's going on in the background so these are the kind of things that we were looking at um at the",
    "start": "245079",
    "end": "251079"
  },
  {
    "text": "start so just briefly what what stuff is there on Windows update so obviously there are security updates there's",
    "start": "251959",
    "end": "257799"
  },
  {
    "text": "there's critical updates um and I guess less critical security updates um and there's a whole bunch of other stuff",
    "start": "257799",
    "end": "263600"
  },
  {
    "text": "there's General software updates things like you know updates to Internet Explorer and office and and so on um but",
    "start": "263600",
    "end": "270199"
  },
  {
    "text": "the thing that um kind of caught our eye early on is is drivers so I'm going to hand over to Alex to talk about",
    "start": "270199",
    "end": "277600"
  },
  {
    "text": "drivers thank you Paul so yeah as as Paul mentioned why",
    "start": "277600",
    "end": "284720"
  },
  {
    "start": "280000",
    "end": "305000"
  },
  {
    "text": "did Hardware drivers actually uh actually appeal to us so uh by default when a new device is plugged into a to a",
    "start": "284720",
    "end": "290600"
  },
  {
    "text": "Windows machine Windows update will actually go and download and install the the drivers and Associated software for",
    "start": "290600",
    "end": "296479"
  },
  {
    "text": "that but Hardware so um I don't know if uh some common ones like the Nvidia control panel and that sort of thing",
    "start": "296479",
    "end": "302400"
  },
  {
    "text": "actually come down as part of the Windows update so the hardware vendors submit",
    "start": "302400",
    "end": "309000"
  },
  {
    "start": "305000",
    "end": "354000"
  },
  {
    "text": "their code to be distributed by Microsoft um the drivers actually have",
    "start": "309000",
    "end": "314479"
  },
  {
    "text": "to be signed by Microsoft but actually um as Microsoft say in their uh signing",
    "start": "314479",
    "end": "320600"
  },
  {
    "text": "guidelines for isvs the code quality is actually the uh responsibility of the",
    "start": "320600",
    "end": "325639"
  },
  {
    "text": "vendor so whilst they do do some checks they don't actually um do rigorous",
    "start": "325639",
    "end": "330759"
  },
  {
    "text": "checking of the code submitted uh submitted to them and any code that is submitted to them will actually be",
    "start": "330759",
    "end": "336360"
  },
  {
    "text": "distributed bya Windows update so that's really interesting you've got third party vendors submitting actually very",
    "start": "336360",
    "end": "343680"
  },
  {
    "text": "highly privileged codes we're talking kernel drivers here running in the core of the operating system to Microsoft and",
    "start": "343680",
    "end": "348880"
  },
  {
    "text": "we're supposed to trust them and the quality of their code to keep our operating system",
    "start": "348880",
    "end": "354160"
  },
  {
    "text": "secure so I guess we've all seen it what actually happens when you plug in a no Hardware device so you plug it in the uh",
    "start": "354160",
    "end": "361240"
  },
  {
    "text": "the Plug and Play service will detect that a new device has been added to the system and adds it to the Windows device",
    "start": "361240",
    "end": "367400"
  },
  {
    "text": "tree um if the driver is recognized or the device is recognized and there's a driver available the driver will be",
    "start": "367400",
    "end": "373080"
  },
  {
    "text": "loaded and the device will communicate and and work as expected from there um",
    "start": "373080",
    "end": "378240"
  },
  {
    "text": "where the device isn't recognized uh the update service will send the entire device tree up to Windows update so",
    "start": "378240",
    "end": "384280"
  },
  {
    "text": "that's every single uh device that's installed on the system uh Windows uh",
    "start": "384280",
    "end": "389599"
  },
  {
    "text": "update then responds with a list of available packages and uh and downloads and drivers uh and then the update",
    "start": "389599",
    "end": "395800"
  },
  {
    "text": "service will will pick the most relevant download that and begin installation",
    "start": "395800",
    "end": "401840"
  },
  {
    "text": "um I guess as alluded to earlier so these these driver packages do include other things than just drivers so you'll",
    "start": "401840",
    "end": "408680"
  },
  {
    "text": "get um user applications support applications uh a number of Windows Services uh insulation Wizards uh and",
    "start": "408680",
    "end": "416319"
  },
  {
    "text": "and other such software along with your with your required kernel driver so these are the uh just quick overview",
    "start": "416319",
    "end": "422800"
  },
  {
    "start": "420000",
    "end": "515000"
  },
  {
    "text": "of the processes involved so the update service running in SVC host there as a high high highly privileged user uh that",
    "start": "422800",
    "end": "430199"
  },
  {
    "text": "then then hands off to Drivin doxe um to actually do the the full driver",
    "start": "430199",
    "end": "436280"
  },
  {
    "text": "installation so that will actually place the uh the kernel driver in in system",
    "start": "436280",
    "end": "441319"
  },
  {
    "text": "32 um we can see the the Run D and DL notify there that's running as the uh as",
    "start": "441319",
    "end": "446759"
  },
  {
    "text": "the current user so that's the uh user interface that pops up say windows is searching for a new new device driver",
    "start": "446759",
    "end": "453400"
  },
  {
    "text": "for this this bit of Hardware device is being installed etc etc um and then in this case there was an installation",
    "start": "453400",
    "end": "459280"
  },
  {
    "text": "wizard that came along with this uh with this driver installation and that's there again running as a low privilege user under rund 32 and new dev.",
    "start": "459280",
    "end": "469039"
  },
  {
    "text": "XE so that's kind of an overview of what happens when you plug in in the device",
    "start": "469039",
    "end": "474400"
  },
  {
    "text": "how do we actually go about researching this so Windows update has d for a large",
    "start": "474400",
    "end": "480319"
  },
  {
    "text": "number of types of devices so graphics cards bus controllers network cards all of these types of things will all",
    "start": "480319",
    "end": "486960"
  },
  {
    "text": "trigger a Windows update um search and download of the um affected drivers sorry the required drivers um but",
    "start": "486960",
    "end": "495479"
  },
  {
    "text": "installing these bits of Hardware is actually quite slow it's uh it's it's a",
    "start": "495479",
    "end": "501080"
  },
  {
    "text": "very difficult thing to do on a on a large scale basis so we wanted to choose something that that would be a bit",
    "start": "501080",
    "end": "506599"
  },
  {
    "text": "easier and cheaper primarily cheaper for us to do so we uh we we thought we'd",
    "start": "506599",
    "end": "511840"
  },
  {
    "text": "look at the subset of drivers USB device drivers so how do we go about finding",
    "start": "511840",
    "end": "516959"
  },
  {
    "start": "515000",
    "end": "552000"
  },
  {
    "text": "all the drivers on Windows update so the first thing we did we empty we emptied our drawers pulled out all the USB",
    "start": "516959",
    "end": "522240"
  },
  {
    "text": "devices we could find started plugging them in and actually monitoring what's happening uh my personal favorite there is the little Dogo I enjoy that one",
    "start": "522240",
    "end": "530720"
  },
  {
    "text": "um but we ran out of devices quite quickly and we only had the sort of devices you'd have around your normal",
    "start": "530720",
    "end": "536800"
  },
  {
    "text": "office from maybe the dog um so we were um set with a number of",
    "start": "536800",
    "end": "543000"
  },
  {
    "text": "options we could go and buy as many devices as we could find but there's no guarantee we obviously find all the",
    "start": "543000",
    "end": "548200"
  },
  {
    "text": "devices costs start racking up and uh we there's a slow turnaround so being",
    "start": "548200",
    "end": "554440"
  },
  {
    "start": "552000",
    "end": "588000"
  },
  {
    "text": "hackers what do we want to do we want to automate this in some way make it easier for ourselves so our first thought was",
    "start": "554440",
    "end": "560640"
  },
  {
    "text": "right brilliant we've been playing around with face dancers and biger Bones all this sort of thing we could use one of those to emulate USB device drivers",
    "start": "560640",
    "end": "569240"
  },
  {
    "text": "uh and and do things that way just Brute Force USB vendor IDs and product IDs and we'll be done in actually quite a long",
    "start": "569240",
    "end": "575959"
  },
  {
    "text": "time and also this doesn't parallelize well these these devices are quite expensive so getting an array of 10 of",
    "start": "575959",
    "end": "582760"
  },
  {
    "text": "them it's going to start racking up the costs and actually not not being all that",
    "start": "582760",
    "end": "588440"
  },
  {
    "start": "588000",
    "end": "618000"
  },
  {
    "text": "quick so it' be better much better if we could search Windows update uh there's no search interface inside windows the",
    "start": "588440",
    "end": "595040"
  },
  {
    "text": "operating system itself so the operating system can only check for uh updates that are apply to itself and its current",
    "start": "595040",
    "end": "601160"
  },
  {
    "text": "Hardware so bit of a bit of a bust there uh W Local database does have some",
    "start": "601160",
    "end": "608079"
  },
  {
    "text": "Hardware drivers um listed that aren't currently installed but by no means all of them so ideally what we want to do is",
    "start": "608079",
    "end": "615600"
  },
  {
    "text": "be able to actually search the uh the soap XML web interfaces um fortunately",
    "start": "615600",
    "end": "621800"
  },
  {
    "start": "618000",
    "end": "647000"
  },
  {
    "text": "Microsoft do provide uh a web page to do this so catalog. update. microsoft.com uh I don't know if anyone",
    "start": "621800",
    "end": "628920"
  },
  {
    "text": "remembers this this is back from the XP era uh and it actually you can see so",
    "start": "628920",
    "end": "634800"
  },
  {
    "text": "its requirements are ie6 or above and it actually requires the installation of an active X control we're talking that era",
    "start": "634800",
    "end": "641040"
  },
  {
    "text": "of the web uh but it does include all modern updates for um for all the modern oses so that's absolutely brilliant so",
    "start": "641040",
    "end": "648920"
  },
  {
    "start": "647000",
    "end": "693000"
  },
  {
    "text": "first stemps you you go to the uh the catalog with firef foxer and you're told you need to use I6 so we get our I6 out",
    "start": "648920",
    "end": "656480"
  },
  {
    "text": "we we connect we install the active X control like we told and we can then actually access the uh",
    "start": "656480",
    "end": "662959"
  },
  {
    "text": "the catalog interface and start searching for drivers so this is going to make our life a lot easier a lot quicker and a lot",
    "start": "662959",
    "end": "669279"
  },
  {
    "text": "cheaper um so in terms of USB device drivers we can actually search on the USB vendor ID and product ID which is",
    "start": "669279",
    "end": "676120"
  },
  {
    "text": "really useful or we can just go blanket search for the USB vendor ID so this allows us to find all device drivers for",
    "start": "676120",
    "end": "682760"
  },
  {
    "text": "a particular vendor um that are available on Windows update so that's kind of cut our work down from having a",
    "start": "682760",
    "end": "688760"
  },
  {
    "text": "Brute Force vendor IDs and product IDs to purely vendor IDs so we come up with a plan so we get",
    "start": "688760",
    "end": "697160"
  },
  {
    "start": "693000",
    "end": "783000"
  },
  {
    "text": "a list of vendor IDs so these are actually published individual vendors are assigned individual vendor IDs so we",
    "start": "697160",
    "end": "702839"
  },
  {
    "text": "we find one of the the public lists and we can use that we're then then going to scrape the windows catalog for all uh",
    "start": "702839",
    "end": "709480"
  },
  {
    "text": "USB products for each individual vendor going to make a database of the uh all the",
    "start": "709480",
    "end": "715200"
  },
  {
    "text": "drivers uh download them all install them all do do something and then profit",
    "start": "715200",
    "end": "721200"
  },
  {
    "text": "it's the way all plans all good plans start so we did this work back in April uh of this year we cre created this",
    "start": "721200",
    "end": "727920"
  },
  {
    "text": "database excuse",
    "start": "727920",
    "end": "731200"
  },
  {
    "text": "me so the results from the the initial database uh scrape so we identified",
    "start": "732959",
    "end": "739360"
  },
  {
    "text": "425 vendors that have updates on uh the U Windows update 25,124",
    "start": "739360",
    "end": "748639"
  },
  {
    "text": "uh that actually boils down to a much smaller number only 4,600 um unique downloads and download",
    "start": "750399",
    "end": "756480"
  },
  {
    "text": "hashes but still in there there's a lot of duplicates and obsolete driver versions and things like that so in the",
    "start": "756480",
    "end": "762839"
  },
  {
    "text": "end we Whittle it down to uh 2284 drivers for download so set the",
    "start": "762839",
    "end": "768440"
  },
  {
    "text": "downloads off going came up with about 5 GB worth of drivers for us to install fantastic uh and these ranged in size",
    "start": "768440",
    "end": "775639"
  },
  {
    "text": "from 100 150 megabytes down to just a few kilobytes each so huge variety",
    "start": "775639",
    "end": "782839"
  },
  {
    "text": "there um in this list as we'd expect there's a lot of standard devices so",
    "start": "782839",
    "end": "788079"
  },
  {
    "start": "783000",
    "end": "832000"
  },
  {
    "text": "printers memory cards ethernet devices etc etc etc uh lots of weird and wonderful sounding things so my favorite",
    "start": "788079",
    "end": "794920"
  },
  {
    "text": "there is the uh s micro Electronics Intel sensor solution blue box dfu got",
    "start": "794920",
    "end": "800639"
  },
  {
    "text": "no idea what that is but it sounds cool um display link adapter so that's something that allows you to um pipe VGA",
    "start": "800639",
    "end": "807959"
  },
  {
    "text": "over USB 2 so some actually quite interesting uh devices there a lot of",
    "start": "807959",
    "end": "813279"
  },
  {
    "text": "the the funky sounding devices actually just ended up um being USB to serial uh",
    "start": "813279",
    "end": "819279"
  },
  {
    "text": "drivers so a bit generic and less interesting uh and some of the the driver downloads actually just enabled",
    "start": "819279",
    "end": "826000"
  },
  {
    "text": "built-in drivers set a couple of registry keys and did nothing else so a bit of a variety",
    "start": "826000",
    "end": "832639"
  },
  {
    "start": "832000",
    "end": "872000"
  },
  {
    "text": "there so each of these downloads um is a Microsoft cab file so um",
    "start": "832639",
    "end": "839880"
  },
  {
    "text": "it's basically just Microsoft's archive format um which can be signed so all of them are signed uh they contain the the",
    "start": "839880",
    "end": "847920"
  },
  {
    "text": "in file which is the installation directives and supported um Hardware so",
    "start": "847920",
    "end": "853120"
  },
  {
    "text": "actually how it installs what what it then goes into stalls and then the files would expect so the kernel drivers Do's",
    "start": "853120",
    "end": "859639"
  },
  {
    "text": "X's help files uh we saw quite a lot of things developers seem to forgot to remove so a lot of um pdb symbol files",
    "start": "859639",
    "end": "867040"
  },
  {
    "text": "were included along with the drivers and and other files we wouldn't have expected",
    "start": "867040",
    "end": "872199"
  },
  {
    "text": "there so back to the plan we've got our um list of drivers we've downloaded the",
    "start": "872199",
    "end": "877680"
  },
  {
    "text": "ones we're interested in we then need to install all the drivers so I don't know about you I've",
    "start": "877680",
    "end": "884120"
  },
  {
    "text": "built quite a few Windows systems in my time installing drivers can take a very long time uh I didn't want to sit there",
    "start": "884120",
    "end": "890680"
  },
  {
    "text": "and do it manually with 2,284 drivers so we're hackers we want to find a way of",
    "start": "890680",
    "end": "896120"
  },
  {
    "text": "automating this so fortunately Microsoft very kindly provide um an application to do",
    "start": "896120",
    "end": "902639"
  },
  {
    "start": "897000",
    "end": "929000"
  },
  {
    "text": "this so the Devcon application so the Windows device console it's part of the driver development kit this requires a",
    "start": "902639",
    "end": "909279"
  },
  {
    "text": "high privilege user and I'll come back to that in a minute um but we can actually provide it with um an in file",
    "start": "909279",
    "end": "915279"
  },
  {
    "text": "and a cab file and a USB U device ID it will take that it will then go and install that for us on the local system",
    "start": "915279",
    "end": "922720"
  },
  {
    "text": "so an example there and then we get obviously the success or failure uh status of that installation",
    "start": "922720",
    "end": "929839"
  },
  {
    "start": "929000",
    "end": "971000"
  },
  {
    "text": "so we set this up virtual box VMS automating all from the command line we",
    "start": "929839",
    "end": "934880"
  },
  {
    "text": "bring up a VM snapshot we launch devcom via PSX uh we monitor the installation",
    "start": "934880",
    "end": "941360"
  },
  {
    "text": "so we take snapshots of the file system we run uh proon we perform the",
    "start": "941360",
    "end": "947279"
  },
  {
    "text": "installation record changes so um again changes to file system Services install",
    "start": "947279",
    "end": "953519"
  },
  {
    "text": "processes running uh other interesting things like that and we repeat this for",
    "start": "953519",
    "end": "959079"
  },
  {
    "text": "driver so this we've gone from our Hardware solution or initial idea done something that's actually highly",
    "start": "959079",
    "end": "964519"
  },
  {
    "text": "parallelizable and we can run it across as many virtual machines as we want to really speed this",
    "start": "964519",
    "end": "972040"
  },
  {
    "start": "971000",
    "end": "996000"
  },
  {
    "text": "up however it's not a perfect solution as I mentioned Devcon actually has to be run as a high privileged user so the",
    "start": "972040",
    "end": "979480"
  },
  {
    "text": "things we're trying to simulate here is actually low privileged user plugging in a physical USB device and we're kind of",
    "start": "979480",
    "end": "986079"
  },
  {
    "text": "70% of the way there with Devcon um but it's not quite what we want so we did",
    "start": "986079",
    "end": "991560"
  },
  {
    "text": "run it this way we collected some results but then tried to improve our our methodology and this is where we",
    "start": "991560",
    "end": "997920"
  },
  {
    "start": "996000",
    "end": "1036000"
  },
  {
    "text": "stumbled across the Windows device simulation framework so this is Again part of the driver development kit um",
    "start": "997920",
    "end": "1003759"
  },
  {
    "text": "but only in older versions so um the latest available version was in 7.1 it's since been discontinued uh in8 and and",
    "start": "1003759",
    "end": "1012199"
  },
  {
    "text": "above so this actually allows the simulation um sorry full software simulation of USB devices it sounds",
    "start": "1012199",
    "end": "1018480"
  },
  {
    "text": "perfect we want um documentation is a bit thin on the ground but it does come with some really useful com script",
    "start": "1018480",
    "end": "1025640"
  },
  {
    "text": "scriptable example devices so using um VBS we can actually create these devices",
    "start": "1025640",
    "end": "1031798"
  },
  {
    "text": "and simulate them enough for our needs so we acquire this and then then",
    "start": "1031799",
    "end": "1038918"
  },
  {
    "start": "1036000",
    "end": "1061000"
  },
  {
    "text": "we set it up with um our virtual box using USB filters to always pass through",
    "start": "1038919",
    "end": "1044640"
  },
  {
    "text": "the simulated device to the VM guest and this automatically triggers the the plug",
    "start": "1044640",
    "end": "1050280"
  },
  {
    "text": "andplay service to identify the new the new hardware and actually then we can automate this as a low privileged user",
    "start": "1050280",
    "end": "1056720"
  },
  {
    "text": "across all devices very very easily so at the end of this process we",
    "start": "1056720",
    "end": "1065120"
  },
  {
    "text": "attempted to install 2,284 USB drivers only about half of",
    "start": "1065120",
    "end": "1071360"
  },
  {
    "text": "them 1,150 installed successfully um of those only about 600",
    "start": "1071360",
    "end": "1077200"
  },
  {
    "text": "did anything actually interesting so we ended up with 533 new kernel",
    "start": "1077200",
    "end": "1082520"
  },
  {
    "text": "drivers admittedly we didn't just do this on a single system we had to do it across all of them because that's a lot",
    "start": "1082520",
    "end": "1087840"
  },
  {
    "text": "of drivers running on one system um 58 installed auto run programs so these",
    "start": "1087840",
    "end": "1092880"
  },
  {
    "text": "either run at boot or when the user logs in and 12 installed Services running as high privileg users so I think we can",
    "start": "1092880",
    "end": "1099919"
  },
  {
    "text": "say from our initial attack surface to running all of these installations that's actually increased hugely and",
    "start": "1099919",
    "end": "1106679"
  },
  {
    "text": "remember this is all third party code so I'm set up there I'm thinking right brilliant what I need to do next is",
    "start": "1106679",
    "end": "1115000"
  },
  {
    "text": "create some automated disassembly vulnerability finding system I'll do",
    "start": "1115000",
    "end": "1121799"
  },
  {
    "text": "this and uh we'll find some fantastic results unfortunately as with a lot of research we hit two big roadblocks there",
    "start": "1121799",
    "end": "1130039"
  },
  {
    "text": "so the first one being time that's a presentation in and of itself um but the",
    "start": "1130039",
    "end": "1135240"
  },
  {
    "text": "more important one was actually scope so whilst doing all of this I'm doing it on Standalone um virtual",
    "start": "1135240",
    "end": "1142120"
  },
  {
    "text": "machines that aren't connected to the network and we suddenly thought actually will this work in an Enterprise",
    "start": "1142120",
    "end": "1148320"
  },
  {
    "text": "environment because that's the focus of our research so we fired up um a Windows",
    "start": "1148320",
    "end": "1153960"
  },
  {
    "text": "2012 domain plugged it all in WS try and run this through W sus and it turns out",
    "start": "1153960",
    "end": "1161280"
  },
  {
    "text": "no no it won't work so WS administrators have to specifically enable um Windows",
    "start": "1161280",
    "end": "1167640"
  },
  {
    "text": "drivers for in installation so in a default installation of wsce none of",
    "start": "1167640",
    "end": "1174200"
  },
  {
    "text": "this will work great so let's take a look at WSS a little bit closer so pass",
    "start": "1174200",
    "end": "1181280"
  },
  {
    "text": "back to Paul thank",
    "start": "1181280",
    "end": "1184400"
  },
  {
    "start": "1185000",
    "end": "1244000"
  },
  {
    "text": "you okay so we're going to we're going to do a deep dive into WS so just a brief introduction uh so WS is um",
    "start": "1186400",
    "end": "1195039"
  },
  {
    "text": "essentially um the Windows update software that that you would normally connect to that's running on Microsoft",
    "start": "1195039",
    "end": "1200240"
  },
  {
    "text": "servers um but you can install and run it on your own uh local server um it's it's pretty much the same",
    "start": "1200240",
    "end": "1206960"
  },
  {
    "text": "so it's the same soap XML web service um from the the client point of view it's",
    "start": "1206960",
    "end": "1212039"
  },
  {
    "text": "it's almost identical um the big differen is for administrator so the idea with WSS is that um it will go and",
    "start": "1212039",
    "end": "1218559"
  },
  {
    "text": "download all the updates and cach them uh from Microsoft servers and then it will uh distribute them out to to all",
    "start": "1218559",
    "end": "1224400"
  },
  {
    "text": "the machines in a in a um in a sort of Windows Network um and the benefits for administrators is that they can control",
    "start": "1224400",
    "end": "1230640"
  },
  {
    "text": "when the updates go out they can test updates and approve them um they can withhold certain updates and so on and",
    "start": "1230640",
    "end": "1237039"
  },
  {
    "text": "they have visibility of which machines have installed which updates which means which machines hadn't rebooted yet and",
    "start": "1237039",
    "end": "1242360"
  },
  {
    "text": "and so on so let's talk a bit bit about the security of",
    "start": "1242360",
    "end": "1248120"
  },
  {
    "start": "1244000",
    "end": "1350000"
  },
  {
    "text": "WS so um I try this I um we set up uh Windows Server 2012 um machine um WS is",
    "start": "1248120",
    "end": "1257159"
  },
  {
    "text": "very simple to set up there's a nice wizard um it takes about 10 minutes to run through um and at the end of uh the",
    "start": "1257159",
    "end": "1263559"
  },
  {
    "text": "end of that Setup Wizard um W Su is up and running um everything's working um",
    "start": "1263559",
    "end": "1268600"
  },
  {
    "text": "and all it's left to do is just configure the client machines to to connect to it instead of connecting to Windows update there's one slight thing",
    "start": "1268600",
    "end": "1274919"
  },
  {
    "text": "one slight problem is that at the end of The Wizard um SSL is not enabled so this is a kind of default setup you run",
    "start": "1274919",
    "end": "1280960"
  },
  {
    "text": "through the wizard um there's no SSL for that soap web service now to Microsoft credit um the",
    "start": "1280960",
    "end": "1287880"
  },
  {
    "text": "very first thing you see after uh completing the wizard is this screen down here um with this says next steps",
    "start": "1287880",
    "end": "1293799"
  },
  {
    "text": "to fully configure your system you should explore the following topics and the very first link there um is a link",
    "start": "1293799",
    "end": "1298880"
  },
  {
    "text": "to using SSL W sus so if you follow that link to um the msdn site um you get to a",
    "start": "1298880",
    "end": "1305200"
  },
  {
    "text": "page that includes this text here so it explains a bit about the security of it so what it says is uh WS uses SSL for",
    "start": "1305200",
    "end": "1313000"
  },
  {
    "text": "metadata only not for update files so the update files are always fetched over HTTP and that's that's the same for",
    "start": "1313000",
    "end": "1318880"
  },
  {
    "text": "Windows update as well um it then goes on to say that actually the update files themselves are signed um and it uses",
    "start": "1318880",
    "end": "1326640"
  },
  {
    "text": "hashes of the files as well so when an update is downloaded it says here when",
    "start": "1326640",
    "end": "1331720"
  },
  {
    "text": "WS checks the the digital signature and the hash and if the update has been changed um then it doesn't install it so",
    "start": "1331720",
    "end": "1338480"
  },
  {
    "text": "essentially if the update have been tampered with in any way um then um it's game over and one really really",
    "start": "1338480",
    "end": "1344840"
  },
  {
    "text": "important thing is the updates they have to be signed but they have to be signed by Microsoft",
    "start": "1344840",
    "end": "1350520"
  },
  {
    "start": "1350000",
    "end": "1454000"
  },
  {
    "text": "soft so let's have a think now let's have a think about the the potential attacks that we could do kind of with",
    "start": "1351120",
    "end": "1356799"
  },
  {
    "text": "within this Within These parameters so let's let's imagine that um an administrator has not set up SSL for",
    "start": "1356799",
    "end": "1363320"
  },
  {
    "text": "their W WS instulation so if WSS is W if SSL was not being used",
    "start": "1363320",
    "end": "1369159"
  },
  {
    "text": "then potentially an attacker a network based attacker on the on the Windows Network could uh see the traffic they",
    "start": "1369159",
    "end": "1374840"
  },
  {
    "text": "could intercept the traffic and they can modify it but the updates themselves we can't modify those we we're going to assume",
    "start": "1374840",
    "end": "1381840"
  },
  {
    "text": "that um we haven't got any crazy um you know signature bypasses or anything like that",
    "start": "1381840",
    "end": "1388400"
  },
  {
    "text": "um so we can't modify the updates so what can we do so what we can do is we",
    "start": "1388400",
    "end": "1393679"
  },
  {
    "text": "can modify the the update metadata itself so things we could do maybe we",
    "start": "1393679",
    "end": "1398960"
  },
  {
    "text": "could if we could insect the man in the middle of the traffic we could prevent updates from being applied so maybe we could prevent critical updates from",
    "start": "1398960",
    "end": "1405000"
  },
  {
    "text": "being applied fairly bad um we could perhaps back to the driver staff we could force certain drivers to be",
    "start": "1405000",
    "end": "1410679"
  },
  {
    "text": "installed maybe third party drivers if we know there's a vulnerability in them perhaps um or we could even potentially",
    "start": "1410679",
    "end": "1416480"
  },
  {
    "text": "do things like downgrade attacks perhaps we could you know uh find a um you know if if the machine's been patched against",
    "start": "1416480",
    "end": "1422480"
  },
  {
    "text": "a recent um oday we could um downgrades uh find a find a previous update that kind of uh remove that protection remove",
    "start": "1422480",
    "end": "1429200"
  },
  {
    "text": "that update and then go and attack um a known vulnerability so those are all possible",
    "start": "1429200",
    "end": "1434640"
  },
  {
    "text": "things but none of them really really uh stand out to me as being particularly easy or particularly um easy to kind of",
    "start": "1434640",
    "end": "1441240"
  },
  {
    "text": "uh exploit across the board so let's go and have a look at the the soap um web service in a bit more detail um I should",
    "start": "1441240",
    "end": "1448240"
  },
  {
    "text": "warn anyone of a nervous disposition we're going to be seeing a lot of XML uh in the next few",
    "start": "1448240",
    "end": "1454240"
  },
  {
    "start": "1454000",
    "end": "1518000"
  },
  {
    "text": "slides so we want to have a look at the Ws traffic we need to proxy it um so we",
    "start": "1454520",
    "end": "1460799"
  },
  {
    "text": "can just use a normal um proxy like burp um and if uh W is using https um then",
    "start": "1460799",
    "end": "1468559"
  },
  {
    "text": "the ca from real proxy that has to go in the machine certificate store um that's",
    "start": "1468559",
    "end": "1473919"
  },
  {
    "text": "supposed to normally you install um your proxy s in the user store which is what",
    "start": "1473919",
    "end": "1479320"
  },
  {
    "text": "I uses but for w it has to be in the machine store um but honestly it's probably just easier to do it with",
    "start": "1479320",
    "end": "1484799"
  },
  {
    "text": "without https just um and not have to worry about that um Windows update does respect the proxy settings um sometimes",
    "start": "1484799",
    "end": "1492240"
  },
  {
    "text": "you might have to restart the Windows update service to get it to pick up proxy settings although normally not so",
    "start": "1492240",
    "end": "1497399"
  },
  {
    "text": "the the main thing we're interested in is this um the endpoint which is a client. asmx this one here so this is",
    "start": "1497399",
    "end": "1503520"
  },
  {
    "text": "where most of the interesting stuff happens and the soap web service is actually documented on on on msdn well",
    "start": "1503520",
    "end": "1511080"
  },
  {
    "text": "it's partially documented now I'll show you why that's um kind of interesting shortly um but there is some useful",
    "start": "1511080",
    "end": "1516520"
  },
  {
    "text": "stuff there so first of all we're just going to have a look at the kind of sequence of so so calls that happen um when",
    "start": "1516520",
    "end": "1524480"
  },
  {
    "start": "1518000",
    "end": "1612000"
  },
  {
    "text": "Windows update talks to the Ws server and this is largely similar to what happen with normal um Windows update um",
    "start": "1524480",
    "end": "1531399"
  },
  {
    "text": "if you're not usings so uh first of all there's a bunch of calls which are used to set up",
    "start": "1531399",
    "end": "1539240"
  },
  {
    "text": "um set up the connection um and these normally just happen once so there's uh",
    "start": "1539240",
    "end": "1544760"
  },
  {
    "text": "get config and returns some some config data there's get authorization cookie which goes to a different web Ser",
    "start": "1544760",
    "end": "1551279"
  },
  {
    "text": "different endpoint called Simple off um the important thing here is uh although it says get authorization cookie there's",
    "start": "1551279",
    "end": "1557279"
  },
  {
    "text": "no real um authentication going on here there's no kind of Windows credentials going backwards and forwards nothing",
    "start": "1557279",
    "end": "1563480"
  },
  {
    "text": "like that it's w SI is pretty much uh kind of unauthenticated um service anything can talk to it if he wants to",
    "start": "1563480",
    "end": "1571159"
  },
  {
    "text": "so the client gets this authorization cookie it then exchanges it for another cookie I don't know why um but the this",
    "start": "1571159",
    "end": "1577480"
  },
  {
    "text": "second cookie is really important because you need it for all the subsequent um requests um you need that cookie um and then the computer",
    "start": "1577480",
    "end": "1583880"
  },
  {
    "text": "registers itself so essentially it says um this is the OS I'm running um this is my computer name and so on few other",
    "start": "1583880",
    "end": "1591120"
  },
  {
    "text": "details and then the server Associates uh Those computer details with the cookie and then from then on it knows um",
    "start": "1591120",
    "end": "1597520"
  },
  {
    "text": "what machine it's talking to so all this normally happens just at once um unless the cookie expires or so and these calls",
    "start": "1597520",
    "end": "1604360"
  },
  {
    "text": "don't happen that often so the really interesting stuff is is what happens next so what happens when um a computer",
    "start": "1604360",
    "end": "1610320"
  },
  {
    "text": "actually checks for updates so first of all there's a call to um a method called sync updates and",
    "start": "1610320",
    "end": "1617679"
  },
  {
    "start": "1612000",
    "end": "1635000"
  },
  {
    "text": "with that the cl client sends a list of all the update IDs that it's got installed so on a typical Windows 7",
    "start": "1617679",
    "end": "1624200"
  },
  {
    "text": "machine there'll be you know a few hundred uh kind of uh update IDs there",
    "start": "1624200",
    "end": "1630320"
  },
  {
    "text": "um and then the server responds with what new updates there are um if any um what happens next it does another",
    "start": "1630320",
    "end": "1637240"
  },
  {
    "start": "1635000",
    "end": "1654000"
  },
  {
    "text": "cord sync update but this time it's looking for uh it's looking for Hardware um updates so essentially it sends a",
    "start": "1637240",
    "end": "1643720"
  },
  {
    "text": "list of all the hardware and all the driver versions and so on that it's got and again the the server responds and says um either you're up to date or",
    "start": "1643720",
    "end": "1650440"
  },
  {
    "text": "actually there's some some new uh drivers that you need to install um so",
    "start": "1650440",
    "end": "1657360"
  },
  {
    "start": "1654000",
    "end": "1691000"
  },
  {
    "text": "the uh so the respon Sy server contain a bit of metadata about the updates so it contains the update IDs and also some",
    "start": "1657360",
    "end": "1664039"
  },
  {
    "text": "metadata that lets the uh the PC decide whether it needs to or wants to install",
    "start": "1664039",
    "end": "1669399"
  },
  {
    "text": "those updates so the updates that uh the client does want to install it does another call it does a call to get",
    "start": "1669399",
    "end": "1676000"
  },
  {
    "text": "extended update info and with this it sends uh the updates it wants to install",
    "start": "1676000",
    "end": "1681440"
  },
  {
    "text": "and the server responds with a whole bunch more metadata about um where to download the files from and how to install them and so on so we're going to",
    "start": "1681440",
    "end": "1688840"
  },
  {
    "text": "look at a bit more detail in the actual XML now so this is a sync updates",
    "start": "1688840",
    "end": "1694480"
  },
  {
    "start": "1691000",
    "end": "1703000"
  },
  {
    "text": "request um I've abbreviated it because normally there's you know hundreds of IDs in there but this is literally just",
    "start": "1694480",
    "end": "1700039"
  },
  {
    "text": "a list of IDs update IDs that it's got installed the server then responds with",
    "start": "1700039",
    "end": "1706039"
  },
  {
    "start": "1703000",
    "end": "1738000"
  },
  {
    "text": "um any any new update IDs um so there's there's one here so this is an updated",
    "start": "1706039",
    "end": "1711360"
  },
  {
    "text": "ID every update has two IDs don't know why um bit of metadata and then um",
    "start": "1711360",
    "end": "1716559"
  },
  {
    "text": "because it's XML there's an XML tag with XML encoded XML inside of it great um",
    "start": "1716559",
    "end": "1722519"
  },
  {
    "text": "now I mentioned before that um this is all documented on on um msdn actually the contents of this XML tag that's not",
    "start": "1722519",
    "end": "1730080"
  },
  {
    "text": "documented and that actually that's where the interesting stuff is so um on the next slide um so this is the content",
    "start": "1730080",
    "end": "1737159"
  },
  {
    "text": "of the XML tag um decoded essentially so this is the um the update metadata that the server",
    "start": "1737159",
    "end": "1743720"
  },
  {
    "start": "1738000",
    "end": "1788000"
  },
  {
    "text": "responds with um for sync updates uh and what's going on here um is the update",
    "start": "1743720",
    "end": "1749279"
  },
  {
    "text": "each update has a guid as well so it has two IDs and a guid don't know why um but it lists uh dependencies so it says",
    "start": "1749279",
    "end": "1755760"
  },
  {
    "text": "before you install this update you must have installed these other ones first that's in these prerequisites here um",
    "start": "1755760",
    "end": "1761679"
  },
  {
    "text": "and then it's got these applicability rules and these are checks that the client can do um to see if it needs to",
    "start": "1761679",
    "end": "1767120"
  },
  {
    "text": "install the update so it can um specify things like go and check if these files",
    "start": "1767120",
    "end": "1772360"
  },
  {
    "text": "exist go and check the versions of these files or dlls um check registry values",
    "start": "1772360",
    "end": "1778320"
  },
  {
    "text": "um and and so on and there's a kind of booing logic there as well so it can say you need to have this file and this file",
    "start": "1778320",
    "end": "1784640"
  },
  {
    "text": "but not this file and so on you can get quite quite involved so um so next um once the the",
    "start": "1784640",
    "end": "1792679"
  },
  {
    "start": "1788000",
    "end": "1824000"
  },
  {
    "text": "client's done those checks it's decided which updates are applicable it then does a call to get extended update info",
    "start": "1792679",
    "end": "1798039"
  },
  {
    "text": "with the list of IDs that he wants to install the server response um with this",
    "start": "1798039",
    "end": "1803240"
  },
  {
    "text": "with this response and there's kind of two parts here so the top we have uh each update ID has some more XML inside",
    "start": "1803240",
    "end": "1810000"
  },
  {
    "text": "of an XML tag that's XML encoded um and it's got a list of files so the files",
    "start": "1810000",
    "end": "1815120"
  },
  {
    "text": "essentially say these are the files you need to download these are the hashes of the files um so now we're going to look at",
    "start": "1815120",
    "end": "1821880"
  },
  {
    "text": "the the contents of the these XML tags so this is the really important stuff here so again this is not",
    "start": "1821880",
    "end": "1828200"
  },
  {
    "start": "1824000",
    "end": "1875000"
  },
  {
    "text": "documented on msdn um but this is this XML here this describes how to install",
    "start": "1828200",
    "end": "1833720"
  },
  {
    "text": "each update so once the file downloaded what do you do with it so um what's circled at the top here",
    "start": "1833720",
    "end": "1842039"
  },
  {
    "text": "is the Handler attribute and for different types of updates there are different handlers and they have",
    "start": "1842039",
    "end": "1847559"
  },
  {
    "text": "different um types of XML for them um so this is a CBS Handler which is a I",
    "start": "1847559",
    "end": "1854519"
  },
  {
    "text": "think for cab files um and then the um it's got a list of files here to this um",
    "start": "1854519",
    "end": "1860799"
  },
  {
    "text": "this relates back to the the files in the previous uh slide here so essentially it says the these particular",
    "start": "1860799",
    "end": "1866000"
  },
  {
    "text": "files are needed for this particular update um and then at the bottom there's handless specific data and that's um",
    "start": "1866000",
    "end": "1873120"
  },
  {
    "text": "we'll take a bit of closer look at that a bit later on so what type of update handlers are there um so we um did a",
    "start": "1873120",
    "end": "1881600"
  },
  {
    "start": "1875000",
    "end": "1943000"
  },
  {
    "text": "kind of we did a full um uh update from a kind of blank Windows uh 7 install so",
    "start": "1881600",
    "end": "1886760"
  },
  {
    "text": "we saw a ton of XML a ton of different updates and things like that and these are the different handling we found so there's um CBS which like I said there",
    "start": "1886760",
    "end": "1894000"
  },
  {
    "text": "cab files there's um update handles for Windows drivers um for full windows installers um and so on but the one that",
    "start": "1894000",
    "end": "1901039"
  },
  {
    "text": "really stood out to us is command on installation that sounds quite interesting I thought so we took a",
    "start": "1901039",
    "end": "1906279"
  },
  {
    "text": "closer look at that so this is the XML um that's um",
    "start": "1906279",
    "end": "1914480"
  },
  {
    "text": "used for uh command installation this example is taken from um the malicious",
    "start": "1914480",
    "end": "1919679"
  },
  {
    "text": "software removal tool so um that's the thing which kind of gets uh you see that",
    "start": "1919679",
    "end": "1924960"
  },
  {
    "text": "every now and then window this update um and essentially what it is and what the command line installation is is it's",
    "start": "1924960",
    "end": "1931000"
  },
  {
    "text": "just a single XE that gets downloaded it gets run once and then then that's it so",
    "start": "1931000",
    "end": "1936279"
  },
  {
    "text": "for things like the militi software removal tool it's like a it's basically fire on forget it gets downloaded it gets run and and that's",
    "start": "1936279",
    "end": "1942840"
  },
  {
    "text": "it um but the thing that's kind of really interesting here which I'll just expand on here is the this handless",
    "start": "1942840",
    "end": "1948279"
  },
  {
    "start": "1943000",
    "end": "1979000"
  },
  {
    "text": "specific data for command line installation uh and you'll see here there's uh these attributes that say program so it says basically saying run",
    "start": "1948279",
    "end": "1955000"
  },
  {
    "text": "this executable that you just downloaded uh and most importantly there some arguments here so it says run this",
    "start": "1955000",
    "end": "1960039"
  },
  {
    "text": "program with these arguments so hopefully by now you're thinking actually this this looks this has",
    "start": "1960039",
    "end": "1966840"
  },
  {
    "text": "potential so what can we do with command command line installation so remember we're talking about the cases where SSL",
    "start": "1966840",
    "end": "1973120"
  },
  {
    "text": "is not being used we can uh intercept all this XML we can inject into it modify it and so",
    "start": "1973120",
    "end": "1979279"
  },
  {
    "start": "1979000",
    "end": "2062000"
  },
  {
    "text": "on so with a command command line installation we can download and run any Microsoft signed executable so it has to",
    "start": "1979279",
    "end": "1985320"
  },
  {
    "text": "be signed by Microsoft and we can provide arbit commin line arguments so this is looking",
    "start": "1985320",
    "end": "1990880"
  },
  {
    "text": "pretty good and also the other thing um which we mentioned back at the start is that updates get installed as system so",
    "start": "1990880",
    "end": "1996760"
  },
  {
    "text": "this is really um privileged stuff happening so the first thought my first",
    "start": "1996760",
    "end": "2002320"
  },
  {
    "text": "thought um once i' kind of gone through this was let's download and run command. exe simple give it some arguments do",
    "start": "2002320",
    "end": "2008519"
  },
  {
    "text": "whatever we like but actually if you look at Commando XE it's not actually signed in",
    "start": "2008519",
    "end": "2014720"
  },
  {
    "text": "fact most um windows binaries on a on a Windows install aren't signed why um but",
    "start": "2014720",
    "end": "2020399"
  },
  {
    "text": "that they're not which is kind of annoying um so the next we we had a",
    "start": "2020399",
    "end": "2026080"
  },
  {
    "text": "think and we had to think in okay what what Windows uh binaries are signed what",
    "start": "2026080",
    "end": "2031799"
  },
  {
    "text": "what stuff is done by Microsoft so we we found we thought of CIS internal so it's great Microsoft",
    "start": "2031799",
    "end": "2037559"
  },
  {
    "text": "bought internals years ago they're basically you know tools that are great for hacking and Microsoft is going to assign them",
    "start": "2037559",
    "end": "2043760"
  },
  {
    "text": "brilliant um so let's use PSX so PSX um is normally used to like a command line",
    "start": "2043760",
    "end": "2050280"
  },
  {
    "text": "tool use it to authenticate to a remote machine and run some commands but you can also just run PSX on the local",
    "start": "2050280",
    "end": "2056240"
  },
  {
    "text": "machine um kind of without specifying any credentials and just run R commands from the command line",
    "start": "2056240",
    "end": "2062520"
  },
  {
    "start": "2062000",
    "end": "2167000"
  },
  {
    "text": "brilliant so here's the plan we're going to um have a man in the middle um proxy",
    "start": "2062520",
    "end": "2070440"
  },
  {
    "text": "essentially it's going to be intercepting the traffic between the client and the server and this this is what we're going to do so the client is",
    "start": "2070440",
    "end": "2076480"
  },
  {
    "text": "going to check for updates it's going to do a sync updates request and we're just going to pass that straight through to the server the server will respond and say",
    "start": "2076480",
    "end": "2083720"
  },
  {
    "text": "there's updates or there's no updates um but we're going to modify that response and we're going to inject our own",
    "start": "2083720",
    "end": "2088800"
  },
  {
    "text": "request so we're going to inject a fake update essentially so the client will say yes I",
    "start": "2088800",
    "end": "2094480"
  },
  {
    "text": "would like to install that fake update please and give me more information now we're not going to pass that through to the server because that update doesn't",
    "start": "2094480",
    "end": "2100480"
  },
  {
    "text": "exist the server is going to go I don't know what you're talking about so we're just going to make our own response to that uh so we're going to respond and",
    "start": "2100480",
    "end": "2106839"
  },
  {
    "text": "say um do this command line installation thing go and download PSX from from me",
    "start": "2106839",
    "end": "2112200"
  },
  {
    "text": "um and go and run that with these arguments so the client will do that download it run it and hopefully this",
    "start": "2112200",
    "end": "2119640"
  },
  {
    "text": "all will work um and this is so this we took the the XML um for a from the",
    "start": "2119640",
    "end": "2126760"
  },
  {
    "text": "malicious software removal tool and then we used it to uh we changed it to specify pxx PSX and with with some uh",
    "start": "2126760",
    "end": "2135200"
  },
  {
    "text": "with the arguments we wanted and this is what this is what we",
    "start": "2135200",
    "end": "2140720"
  },
  {
    "text": "has so this this this probably all sounds very simple uh you know modify the XML PSX",
    "start": "2140720",
    "end": "2147440"
  },
  {
    "text": "done um this this took a while to to get working the theory was very simple uh we whisper a long time waiting for updates",
    "start": "2147440",
    "end": "2154400"
  },
  {
    "text": "to happen and um getting tweaking the XML to get it right it's not fully documented and so on so um we were",
    "start": "2154400",
    "end": "2160280"
  },
  {
    "text": "pretty pretty pleased uh when we got to this stage okay so now it's demo",
    "start": "2160280",
    "end": "2166599"
  },
  {
    "text": "time so I'm just going to explain uh the setup we've got here so we have a",
    "start": "2166599",
    "end": "2173200"
  },
  {
    "start": "2167000",
    "end": "2206000"
  },
  {
    "text": "Windows Server 2012 VM uh that's got W sus um installed and set up um no SSL um",
    "start": "2173200",
    "end": "2181520"
  },
  {
    "text": "which is kind of the default um we've got uh I've got a Linux",
    "start": "2181520",
    "end": "2186800"
  },
  {
    "text": "um VM which is we're going to use to do the the um the modification of the XML",
    "start": "2186800",
    "end": "2193400"
  },
  {
    "text": "and I'm going to uh boot up a Windows 8 VM which is going to be our um our",
    "start": "2193400",
    "end": "2200640"
  },
  {
    "text": "Target so the first scenario we're going to look at is um a local pesque so the",
    "start": "2200640",
    "end": "2207040"
  },
  {
    "start": "2206000",
    "end": "2326000"
  },
  {
    "text": "scenario here is that we are a a non-privileged user that's got access to a um a machine um you know like a",
    "start": "2207040",
    "end": "2213560"
  },
  {
    "text": "typical corporate desktop machine um and what we're going to do is um we're going",
    "start": "2213560",
    "end": "2218960"
  },
  {
    "text": "to modify the proxy settings so we're going to assume I mean yeah some environments are going to be really locked down you can't modify proxy",
    "start": "2218960",
    "end": "2224560"
  },
  {
    "text": "settings at all some you can we're going to assume that we can um modify the uh",
    "start": "2224560",
    "end": "2230720"
  },
  {
    "text": "the proxy settings so uh",
    "start": "2230720",
    "end": "2236079"
  },
  {
    "text": "see right so first of all I'm just going to do uh nothing's changed I'm just going to check for updates it's going to",
    "start": "2236079",
    "end": "2241880"
  },
  {
    "text": "talk to the um the dou server um the actual D server um and it should say",
    "start": "2241880",
    "end": "2247560"
  },
  {
    "text": "there's not any updates so no updates so there's nothing no funny physics going on now we're",
    "start": "2247560",
    "end": "2254000"
  },
  {
    "text": "going to modify the proxy settings so now this is pointing uh uh the proy",
    "start": "2254000",
    "end": "2259359"
  },
  {
    "text": "settings to my Linux VM it could equally just be point we could point at a local host if we had a you know if we could",
    "start": "2259359",
    "end": "2265359"
  },
  {
    "text": "run a you know um an executable just a non-privileged executable on here um and",
    "start": "2265359",
    "end": "2270920"
  },
  {
    "text": "it would work just the same so we check for updates again hopefully",
    "start": "2270920",
    "end": "2277800"
  },
  {
    "text": "I spent a long time oh oh that's because I forgot to run my proxy right so let's run my",
    "start": "2278240",
    "end": "2285319"
  },
  {
    "text": "proxy yeah so this is basically a python script it's about 200 lines um it's very",
    "start": "2285319",
    "end": "2290920"
  },
  {
    "text": "basic it just um modifies the ne necessary request injects a bit of XML and let's try it",
    "start": "2290920",
    "end": "2299079"
  },
  {
    "text": "again we've got an update let's install",
    "start": "2304520",
    "end": "2310119"
  },
  {
    "text": "it fingers crossed there we go so let's just uh just in case you don't believe",
    "start": "2311480",
    "end": "2317079"
  },
  {
    "text": "me so we're now running as ENT Authority system thank",
    "start": "2317079",
    "end": "2324160"
  },
  {
    "text": "you okay so we we were pretty pleased when we got that working that was that was quite good um so that's that's a a",
    "start": "2326800",
    "end": "2333800"
  },
  {
    "text": "local pesque that's that's kind of the first step now are a few problems with this so we're talking about corporate",
    "start": "2333800",
    "end": "2339440"
  },
  {
    "text": "environment now PSX is often picked up by AVS as a evil hacking tool um so",
    "start": "2339440",
    "end": "2345599"
  },
  {
    "text": "using PSX maybe that's not the most realistic um thing so it may get blocked if we try and use that essentially",
    "start": "2345599",
    "end": "2353200"
  },
  {
    "text": "so had to think okay what else can we use so this brought us to another CIS",
    "start": "2353200",
    "end": "2359240"
  },
  {
    "start": "2357000",
    "end": "2417000"
  },
  {
    "text": "internals tool um BG info now BG info if you're not familiar with it essentially it displays system information on the",
    "start": "2359240",
    "end": "2365359"
  },
  {
    "text": "desktop background and actually it's often used on Enterprise machines um to let admins tell one machine from another",
    "start": "2365359",
    "end": "2370880"
  },
  {
    "text": "just and so on now probably what you don't know about B info is you can specify various different custom fields",
    "start": "2370880",
    "end": "2377720"
  },
  {
    "text": "and one thing you can do is specify a VB script file to execute uh to produce an output that will display on the desktop",
    "start": "2377720",
    "end": "2384400"
  },
  {
    "text": "so again we have we can run arbitary code um via a Microsoft science",
    "start": "2384400",
    "end": "2391640"
  },
  {
    "text": "binary um and also the the other important thing is we can load the config file so you can create a bgo file",
    "start": "2391640",
    "end": "2397960"
  },
  {
    "text": "we can load it from a network share so this is the kind of thing we want to run we want to run BG info uh we're going to specify a uh a share an unauthenticated",
    "start": "2397960",
    "end": "2406480"
  },
  {
    "text": "unauthenticated share hosted on TM uh and we going to tell it to to run the",
    "start": "2406480",
    "end": "2411520"
  },
  {
    "text": "this this this file and launch our VB script okay so demo two",
    "start": "2411520",
    "end": "2417599"
  },
  {
    "start": "2417000",
    "end": "2588000"
  },
  {
    "text": "time right uh so I'm going to modify",
    "start": "2417599",
    "end": "2423560"
  },
  {
    "text": "proxy slightly um to so BD info is going to be served",
    "start": "2423560",
    "end": "2429280"
  },
  {
    "text": "up so the scenario now is that we're going to do it purely network based so",
    "start": "2429280",
    "end": "2434440"
  },
  {
    "text": "we're assuming we've got no access um to any Windows machines we've got no credentials nothing the only thing we",
    "start": "2434440",
    "end": "2440800"
  },
  {
    "text": "have is access to to the the kind of the windows Network so I'm going to use a tool called um responder uh from SP labs",
    "start": "2440800",
    "end": "2448280"
  },
  {
    "text": "and what this does we're using it to um do a w pads uh injection attack so essentially what happens is um machines",
    "start": "2448280",
    "end": "2455200"
  },
  {
    "text": "will will kind of call out to the network say any net proxy Auto configuration out there and we're going",
    "start": "2455200",
    "end": "2460319"
  },
  {
    "text": "to respond and say yes you need to talk to my proxy so if I uh boot up my VM",
    "start": "2460319",
    "end": "2468319"
  },
  {
    "text": "again so this time we've got a net count",
    "start": "2468319",
    "end": "2472920"
  },
  {
    "text": "listener okay so we don't need the um so the the ideal here is we not got any",
    "start": "2475839",
    "end": "2482440"
  },
  {
    "text": "access at all um I'm going to cheat slightly uh because normally what would happen is that the machine would",
    "start": "2482440",
    "end": "2488040"
  },
  {
    "text": "periodically check for updates every so often and then it would download the updates and at a designated time of day",
    "start": "2488040",
    "end": "2493880"
  },
  {
    "text": "it would automatically install the updates um we haven't really got time to wait around for a few hours for that so I'm just going to trick it manually but",
    "start": "2493880",
    "end": "2499720"
  },
  {
    "text": "this this would all happen um this would all happen automatically if we if we were patient",
    "start": "2499720",
    "end": "2507200"
  },
  {
    "text": "enough right so when I ran this before the update this didn't work the first",
    "start": "2509560",
    "end": "2515119"
  },
  {
    "text": "time but it did work the second time so we we'll see we we got this working just",
    "start": "2515119",
    "end": "2520359"
  },
  {
    "text": "yesterday um this demo so we'll see how it",
    "start": "2520359",
    "end": "2526240"
  },
  {
    "text": "goes I spent so much of my life waiting for these updates to",
    "start": "2530640",
    "end": "2535680"
  },
  {
    "text": "happen come on right so that didn't work but I knew it wasn't going to work I don't know why in there it should but",
    "start": "2537319",
    "end": "2543839"
  },
  {
    "text": "there's something weird with my setup I don't really know so we're just going to check for updates again so fingers crossed this",
    "start": "2543839",
    "end": "2551839"
  },
  {
    "text": "time there we go so this has popped up here",
    "start": "2553240",
    "end": "2559319"
  },
  {
    "text": "and there we go system [Applause]",
    "start": "2559319",
    "end": "2566590"
  },
  {
    "text": "again so they probably all look fairly straightforward but the really kind of important thing here is we we started off with basically nothing we just um",
    "start": "2567559",
    "end": "2574000"
  },
  {
    "text": "we're on the local network but we have no no privileges no nothing like that and we can fully compromise so not to",
    "start": "2574000",
    "end": "2580160"
  },
  {
    "text": "get code running we can get code running at system of any machine on the network that's using Windows update or WS rather",
    "start": "2580160",
    "end": "2586079"
  },
  {
    "text": "without with no um https so that's that's what can happen if you're not using htps so um for those",
    "start": "2586079",
    "end": "2592599"
  },
  {
    "start": "2588000",
    "end": "2633000"
  },
  {
    "text": "of you who um do pent tests or audits or um manage networks and so on um you'll be asking okay how can we check for this",
    "start": "2592599",
    "end": "2598960"
  },
  {
    "text": "how can we see if I'm runable so it's pretty easy um just check this this register key so this one here ww server",
    "start": "2598960",
    "end": "2606359"
  },
  {
    "text": "um has the URL of the W server if that URL starts with HTTP and not https then",
    "start": "2606359",
    "end": "2611880"
  },
  {
    "text": "you're you've got problems um and you can also check it by Group Policy as",
    "start": "2611880",
    "end": "2617079"
  },
  {
    "text": "well so how do you fix this um well like I said Microsoft does recommend using SSL they have a guide for it so",
    "start": "2617079",
    "end": "2623760"
  },
  {
    "text": "basically go and read the guide um it's just a case of deploying assert and installing it and if you're using SSL it",
    "start": "2623760",
    "end": "2630160"
  },
  {
    "text": "will mitigate the attacks that dis shown they won't be possible so just to summarize um so we",
    "start": "2630160",
    "end": "2636440"
  },
  {
    "start": "2633000",
    "end": "2699000"
  },
  {
    "text": "looked at the drivers on Windows update so we found a large number of third party drivers that can increase uh the",
    "start": "2636440",
    "end": "2643119"
  },
  {
    "text": "attack surface of a Windows machine um so that's interesting but for the",
    "start": "2643119",
    "end": "2648880"
  },
  {
    "text": "Enterprise which is what we're focused on it's not so much of an issue um basically because um the updates um the",
    "start": "2648880",
    "end": "2655680"
  },
  {
    "text": "admin has to approve the updates so for drivers they're only going to probably just approve a certain drivers they need",
    "start": "2655680",
    "end": "2661559"
  },
  {
    "text": "for their environment uh and in terms of widely applicable attacks there's not a lot there so that brings us to the",
    "start": "2661559",
    "end": "2668359"
  },
  {
    "text": "unencrypted Ws so we've shown local pesque um full local network",
    "start": "2668359",
    "end": "2674720"
  },
  {
    "text": "compromise um basically because SSL is not on by default so the question now is is this",
    "start": "2674720",
    "end": "2682880"
  },
  {
    "text": "really a problem do all admins follow the hardening gu hardening guidelines um",
    "start": "2682880",
    "end": "2688640"
  },
  {
    "text": "I'm going to go out on limb and say no not all admins probably follow the Harden guidelines and certainly in our",
    "start": "2688640",
    "end": "2695040"
  },
  {
    "text": "experience that's you know we we we we've seen that as well so that's it um before I finish I",
    "start": "2695040",
    "end": "2702040"
  },
  {
    "start": "2699000",
    "end": "2710000"
  },
  {
    "text": "just want to thank these guys who um uh work from Tex they they helped us get this already in time so big thanks to",
    "start": "2702040",
    "end": "2708440"
  },
  {
    "text": "those guys um and oh just before I finish uh the question we started off",
    "start": "2708440",
    "end": "2713640"
  },
  {
    "start": "2710000",
    "end": "2724000"
  },
  {
    "text": "with why is Windows update so slow um you know we spent a few months looking at this we've gone into some great depth",
    "start": "2713640",
    "end": "2719119"
  },
  {
    "text": "windows with Windows update and to be honest we have no idea sorry um so that's it any oh um the",
    "start": "2719119",
    "end": "2727559"
  },
  {
    "start": "2724000",
    "end": "2770000"
  },
  {
    "text": "white paper so if you if you want to know more about this um there's a a lot more detail in our white paper which you can go to uh that Euro now and get that",
    "start": "2727559",
    "end": "2734000"
  },
  {
    "text": "we've got a fully worked example of the XML you need to inject and everything to create fake update um yeah any any",
    "start": "2734000",
    "end": "2742119"
  },
  {
    "text": "questions yes",
    "start": "2742680",
    "end": "2745960"
  },
  {
    "text": "pleas do we do testing SSM no we didn't",
    "start": "2749559",
    "end": "2755520"
  },
  {
    "text": "great well thank you very much anyone and uh sorry there was so much XML",
    "start": "2757920",
    "end": "2764079"
  },
  {
    "text": "[Applause]",
    "start": "2766510",
    "end": "2772069"
  }
]