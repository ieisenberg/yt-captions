[
  {
    "start": "0",
    "end": "158000"
  },
  {
    "text": "so my name's Keith and chief architect at slack it's a pleasure to be here at Q Khan I probably the less grueling",
    "start": "3980",
    "end": "10070"
  },
  {
    "text": "commute to get to Q con than than most of you our office about four blocks away and Sid stole my my pull the audience",
    "start": "10070",
    "end": "19580"
  },
  {
    "text": "for who uses slack lines so now that I know that a lot of you know what slack is this feels a little forced but you",
    "start": "19580",
    "end": "25760"
  },
  {
    "text": "know when you talk about slack a lot of times the new stories that people write these days are about new features like",
    "start": "25760",
    "end": "30890"
  },
  {
    "text": "voice calls or sometimes they're about the sort of you know some of the strategic things that might be more interesting to developers like platform",
    "start": "30890",
    "end": "36589"
  },
  {
    "text": "a lot of people really enjoy writing about BOTS for whatever reasons a lot of stuff gets written about bots but for",
    "start": "36589",
    "end": "42530"
  },
  {
    "text": "the purposes of this talk I'm gonna be focused on the sort of a core original use case of slack which is persistent",
    "start": "42530",
    "end": "48769"
  },
  {
    "text": "group messaging right so the product category that we're trying to define is group messaging right so a little bit",
    "start": "48769",
    "end": "54409"
  },
  {
    "text": "like you know IRC right self self curated channels of people with the same interest groups talking in a real-time",
    "start": "54409",
    "end": "60680"
  },
  {
    "text": "way and I talk in a conversational sort of setting around a kind of virtual water cooler instead of like you know",
    "start": "60680",
    "end": "65900"
  },
  {
    "text": "you know common thread or an email thread where it's reveals long-form but also persistent right so if you leave",
    "start": "65900",
    "end": "72740"
  },
  {
    "text": "work at five and get back at nine you can catch up on whatever happened in the ops channel while you were away and this",
    "start": "72740",
    "end": "79640"
  },
  {
    "text": "is sort of a really simple vision to kind of state it turns out that executing it well and executing it at scale in a way that you can operate is",
    "start": "79640",
    "end": "85490"
  },
  {
    "text": "pretty challenging so you can expect here today is that we're going to go through a little case study of how a",
    "start": "85490",
    "end": "91969"
  },
  {
    "text": "typical slack session works so we have a user and their client connecting to sort of slacks infrastructure running in the",
    "start": "91969",
    "end": "97999"
  },
  {
    "text": "cloud receiving messages sending messages and all the sort of internal pieces of slack that interacts with also",
    "start": "97999",
    "end": "104509"
  },
  {
    "text": "talk about so much Alan jizz we face right now right so slacks a very new product it's only been in operation for a little over",
    "start": "104509",
    "end": "110270"
  },
  {
    "text": "two years at this met this time it's been operational and up for all of its users that whole time so it's still busy",
    "start": "110270",
    "end": "117289"
  },
  {
    "text": "being born and I'll talk a little bit about our plans to address them and what state they're in and I've done a couple",
    "start": "117289",
    "end": "124819"
  },
  {
    "text": "of Toxic Yukon before you know with different hats on and I've done a lot of these tech talks and there's this",
    "start": "124819",
    "end": "130100"
  },
  {
    "text": "tendency to get frozen into talking about your thing as if it's perfect in part because like it's kind of you're",
    "start": "130100",
    "end": "135830"
  },
  {
    "text": "insecure right you're talking about the work you do all all day long you want to make it sound like you work at a cool company full of smart people or doing hard stuff which",
    "start": "135830",
    "end": "142880"
  },
  {
    "text": "is true the more often than not but it's also a little bit of a fib right there",
    "start": "142880",
    "end": "147890"
  },
  {
    "text": "are lots of things that aren't perfect there's lots of things that if you had sort of perfect hindsight you'd go back and do differently and I'm gonna try and",
    "start": "147890",
    "end": "154070"
  },
  {
    "text": "not paper over them to to egregiously so",
    "start": "154070",
    "end": "159140"
  },
  {
    "start": "158000",
    "end": "158000"
  },
  {
    "text": "a few numbers to get us some sense of scale here in terms of raw headcount of users slack is sort of mega scale and",
    "start": "159140",
    "end": "165710"
  },
  {
    "text": "not Giga scale and so there are millions not billions of connected users right Millions with an atom we have peak",
    "start": "165710",
    "end": "174590"
  },
  {
    "text": "connected users of two and a half million and I'm sure somebody will correct me if this turns out to be wrong I think that's the largest sort of",
    "start": "174590",
    "end": "181580"
  },
  {
    "text": "instantaneous number of open WebSocket connections of anything out there I might be wrong about that I look forward",
    "start": "181580",
    "end": "187790"
  },
  {
    "text": "to finding out if I am what's more unusual about the scale and sort of load of the way that people use",
    "start": "187790",
    "end": "193970"
  },
  {
    "text": "slack it currently isn't so much the raw crush of bodies although that's getting more and more challenging it's actually",
    "start": "193970",
    "end": "200780"
  },
  {
    "text": "just how intensively they use it all right so we're not something that people kind of log into and write a few messages read a few messages and leave",
    "start": "200780",
    "end": "207160"
  },
  {
    "text": "for those part people stay connected during their entire workday so for instance the average user is actually",
    "start": "207160",
    "end": "213530"
  },
  {
    "text": "intensively using slack alright so actively in focus reading channels writing messages and so on for two hours",
    "start": "213530",
    "end": "219980"
  },
  {
    "text": "away for every workday and they're connected on an average of 10 hours for the average workday there's also this",
    "start": "219980",
    "end": "227120"
  },
  {
    "text": "impression that everything that slack is kind of a Silicon Valley thing or something that it's all you know start at people using it 50% of our daily",
    "start": "227120",
    "end": "234470"
  },
  {
    "text": "active users are from outside the US so you know Europe Asia Africa and we'll",
    "start": "234470",
    "end": "240920"
  },
  {
    "text": "see how that trend goes over time and a little bit about sort of our style of",
    "start": "240920",
    "end": "247310"
  },
  {
    "start": "244000",
    "end": "244000"
  },
  {
    "text": "solving problems and the kinds of things to expect from this talk so a lot of times people when they talk about their",
    "start": "247310",
    "end": "253640"
  },
  {
    "text": "consumer oriented web stack it's a little bit of buzz word bingo over at the so reason this reason that reason that we're using that we plumbed",
    "start": "253640",
    "end": "259280"
  },
  {
    "text": "together these two things that way there's gonna be a little bit of a different kind of talk from that perspective if I were to pick with",
    "start": "259280",
    "end": "265850"
  },
  {
    "text": "single adjectives for the house style at SLAC it would be conservative",
    "start": "265850",
    "end": "270910"
  },
  {
    "text": "so the vast majority of what slack is doing and what's challenging about what it's doing are storage and memory and",
    "start": "271009",
    "end": "276409"
  },
  {
    "text": "compute and networking handling failure these the hard part of these things are",
    "start": "276409",
    "end": "282349"
  },
  {
    "text": "essentially hard the same way they were ten years ago and the things that have come along in the intervening ten years while sometimes better are also ten",
    "start": "282349",
    "end": "289969"
  },
  {
    "text": "years younger and you know full of ten years of bugs that were not that interested in being the people to find",
    "start": "289969",
    "end": "295219"
  },
  {
    "text": "out about on the other side of this spectrum we're willing to write some code so for instance when we get to",
    "start": "295219",
    "end": "302749"
  },
  {
    "text": "talking about messages a lot of times people expect slack's message bus to be described as",
    "start": "302749",
    "end": "308449"
  },
  {
    "text": "you know we set up Kafka and such in such a way and we tuned it like this to get low latency and so on and so forth and to be clear there are places that",
    "start": "308449",
    "end": "316219"
  },
  {
    "text": "can be successful with that style solving problems however our experience so far is that the effort and",
    "start": "316219",
    "end": "322459"
  },
  {
    "text": "operational know-how and monitoring and alerting and so on that goes into getting an off-the-shelf piece of software to do exactly what you want it",
    "start": "322459",
    "end": "328520"
  },
  {
    "text": "to do sometimes is better spent telling the computer what you want it to do in the programming language of your choice",
    "start": "328520",
    "end": "334209"
  },
  {
    "text": "so our message bus to go back to that example again is a bunch of Java that we wrote and while that means that we",
    "start": "334209",
    "end": "342589"
  },
  {
    "text": "invest software effort in building and maintaining a lot of software it means that it actually does what we want it to do and that we have in-house experts",
    "start": "342589",
    "end": "348919"
  },
  {
    "text": "that understand essentially all of it and along these lines we also have a taste for minimalism there are",
    "start": "348919",
    "end": "354709"
  },
  {
    "text": "relatively few core pieces of infrastructure that come from outside of slack that we depend upon so for",
    "start": "354709",
    "end": "362209"
  },
  {
    "text": "instance if you're proposing that we introduced some new dependency and Kassondra we might have a long conversation of the form well why can't",
    "start": "362209",
    "end": "368360"
  },
  {
    "text": "you do what you're trying to do with Redis or my sequel or some other system that we've already got thousands and",
    "start": "368360",
    "end": "374120"
  },
  {
    "text": "thousands of server years of experience operating successfully so I had to go to",
    "start": "374120",
    "end": "380599"
  },
  {
    "start": "379000",
    "end": "379000"
  },
  {
    "text": "Comic Sans for this one because this is sort of a abusively crude picture of what's going on at SLAC but it's not",
    "start": "380599",
    "end": "387919"
  },
  {
    "text": "entirely deceptive so out here on the edge down at the bottom of the screen",
    "start": "387919",
    "end": "393110"
  },
  {
    "text": "we've got our clients right so there are happy hopefully slot customers and they've got some floor ality of devices",
    "start": "393110",
    "end": "399889"
  },
  {
    "text": "running slot clients right so maybe there is an iPhone now at the lower left running our iOS client maybe there a laptop running are our native Mac OS",
    "start": "399889",
    "end": "407090"
  },
  {
    "text": "client or a native Windows client and you can see that there's kind of two big gateways into the backend of slack that",
    "start": "407090",
    "end": "413150"
  },
  {
    "text": "these things end up cooperating with one of them is is the web app stack and web",
    "start": "413150",
    "end": "418400"
  },
  {
    "text": "app is a big restful application that I'll be talking about more in more detail in a second and the other ones",
    "start": "418400",
    "end": "424400"
  },
  {
    "text": "the real-time part of our serving infrastructure which I'm representing the message server here a quick word",
    "start": "424400",
    "end": "431930"
  },
  {
    "text": "about I'm gonna be repeating this point over and over again a couple times there's this like fun fact about slack that media stories really enjoy",
    "start": "431930",
    "end": "438320"
  },
  {
    "text": "hammering home which is that it started out as a game company or as a pivot from a massively multiplayer online game and",
    "start": "438320",
    "end": "445400"
  },
  {
    "text": "usually people just mentioned this as like some funny thing right it's like oh they were a game company haha isn't it",
    "start": "445400",
    "end": "450590"
  },
  {
    "text": "weird how like cookies crumble sometime that's true but it actually does kind of come back in certain ways and comes back",
    "start": "450590",
    "end": "457610"
  },
  {
    "text": "to be meaningful in certain ways and in a certain way if you kind of squint until your head the actual architecture",
    "start": "457610",
    "end": "462740"
  },
  {
    "text": "of slack resembles the architecture of a massively multiplayer online game right so you kind of have your world that you",
    "start": "462740",
    "end": "468920"
  },
  {
    "text": "operate in which is your team and in order to kind of make that world seem both persistent and sort of",
    "start": "468920",
    "end": "475130"
  },
  {
    "text": "interactively mutable with other things in the world you end up making a pretty thick cache of what's going on in that",
    "start": "475130",
    "end": "481520"
  },
  {
    "text": "world and then you've got some way of getting hopefully low latency updates for the changes in that world so that",
    "start": "481520",
    "end": "487850"
  },
  {
    "text": "kind of mental paradigm of oh it's kind of like an online game actually explains a lot of things about slack like it's like why we have loading screens for",
    "start": "487850",
    "end": "493940"
  },
  {
    "text": "instance that's the same reason that video games tend to have loading screens",
    "start": "493940",
    "end": "499360"
  },
  {
    "text": "so we're going to illustrate all these moving parts here going to exercise all the bits on screen here by working",
    "start": "499360",
    "end": "506540"
  },
  {
    "text": "through a worked example of a user logging into slack and listening to messages and writing some messages so",
    "start": "506540",
    "end": "513500"
  },
  {
    "text": "there's a element of this that's just the internet right so when you go to you know my domain name.com dns does it's",
    "start": "513500",
    "end": "520940"
  },
  {
    "text": "magic you know a bunch of Cisco routers are in the way ELB etc and you end up",
    "start": "520940",
    "end": "527200"
  },
  {
    "text": "somewhere in slacks web app code somewhere on a dub dub dub machine that slack operates and we call you'll hear",
    "start": "527200",
    "end": "536810"
  },
  {
    "start": "528000",
    "end": "528000"
  },
  {
    "text": "me go back and forth between dub dub dub and web app and the contraction web app because the github repo is is named web",
    "start": "536810",
    "end": "543770"
  },
  {
    "text": "app and the first thing that they do is this method that we call our TM start so",
    "start": "543770",
    "end": "550370"
  },
  {
    "text": "they're gonna use our API our TM in the context of slack by the way stands for real-time messaging so super occurs in",
    "start": "550370",
    "end": "556490"
  },
  {
    "text": "the API a lot kind of trips off my tongue a lot we say our TM starts so much that I'll be saying our TM start a",
    "start": "556490",
    "end": "562280"
  },
  {
    "text": "lot as well and so a real-time messaging start this is saying I'd like to start a session",
    "start": "562280",
    "end": "568120"
  },
  {
    "text": "you present some token some auth magic happens and so on and a word about",
    "start": "568120",
    "end": "574460"
  },
  {
    "text": "what's actually happening on the inside there what's running there at that web endpoint is a PHP monolith right is an",
    "start": "574460",
    "end": "581660"
  },
  {
    "start": "577000",
    "end": "577000"
  },
  {
    "text": "app law is a bunch of app logic a little less than a million lines of code at this as I said here talking to you",
    "start": "581660",
    "end": "587480"
  },
  {
    "text": "that knows where all the business objects that describe your team actually reside right there out in some database",
    "start": "587480",
    "end": "593660"
  },
  {
    "text": "somewhere and if you kind of look at the DNA of this thing you can recognize it as a you know very competently executed",
    "start": "593660",
    "end": "599780"
  },
  {
    "text": "lamp stack that has had to scale out so for instance it's memcache wrapped around my sequel my sequel really is",
    "start": "599780",
    "end": "606470"
  },
  {
    "text": "doing queries for instance that's not all just point queries the actual engine we happen to be using for PHP is the hip",
    "start": "606470",
    "end": "612830"
  },
  {
    "text": "hop virtual machine which is is Facebook's JIT for PHP it gets things a little bit faster but it also gets us",
    "start": "612830",
    "end": "618230"
  },
  {
    "text": "the option of using a gradual typing system for PHP called hack lang but from 100,000 feet yes it's really",
    "start": "618230",
    "end": "624770"
  },
  {
    "text": "really PHP and usually when I when I delve into this sort of whole",
    "start": "624770",
    "end": "630620"
  },
  {
    "start": "627000",
    "end": "627000"
  },
  {
    "text": "complicated and interesting conversation ensues and I desperately wish we had time to go into this whole interesting",
    "start": "630620",
    "end": "635780"
  },
  {
    "text": "complicated conversation and that conversation usually starts with I like slack but I hate PHP with a raw passion",
    "start": "635780",
    "end": "643670"
  },
  {
    "text": "that burns inside and I don't know how to reconcile these two facts they're confusing to me and I wrote a blog post",
    "start": "643670",
    "end": "650300"
  },
  {
    "text": "for engineering blog recently that basically makes the weird claim that those are both true right that it is",
    "start": "650300",
    "end": "656000"
  },
  {
    "text": "simultaneously true that PHP is essentially a bad programming language for almost every reasonable definition",
    "start": "656000",
    "end": "661610"
  },
  {
    "text": "of bad and then it's a very good choice for your application logic for something you're going to serve on the web if",
    "start": "661610",
    "end": "668420"
  },
  {
    "text": "you're really curious about this I suggest you dive in there but interest of talking more about how slack works I'm just going to leave that",
    "start": "668420",
    "end": "673950"
  },
  {
    "text": "thread dangling for now and ask that you take me at my word on it",
    "start": "673950",
    "end": "679160"
  },
  {
    "start": "678000",
    "end": "678000"
  },
  {
    "text": "so now here's where things start getting a little strange and there start to be a few forward references so your team all",
    "start": "679160",
    "end": "687180"
  },
  {
    "text": "the business objects that represent your team really are relational data inside of slack there are a bunch of tables",
    "start": "687180",
    "end": "692490"
  },
  {
    "text": "that contain things like messages and users and channels and they're designed in sort of a you know relatively",
    "start": "692490",
    "end": "698670"
  },
  {
    "text": "normalized form and it is also the fact",
    "start": "698670",
    "end": "704400"
  },
  {
    "text": "that we're charting by team it turns out right so team IDs get you to a database",
    "start": "704400",
    "end": "709620"
  },
  {
    "text": "where your team lives probably lives with some other teams unless you're really really active or really huge team",
    "start": "709620",
    "end": "715310"
  },
  {
    "text": "or both that when I say shard by team people tend to assume that what that",
    "start": "715310",
    "end": "722040"
  },
  {
    "text": "means is you take the team ID and you hash it and you project that hash onto some address space right there you take",
    "start": "722040",
    "end": "728100"
  },
  {
    "text": "that hash and you mod it or you you know Kodama it or whatever on some set of shards that's not what's going on right",
    "start": "728100",
    "end": "734480"
  },
  {
    "text": "the actual layer of indirection that goes from a team to the shard that it lives on is arbitrary and it's arbitrary",
    "start": "734480",
    "end": "741089"
  },
  {
    "text": "for basically administrative reasons it's arbitrary so that if a shard gets hot we can split it manually or",
    "start": "741089",
    "end": "748260"
  },
  {
    "text": "automatically in some cases we're still sort of in the transition from manual to automatic splits so that metadata of",
    "start": "748260",
    "end": "755810"
  },
  {
    "text": "which shard a given team lives on lives on another my sequel database that we",
    "start": "755810",
    "end": "761550"
  },
  {
    "text": "call the mains because they're a pair but it's one logical database and that thing knows which domain names RepRap to",
    "start": "761550",
    "end": "768810"
  },
  {
    "text": "which teams and which teams map to which shards and not a whole heck of a lot else the process of sort of getting",
    "start": "768810",
    "end": "775050"
  },
  {
    "text": "metadata off of the mains has been a recurring theme in our infrastructure over the last year for reasons that will",
    "start": "775050",
    "end": "781050"
  },
  {
    "text": "become really clear and with that information in hand we go off and start",
    "start": "781050",
    "end": "786750"
  },
  {
    "start": "784000",
    "end": "784000"
  },
  {
    "text": "actually constructing the payload for the response to our TM start so remember I'm claiming that you know slacks a",
    "start": "786750",
    "end": "793050"
  },
  {
    "text": "little bit like a massively multiplayer online game RTM start is kind of the key frame that bootstraps",
    "start": "793050",
    "end": "798240"
  },
  {
    "text": "the simulation of it right it's the thing that tells you here's the state of the world here's all the users here's all their profile pictures because for",
    "start": "798240",
    "end": "804480"
  },
  {
    "text": "all you know while client was disconnected everything changed right for all you know the last time I've connected to this team it was",
    "start": "804480",
    "end": "809880"
  },
  {
    "text": "only two people and now it's 2000 people and they've all changed their profile pictures for the election and whatever else right so our team start gives you",
    "start": "809880",
    "end": "819060"
  },
  {
    "text": "back this big blob of data that's essentially here's where we're at and to",
    "start": "819060",
    "end": "824310"
  },
  {
    "text": "do that we do lots and lots of sequel queries it's the most egregious offenders on this take something like",
    "start": "824310",
    "end": "830459"
  },
  {
    "text": "thousands of sequel queries so thousands of trips back and forth to this shard and yes fixing that is something that",
    "start": "830459",
    "end": "835740"
  },
  {
    "text": "we're you know constantly working on so a couple words about I've kind of been whistling past the fact that there are",
    "start": "835740",
    "end": "842279"
  },
  {
    "text": "these little pairs being Illustrated here I'm gonna keep whistling past it",
    "start": "842279",
    "end": "847920"
  },
  {
    "text": "for a second longer here just bear with me so both pairs are across two different",
    "start": "847920",
    "end": "855000"
  },
  {
    "text": "data centers right so barring sort of world historical scale crises hopefully",
    "start": "855000",
    "end": "860519"
  },
  {
    "text": "these things will be available for reads and writes given a single data center failure and reads and writes you say",
    "start": "860519",
    "end": "867690"
  },
  {
    "text": "Keith reads and writes that's interesting yeah hold that thought for a second so my sequel is an unfashionable",
    "start": "867690",
    "end": "874680"
  },
  {
    "text": "choice a little bit like PHP not quite as bad a reputation as PHP my sequel definitely does what it says in the",
    "start": "874680",
    "end": "880410"
  },
  {
    "text": "outside of the box and it's very carefully engineered but still not we're used to hearing when people talk about",
    "start": "880410",
    "end": "886500"
  },
  {
    "text": "their scale-out storage engines and probably the most important reason that we're using my sequel is just the",
    "start": "886500",
    "end": "891690"
  },
  {
    "text": "collective history in the universe of the thousands of server years of operating my sequel without it losing",
    "start": "891690",
    "end": "897240"
  },
  {
    "text": "data we also actually like the data modeling discipline that relational imposes on us we don't wish my sequel or",
    "start": "897240",
    "end": "904079"
  },
  {
    "text": "a document store we don't use it as if it were a document store the way a lot of people scaling up my sequel do and",
    "start": "904079",
    "end": "909990"
  },
  {
    "text": "also they're just a lot of in-house experience operating it and writing code for it and writing queries against it and diagnosing performance problems and",
    "start": "909990",
    "end": "916230"
  },
  {
    "text": "figuring out you know when it makes sense that a secondary index and so on but don't think of this as some big",
    "start": "916230",
    "end": "922470"
  },
  {
    "text": "arrow in the quiver of the no sequel debates because actually we don't you",
    "start": "922470",
    "end": "928500"
  },
  {
    "text": "know we throw away a lot of the strong properties of my sequel in the way that we're using it specifically",
    "start": "928500",
    "end": "937190"
  },
  {
    "start": "937000",
    "end": "937000"
  },
  {
    "text": "we use it an active-active way we do master master replication so you actually can write to either one of",
    "start": "937720",
    "end": "944060"
  },
  {
    "text": "those heads so each one of those heads is is replaying a statement based log and producing a statement based log from",
    "start": "944060",
    "end": "950420"
  },
  {
    "text": "its partner and if you have if you you know go out and hold a stethoscope up to",
    "start": "950420",
    "end": "955610"
  },
  {
    "text": "one of these logical you know it's a single database logically but they're separate machines they really will be",
    "start": "955610",
    "end": "961250"
  },
  {
    "text": "sustaining right traffic on either side of this and there really will be some some lag in the replication is that crosses from one machine to another",
    "start": "961250",
    "end": "967960"
  },
  {
    "text": "so we've taken my sequel and made an eventually consistent store out of it and we do this because basically we want",
    "start": "967960",
    "end": "975860"
  },
  {
    "text": "to be right available in in the case of failures and we want master promotion to be automatic in the case of failures now",
    "start": "975860",
    "end": "983110"
  },
  {
    "start": "983000",
    "end": "983000"
  },
  {
    "text": "you might be wondering what about conflicts what if we actually wrote the same row on either side of these things",
    "start": "983110",
    "end": "988850"
  },
  {
    "text": "where we did something else inconsistent like we tried to insert the same value conflicts do happen",
    "start": "988850",
    "end": "994610"
  },
  {
    "text": "so basically when application authors at slack are writing query is especially update queries to this system they need",
    "start": "994610",
    "end": "1001990"
  },
  {
    "text": "to bear in mind the possibility of this and it's where some that comes up in code reviews a lot is like is this actually safe in the event of you know",
    "start": "1001990",
    "end": "1009400"
  },
  {
    "text": "serious master master lag a replication lag if this right happened on both sides would it be safe and the majority of our",
    "start": "1009400",
    "end": "1017770"
  },
  {
    "text": "conflicts that do happen we're able to resolve automatically basically with application knowledge right we know what",
    "start": "1017770",
    "end": "1022990"
  },
  {
    "text": "it's trying to do and so we're able to resolve it but there are human beings who work at slack who have to resolve",
    "start": "1022990",
    "end": "1028688"
  },
  {
    "text": "conflicts that are nonzero rate and this is one of those things that uh you know when I talked about sort of things that just aren't pretty but are true that's a",
    "start": "1028689",
    "end": "1035110"
  },
  {
    "text": "thing that's not pretty but is true it's a thing that is not going to scale forever that we're currently doing a bit",
    "start": "1035110",
    "end": "1041380"
  },
  {
    "text": "of a kind of application level programming trick for making these things a little safer is a lot of these",
    "start": "1041380",
    "end": "1046540"
  },
  {
    "text": "are kind of racy updates of the same structure right so you know you can imagine that I've got my laptop out and",
    "start": "1046540",
    "end": "1052660"
  },
  {
    "text": "I've got my phone out and I'm trying to sort of change my profile picture and both of them to try and catch slack in the act and get you know a be a to",
    "start": "1052660",
    "end": "1058780"
  },
  {
    "text": "happen or something for the most part rights like that are",
    "start": "1058780",
    "end": "1064380"
  },
  {
    "text": "are are what you're going to read what you wrote even though we're doing this master master business because there's a",
    "start": "1064380",
    "end": "1070420"
  },
  {
    "text": "best effort to kind of get read what you wrote semantics using the team ID so the lowered a bit of your team ID is your",
    "start": "1070420",
    "end": "1076550"
  },
  {
    "text": "preferred head all right so even even teams want to write on the left head and odd teams want to write on the right",
    "start": "1076550",
    "end": "1083930"
  },
  {
    "text": "head as it were and of course they'll fail over to actually doing the right song on either side so you still have to think about all these conflicts and",
    "start": "1083930",
    "end": "1089000"
  },
  {
    "text": "stuff but in practice it's actually pretty hard if things are humming along in a healthy way to try to write the",
    "start": "1089000",
    "end": "1094700"
  },
  {
    "text": "same road twice okay so we do all of",
    "start": "1094700",
    "end": "1103010"
  },
  {
    "text": "these eventually consistent queries that let us construct the RTM start payload",
    "start": "1103010",
    "end": "1108220"
  },
  {
    "text": "and we return it to you and it's got a lot of information it's got the identity of every channel on the team it's got",
    "start": "1108220",
    "end": "1114740"
  },
  {
    "text": "the identity of every user in the team it's got the membership of all the channels it's got you know where the",
    "start": "1114740",
    "end": "1120050"
  },
  {
    "text": "reed cursor has moved ahead and all those channels since you lost examined them and blah blah blah blah but the two",
    "start": "1120050",
    "end": "1125330"
  },
  {
    "text": "pieces that we probably care about for our purposes are it says okay you know you did start a session I'm kind of",
    "start": "1125330",
    "end": "1131120"
  },
  {
    "text": "using active user for right now and here's your WebSocket URL right so there's a little WebSocket URL there",
    "start": "1131120",
    "end": "1137360"
  },
  {
    "text": "it's some host name at slack messages com and then the actual applications named WebSocket and then some funny hash of",
    "start": "1137360",
    "end": "1144260"
  },
  {
    "text": "something or other and we'll talk about what that funny hash is doing in a second so the contract here is going to",
    "start": "1144260",
    "end": "1152870"
  },
  {
    "start": "1147000",
    "end": "1147000"
  },
  {
    "text": "be now that you've gotten your key frame right now that you've gotten your state of the world at the time you started your session we're gonna keep you up to",
    "start": "1152870",
    "end": "1159410"
  },
  {
    "text": "date by trickling cache updates through that WebSocket connection all right so that WebSocket connection if you're using it as a chat app one of the really",
    "start": "1159410",
    "end": "1166190"
  },
  {
    "text": "visible of things that's flowing over that WebSocket connection is just messages going back and forth right so that's where the write amplifier that",
    "start": "1166190",
    "end": "1171320"
  },
  {
    "text": "actually takes a message you send broadcast it to everybody that's where that thing lives and you can see that",
    "start": "1171320",
    "end": "1177050"
  },
  {
    "text": "operating but going on behind the scenes is actually a lot of sort of quiet oh gosh so-and-so changed their profile",
    "start": "1177050",
    "end": "1182600"
  },
  {
    "text": "picture okay cool I'll show the right profile picture and things along those lines also presents information we'll",
    "start": "1182600",
    "end": "1188300"
  },
  {
    "text": "talk about presents briefly too so diving in a message server I kind of",
    "start": "1188300",
    "end": "1194720"
  },
  {
    "text": "gave a little preview of this briefly message server is an actual bunch of",
    "start": "1194720",
    "end": "1200030"
  },
  {
    "text": "Java code we wrote it's message in life is sort of twofold right so one is that it's a right",
    "start": "1200030",
    "end": "1205999"
  },
  {
    "start": "1202000",
    "end": "1202000"
  },
  {
    "text": "amplifier so things that happen on the team need to be shared to everybody that's actively using the team and it",
    "start": "1205999",
    "end": "1211639"
  },
  {
    "text": "also needs to be sort of communicated to the future it needs to be communicated to all the people who aren't here in",
    "start": "1211639",
    "end": "1217220"
  },
  {
    "text": "space but will be here later in time and so we need to store these messages somewhere we were talking about all this",
    "start": "1217220",
    "end": "1223610"
  },
  {
    "text": "discussion foregoing discussion about sort of master master replication and my sequel and shards and the left half and",
    "start": "1223610",
    "end": "1229309"
  },
  {
    "text": "the right half and so on that's all application logic message server doesn't know anything about it it's in a different language",
    "start": "1229309",
    "end": "1234379"
  },
  {
    "text": "there's no unholy bridge between Java and PHP that we've tried to forge it really side calls into a web server in a",
    "start": "1234379",
    "end": "1241369"
  },
  {
    "text": "way that's not so different from the way that you'd inside call over you know port 80 from the big bad internet so",
    "start": "1241369",
    "end": "1246649"
  },
  {
    "text": "that it can actually persist the message",
    "start": "1246649",
    "end": "1249909"
  },
  {
    "text": "and I'm making it sound like it's really simple so you might be kind of like is this literally just kind of 40 lines of",
    "start": "1251950",
    "end": "1256999"
  },
  {
    "start": "1252000",
    "end": "1252000"
  },
  {
    "text": "code that you know opens oh you know it's a wrapper around a WebSocket library and then a for loop over the people that are connected well no so one",
    "start": "1256999",
    "end": "1265279"
  },
  {
    "text": "of the things that I talked about there was that there was a contract here that you're gonna get your updates over the WebSocket you might have noticed there's",
    "start": "1265279",
    "end": "1273019"
  },
  {
    "text": "actually a little race here right so RTM start gives you a WebSocket URL time",
    "start": "1273019",
    "end": "1278360"
  },
  {
    "text": "elapses things change the world moves on a little bit maybe some messages even get exchanged and then you go over and",
    "start": "1278360",
    "end": "1284269"
  },
  {
    "text": "start connected and start talking over the real time connection to the web server to the message server rate so",
    "start": "1284269",
    "end": "1290619"
  },
  {
    "text": "that little hash of weirdness that came along with your payload that's actually a little cursor in the event log that",
    "start": "1290619",
    "end": "1298220"
  },
  {
    "text": "the message server keeps the message server keeps an in-memory buffer of recent events and that things actually bounded in real time I think it's 30",
    "start": "1298220",
    "end": "1304789"
  },
  {
    "text": "seconds so in practice you kind of have 30 seconds to go take the ticket that RTM start gave you and connect to the",
    "start": "1304789",
    "end": "1312139"
  },
  {
    "text": "message server and when you connect with it it'll catch you up with whatever you've missed there's also the fact that",
    "start": "1312139",
    "end": "1318350"
  },
  {
    "text": "we're doing persistence across you know a network boundary possibly a data center boundary so it's actually",
    "start": "1318350",
    "end": "1324980"
  },
  {
    "text": "possible that we're not able to persist a message for a while and then what should we do well you have the option of",
    "start": "1324980",
    "end": "1333440"
  },
  {
    "text": "sort of the sort of clinic distributed systems answer is whoa like we're not in an okay state we're not",
    "start": "1333440",
    "end": "1340580"
  },
  {
    "text": "able to actually send your message right now that is probably not the most helpful thing to do in this situation though right Network weather does happen",
    "start": "1340580",
    "end": "1347770"
  },
  {
    "text": "and usually network weather is you know very brief seconds later we will be able to persist it so there is both an",
    "start": "1347770",
    "end": "1355130"
  },
  {
    "text": "in-memory and on disk queue that we try to recover that the message server operates so it you know persists locally",
    "start": "1355130",
    "end": "1362300"
  },
  {
    "text": "and replay is the locally persisted log if it you know crashes and comes back up or if there's a you know something",
    "start": "1362300",
    "end": "1368840"
  },
  {
    "text": "really terrible happens and it takes a long time for the message for the my sequel and web app to be able to talk to",
    "start": "1368840",
    "end": "1374780"
  },
  {
    "text": "it by the way we really carefully monitor the depth of those those queues if those queues start building up that's",
    "start": "1374780",
    "end": "1380450"
  },
  {
    "text": "a really powerful sign that sort of something is badly wrong with the system and it could be load anywhere from oh",
    "start": "1380450",
    "end": "1386390"
  },
  {
    "text": "gosh the peril of presenting on your own laptop here yeah and it could be load",
    "start": "1386390",
    "end": "1392750"
  },
  {
    "text": "anywhere from the web server my sequel or other systems that I haven't been able to talk about here yet also the",
    "start": "1392750",
    "end": "1400100"
  },
  {
    "text": "vast majority of messages in a large team or presence or I mean by presence",
    "start": "1400100",
    "end": "1405440"
  },
  {
    "text": "is the information that so-and-so opened or closed their laptop so you know your intuition is probably most of what",
    "start": "1405440",
    "end": "1410930"
  },
  {
    "text": "happens is you're sending chat back and forth gets the chat application well know most of what you're sending is like the stuff that drives the little green",
    "start": "1410930",
    "end": "1417350"
  },
  {
    "text": "dots next to people's names when they're online that might seem wasteful but this",
    "start": "1417350",
    "end": "1423290"
  },
  {
    "text": "is actually a really really critical feature like going back to the online game analogy for a second those little",
    "start": "1423290",
    "end": "1428510"
  },
  {
    "text": "presents dots are a lot of what makes it kind of feel like a virtual water cooler in a virtual place where sort of people are you know you're kind of using your",
    "start": "1428510",
    "end": "1436250"
  },
  {
    "text": "brains location hardware to think about slot channels sometimes and the reason that messages that presents messages",
    "start": "1436250",
    "end": "1442010"
  },
  {
    "text": "proliferate this is a little weird but it's true is that this is basically N squared in the number of people in the",
    "start": "1442010",
    "end": "1448580"
  },
  {
    "text": "team so if we actually tell every connected user about every other connected users present status whereas",
    "start": "1448580",
    "end": "1455540"
  },
  {
    "text": "like other ones are kind of narrow cast two channels and stuff then it's just going to be the case that ultimate you",
    "start": "1455540",
    "end": "1460940"
  },
  {
    "text": "know in the long run you're gonna be dominated by people opening and closing their laptops because they do that more often than they post a mess",
    "start": "1460940",
    "end": "1466790"
  },
  {
    "text": "in general that goes to every single user there's another big box that I",
    "start": "1466790",
    "end": "1473330"
  },
  {
    "start": "1471000",
    "end": "1471000"
  },
  {
    "text": "haven't talked about yet which is the job queue let's work deferral mechanism I know job queue is not a very inventive",
    "start": "1473330",
    "end": "1478430"
  },
  {
    "text": "name but that is what the code base calls it and so I'll stick with it here be one of those things would be fun to",
    "start": "1478430",
    "end": "1483680"
  },
  {
    "text": "make up a name for someday we physically manifest this thing in Redis so there's all kinds of stuff that you kind of",
    "start": "1483680",
    "end": "1489290"
  },
  {
    "text": "don't want to do I have a background as operating system person by the way so I find this analogy just irresistible in",
    "start": "1489290",
    "end": "1494930"
  },
  {
    "text": "an actual web request it's a little bit like the top half of an interrupt handler right you kind of you have real-time you're sitting there occupying",
    "start": "1494930",
    "end": "1501560"
  },
  {
    "text": "a slot and like Apaches set of processes it can handle you want to get what",
    "start": "1501560",
    "end": "1506660"
  },
  {
    "text": "you're doing out of the way pretty quickly so that this server can go on to serve other users but there are things that just inherently take a long time a",
    "start": "1506660",
    "end": "1513080"
  },
  {
    "text": "really extreme example is an import or an if you're just importing you know years worth of data from you know some",
    "start": "1513080",
    "end": "1519080"
  },
  {
    "text": "competing chat product or something that's going to take hours no matter what we do but we want to be able to",
    "start": "1519080",
    "end": "1524330"
  },
  {
    "text": "kick that off using the web application and we want to tap access to all the sort of you know application logic that",
    "start": "1524330",
    "end": "1529550"
  },
  {
    "text": "I've been talking about before but we don't want to just sit there squatting on a open socket over port 80 for hours",
    "start": "1529550",
    "end": "1536690"
  },
  {
    "text": "at a time so that happens to this job key mechanism if you're kind of in the top half trying to get your requests",
    "start": "1536690",
    "end": "1543140"
  },
  {
    "text": "finished in a timely manner you can write a memo to the rest of the system to to do work later and we do the actual",
    "start": "1543140",
    "end": "1551090"
  },
  {
    "text": "physical storage of that in a set of Redis clusters I'm calling it blood job queue by the way it's actually multiple",
    "start": "1551090",
    "end": "1556280"
  },
  {
    "text": "queues so you have different sort of levels of service class some performance isolation by running them in different",
    "start": "1556280",
    "end": "1561620"
  },
  {
    "text": "queues different pools of workers and the pools of workers are sitting there actively pulling for work to do they",
    "start": "1561620",
    "end": "1569420"
  },
  {
    "text": "could use pub/sub but they don't yet but actively pulling for work to do and pulling stuff off of there and by the",
    "start": "1569420",
    "end": "1577340"
  },
  {
    "text": "way this is kind of this is one of those things that seems really the fun thing to take away from this slide if at least",
    "start": "1577340",
    "end": "1583460"
  },
  {
    "text": "if you're me or if you ever end up working at slack is that link unfurling which is like what we call it when we do the little cartouche around a link right",
    "start": "1583460",
    "end": "1591140"
  },
  {
    "text": "so you're in some channel you type HTTP colon slash slash you know twitter.com slash some username or whatever after a",
    "start": "1591140",
    "end": "1598010"
  },
  {
    "text": "second or two hopefully a little box shows with you know that person's profile picture and sort of a blurb about what",
    "start": "1598010",
    "end": "1603500"
  },
  {
    "text": "Twitter is and a little bit of their bio and whatever that all happens in this job key mechanism you want that to be",
    "start": "1603500",
    "end": "1610039"
  },
  {
    "text": "there because right sometimes external URLs fail sometimes it takes a long time to curl something else",
    "start": "1610039",
    "end": "1615169"
  },
  {
    "text": "sometimes that sites just under load and if you just retry again in five seconds it'll be just fine but I mentioned this",
    "start": "1615169",
    "end": "1622370"
  },
  {
    "text": "because if I'm sort of stuck on the subway and I'm trying to make sure that the site's still up and I didn't break it with you know the code I just pushed",
    "start": "1622370",
    "end": "1627529"
  },
  {
    "text": "or something like that I just linked infer or something in a message to myself and if I do that I have just",
    "start": "1627529",
    "end": "1632690"
  },
  {
    "text": "exorcised the hell out of everything I've talked about so far right I means that the web app it means that the web's",
    "start": "1632690",
    "end": "1638600"
  },
  {
    "text": "up it means my sequels up it means the message server for my team is working it means that Redis is operating in some",
    "start": "1638600",
    "end": "1644360"
  },
  {
    "text": "sort of vaguely good way it means that job workers are finding stuff from Redis in a timely way and actually doing the work that's on them it means that the",
    "start": "1644360",
    "end": "1650299"
  },
  {
    "text": "messages that go down through the message server that tell you that job is completed and tell you what to show now are actually functioning and so on okay",
    "start": "1650299",
    "end": "1660860"
  },
  {
    "text": "so we've kind of worked our way through our career little picture here we've got the mains we've got the shards we've",
    "start": "1660860",
    "end": "1667640"
  },
  {
    "text": "we've talked about message server we've talked about web app how they're the kind of two big gateways for sort of the bulk you know session initiation and",
    "start": "1667640",
    "end": "1675470"
  },
  {
    "text": "termination and then the actual kind of fine-grained low latency session information so there's a whole lot of",
    "start": "1675470",
    "end": "1682789"
  },
  {
    "start": "1681000",
    "end": "1681000"
  },
  {
    "text": "stuff that I'm omitting here so we don't use ROM isequal all the time memcache is",
    "start": "1682789",
    "end": "1688039"
  },
  {
    "text": "there for a lot of performance-critical queries it's basically providing a materialized view of some queries that are important that keep recurring this",
    "start": "1688039",
    "end": "1695210"
  },
  {
    "text": "is currently totally manual right this is currently totally done by people noticing that oh gosh we spend a lot of time on this API endpoint why is that oh",
    "start": "1695210",
    "end": "1702590"
  },
  {
    "text": "it turns out it's this query is it easy to cache is it safe to cache yes it is and so they build it that way you know",
    "start": "1702590",
    "end": "1709340"
  },
  {
    "text": "the old-fashioned way by hand so there's no kind of magic framework that just automatically caches queries for you yet",
    "start": "1709340",
    "end": "1715149"
  },
  {
    "text": "I didn't talk about a service that we call CVS for the computer data service one of the as the the essence lacks",
    "start": "1715149",
    "end": "1722480"
  },
  {
    "text": "backronym all right so after slack was founded our founder Stewart Butterfield made up the acronym searchable link to",
    "start": "1722480",
    "end": "1729500"
  },
  {
    "text": "archive of company knowledge but honestly slack was just a cool name and that was plausible backronym for it but haven't",
    "start": "1729500",
    "end": "1736879"
  },
  {
    "text": "talked about search at all yet we do search and it involves search quality and that involves the sort of usual",
    "start": "1736879",
    "end": "1744169"
  },
  {
    "text": "pipeline of search quality tools and m/l models and weights for linear models and",
    "start": "1744169",
    "end": "1749809"
  },
  {
    "text": "things like that are currently provided by the cdf thing over a thrift interface we're using it for more and more things it's the bridge between sort of stuff",
    "start": "1749809",
    "end": "1757459"
  },
  {
    "text": "that we have to construct in our data warehouse in a batch way and real time services I didn't talk to you but you",
    "start": "1757459",
    "end": "1764509"
  },
  {
    "text": "are rate limiting a lot of it there are lots of little pieces of this picture that I drew where if you poke them hard enough really terrible things will",
    "start": "1764509",
    "end": "1770719"
  },
  {
    "text": "happen so a lot of those things are guarded by if you know some version of a finger and the wind for what's a",
    "start": "1770719",
    "end": "1776449"
  },
  {
    "text": "reasonable rate to use them at and if we start exceeding that we shed load and start alerting people and by the way the",
    "start": "1776449",
    "end": "1783919"
  },
  {
    "text": "quick back the quick version of the the nickel sketch of the solar infrastructure is that we use solar its",
    "start": "1783919",
    "end": "1789679"
  },
  {
    "text": "power and search those search indices are updated in real time by job queue jobs because solar itself sometimes is",
    "start": "1789679",
    "end": "1795379"
  },
  {
    "text": "sticky and sometimes gets under load and it's team partitioned which is a complicated choice but it sort of fits",
    "start": "1795379",
    "end": "1801679"
  },
  {
    "text": "in a framework of lots of the other team partitioning choices we'll be talking about so feel free to press me on this",
    "start": "1801679",
    "end": "1807829"
  },
  {
    "text": "if you're curious about more later so there are bunch of cool things that fall",
    "start": "1807829",
    "end": "1813589"
  },
  {
    "start": "1809000",
    "end": "1809000"
  },
  {
    "text": "out of this the way that we've built slack so far one of the unifying themes",
    "start": "1813589",
    "end": "1818719"
  },
  {
    "text": "that's a little unusual if you're coming from sort of a scale out consumer-oriented backend is that there's been team prove",
    "start": "1818719",
    "end": "1825319"
  },
  {
    "text": "it partitioning as a pretty pervasive decision and as long as teams are sort of the dimension you're scaling along",
    "start": "1825319",
    "end": "1831049"
  },
  {
    "text": "right as long as that's kind of how you're growing this works really well this lets you scale teams really really easily so if you ever go to slack comm",
    "start": "1831049",
    "end": "1837889"
  },
  {
    "text": "and you sign up for a team we're essentially provisioning an instance of this little box in Aero diagram I keep",
    "start": "1837889",
    "end": "1843799"
  },
  {
    "text": "showing right we find you some shard to fit your team on we slap it there we",
    "start": "1843799",
    "end": "1848899"
  },
  {
    "text": "find some message server that seems to have some spare capacity we just tell you that's the message server that you're going to be using we write a row",
    "start": "1848899",
    "end": "1854479"
  },
  {
    "text": "out to the mains that says hey this team exists here's its domain name here's its name and a few other sort of pieces of metadata pointers to which shard and",
    "start": "1854479",
    "end": "1861289"
  },
  {
    "text": "message server shard and so on it uses and we're golden and you know slack unlike a lot of the",
    "start": "1861289",
    "end": "1867049"
  },
  {
    "text": "a lot of sort of recent hot mass adoption consumer products we actually",
    "start": "1867049",
    "end": "1872149"
  },
  {
    "text": "charge our customers right people actually pay us money and so this is actually a fairly nice layer of",
    "start": "1872149",
    "end": "1877249"
  },
  {
    "text": "indirection to have from that point of view right if you have an angry customer who you know probably is angry because",
    "start": "1877249",
    "end": "1883009"
  },
  {
    "text": "there's such great users of your product right they're probably angry because they use you a lot or they have a lot of users I was having a bad time of things",
    "start": "1883009",
    "end": "1889489"
  },
  {
    "text": "being able to just say okay we'll put you on some nice fire-breathing platinum coated hardware is a nice economically",
    "start": "1889489",
    "end": "1896659"
  },
  {
    "text": "viable store decision to make okay so",
    "start": "1896659",
    "end": "1902929"
  },
  {
    "text": "let me critique this not all is is roses",
    "start": "1902929",
    "end": "1908450"
  },
  {
    "text": "for us right now we have a number of challenges like everybody else and a lot of these challenges do arise from sort",
    "start": "1908450",
    "end": "1913639"
  },
  {
    "text": "of some decisions that we made in this architecture so we'll walk through a few",
    "start": "1913639",
    "end": "1919429"
  },
  {
    "text": "scenarios or on the system that I've just outlined which is and this isn't like some weird punchline by the way like that really is how slack works so",
    "start": "1919429",
    "end": "1927470"
  },
  {
    "text": "I'll walk you through a few scenarios that are difficult to deal with with this kind of infrastructure the means",
    "start": "1927470",
    "end": "1935239"
  },
  {
    "start": "1932000",
    "end": "1932000"
  },
  {
    "text": "you might have wondered why I mentioned them it seemed like sort of a kind of detail you might want to skip there a",
    "start": "1935239",
    "end": "1941359"
  },
  {
    "text": "database there they're a pair of databases but they're still a database and terrible things can happen to them",
    "start": "1941359",
    "end": "1947210"
  },
  {
    "text": "and they turn out to be a single point of failure I've been talking about RTM start a lot and emphasizing how it's",
    "start": "1947210",
    "end": "1953090"
  },
  {
    "text": "this really big bulky thing that kind of tells you everything you need to know about your team that turns out to be",
    "start": "1953090",
    "end": "1958340"
  },
  {
    "text": "really messy for large teams if you are a thousand people who share an office together and the people doing sewer work",
    "start": "1958340",
    "end": "1966379"
  },
  {
    "text": "on the street outside your office today happen to cut through your fiber line and people get things working again at 3:00 p.m. and all thousand of you try to",
    "start": "1966379",
    "end": "1972919"
  },
  {
    "text": "reconnect at the same millisecond that also turns out to be really difficult for this infrastructure to handle and",
    "start": "1972919",
    "end": "1979960"
  },
  {
    "start": "1979000",
    "end": "1979000"
  },
  {
    "text": "just sort of diving into this some more you might think well you know the man's sure like it seems like a single point",
    "start": "1979960",
    "end": "1985220"
  },
  {
    "text": "of failure logically but their two physical machines what's the big deal it's true that if one of the mains fails its partners gonna take over if both if",
    "start": "1985220",
    "end": "1993440"
  },
  {
    "text": "both of them fail well we've wrapped a lot of memcache around these things so certain number of people are still going",
    "start": "1993440",
    "end": "1998960"
  },
  {
    "text": "to be able to login but as soon as they're down the set of people who are actually able logging to",
    "start": "1998960",
    "end": "2004000"
  },
  {
    "text": "slack is sort of dwindling quickly so if you're not a hidden memcache for your",
    "start": "2004000",
    "end": "2009040"
  },
  {
    "text": "team's row from the mains slacks essentially down for you and this might sound really far-fetched because you",
    "start": "2009040",
    "end": "2015250"
  },
  {
    "text": "know you've already sort of sustained one failure you said they're in two different data centers like why did the other one fail well you know how many",
    "start": "2015250",
    "end": "2021010"
  },
  {
    "text": "people have had the experience of trying to sort of protect a system by replicating it and have the load be",
    "start": "2021010",
    "end": "2026080"
  },
  {
    "text": "contagious right so those kinds of scenarios where the reason that one of them failed was because it was under too",
    "start": "2026080",
    "end": "2031150"
  },
  {
    "text": "much load well now you have twice as much load on the other half and that one's probably not long for this world so this has happened the worst sort of",
    "start": "2031150",
    "end": "2038530"
  },
  {
    "text": "outage in in terms of sort of affected users in slacks history was almost a",
    "start": "2038530",
    "end": "2043540"
  },
  {
    "text": "year ago on November 23rd and was of 2015 and was an instance of mains",
    "start": "2043540",
    "end": "2049480"
  },
  {
    "text": "failures so this is still something that keeps us up at night I talked about our",
    "start": "2049480",
    "end": "2056860"
  },
  {
    "text": "team start sort of being big let me put a finer point on it it's not just big it's actually quadratic so as you add a",
    "start": "2056860",
    "end": "2063490"
  },
  {
    "text": "new user to your team there is some probability that that user is also going to add a channel and that the users that",
    "start": "2063490",
    "end": "2069550"
  },
  {
    "text": "are already there are going to join that channel so it turns out channel membership is naturally quadratic in team size right you sort of have a",
    "start": "2069550",
    "end": "2077280"
  },
  {
    "text": "rectangle that's M channels high and end users high and it's moving up into the right getting bigger quadratically every",
    "start": "2077280",
    "end": "2084700"
  },
  {
    "text": "time you add people to your team so if you're in a big team we're sending you a quadratic chunk of data when you start a",
    "start": "2084700",
    "end": "2090760"
  },
  {
    "text": "session and this was sort of hard to notice initially just cuz the constant factors are pretty small but you start",
    "start": "2090760",
    "end": "2096398"
  },
  {
    "text": "getting into the thousands and tens of thousands this becomes really noticeable and making this even worse as sort of",
    "start": "2096399",
    "end": "2103600"
  },
  {
    "text": "that mastery connect scenario so imagine we do have thousands of people each of",
    "start": "2103600",
    "end": "2109660"
  },
  {
    "text": "them doing these order of N squared RT M start operations there's kind of n cubed load on the system and this decision",
    "start": "2109660",
    "end": "2117760"
  },
  {
    "text": "that we made of focusing teams on shards means that that n cubed load isn't spread across a nice ocean of sort of",
    "start": "2117760",
    "end": "2123610"
  },
  {
    "text": "cloud capacity it's concentrated on that single pair of of databases that constitute this particular shards master",
    "start": "2123610",
    "end": "2130600"
  },
  {
    "text": "master pair so we're just gonna lay down and die it's a bummer it turns out though it all",
    "start": "2130600",
    "end": "2137200"
  },
  {
    "text": "ends here their jigs up if you guys like you know have a job for me I'm pretty",
    "start": "2137200",
    "end": "2142630"
  },
  {
    "text": "smart I'm good at programming computers sometimes no no of course not",
    "start": "2142630",
    "end": "2148300"
  },
  {
    "text": "of course not we're not giving up there don't worry never so with the mains",
    "start": "2148300",
    "end": "2154650"
  },
  {
    "start": "2152000",
    "end": "2152000"
  },
  {
    "text": "we're very lucky so currently they're my sequel like everything else there's essentially another instance of that of",
    "start": "2154650",
    "end": "2160240"
  },
  {
    "text": "that sort of my sequel master master pair of design pattern they do very",
    "start": "2160240",
    "end": "2166150"
  },
  {
    "text": "simple queries against the mains and very simple updates against the mains it's almost the updates are almost always adding a row or modifying an",
    "start": "2166150",
    "end": "2172120"
  },
  {
    "text": "existing row the queries are always point queries so you don't need some",
    "start": "2172120",
    "end": "2177250"
  },
  {
    "text": "incredibly special properties or some incredibly strong properties from you know pick your favorite scale out",
    "start": "2177250",
    "end": "2183490"
  },
  {
    "text": "storage engine to replace the mains with why hasn't happened already well it hasn't happened already in part because",
    "start": "2183490",
    "end": "2189670"
  },
  {
    "text": "we've gotten really good at protecting the mains through a combination of memcache and the kind of rate limiting I",
    "start": "2189670",
    "end": "2195250"
  },
  {
    "text": "was describing earlier but also because it's just a really hard thing to change",
    "start": "2195250",
    "end": "2200520"
  },
  {
    "text": "when we finally kind of work up the nerve to do this it's going to be a very difficult and delicate operation to do",
    "start": "2200520",
    "end": "2207100"
  },
  {
    "text": "it in a way that doesn't actually take all of slack down and we have ideas about how to do that of course you know",
    "start": "2207100",
    "end": "2213100"
  },
  {
    "text": "well you know T the rights and double-reed and do you know run the whole playbook for how you deploy stateful services that are scary it just",
    "start": "2213100",
    "end": "2220420"
  },
  {
    "text": "hasn't bubbled to the top of our list of priorities yet a little more to say",
    "start": "2220420",
    "end": "2226720"
  },
  {
    "start": "2224000",
    "end": "2224000"
  },
  {
    "text": "about our team start for large teams so first of all partly incremental work has just been astonishingly successful at this so even though there's this like",
    "start": "2226720",
    "end": "2233470"
  },
  {
    "text": "bummer kind of big o story about it being quadratic the actual distribution of latency is here is not unacceptable",
    "start": "2233470",
    "end": "2239740"
  },
  {
    "text": "p95 is around 221 milliseconds right so barely perceptible p95 is you know well",
    "start": "2239740",
    "end": "2245410"
  },
  {
    "text": "over half a second but we're not you know with that N squared there you might think that there are people sitting there you know growing old while they",
    "start": "2245410",
    "end": "2250840"
  },
  {
    "text": "try to connect to slack and that doesn't seem to be happening mostly and we're in",
    "start": "2250840",
    "end": "2256420"
  },
  {
    "text": "the process right now of actually changing the story around the client architecture I've been telling you right so instead of having a complete view of",
    "start": "2256420",
    "end": "2262390"
  },
  {
    "text": "the we're in the process of migrating all of our clients and there's several of them and they're in different code bases to",
    "start": "2262390",
    "end": "2268810"
  },
  {
    "text": "be able to understand a partial view and give you separate api's that let you do partial queries of channel membership",
    "start": "2268810",
    "end": "2274390"
  },
  {
    "text": "and I'm using the channel membership example that's really easy to understand but that kind of quadratus it e as you",
    "start": "2274390",
    "end": "2280060"
  },
  {
    "text": "add users keeps popping up in lots of natural places my fairy example this is just emojis right so slack lets you add",
    "start": "2280060",
    "end": "2285970"
  },
  {
    "text": "custom emojis you can name an emoji give it a little 32 by 32 thing it might even be animated and it's relatively natural",
    "start": "2285970",
    "end": "2292690"
  },
  {
    "text": "as teams grow to like go through this life cycle where they kind of have emoji bloat and then some administrator decides to clamp down on it or some sort",
    "start": "2292690",
    "end": "2299260"
  },
  {
    "text": "of no fun person says hey this is work why do we have all these like animated emojis of parrots and but until you",
    "start": "2299260",
    "end": "2307240"
  },
  {
    "text": "reach that point like emojis are also one of these kind of quadratic things and I spent a bunch of time looking at emoji performance when I first started",
    "start": "2307240",
    "end": "2312760"
  },
  {
    "text": "back in January and then I masse reconnects I'm I get to introduce a new",
    "start": "2312760",
    "end": "2319060"
  },
  {
    "start": "2313000",
    "end": "2313000"
  },
  {
    "text": "service that we're calling flannel and I keep trying to come up with some like clever name for what the what flannel",
    "start": "2319060",
    "end": "2324910"
  },
  {
    "text": "means like some sort of pun on channel or like maybe like Spanish you know Mexican desserts like the flan or something we've got",
    "start": "2324910",
    "end": "2330520"
  },
  {
    "text": "nothing it's just named flannel I'm sorry and what is it well flannel is a nap level as an",
    "start": "2330520",
    "end": "2336460"
  },
  {
    "text": "application aware edge cash right so it's an edge cash that let's unpack that it's a cash so it has some of the",
    "start": "2336460",
    "end": "2342490"
  },
  {
    "text": "information that we need to start and run these real-time operations it knows about slack or it's specific to slack",
    "start": "2342490",
    "end": "2348940"
  },
  {
    "text": "it's not some generic thing it's not operating on sort of arbitrary restful things or something it knows that the",
    "start": "2348940",
    "end": "2354310"
  },
  {
    "text": "thing that it's trying to do is accelerate slack connections and sessions and we don't necessarily run it",
    "start": "2354310",
    "end": "2359740"
  },
  {
    "text": "that close to the data center we're running it on you know hopefully nice gear with good network connectivity but we'd like to be able to run this you",
    "start": "2359740",
    "end": "2365890"
  },
  {
    "text": "know in a closet that we're renting from somewhere far around the world hopefully so I sort of before a picture of the",
    "start": "2365890",
    "end": "2374380"
  },
  {
    "text": "real time part of the stack looked like this and we're in the process of changing its that it looks a little more",
    "start": "2374380",
    "end": "2380380"
  },
  {
    "text": "like this so a couple of observations about this first of all this looks like a really silly change to be making right",
    "start": "2380380",
    "end": "2386500"
  },
  {
    "text": "I've added a hop in a layer of indirection presumably we have to pay money for those computers you know why are we happy about that well",
    "start": "2386500",
    "end": "2394710"
  },
  {
    "text": "that layer of indirection is doing a couple of things for us first of all it's keeping load off of the actual web",
    "start": "2394990",
    "end": "2402440"
  },
  {
    "text": "back-end so if a lot of the functions that sort of RT M start used to take up are now happening when you connect to flannel we're actually able to serve",
    "start": "2402440",
    "end": "2410090"
  },
  {
    "text": "that you know in a way that scales out a little more straightforwardly you notice there's two of them right so we can",
    "start": "2410090",
    "end": "2415340"
  },
  {
    "text": "actually scale edge capacity for flannel separately from scaling the back end all",
    "start": "2415340",
    "end": "2420560"
  },
  {
    "text": "right so we don't actually have to make some big painful migration to scale out all the shards for instance right we",
    "start": "2420560",
    "end": "2426650"
  },
  {
    "text": "don't have to find you know we don't have migrated to MongoDB or something like that which would actually be a challenge by the way I didn't kind of",
    "start": "2426650",
    "end": "2432230"
  },
  {
    "text": "get too deep into this but we really do use sequel the database engine does work for us we're actually relying on the",
    "start": "2432230",
    "end": "2438590"
  },
  {
    "text": "query planner to be smart there are joins and stuff right we're not using it like a document store so being able to",
    "start": "2438590",
    "end": "2445370"
  },
  {
    "text": "cache the application level results of that throw closer to the user it logically provides a nicer place to scale out a little bit and this is not",
    "start": "2445370",
    "end": "2453620"
  },
  {
    "start": "2453000",
    "end": "2453000"
  },
  {
    "text": "all pie in the sky I did an engineering blog posts like back in spring about how we were planning to do this at that time",
    "start": "2453620",
    "end": "2459800"
  },
  {
    "text": "we were calling flannel slack D it's in its creator since then it's actually gotten started on it want to call it",
    "start": "2459800",
    "end": "2465410"
  },
  {
    "text": "flannel so we're calling it flannel and this this thing actually exists so slacks internal team the team that we",
    "start": "2465410",
    "end": "2472460"
  },
  {
    "text": "actually all live off of all 650 slack employees are using it there are a few other teams that were using it for",
    "start": "2472460",
    "end": "2478040"
  },
  {
    "text": "because it sort of addresses really critical problems that they're experiencing and with any luck it's coming to you real soon now as a version",
    "start": "2478040",
    "end": "2484880"
  },
  {
    "text": "of these slides that's kind of was premature and jinx did so but this is",
    "start": "2484880",
    "end": "2490190"
  },
  {
    "text": "not sort of a you know sometime in 2017 when we get to it this is real code that we're in the process of sort of figuring",
    "start": "2490190",
    "end": "2495230"
  },
  {
    "text": "out how we're gonna deploy okay then so",
    "start": "2495230",
    "end": "2500660"
  },
  {
    "text": "let's take a little breath here think about some of the things we learned it",
    "start": "2500660",
    "end": "2508460"
  },
  {
    "start": "2506000",
    "end": "2506000"
  },
  {
    "text": "pains me to highlight this but of course there's a lot going on that I wasn't able to go into here I'd be incompetent",
    "start": "2508460",
    "end": "2515510"
  },
  {
    "text": "to answer a lot of interesting questions about the client technology but we do have clients and they're complicated software to you know if you look at sort",
    "start": "2515510",
    "end": "2522230"
  },
  {
    "text": "of the distributed system that is slack in terms of the number of cores the amount of storage use the number",
    "start": "2522230",
    "end": "2528200"
  },
  {
    "text": "memory you know the flops the bandwidth the vast majority of it is in phones and laptops not in computers that we operate",
    "start": "2528200",
    "end": "2533930"
  },
  {
    "text": "or write you know are able to administer we do voice calls there's a whole bunch",
    "start": "2533930",
    "end": "2540980"
  },
  {
    "text": "of infrastructure on the back end to make voice calls work well and a bunch of Technology and clients also to make voice calls work well and there were a",
    "start": "2540980",
    "end": "2547250"
  },
  {
    "text": "bunch of interesting trade-offs there I haven't told you how we backing this stuff up how any of this information ends up in a data warehouse I very",
    "start": "2547250",
    "end": "2554630"
  },
  {
    "text": "briefly thumbnail sketch search Ivan talk about how we deploy code we do that about 40 times a day to the web",
    "start": "2554630",
    "end": "2559670"
  },
  {
    "text": "application and the infrastructure that supports that and lets us do that with confidence and lets us convince ourselves that we're not breaking tests",
    "start": "2559670",
    "end": "2565579"
  },
  {
    "text": "and that you know the core workflows inside of slack still work with all those changes to enable that kind of",
    "start": "2565579",
    "end": "2571250"
  },
  {
    "text": "high velocity is is itself very interesting monitoring alerting is also a critical part of running slack so you",
    "start": "2571250",
    "end": "2578720"
  },
  {
    "text": "know there's a really rich kind of smorgasbord of stuff that I could be talking about but it seemed like the the",
    "start": "2578720",
    "end": "2584390"
  },
  {
    "text": "interest gauge for people who want to talk to me about slack are usually more interested in sort of this basic kind of you know what is the 100,000 foot",
    "start": "2584390",
    "end": "2590960"
  },
  {
    "text": "picture view of it but there are many many careers worth of stuff to learn and do and problems to solve here so we did",
    "start": "2590960",
    "end": "2602660"
  },
  {
    "text": "the hundred thousand foot view as promised we talked a little bit about our big PHP monolith and why you",
    "start": "2602660",
    "end": "2608960"
  },
  {
    "text": "shouldn't hold that against us if you are currently inclined to we talked about the unusual way we use my sequel well we've kind of used my sequel to",
    "start": "2608960",
    "end": "2615319"
  },
  {
    "text": "make an eventually consistent store that's highly available for rights under failure talked about how our real-time",
    "start": "2615319",
    "end": "2621200"
  },
  {
    "text": "stack works and how we defer work we talked about a bunch of challenges we faced a lot of them around sort of how",
    "start": "2621200",
    "end": "2627050"
  },
  {
    "text": "slow reconnects are and RTM start and the fact that failures and reconnections are often correlated in time and we need",
    "start": "2627050",
    "end": "2632660"
  },
  {
    "text": "to handle that and we got to explain a little bit about flannel which is a big part of our solution to that story so",
    "start": "2632660",
    "end": "2641150"
  },
  {
    "text": "this is work in progress there's a lot to do there's contact info for me on the slide obviously like you know I would be",
    "start": "2641150",
    "end": "2648319"
  },
  {
    "text": "remiss if I didn't mention that we're hiring and with that I thank you for your time I'd be happy to take questions",
    "start": "2648319",
    "end": "2656079"
  },
  {
    "text": "okay so if anyone has questions please raise your hand and then we'll hand out",
    "start": "2663460",
    "end": "2669410"
  },
  {
    "text": "Mikey all right what happens when you",
    "start": "2669410",
    "end": "2674420"
  },
  {
    "text": "get the third data center how was the active active and replication work in that case yeah so one of the interesting",
    "start": "2674420",
    "end": "2680990"
  },
  {
    "text": "things about this master master thing is there's actually no obvious way to go from N equals 2 to N equals 3 and the",
    "start": "2680990",
    "end": "2686540"
  },
  {
    "text": "answer is that is one of the like bridges that we actually need to cross so a current possible answer to this is",
    "start": "2686540",
    "end": "2692030"
  },
  {
    "text": "that we just sort of go more conventional route and do master/slave so maybe there is a right head data",
    "start": "2692030",
    "end": "2697910"
  },
  {
    "text": "center and writes just have to make their way back to the right capital of the world maybe we can have that right",
    "start": "2697910",
    "end": "2704330"
  },
  {
    "text": "be per shard and we try to make it so that you know you're geographically close to the right head for your for",
    "start": "2704330",
    "end": "2709850"
  },
  {
    "text": "your particular shard I could speculate we haven't really built it yet but it's a solid observation that",
    "start": "2709850",
    "end": "2716780"
  },
  {
    "text": "there's not a totally obvious way to sort of make the master master stuff work if you're thinking why can't you just kind of make a ring of three and",
    "start": "2716780",
    "end": "2722300"
  },
  {
    "text": "say you know here's a B and C a replays to B be replaced to CC replays to a it turns out that doesn't work and and ask",
    "start": "2722300",
    "end": "2729950"
  },
  {
    "text": "your local my sequel expert if you're curious about why okay so the bin logs",
    "start": "2729950",
    "end": "2735170"
  },
  {
    "text": "don't get replayed so they don't echo forever so you the one from a doesn't make it to C thanks for this great",
    "start": "2735170",
    "end": "2741770"
  },
  {
    "text": "presentation I have a question about how do you handle hot spot for your charts",
    "start": "2741770",
    "end": "2747440"
  },
  {
    "text": "yeah great so the question is how do you handle hot spots for your shards currently we handle it by alerting and",
    "start": "2747440",
    "end": "2753320"
  },
  {
    "text": "having people scramble to split or shard the top and if that doesn't work we we",
    "start": "2753320",
    "end": "2758720"
  },
  {
    "text": "handle it by paying for even fancier hardware to run the shard on and by hiring you know hopefully smart people",
    "start": "2758720",
    "end": "2765440"
  },
  {
    "text": "like yourself to come work for us and come up with a solution that's going to work better and be more automated and",
    "start": "2765440",
    "end": "2772060"
  },
  {
    "text": "hopefully not break everything about the application in the process does that answer your question",
    "start": "2772060",
    "end": "2778650"
  },
  {
    "text": "all right honesty yes so smoking so you",
    "start": "2778650",
    "end": "2785220"
  },
  {
    "text": "didn't think about security so lots of teams shared lots of documents through slack and maybe some confidential",
    "start": "2785220",
    "end": "2790920"
  },
  {
    "text": "information like bats or and stuff like that so how do you make sure that these information lies in your servers and",
    "start": "2790920",
    "end": "2796070"
  },
  {
    "text": "only our team acts as these service not only even your team can have access to these data even if they're wise to see",
    "start": "2796070",
    "end": "2803640"
  },
  {
    "text": "my sequel database or the encrypted message if you encrypt them there's my first question my same question I know",
    "start": "2803640",
    "end": "2810060"
  },
  {
    "text": "that you won't slack to replace the normal email flows between the team so I",
    "start": "2810060",
    "end": "2815220"
  },
  {
    "text": "had this case that one of our team members just left the team and all the information that he wrote to us",
    "start": "2815220",
    "end": "2820280"
  },
  {
    "text": "including descriptions conversations documents that he shared with the team is gone how would that replace the email",
    "start": "2820280",
    "end": "2827760"
  },
  {
    "text": "if it's gone okay that's those are a couple interesting questions the first one said I should say by the way that I'm like",
    "start": "2827760",
    "end": "2833520"
  },
  {
    "text": "not an actual InfoSec professional so my understanding of this stuff is especially secondhand in amateurish",
    "start": "2833520",
    "end": "2838610"
  },
  {
    "text": "however one of the advantages of sort of the team charting approach that we",
    "start": "2838610",
    "end": "2843960"
  },
  {
    "text": "didn't go into too deeply here is that it does make attempts at intrusion a",
    "start": "2843960",
    "end": "2849660"
  },
  {
    "text": "little more legible right so it does make sort of attempts to exfiltrate a",
    "start": "2849660",
    "end": "2854970"
  },
  {
    "text": "team's data or something a little easier to see one of the things that we're is a",
    "start": "2854970",
    "end": "2860040"
  },
  {
    "text": "little opaque from the outside that we're more careful about than some of then I think some of our competitors is",
    "start": "2860040",
    "end": "2866310"
  },
  {
    "text": "that people don't have access to the production environment right I don't have access to the production environment I don't have the you know I",
    "start": "2866310",
    "end": "2871980"
  },
  {
    "text": "can't run queries against the production my sequel shard there is you know glass I can break in case of emergency that",
    "start": "2871980",
    "end": "2878280"
  },
  {
    "text": "enables me to do that for instance but that's obviously heavily audited and the people in our security team have tooling",
    "start": "2878280",
    "end": "2883710"
  },
  {
    "text": "that they refuse to tell me about that they claim is keeping that stuff on lockdown and that's kind of one of the",
    "start": "2883710",
    "end": "2890460"
  },
  {
    "text": "things that's different about a paid product that we're asking people to trust their company's information with in the case the second one where my",
    "start": "2890460",
    "end": "2896460"
  },
  {
    "text": "understanding is basically you're saying that somebody left the team and they kind of took all their information with them when they left the team that is not",
    "start": "2896460",
    "end": "2904320"
  },
  {
    "text": "how I understand the product to be supposed to work right so when when users disappear they still kind of have",
    "start": "2904320",
    "end": "2910590"
  },
  {
    "text": "an identity the product and things like your DM threads with them should still be there",
    "start": "2910590",
    "end": "2916250"
  },
  {
    "text": "files they created should still be there to the best of my understanding and share it in the same places but if you",
    "start": "2916250",
    "end": "2921690"
  },
  {
    "text": "have a repro of this and if you're able to share any details at all you know hit me up and I'll try and dig into what",
    "start": "2921690",
    "end": "2928110"
  },
  {
    "text": "actually happened there one more question great presentation thank you our",
    "start": "2928110",
    "end": "2935220"
  },
  {
    "text": "engineers like engineers happy with PHP so it depends on the engineer the",
    "start": "2935220",
    "end": "2940350"
  },
  {
    "text": "question if you didn't hear it is our slack engineers happy with PHP so it depends on the engineer right and so I'm",
    "start": "2940350",
    "end": "2946020"
  },
  {
    "text": "coming from like 7 years at Facebook so I of course like feel like this is you know the old sword right this is I know",
    "start": "2946020",
    "end": "2951990"
  },
  {
    "text": "exactly what the what the scary parts are and exactly how to use it so it doesn't break when you're coming to it",
    "start": "2951990",
    "end": "2959340"
  },
  {
    "text": "new there's a bunch of things that are actually that are actually surprising I think by and large once they've adapted",
    "start": "2959340",
    "end": "2965430"
  },
  {
    "text": "to our code base in our conventions we're using it well I think most probably wouldn't say they love PHP the",
    "start": "2965430",
    "end": "2971460"
  },
  {
    "text": "programming language but they sure like deploying 40 times a day and it turns out that's there those two are sort of",
    "start": "2971460",
    "end": "2977820"
  },
  {
    "text": "fundamentally in tension in an interesting way so I'll sell my blog post again if you don't mind if you look",
    "start": "2977820",
    "end": "2983520"
  },
  {
    "text": "for taking PHP seriously everyone for coming and another round of applause for",
    "start": "2983520",
    "end": "2991320"
  },
  {
    "text": "you",
    "start": "2991320",
    "end": "2993380"
  }
]