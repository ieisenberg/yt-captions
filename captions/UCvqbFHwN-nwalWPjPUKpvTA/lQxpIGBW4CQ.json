[
  {
    "text": "hello everyone my name is christophe",
    "start": "80",
    "end": "2800"
  },
  {
    "text": "swanka",
    "start": "2800",
    "end": "3679"
  },
  {
    "text": "and welcome to service smash failure",
    "start": "3679",
    "end": "6319"
  },
  {
    "text": "stories at scale",
    "start": "6319",
    "end": "8880"
  },
  {
    "text": "this is where it all began it's the 24th",
    "start": "8880",
    "end": "12080"
  },
  {
    "text": "of june",
    "start": "12080",
    "end": "13080"
  },
  {
    "text": "2019. it's almost midday i am the",
    "start": "13080",
    "end": "16640"
  },
  {
    "text": "engineer on call",
    "start": "16640",
    "end": "18000"
  },
  {
    "text": "and i'm about to carry out the biggest",
    "start": "18000",
    "end": "19840"
  },
  {
    "text": "deployment of my carrier",
    "start": "19840",
    "end": "22000"
  },
  {
    "text": "i've dealt with large systems in the",
    "start": "22000",
    "end": "23920"
  },
  {
    "text": "past but usually",
    "start": "23920",
    "end": "25599"
  },
  {
    "text": "i was responsible for a couple of micro",
    "start": "25599",
    "end": "28320"
  },
  {
    "text": "services",
    "start": "28320",
    "end": "29679"
  },
  {
    "text": "this time is different allegro consists",
    "start": "29679",
    "end": "32960"
  },
  {
    "text": "of around",
    "start": "32960",
    "end": "33760"
  },
  {
    "text": "800 microservices running in",
    "start": "33760",
    "end": "36800"
  },
  {
    "text": "5 000 instances and to carry out this",
    "start": "36800",
    "end": "40079"
  },
  {
    "text": "deployment",
    "start": "40079",
    "end": "41200"
  },
  {
    "text": "i have to redeploy single",
    "start": "41200",
    "end": "44320"
  },
  {
    "text": "one of them my team knows",
    "start": "44320",
    "end": "47360"
  },
  {
    "text": "how things can go south very quickly",
    "start": "47360",
    "end": "50160"
  },
  {
    "text": "when they're not",
    "start": "50160",
    "end": "50879"
  },
  {
    "text": "under control so i've come prepared",
    "start": "50879",
    "end": "55680"
  },
  {
    "text": "i have a panel that allows me to deploy",
    "start": "55680",
    "end": "58399"
  },
  {
    "text": "a specific service",
    "start": "58399",
    "end": "60239"
  },
  {
    "text": "a batch of services or just enable the",
    "start": "60239",
    "end": "63440"
  },
  {
    "text": "deployment with the new version",
    "start": "63440",
    "end": "66159"
  },
  {
    "text": "our service mesh based on envoy and the",
    "start": "66159",
    "end": "69360"
  },
  {
    "text": "home go",
    "start": "69360",
    "end": "70080"
  },
  {
    "text": "ground control plane has been running in",
    "start": "70080",
    "end": "72960"
  },
  {
    "text": "for months",
    "start": "72960",
    "end": "73760"
  },
  {
    "text": "in our dev and test environments and we",
    "start": "73760",
    "end": "76720"
  },
  {
    "text": "are pretty sure",
    "start": "76720",
    "end": "78080"
  },
  {
    "text": "we fix all the problems that we found",
    "start": "78080",
    "end": "80640"
  },
  {
    "text": "there",
    "start": "80640",
    "end": "81600"
  },
  {
    "text": "so everything should be all right yeah",
    "start": "81600",
    "end": "86400"
  },
  {
    "text": "the deployment was going smoothly it",
    "start": "86400",
    "end": "88640"
  },
  {
    "text": "quickly hit",
    "start": "88640",
    "end": "89520"
  },
  {
    "text": "a thousand instances then 2000",
    "start": "89520",
    "end": "93200"
  },
  {
    "text": "and a bit more and more services",
    "start": "93200",
    "end": "96240"
  },
  {
    "text": "were being migrated i've encountered a",
    "start": "96240",
    "end": "99360"
  },
  {
    "text": "couple of small bombs like",
    "start": "99360",
    "end": "101040"
  },
  {
    "text": "reviving at that service and some 500",
    "start": "101040",
    "end": "104320"
  },
  {
    "text": "errors here and there",
    "start": "104320",
    "end": "105600"
  },
  {
    "text": "but overall everything went well",
    "start": "105600",
    "end": "109040"
  },
  {
    "text": "after a couple of hours everything was",
    "start": "109040",
    "end": "111520"
  },
  {
    "text": "done",
    "start": "111520",
    "end": "112320"
  },
  {
    "text": "i felt a big relief the website was up",
    "start": "112320",
    "end": "116079"
  },
  {
    "text": "and running",
    "start": "116079",
    "end": "116880"
  },
  {
    "text": "there were no messages on our emergency",
    "start": "116880",
    "end": "119439"
  },
  {
    "text": "slack channel",
    "start": "119439",
    "end": "120799"
  },
  {
    "text": "everything seems fine but is it",
    "start": "120799",
    "end": "124000"
  },
  {
    "text": "is it really over close",
    "start": "124000",
    "end": "127280"
  },
  {
    "text": "but no cigar the next day we've got some",
    "start": "127280",
    "end": "131039"
  },
  {
    "text": "reports of apps dying",
    "start": "131039",
    "end": "132959"
  },
  {
    "text": "because of out of memory errors some",
    "start": "132959",
    "end": "136160"
  },
  {
    "text": "connections being rejected",
    "start": "136160",
    "end": "138480"
  },
  {
    "text": "and when we found out that we disabled",
    "start": "138480",
    "end": "141520"
  },
  {
    "text": "some parts of our monitoring platform we",
    "start": "141520",
    "end": "144000"
  },
  {
    "text": "had to abort the mission",
    "start": "144000",
    "end": "145520"
  },
  {
    "text": "and roll back so what actually went",
    "start": "145520",
    "end": "150160"
  },
  {
    "text": "wrong with that deployment i will solve",
    "start": "150160",
    "end": "152879"
  },
  {
    "text": "this mystery",
    "start": "152879",
    "end": "153760"
  },
  {
    "text": "in 30 minutes but before i do that",
    "start": "153760",
    "end": "157599"
  },
  {
    "text": "let's focus on how did we get to this",
    "start": "157599",
    "end": "160080"
  },
  {
    "text": "place",
    "start": "160080",
    "end": "162160"
  },
  {
    "text": "to answer that question we have to go",
    "start": "162160",
    "end": "164000"
  },
  {
    "text": "back even further",
    "start": "164000",
    "end": "165360"
  },
  {
    "text": "to the summer of 2018",
    "start": "165360",
    "end": "169120"
  },
  {
    "text": "at that time i'm a relatively new",
    "start": "169120",
    "end": "171840"
  },
  {
    "text": "software engineer in allegro",
    "start": "171840",
    "end": "174160"
  },
  {
    "text": "allegro is the 10th biggest e-commerce",
    "start": "174160",
    "end": "176800"
  },
  {
    "text": "platform in the world",
    "start": "176800",
    "end": "178319"
  },
  {
    "text": "you can buy pretty much everything there",
    "start": "178319",
    "end": "181280"
  },
  {
    "text": "i'm a part of a team",
    "start": "181280",
    "end": "182959"
  },
  {
    "text": "operating at the edge of business",
    "start": "182959",
    "end": "185120"
  },
  {
    "text": "software and the technical platform",
    "start": "185120",
    "end": "187920"
  },
  {
    "text": "we provide libraries and services",
    "start": "187920",
    "end": "191040"
  },
  {
    "text": "that allow other business teams to focus",
    "start": "191040",
    "end": "194560"
  },
  {
    "text": "on developing features",
    "start": "194560",
    "end": "196560"
  },
  {
    "text": "our most prominent responsibility is",
    "start": "196560",
    "end": "199840"
  },
  {
    "text": "service discovery",
    "start": "199840",
    "end": "203040"
  },
  {
    "text": "the mechanism is implemented in a set of",
    "start": "203120",
    "end": "205680"
  },
  {
    "text": "common libraries",
    "start": "205680",
    "end": "207200"
  },
  {
    "text": "so when an application wants to",
    "start": "207200",
    "end": "209120"
  },
  {
    "text": "communicate with another application",
    "start": "209120",
    "end": "211760"
  },
  {
    "text": "it uses a special protocol called",
    "start": "211760",
    "end": "214239"
  },
  {
    "text": "service",
    "start": "214239",
    "end": "216000"
  },
  {
    "text": "the http interceptor that we register",
    "start": "216000",
    "end": "219360"
  },
  {
    "text": "we figure out where that service is",
    "start": "219360",
    "end": "222080"
  },
  {
    "text": "located",
    "start": "222080",
    "end": "222879"
  },
  {
    "text": "by communicating by communicating with",
    "start": "222879",
    "end": "225519"
  },
  {
    "text": "our",
    "start": "225519",
    "end": "226799"
  },
  {
    "text": "discovery backend which is console",
    "start": "226799",
    "end": "230799"
  },
  {
    "text": "and send the traffic to that destination",
    "start": "230799",
    "end": "234480"
  },
  {
    "text": "it will also have to figure it out",
    "start": "234480",
    "end": "236560"
  },
  {
    "text": "figure out things like",
    "start": "236560",
    "end": "238000"
  },
  {
    "text": "should i send this traffic to a canary",
    "start": "238000",
    "end": "240720"
  },
  {
    "text": "instance",
    "start": "240720",
    "end": "241599"
  },
  {
    "text": "is this an isolated environment should i",
    "start": "241599",
    "end": "244799"
  },
  {
    "text": "do weighted load balancing",
    "start": "244799",
    "end": "248319"
  },
  {
    "text": "okay so why are we even thinking about",
    "start": "248319",
    "end": "251200"
  },
  {
    "text": "service mesh",
    "start": "251200",
    "end": "252560"
  },
  {
    "text": "our main pain points today are",
    "start": "252560",
    "end": "255840"
  },
  {
    "text": "to change anything in the routing",
    "start": "255840",
    "end": "257519"
  },
  {
    "text": "mechanism we have to implement that",
    "start": "257519",
    "end": "260160"
  },
  {
    "text": "change in the common library",
    "start": "260160",
    "end": "262160"
  },
  {
    "text": "and then wait for all of the clients to",
    "start": "262160",
    "end": "264880"
  },
  {
    "text": "upgrade",
    "start": "264880",
    "end": "265919"
  },
  {
    "text": "and that can take a lot of time",
    "start": "265919",
    "end": "269600"
  },
  {
    "text": "services that do not use jvm have to",
    "start": "269600",
    "end": "272800"
  },
  {
    "text": "re-implement every change that we do",
    "start": "272800",
    "end": "275520"
  },
  {
    "text": "there in their own libraries and they",
    "start": "275520",
    "end": "278080"
  },
  {
    "text": "have to follow",
    "start": "278080",
    "end": "279280"
  },
  {
    "text": "a microservices contract",
    "start": "279280",
    "end": "282880"
  },
  {
    "text": "and mtls is only implemented on jvm",
    "start": "282880",
    "end": "286639"
  },
  {
    "text": "and we have a growing ecosystem",
    "start": "286639",
    "end": "290400"
  },
  {
    "text": "and we'd like to support some other tech",
    "start": "290400",
    "end": "294840"
  },
  {
    "text": "stacks",
    "start": "294840",
    "end": "296000"
  },
  {
    "text": "knowing all of that we decided that we",
    "start": "296000",
    "end": "298560"
  },
  {
    "text": "want some sort of a service mesh",
    "start": "298560",
    "end": "300320"
  },
  {
    "text": "solution",
    "start": "300320",
    "end": "301360"
  },
  {
    "text": "we have a couple more requirements we",
    "start": "301360",
    "end": "304479"
  },
  {
    "text": "run most of our jobs and applications on",
    "start": "304479",
    "end": "307919"
  },
  {
    "text": "mesos",
    "start": "307919",
    "end": "308880"
  },
  {
    "text": "and our kubernetes adoption is just",
    "start": "308880",
    "end": "311680"
  },
  {
    "text": "starting",
    "start": "311680",
    "end": "313440"
  },
  {
    "text": "we have some applications and jobs",
    "start": "313440",
    "end": "315600"
  },
  {
    "text": "running on vms",
    "start": "315600",
    "end": "316800"
  },
  {
    "text": "so we need to support that as well our",
    "start": "316800",
    "end": "319840"
  },
  {
    "text": "discovery backend is console so we need",
    "start": "319840",
    "end": "322160"
  },
  {
    "text": "to",
    "start": "322160",
    "end": "322639"
  },
  {
    "text": "integrate with it knowing the",
    "start": "322639",
    "end": "326160"
  },
  {
    "text": "requirements and limitations we set out",
    "start": "326160",
    "end": "328400"
  },
  {
    "text": "to evaluate",
    "start": "328400",
    "end": "329680"
  },
  {
    "text": "all of these solutions that are",
    "start": "329680",
    "end": "331280"
  },
  {
    "text": "available on the market",
    "start": "331280",
    "end": "333280"
  },
  {
    "text": "we started with istio it is very popular",
    "start": "333280",
    "end": "336000"
  },
  {
    "text": "and backed by a big company",
    "start": "336000",
    "end": "338000"
  },
  {
    "text": "unfortunately there was no native",
    "start": "338000",
    "end": "341280"
  },
  {
    "text": "support for mises and the council",
    "start": "341280",
    "end": "344080"
  },
  {
    "text": "integration did not scale at that point",
    "start": "344080",
    "end": "346240"
  },
  {
    "text": "in time",
    "start": "346240",
    "end": "347840"
  },
  {
    "text": "next we looked at linkardi but this was",
    "start": "347840",
    "end": "351039"
  },
  {
    "text": "also a pass for",
    "start": "351039",
    "end": "352000"
  },
  {
    "text": "us in version 1 the data plane was",
    "start": "352000",
    "end": "355280"
  },
  {
    "text": "written in scala",
    "start": "355280",
    "end": "356800"
  },
  {
    "text": "so higher memory footprint and gc poses",
    "start": "356800",
    "end": "361199"
  },
  {
    "text": "put us off and the version 2 was",
    "start": "361199",
    "end": "364240"
  },
  {
    "text": "kubernetes only",
    "start": "364240",
    "end": "366880"
  },
  {
    "text": "console connect would play very nicely",
    "start": "366880",
    "end": "369919"
  },
  {
    "text": "with our current setup but due to",
    "start": "369919",
    "end": "372800"
  },
  {
    "text": "limited",
    "start": "372800",
    "end": "374080"
  },
  {
    "text": "control traffic control features we",
    "start": "374080",
    "end": "377440"
  },
  {
    "text": "that meant we couldn't use it",
    "start": "377440",
    "end": "380639"
  },
  {
    "text": "the last thing we looked at was router",
    "start": "380639",
    "end": "383039"
  },
  {
    "text": "by turbine light",
    "start": "383039",
    "end": "384560"
  },
  {
    "text": "labs it was no longer maintained and the",
    "start": "384560",
    "end": "387840"
  },
  {
    "text": "console integration",
    "start": "387840",
    "end": "389039"
  },
  {
    "text": "also didn't scale so",
    "start": "389039",
    "end": "392400"
  },
  {
    "text": "none of the things that we looked at",
    "start": "392400",
    "end": "394720"
  },
  {
    "text": "really fulfilled",
    "start": "394720",
    "end": "396160"
  },
  {
    "text": "all of our needs so we decided to build",
    "start": "396160",
    "end": "399199"
  },
  {
    "text": "our own solution",
    "start": "399199",
    "end": "402080"
  },
  {
    "text": "as the data plane we chose envoy mostly",
    "start": "402080",
    "end": "405039"
  },
  {
    "text": "because of",
    "start": "405039",
    "end": "405919"
  },
  {
    "text": "good performance big and active",
    "start": "405919",
    "end": "408240"
  },
  {
    "text": "community",
    "start": "408240",
    "end": "409360"
  },
  {
    "text": "and hot reloading feature that we needed",
    "start": "409360",
    "end": "411599"
  },
  {
    "text": "for our vms",
    "start": "411599",
    "end": "414000"
  },
  {
    "text": "and we decided to write the control pane",
    "start": "414000",
    "end": "416800"
  },
  {
    "text": "ourselves",
    "start": "416800",
    "end": "417680"
  },
  {
    "text": "we used java control play as our base",
    "start": "417680",
    "end": "420880"
  },
  {
    "text": "and brought all of the features that we",
    "start": "420880",
    "end": "423120"
  },
  {
    "text": "needed in kotlin",
    "start": "423120",
    "end": "424319"
  },
  {
    "text": "and released it in open source as onward",
    "start": "424319",
    "end": "427360"
  },
  {
    "text": "control",
    "start": "427360",
    "end": "429840"
  },
  {
    "text": "we know why we want to build the service",
    "start": "430880",
    "end": "433039"
  },
  {
    "text": "mesh",
    "start": "433039",
    "end": "434000"
  },
  {
    "text": "we know what the requirements are but",
    "start": "434000",
    "end": "437120"
  },
  {
    "text": "how how are we going to do this our",
    "start": "437120",
    "end": "439840"
  },
  {
    "text": "strategy",
    "start": "439840",
    "end": "440639"
  },
  {
    "text": "is quite simple we have to change two",
    "start": "440639",
    "end": "443120"
  },
  {
    "text": "things in our applications",
    "start": "443120",
    "end": "445280"
  },
  {
    "text": "how the app is receiving and sending out",
    "start": "445280",
    "end": "447759"
  },
  {
    "text": "requests",
    "start": "447759",
    "end": "449599"
  },
  {
    "text": "the first part is quite easy when an app",
    "start": "449599",
    "end": "452240"
  },
  {
    "text": "is",
    "start": "452240",
    "end": "452720"
  },
  {
    "text": "deployed there is a hook that registers",
    "start": "452720",
    "end": "456240"
  },
  {
    "text": "it in",
    "start": "456240",
    "end": "457039"
  },
  {
    "text": "console and after that the application",
    "start": "457039",
    "end": "460479"
  },
  {
    "text": "can accept traffic",
    "start": "460479",
    "end": "462960"
  },
  {
    "text": "what we would like to do is to inject",
    "start": "462960",
    "end": "465680"
  },
  {
    "text": "envoy",
    "start": "465680",
    "end": "466400"
  },
  {
    "text": "into that deployment and change the",
    "start": "466400",
    "end": "468800"
  },
  {
    "text": "registration part",
    "start": "468800",
    "end": "470319"
  },
  {
    "text": "and voila now envoy is proxying all of",
    "start": "470319",
    "end": "473520"
  },
  {
    "text": "the incoming traffic",
    "start": "473520",
    "end": "476000"
  },
  {
    "text": "the second part is a bit more",
    "start": "476000",
    "end": "478080"
  },
  {
    "text": "complicated",
    "start": "478080",
    "end": "479440"
  },
  {
    "text": "the most widespread approach is to use",
    "start": "479440",
    "end": "482560"
  },
  {
    "text": "ip tables and route all of the outgoing",
    "start": "482560",
    "end": "485599"
  },
  {
    "text": "traffic",
    "start": "485599",
    "end": "486560"
  },
  {
    "text": "to the proxy but the team that's",
    "start": "486560",
    "end": "489840"
  },
  {
    "text": "responsible for misos but",
    "start": "489840",
    "end": "492400"
  },
  {
    "text": "has had really bad experience with",
    "start": "492400",
    "end": "494160"
  },
  {
    "text": "network isolation there",
    "start": "494160",
    "end": "495919"
  },
  {
    "text": "mostly kernel panics this is a graph i",
    "start": "495919",
    "end": "499759"
  },
  {
    "text": "showed before",
    "start": "499759",
    "end": "500560"
  },
  {
    "text": "illustrating how outgoing requests are",
    "start": "500560",
    "end": "503360"
  },
  {
    "text": "made",
    "start": "503360",
    "end": "504080"
  },
  {
    "text": "we've decided to do this on the",
    "start": "504080",
    "end": "505680"
  },
  {
    "text": "application level",
    "start": "505680",
    "end": "507599"
  },
  {
    "text": "so in our common library we intercept",
    "start": "507599",
    "end": "510319"
  },
  {
    "text": "all of the traffic",
    "start": "510319",
    "end": "511440"
  },
  {
    "text": "just like before and route it to online",
    "start": "511440",
    "end": "514719"
  },
  {
    "text": "and then envoy will know where to send",
    "start": "514719",
    "end": "516560"
  },
  {
    "text": "the request",
    "start": "516560",
    "end": "517919"
  },
  {
    "text": "this has a couple of drawbacks our",
    "start": "517919",
    "end": "520560"
  },
  {
    "text": "clients have to",
    "start": "520560",
    "end": "521760"
  },
  {
    "text": "upgrade once more and other software",
    "start": "521760",
    "end": "524159"
  },
  {
    "text": "stacks have to re-implement it",
    "start": "524159",
    "end": "526480"
  },
  {
    "text": "but it is a relatively small change",
    "start": "526480",
    "end": "530560"
  },
  {
    "text": "to add a proxy to an http client",
    "start": "530560",
    "end": "534080"
  },
  {
    "text": "and this does not prevent us from using",
    "start": "534080",
    "end": "537360"
  },
  {
    "text": "the",
    "start": "537360",
    "end": "537760"
  },
  {
    "text": "transparent approach on kubernetes",
    "start": "537760",
    "end": "541839"
  },
  {
    "text": "so having both incoming and outgoing",
    "start": "541839",
    "end": "544560"
  },
  {
    "text": "traffic go through envoy",
    "start": "544560",
    "end": "546080"
  },
  {
    "text": "we can think about implementing other",
    "start": "546080",
    "end": "547839"
  },
  {
    "text": "things like mtls and airbag rules",
    "start": "547839",
    "end": "552000"
  },
  {
    "text": "now that we know the context we can go",
    "start": "552000",
    "end": "554240"
  },
  {
    "text": "back to the first deployment i described",
    "start": "554240",
    "end": "556320"
  },
  {
    "text": "in the beginning",
    "start": "556320",
    "end": "558080"
  },
  {
    "text": "and the problems that occurred after it",
    "start": "558080",
    "end": "560480"
  },
  {
    "text": "i'm going to group similar problems",
    "start": "560480",
    "end": "563200"
  },
  {
    "text": "together and talk about each group in",
    "start": "563200",
    "end": "565440"
  },
  {
    "text": "detail",
    "start": "565440",
    "end": "566480"
  },
  {
    "text": "i call the first group of problems there",
    "start": "566480",
    "end": "569120"
  },
  {
    "text": "are three types of lies",
    "start": "569120",
    "end": "570959"
  },
  {
    "text": "lies then lies and stats",
    "start": "570959",
    "end": "574800"
  },
  {
    "text": "first i'm going to tackle the memory",
    "start": "574800",
    "end": "576959"
  },
  {
    "text": "issue that was reported",
    "start": "576959",
    "end": "578720"
  },
  {
    "text": "a day after the deployment the",
    "start": "578720",
    "end": "581920"
  },
  {
    "text": "consequence of our setup",
    "start": "581920",
    "end": "584000"
  },
  {
    "text": "is that on-voice memory you set",
    "start": "584000",
    "end": "587200"
  },
  {
    "text": "is a part of the total memory used",
    "start": "587200",
    "end": "590240"
  },
  {
    "text": "by the app before the deployment we",
    "start": "590240",
    "end": "592959"
  },
  {
    "text": "measured",
    "start": "592959",
    "end": "593839"
  },
  {
    "text": "and verified that additional memory",
    "start": "593839",
    "end": "596640"
  },
  {
    "text": "would not cause",
    "start": "596640",
    "end": "597680"
  },
  {
    "text": "any problems so according to onvoice",
    "start": "597680",
    "end": "600959"
  },
  {
    "text": "server memory allocated the biggest",
    "start": "600959",
    "end": "604480"
  },
  {
    "text": "ongoing instance is less than 30",
    "start": "604480",
    "end": "606880"
  },
  {
    "text": "megabytes",
    "start": "606880",
    "end": "608880"
  },
  {
    "text": "but in reality for most apps",
    "start": "608880",
    "end": "612000"
  },
  {
    "text": "it's more than 100 megabytes this was",
    "start": "612000",
    "end": "614880"
  },
  {
    "text": "enough",
    "start": "614880",
    "end": "615440"
  },
  {
    "text": "to tip some of the apps over the edge",
    "start": "615440",
    "end": "618399"
  },
  {
    "text": "and cause out of memory errors",
    "start": "618399",
    "end": "620880"
  },
  {
    "text": "it turned out that there was a proposal",
    "start": "620880",
    "end": "623600"
  },
  {
    "text": "in envoy",
    "start": "623600",
    "end": "624480"
  },
  {
    "text": "to report memoir statistics for all",
    "start": "624480",
    "end": "627440"
  },
  {
    "text": "sub-systems",
    "start": "627440",
    "end": "628399"
  },
  {
    "text": "but it was never fully finished",
    "start": "628399",
    "end": "632079"
  },
  {
    "text": "before i tag the next thing i talk about",
    "start": "632079",
    "end": "634560"
  },
  {
    "text": "the next thing",
    "start": "634560",
    "end": "635440"
  },
  {
    "text": "i have to explain what a hot restart is",
    "start": "635440",
    "end": "638079"
  },
  {
    "text": "for those of you",
    "start": "638079",
    "end": "639040"
  },
  {
    "text": "unfamiliar with onboard a hot restart is",
    "start": "639040",
    "end": "641920"
  },
  {
    "text": "a",
    "start": "641920",
    "end": "642160"
  },
  {
    "text": "full binary reload of envoy",
    "start": "642160",
    "end": "645440"
  },
  {
    "text": "without losing any connections it is",
    "start": "645440",
    "end": "648560"
  },
  {
    "text": "very useful for our vms because we",
    "start": "648560",
    "end": "651680"
  },
  {
    "text": "can't afford any downtime in critical",
    "start": "651680",
    "end": "654079"
  },
  {
    "text": "systems that we are running there",
    "start": "654079",
    "end": "657040"
  },
  {
    "text": "after investigating that feature in our",
    "start": "657040",
    "end": "660560"
  },
  {
    "text": "setup",
    "start": "660560",
    "end": "661200"
  },
  {
    "text": "we found out that there are some gauges",
    "start": "661200",
    "end": "663920"
  },
  {
    "text": "that",
    "start": "663920",
    "end": "664399"
  },
  {
    "text": "reported inconsistent active connection",
    "start": "664399",
    "end": "667760"
  },
  {
    "text": "values",
    "start": "667760",
    "end": "668640"
  },
  {
    "text": "after a hot rest up this troubled us for",
    "start": "668640",
    "end": "671440"
  },
  {
    "text": "a bit",
    "start": "671440",
    "end": "672079"
  },
  {
    "text": "because we thought that we were leaking",
    "start": "672079",
    "end": "674160"
  },
  {
    "text": "connections somewhere",
    "start": "674160",
    "end": "676399"
  },
  {
    "text": "but it turned out that it actually was a",
    "start": "676399",
    "end": "679360"
  },
  {
    "text": "bug",
    "start": "679360",
    "end": "680079"
  },
  {
    "text": "so we reported it and i'm glad to tell",
    "start": "680079",
    "end": "682560"
  },
  {
    "text": "you that",
    "start": "682560",
    "end": "683200"
  },
  {
    "text": "it's been fixed in the newest version of",
    "start": "683200",
    "end": "686839"
  },
  {
    "text": "outboy",
    "start": "686839",
    "end": "688000"
  },
  {
    "text": "so what have you learned from that it's",
    "start": "688000",
    "end": "690880"
  },
  {
    "text": "important to measure",
    "start": "690880",
    "end": "692320"
  },
  {
    "text": "and check critical things by yourself do",
    "start": "692320",
    "end": "695360"
  },
  {
    "text": "not completely trust a new system",
    "start": "695360",
    "end": "697839"
  },
  {
    "text": "measure critical metrics at the os level",
    "start": "697839",
    "end": "701120"
  },
  {
    "text": "if you can the next section",
    "start": "701120",
    "end": "704480"
  },
  {
    "text": "describes how envoy changes the way",
    "start": "704480",
    "end": "707519"
  },
  {
    "text": "requests",
    "start": "707519",
    "end": "708399"
  },
  {
    "text": "and connections are made",
    "start": "708399",
    "end": "711680"
  },
  {
    "text": "so when there is a proxy when there is",
    "start": "711680",
    "end": "714880"
  },
  {
    "text": "no proxy in between the services",
    "start": "714880",
    "end": "717120"
  },
  {
    "text": "and you're trying to make a new",
    "start": "717120",
    "end": "718800"
  },
  {
    "text": "connection and there's nothing",
    "start": "718800",
    "end": "721279"
  },
  {
    "text": "uh listening on the other end you will",
    "start": "721279",
    "end": "724240"
  },
  {
    "text": "get",
    "start": "724240",
    "end": "724720"
  },
  {
    "text": "a connection refuse but when there is a",
    "start": "724720",
    "end": "728160"
  },
  {
    "text": "proxy in between",
    "start": "728160",
    "end": "729519"
  },
  {
    "text": "you'll always be able to establish the",
    "start": "729519",
    "end": "731440"
  },
  {
    "text": "connection to the proxy",
    "start": "731440",
    "end": "733839"
  },
  {
    "text": "but the proxy will return 503 error with",
    "start": "733839",
    "end": "737120"
  },
  {
    "text": "no healthy upstream this is the most",
    "start": "737120",
    "end": "740399"
  },
  {
    "text": "basic change that occurs when you",
    "start": "740399",
    "end": "742880"
  },
  {
    "text": "introduce a proxy",
    "start": "742880",
    "end": "744720"
  },
  {
    "text": "let's dig a little bit deeper what are",
    "start": "744720",
    "end": "747360"
  },
  {
    "text": "some other things that can change",
    "start": "747360",
    "end": "749839"
  },
  {
    "text": "default time modes for example when",
    "start": "749839",
    "end": "752399"
  },
  {
    "text": "service a",
    "start": "752399",
    "end": "753279"
  },
  {
    "text": "wants to communicate with service b and",
    "start": "753279",
    "end": "755839"
  },
  {
    "text": "sets",
    "start": "755839",
    "end": "756320"
  },
  {
    "text": "a 2 minute timeout on the response",
    "start": "756320",
    "end": "759680"
  },
  {
    "text": "and the service b response after 30",
    "start": "759680",
    "end": "762399"
  },
  {
    "text": "seconds",
    "start": "762399",
    "end": "763200"
  },
  {
    "text": "or 90 seconds everything is alright",
    "start": "763200",
    "end": "766480"
  },
  {
    "text": "when you throw in a proxy in the middle",
    "start": "766480",
    "end": "768800"
  },
  {
    "text": "of it and it has",
    "start": "768800",
    "end": "770240"
  },
  {
    "text": "a different timeout set then the request",
    "start": "770240",
    "end": "773920"
  },
  {
    "text": "will fail",
    "start": "773920",
    "end": "775360"
  },
  {
    "text": "and the proxy will return an error",
    "start": "775360",
    "end": "778560"
  },
  {
    "text": "when we were back on production we",
    "start": "778560",
    "end": "781839"
  },
  {
    "text": "learned that there were some services",
    "start": "781839",
    "end": "784240"
  },
  {
    "text": "that take",
    "start": "784240",
    "end": "784880"
  },
  {
    "text": "more than 5 minutes to respond and with",
    "start": "784880",
    "end": "787839"
  },
  {
    "text": "proxy in place",
    "start": "787839",
    "end": "789040"
  },
  {
    "text": "those requests timed out",
    "start": "789040",
    "end": "792079"
  },
  {
    "text": "timeouts are a bit more complicated than",
    "start": "792079",
    "end": "794480"
  },
  {
    "text": "that",
    "start": "794480",
    "end": "795200"
  },
  {
    "text": "if you set the same value in your",
    "start": "795200",
    "end": "797279"
  },
  {
    "text": "application",
    "start": "797279",
    "end": "798480"
  },
  {
    "text": "and the proxy then for a brief moment",
    "start": "798480",
    "end": "802399"
  },
  {
    "text": "when the connection is being closed you",
    "start": "802399",
    "end": "804560"
  },
  {
    "text": "might see a proxy trying to send",
    "start": "804560",
    "end": "807200"
  },
  {
    "text": "data over an already closed connection",
    "start": "807200",
    "end": "811360"
  },
  {
    "text": "envoy can also delay closing the",
    "start": "811360",
    "end": "814160"
  },
  {
    "text": "connection",
    "start": "814160",
    "end": "815200"
  },
  {
    "text": "so in some cases if you have very",
    "start": "815200",
    "end": "818000"
  },
  {
    "text": "sensitive",
    "start": "818000",
    "end": "819279"
  },
  {
    "text": "health checks it can make them fail",
    "start": "819279",
    "end": "822399"
  },
  {
    "text": "and that's not all there are so many",
    "start": "822399",
    "end": "825519"
  },
  {
    "text": "types of timeouts connection stream",
    "start": "825519",
    "end": "829360"
  },
  {
    "text": "route",
    "start": "829360",
    "end": "830800"
  },
  {
    "text": "how to configure them one of my",
    "start": "830800",
    "end": "833600"
  },
  {
    "text": "teammates created",
    "start": "833600",
    "end": "834639"
  },
  {
    "text": "a repository breaking down most of the",
    "start": "834639",
    "end": "837839"
  },
  {
    "text": "cases that we encountered in our",
    "start": "837839",
    "end": "839760"
  },
  {
    "text": "production environment",
    "start": "839760",
    "end": "841120"
  },
  {
    "text": "with an example in a docker file so you",
    "start": "841120",
    "end": "843839"
  },
  {
    "text": "can play around with it",
    "start": "843839",
    "end": "845440"
  },
  {
    "text": "a good rule of thumb is to set a",
    "start": "845440",
    "end": "848480"
  },
  {
    "text": "default retrieve on those kind of errors",
    "start": "848480",
    "end": "851120"
  },
  {
    "text": "but you need to make sure",
    "start": "851120",
    "end": "852639"
  },
  {
    "text": "that you only retry on idempotent",
    "start": "852639",
    "end": "855519"
  },
  {
    "text": "request",
    "start": "855519",
    "end": "856560"
  },
  {
    "text": "so head get put",
    "start": "856560",
    "end": "859680"
  },
  {
    "text": "beware of is still here by default it",
    "start": "859680",
    "end": "862800"
  },
  {
    "text": "also retries",
    "start": "862800",
    "end": "864079"
  },
  {
    "text": "post requests the next thing",
    "start": "864079",
    "end": "867920"
  },
  {
    "text": "that also beat us during the deployment",
    "start": "867920",
    "end": "870560"
  },
  {
    "text": "was the max connection limit",
    "start": "870560",
    "end": "872320"
  },
  {
    "text": "which is 1024",
    "start": "872320",
    "end": "875440"
  },
  {
    "text": "in envoy by default that was",
    "start": "875440",
    "end": "879040"
  },
  {
    "text": "way too low for some of our applications",
    "start": "879040",
    "end": "881680"
  },
  {
    "text": "ingress running on measles",
    "start": "881680",
    "end": "883760"
  },
  {
    "text": "and here we discover some more things",
    "start": "883760",
    "end": "887040"
  },
  {
    "text": "that could get us in trouble",
    "start": "887040",
    "end": "888880"
  },
  {
    "text": "our all limits are set per",
    "start": "888880",
    "end": "892079"
  },
  {
    "text": "envoy worker and by default",
    "start": "892079",
    "end": "895120"
  },
  {
    "text": "envoy will start with as many workers as",
    "start": "895120",
    "end": "898079"
  },
  {
    "text": "it has cpus",
    "start": "898079",
    "end": "899519"
  },
  {
    "text": "so if you are making an outgoing",
    "start": "899519",
    "end": "901680"
  },
  {
    "text": "connection to a service",
    "start": "901680",
    "end": "903519"
  },
  {
    "text": "that has a 100 endpoints and you run it",
    "start": "903519",
    "end": "907600"
  },
  {
    "text": "on 64 core machine and leave the default",
    "start": "907600",
    "end": "910800"
  },
  {
    "text": "timeout",
    "start": "910800",
    "end": "911680"
  },
  {
    "text": "that means if you get the burst of",
    "start": "911680",
    "end": "913519"
  },
  {
    "text": "traffic",
    "start": "913519",
    "end": "914720"
  },
  {
    "text": "you can open up to 6 million connections",
    "start": "914720",
    "end": "918240"
  },
  {
    "text": "which is not good and remember",
    "start": "918240",
    "end": "921040"
  },
  {
    "text": "connections are",
    "start": "921040",
    "end": "922000"
  },
  {
    "text": "sockets which are file descriptors",
    "start": "922000",
    "end": "925440"
  },
  {
    "text": "which are finite so when deploying",
    "start": "925440",
    "end": "928160"
  },
  {
    "text": "service mesh",
    "start": "928160",
    "end": "929279"
  },
  {
    "text": "we unconsciously increase the number of",
    "start": "929279",
    "end": "932480"
  },
  {
    "text": "descriptors created and hit a global",
    "start": "932480",
    "end": "935120"
  },
  {
    "text": "limit",
    "start": "935120",
    "end": "937279"
  },
  {
    "text": "to combat that we implement in our",
    "start": "937279",
    "end": "939600"
  },
  {
    "text": "control plane",
    "start": "939600",
    "end": "940480"
  },
  {
    "text": "a check that would set the connection",
    "start": "940480",
    "end": "943360"
  },
  {
    "text": "type to http tool",
    "start": "943360",
    "end": "945920"
  },
  {
    "text": "if we detected that both sides of the",
    "start": "945920",
    "end": "948639"
  },
  {
    "text": "request",
    "start": "948639",
    "end": "949199"
  },
  {
    "text": "can handle it this cannot",
    "start": "949199",
    "end": "952240"
  },
  {
    "text": "be done automatically this is because",
    "start": "952240",
    "end": "955120"
  },
  {
    "text": "envoy only works",
    "start": "955120",
    "end": "956639"
  },
  {
    "text": "with http 2 in prior knowledge mode",
    "start": "956639",
    "end": "960560"
  },
  {
    "text": "it does not support protocol upgrade",
    "start": "960560",
    "end": "963519"
  },
  {
    "text": "this was also a big factor",
    "start": "963519",
    "end": "965920"
  },
  {
    "text": "in our decision not to proxy traffic to",
    "start": "965920",
    "end": "968320"
  },
  {
    "text": "external domains",
    "start": "968320",
    "end": "969600"
  },
  {
    "text": "like vendor rpis and second factor being",
    "start": "969600",
    "end": "973279"
  },
  {
    "text": "envoy not supporting the connect method",
    "start": "973279",
    "end": "976000"
  },
  {
    "text": "at that time",
    "start": "976000",
    "end": "978160"
  },
  {
    "text": "okay so after the deployment we are able",
    "start": "978160",
    "end": "980639"
  },
  {
    "text": "to reduce the number of connections by",
    "start": "980639",
    "end": "982880"
  },
  {
    "text": "a thousand uh a hundred thousand",
    "start": "982880",
    "end": "986560"
  },
  {
    "text": "in the first 20 minutes of the",
    "start": "986560",
    "end": "987920"
  },
  {
    "text": "deployment",
    "start": "987920",
    "end": "990480"
  },
  {
    "text": "another group of errors from envoy",
    "start": "991120",
    "end": "994880"
  },
  {
    "text": "came from onboard being really strict",
    "start": "994880",
    "end": "996800"
  },
  {
    "text": "with the http",
    "start": "996800",
    "end": "998160"
  },
  {
    "text": "protocol so it will lower case all of",
    "start": "998160",
    "end": "1001680"
  },
  {
    "text": "the headers",
    "start": "1001680",
    "end": "1002800"
  },
  {
    "text": "and we knew about it but we still got",
    "start": "1002800",
    "end": "1006000"
  },
  {
    "text": "caught",
    "start": "1006000",
    "end": "1006560"
  },
  {
    "text": "by surprise in some places for example",
    "start": "1006560",
    "end": "1009920"
  },
  {
    "text": "some header sanitizers",
    "start": "1009920",
    "end": "1011680"
  },
  {
    "text": "were case sensitive and stopped working",
    "start": "1011680",
    "end": "1015759"
  },
  {
    "text": "it will also merge multiple headers with",
    "start": "1015759",
    "end": "1018079"
  },
  {
    "text": "the same name into",
    "start": "1018079",
    "end": "1019199"
  },
  {
    "text": "a comma separated list",
    "start": "1019199",
    "end": "1022560"
  },
  {
    "text": "and it does not tolerate forbidden",
    "start": "1022560",
    "end": "1025199"
  },
  {
    "text": "combinations of headers",
    "start": "1025199",
    "end": "1027038"
  },
  {
    "text": "for example undertow and koa.js in some",
    "start": "1027039",
    "end": "1031038"
  },
  {
    "text": "older versions can produce responses",
    "start": "1031039",
    "end": "1034480"
  },
  {
    "text": "with",
    "start": "1034480",
    "end": "1034798"
  },
  {
    "text": "transfer encoding chunked and",
    "start": "1034799",
    "end": "1037038"
  },
  {
    "text": "content-length",
    "start": "1037039",
    "end": "1038079"
  },
  {
    "text": "headers so envoy will reject that",
    "start": "1038079",
    "end": "1040480"
  },
  {
    "text": "response and return an",
    "start": "1040480",
    "end": "1042240"
  },
  {
    "text": "a503 error to sum",
    "start": "1042240",
    "end": "1045918"
  },
  {
    "text": "everything up i think that transparent",
    "start": "1045919",
    "end": "1048799"
  },
  {
    "text": "proxies",
    "start": "1048799",
    "end": "1049440"
  },
  {
    "text": "are not that completely transparent",
    "start": "1049440",
    "end": "1051840"
  },
  {
    "text": "there are so many factors",
    "start": "1051840",
    "end": "1053919"
  },
  {
    "text": "that a proxy influences and to get",
    "start": "1053919",
    "end": "1056480"
  },
  {
    "text": "everything right",
    "start": "1056480",
    "end": "1057760"
  },
  {
    "text": "you have to be able to fine tune the",
    "start": "1057760",
    "end": "1060080"
  },
  {
    "text": "settings to each application in the",
    "start": "1060080",
    "end": "1061760"
  },
  {
    "text": "ecosystem",
    "start": "1061760",
    "end": "1064400"
  },
  {
    "text": "as i mentioned before we we decided to",
    "start": "1064400",
    "end": "1067600"
  },
  {
    "text": "write our own control plane",
    "start": "1067600",
    "end": "1069440"
  },
  {
    "text": "it gave us a lot of flexibility but we",
    "start": "1069440",
    "end": "1072240"
  },
  {
    "text": "it also meant that we had to be",
    "start": "1072240",
    "end": "1074160"
  },
  {
    "text": "really careful not to introduce any",
    "start": "1074160",
    "end": "1077120"
  },
  {
    "text": "errors to the",
    "start": "1077120",
    "end": "1078000"
  },
  {
    "text": "current discovery mechanism if there's a",
    "start": "1078000",
    "end": "1081200"
  },
  {
    "text": "bug in there",
    "start": "1081200",
    "end": "1082080"
  },
  {
    "text": "it means no traffic flowing between our",
    "start": "1082080",
    "end": "1085520"
  },
  {
    "text": "in our mesh and that we that means we",
    "start": "1085520",
    "end": "1088000"
  },
  {
    "text": "are in big trouble",
    "start": "1088000",
    "end": "1089760"
  },
  {
    "text": "for the most part we did a good job but",
    "start": "1089760",
    "end": "1092320"
  },
  {
    "text": "there were a couple of bumps along",
    "start": "1092320",
    "end": "1094000"
  },
  {
    "text": "the way let's first look at the control",
    "start": "1094000",
    "end": "1097200"
  },
  {
    "text": "plane",
    "start": "1097200",
    "end": "1097600"
  },
  {
    "text": "architecture our discovery backhand is",
    "start": "1097600",
    "end": "1100080"
  },
  {
    "text": "console",
    "start": "1100080",
    "end": "1101200"
  },
  {
    "text": "we pull state from there process it and",
    "start": "1101200",
    "end": "1103760"
  },
  {
    "text": "then push the configuration to envoy",
    "start": "1103760",
    "end": "1106640"
  },
  {
    "text": "and envoy will communicate with local",
    "start": "1106640",
    "end": "1108799"
  },
  {
    "text": "instances",
    "start": "1108799",
    "end": "1110240"
  },
  {
    "text": "within a single dc we also have a",
    "start": "1110240",
    "end": "1113600"
  },
  {
    "text": "synchronization mechanism between our",
    "start": "1113600",
    "end": "1115679"
  },
  {
    "text": "control planes",
    "start": "1115679",
    "end": "1116960"
  },
  {
    "text": "so we can fall back to another dc when",
    "start": "1116960",
    "end": "1119840"
  },
  {
    "text": "instances of a service are not available",
    "start": "1119840",
    "end": "1122160"
  },
  {
    "text": "there the fifth service",
    "start": "1122160",
    "end": "1125600"
  },
  {
    "text": "issue that we face was when envoy",
    "start": "1125600",
    "end": "1128799"
  },
  {
    "text": "was being stuck in the warming phase",
    "start": "1128799",
    "end": "1131280"
  },
  {
    "text": "indefinitely",
    "start": "1131280",
    "end": "1132320"
  },
  {
    "text": "this means that there are no updates to",
    "start": "1132320",
    "end": "1134640"
  },
  {
    "text": "the cluster state",
    "start": "1134640",
    "end": "1136000"
  },
  {
    "text": "applied which means no traffic flowing",
    "start": "1136000",
    "end": "1139360"
  },
  {
    "text": "after a service changes its ip address",
    "start": "1139360",
    "end": "1142320"
  },
  {
    "text": "it took us a lot of time to figure it",
    "start": "1142320",
    "end": "1144080"
  },
  {
    "text": "out",
    "start": "1144080",
    "end": "1144640"
  },
  {
    "text": "and it turned out that our base project",
    "start": "1144640",
    "end": "1147520"
  },
  {
    "text": "java control plane",
    "start": "1147520",
    "end": "1148799"
  },
  {
    "text": "did not send the updates in the",
    "start": "1148799",
    "end": "1150720"
  },
  {
    "text": "specified order",
    "start": "1150720",
    "end": "1152400"
  },
  {
    "text": "xds protocol requires that eds",
    "start": "1152400",
    "end": "1155520"
  },
  {
    "text": "and rds updates are triggered after",
    "start": "1155520",
    "end": "1158799"
  },
  {
    "text": "cds and lds",
    "start": "1158799",
    "end": "1161840"
  },
  {
    "text": "we also found out that if envoy",
    "start": "1161840",
    "end": "1164320"
  },
  {
    "text": "disconnects from",
    "start": "1164320",
    "end": "1165679"
  },
  {
    "text": "one control plane and connects to",
    "start": "1165679",
    "end": "1168559"
  },
  {
    "text": "another",
    "start": "1168559",
    "end": "1169200"
  },
  {
    "text": "instance of control plane we might not",
    "start": "1169200",
    "end": "1171520"
  },
  {
    "text": "send all of the resources that are",
    "start": "1171520",
    "end": "1173440"
  },
  {
    "text": "needed",
    "start": "1173440",
    "end": "1174080"
  },
  {
    "text": "and that might also cause the warming",
    "start": "1174080",
    "end": "1176160"
  },
  {
    "text": "state as well fortunately",
    "start": "1176160",
    "end": "1178880"
  },
  {
    "text": "we've patched all of these problems in",
    "start": "1178880",
    "end": "1180640"
  },
  {
    "text": "open source and we haven't",
    "start": "1180640",
    "end": "1182640"
  },
  {
    "text": "seen them since",
    "start": "1182640",
    "end": "1185600"
  },
  {
    "text": "the second issue that stole our",
    "start": "1186080",
    "end": "1188160"
  },
  {
    "text": "development for a while",
    "start": "1188160",
    "end": "1189919"
  },
  {
    "text": "was poor performance of the control",
    "start": "1189919",
    "end": "1191919"
  },
  {
    "text": "plane",
    "start": "1191919",
    "end": "1193200"
  },
  {
    "text": "especially with regards to services that",
    "start": "1193200",
    "end": "1196559"
  },
  {
    "text": "have a lot of cluster definitions",
    "start": "1196559",
    "end": "1199200"
  },
  {
    "text": "a couple of people spent considerable",
    "start": "1199200",
    "end": "1201360"
  },
  {
    "text": "amount of time",
    "start": "1201360",
    "end": "1202400"
  },
  {
    "text": "applying the following optimization",
    "start": "1202400",
    "end": "1205520"
  },
  {
    "text": "our synchronization mechanism was not",
    "start": "1205520",
    "end": "1207919"
  },
  {
    "text": "good with flapping instances",
    "start": "1207919",
    "end": "1210480"
  },
  {
    "text": "when an instance appears and disappears",
    "start": "1210480",
    "end": "1214000"
  },
  {
    "text": "suddenly we would regenerate a lot of",
    "start": "1214000",
    "end": "1216799"
  },
  {
    "text": "resources",
    "start": "1216799",
    "end": "1218640"
  },
  {
    "text": "on this graph you can see time spent in",
    "start": "1218640",
    "end": "1221360"
  },
  {
    "text": "gc",
    "start": "1221360",
    "end": "1222000"
  },
  {
    "text": "before and after the deployment of an",
    "start": "1222000",
    "end": "1224960"
  },
  {
    "text": "improved version",
    "start": "1224960",
    "end": "1227360"
  },
  {
    "text": "in some cases we regenerate parts of the",
    "start": "1227360",
    "end": "1231200"
  },
  {
    "text": "envoy config when it was needed on this",
    "start": "1231200",
    "end": "1233919"
  },
  {
    "text": "graph you can see",
    "start": "1233919",
    "end": "1234799"
  },
  {
    "text": "cpu usage before and after",
    "start": "1234799",
    "end": "1239200"
  },
  {
    "text": "and this graph shows an average",
    "start": "1239200",
    "end": "1241600"
  },
  {
    "text": "percentage",
    "start": "1241600",
    "end": "1242720"
  },
  {
    "text": "of cpu usage of envoy remember before",
    "start": "1242720",
    "end": "1246080"
  },
  {
    "text": "it was control planes metrics",
    "start": "1246080",
    "end": "1249600"
  },
  {
    "text": "our test services would trigger a lot of",
    "start": "1249600",
    "end": "1252400"
  },
  {
    "text": "unnecessary changes which meant",
    "start": "1252400",
    "end": "1254640"
  },
  {
    "text": "a lot of traffic and cpu spike on envoy",
    "start": "1254640",
    "end": "1257600"
  },
  {
    "text": "that had",
    "start": "1257600",
    "end": "1258240"
  },
  {
    "text": "a lot of cluster definitions",
    "start": "1258240",
    "end": "1261440"
  },
  {
    "text": "i would like to focus on this one",
    "start": "1261440",
    "end": "1264159"
  },
  {
    "text": "because i think it's a great",
    "start": "1264159",
    "end": "1266240"
  },
  {
    "text": "engineering practice in our",
    "start": "1266240",
    "end": "1268400"
  },
  {
    "text": "infrastructure",
    "start": "1268400",
    "end": "1269440"
  },
  {
    "text": "we have a couple of so-called test apps",
    "start": "1269440",
    "end": "1272400"
  },
  {
    "text": "that are constantly being",
    "start": "1272400",
    "end": "1274240"
  },
  {
    "text": "deployed and scaled to see how fast the",
    "start": "1274240",
    "end": "1277440"
  },
  {
    "text": "information from our discovery backend",
    "start": "1277440",
    "end": "1280080"
  },
  {
    "text": "is available in onboard if we see a rise",
    "start": "1280080",
    "end": "1283840"
  },
  {
    "text": "in that metric we know that something is",
    "start": "1283840",
    "end": "1287120"
  },
  {
    "text": "wrong",
    "start": "1287120",
    "end": "1287600"
  },
  {
    "text": "with the new version of our control",
    "start": "1287600",
    "end": "1289360"
  },
  {
    "text": "plane in this screenshot",
    "start": "1289360",
    "end": "1291440"
  },
  {
    "text": "you can see spawn first instance time",
    "start": "1291440",
    "end": "1294720"
  },
  {
    "text": "there are also spawn next since time",
    "start": "1294720",
    "end": "1297280"
  },
  {
    "text": "scaled down",
    "start": "1297280",
    "end": "1298080"
  },
  {
    "text": "and so on if you remember",
    "start": "1298080",
    "end": "1301120"
  },
  {
    "text": "way back in the beginning i told you",
    "start": "1301120",
    "end": "1303440"
  },
  {
    "text": "that we disabled",
    "start": "1303440",
    "end": "1304960"
  },
  {
    "text": "some parts of the monitoring system",
    "start": "1304960",
    "end": "1308720"
  },
  {
    "text": "i do not want to get into the details",
    "start": "1308720",
    "end": "1310880"
  },
  {
    "text": "but if the monitoring platform",
    "start": "1310880",
    "end": "1313520"
  },
  {
    "text": "had a test app like this that would test",
    "start": "1313520",
    "end": "1317440"
  },
  {
    "text": "if metrics are reported and alerts are",
    "start": "1317440",
    "end": "1320159"
  },
  {
    "text": "triggered",
    "start": "1320159",
    "end": "1321280"
  },
  {
    "text": "we would know about the problem sooner",
    "start": "1321280",
    "end": "1323679"
  },
  {
    "text": "than in production environment",
    "start": "1323679",
    "end": "1327360"
  },
  {
    "text": "the last thing but still very important",
    "start": "1327520",
    "end": "1330240"
  },
  {
    "text": "is that we create",
    "start": "1330240",
    "end": "1331679"
  },
  {
    "text": "resilience tests they verify that if",
    "start": "1331679",
    "end": "1334799"
  },
  {
    "text": "some parts of our system",
    "start": "1334799",
    "end": "1336559"
  },
  {
    "text": "are unavailable meaning the control",
    "start": "1336559",
    "end": "1339440"
  },
  {
    "text": "plane",
    "start": "1339440",
    "end": "1339919"
  },
  {
    "text": "cannot reach its local console agent",
    "start": "1339919",
    "end": "1343280"
  },
  {
    "text": "there is no leader in the console",
    "start": "1343280",
    "end": "1344960"
  },
  {
    "text": "cluster or",
    "start": "1344960",
    "end": "1346559"
  },
  {
    "text": "envoy disconnects and tries to reconnect",
    "start": "1346559",
    "end": "1349600"
  },
  {
    "text": "the system behaves in a predictable",
    "start": "1349600",
    "end": "1352159"
  },
  {
    "text": "manner",
    "start": "1352159",
    "end": "1353039"
  },
  {
    "text": "and will self heal after the outage is",
    "start": "1353039",
    "end": "1356080"
  },
  {
    "text": "done",
    "start": "1356080",
    "end": "1357760"
  },
  {
    "text": "and there is nothing special about these",
    "start": "1357760",
    "end": "1361039"
  },
  {
    "text": "tests",
    "start": "1361039",
    "end": "1361840"
  },
  {
    "text": "they use junit framework and can be",
    "start": "1361840",
    "end": "1364080"
  },
  {
    "text": "simply run",
    "start": "1364080",
    "end": "1365039"
  },
  {
    "text": "from a laptop or ci the test gave us",
    "start": "1365039",
    "end": "1368640"
  },
  {
    "text": "a calculator saved us a couple of times",
    "start": "1368640",
    "end": "1371200"
  },
  {
    "text": "from introducing bugs",
    "start": "1371200",
    "end": "1372880"
  },
  {
    "text": "that would lead to bigger outages",
    "start": "1372880",
    "end": "1375679"
  },
  {
    "text": "stemming from",
    "start": "1375679",
    "end": "1376720"
  },
  {
    "text": "small instabilities",
    "start": "1376720",
    "end": "1379760"
  },
  {
    "text": "to summarize writing a control plane is",
    "start": "1379760",
    "end": "1382559"
  },
  {
    "text": "hard",
    "start": "1382559",
    "end": "1383679"
  },
  {
    "text": "if you decide to do that use a base",
    "start": "1383679",
    "end": "1386400"
  },
  {
    "text": "project",
    "start": "1386400",
    "end": "1387200"
  },
  {
    "text": "like go control plane or java control",
    "start": "1387200",
    "end": "1389919"
  },
  {
    "text": "plane",
    "start": "1389919",
    "end": "1390480"
  },
  {
    "text": "and contribute to those projects if you",
    "start": "1390480",
    "end": "1392640"
  },
  {
    "text": "find any problems",
    "start": "1392640",
    "end": "1394880"
  },
  {
    "text": "also write test services that constantly",
    "start": "1394880",
    "end": "1398720"
  },
  {
    "text": "test your product this is a great way to",
    "start": "1398720",
    "end": "1401440"
  },
  {
    "text": "make sure",
    "start": "1401440",
    "end": "1402000"
  },
  {
    "text": "you discover problems before your",
    "start": "1402000",
    "end": "1403760"
  },
  {
    "text": "clients do",
    "start": "1403760",
    "end": "1405200"
  },
  {
    "text": "do this of course this is of course",
    "start": "1405200",
    "end": "1407840"
  },
  {
    "text": "another",
    "start": "1407840",
    "end": "1408640"
  },
  {
    "text": "layer of protection right after unit",
    "start": "1408640",
    "end": "1411280"
  },
  {
    "text": "integration and",
    "start": "1411280",
    "end": "1412400"
  },
  {
    "text": "end-to-end tests that you should write",
    "start": "1412400",
    "end": "1415600"
  },
  {
    "text": "okay so what's happening right now",
    "start": "1415600",
    "end": "1419280"
  },
  {
    "text": "currently we are running strong in",
    "start": "1419280",
    "end": "1421200"
  },
  {
    "text": "productions most of the problems i",
    "start": "1421200",
    "end": "1423279"
  },
  {
    "text": "described",
    "start": "1423279",
    "end": "1424400"
  },
  {
    "text": "are long gone and we are pushing 1",
    "start": "1424400",
    "end": "1427440"
  },
  {
    "text": "million rps in our mesh",
    "start": "1427440",
    "end": "1429600"
  },
  {
    "text": "we are bound to break that barrier",
    "start": "1429600",
    "end": "1431200"
  },
  {
    "text": "really soon",
    "start": "1431200",
    "end": "1433279"
  },
  {
    "text": "so looking back at more looking back at",
    "start": "1433279",
    "end": "1436159"
  },
  {
    "text": "more of the",
    "start": "1436159",
    "end": "1437840"
  },
  {
    "text": "more more than a year of work what could",
    "start": "1437840",
    "end": "1440880"
  },
  {
    "text": "have been done differently",
    "start": "1440880",
    "end": "1442960"
  },
  {
    "text": "maybe we could have gone into console",
    "start": "1442960",
    "end": "1445360"
  },
  {
    "text": "connect",
    "start": "1445360",
    "end": "1446080"
  },
  {
    "text": "and work with the vendor to try to",
    "start": "1446080",
    "end": "1448240"
  },
  {
    "text": "extend system where we need it",
    "start": "1448240",
    "end": "1451039"
  },
  {
    "text": "maybe we should have focused on our",
    "start": "1451039",
    "end": "1454240"
  },
  {
    "text": "migration to kubernetes",
    "start": "1454240",
    "end": "1456400"
  },
  {
    "text": "and then go with instant instead we may",
    "start": "1456400",
    "end": "1459360"
  },
  {
    "text": "never know what would have been better",
    "start": "1459360",
    "end": "1463120"
  },
  {
    "text": "okay so what's in the future for us",
    "start": "1463120",
    "end": "1466240"
  },
  {
    "text": "in a couple of weeks we are introducing",
    "start": "1466240",
    "end": "1468640"
  },
  {
    "text": "mtos and airbag mechanisms to our",
    "start": "1468640",
    "end": "1470880"
  },
  {
    "text": "service mesh and it's",
    "start": "1470880",
    "end": "1472480"
  },
  {
    "text": "a combination of months of work i will",
    "start": "1472480",
    "end": "1475520"
  },
  {
    "text": "definitely blog about it",
    "start": "1475520",
    "end": "1477440"
  },
  {
    "text": "once we are in production environment",
    "start": "1477440",
    "end": "1479440"
  },
  {
    "text": "because i think we did a great",
    "start": "1479440",
    "end": "1481279"
  },
  {
    "text": "job designing the migration process",
    "start": "1481279",
    "end": "1485120"
  },
  {
    "text": "i think now is a good time to thank",
    "start": "1485120",
    "end": "1488320"
  },
  {
    "text": "all of the people who worked on service",
    "start": "1488320",
    "end": "1491039"
  },
  {
    "text": "smash in allegro",
    "start": "1491039",
    "end": "1492400"
  },
  {
    "text": "piotr darius ukash patrick",
    "start": "1492400",
    "end": "1496080"
  },
  {
    "text": "ukash martin and andre thank you very",
    "start": "1496080",
    "end": "1499600"
  },
  {
    "text": "much",
    "start": "1499600",
    "end": "1500159"
  },
  {
    "text": "for all of your hard work",
    "start": "1500159",
    "end": "1503520"
  },
  {
    "text": "so if you only remember three things",
    "start": "1503520",
    "end": "1505919"
  },
  {
    "text": "from this stack",
    "start": "1505919",
    "end": "1507520"
  },
  {
    "text": "please remember this service mesh",
    "start": "1507520",
    "end": "1510240"
  },
  {
    "text": "deployment",
    "start": "1510240",
    "end": "1510880"
  },
  {
    "text": "should be gradual and rollback should be",
    "start": "1510880",
    "end": "1513520"
  },
  {
    "text": "easy",
    "start": "1513520",
    "end": "1514799"
  },
  {
    "text": "transparent proxies are tricky",
    "start": "1514799",
    "end": "1518000"
  },
  {
    "text": "and not completely transparent service",
    "start": "1518000",
    "end": "1521279"
  },
  {
    "text": "mesh",
    "start": "1521279",
    "end": "1521679"
  },
  {
    "text": "is hard so do do a lot of testing",
    "start": "1521679",
    "end": "1526000"
  },
  {
    "text": "thank you very much for listening that's",
    "start": "1526000",
    "end": "1528640"
  },
  {
    "text": "all from me",
    "start": "1528640",
    "end": "1529840"
  },
  {
    "text": "if you have any questions i'm glad to",
    "start": "1529840",
    "end": "1532559"
  },
  {
    "text": "answer them",
    "start": "1532559",
    "end": "1536080"
  }
]