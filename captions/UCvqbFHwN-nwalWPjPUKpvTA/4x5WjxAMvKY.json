[
  {
    "start": "0",
    "end": "46000"
  },
  {
    "text": "hi everyone I'm Derek I am a site",
    "start": "2179",
    "end": "4550"
  },
  {
    "text": "reliability engineer at Pinterest where",
    "start": "4550",
    "end": "5960"
  },
  {
    "text": "I work on the traffic engineering team",
    "start": "5960",
    "end": "7099"
  },
  {
    "text": "and I'm here to talk about our edge",
    "start": "7099",
    "end": "8960"
  },
  {
    "text": "deployment of envoy when I first got to",
    "start": "8960",
    "end": "11389"
  },
  {
    "text": "Pinterest rolling out on boy as our load",
    "start": "11389",
    "end": "14419"
  },
  {
    "text": "balancer in HD router was one of the",
    "start": "14419",
    "end": "16100"
  },
  {
    "text": "first things I did sounds really fun",
    "start": "16100",
    "end": "18530"
  },
  {
    "text": "journey if we started working that out",
    "start": "18530",
    "end": "19790"
  },
  {
    "text": "in about March of this year and as of",
    "start": "19790",
    "end": "22340"
  },
  {
    "text": "summer our load balancers are a hundred",
    "start": "22340",
    "end": "25340"
  },
  {
    "text": "percent running on boy so I'll request",
    "start": "25340",
    "end": "27200"
  },
  {
    "text": "hitting Pinterest we go through on",
    "start": "27200",
    "end": "28520"
  },
  {
    "text": "volume a bit of agenda so we talked",
    "start": "28520",
    "end": "31490"
  },
  {
    "text": "about about the migration process in",
    "start": "31490",
    "end": "33499"
  },
  {
    "text": "particular I want to spend a book this",
    "start": "33499",
    "end": "35210"
  },
  {
    "text": "talk talking about the subset load",
    "start": "35210",
    "end": "36289"
  },
  {
    "text": "balancer and some sophisticated routing",
    "start": "36289",
    "end": "38359"
  },
  {
    "text": "scheme that we did for serving the",
    "start": "38359",
    "end": "40100"
  },
  {
    "text": "website duty some interesting requires",
    "start": "40100",
    "end": "42199"
  },
  {
    "text": "that we adopted from our previous load",
    "start": "42199",
    "end": "44359"
  },
  {
    "text": "bouncer it's a bit of background as to",
    "start": "44359",
    "end": "47929"
  },
  {
    "start": "46000",
    "end": "84000"
  },
  {
    "text": "our stack so we run well we use multiple",
    "start": "47929",
    "end": "51260"
  },
  {
    "text": "seeding vendors in front of our edge",
    "start": "51260",
    "end": "52850"
  },
  {
    "text": "deployment just interleaved into one",
    "start": "52850",
    "end": "55399"
  },
  {
    "text": "large coherent Network those went to",
    "start": "55399",
    "end": "57979"
  },
  {
    "text": "classic load balancers serving HTTP",
    "start": "57979",
    "end": "60620"
  },
  {
    "text": "sorry Larry seven HTTP which would go to",
    "start": "60620",
    "end": "63379"
  },
  {
    "text": "a fleet of varnish hosts which did the",
    "start": "63379",
    "end": "65448"
  },
  {
    "text": "path based routing the complexity",
    "start": "65449",
    "end": "67430"
  },
  {
    "text": "balancing all those sorts of things so",
    "start": "67430",
    "end": "69710"
  },
  {
    "text": "this is how we looked at this point last",
    "start": "69710",
    "end": "71659"
  },
  {
    "text": "year this stack service well I think has",
    "start": "71659",
    "end": "74240"
  },
  {
    "text": "been this way since maybe 2012 but as",
    "start": "74240",
    "end": "77240"
  },
  {
    "text": "time progressed we started running into",
    "start": "77240",
    "end": "78500"
  },
  {
    "text": "many issues and commuting tech tech debt",
    "start": "78500",
    "end": "80630"
  },
  {
    "text": "that came time to rethink how we serve",
    "start": "80630",
    "end": "82939"
  },
  {
    "text": "Pinterest so some of the reasons we want",
    "start": "82939",
    "end": "86299"
  },
  {
    "start": "84000",
    "end": "334000"
  },
  {
    "text": "to migrate our classic Gilbey's we're",
    "start": "86299",
    "end": "88520"
  },
  {
    "text": "facing scaling issues during peak",
    "start": "88520",
    "end": "90829"
  },
  {
    "text": "traffic of the week we start",
    "start": "90829",
    "end": "91820"
  },
  {
    "text": "experiencing intermittent connection",
    "start": "91820",
    "end": "93170"
  },
  {
    "text": "failures or connection timeouts that we",
    "start": "93170",
    "end": "95420"
  },
  {
    "text": "just cannot debug cannot find out why",
    "start": "95420",
    "end": "97219"
  },
  {
    "text": "and it turned out that our LB was",
    "start": "97219",
    "end": "99020"
  },
  {
    "text": "hitting capacity limits the options 80s",
    "start": "99020",
    "end": "101509"
  },
  {
    "text": "gave us were to either shard our traffic",
    "start": "101509",
    "end": "103969"
  },
  {
    "text": "amongst multiple i/o bees or adopt their",
    "start": "103969",
    "end": "106520"
  },
  {
    "text": "new network load balancing products",
    "start": "106520",
    "end": "108829"
  },
  {
    "text": "their layer for load balancer that",
    "start": "108829",
    "end": "110149"
  },
  {
    "text": "sounds awesome but it doesn't support a",
    "start": "110149",
    "end": "112880"
  },
  {
    "text": "less termination which the classic EO",
    "start": "112880",
    "end": "114500"
  },
  {
    "text": "bees were doing for us so that meant",
    "start": "114500",
    "end": "116060"
  },
  {
    "text": "pushing till us back a layer in our",
    "start": "116060",
    "end": "117380"
  },
  {
    "text": "stack which would be great but varnish",
    "start": "117380",
    "end": "119990"
  },
  {
    "text": "does not support TLS termination out of",
    "start": "119990",
    "end": "121670"
  },
  {
    "text": "the box the varnish way to do till",
    "start": "121670",
    "end": "124549"
  },
  {
    "text": "extermination is to run another proxy in",
    "start": "124549",
    "end": "126259"
  },
  {
    "text": "front of Arnage and Terman TLS and then",
    "start": "126259",
    "end": "127939"
  },
  {
    "text": "proxy the plaintext to varnish so if",
    "start": "127939",
    "end": "130489"
  },
  {
    "text": "we're gonna operationalize an entirely",
    "start": "130489",
    "end": "132140"
  },
  {
    "text": "new proxy maybe if you just rethink",
    "start": "132140",
    "end": "133940"
  },
  {
    "text": "using",
    "start": "133940",
    "end": "135570"
  },
  {
    "text": "there are a number of other issues too",
    "start": "135570",
    "end": "136950"
  },
  {
    "text": "so varnish is a great caching proxy no",
    "start": "136950",
    "end": "139440"
  },
  {
    "text": "doubt about that fastly uses it to run",
    "start": "139440",
    "end": "141510"
  },
  {
    "text": "their CDN but the path that we were",
    "start": "141510",
    "end": "143670"
  },
  {
    "text": "serving was all dynamic traffic",
    "start": "143670",
    "end": "145290"
  },
  {
    "text": "we weren't really caching anything so we",
    "start": "145290",
    "end": "147690"
  },
  {
    "text": "weren't really using varnish for its",
    "start": "147690",
    "end": "149070"
  },
  {
    "text": "strengths and what is meant for for the",
    "start": "149070",
    "end": "151470"
  },
  {
    "text": "more there were some other goodies that",
    "start": "151470",
    "end": "152580"
  },
  {
    "text": "we wanted out of our edge to the",
    "start": "152580",
    "end": "153780"
  },
  {
    "text": "balancer dynamic upstreams",
    "start": "153780",
    "end": "155700"
  },
  {
    "text": "which we kind of hacked onto varnish",
    "start": "155700",
    "end": "157320"
  },
  {
    "text": "with this scheme where we would reload",
    "start": "157320",
    "end": "159330"
  },
  {
    "text": "or regenerate configuration and reload",
    "start": "159330",
    "end": "161160"
  },
  {
    "text": "varnish every time we detect a change in",
    "start": "161160",
    "end": "162780"
  },
  {
    "text": "zookeeper there's this brittle group",
    "start": "162780",
    "end": "165870"
  },
  {
    "text": "Goldberg machine that when it broke was",
    "start": "165870",
    "end": "167610"
  },
  {
    "text": "terrifying to deal with the",
    "start": "167610",
    "end": "169920"
  },
  {
    "text": "observability wasn't great when varnish",
    "start": "169920",
    "end": "171990"
  },
  {
    "text": "did break it was very hard to figure out",
    "start": "171990",
    "end": "173520"
  },
  {
    "text": "why and lastly when we were looking for",
    "start": "173520",
    "end": "179010"
  },
  {
    "text": "a new proxy - we're sorry",
    "start": "179010",
    "end": "180870"
  },
  {
    "text": "yeah those reasons to migrate so we were",
    "start": "180870",
    "end": "182910"
  },
  {
    "text": "in the market for new proxy and one of",
    "start": "182910",
    "end": "184410"
  },
  {
    "text": "the main options we were looking at was",
    "start": "184410",
    "end": "186300"
  },
  {
    "text": "open rusty which many of you might know",
    "start": "186300",
    "end": "187890"
  },
  {
    "text": "is an entry next module that embeds Lua",
    "start": "187890",
    "end": "189810"
  },
  {
    "text": "scripting into nginx runtime so you get",
    "start": "189810",
    "end": "191520"
  },
  {
    "text": "a script a bullet bouncer dynamic",
    "start": "191520",
    "end": "193290"
  },
  {
    "text": "behavior great we were talking to some",
    "start": "193290",
    "end": "196440"
  },
  {
    "text": "other internal teams at Pinterest",
    "start": "196440",
    "end": "197640"
  },
  {
    "text": "specifically our service framework team",
    "start": "197640",
    "end": "199590"
  },
  {
    "text": "this is the team that writes networking",
    "start": "199590",
    "end": "201930"
  },
  {
    "text": "code in each language you know the",
    "start": "201930",
    "end": "203280"
  },
  {
    "text": "problem that on boys trying to solve and",
    "start": "203280",
    "end": "205080"
  },
  {
    "text": "they're like hey there's this cool proxy",
    "start": "205080",
    "end": "206940"
  },
  {
    "text": "that we want to use as a service mesh",
    "start": "206940",
    "end": "208440"
  },
  {
    "text": "maybe you guys want to check it out for",
    "start": "208440",
    "end": "209940"
  },
  {
    "text": "your edge proxy they're gonna replace so",
    "start": "209940",
    "end": "212820"
  },
  {
    "text": "we took a look and it checked all our",
    "start": "212820",
    "end": "214230"
  },
  {
    "text": "boxes that we needed out of an edge",
    "start": "214230",
    "end": "215400"
  },
  {
    "text": "proxies voice Hillis termination its",
    "start": "215400",
    "end": "216959"
  },
  {
    "text": "high performance it has a great",
    "start": "216959",
    "end": "218310"
  },
  {
    "text": "extension model whoa did my computer die",
    "start": "218310",
    "end": "223260"
  },
  {
    "text": "oh I locked me out awesome",
    "start": "223260",
    "end": "227000"
  },
  {
    "text": "I hope Security's happy that I had",
    "start": "233990",
    "end": "236630"
  },
  {
    "text": "bought a lock on okay so yes TLS",
    "start": "236630",
    "end": "240320"
  },
  {
    "text": "termination and count up here okay so we",
    "start": "240320",
    "end": "247820"
  },
  {
    "text": "were ready for new proxy we talked a",
    "start": "247820",
    "end": "248990"
  },
  {
    "text": "tomboy that was a great fit for our",
    "start": "248990",
    "end": "250340"
  },
  {
    "text": "stack so we won with it some logistics",
    "start": "250340",
    "end": "253940"
  },
  {
    "text": "of how we started for an envoy we don't",
    "start": "253940",
    "end": "255740"
  },
  {
    "text": "fort the project any chord changes we",
    "start": "255740",
    "end": "257180"
  },
  {
    "text": "need we try to contribute through the",
    "start": "257180",
    "end": "258290"
  },
  {
    "text": "open-source process we run envoy and",
    "start": "258290",
    "end": "259940"
  },
  {
    "text": "docker containers we do use hot restart",
    "start": "259940",
    "end": "262700"
  },
  {
    "text": "across containers that was fun to get",
    "start": "262700",
    "end": "264110"
  },
  {
    "text": "working and works really well and lastly",
    "start": "264110",
    "end": "267410"
  },
  {
    "text": "our control plane for our initial on WA",
    "start": "267410",
    "end": "269030"
  },
  {
    "text": "rollout runs as a sidecar on our edge",
    "start": "269030",
    "end": "270920"
  },
  {
    "text": "hosts it's a bit of detail about the",
    "start": "270920",
    "end": "273110"
  },
  {
    "text": "control plane that we run at Pinterest",
    "start": "273110",
    "end": "275810"
  },
  {
    "text": "we have a default service discovery",
    "start": "275810",
    "end": "277760"
  },
  {
    "text": "setup where everything's backed by",
    "start": "277760",
    "end": "279710"
  },
  {
    "text": "zookeeper when a host comes up they",
    "start": "279710",
    "end": "281390"
  },
  {
    "text": "registers in a fumarole node and we have",
    "start": "281390",
    "end": "283970"
  },
  {
    "text": "a daemon on every host at Pinterest that",
    "start": "283970",
    "end": "285740"
  },
  {
    "text": "will read that do to keep your",
    "start": "285740",
    "end": "287060"
  },
  {
    "text": "configuration and we'll write it to a",
    "start": "287060",
    "end": "288710"
  },
  {
    "text": "file on the machine so if our",
    "start": "288710",
    "end": "290830"
  },
  {
    "text": "communication with zookeeper breaks or",
    "start": "290830",
    "end": "292670"
  },
  {
    "text": "never partitions we have a local cache",
    "start": "292670",
    "end": "294080"
  },
  {
    "text": "copy available sounds very similar to",
    "start": "294080",
    "end": "296810"
  },
  {
    "text": "how Envoy caches eds intent so the",
    "start": "296810",
    "end": "302000"
  },
  {
    "text": "second part is the routes clusters and",
    "start": "302000",
    "end": "303950"
  },
  {
    "text": "listeners which for our edge deployments",
    "start": "303950",
    "end": "306290"
  },
  {
    "text": "don't change very often so for those",
    "start": "306290",
    "end": "308630"
  },
  {
    "text": "three services we decided to use static",
    "start": "308630",
    "end": "310490"
  },
  {
    "text": "json files on the machine when we deploy",
    "start": "310490",
    "end": "312560"
  },
  {
    "text": "changes to those it's just a matter of",
    "start": "312560",
    "end": "314030"
  },
  {
    "text": "swapping the files and on boys configure",
    "start": "314030",
    "end": "315800"
  },
  {
    "text": "to watch those files for updates for EDS",
    "start": "315800",
    "end": "318410"
  },
  {
    "text": "the problem was simply taking those",
    "start": "318410",
    "end": "320600"
  },
  {
    "text": "cached files of the zookeeper data and",
    "start": "320600",
    "end": "323420"
  },
  {
    "text": "fitting in to API that Amelie",
    "start": "323420",
    "end": "325070"
  },
  {
    "text": "understands so we wrote a little go",
    "start": "325070",
    "end": "326930"
  },
  {
    "text": "sidecar that just sits next to Uncle",
    "start": "326930",
    "end": "328580"
  },
  {
    "text": "Machine and feeds the data to hunt way",
    "start": "328580",
    "end": "330380"
  },
  {
    "text": "over those api's so to get complete",
    "start": "330380",
    "end": "336740"
  },
  {
    "start": "334000",
    "end": "432000"
  },
  {
    "text": "feature parity with varnish we had a",
    "start": "336740",
    "end": "338360"
  },
  {
    "text": "list of things we had to satisfy most",
    "start": "338360",
    "end": "340910"
  },
  {
    "text": "notably there were so the routing",
    "start": "340910",
    "end": "343100"
  },
  {
    "text": "schemes and request manipulation and",
    "start": "343100",
    "end": "344630"
  },
  {
    "text": "that kind of comes out of the box with",
    "start": "344630",
    "end": "345800"
  },
  {
    "text": "the Envoy there wasn't any work to be",
    "start": "345800",
    "end": "347300"
  },
  {
    "text": "done there",
    "start": "347300",
    "end": "347980"
  },
  {
    "text": "one of the more sophisticated features",
    "start": "347980",
    "end": "349970"
  },
  {
    "text": "we had to do is CDN request signing so",
    "start": "349970",
    "end": "352610"
  },
  {
    "text": "since we use multiple CD ends the CD",
    "start": "352610",
    "end": "356090"
  },
  {
    "text": "ends will sign the request with an H Mac",
    "start": "356090",
    "end": "357860"
  },
  {
    "text": "and forward it to our proxies and the",
    "start": "357860",
    "end": "359420"
  },
  {
    "text": "proxies and code the HTML gonna verify",
    "start": "359420",
    "end": "361580"
  },
  {
    "text": "that ok yes this request came from CDN",
    "start": "361580",
    "end": "363470"
  },
  {
    "text": "since we used multiple CD ends",
    "start": "363470",
    "end": "366289"
  },
  {
    "text": "this was the best solution we had in a",
    "start": "366289",
    "end": "368599"
  },
  {
    "text": "simpler world we could have an IP list",
    "start": "368599",
    "end": "370699"
  },
  {
    "text": "of known IPS for the CD ends and to say",
    "start": "370699",
    "end": "372710"
  },
  {
    "text": "have a security group that says it has",
    "start": "372710",
    "end": "374089"
  },
  {
    "text": "to come from these IPS but we don't live",
    "start": "374089",
    "end": "376580"
  },
  {
    "text": "in a simple world unfortunately so this",
    "start": "376580",
    "end": "378949"
  },
  {
    "text": "is an adaptable scheme to however many",
    "start": "378949",
    "end": "380749"
  },
  {
    "text": "CD ends we on board in the future we",
    "start": "380749",
    "end": "384110"
  },
  {
    "text": "also have to do bot detection our SEO or",
    "start": "384110",
    "end": "387649"
  },
  {
    "text": "SEO team with imp interests are heavy",
    "start": "387649",
    "end": "389059"
  },
  {
    "text": "clients of our team they want to know",
    "start": "389059",
    "end": "390680"
  },
  {
    "text": "when is Googlebot crawling when is",
    "start": "390680",
    "end": "392990"
  },
  {
    "text": "Facebook Bach crawling are we giving",
    "start": "392990",
    "end": "394580"
  },
  {
    "text": "them five hundreds or we getting to",
    "start": "394580",
    "end": "395779"
  },
  {
    "text": "hundreds so we did a bit of legwork to",
    "start": "395779",
    "end": "397909"
  },
  {
    "text": "write up a filter that builds off of the",
    "start": "397909",
    "end": "400129"
  },
  {
    "text": "IP tagging filter to identify bot",
    "start": "400129",
    "end": "402169"
  },
  {
    "text": "traffic pretty reliably since it's an",
    "start": "402169",
    "end": "405589"
  },
  {
    "text": "edge proxy we have to do access control",
    "start": "405589",
    "end": "407270"
  },
  {
    "text": "recognize whether the requests to pit -",
    "start": "407270",
    "end": "410479"
  },
  {
    "text": "envoy is an internal request whether it",
    "start": "410479",
    "end": "412430"
  },
  {
    "text": "can access certain services and lastly",
    "start": "412430",
    "end": "415039"
  },
  {
    "text": "what I'm gonna be talking about for the",
    "start": "415039",
    "end": "416059"
  },
  {
    "text": "bulk half of this talk is fronting an AP",
    "start": "416059",
    "end": "419629"
  },
  {
    "text": "deploy at Pinterest so that Pinterest we",
    "start": "419629",
    "end": "421490"
  },
  {
    "text": "have one service that is a be deployed",
    "start": "421490",
    "end": "423469"
  },
  {
    "text": "that's our website dr. pepper intercom",
    "start": "423469",
    "end": "425860"
  },
  {
    "text": "I'm gonna dive into the Okhrana then a",
    "start": "425860",
    "end": "428479"
  },
  {
    "text": "bit after we yeah there were a couple",
    "start": "428479",
    "end": "434409"
  },
  {
    "start": "432000",
    "end": "584000"
  },
  {
    "text": "migration hiccups along the way that ran",
    "start": "434409",
    "end": "436639"
  },
  {
    "text": "into envoy has the configuration to",
    "start": "436639",
    "end": "439339"
  },
  {
    "text": "handle X 44 for you and detect client IP",
    "start": "439339",
    "end": "441769"
  },
  {
    "text": "addresses which is great if you know how",
    "start": "441769",
    "end": "443809"
  },
  {
    "text": "many trusted hops you have in front of",
    "start": "443809",
    "end": "445009"
  },
  {
    "text": "you I'm in a guard case we have multiple",
    "start": "445009",
    "end": "446809"
  },
  {
    "text": "scenes and they make no guarantees about",
    "start": "446809",
    "end": "448819"
  },
  {
    "text": "how many trusted hops there are so we",
    "start": "448819",
    "end": "451309"
  },
  {
    "text": "adapted our CN request signing mechanism",
    "start": "451309",
    "end": "453919"
  },
  {
    "text": "to also proxy the trusted client IP",
    "start": "453919",
    "end": "456139"
  },
  {
    "text": "address",
    "start": "456139",
    "end": "457369"
  },
  {
    "text": "sometimes the trusted top would be one",
    "start": "457369",
    "end": "459259"
  },
  {
    "text": "for some of the C ends at b2 so we",
    "start": "459259",
    "end": "461990"
  },
  {
    "text": "couldn't rely on a static number",
    "start": "461990",
    "end": "463099"
  },
  {
    "text": "therefore trusted hops we also learned",
    "start": "463099",
    "end": "465860"
  },
  {
    "text": "the hard way that on point by default is",
    "start": "465860",
    "end": "468769"
  },
  {
    "text": "conservative about circuit breaking when",
    "start": "468769",
    "end": "470269"
  },
  {
    "text": "we were first running envoy and it was",
    "start": "470269",
    "end": "471769"
  },
  {
    "text": "pumping about 1,000 RPS compared to",
    "start": "471769",
    "end": "474199"
  },
  {
    "text": "varnish which was pushing out six or",
    "start": "474199",
    "end": "475550"
  },
  {
    "text": "seven thousand we were wondering what",
    "start": "475550",
    "end": "477349"
  },
  {
    "text": "we're doing wrong it turns out that by",
    "start": "477349",
    "end": "479119"
  },
  {
    "text": "default the upstream circuit breaker",
    "start": "479119",
    "end": "480289"
  },
  {
    "text": "limits at 1024 if you don't specify",
    "start": "480289",
    "end": "482089"
  },
  {
    "text": "anything and since we live in in HTTP",
    "start": "482089",
    "end": "484399"
  },
  {
    "text": "one world it's one request to one",
    "start": "484399",
    "end": "485930"
  },
  {
    "text": "connection so we were effectively",
    "start": "485930",
    "end": "487759"
  },
  {
    "text": "limited to 1,000 requests upstream until",
    "start": "487759",
    "end": "490249"
  },
  {
    "text": "we realized that we were missing a",
    "start": "490249",
    "end": "491509"
  },
  {
    "text": "configuration option hog restart across",
    "start": "491509",
    "end": "494029"
  },
  {
    "text": "containers took a bit of work to get",
    "start": "494029",
    "end": "495800"
  },
  {
    "text": "going since for har we starting each",
    "start": "495800",
    "end": "497479"
  },
  {
    "text": "shared memory and shared networking",
    "start": "497479",
    "end": "498800"
  },
  {
    "text": "space",
    "start": "498800",
    "end": "499800"
  },
  {
    "text": "that was pretty easy to do once you have",
    "start": "499800",
    "end": "501870"
  },
  {
    "text": "the doctrine configurations to share the",
    "start": "501870",
    "end": "503370"
  },
  {
    "text": "memory space and network space and then",
    "start": "503370",
    "end": "505770"
  },
  {
    "text": "along the way we learned a lot of",
    "start": "505770",
    "end": "507810"
  },
  {
    "text": "services don't quiet respect HTTP the",
    "start": "507810",
    "end": "510330"
  },
  {
    "text": "way you want them to respect HTTP we",
    "start": "510330",
    "end": "513599"
  },
  {
    "text": "found a service that was using a library",
    "start": "513599",
    "end": "515399"
  },
  {
    "text": "whose header parser was still case",
    "start": "515399",
    "end": "517950"
  },
  {
    "text": "sensitive so when they should be in",
    "start": "517950",
    "end": "520529"
  },
  {
    "text": "front and lower case all the headers",
    "start": "520529",
    "end": "521578"
  },
  {
    "text": "that service broke there was another fun",
    "start": "521579",
    "end": "524399"
  },
  {
    "text": "bug where an older version of finagle or",
    "start": "524399",
    "end": "526769"
  },
  {
    "text": "some buggy version that we were using if",
    "start": "526769",
    "end": "528930"
  },
  {
    "text": "the response was empty it would put too",
    "start": "528930",
    "end": "531089"
  },
  {
    "text": "content length headers in the response",
    "start": "531089",
    "end": "533480"
  },
  {
    "text": "which if you read the art of C it says",
    "start": "533480",
    "end": "536269"
  },
  {
    "text": "you can either collapse them into one",
    "start": "536269",
    "end": "539220"
  },
  {
    "text": "header or just call it request invalid",
    "start": "539220",
    "end": "541200"
  },
  {
    "text": "and from Akito garnish was perfectly",
    "start": "541200",
    "end": "543630"
  },
  {
    "text": "fine with it but when Envoy jumped in",
    "start": "543630",
    "end": "545370"
  },
  {
    "text": "front with nodes HTTP parser it was",
    "start": "545370",
    "end": "547019"
  },
  {
    "text": "started rejecting all those requests",
    "start": "547019",
    "end": "548640"
  },
  {
    "text": "which mostly were health check requests",
    "start": "548640",
    "end": "551220"
  },
  {
    "text": "so these services just started failing",
    "start": "551220",
    "end": "553769"
  },
  {
    "text": "health checks for no reason that was a",
    "start": "553769",
    "end": "556649"
  },
  {
    "text": "ton of fun to debug not really so just a",
    "start": "556649",
    "end": "559200"
  },
  {
    "text": "bunch of really fun interesting ways",
    "start": "559200",
    "end": "560750"
  },
  {
    "text": "that things can break when you replace a",
    "start": "560750",
    "end": "563279"
  },
  {
    "text": "north-south proxy you learn the hard way",
    "start": "563279",
    "end": "565740"
  },
  {
    "text": "that you have a lot of inherent",
    "start": "565740",
    "end": "567270"
  },
  {
    "text": "dependencies you don't know about so",
    "start": "567270",
    "end": "568980"
  },
  {
    "text": "it's critical to try to get as close on",
    "start": "568980",
    "end": "571350"
  },
  {
    "text": "par functionality as you can even if you",
    "start": "571350",
    "end": "573300"
  },
  {
    "text": "think and this isn't gonna make a",
    "start": "573300",
    "end": "574529"
  },
  {
    "text": "difference",
    "start": "574529",
    "end": "575070"
  },
  {
    "text": "someone downstream is depending on that",
    "start": "575070",
    "end": "577079"
  },
  {
    "text": "I think they call it Hiram's law of",
    "start": "577079",
    "end": "578670"
  },
  {
    "text": "sovereign sneering that anything that is",
    "start": "578670",
    "end": "580380"
  },
  {
    "text": "observable people will depend upon so",
    "start": "580380",
    "end": "583320"
  },
  {
    "text": "getting everything as close as possible",
    "start": "583320",
    "end": "584160"
  },
  {
    "start": "584000",
    "end": "621000"
  },
  {
    "text": "is critical",
    "start": "584160",
    "end": "585470"
  },
  {
    "text": "okay so jumping into AP deploys so with",
    "start": "585470",
    "end": "589410"
  },
  {
    "text": "the website dub dub dub dub fitter comm",
    "start": "589410",
    "end": "591149"
  },
  {
    "text": "we have this requirement that when a",
    "start": "591149",
    "end": "593430"
  },
  {
    "text": "user starts the recession of interest",
    "start": "593430",
    "end": "595350"
  },
  {
    "text": "they continue to see the same version",
    "start": "595350",
    "end": "597600"
  },
  {
    "text": "throughout their browsing session",
    "start": "597600",
    "end": "599040"
  },
  {
    "text": "Pinterest is the kind of application",
    "start": "599040",
    "end": "600839"
  },
  {
    "text": "where people don't check it every five",
    "start": "600839",
    "end": "602760"
  },
  {
    "text": "minutes they typically sit down pour a",
    "start": "602760",
    "end": "604980"
  },
  {
    "text": "glass of wine and start scrolling",
    "start": "604980",
    "end": "605970"
  },
  {
    "text": "through boards of interior design and",
    "start": "605970",
    "end": "608370"
  },
  {
    "text": "gardening in recipes it's very",
    "start": "608370",
    "end": "609930"
  },
  {
    "text": "meditative therapeutic process so we",
    "start": "609930",
    "end": "612810"
  },
  {
    "text": "want make sure we don't disrupt that",
    "start": "612810",
    "end": "613920"
  },
  {
    "text": "throughout their browsing session so",
    "start": "613920",
    "end": "615510"
  },
  {
    "text": "once the user starts their session we",
    "start": "615510",
    "end": "617160"
  },
  {
    "text": "want to keep serving in the same version",
    "start": "617160",
    "end": "618660"
  },
  {
    "text": "even if a deploy happens we don't want",
    "start": "618660",
    "end": "620550"
  },
  {
    "text": "that deployed to disrupt their",
    "start": "620550",
    "end": "621810"
  },
  {
    "start": "621000",
    "end": "656000"
  },
  {
    "text": "experience so the way that this has",
    "start": "621810",
    "end": "624240"
  },
  {
    "text": "historically been solved is every web",
    "start": "624240",
    "end": "627899"
  },
  {
    "text": "machine has two versions of the website",
    "start": "627899",
    "end": "630449"
  },
  {
    "text": "and a version and a B version and",
    "start": "630449",
    "end": "633270"
  },
  {
    "text": "we deploy when we deploy the website it",
    "start": "633270",
    "end": "636000"
  },
  {
    "text": "goes to one of the versions and the user",
    "start": "636000",
    "end": "637500"
  },
  {
    "text": "can still access the old version through",
    "start": "637500",
    "end": "640170"
  },
  {
    "text": "a request header that the browser sets",
    "start": "640170",
    "end": "641820"
  },
  {
    "text": "or our JavaScript client sets so that B",
    "start": "641820",
    "end": "644310"
  },
  {
    "text": "version is still available and then once",
    "start": "644310",
    "end": "645840"
  },
  {
    "text": "their session ends and it come back on",
    "start": "645840",
    "end": "647370"
  },
  {
    "text": "to Pinterest then they gave up to the",
    "start": "647370",
    "end": "648540"
  },
  {
    "text": "new version that has been launched so",
    "start": "648540",
    "end": "650790"
  },
  {
    "text": "we're running these two versions at all",
    "start": "650790",
    "end": "651810"
  },
  {
    "text": "times which has been fine and then okay",
    "start": "651810",
    "end": "657360"
  },
  {
    "start": "656000",
    "end": "670000"
  },
  {
    "text": "so to route to these different versions",
    "start": "657360",
    "end": "659040"
  },
  {
    "text": "we use these subsets load balancer to do",
    "start": "659040",
    "end": "660870"
  },
  {
    "text": "so we attach the version as an endpoint",
    "start": "660870",
    "end": "664650"
  },
  {
    "text": "metadata and the request sends the",
    "start": "664650",
    "end": "667200"
  },
  {
    "text": "version header that comes in and so we",
    "start": "667200",
    "end": "669870"
  },
  {
    "text": "wrote a little glue filter called a",
    "start": "669870",
    "end": "671250"
  },
  {
    "start": "670000",
    "end": "684000"
  },
  {
    "text": "header to metadata filter if you have",
    "start": "671250",
    "end": "673020"
  },
  {
    "text": "seen this in in the quorum wondered what",
    "start": "673020",
    "end": "675900"
  },
  {
    "text": "the heck is this for we use this to",
    "start": "675900",
    "end": "677580"
  },
  {
    "text": "solve the problem of matching request",
    "start": "677580",
    "end": "679260"
  },
  {
    "text": "headers to endpoint metadata say that up",
    "start": "679260",
    "end": "686520"
  },
  {
    "start": "684000",
    "end": "787000"
  },
  {
    "text": "however we put on point front of this a",
    "start": "686520",
    "end": "689160"
  },
  {
    "text": "B cluster and something everything",
    "start": "689160",
    "end": "690900"
  },
  {
    "text": "happened CPU usage jumped up to a",
    "start": "690900",
    "end": "693570"
  },
  {
    "text": "hundred percent almost a hundred percent",
    "start": "693570",
    "end": "695150"
  },
  {
    "text": "and the worst part about this this was",
    "start": "695150",
    "end": "698130"
  },
  {
    "text": "the last deploy group we were trying to",
    "start": "698130",
    "end": "700020"
  },
  {
    "text": "get upon point out we had like three",
    "start": "700020",
    "end": "701250"
  },
  {
    "text": "successful deploy groups go out this was",
    "start": "701250",
    "end": "703560"
  },
  {
    "text": "the fourth one the main one DUP DUP DUP",
    "start": "703560",
    "end": "705360"
  },
  {
    "text": "here we go and CPU skyrocketed so we had",
    "start": "705360",
    "end": "707640"
  },
  {
    "text": "to take it out and do a bit of homework",
    "start": "707640",
    "end": "709470"
  },
  {
    "text": "into what's going on so we ran perf top",
    "start": "709470",
    "end": "712380"
  },
  {
    "text": "on Envoy while was fronting this deploy",
    "start": "712380",
    "end": "714180"
  },
  {
    "text": "which perf top is a wonderful way to get",
    "start": "714180",
    "end": "716550"
  },
  {
    "text": "to know any piece of software and we saw",
    "start": "716550",
    "end": "718830"
  },
  {
    "text": "this this function this update function",
    "start": "718830",
    "end": "721980"
  },
  {
    "text": "taking up 86% of CPU time and if you",
    "start": "721980",
    "end": "725070"
  },
  {
    "text": "look three lines above that is I think",
    "start": "725070",
    "end": "727080"
  },
  {
    "text": "says cluster update membership or up to",
    "start": "727080",
    "end": "729060"
  },
  {
    "text": "membership cluster uh-huh okay so what's",
    "start": "729060",
    "end": "731760"
  },
  {
    "text": "going on here so we did a bit more",
    "start": "731760",
    "end": "733290"
  },
  {
    "text": "diving and the the caveat of having the",
    "start": "733290",
    "end": "737310"
  },
  {
    "text": "a/b deploy worked away was where we have",
    "start": "737310",
    "end": "738930"
  },
  {
    "text": "two versions on every machine meant that",
    "start": "738930",
    "end": "741180"
  },
  {
    "text": "however many web hosts you have double",
    "start": "741180",
    "end": "744060"
  },
  {
    "text": "that and that's actually how many",
    "start": "744060",
    "end": "745520"
  },
  {
    "text": "endpoints envoy has so however big the",
    "start": "745520",
    "end": "748140"
  },
  {
    "text": "fleet was double that and that's on the",
    "start": "748140",
    "end": "749640"
  },
  {
    "text": "endpoints and a fleet of that size is",
    "start": "749640",
    "end": "752910"
  },
  {
    "text": "constantly experiencing health check",
    "start": "752910",
    "end": "754380"
  },
  {
    "text": "churn ho start dying hosts are launching",
    "start": "754380",
    "end": "756540"
  },
  {
    "text": "auto skill and kicks in a deploy happens",
    "start": "756540",
    "end": "758730"
  },
  {
    "text": "that causes health checks to turn and at",
    "start": "758730",
    "end": "761220"
  },
  {
    "text": "that scale what you're doing when you",
    "start": "761220",
    "end": "764070"
  },
  {
    "text": "update the health check is that Envoy",
    "start": "764070",
    "end": "765840"
  },
  {
    "text": "has to not only",
    "start": "765840",
    "end": "766649"
  },
  {
    "text": "take the cluster membership but when",
    "start": "766649",
    "end": "768420"
  },
  {
    "text": "used the subset load balancer it also",
    "start": "768420",
    "end": "769709"
  },
  {
    "text": "needs to update all of its subsets and",
    "start": "769709",
    "end": "771509"
  },
  {
    "text": "keep track of who was in what subset he",
    "start": "771509",
    "end": "773309"
  },
  {
    "text": "was still alive etc so this constant",
    "start": "773309",
    "end": "775769"
  },
  {
    "text": "continual churn was really pecking the",
    "start": "775769",
    "end": "778439"
  },
  {
    "text": "CPU and so we had to come up with a",
    "start": "778439",
    "end": "780269"
  },
  {
    "text": "better way to do this",
    "start": "780269",
    "end": "781889"
  },
  {
    "text": "downsizing the fleet is not an option",
    "start": "781889",
    "end": "783869"
  },
  {
    "text": "unfortunately so I forgot how to how to",
    "start": "783869",
    "end": "786179"
  },
  {
    "text": "make this work so my teammate rubble",
    "start": "786179",
    "end": "789660"
  },
  {
    "start": "787000",
    "end": "823000"
  },
  {
    "text": "came up with this process that we call",
    "start": "789660",
    "end": "791670"
  },
  {
    "text": "health check coalescing the idea here is",
    "start": "791670",
    "end": "794009"
  },
  {
    "text": "to batch deliver updates of health check",
    "start": "794009",
    "end": "797129"
  },
  {
    "text": "membership so I think it's not by",
    "start": "797129",
    "end": "799139"
  },
  {
    "text": "default now an envoy but essentially you",
    "start": "799139",
    "end": "801569"
  },
  {
    "text": "can configure envoy to say check the",
    "start": "801569",
    "end": "804629"
  },
  {
    "text": "membership status every one second or",
    "start": "804629",
    "end": "806699"
  },
  {
    "text": "every three seconds rather than having",
    "start": "806699",
    "end": "808499"
  },
  {
    "text": "it constantly happen because we didn't",
    "start": "808499",
    "end": "810929"
  },
  {
    "text": "need sub second granularity on cluster",
    "start": "810929",
    "end": "812879"
  },
  {
    "text": "membership we just needed a general",
    "start": "812879",
    "end": "814230"
  },
  {
    "text": "update at least every couple of seconds",
    "start": "814230",
    "end": "816089"
  },
  {
    "text": "this dramatically fixed our CPU problem",
    "start": "816089",
    "end": "819420"
  },
  {
    "text": "and we were ready to go we were ready to",
    "start": "819420",
    "end": "821670"
  },
  {
    "text": "launch the Envoy so the AP the AP deploy",
    "start": "821670",
    "end": "826619"
  },
  {
    "start": "823000",
    "end": "862000"
  },
  {
    "text": "process is not perfect we've had a",
    "start": "826619",
    "end": "829980"
  },
  {
    "text": "number of incidents caused by this a be",
    "start": "829980",
    "end": "832889"
  },
  {
    "text": "deployed scenario yeah this is problem",
    "start": "832889",
    "end": "835860"
  },
  {
    "text": "favorite slack quote yet we had one",
    "start": "835860",
    "end": "838410"
  },
  {
    "text": "really bad incident where instead of",
    "start": "838410",
    "end": "840420"
  },
  {
    "text": "being an AP deploy it was an AAA deploy",
    "start": "840420",
    "end": "842790"
  },
  {
    "text": "which is like the equivalent of",
    "start": "842790",
    "end": "844470"
  },
  {
    "text": "undefined behavior in our deployment",
    "start": "844470",
    "end": "846209"
  },
  {
    "text": "world and it turns out that defined",
    "start": "846209",
    "end": "848370"
  },
  {
    "text": "behavior means machines break in",
    "start": "848370",
    "end": "849959"
  },
  {
    "text": "fantastic ways so we needed a better",
    "start": "849959",
    "end": "851970"
  },
  {
    "text": "solution and now that we had Envoy in",
    "start": "851970",
    "end": "854399"
  },
  {
    "text": "place running our website we thought we",
    "start": "854399",
    "end": "857759"
  },
  {
    "text": "had the building blocks needed to come",
    "start": "857759",
    "end": "859110"
  },
  {
    "text": "up with a better more robust and",
    "start": "859110",
    "end": "860490"
  },
  {
    "text": "scalable solution so these are the",
    "start": "860490",
    "end": "865439"
  },
  {
    "start": "862000",
    "end": "877000"
  },
  {
    "text": "constraints that we had to abide by in",
    "start": "865439",
    "end": "866879"
  },
  {
    "text": "our new deploy scenario we still had to",
    "start": "866879",
    "end": "869009"
  },
  {
    "text": "pin users to a certain version that",
    "start": "869009",
    "end": "871620"
  },
  {
    "text": "couldn't change the model that we were",
    "start": "871620",
    "end": "873959"
  },
  {
    "text": "going for was what we call staged",
    "start": "873959",
    "end": "875549"
  },
  {
    "text": "deploys staged base deploys essentially",
    "start": "875549",
    "end": "878610"
  },
  {
    "start": "877000",
    "end": "960000"
  },
  {
    "text": "you divide up your clusters into stages",
    "start": "878610",
    "end": "880350"
  },
  {
    "text": "so canary staging fraud the usual one",
    "start": "880350",
    "end": "883439"
  },
  {
    "text": "thing you're all probably familiar with",
    "start": "883439",
    "end": "884329"
  },
  {
    "text": "and each stage should have a virgin",
    "start": "884329",
    "end": "886589"
  },
  {
    "text": "write and handling this stuff by default",
    "start": "886589",
    "end": "889559"
  },
  {
    "text": "an envoy is pretty easy to do it's",
    "start": "889559",
    "end": "891029"
  },
  {
    "text": "pretty easy to map version production",
    "start": "891029",
    "end": "893069"
  },
  {
    "text": "whatever using the subset of a balancer",
    "start": "893069",
    "end": "895410"
  },
  {
    "text": "and the metadata but the caveat is",
    "start": "895410",
    "end": "897569"
  },
  {
    "text": "pinning users to your particular version",
    "start": "897569",
    "end": "900470"
  },
  {
    "text": "and in stage so okay cool not getting",
    "start": "900470",
    "end": "908240"
  },
  {
    "text": "head actually so the way that we solved",
    "start": "908240",
    "end": "913910"
  },
  {
    "text": "this is we have the end points all we",
    "start": "913910",
    "end": "918860"
  },
  {
    "text": "have ets served which has the stage and",
    "start": "918860",
    "end": "921530"
  },
  {
    "text": "version those lot go up into zookeeper",
    "start": "921530",
    "end": "923540"
  },
  {
    "text": "and the sidecar process will pull this",
    "start": "923540",
    "end": "926450"
  },
  {
    "text": "down and writing directly ideas we then",
    "start": "926450",
    "end": "928340"
  },
  {
    "text": "came up with something called a route",
    "start": "928340",
    "end": "929540"
  },
  {
    "text": "map the route map is a map indicating",
    "start": "929540",
    "end": "933470"
  },
  {
    "text": "how many hosts are available to serve",
    "start": "933470",
    "end": "935390"
  },
  {
    "text": "each permutation of stage and version",
    "start": "935390",
    "end": "938090"
  },
  {
    "text": "because we could say that we want to",
    "start": "938090",
    "end": "939380"
  },
  {
    "text": "target sending 20% of users to version a",
    "start": "939380",
    "end": "942020"
  },
  {
    "text": "but if only 5% of machines are serving",
    "start": "942020",
    "end": "944810"
  },
  {
    "text": "version a we might accidentally overload",
    "start": "944810",
    "end": "946400"
  },
  {
    "text": "those machines so you also make sure",
    "start": "946400",
    "end": "947600"
  },
  {
    "text": "we're not saying too much traffic to a",
    "start": "947600",
    "end": "949130"
  },
  {
    "text": "particular permutation so the sidecar",
    "start": "949130",
    "end": "951950"
  },
  {
    "text": "generates two artifacts the EDS so that",
    "start": "951950",
    "end": "954110"
  },
  {
    "text": "way the subset lab on site can use",
    "start": "954110",
    "end": "955640"
  },
  {
    "text": "matching and also this route map which",
    "start": "955640",
    "end": "957170"
  },
  {
    "text": "gets consumed by a filter rewrote so the",
    "start": "957170",
    "end": "961910"
  },
  {
    "start": "960000",
    "end": "1023000"
  },
  {
    "text": "filter that we wrote does is whenever",
    "start": "961910",
    "end": "963440"
  },
  {
    "text": "request comes into envoy if there it'll",
    "start": "963440",
    "end": "966320"
  },
  {
    "text": "try to sign it a routing ID if one does",
    "start": "966320",
    "end": "967850"
  },
  {
    "text": "not exist this is just unique",
    "start": "967850",
    "end": "969230"
  },
  {
    "text": "identifiers so that way when this trip",
    "start": "969230",
    "end": "970820"
  },
  {
    "text": "this user comes back we can send them to",
    "start": "970820",
    "end": "972950"
  },
  {
    "text": "the same version and stage without",
    "start": "972950",
    "end": "975020"
  },
  {
    "text": "having the flat between anything the B",
    "start": "975020",
    "end": "978860"
  },
  {
    "text": "filter then collects the capacity",
    "start": "978860",
    "end": "981050"
  },
  {
    "text": "measurements from the route map which I",
    "start": "981050",
    "end": "983960"
  },
  {
    "text": "forgot to mention is injected by runtime",
    "start": "983960",
    "end": "985940"
  },
  {
    "text": "data so this the sidecar as I mentioned",
    "start": "985940",
    "end": "989780"
  },
  {
    "text": "it's a sidecar it sits on the host so it",
    "start": "989780",
    "end": "991400"
  },
  {
    "text": "has access to on point to directly pass",
    "start": "991400",
    "end": "993110"
  },
  {
    "text": "it runtime values so the filter will",
    "start": "993110",
    "end": "995300"
  },
  {
    "text": "read those runtime values for the",
    "start": "995300",
    "end": "996470"
  },
  {
    "text": "capacity and then compute where should",
    "start": "996470",
    "end": "998960"
  },
  {
    "text": "this request go and then at once all",
    "start": "998960",
    "end": "1002170"
  },
  {
    "text": "those computations are done it's just a",
    "start": "1002170",
    "end": "1004090"
  },
  {
    "text": "matter of setting the metadata on the",
    "start": "1004090",
    "end": "1005770"
  },
  {
    "text": "request and then letting the request go",
    "start": "1005770",
    "end": "1007510"
  },
  {
    "text": "on its merry way onto the subset load",
    "start": "1007510",
    "end": "1008950"
  },
  {
    "text": "balancer to get matched and then of",
    "start": "1008950",
    "end": "1010420"
  },
  {
    "text": "course since we're having a filter in",
    "start": "1010420",
    "end": "1011590"
  },
  {
    "text": "here it's a great place to put in some",
    "start": "1011590",
    "end": "1013000"
  },
  {
    "text": "custom metrics so that we can see what",
    "start": "1013000",
    "end": "1014800"
  },
  {
    "text": "the decision split is how many requests",
    "start": "1014800",
    "end": "1017740"
  },
  {
    "text": "come in that don't have a routing idea",
    "start": "1017740",
    "end": "1019060"
  },
  {
    "text": "at all just some good metrics to keep",
    "start": "1019060",
    "end": "1021310"
  },
  {
    "text": "track of",
    "start": "1021310",
    "end": "1023610"
  },
  {
    "start": "1023000",
    "end": "1068000"
  },
  {
    "text": "so kind of to explain it's more explicit",
    "start": "1025280",
    "end": "1028100"
  },
  {
    "text": "the interfaces that we have so we have",
    "start": "1028100",
    "end": "1029660"
  },
  {
    "text": "the control plane which receives input",
    "start": "1029660",
    "end": "1031160"
  },
  {
    "text": "from zookeeper and produces the two two",
    "start": "1031160",
    "end": "1034010"
  },
  {
    "text": "outputs EDS and the brow map which has",
    "start": "1034010",
    "end": "1036110"
  },
  {
    "text": "capacity then the filter just consumes",
    "start": "1036110",
    "end": "1040069"
  },
  {
    "text": "that route map runs a computation to see",
    "start": "1040070",
    "end": "1042680"
  },
  {
    "text": "where systems request and then applies",
    "start": "1042680",
    "end": "1044660"
  },
  {
    "text": "the metadata at the request and let the",
    "start": "1044660",
    "end": "1046550"
  },
  {
    "text": "subset load balancer consume the",
    "start": "1046550",
    "end": "1047900"
  },
  {
    "text": "endpoint discovery service and do all",
    "start": "1047900",
    "end": "1049250"
  },
  {
    "text": "the heavy lifting for us so the amount",
    "start": "1049250",
    "end": "1050960"
  },
  {
    "text": "of code it took to implement this really",
    "start": "1050960",
    "end": "1052340"
  },
  {
    "text": "wasn't that much I think there's only a",
    "start": "1052340",
    "end": "1053660"
  },
  {
    "text": "couple hundred lines of go in C++ and",
    "start": "1053660",
    "end": "1055400"
  },
  {
    "text": "majority that was unit tests so the",
    "start": "1055400",
    "end": "1058130"
  },
  {
    "text": "subset lavon's are provided a great",
    "start": "1058130",
    "end": "1059840"
  },
  {
    "text": "building block to build complex routing",
    "start": "1059840",
    "end": "1061880"
  },
  {
    "text": "schemes all we had to do was set the",
    "start": "1061880",
    "end": "1063440"
  },
  {
    "text": "metadata to any flexibility that we",
    "start": "1063440",
    "end": "1065990"
  },
  {
    "text": "needed so as I mentioned so we had to go",
    "start": "1065990",
    "end": "1072140"
  },
  {
    "start": "1068000",
    "end": "1106000"
  },
  {
    "text": "to this custom solution so envoy has a",
    "start": "1072140",
    "end": "1074020"
  },
  {
    "text": "feature in it called subset localities",
    "start": "1074020",
    "end": "1077750"
  },
  {
    "text": "we can set the weights per subset which",
    "start": "1077750",
    "end": "1080150"
  },
  {
    "text": "works great if you want to do traffic",
    "start": "1080150",
    "end": "1081710"
  },
  {
    "text": "distribution on a request by a quest",
    "start": "1081710",
    "end": "1083120"
  },
  {
    "text": "basis but as mentioned we have this",
    "start": "1083120",
    "end": "1085000"
  },
  {
    "text": "constraint of pinning not just requests",
    "start": "1085000",
    "end": "1087680"
  },
  {
    "text": "to a certain version but users so we",
    "start": "1087680",
    "end": "1090380"
  },
  {
    "text": "found that the localities the subset",
    "start": "1090380",
    "end": "1093170"
  },
  {
    "text": "locality weights didn't really work for",
    "start": "1093170",
    "end": "1094610"
  },
  {
    "text": "us because it would shard traffic and",
    "start": "1094610",
    "end": "1096290"
  },
  {
    "text": "could potentially flap users between",
    "start": "1096290",
    "end": "1097760"
  },
  {
    "text": "some requests go to certain stage some",
    "start": "1097760",
    "end": "1100220"
  },
  {
    "text": "requests go to a different stage I",
    "start": "1100220",
    "end": "1101630"
  },
  {
    "text": "wanted to keep that screens cohesive for",
    "start": "1101630",
    "end": "1103880"
  },
  {
    "text": "our users lastly my problem favorite",
    "start": "1103880",
    "end": "1109850"
  },
  {
    "start": "1106000",
    "end": "1119000"
  },
  {
    "text": "part about envoy is how many metrics it",
    "start": "1109850",
    "end": "1112700"
  },
  {
    "text": "emits I did a quick little measurement I",
    "start": "1112700",
    "end": "1115700"
  },
  {
    "text": "think it's something like 1300 metrics",
    "start": "1115700",
    "end": "1117620"
  },
  {
    "text": "out the box for one of our deployments",
    "start": "1117620",
    "end": "1120110"
  },
  {
    "start": "1119000",
    "end": "1147000"
  },
  {
    "text": "it's fantastic my favorite thing about",
    "start": "1120110",
    "end": "1121400"
  },
  {
    "text": "it these are some things that we learn",
    "start": "1121400",
    "end": "1123290"
  },
  {
    "text": "on we have the basics like high CPU disk",
    "start": "1123290",
    "end": "1125990"
  },
  {
    "text": "those those come from just a tea",
    "start": "1125990",
    "end": "1127520"
  },
  {
    "text": "collector module that's querying the",
    "start": "1127520",
    "end": "1129260"
  },
  {
    "text": "system metrics and then we also learn a",
    "start": "1129260",
    "end": "1131690"
  },
  {
    "text": "variety of failure cases these are very",
    "start": "1131690",
    "end": "1135200"
  },
  {
    "text": "helpful for diagnosing issues in",
    "start": "1135200",
    "end": "1136850"
  },
  {
    "text": "production when things break why they're",
    "start": "1136850",
    "end": "1138410"
  },
  {
    "text": "breaking and fantastically Hong call is",
    "start": "1138410",
    "end": "1142400"
  },
  {
    "text": "very quiet envoy is very level if you",
    "start": "1142400",
    "end": "1144080"
  },
  {
    "text": "software as Matt mentioned what's great",
    "start": "1144080",
    "end": "1147650"
  },
  {
    "start": "1147000",
    "end": "1172000"
  },
  {
    "text": "is seeing other people's reaction to how",
    "start": "1147650",
    "end": "1149240"
  },
  {
    "text": "much observability we have so envoy by",
    "start": "1149240",
    "end": "1151880"
  },
  {
    "text": "default has metrics on a per cluster",
    "start": "1151880",
    "end": "1153800"
  },
  {
    "text": "basis that's something that's",
    "start": "1153800",
    "end": "1155170"
  },
  {
    "text": "practically new to our edge tier so the",
    "start": "1155170",
    "end": "1158120"
  },
  {
    "text": "fact that we can see",
    "start": "1158120",
    "end": "1159170"
  },
  {
    "text": "spike in five hundreds exactly which",
    "start": "1159170",
    "end": "1161060"
  },
  {
    "text": "upstream cause those five hundreds that",
    "start": "1161060",
    "end": "1163280"
  },
  {
    "text": "has been freely revolutionary for a",
    "start": "1163280",
    "end": "1165470"
  },
  {
    "text": "series and we even had a little hot boy",
    "start": "1165470",
    "end": "1167960"
  },
  {
    "text": "I'm gonna be calling to slack so looking",
    "start": "1167960",
    "end": "1175880"
  },
  {
    "start": "1172000",
    "end": "1228000"
  },
  {
    "text": "to the future so we have on play running",
    "start": "1175880",
    "end": "1177920"
  },
  {
    "text": "100% of our edge deployment we are",
    "start": "1177920",
    "end": "1179690"
  },
  {
    "text": "looking at the service miss scenario our",
    "start": "1179690",
    "end": "1181400"
  },
  {
    "text": "case is a little bit interesting because",
    "start": "1181400",
    "end": "1183050"
  },
  {
    "text": "we are a thrift shop and not only our",
    "start": "1183050",
    "end": "1185600"
  },
  {
    "text": "third shop but we have multiple dialects",
    "start": "1185600",
    "end": "1187520"
  },
  {
    "text": "of thrift that run within Pinterest so",
    "start": "1187520",
    "end": "1189410"
  },
  {
    "text": "if we reckon out how to get all the",
    "start": "1189410",
    "end": "1190370"
  },
  {
    "text": "standardized and figure out how to get",
    "start": "1190370",
    "end": "1191750"
  },
  {
    "text": "envoy and way that can support all those",
    "start": "1191750",
    "end": "1193700"
  },
  {
    "text": "permutations of functionality is gonna",
    "start": "1193700",
    "end": "1196400"
  },
  {
    "text": "be a fun challenge we are looking at the",
    "start": "1196400",
    "end": "1199070"
  },
  {
    "text": "possibility of integrating memcached in",
    "start": "1199070",
    "end": "1200900"
  },
  {
    "text": "some way maybe it as a network filter",
    "start": "1200900",
    "end": "1202330"
  },
  {
    "text": "and we're keeping an eye on the my",
    "start": "1202330",
    "end": "1204440"
  },
  {
    "text": "sequel and Kafka filters very closely as",
    "start": "1204440",
    "end": "1206330"
  },
  {
    "text": "we are heavy users of those systems and",
    "start": "1206330",
    "end": "1210130"
  },
  {
    "text": "with envoy at the edge we're looking at",
    "start": "1210130",
    "end": "1212780"
  },
  {
    "text": "moving a lot of our authentication",
    "start": "1212780",
    "end": "1215360"
  },
  {
    "text": "authorization functionality out to the",
    "start": "1215360",
    "end": "1216950"
  },
  {
    "text": "edge and doing everything there that",
    "start": "1216950",
    "end": "1218900"
  },
  {
    "text": "requires looking doing lookaside request",
    "start": "1218900",
    "end": "1220910"
  },
  {
    "text": "other services in thrift so we'll so we",
    "start": "1220910",
    "end": "1222530"
  },
  {
    "text": "need both out there at foundational work",
    "start": "1222530",
    "end": "1223960"
  },
  {
    "text": "but rogue decided to push that in this",
    "start": "1223960",
    "end": "1226490"
  },
  {
    "text": "coming year that was everything I had I",
    "start": "1226490",
    "end": "1229700"
  },
  {
    "start": "1228000",
    "end": "1555000"
  },
  {
    "text": "think it's big a little fast but I have",
    "start": "1229700",
    "end": "1231290"
  },
  {
    "text": "plenty of time for questions thank you",
    "start": "1231290",
    "end": "1235270"
  },
  {
    "text": "[Applause]",
    "start": "1239310",
    "end": "1240959"
  },
  {
    "text": "yes",
    "start": "1240959",
    "end": "1243959"
  },
  {
    "text": "multiple CD ends with what so this is",
    "start": "1247229",
    "end": "1252459"
  },
  {
    "text": "particularly dynamic path so all of our",
    "start": "1252459",
    "end": "1254409"
  },
  {
    "text": "static content to serve data s3 directly",
    "start": "1254409",
    "end": "1256269"
  },
  {
    "text": "and so we should use multiple CD ends to",
    "start": "1256269",
    "end": "1258879"
  },
  {
    "text": "optimize for availability and",
    "start": "1258879",
    "end": "1260889"
  },
  {
    "text": "performance in various parts of the",
    "start": "1260889",
    "end": "1261879"
  },
  {
    "text": "world yes it was mostly operability and",
    "start": "1261879",
    "end": "1276190"
  },
  {
    "text": "reliability so he asked what was the",
    "start": "1276190",
    "end": "1280869"
  },
  {
    "text": "what was the end user impact of running",
    "start": "1280869",
    "end": "1282369"
  },
  {
    "text": "on boy at the edge so there wasn't much",
    "start": "1282369",
    "end": "1285249"
  },
  {
    "text": "in terms of user facing things like",
    "start": "1285249",
    "end": "1286869"
  },
  {
    "text": "users didn't necessarily know like",
    "start": "1286869",
    "end": "1288190"
  },
  {
    "text": "Pintrest are doing Neela balancer it was",
    "start": "1288190",
    "end": "1291159"
  },
  {
    "text": "mostly for our own engineering delight",
    "start": "1291159",
    "end": "1293440"
  },
  {
    "text": "in that we had better observability",
    "start": "1293440",
    "end": "1295799"
  },
  {
    "text": "things broke less often when they did",
    "start": "1295799",
    "end": "1298149"
  },
  {
    "text": "break it was really easy to debug",
    "start": "1298149",
    "end": "1299889"
  },
  {
    "text": "we had a very powerful control plane",
    "start": "1299889",
    "end": "1301779"
  },
  {
    "text": "that was very flexible and enabled us to",
    "start": "1301779",
    "end": "1304139"
  },
  {
    "text": "dream up of any complex interaction that",
    "start": "1304139",
    "end": "1307209"
  },
  {
    "text": "we needed and ah we could do it the",
    "start": "1307209",
    "end": "1309159"
  },
  {
    "text": "control plane fly is very powerful",
    "start": "1309159",
    "end": "1310299"
  },
  {
    "text": "puppeteering ap I like to think of it",
    "start": "1310299",
    "end": "1312070"
  },
  {
    "text": "something to say for operability yes",
    "start": "1312070",
    "end": "1320488"
  },
  {
    "text": "yes yes what the tool was for diagnosing",
    "start": "1323879",
    "end": "1325649"
  },
  {
    "text": "CP usage we just used perf and Perez",
    "start": "1325649",
    "end": "1327989"
  },
  {
    "text": "very sub tools I perf top if you use",
    "start": "1327989",
    "end": "1331379"
  },
  {
    "text": "Brent and Greg's flame graph tool that's",
    "start": "1331379",
    "end": "1333329"
  },
  {
    "text": "an excellent tool for visualizing CPU",
    "start": "1333329",
    "end": "1335639"
  },
  {
    "text": "performance yes great question so we",
    "start": "1335639",
    "end": "1345479"
  },
  {
    "text": "have two different deployments our main",
    "start": "1345479",
    "end": "1347369"
  },
  {
    "text": "two so yes if we expose on weight",
    "start": "1347369",
    "end": "1350069"
  },
  {
    "text": "directly to the internet most of our",
    "start": "1350069",
    "end": "1352049"
  },
  {
    "text": "deployments are fronted by a CDN who",
    "start": "1352049",
    "end": "1354479"
  },
  {
    "text": "implements the request signing words to",
    "start": "1354479",
    "end": "1355889"
  },
  {
    "text": "verify that requests are going to the",
    "start": "1355889",
    "end": "1357419"
  },
  {
    "text": "CDN so for the most part stretch of",
    "start": "1357419",
    "end": "1358829"
  },
  {
    "text": "traffic we do have one deployment that",
    "start": "1358829",
    "end": "1361589"
  },
  {
    "text": "does face the OP internet yeah does that",
    "start": "1361589",
    "end": "1364709"
  },
  {
    "text": "answer question on a secured respective",
    "start": "1364709",
    "end": "1370829"
  },
  {
    "text": "how we decided it",
    "start": "1370829",
    "end": "1373518"
  },
  {
    "text": "yeah",
    "start": "1373969",
    "end": "1375889"
  },
  {
    "text": "sir from security perspective for the",
    "start": "1375889",
    "end": "1378239"
  },
  {
    "text": "internet facing one are you talking",
    "start": "1378239",
    "end": "1379739"
  },
  {
    "text": "about yeah so the interface facing",
    "start": "1379739",
    "end": "1382739"
  },
  {
    "text": "service just has a history of not being",
    "start": "1382739",
    "end": "1384419"
  },
  {
    "text": "fronted by CDN for a number of reasons",
    "start": "1384419",
    "end": "1386819"
  },
  {
    "text": "that it's a logging endpoint and so yeah",
    "start": "1386819",
    "end": "1393719"
  },
  {
    "text": "there were the security of that has been",
    "start": "1393719",
    "end": "1397139"
  },
  {
    "text": "like before my time this is kind of how",
    "start": "1397139",
    "end": "1398940"
  },
  {
    "text": "that service is always run",
    "start": "1398940",
    "end": "1400859"
  },
  {
    "text": "we have experienced certain things like",
    "start": "1400859",
    "end": "1403289"
  },
  {
    "text": "syn flood attacks that have tried to",
    "start": "1403289",
    "end": "1404759"
  },
  {
    "text": "happen and those scenarios all went over",
    "start": "1404759",
    "end": "1408929"
  },
  {
    "text": "quite well we didn't experience and how",
    "start": "1408929",
    "end": "1411089"
  },
  {
    "text": "to do to those",
    "start": "1411089",
    "end": "1413778"
  },
  {
    "text": "yeah so the question was if we use it",
    "start": "1430580",
    "end": "1432500"
  },
  {
    "text": "appears to low balance multiple envoys",
    "start": "1432500",
    "end": "1434620"
  },
  {
    "text": "so we have one n lb per employed",
    "start": "1434620",
    "end": "1437510"
  },
  {
    "text": "deployment and each deployment consists",
    "start": "1437510",
    "end": "1439040"
  },
  {
    "text": "of n envoys yeah yes",
    "start": "1439040",
    "end": "1448750"
  },
  {
    "text": "great so the question was how routing",
    "start": "1456190",
    "end": "1459070"
  },
  {
    "text": "changes were expressed so in the",
    "start": "1459070",
    "end": "1460600"
  },
  {
    "text": "previous world with varnish we were",
    "start": "1460600",
    "end": "1461830"
  },
  {
    "text": "having VCL it was kind of up to traffic",
    "start": "1461830",
    "end": "1463540"
  },
  {
    "text": "engineers to make the changes on behalf",
    "start": "1463540",
    "end": "1465700"
  },
  {
    "text": "for the people because those route",
    "start": "1465700",
    "end": "1466900"
  },
  {
    "text": "tables grew so complex and there goes",
    "start": "1466900",
    "end": "1469000"
  },
  {
    "text": "Auto luck again and so with the change",
    "start": "1469000",
    "end": "1472330"
  },
  {
    "text": "to envoy essentially what that migration",
    "start": "1472330",
    "end": "1474400"
  },
  {
    "text": "consisted of is I would take the VCL and",
    "start": "1474400",
    "end": "1476110"
  },
  {
    "text": "just do an enumeration of what are all",
    "start": "1476110",
    "end": "1477790"
  },
  {
    "text": "the features that weren't read doing and",
    "start": "1477790",
    "end": "1479080"
  },
  {
    "text": "implement them into on which is a",
    "start": "1479080",
    "end": "1480820"
  },
  {
    "text": "checklist and now that the routes are",
    "start": "1480820",
    "end": "1482860"
  },
  {
    "text": "expressed as JSON files is very easy for",
    "start": "1482860",
    "end": "1484750"
  },
  {
    "text": "other engineers to go in and understand",
    "start": "1484750",
    "end": "1486040"
  },
  {
    "text": "what's happening and make the changes",
    "start": "1486040",
    "end": "1487060"
  },
  {
    "text": "themselves so we for now writing changes",
    "start": "1487060",
    "end": "1489850"
  },
  {
    "text": "it's just up to engineers to submit a",
    "start": "1489850",
    "end": "1491350"
  },
  {
    "text": "pull request who will review it ok it",
    "start": "1491350",
    "end": "1492910"
  },
  {
    "text": "and deploy it cool I think yes yes",
    "start": "1492910",
    "end": "1506400"
  },
  {
    "text": "on the onions itself so the question was",
    "start": "1509279",
    "end": "1515110"
  },
  {
    "text": "if we did any dust protection on the",
    "start": "1515110",
    "end": "1517870"
  },
  {
    "text": "novel instance the D yeah we we have",
    "start": "1517870",
    "end": "1525909"
  },
  {
    "text": "that as a hard set sized group so it's",
    "start": "1525909",
    "end": "1529809"
  },
  {
    "text": "susceptible to toss but we have firewall",
    "start": "1529809",
    "end": "1534159"
  },
  {
    "text": "rules to prevent that and yeah I'm not",
    "start": "1534159",
    "end": "1538059"
  },
  {
    "text": "too familiar with that deployments I",
    "start": "1538059",
    "end": "1539110"
  },
  {
    "text": "can't speak to it in great detail but we",
    "start": "1539110",
    "end": "1541390"
  },
  {
    "text": "have done a bunch of failure testing",
    "start": "1541390",
    "end": "1542529"
  },
  {
    "text": "with envoy in terms of what happens if",
    "start": "1542529",
    "end": "1544360"
  },
  {
    "text": "runs ICP or not a memory auto-scaling or",
    "start": "1544360",
    "end": "1546190"
  },
  {
    "text": "strains etc great thank you",
    "start": "1546190",
    "end": "1552570"
  },
  {
    "text": "[Applause]",
    "start": "1552770",
    "end": "1556549"
  }
]