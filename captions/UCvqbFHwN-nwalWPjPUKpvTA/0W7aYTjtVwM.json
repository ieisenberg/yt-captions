[
  {
    "start": "0",
    "end": "0"
  },
  {
    "text": "uh thank you for coming to the talk at",
    "start": "560",
    "end": "2800"
  },
  {
    "text": "the",
    "start": "2800",
    "end": "4080"
  },
  {
    "text": "nearly the conference",
    "start": "4080",
    "end": "5920"
  },
  {
    "text": "uh",
    "start": "5920",
    "end": "6960"
  },
  {
    "text": "as randy said the",
    "start": "6960",
    "end": "8639"
  },
  {
    "text": "title is context aware traffic routing",
    "start": "8639",
    "end": "11360"
  },
  {
    "text": "uh",
    "start": "11360",
    "end": "12400"
  },
  {
    "text": "here's the agenda for the talk",
    "start": "12400",
    "end": "14480"
  },
  {
    "text": "uh we're gonna talk a little bit about",
    "start": "14480",
    "end": "16960"
  },
  {
    "text": "ourselves explain to you what the",
    "start": "16960",
    "end": "19520"
  },
  {
    "text": "motivation you might have for doing",
    "start": "19520",
    "end": "22400"
  },
  {
    "text": "context-aware routing",
    "start": "22400",
    "end": "24000"
  },
  {
    "text": "discuss the issues involved",
    "start": "24000",
    "end": "26400"
  },
  {
    "text": "talk about the implementation",
    "start": "26400",
    "end": "28320"
  },
  {
    "text": "look at results uh",
    "start": "28320",
    "end": "30800"
  },
  {
    "text": "and then",
    "start": "30800",
    "end": "32078"
  },
  {
    "text": "talk more about",
    "start": "32079",
    "end": "33920"
  },
  {
    "text": "our prototype and we'll definitely have",
    "start": "33920",
    "end": "36160"
  },
  {
    "text": "time at the end for questions",
    "start": "36160",
    "end": "38399"
  },
  {
    "text": "uh my name is pial i'm a senior staff",
    "start": "38399",
    "end": "40800"
  },
  {
    "text": "software engineer at niantic",
    "start": "40800",
    "end": "43280"
  },
  {
    "text": "na i'm a soft staff software engineer at",
    "start": "43280",
    "end": "46000"
  },
  {
    "text": "nandi",
    "start": "46000",
    "end": "48079"
  },
  {
    "text": "uh let's jump right in",
    "start": "48079",
    "end": "50239"
  },
  {
    "start": "50000",
    "end": "50000"
  },
  {
    "text": "uh",
    "start": "50239",
    "end": "52079"
  },
  {
    "text": "you probably know about the usual",
    "start": "52079",
    "end": "54079"
  },
  {
    "text": "context aware routing that nearly every",
    "start": "54079",
    "end": "56719"
  },
  {
    "text": "website uses the url",
    "start": "56719",
    "end": "59199"
  },
  {
    "text": "directs you your particular request to a",
    "start": "59199",
    "end": "62480"
  },
  {
    "text": "backend",
    "start": "62480",
    "end": "64000"
  },
  {
    "text": "that then serves your request",
    "start": "64000",
    "end": "66400"
  },
  {
    "text": "nearly every website does this",
    "start": "66400",
    "end": "69040"
  },
  {
    "text": "you can also get",
    "start": "69040",
    "end": "71040"
  },
  {
    "text": "data from the request header about how",
    "start": "71040",
    "end": "72960"
  },
  {
    "text": "to",
    "start": "72960",
    "end": "73680"
  },
  {
    "text": "do routing is usually done by a load",
    "start": "73680",
    "end": "75840"
  },
  {
    "text": "balancer",
    "start": "75840",
    "end": "77520"
  },
  {
    "text": "you can also have side channels that are",
    "start": "77520",
    "end": "79600"
  },
  {
    "text": "used to direct traffic",
    "start": "79600",
    "end": "81360"
  },
  {
    "text": "this might be an application that tries",
    "start": "81360",
    "end": "83920"
  },
  {
    "text": "to",
    "start": "83920",
    "end": "84960"
  },
  {
    "text": "give smart",
    "start": "84960",
    "end": "86560"
  },
  {
    "text": "load balancing by checking which servers",
    "start": "86560",
    "end": "88880"
  },
  {
    "text": "can take the load",
    "start": "88880",
    "end": "90880"
  },
  {
    "text": "and what this talk is about is using the",
    "start": "90880",
    "end": "93759"
  },
  {
    "text": "actual content",
    "start": "93759",
    "end": "95280"
  },
  {
    "text": "of the request message",
    "start": "95280",
    "end": "97280"
  },
  {
    "text": "in order to do the routing",
    "start": "97280",
    "end": "100640"
  },
  {
    "start": "99000",
    "end": "99000"
  },
  {
    "text": "why might you want to do this",
    "start": "100640",
    "end": "103439"
  },
  {
    "text": "in our particular case",
    "start": "103439",
    "end": "105360"
  },
  {
    "text": "what we",
    "start": "105360",
    "end": "106399"
  },
  {
    "text": "wanted to do was to be able to retrofit",
    "start": "106399",
    "end": "109200"
  },
  {
    "text": "smart routing",
    "start": "109200",
    "end": "111360"
  },
  {
    "text": "based on the data that was already being",
    "start": "111360",
    "end": "113439"
  },
  {
    "text": "passed into the packet and that that",
    "start": "113439",
    "end": "116479"
  },
  {
    "text": "routing wasn't previously done",
    "start": "116479",
    "end": "118479"
  },
  {
    "text": "and we figured we could do this without",
    "start": "118479",
    "end": "120159"
  },
  {
    "text": "changing the application",
    "start": "120159",
    "end": "123359"
  },
  {
    "text": "you can also do back-end mapping based",
    "start": "123920",
    "end": "126960"
  },
  {
    "text": "on either personal information that's",
    "start": "126960",
    "end": "129360"
  },
  {
    "text": "already in the packet so user x",
    "start": "129360",
    "end": "132800"
  },
  {
    "text": "always goes to this server",
    "start": "132800",
    "end": "135520"
  },
  {
    "text": "or based on whatever intellectual",
    "start": "135520",
    "end": "137280"
  },
  {
    "text": "property you might have",
    "start": "137280",
    "end": "139680"
  },
  {
    "text": "in one of our applications we actually",
    "start": "139680",
    "end": "142720"
  },
  {
    "text": "peek back multiple protocol buffers into",
    "start": "142720",
    "end": "145360"
  },
  {
    "text": "a single request",
    "start": "145360",
    "end": "147200"
  },
  {
    "text": "and",
    "start": "147200",
    "end": "148160"
  },
  {
    "text": "when the monolithic application is",
    "start": "148160",
    "end": "150319"
  },
  {
    "text": "broken up into microservices",
    "start": "150319",
    "end": "152480"
  },
  {
    "text": "one thing that's useful to do is you can",
    "start": "152480",
    "end": "154000"
  },
  {
    "text": "hey now take each of these individual",
    "start": "154000",
    "end": "156720"
  },
  {
    "text": "protocol sub messages in that protocol",
    "start": "156720",
    "end": "159040"
  },
  {
    "text": "buffer and route them to different",
    "start": "159040",
    "end": "160879"
  },
  {
    "text": "services simultaneously",
    "start": "160879",
    "end": "164560"
  },
  {
    "start": "164000",
    "end": "164000"
  },
  {
    "text": "uh just what a the custom envoy filter",
    "start": "164640",
    "end": "168800"
  },
  {
    "text": "looks like the client",
    "start": "168800",
    "end": "172160"
  },
  {
    "text": "sends a protocol buffer or message",
    "start": "172160",
    "end": "175599"
  },
  {
    "text": "and",
    "start": "175599",
    "end": "176400"
  },
  {
    "text": "envoy captures it decodes the data",
    "start": "176400",
    "end": "179120"
  },
  {
    "text": "deserializes the entire protocol buffer",
    "start": "179120",
    "end": "182560"
  },
  {
    "text": "applies the routing algorithm",
    "start": "182560",
    "end": "184800"
  },
  {
    "text": "and sends it to the correct backend",
    "start": "184800",
    "end": "188720"
  },
  {
    "start": "188000",
    "end": "188000"
  },
  {
    "text": "we did two runs using this naive",
    "start": "188879",
    "end": "191200"
  },
  {
    "text": "approach",
    "start": "191200",
    "end": "192800"
  },
  {
    "text": "one with an average message size around",
    "start": "192800",
    "end": "196400"
  },
  {
    "text": "half a megabyte and the other one with",
    "start": "196400",
    "end": "199200"
  },
  {
    "text": "average sizes in the two megabyte ranges",
    "start": "199200",
    "end": "202400"
  },
  {
    "text": "uh",
    "start": "202400",
    "end": "203680"
  },
  {
    "text": "the entire test turned out to be",
    "start": "203680",
    "end": "207360"
  },
  {
    "text": "bandwidth limited",
    "start": "207360",
    "end": "209200"
  },
  {
    "text": "and",
    "start": "209200",
    "end": "210080"
  },
  {
    "text": "what would happen was that for small",
    "start": "210080",
    "end": "211760"
  },
  {
    "text": "messages you can do a lot of requests at",
    "start": "211760",
    "end": "214560"
  },
  {
    "text": "once",
    "start": "214560",
    "end": "215519"
  },
  {
    "text": "uh",
    "start": "215519",
    "end": "216400"
  },
  {
    "text": "and that uses about seven calls",
    "start": "216400",
    "end": "218640"
  },
  {
    "text": "for large messages you're",
    "start": "218640",
    "end": "221040"
  },
  {
    "text": "because of the amount of bandwidth",
    "start": "221040",
    "end": "222400"
  },
  {
    "text": "you're using you can only do about 400",
    "start": "222400",
    "end": "224720"
  },
  {
    "text": "before your net link gets saturated",
    "start": "224720",
    "end": "227440"
  },
  {
    "text": "uh",
    "start": "227440",
    "end": "228319"
  },
  {
    "text": "and",
    "start": "228319",
    "end": "229120"
  },
  {
    "text": "because you actually end up with only",
    "start": "229120",
    "end": "230560"
  },
  {
    "text": "about 400 messages per second",
    "start": "230560",
    "end": "233200"
  },
  {
    "text": "you need a lot less cpu",
    "start": "233200",
    "end": "236400"
  },
  {
    "text": "both",
    "start": "236400",
    "end": "237360"
  },
  {
    "text": "the small and",
    "start": "237360",
    "end": "238799"
  },
  {
    "text": "large messages take about 168 megabytes",
    "start": "238799",
    "end": "241920"
  },
  {
    "text": "and this makes sense because that's",
    "start": "241920",
    "end": "243599"
  },
  {
    "text": "basically what your bandwidth can do",
    "start": "243599",
    "end": "247200"
  },
  {
    "text": "looking at a graph",
    "start": "247280",
    "end": "248799"
  },
  {
    "text": "you can see",
    "start": "248799",
    "end": "250000"
  },
  {
    "text": "some interesting characteristics",
    "start": "250000",
    "end": "252319"
  },
  {
    "text": "so for instance for the large messages",
    "start": "252319",
    "end": "254879"
  },
  {
    "text": "the memory",
    "start": "254879",
    "end": "256320"
  },
  {
    "text": "uh is much more spiky and we speculate",
    "start": "256320",
    "end": "258880"
  },
  {
    "text": "this is because of the heap allocator",
    "start": "258880",
    "end": "261600"
  },
  {
    "text": "you would get a message you would",
    "start": "261600",
    "end": "263759"
  },
  {
    "text": "spend some time like defragging your",
    "start": "263759",
    "end": "266400"
  },
  {
    "text": "free list",
    "start": "266400",
    "end": "267520"
  },
  {
    "text": "or allocating free lease and breaking it",
    "start": "267520",
    "end": "269840"
  },
  {
    "text": "up and so that's that's where you see",
    "start": "269840",
    "end": "271680"
  },
  {
    "text": "these like up and downs on the memory",
    "start": "271680",
    "end": "273919"
  },
  {
    "text": "use",
    "start": "273919",
    "end": "274880"
  },
  {
    "text": "uh",
    "start": "274880",
    "end": "275840"
  },
  {
    "text": "and then on the cpu sometimes you might",
    "start": "275840",
    "end": "278400"
  },
  {
    "text": "get burstiness",
    "start": "278400",
    "end": "279919"
  },
  {
    "text": "in terms of number of messages coming in",
    "start": "279919",
    "end": "281759"
  },
  {
    "text": "and so",
    "start": "281759",
    "end": "283520"
  },
  {
    "text": "that's",
    "start": "283520",
    "end": "284720"
  },
  {
    "text": "that's what you see on the cpu graph on",
    "start": "284720",
    "end": "286800"
  },
  {
    "text": "the small messages",
    "start": "286800",
    "end": "289600"
  },
  {
    "start": "288000",
    "end": "288000"
  },
  {
    "text": "okay",
    "start": "289600",
    "end": "290400"
  },
  {
    "text": "let's see if we can improve it to be",
    "start": "290400",
    "end": "292960"
  },
  {
    "text": "able to like peek inside the actual",
    "start": "292960",
    "end": "295120"
  },
  {
    "text": "message you actually without actually",
    "start": "295120",
    "end": "297520"
  },
  {
    "text": "having the protocol buffer definition",
    "start": "297520",
    "end": "300000"
  },
  {
    "text": "uh you need to decode the protobuf wire",
    "start": "300000",
    "end": "303280"
  },
  {
    "text": "format turns out there are only five",
    "start": "303280",
    "end": "306479"
  },
  {
    "text": "objects that are typically inside a",
    "start": "306479",
    "end": "308720"
  },
  {
    "text": "protocol buffer and one of them has been",
    "start": "308720",
    "end": "310560"
  },
  {
    "text": "deprecated so you don't even have to",
    "start": "310560",
    "end": "311919"
  },
  {
    "text": "think about it so that makes fall",
    "start": "311919",
    "end": "314880"
  },
  {
    "text": "the key the most",
    "start": "314880",
    "end": "316960"
  },
  {
    "text": "the most important one is the variant",
    "start": "316960",
    "end": "319039"
  },
  {
    "text": "that's what",
    "start": "319039",
    "end": "320560"
  },
  {
    "text": "you have on the right side of a protocol",
    "start": "320560",
    "end": "323039"
  },
  {
    "text": "buffer definition when you're specifying",
    "start": "323039",
    "end": "325039"
  },
  {
    "text": "a field",
    "start": "325039",
    "end": "326240"
  },
  {
    "text": "that's a variable length it ranges from",
    "start": "326240",
    "end": "329600"
  },
  {
    "text": "8 bytes to 128 bytes and that's also why",
    "start": "329600",
    "end": "333440"
  },
  {
    "text": "you try to use the smaller numbers on",
    "start": "333440",
    "end": "336320"
  },
  {
    "text": "that right hand side because those are",
    "start": "336320",
    "end": "338800"
  },
  {
    "text": "smaller and use less space and bandwidth",
    "start": "338800",
    "end": "342800"
  },
  {
    "text": "uh the fixed 64 and fixed 32-bit fields",
    "start": "342800",
    "end": "346720"
  },
  {
    "text": "are self-explanatory they're usually",
    "start": "346720",
    "end": "348720"
  },
  {
    "text": "used for doubles or floats",
    "start": "348720",
    "end": "351360"
  },
  {
    "text": "and the interesting bit from our point",
    "start": "351360",
    "end": "353919"
  },
  {
    "text": "of view is the length delimited field",
    "start": "353919",
    "end": "356400"
  },
  {
    "text": "right and",
    "start": "356400",
    "end": "357440"
  },
  {
    "text": "those are used for both strings",
    "start": "357440",
    "end": "360639"
  },
  {
    "text": "and",
    "start": "360639",
    "end": "362160"
  },
  {
    "text": "embedded protocol buffer messages that",
    "start": "362160",
    "end": "364240"
  },
  {
    "text": "are inside the overall big protocol but",
    "start": "364240",
    "end": "369360"
  },
  {
    "text": "so our insight is",
    "start": "369759",
    "end": "371840"
  },
  {
    "text": "when you see one of these lengths of",
    "start": "371840",
    "end": "373520"
  },
  {
    "text": "limited views you can try to unpack it",
    "start": "373520",
    "end": "375840"
  },
  {
    "text": "treat it like a message and if you fail",
    "start": "375840",
    "end": "379440"
  },
  {
    "text": "then it was a string",
    "start": "379440",
    "end": "381039"
  },
  {
    "text": "if you succeeded",
    "start": "381039",
    "end": "383440"
  },
  {
    "text": "then you can peek inside and say oh you",
    "start": "383440",
    "end": "385680"
  },
  {
    "text": "know let me",
    "start": "385680",
    "end": "388000"
  },
  {
    "text": "take a look at what's inside and in this",
    "start": "388000",
    "end": "391280"
  },
  {
    "text": "example that's on the",
    "start": "391280",
    "end": "392840"
  },
  {
    "text": "screen what we do is we have an envelope",
    "start": "392840",
    "end": "395919"
  },
  {
    "text": "that contains",
    "start": "395919",
    "end": "397199"
  },
  {
    "text": "four",
    "start": "397199",
    "end": "397919"
  },
  {
    "text": "four strings",
    "start": "397919",
    "end": "400240"
  },
  {
    "text": "and as an exercise this this last string",
    "start": "400240",
    "end": "403520"
  },
  {
    "text": "envelope id",
    "start": "403520",
    "end": "405360"
  },
  {
    "text": "is used to inject a unique string that",
    "start": "405360",
    "end": "408080"
  },
  {
    "text": "lets you say oh this particular thing is",
    "start": "408080",
    "end": "411280"
  },
  {
    "text": "one of these envelopes that can be used",
    "start": "411280",
    "end": "412960"
  },
  {
    "text": "for routing",
    "start": "412960",
    "end": "414080"
  },
  {
    "text": "and the other three fields app id server",
    "start": "414080",
    "end": "416560"
  },
  {
    "text": "id player id could easily be",
    "start": "416560",
    "end": "419440"
  },
  {
    "text": "the content on which you do your routing",
    "start": "419440",
    "end": "422880"
  },
  {
    "text": "uh",
    "start": "422880",
    "end": "424639"
  },
  {
    "text": "a few interesting observations",
    "start": "424639",
    "end": "427120"
  },
  {
    "start": "425000",
    "end": "425000"
  },
  {
    "text": "first of all you the",
    "start": "427120",
    "end": "429199"
  },
  {
    "text": "envelope can be retrofitted so if you",
    "start": "429199",
    "end": "431840"
  },
  {
    "text": "had an existing protocol buffer you know",
    "start": "431840",
    "end": "434639"
  },
  {
    "text": "where the payload is already used up",
    "start": "434639",
    "end": "437039"
  },
  {
    "text": "like the first 10 views you can use the",
    "start": "437039",
    "end": "440160"
  },
  {
    "text": "12 field to inject an envelope if you",
    "start": "440160",
    "end": "443120"
  },
  {
    "text": "needed to do that",
    "start": "443120",
    "end": "444479"
  },
  {
    "text": "uh when you have something like an",
    "start": "444479",
    "end": "447120"
  },
  {
    "text": "envelope id that's a unique string",
    "start": "447120",
    "end": "449440"
  },
  {
    "text": "that's used to identify the envelope",
    "start": "449440",
    "end": "452319"
  },
  {
    "text": "what you can do is you can change the",
    "start": "452319",
    "end": "454400"
  },
  {
    "text": "contents",
    "start": "454400",
    "end": "455599"
  },
  {
    "start": "455000",
    "end": "455000"
  },
  {
    "text": "of that string in order to indicate the",
    "start": "455599",
    "end": "458639"
  },
  {
    "text": "version number of the of the envelope",
    "start": "458639",
    "end": "462000"
  },
  {
    "text": "that you're doing so you could indicate",
    "start": "462000",
    "end": "464000"
  },
  {
    "text": "a backwards incompatible change for",
    "start": "464000",
    "end": "465759"
  },
  {
    "text": "instance if you needed to change",
    "start": "465759",
    "end": "467759"
  },
  {
    "text": "the type of envelope you had",
    "start": "467759",
    "end": "470960"
  },
  {
    "text": "and lastly as previously stated you can",
    "start": "470960",
    "end": "474000"
  },
  {
    "text": "actually use a combination of the data",
    "start": "474000",
    "end": "476319"
  },
  {
    "text": "in the envelope to do a routing you",
    "start": "476319",
    "end": "477759"
  },
  {
    "text": "don't have to depend on just one field",
    "start": "477759",
    "end": "480000"
  },
  {
    "text": "or another",
    "start": "480000",
    "end": "482240"
  },
  {
    "start": "482000",
    "end": "482000"
  },
  {
    "text": "so we implemented this partial",
    "start": "482240",
    "end": "483840"
  },
  {
    "text": "deserialization",
    "start": "483840",
    "end": "485440"
  },
  {
    "text": "and this is what it looks like",
    "start": "485440",
    "end": "488479"
  },
  {
    "text": "for",
    "start": "488479",
    "end": "489599"
  },
  {
    "text": "small messages we used about the same",
    "start": "489599",
    "end": "491680"
  },
  {
    "text": "number of calls but the amount of memory",
    "start": "491680",
    "end": "493919"
  },
  {
    "text": "used",
    "start": "493919",
    "end": "494960"
  },
  {
    "text": "has been reduced by more than 50 percent",
    "start": "494960",
    "end": "497599"
  },
  {
    "text": "right and this this this makes sense",
    "start": "497599",
    "end": "499440"
  },
  {
    "text": "well you know for a small message",
    "start": "499440",
    "end": "501520"
  },
  {
    "text": "envelope you know it's",
    "start": "501520",
    "end": "503840"
  },
  {
    "text": "it's",
    "start": "503840",
    "end": "504720"
  },
  {
    "text": "even the the envelope is not as big as",
    "start": "504720",
    "end": "508080"
  },
  {
    "text": "half a megabyte so you you're only",
    "start": "508080",
    "end": "510840"
  },
  {
    "text": "deserializing as much as you need to do",
    "start": "510840",
    "end": "513120"
  },
  {
    "text": "routing and then the rest of the",
    "start": "513120",
    "end": "515680"
  },
  {
    "text": "protocol buffer is just handed off",
    "start": "515680",
    "end": "518080"
  },
  {
    "text": "uh",
    "start": "518080",
    "end": "518880"
  },
  {
    "text": "for large envelopes uh again",
    "start": "518880",
    "end": "522560"
  },
  {
    "text": "you're still brand was limited that",
    "start": "522560",
    "end": "524399"
  },
  {
    "text": "doesn't change",
    "start": "524399",
    "end": "525760"
  },
  {
    "text": "uh",
    "start": "525760",
    "end": "526720"
  },
  {
    "text": "but because you're processing processing",
    "start": "526720",
    "end": "529200"
  },
  {
    "text": "less of the envelope or less of the",
    "start": "529200",
    "end": "530959"
  },
  {
    "text": "protocol buffer before you route it uh",
    "start": "530959",
    "end": "533519"
  },
  {
    "text": "you'll actually improve cpu utilization",
    "start": "533519",
    "end": "536800"
  },
  {
    "text": "you also save some memory",
    "start": "536800",
    "end": "538880"
  },
  {
    "text": "not as much because your payload is so",
    "start": "538880",
    "end": "541040"
  },
  {
    "text": "big",
    "start": "541040",
    "end": "542560"
  },
  {
    "text": "in this case you save about 30",
    "start": "542560",
    "end": "545920"
  },
  {
    "start": "546000",
    "end": "546000"
  },
  {
    "text": "ah this is the interesting chart",
    "start": "546000",
    "end": "548399"
  },
  {
    "text": "uh what's happened in the large",
    "start": "548399",
    "end": "550959"
  },
  {
    "text": "message case is that you no longer see",
    "start": "550959",
    "end": "552880"
  },
  {
    "text": "the jiggle",
    "start": "552880",
    "end": "554480"
  },
  {
    "text": "because you you're no longer",
    "start": "554480",
    "end": "557279"
  },
  {
    "text": "fragmenting your heap as much as you",
    "start": "557279",
    "end": "559839"
  },
  {
    "text": "used to",
    "start": "559839",
    "end": "561600"
  },
  {
    "text": "both the cp both the cpu on both sides",
    "start": "561600",
    "end": "564320"
  },
  {
    "text": "look pretty much the same and",
    "start": "564320",
    "end": "567519"
  },
  {
    "text": "but you know in in this particular case",
    "start": "567519",
    "end": "569600"
  },
  {
    "text": "we're pretty happy about the performance",
    "start": "569600",
    "end": "571360"
  },
  {
    "text": "improvement we got",
    "start": "571360",
    "end": "574920"
  },
  {
    "text": "so now we would like to focus regarding",
    "start": "576000",
    "end": "578880"
  },
  {
    "text": "context that we're routing for the case",
    "start": "578880",
    "end": "581120"
  },
  {
    "text": "of our stateful services and what does",
    "start": "581120",
    "end": "583120"
  },
  {
    "text": "it mean for niantic",
    "start": "583120",
    "end": "584720"
  },
  {
    "text": "so in niantic when you play pokemon go a",
    "start": "584720",
    "end": "587760"
  },
  {
    "text": "mobile client is when it connects for",
    "start": "587760",
    "end": "589920"
  },
  {
    "text": "the first time is assigned a server that",
    "start": "589920",
    "end": "592240"
  },
  {
    "text": "server is where the player state is",
    "start": "592240",
    "end": "594240"
  },
  {
    "text": "being maintained and from that point on",
    "start": "594240",
    "end": "596480"
  },
  {
    "text": "we want the request to be as fast as",
    "start": "596480",
    "end": "599040"
  },
  {
    "text": "possible more in the area of",
    "start": "599040",
    "end": "600560"
  },
  {
    "text": "milliseconds than in the area of seconds",
    "start": "600560",
    "end": "603680"
  },
  {
    "text": "so how does it look when a client",
    "start": "603680",
    "end": "605920"
  },
  {
    "start": "604000",
    "end": "604000"
  },
  {
    "text": "connects for the first time it sends a",
    "start": "605920",
    "end": "607680"
  },
  {
    "text": "handshake request the server then goes",
    "start": "607680",
    "end": "609839"
  },
  {
    "text": "into a storage where the state of the",
    "start": "609839",
    "end": "611680"
  },
  {
    "text": "player is being stored",
    "start": "611680",
    "end": "613760"
  },
  {
    "text": "and it asks the storage to assign the",
    "start": "613760",
    "end": "615839"
  },
  {
    "text": "player to himself the storage then check",
    "start": "615839",
    "end": "618959"
  },
  {
    "text": "is it possible is it the player already",
    "start": "618959",
    "end": "621040"
  },
  {
    "text": "assigned a server if it's assigned the",
    "start": "621040",
    "end": "623120"
  },
  {
    "text": "server then it will return the id of the",
    "start": "623120",
    "end": "625120"
  },
  {
    "text": "server it's already assigned to and if",
    "start": "625120",
    "end": "627120"
  },
  {
    "text": "not it will say yeah sure",
    "start": "627120",
    "end": "629120"
  },
  {
    "text": "your client",
    "start": "629120",
    "end": "630480"
  },
  {
    "text": "at that point the server will reply to",
    "start": "630480",
    "end": "632640"
  },
  {
    "text": "the client and will tell it what is the",
    "start": "632640",
    "end": "635279"
  },
  {
    "text": "id of the server that it needs to",
    "start": "635279",
    "end": "637200"
  },
  {
    "text": "continue to talk with either itself or",
    "start": "637200",
    "end": "640399"
  },
  {
    "text": "the server that it was already assigned",
    "start": "640399",
    "end": "642800"
  },
  {
    "text": "for the case by the way of when it was",
    "start": "642800",
    "end": "644959"
  },
  {
    "text": "already assigned is for example a",
    "start": "644959",
    "end": "646320"
  },
  {
    "text": "restart or a player getting offline for",
    "start": "646320",
    "end": "648560"
  },
  {
    "text": "a couple of minutes",
    "start": "648560",
    "end": "650880"
  },
  {
    "text": "so",
    "start": "650880",
    "end": "652240"
  },
  {
    "start": "651000",
    "end": "651000"
  },
  {
    "text": "how does it what does the client do at",
    "start": "652240",
    "end": "653920"
  },
  {
    "text": "that point",
    "start": "653920",
    "end": "655519"
  },
  {
    "text": "as you can see",
    "start": "655519",
    "end": "657600"
  },
  {
    "text": "oh i can use my mouse so as you can see",
    "start": "657600",
    "end": "660079"
  },
  {
    "text": "the the client is using the id that it",
    "start": "660079",
    "end": "663440"
  },
  {
    "text": "just received from the server and sends",
    "start": "663440",
    "end": "666000"
  },
  {
    "text": "it with every request",
    "start": "666000",
    "end": "668079"
  },
  {
    "text": "that request then reaches envoy which",
    "start": "668079",
    "end": "670959"
  },
  {
    "text": "already have a routing a mapping of",
    "start": "670959",
    "end": "674160"
  },
  {
    "text": "listeners and",
    "start": "674160",
    "end": "675680"
  },
  {
    "text": "clusters and knows that for each id",
    "start": "675680",
    "end": "678560"
  },
  {
    "text": "which back-end to send the request it",
    "start": "678560",
    "end": "681200"
  },
  {
    "text": "strips out the id and then send it back",
    "start": "681200",
    "end": "683519"
  },
  {
    "text": "there",
    "start": "683519",
    "end": "685440"
  },
  {
    "text": "the servers themselves to make sure that",
    "start": "685440",
    "end": "688000"
  },
  {
    "text": "everything works correctly are talking",
    "start": "688000",
    "end": "689920"
  },
  {
    "text": "with the storage where the player state",
    "start": "689920",
    "end": "692240"
  },
  {
    "text": "is stored and uh in that storage we have",
    "start": "692240",
    "end": "696240"
  },
  {
    "text": "mechanism of course for timeouts when a",
    "start": "696240",
    "end": "698959"
  },
  {
    "text": "client is not connected for a long time",
    "start": "698959",
    "end": "701279"
  },
  {
    "text": "and locks of course to make sure the",
    "start": "701279",
    "end": "703360"
  },
  {
    "text": "client is assigned only a single server",
    "start": "703360",
    "end": "706079"
  },
  {
    "text": "all this flow allah adds a lot of",
    "start": "706079",
    "end": "708720"
  },
  {
    "text": "latency now it's true that this happens",
    "start": "708720",
    "end": "710959"
  },
  {
    "text": "usually only",
    "start": "710959",
    "end": "713200"
  },
  {
    "text": "on first connect or after a long time",
    "start": "713200",
    "end": "715600"
  },
  {
    "text": "that the client haven't connected",
    "start": "715600",
    "end": "717839"
  },
  {
    "text": "it means that",
    "start": "717839",
    "end": "719920"
  },
  {
    "text": "the requests are taking",
    "start": "719920",
    "end": "722079"
  },
  {
    "text": "can take up to two seconds just because",
    "start": "722079",
    "end": "724880"
  },
  {
    "text": "that's the configured timeout we have",
    "start": "724880",
    "end": "726399"
  },
  {
    "text": "currently on that connection",
    "start": "726399",
    "end": "728079"
  },
  {
    "text": "if",
    "start": "728079",
    "end": "728880"
  },
  {
    "text": "for example the spanner the database",
    "start": "728880",
    "end": "731200"
  },
  {
    "text": "starts to be very slow",
    "start": "731200",
    "end": "733680"
  },
  {
    "text": "so what is the proposed solution if we",
    "start": "733680",
    "end": "736160"
  },
  {
    "start": "734000",
    "end": "734000"
  },
  {
    "text": "look on what pr was just proposing",
    "start": "736160",
    "end": "738959"
  },
  {
    "text": "regarding how we can take the context",
    "start": "738959",
    "end": "741600"
  },
  {
    "text": "out of the messages themselves then",
    "start": "741600",
    "end": "744160"
  },
  {
    "text": "whenever the client sends a message and",
    "start": "744160",
    "end": "747519"
  },
  {
    "text": "we can either look in the header if you",
    "start": "747519",
    "end": "749200"
  },
  {
    "text": "look at other methods but if you look in",
    "start": "749200",
    "end": "750880"
  },
  {
    "text": "our own methods look in the content",
    "start": "750880",
    "end": "753440"
  },
  {
    "text": "we can we usually apply a routing",
    "start": "753440",
    "end": "756240"
  },
  {
    "text": "algorithm and then reroute in our case",
    "start": "756240",
    "end": "759200"
  },
  {
    "text": "and proposed solution",
    "start": "759200",
    "end": "760880"
  },
  {
    "text": "we take the client to server mapping and",
    "start": "760880",
    "end": "763920"
  },
  {
    "text": "put it closer",
    "start": "763920",
    "end": "765519"
  },
  {
    "text": "so in this case for example the client",
    "start": "765519",
    "end": "768160"
  },
  {
    "text": "to server mapping is part of the memory",
    "start": "768160",
    "end": "770480"
  },
  {
    "text": "of the running invoice every message",
    "start": "770480",
    "end": "772639"
  },
  {
    "text": "that gets in we pull the context in this",
    "start": "772639",
    "end": "774959"
  },
  {
    "text": "case the client id and then we check",
    "start": "774959",
    "end": "778079"
  },
  {
    "text": "if there is already a map then we",
    "start": "778079",
    "end": "781760"
  },
  {
    "text": "already know where to route it",
    "start": "781760",
    "end": "783839"
  },
  {
    "text": "if not then we take just the selected",
    "start": "783839",
    "end": "786480"
  },
  {
    "text": "load bouncer",
    "start": "786480",
    "end": "788160"
  },
  {
    "text": "algorithm and then we apply it take",
    "start": "788160",
    "end": "790720"
  },
  {
    "text": "whatever invoice proposed to us and ask",
    "start": "790720",
    "end": "792880"
  },
  {
    "text": "the mapping to update accordingly",
    "start": "792880",
    "end": "796639"
  },
  {
    "text": "so if",
    "start": "797200",
    "end": "798639"
  },
  {
    "text": "before we needed to have the id on the",
    "start": "798639",
    "end": "802240"
  },
  {
    "text": "client and the storage in the back end",
    "start": "802240",
    "end": "805440"
  },
  {
    "text": "now we have the client no longer needs",
    "start": "805440",
    "end": "807839"
  },
  {
    "text": "to know what server is talking with it's",
    "start": "807839",
    "end": "809839"
  },
  {
    "text": "not something that has any impact",
    "start": "809839",
    "end": "812800"
  },
  {
    "text": "the invoice holds the client to server",
    "start": "812800",
    "end": "814880"
  },
  {
    "text": "mapping and the servers themselves don't",
    "start": "814880",
    "end": "816800"
  },
  {
    "text": "need to communicate with the storage to",
    "start": "816800",
    "end": "818959"
  },
  {
    "text": "make sure that they are talking with the",
    "start": "818959",
    "end": "821440"
  },
  {
    "text": "right uh the right client now one of the",
    "start": "821440",
    "end": "824240"
  },
  {
    "text": "things that is important to note here is",
    "start": "824240",
    "end": "826720"
  },
  {
    "text": "that we guarantee 100 correctness",
    "start": "826720",
    "end": "829600"
  },
  {
    "text": "and why is that important",
    "start": "829600",
    "end": "832000"
  },
  {
    "text": "so first of all most of you already",
    "start": "832000",
    "end": "833680"
  },
  {
    "text": "noticed that this works only if you have",
    "start": "833680",
    "end": "835839"
  },
  {
    "text": "one invoice because if it's in memory",
    "start": "835839",
    "end": "838560"
  },
  {
    "text": "what will happen with the rest of them",
    "start": "838560",
    "end": "840000"
  },
  {
    "text": "you need a way now to synchronize this",
    "start": "840000",
    "end": "842639"
  },
  {
    "text": "so our proposed solution was to add a",
    "start": "842639",
    "end": "845600"
  },
  {
    "text": "service called the state coordinator",
    "start": "845600",
    "end": "848399"
  },
  {
    "text": "this is where the origin of your data",
    "start": "848399",
    "end": "851040"
  },
  {
    "text": "this is your source of truth this is",
    "start": "851040",
    "end": "852720"
  },
  {
    "text": "where the client-to-server mapping",
    "start": "852720",
    "end": "854240"
  },
  {
    "text": "actually lives",
    "start": "854240",
    "end": "855519"
  },
  {
    "text": "each envoy have a cache of that one",
    "start": "855519",
    "end": "859279"
  },
  {
    "text": "now whenever a new client connects",
    "start": "859279",
    "end": "862240"
  },
  {
    "text": "whenever a client connects sorry then",
    "start": "862240",
    "end": "864800"
  },
  {
    "text": "involve will check do i have it in the",
    "start": "864800",
    "end": "866800"
  },
  {
    "text": "cache if i have it in the cache great i",
    "start": "866800",
    "end": "868880"
  },
  {
    "text": "just map it to where it should go",
    "start": "868880",
    "end": "870800"
  },
  {
    "text": "if i don't have it in the cache then",
    "start": "870800",
    "end": "872480"
  },
  {
    "text": "invoi will go and ask the state",
    "start": "872480",
    "end": "875040"
  },
  {
    "text": "coordinator to assign a server",
    "start": "875040",
    "end": "877680"
  },
  {
    "text": "now one of the things that the state",
    "start": "877680",
    "end": "879279"
  },
  {
    "text": "coordinator",
    "start": "879279",
    "end": "880800"
  },
  {
    "text": "also have is the ability to monitor",
    "start": "880800",
    "end": "882800"
  },
  {
    "text": "which servers are alive if a server is",
    "start": "882800",
    "end": "885199"
  },
  {
    "text": "started he can reroute",
    "start": "885199",
    "end": "888000"
  },
  {
    "text": "clients and have a lot of logic for",
    "start": "888000",
    "end": "890320"
  },
  {
    "text": "supporting that",
    "start": "890320",
    "end": "892000"
  },
  {
    "text": "and then it will reassign a new backend",
    "start": "892000",
    "end": "895680"
  },
  {
    "text": "now the moment that it have a new",
    "start": "895680",
    "end": "897680"
  },
  {
    "text": "backend assigned it means that your",
    "start": "897680",
    "end": "900880"
  },
  {
    "text": "your origin is already updated it will",
    "start": "900880",
    "end": "903360"
  },
  {
    "text": "reply with the server",
    "start": "903360",
    "end": "905600"
  },
  {
    "text": "uh that the android needs to route to",
    "start": "905600",
    "end": "909040"
  },
  {
    "text": "and then",
    "start": "909040",
    "end": "910240"
  },
  {
    "text": "the mechanism where we update",
    "start": "910240",
    "end": "913040"
  },
  {
    "text": "the",
    "start": "913040",
    "end": "914079"
  },
  {
    "text": "the cache on each invoice is very",
    "start": "914079",
    "end": "916720"
  },
  {
    "text": "similar to um the cosmos db change feed",
    "start": "916720",
    "end": "920720"
  },
  {
    "text": "i will not try to start to explain that",
    "start": "920720",
    "end": "922880"
  },
  {
    "text": "one because it's very complicated but",
    "start": "922880",
    "end": "924399"
  },
  {
    "text": "there is a link here and we will",
    "start": "924399",
    "end": "925920"
  },
  {
    "text": "uploaded the update presentation with",
    "start": "925920",
    "end": "928160"
  },
  {
    "text": "this",
    "start": "928160",
    "end": "929040"
  },
  {
    "text": "but",
    "start": "929040",
    "end": "930800"
  },
  {
    "text": "the way that we are updating is that",
    "start": "930800",
    "end": "933199"
  },
  {
    "start": "931000",
    "end": "931000"
  },
  {
    "text": "whenever and change is happening on the",
    "start": "933199",
    "end": "935519"
  },
  {
    "text": "client server mapping we just stream the",
    "start": "935519",
    "end": "938800"
  },
  {
    "text": "change itself that allows us to do fast",
    "start": "938800",
    "end": "941759"
  },
  {
    "text": "updates",
    "start": "941759",
    "end": "942800"
  },
  {
    "text": "and allows the invoice to be updated as",
    "start": "942800",
    "end": "944560"
  },
  {
    "text": "much as possible so getting back to the",
    "start": "944560",
    "end": "947120"
  },
  {
    "text": "subject of 100 correctness",
    "start": "947120",
    "end": "950480"
  },
  {
    "text": "if",
    "start": "950480",
    "end": "951440"
  },
  {
    "text": "the state coordinator returns an error",
    "start": "951440",
    "end": "954000"
  },
  {
    "text": "because he's not able to assign the",
    "start": "954000",
    "end": "955759"
  },
  {
    "text": "client involved will return an error it",
    "start": "955759",
    "end": "958000"
  },
  {
    "text": "will not try to route to anywhere else",
    "start": "958000",
    "end": "960959"
  },
  {
    "text": "and that's how we actually replace the",
    "start": "960959",
    "end": "963120"
  },
  {
    "text": "stateful database and all the logic",
    "start": "963120",
    "end": "965440"
  },
  {
    "text": "behind it with this component",
    "start": "965440",
    "end": "969440"
  },
  {
    "text": "so i'm sorry that i talk fast because i",
    "start": "969440",
    "end": "971920"
  },
  {
    "start": "970000",
    "end": "970000"
  },
  {
    "text": "do tend to talk fast but conclusions",
    "start": "971920",
    "end": "975199"
  },
  {
    "text": "so",
    "start": "975199",
    "end": "975480"
  },
  {
    "text": "[Music]",
    "start": "975480",
    "end": "976880"
  },
  {
    "text": "in this case we moved a lot of the",
    "start": "976880",
    "end": "979600"
  },
  {
    "text": "computation and the logic that the state",
    "start": "979600",
    "end": "982160"
  },
  {
    "text": "that was maintained in the back end and",
    "start": "982160",
    "end": "984480"
  },
  {
    "text": "just shifted it closer closer to where",
    "start": "984480",
    "end": "987120"
  },
  {
    "text": "actually it's needed which is where we",
    "start": "987120",
    "end": "989360"
  },
  {
    "text": "are routing messages uh it definitely",
    "start": "989360",
    "end": "992000"
  },
  {
    "text": "improved performance and then when we",
    "start": "992000",
    "end": "994720"
  },
  {
    "text": "started to handle larger messages we saw",
    "start": "994720",
    "end": "997680"
  },
  {
    "text": "things are costing us more and take a",
    "start": "997680",
    "end": "999519"
  },
  {
    "text": "bit more time and then we started",
    "start": "999519",
    "end": "1002160"
  },
  {
    "text": "investigating the message uh partial",
    "start": "1002160",
    "end": "1004639"
  },
  {
    "text": "messages organization to help with large",
    "start": "1004639",
    "end": "1007600"
  },
  {
    "text": "messages",
    "start": "1007600",
    "end": "1009440"
  },
  {
    "text": "so thank you everybody for coming i'm uh",
    "start": "1009440",
    "end": "1012880"
  },
  {
    "text": "kobe",
    "start": "1012880",
    "end": "1014079"
  },
  {
    "text": "and",
    "start": "1014079",
    "end": "1014880"
  },
  {
    "text": "you know we have the plug for our",
    "start": "1014880",
    "end": "1016320"
  },
  {
    "text": "employer if you find this type of work",
    "start": "1016320",
    "end": "1018560"
  },
  {
    "text": "interesting yes niantic is hiring",
    "start": "1018560",
    "end": "1022639"
  },
  {
    "text": "and if this was interesting we'll be",
    "start": "1022639",
    "end": "1024319"
  },
  {
    "text": "very happy",
    "start": "1024319",
    "end": "1025360"
  },
  {
    "text": "any questions",
    "start": "1025360",
    "end": "1028600"
  },
  {
    "text": "[Applause]",
    "start": "1029160",
    "end": "1032079"
  }
]