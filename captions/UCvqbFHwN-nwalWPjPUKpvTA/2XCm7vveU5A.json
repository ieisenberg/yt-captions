[
  {
    "start": "0",
    "end": "67000"
  },
  {
    "text": "ok everyone I'm gonna get started I don't want to make this delay you any longer I'm getting you to your plane's",
    "start": "709",
    "end": "7410"
  },
  {
    "text": "thank you very much for attending our session it is the loss of the conference so thank you for being in this room",
    "start": "7410",
    "end": "13200"
  },
  {
    "text": "hearty conference goers so my name is Greg I'm the jke security tech lead at",
    "start": "13200",
    "end": "18869"
  },
  {
    "text": "Google and with me today I have Shane Lawrence who's a security infrastructure engineer at Shopify and I'm really",
    "start": "18869",
    "end": "25109"
  },
  {
    "text": "excited to be able to talk about a real-life production security issue that Shopify had and that they've been",
    "start": "25109",
    "end": "30929"
  },
  {
    "text": "gracious enough to share with us on the whole community and I think this is a great opportunity to learn from how how",
    "start": "30929",
    "end": "38730"
  },
  {
    "text": "this how this issue played out how we can defend against issues like this as a",
    "start": "38730",
    "end": "43829"
  },
  {
    "text": "community and how we can make kubernetes more secure and stronger some of these things are GK's specific that we're",
    "start": "43829",
    "end": "50280"
  },
  {
    "text": "talking about today all some of them are kind of probably generalizable to cloud provider and some of them are",
    "start": "50280",
    "end": "56399"
  },
  {
    "text": "generalizable to any kubernetes cluster so I'll try and call those out where it's a DKE specific thing or a",
    "start": "56399",
    "end": "62989"
  },
  {
    "text": "kubernetes general thing so start out by",
    "start": "62989",
    "end": "69869"
  },
  {
    "start": "67000",
    "end": "67000"
  },
  {
    "text": "talking a little bit about Shopify's production security infrastructure how they run on gke and then also discussing",
    "start": "69869",
    "end": "77070"
  },
  {
    "text": "their bug bounty program where this security issue was reported told through the bug report talk about the vulnerable",
    "start": "77070",
    "end": "84030"
  },
  {
    "text": "application that had the security problem worked through and we're gonna",
    "start": "84030",
    "end": "89040"
  },
  {
    "text": "demo kind of attack and defense through each part of it to see how the security",
    "start": "89040",
    "end": "94049"
  },
  {
    "text": "researcher was able to take a vulnerability in that service and turn it into control of the entire cluster",
    "start": "94049",
    "end": "99060"
  },
  {
    "text": "through a series of steps so we'll work through those steps demo the steps talk about defenses at each point and then",
    "start": "99060",
    "end": "107130"
  },
  {
    "text": "we'll look at if you were responding to this vulnerability as as Shopify was",
    "start": "107130",
    "end": "113070"
  },
  {
    "text": "what would you look for in your logs how would you detect if a vulnerability like this had been used and then we'll finish",
    "start": "113070",
    "end": "119640"
  },
  {
    "text": "up with some takeaways the general security advice that will help others defend against situations like this so",
    "start": "119640",
    "end": "128399"
  },
  {
    "text": "I'll hand it over to Shane to introduce the shuffle thanks Greg I'm Shane from Shopify and I",
    "start": "128399",
    "end": "134860"
  },
  {
    "start": "132000",
    "end": "132000"
  },
  {
    "text": "work on the infrastructure security team it's our job to make commerce secure for everyone and to that end we think that",
    "start": "134860",
    "end": "141250"
  },
  {
    "text": "responsible disclosure is a really important part of our program so I hope that you'll find some value from this",
    "start": "141250",
    "end": "147069"
  },
  {
    "text": "and the things that we missed how we responded and what we did harden our clusters afterward if you're not",
    "start": "147069",
    "end": "153280"
  },
  {
    "text": "familiar with Shopify we've got about 600,000 businesses so there's a good chance that you've purchased something",
    "start": "153280",
    "end": "159370"
  },
  {
    "text": "from us without even realizing it we processed about twenty six billion dollars last year and during peak hours",
    "start": "159370",
    "end": "165880"
  },
  {
    "text": "we have eighty thousand requests per second now based on the traffic I think that people are more interested in",
    "start": "165880",
    "end": "171519"
  },
  {
    "text": "purchasing lipstick than kubernetes merch but to me it's a really big accolade that the cloud native computing",
    "start": "171519",
    "end": "177430"
  },
  {
    "text": "foundation has chosen us to sell all of their merch so if you've got a kubernetes hoodie then you got that on a",
    "start": "177430",
    "end": "183040"
  },
  {
    "text": "platform that's running on kubernetes now we've built a cloud platform",
    "start": "183040",
    "end": "188170"
  },
  {
    "start": "186000",
    "end": "186000"
  },
  {
    "text": "entirely on gke Shopify and the reason we've chosen kubernetes is because we",
    "start": "188170",
    "end": "193300"
  },
  {
    "text": "need to be scalable we have events like Black Friday Cyber Monday where some of our businesses do as much revenue in",
    "start": "193300",
    "end": "200079"
  },
  {
    "text": "that weekend as the entire rest of the year and we also have flash sales especially with things like street wear",
    "start": "200079",
    "end": "206019"
  },
  {
    "text": "and cosmetics and sneakers we find that they will release a new item for a limited period of time or have a limited",
    "start": "206019",
    "end": "213400"
  },
  {
    "text": "time sale and they will increase their volume exponentially in a very short amount of time and then go back to",
    "start": "213400",
    "end": "218829"
  },
  {
    "text": "normal so it would be a waste of resources to just have enough servers running all the time to handle that load",
    "start": "218829",
    "end": "224560"
  },
  {
    "text": "with kubernetes we can scale down to a single replica if we need to test things or we can scale up to hundreds across",
    "start": "224560",
    "end": "231579"
  },
  {
    "text": "multiple geographical locations it's important to us that our application",
    "start": "231579",
    "end": "236620"
  },
  {
    "text": "developers spend their time developing applications not becoming kubernetes experts and so to that end we've built a",
    "start": "236620",
    "end": "243280"
  },
  {
    "text": "self-serve platform and they can literally go in and press the create cloud runtime button and in minutes have",
    "start": "243280",
    "end": "250230"
  },
  {
    "text": "web applications serving traffic running on kubernetes we use guardrails to warn",
    "start": "250230",
    "end": "256150"
  },
  {
    "text": "them if they're going too far off the beaten path if they're doing something that we think might not be best practice",
    "start": "256150",
    "end": "261310"
  },
  {
    "text": "or might not be secure then we will let them know and we use paved roads to make it really",
    "start": "261310",
    "end": "266349"
  },
  {
    "text": "really easy for them to do what we think is best and doing so we get security by",
    "start": "266349",
    "end": "273009"
  },
  {
    "text": "default so I should limit that we don't get 100% secure clusters that would be",
    "start": "273009",
    "end": "280360"
  },
  {
    "text": "impossible and it's not just magic my team works very hard to make sure that",
    "start": "280360",
    "end": "285430"
  },
  {
    "text": "this happens but what we do get is a baseline of security so for instance when they press that button we",
    "start": "285430",
    "end": "291909"
  },
  {
    "text": "automatically drop all of the privileges that the vast majority of developers don't need and if they want more than",
    "start": "291909",
    "end": "298479"
  },
  {
    "text": "that then they can go out and customize it so that their manifests will allow more privileges than that knowing that",
    "start": "298479",
    "end": "305919"
  },
  {
    "text": "there is never going to be a 100% secure cluster we can augment this we have a",
    "start": "305919",
    "end": "311830"
  },
  {
    "text": "comprehensive security posture and that involves external audits as well as our",
    "start": "311830",
    "end": "316900"
  },
  {
    "text": "bug bounty program with this bug bounty program we recognize that it would be",
    "start": "316900",
    "end": "322569"
  },
  {
    "text": "infeasible to hire 300 people to sit around all day test every single commit and try to find some vulnerability and",
    "start": "322569",
    "end": "328690"
  },
  {
    "text": "every single thing we do so instead we just leverage the power of the community and in doing so we've had over 300",
    "start": "328690",
    "end": "335800"
  },
  {
    "text": "hackers over the last three years or so participate in our program we think that it's really important that merchants and",
    "start": "335800",
    "end": "342340"
  },
  {
    "text": "buyers are protected so anyone who wants to take part in this program is required to set up a test store and doing so they",
    "start": "342340",
    "end": "349120"
  },
  {
    "text": "can test our platform and they're really working against Shopify they know that they're on our infrastructure but",
    "start": "349120",
    "end": "355360"
  },
  {
    "text": "they're not going to compromise any personal information or any actual business with this program and the other",
    "start": "355360",
    "end": "363940"
  },
  {
    "text": "programs that we run we've paid out over a million dollars in bug bounties and we think that's really important because it",
    "start": "363940",
    "end": "369610"
  },
  {
    "text": "shows the researchers that we value the time we value the contribution that they've given to us and it encourages",
    "start": "369610",
    "end": "375159"
  },
  {
    "text": "them to come back again if you're interested in participating in this then please go to hacker 1.com slash Shopify",
    "start": "375159",
    "end": "382029"
  },
  {
    "text": "and hack Shopify tell us what you find so today I'm going to talk about a",
    "start": "382029",
    "end": "387580"
  },
  {
    "start": "386000",
    "end": "386000"
  },
  {
    "text": "specific bug report that we got it came in at 7:30 9 p.m. on a Sunday which is",
    "start": "387580",
    "end": "392800"
  },
  {
    "text": "not the best time to have a security incident it would be a lot nicer for all of us if this sort of thing only ever happened",
    "start": "392800",
    "end": "399230"
  },
  {
    "text": "at 11 o'clock in the morning on a Tuesday when we're all at our desks ready to go but we need to respond to",
    "start": "399230",
    "end": "405110"
  },
  {
    "text": "regardless and I want to take a moment to thank Andre personally because he did an exceptional job on this report it was",
    "start": "405110",
    "end": "411650"
  },
  {
    "text": "really clear really thorough and it certainly made it easier for us to triage this so we got the report at 7:30",
    "start": "411650",
    "end": "420110"
  },
  {
    "text": "9 about a vulnerability in an exchange application which I'll explain in a moment 11 minutes later had 750 we had",
    "start": "420110",
    "end": "428060"
  },
  {
    "text": "declared an incident and ten minutes after that message had gone out to the cloud security team and the application",
    "start": "428060",
    "end": "434990"
  },
  {
    "text": "developers who worked on this app at 8:43 we had mitigated this vulnerability",
    "start": "434990",
    "end": "442990"
  },
  {
    "text": "by 927 the more difficult work of investigating and cleaning up rotating",
    "start": "442990",
    "end": "449510"
  },
  {
    "text": "credentials contacting Google's support to make sure we hadn't missed anything and investigating the logs had begotten",
    "start": "449510",
    "end": "455650"
  },
  {
    "text": "really happy with that one hour and four minute time line where obviously we",
    "start": "455650",
    "end": "461420"
  },
  {
    "text": "hadn't done every single thing we needed to do but we were now safe from this particular vulnerability so the exchange",
    "start": "461420",
    "end": "469940"
  },
  {
    "text": "application that was targeted is what we consider a tier two application it's not the most reliable most secure Tier one",
    "start": "469940",
    "end": "476660"
  },
  {
    "start": "471000",
    "end": "471000"
  },
  {
    "text": "business which is the storefronts that you would see typically nor is it a Tier",
    "start": "476660",
    "end": "481850"
  },
  {
    "text": "four hackie experimental really gross horrible application that you might find",
    "start": "481850",
    "end": "486860"
  },
  {
    "text": "elsewhere so this was reasonably important this works it's a marketplace",
    "start": "486860",
    "end": "493190"
  },
  {
    "text": "for buying and selling stores and one of the most important things is having a",
    "start": "493190",
    "end": "498290"
  },
  {
    "text": "screenshot of the storefront because you wouldn't want to buy someone's store without seeing what it looks like so we",
    "start": "498290",
    "end": "503690"
  },
  {
    "text": "don't want users to have to manually do this screenshotting process we do it automatically for them so the exchange",
    "start": "503690",
    "end": "509840"
  },
  {
    "text": "application when you create a listing sends a request to a screenshot service headless browser sends a request to the",
    "start": "509840",
    "end": "515900"
  },
  {
    "text": "storefront and the test store that the researcher set up will return a webpage an image of that webpage is returned and",
    "start": "515900",
    "end": "522380"
  },
  {
    "text": "put on the page in explaining the attack and some",
    "start": "522380",
    "end": "527690"
  },
  {
    "start": "527000",
    "end": "527000"
  },
  {
    "text": "against it you should know that the researcher exploited an SSR F which I'll explain in a moment and use that to",
    "start": "527690",
    "end": "534050"
  },
  {
    "text": "obtain a Google service account token that was successful but he wasn't able",
    "start": "534050",
    "end": "539570"
  },
  {
    "text": "to actually do anything with it or anything worthwhile so he pivoted obtained a cube end of environment",
    "start": "539570",
    "end": "545570"
  },
  {
    "text": "variable which gave him a cubelet token and he used that to obtain a sensibly",
    "start": "545570",
    "end": "550670"
  },
  {
    "text": "full control of the cluster now that server side request forgery or",
    "start": "550670",
    "end": "556550"
  },
  {
    "start": "554000",
    "end": "554000"
  },
  {
    "text": "SSR F that I talked about that is where you convince a web server to make a",
    "start": "556550",
    "end": "561620"
  },
  {
    "text": "request on your behalf what you're seeing in the screenshot here is a picture of the page where you would edit",
    "start": "561620",
    "end": "567920"
  },
  {
    "text": "your stores theme and rather than just changing some text or shapes or images what the researcher did was add a",
    "start": "567920",
    "end": "574760"
  },
  {
    "text": "redirect and if you're not in security this might seem relatively benign because if you redirect your browser of",
    "start": "574760",
    "end": "581450"
  },
  {
    "text": "the storefront to for instance Google com and that's your business it's probably bad for business",
    "start": "581450",
    "end": "587510"
  },
  {
    "text": "but it's not inherently dangerous they'll just be sent to a search page the problem is that there is a certain",
    "start": "587510",
    "end": "594020"
  },
  {
    "text": "level of implicit trust with anything that comes from inside your network and the researcher was able to exploit that",
    "start": "594020",
    "end": "599360"
  },
  {
    "text": "here so getting back to the diagram he replaced that with an exploit page and when the headless browser connected to",
    "start": "599360",
    "end": "606560"
  },
  {
    "text": "the exploit page it got the redirect and sent a request for a token to a metadata",
    "start": "606560",
    "end": "611930"
  },
  {
    "text": "server so this Google service account and the metadata server that runs with",
    "start": "611930",
    "end": "617750"
  },
  {
    "text": "it is used for interacting with other api's the metadata server will hold this",
    "start": "617750",
    "end": "623000"
  },
  {
    "text": "token and it will also return other valuable information for any cloud platforms such as the geographical",
    "start": "623000",
    "end": "628550"
  },
  {
    "text": "location that you're running in or the type of machine that you're running on the api's assume that this token is",
    "start": "628550",
    "end": "635720"
  },
  {
    "text": "going to be used by other applications running in the cloud platform not by an end-user but by using this SS or F he",
    "start": "635720",
    "end": "642440"
  },
  {
    "text": "was able to convince the web server to return the token to him directly and Greg's going to demonstrate that so for",
    "start": "642440",
    "end": "653330"
  },
  {
    "text": "this demo we haven't recreated the whole environment what we do have is we have a pod called the screen screenshot pod",
    "start": "653330",
    "end": "659839"
  },
  {
    "text": "that we're going to technically just shell into for the purposes of this demo so in the actual",
    "start": "659839",
    "end": "666339"
  },
  {
    "text": "attack the attacker is using that possible adult liquid and doing the SS RF here we're gonna replicate",
    "start": "666339",
    "end": "672540"
  },
  {
    "text": "effectively the same thing but just using W get so this is I've scooped it",
    "start": "672540",
    "end": "679240"
  },
  {
    "text": "up so I don't typos here but this is a live demo and we are making these requests live against an actual cluster",
    "start": "679240",
    "end": "684490"
  },
  {
    "text": "so making that request to the computer data metadata API for a token for that",
    "start": "684490",
    "end": "691720"
  },
  {
    "text": "service account and we actually get a 403 permission denied message so it",
    "start": "691720",
    "end": "697779"
  },
  {
    "text": "doesn't actually work and the reason it doesn't work is that Google basically anticipated this style of attack so this",
    "start": "697779",
    "end": "704529"
  },
  {
    "text": "stealth attack is quite common and so Google requires when talking to this metadata server that you set this",
    "start": "704529",
    "end": "711490"
  },
  {
    "text": "metadata flava Google header and it's for exactly this reason so it's pretty common for a this style of attack to be",
    "start": "711490",
    "end": "719019"
  },
  {
    "text": "able to control the URL of a request but not to be able to set headers or control the full HTTP payload so that's good we",
    "start": "719019",
    "end": "727390"
  },
  {
    "text": "blocked this attack but unfortunately the attacker would kind of looked around",
    "start": "727390",
    "end": "732880"
  },
  {
    "text": "a bit and found that there was a beta version of the same API so you can see here v1 is the ga version and B 1 beta 1",
    "start": "732880",
    "end": "741570"
  },
  {
    "text": "is a different version of the same API and that doesn't have this protection so",
    "start": "741570",
    "end": "747220"
  },
  {
    "text": "this header requirement was a was added between beta and GA so you can see here",
    "start": "747220",
    "end": "753040"
  },
  {
    "text": "the security researcher was able to get the the access token from this metadata so the end point",
    "start": "753040",
    "end": "760740"
  },
  {
    "text": "so just to recap that first try was on the v1 API back up to 403 the second try",
    "start": "761760",
    "end": "769480"
  },
  {
    "text": "went to the v1 beta 1 and that got the token and so it turns back up in a",
    "start": "769480",
    "end": "774880"
  },
  {
    "text": "screenshot and then the research I had to dump out the token out of the screenshot so this obviously seems like",
    "start": "774880",
    "end": "782079"
  },
  {
    "start": "780000",
    "end": "780000"
  },
  {
    "text": "not good so the beta API is effectively a known issue when when this report what",
    "start": "782079",
    "end": "790240"
  },
  {
    "text": "happened and Shopify engaged just to figure out what was going on here these API is actually is a seeing",
    "start": "790240",
    "end": "796740"
  },
  {
    "text": "significant usage still so even prior the beta beta there's actually more versions of these api's and there were a",
    "start": "796740",
    "end": "803580"
  },
  {
    "text": "lot of tools developed in in that period between beta and nga that have created",
    "start": "803580",
    "end": "809190"
  },
  {
    "text": "dependencies on these api's and anyone who's had to turn down an API that's in wide usage knows how hard that can be so",
    "start": "809190",
    "end": "816150"
  },
  {
    "text": "what we've done is we've started announcing a few months ago that we",
    "start": "816150",
    "end": "822540"
  },
  {
    "text": "would start we would be turning these off so when you started getting warnings on cluster creation on gke that we were",
    "start": "822540",
    "end": "828120"
  },
  {
    "text": "going to disable these old api's and as of 1:12 they'll be off by default so",
    "start": "828120",
    "end": "833400"
  },
  {
    "text": "1:12 isn't quite available on GAE but it will be soon so if you create a new one 12 cluster you won't have these api's on",
    "start": "833400",
    "end": "839850"
  },
  {
    "text": "by default and right now you can opt in by setting a this flag to turn off those",
    "start": "839850",
    "end": "845460"
  },
  {
    "text": "api's so you can either create a new cluster with this flag or create a new node pull in an existing cluster and",
    "start": "845460",
    "end": "852300"
  },
  {
    "text": "migrate your workloads over and there's a link here for the details this is a",
    "start": "852300",
    "end": "857430"
  },
  {
    "text": "GAE specific thing too so ok that's the",
    "start": "857430",
    "end": "863790"
  },
  {
    "start": "862000",
    "end": "862000"
  },
  {
    "text": "defense for the token but like how useful is this token at all so we actually done a fair bit of work to d-d",
    "start": "863790",
    "end": "871589"
  },
  {
    "text": "privileged that token and what you get by default so prior to 1:10 that token",
    "start": "871589",
    "end": "876750"
  },
  {
    "text": "was fairly powerful and had a fair bit of power over the compute API just generally and we did a similar",
    "start": "876750",
    "end": "883830"
  },
  {
    "text": "deprecation kind of warning and process and as of 1:10 onwards that token",
    "start": "883830",
    "end": "890580"
  },
  {
    "text": "actually doesn't really have particularly interesting permissions anymore so it has some minimal stuff that allows it to deliver logs and that",
    "start": "890580",
    "end": "897300"
  },
  {
    "text": "kind of thing but it doesn't have kind of broad privileges that it previously did that may vary if the customer has",
    "start": "897300",
    "end": "904530"
  },
  {
    "text": "kind of added additional privileges on to that that particular token but in",
    "start": "904530",
    "end": "909660"
  },
  {
    "text": "this case Shopify hadn't done that they were actually running a 1:9 cluster but they'd followed our hardening advice so",
    "start": "909660",
    "end": "915180"
  },
  {
    "text": "they created a a service account that had the permissions described in the",
    "start": "915180",
    "end": "920339"
  },
  {
    "text": "hardening guide and so they were effectively on the 1:10 behavior a bit on a 1:9 cluster so the end result you",
    "start": "920339",
    "end": "927720"
  },
  {
    "text": "can go kind of report from the research it was and I got to this point no I it's",
    "start": "927720",
    "end": "933209"
  },
  {
    "text": "doesn't seem that useful what else what else is there what else can I do so they looked around a little bit and",
    "start": "933209",
    "end": "939570"
  },
  {
    "start": "937000",
    "end": "937000"
  },
  {
    "text": "then in the metadata server they started like looking through what else was in the metadata server and they found this",
    "start": "939570",
    "end": "945000"
  },
  {
    "text": "cube end environment variable and that's how we bootstrap trust today in GAE",
    "start": "945000",
    "end": "950310"
  },
  {
    "text": "nodes so we deliver a static key that is populated into this variable along with",
    "start": "950310",
    "end": "955769"
  },
  {
    "text": "a bunch of other configuration and stuff and that's the the way the cubelet gets the trust to kind of request a",
    "start": "955769",
    "end": "962910"
  },
  {
    "text": "certificate from the communities certificates API and join the cluster so",
    "start": "962910",
    "end": "968009"
  },
  {
    "text": "it's a bootstrap token that it uses to kind of get a real identity and then become a node effectively joined to the",
    "start": "968009",
    "end": "975569"
  },
  {
    "text": "cluster so let's demo that next step in the attack so we're gonna do the same",
    "start": "975569",
    "end": "988410"
  },
  {
    "text": "thing hit that V 1 beta 1 API except now we're gonna ask for a cube M and this is",
    "start": "988410",
    "end": "994949"
  },
  {
    "text": "a wall text it's a big variable but pausing out the interesting bits of that",
    "start": "994949",
    "end": "1000620"
  },
  {
    "text": "there's a CA cert that's the public set for the communities API server there's a",
    "start": "1000620",
    "end": "1008360"
  },
  {
    "text": "cubed cert that's the public part of the cubelet credential this cube bootstrap",
    "start": "1008360",
    "end": "1013970"
  },
  {
    "text": "credential and then the private part of that and so now if we kind of in if we",
    "start": "1013970",
    "end": "1023540"
  },
  {
    "text": "pretend we're the attacker we've kind of grabbed that cube M environment variable out we've paused out these these three",
    "start": "1023540",
    "end": "1029418"
  },
  {
    "text": "things decoded them into the right format and then we take that stuff over to our machine what can we do with it so",
    "start": "1029419",
    "end": "1036798"
  },
  {
    "text": "we can actually just plumb it directly into Q control because it is a valid credential against the against the",
    "start": "1036799",
    "end": "1042740"
  },
  {
    "text": "server so we're going to take that client certificate that client private key and the C a public key and then we",
    "start": "1042740",
    "end": "1050960"
  },
  {
    "text": "can just make request against the API so that as the bootstrap token for the cube laid so we're going to try getting pods",
    "start": "1050960",
    "end": "1056900"
  },
  {
    "text": "for all namespaces and that works so we'll try let's try running a deployment",
    "start": "1056900",
    "end": "1062580"
  },
  {
    "text": "that actually doesn't work this this bootstrap credential doesn't have privileges to do that",
    "start": "1062580",
    "end": "1068279"
  },
  {
    "text": "I'll try exacting into a pod that doesn't work try getting secrets that",
    "start": "1068279",
    "end": "1077070"
  },
  {
    "text": "does work so the couplet as part of its core function needs to be able to get secrets to be able to mount them into",
    "start": "1077070",
    "end": "1083159"
  },
  {
    "text": "pods so just recapping again we took the",
    "start": "1083159",
    "end": "1091139"
  },
  {
    "text": "cube n split three things out of it used it with Q control to talk to the API so though",
    "start": "1091139",
    "end": "1097110"
  },
  {
    "start": "1096000",
    "end": "1096000"
  },
  {
    "text": "what's the defense here so there's a right now you can add a metadata concealment option which effectively",
    "start": "1097110",
    "end": "1104880"
  },
  {
    "text": "puts a proxy in between the metadata server and the pods the the containers",
    "start": "1104880",
    "end": "1110820"
  },
  {
    "text": "that are running on that machine and it filters out sensitive information like cube and it was actually specifically",
    "start": "1110820",
    "end": "1117570"
  },
  {
    "text": "developed for exactly this this style of attack that was available kind of at the",
    "start": "1117570",
    "end": "1124559"
  },
  {
    "text": "time Shopify had tried it out they'd had some problems with it so it wasn't actually running on the cluster that the",
    "start": "1124559",
    "end": "1131880"
  },
  {
    "text": "security research had tried if it had been it would have prevented this attack this is really only a temporary solution",
    "start": "1131880",
    "end": "1138389"
  },
  {
    "text": "though we don't want to have to kind of have people opt into security like this",
    "start": "1138389",
    "end": "1144929"
  },
  {
    "text": "so we've added to kubernetes itself the ability for communities to the cubelet",
    "start": "1144929",
    "end": "1151860"
  },
  {
    "text": "to bootstrap itself of a cryptographic assertion that comes from a trusted platform module and the idea is that",
    "start": "1151860",
    "end": "1158010"
  },
  {
    "text": "that will be a bitter bootstrap what a better way to bootstrap the cubelet in",
    "start": "1158010",
    "end": "1164070"
  },
  {
    "text": "the future that will replace this static token and fix up this security weakness",
    "start": "1164070",
    "end": "1169950"
  },
  {
    "text": "so if you're a GAE customer interested in in that come talk to us and we can",
    "start": "1169950",
    "end": "1175769"
  },
  {
    "text": "give you more information so just kind of general advice out of out of this",
    "start": "1175769",
    "end": "1182250"
  },
  {
    "start": "1179000",
    "end": "1179000"
  },
  {
    "text": "part of the attack generally we want the couplet to have just the minimum privileges that it actually needs and so",
    "start": "1182250",
    "end": "1188399"
  },
  {
    "text": "that means a few things you need to have all back on a back turned off you need to have no",
    "start": "1188399",
    "end": "1193870"
  },
  {
    "text": "authorization feature turned on that also limits the cubelet privileges in in a number of important ways and an",
    "start": "1193870",
    "end": "1201250"
  },
  {
    "text": "interesting part of this for their kind of Shopify scenario was that they'd upgraded their cluster through a number",
    "start": "1201250",
    "end": "1207520"
  },
  {
    "text": "of versions and we'd kind of it continually iterated on the security as through each of those versions and so",
    "start": "1207520",
    "end": "1213990"
  },
  {
    "text": "the cubelets in the older clusters required kind of far more privileged than the couplets in newer clusters and",
    "start": "1213990",
    "end": "1221140"
  },
  {
    "text": "so there was an older cluster role binding called cubelet cluster admin which doesn't actually give you close to",
    "start": "1221140",
    "end": "1227080"
  },
  {
    "text": "admin it's kind of a bad name for it but it does give you more power than modern cubelets need on gke so if you have a",
    "start": "1227080",
    "end": "1234820"
  },
  {
    "text": "new gke cluster and you create a brand new cluster you don't have this this backwards compatibility binding there",
    "start": "1234820",
    "end": "1241299"
  },
  {
    "text": "but because this cluster had been upgraded a few times this backwards compatibility binding was there so",
    "start": "1241299",
    "end": "1247169"
  },
  {
    "text": "taking a look at all auditing role bindings periodically is good for gke in",
    "start": "1247169",
    "end": "1254049"
  },
  {
    "text": "particular we'll be removing this binding automatically for customers on",
    "start": "1254049",
    "end": "1260010"
  },
  {
    "text": "clusters where it's safe to do to do so where they don't have old nodes that still rely on this binding and there's a",
    "start": "1260010",
    "end": "1268029"
  },
  {
    "text": "link here to a general kubernetes cluster hardening guide that talks about some of these concepts if you trying to",
    "start": "1268029",
    "end": "1278140"
  },
  {
    "text": "take photos and you miss it I've got a slide at the end with all the links so don't worry so let's just see what it",
    "start": "1278140",
    "end": "1286360"
  },
  {
    "text": "looks like with all that good defense stuff turned on",
    "start": "1286360",
    "end": "1292080"
  },
  {
    "text": "so we'll try exactly the same thing in same order just for demo symmetry so",
    "start": "1297470",
    "end": "1303629"
  },
  {
    "text": "this was the first request that was already going to fail because it was against the v1 API and we went setting",
    "start": "1303629",
    "end": "1309690"
  },
  {
    "text": "that header the second time was the the beta 1 version and we expect that to now",
    "start": "1309690",
    "end": "1316110"
  },
  {
    "text": "fail because we've turned off those that beta API it's great that now fails and",
    "start": "1316110",
    "end": "1323389"
  },
  {
    "text": "then the third thing was so at that point this attack is now mitigated",
    "start": "1323389",
    "end": "1328710"
  },
  {
    "text": "because that had a can't be set with this vulnerability but say there was another vulnerability that could set the",
    "start": "1328710",
    "end": "1334769"
  },
  {
    "text": "header or they got access to the host somehow in a different way if they got that cube and environment variable then",
    "start": "1334769",
    "end": "1342389"
  },
  {
    "text": "the if the meta-data proxy is running it should get filtered out so you shouldn't",
    "start": "1342389",
    "end": "1347490"
  },
  {
    "text": "be able to get access to that so we'll try making that same request and yet we can see it's forbidden",
    "start": "1347490",
    "end": "1352980"
  },
  {
    "text": "and now just switching over to the attackers machine so in the same kind of",
    "start": "1352980",
    "end": "1358499"
  },
  {
    "text": "vein that's like two different defenses that are going to block those those",
    "start": "1358499",
    "end": "1364590"
  },
  {
    "text": "things from happening but say somehow the cubic credentials was still managed",
    "start": "1364590",
    "end": "1370289"
  },
  {
    "text": "to be exfiltrated and use what does it look like if you don't have that kind of older role binding the situation is a",
    "start": "1370289",
    "end": "1377519"
  },
  {
    "text": "bit different in terms of what permissions that cubelet has so we're going to do the same things we did before we're going to try and get pause",
    "start": "1377519",
    "end": "1383820"
  },
  {
    "text": "in all namespaces we don't have the permissions to do that I'm gonna get secrets you know permission to do that",
    "start": "1383820",
    "end": "1390809"
  },
  {
    "text": "in the general case and effectively mostly what this does favorably the only",
    "start": "1390809",
    "end": "1398340"
  },
  {
    "text": "permission is culet this newer version of the cubelet that doesn't have the old compatibility binding I can do is just",
    "start": "1398340",
    "end": "1404549"
  },
  {
    "text": "create certificate signing request so all it needs to do is create a CSR that it can use to get a certificate that'll",
    "start": "1404549",
    "end": "1411269"
  },
  {
    "text": "let's it talk to the API server it doesn't need to be used for anything else and from that point on the that",
    "start": "1411269",
    "end": "1417200"
  },
  {
    "text": "node x.509 identity is used against the against the API server so there's more",
    "start": "1417200",
    "end": "1423659"
  },
  {
    "text": "hops for an attacker to go through here but we have reduced like the privileges that just this bootstrap credential",
    "start": "1423659",
    "end": "1429419"
  },
  {
    "text": "needs so a little bit about detection here so",
    "start": "1429419",
    "end": "1439179"
  },
  {
    "start": "1438000",
    "end": "1438000"
  },
  {
    "text": "say this happened on your cluster what's in the logs what can you look for how could you detect actions like this so",
    "start": "1439179",
    "end": "1445689"
  },
  {
    "text": "kubernetes has API audit logging there's a link here to the documentation about it exactly what's in that log depends on",
    "start": "1445689",
    "end": "1452769"
  },
  {
    "text": "you ordered policy that you set a person from hebijo actually did a pretty good",
    "start": "1452769",
    "end": "1458619"
  },
  {
    "text": "talk about how how you might do that for a cluster and kind of the content of the",
    "start": "1458619",
    "end": "1463809"
  },
  {
    "text": "log said I'd check that out so on gke you can read about how we configure",
    "start": "1463809",
    "end": "1469509"
  },
  {
    "text": "audit logging at this at this link effectively what you get on GAE is",
    "start": "1469509",
    "end": "1474549"
  },
  {
    "text": "mutating operations logged by default for free so you get those logs just by",
    "start": "1474549",
    "end": "1480009"
  },
  {
    "text": "creating a gke clustering doing nothing so kind of screenshot of the of the",
    "start": "1480009",
    "end": "1486639"
  },
  {
    "text": "stack private API staff drive the UI where you can analyze these logs and",
    "start": "1486639",
    "end": "1492489"
  },
  {
    "text": "just zooming in on that top bit there the interesting part for this particular attack is that you would want to go look",
    "start": "1492489",
    "end": "1499779"
  },
  {
    "text": "for authentication for a user called cubelet this is a GAE specific string",
    "start": "1499779",
    "end": "1506829"
  },
  {
    "text": "but in this particular case that's what you would look for and more generally this is kind of how you look for",
    "start": "1506829",
    "end": "1512469"
  },
  {
    "text": "usernames in the in the structure of the of the community's audit log and then we",
    "start": "1512469",
    "end": "1520179"
  },
  {
    "start": "1519000",
    "end": "1519000"
  },
  {
    "text": "can see other stuff in the in the logs as well too so when I tried to create that deployment as the cubelet you can",
    "start": "1520179",
    "end": "1525999"
  },
  {
    "text": "see here this was a logging level error there's a authorization denied",
    "start": "1525999",
    "end": "1532469"
  },
  {
    "text": "authorization granted false somewhere in that Jason and the exec can go another",
    "start": "1532469",
    "end": "1540429"
  },
  {
    "text": "pod that also failed would look like this and you can also see other things",
    "start": "1540429",
    "end": "1545799"
  },
  {
    "start": "1545000",
    "end": "1545000"
  },
  {
    "text": "like I mentioned that that CSR creation for nodes joining the cluster so I'm",
    "start": "1545799",
    "end": "1553989"
  },
  {
    "text": "gonna hand it back to Shane to kind of sum up shuffle his response thanks Greg so in the first day after we received",
    "start": "1553989",
    "end": "1562089"
  },
  {
    "start": "1554000",
    "end": "1554000"
  },
  {
    "text": "this report we had disabled the vulnerable service we had started rotating credentials and that was important to",
    "start": "1562089",
    "end": "1568010"
  },
  {
    "text": "make sure that there could be no persistence that if the researcher or anyone else had been able to take these",
    "start": "1568010",
    "end": "1573140"
  },
  {
    "text": "credentials they wouldn't be able to use them anymore and we paid a small token bounty to the researcher to say you know",
    "start": "1573140",
    "end": "1579500"
  },
  {
    "text": "thanks for submitting this report there's more on the way by the end of one week we had analyzed the audit logs",
    "start": "1579500",
    "end": "1585800"
  },
  {
    "text": "using some of the queries that Greg's team suggested and determined that no one else had access to our clusters no",
    "start": "1585800",
    "end": "1592430"
  },
  {
    "text": "one else had exploited this vulnerability and we started auditing our our back findings and found that",
    "start": "1592430",
    "end": "1599000"
  },
  {
    "text": "because some of them were more permissive we were able to tighten that down by the end of one month we were",
    "start": "1599000",
    "end": "1604580"
  },
  {
    "text": "able to prevent unwanted redirects completely by patching the application and implementing a whitelist blacklist",
    "start": "1604580",
    "end": "1611000"
  },
  {
    "text": "so that safe redirects are still okay but you couldn't use that redirect to talk to the metadata server we re",
    "start": "1611000",
    "end": "1618020"
  },
  {
    "text": "enabled the screenshot service once that was done and then we deployed the metadata proxy now the metadata",
    "start": "1618020",
    "end": "1624410"
  },
  {
    "text": "concealment feature was not quite ready for what we needed and so we found that",
    "start": "1624410",
    "end": "1629420"
  },
  {
    "text": "it used an open source metadata proxy we made our own Fork and we're able to implement that we paid the researchers",
    "start": "1629420",
    "end": "1637670"
  },
  {
    "text": "rent and quite a bit more than that and then we disclose the vulnerability to the community so that's what we did",
    "start": "1637670",
    "end": "1643340"
  },
  {
    "text": "on gke on our clusters Greg's going to summarize what you can do more generally",
    "start": "1643340",
    "end": "1649630"
  },
  {
    "text": "yeah so generalizing up to kind of anyone running kubernetes what can you take away from this talk so if you are",
    "start": "1651640",
    "end": "1658400"
  },
  {
    "start": "1652000",
    "end": "1652000"
  },
  {
    "text": "running on a provider and they've given you some security advice go take a look at it this is where we put ours the the",
    "start": "1658400",
    "end": "1666320"
  },
  {
    "text": "kind of metadata server was a played a key part in this in this in this story and it's not unique to Google there are",
    "start": "1666320",
    "end": "1674330"
  },
  {
    "text": "other kind of similar privileged network endpoints and not just kind of cloud provider metadata servers but also think",
    "start": "1674330",
    "end": "1680990"
  },
  {
    "text": "more generally about other network endpoints that are exposed on the host that you might want to either filter or",
    "start": "1680990",
    "end": "1686570"
  },
  {
    "text": "block off two containers or two specific containers run the runner back for sure",
    "start": "1686570",
    "end": "1693710"
  },
  {
    "text": "and the node authorization teacher make sure your kubernetes service",
    "start": "1693710",
    "end": "1699270"
  },
  {
    "text": "accounts at least privilege take a look at your roll bindings periodically especially if you're upgrading through a",
    "start": "1699270",
    "end": "1705210"
  },
  {
    "text": "number of different versions there's kind of kubernetes has been evolving and to make those upgrades functional so",
    "start": "1705210",
    "end": "1712740"
  },
  {
    "text": "that cubelets don't break and similar things if you've got a cluster that's been through a few upgrades it may have",
    "start": "1712740",
    "end": "1719520"
  },
  {
    "text": "some older backwards compatibility things if you can and it's not you know",
    "start": "1719520",
    "end": "1725190"
  },
  {
    "text": "a burdensome amount of work I'd recommend kind of creating new clusters and migrating to them on on minor",
    "start": "1725190",
    "end": "1732210"
  },
  {
    "text": "version updates but I recognize there is there is cost in that and it sort of depends on how you've configured your",
    "start": "1732210",
    "end": "1738510"
  },
  {
    "text": "event environment how big that cost is of moving to a brand-new cluster but on",
    "start": "1738510",
    "end": "1743850"
  },
  {
    "text": "GAE you'll always get like the the most that kind of most up-to-date security on",
    "start": "1743850",
    "end": "1750000"
  },
  {
    "text": "a brand-new cluster and we'll make it as secure as possible for upgrades as well to within the bounds of backwards",
    "start": "1750000",
    "end": "1756810"
  },
  {
    "text": "compatibility it's really important to collect those API logs and have them",
    "start": "1756810",
    "end": "1761880"
  },
  {
    "text": "available to query and that's the default on GAE at the end of the presentation here I've",
    "start": "1761880",
    "end": "1767400"
  },
  {
    "text": "put in a bunch of kind of example queries that were relevant to this particular security issue as sort of a",
    "start": "1767400",
    "end": "1774600"
  },
  {
    "text": "pointer to here's where some interesting fields are in the logs that you should",
    "start": "1774600",
    "end": "1779810"
  },
  {
    "text": "maybe run some trial queries against your logs before something like this happens so you're a bit more familiar",
    "start": "1779810",
    "end": "1785010"
  },
  {
    "text": "with them and also some interesting values for things you might look for in those fields that represent things like",
    "start": "1785010",
    "end": "1791100"
  },
  {
    "text": "nodes represent things like the cubelet that are probably relevant so here's a",
    "start": "1791100",
    "end": "1799170"
  },
  {
    "text": "slide of links I will leave this up while we're taking questions but that's",
    "start": "1799170",
    "end": "1804840"
  },
  {
    "text": "all we have so I'm happy to take questions now yeah [Applause]",
    "start": "1804840",
    "end": "1817380"
  },
  {
    "start": "1819000",
    "end": "1819000"
  },
  {
    "text": "so a member of the security team Gaza a mystic oh sorry so the question was when",
    "start": "1822150",
    "end": "1828880"
  },
  {
    "text": "we received the report on Sunday night how did we know it wasn't just spam how did we know this was serious so we have",
    "start": "1828880",
    "end": "1834310"
  },
  {
    "text": "a dedicated triage team that analyzes every report that comes in and decides whether this is something that needs to",
    "start": "1834310",
    "end": "1839650"
  },
  {
    "text": "be action immediately or if this is something that can wait or if maybe we just need to guide this researcher and he's not quite ready for",
    "start": "1839650",
    "end": "1845230"
  },
  {
    "text": "this yet so once we receive this he was able to look at that and decided yes",
    "start": "1845230",
    "end": "1851590"
  },
  {
    "text": "this was really important and alerted the rest of the team yeah and there are companies you can pay to help you do",
    "start": "1851590",
    "end": "1858160"
  },
  {
    "text": "that triage and do that through that first level I was to filter out the bogus stuff and I think like any triage",
    "start": "1858160",
    "end": "1864640"
  },
  {
    "text": "person looking at this report like if you go look at it it's great like it's step by step very repeatable very",
    "start": "1864640",
    "end": "1870760"
  },
  {
    "text": "reproducible they're a good report so those reports get realized very quickly so yeah",
    "start": "1870760",
    "end": "1881610"
  },
  {
    "text": "I don't think I quite followed the question yeah I think the question is about that that all the cluster role",
    "start": "1900370",
    "end": "1906010"
  },
  {
    "text": "binding is that yeah so yeah what's happening with that is it needs to be",
    "start": "1906010",
    "end": "1911950"
  },
  {
    "text": "there if you have old cubelets so there are clusters that still need it so for clusters that don't need it we're going",
    "start": "1911950",
    "end": "1917889"
  },
  {
    "text": "to be cleaning those up for gke customers and this is a gke specific thing in this case there may be other",
    "start": "1917889",
    "end": "1925480"
  },
  {
    "text": "similar compatibility things for other providers that have had to have had",
    "start": "1925480",
    "end": "1931029"
  },
  {
    "text": "clusters that moves from multiple versions but the gke customers will will be cleaning that up where it's safe to do so but we have to",
    "start": "1931029",
    "end": "1938230"
  },
  {
    "text": "tread fairly carefully because the consequence of like messing that up is your nose drop off the map and they",
    "start": "1938230",
    "end": "1944320"
  },
  {
    "text": "stopped communicating with the API server so it needs it's a something that needs to be handled very carefully for",
    "start": "1944320",
    "end": "1955480"
  },
  {
    "text": "what was force upgrades safe so force upgrade wouldn't have actually helped so like this is this is a cluster role",
    "start": "1955480",
    "end": "1961090"
  },
  {
    "text": "binding it's not a case about upgrading the queue blade or or anything like that it needs to me state the two things so",
    "start": "1961090",
    "end": "1968529"
  },
  {
    "text": "the one thing that was always safe was creating a new cluster the other thing that was that could have got to the",
    "start": "1968529",
    "end": "1973690"
  },
  {
    "text": "safety was either us cleaning up this binding for you or you cleaning up yourself which is which is a you know",
    "start": "1973690",
    "end": "1980169"
  },
  {
    "text": "delete this particular role by name yes",
    "start": "1980169",
    "end": "1985299"
  },
  {
    "text": "in the back",
    "start": "1985299",
    "end": "1987690"
  },
  {
    "text": "that is a good question I don't know what the particular tool is but we could",
    "start": "2003100",
    "end": "2008570"
  },
  {
    "text": "take a look at it and cube bench okay I",
    "start": "2008570",
    "end": "2014180"
  },
  {
    "text": "don't know I don't know if so the question is does cube bench kind of give you an alert that what for this",
    "start": "2014180",
    "end": "2021920"
  },
  {
    "text": "particular role binding I don't know the answer to that but we could take a look at that and see if we can we could add it yeah okay Brad",
    "start": "2021920",
    "end": "2031480"
  },
  {
    "text": "it doesn't bread said it doesn't okay well so we'll see we'll see if we can sleep we can do that yeah it is not a",
    "start": "2031480",
    "end": "2044630"
  },
  {
    "text": "temp so the question is isn't the bootstrap token temporary the answer is it is not right now yeah it q a DM is",
    "start": "2044630",
    "end": "2057408"
  },
  {
    "text": "not a Google so that cube a DM is not used to set up this Google cluster but",
    "start": "2057409",
    "end": "2064310"
  },
  {
    "text": "there gke cluster yeah",
    "start": "2064310",
    "end": "2067510"
  },
  {
    "text": "okay thanks everyone thank you [Applause]",
    "start": "2075010",
    "end": "2083050"
  }
]