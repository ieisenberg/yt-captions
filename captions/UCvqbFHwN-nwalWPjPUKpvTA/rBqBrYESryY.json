[
  {
    "start": "0",
    "end": "13000"
  },
  {
    "text": "hey i'm shane from shopify and thanks for watching my talk this is intro to falco",
    "start": "80",
    "end": "5440"
  },
  {
    "text": "i'm going to tell you about a security tool that we've been using at shopify since 2018 but first i have a confession",
    "start": "5440",
    "end": "13599"
  },
  {
    "start": "13000",
    "end": "13000"
  },
  {
    "text": "i'm not actually a falco maintainer and this is a maintainer track talk",
    "start": "13599",
    "end": "20000"
  },
  {
    "text": "um i'm barely even a contributor but they thought it would be cool to have an end user go through a few things",
    "start": "20000",
    "end": "25119"
  },
  {
    "text": "and i've been using it in one form or another since uh 2018 so a little bit about myself i'm on the",
    "start": "25119",
    "end": "31119"
  },
  {
    "text": "infrastructure security team at shopify um i've worked in the past mostly with intrusion detection systems like",
    "start": "31119",
    "end": "37920"
  },
  {
    "text": "network intrusion detection or nids using a tool called snort also a bit of circada the zeek formerly",
    "start": "37920",
    "end": "44160"
  },
  {
    "text": "known as bro and also some host ids or hids like os sec i've also done some sim or",
    "start": "44160",
    "end": "51840"
  },
  {
    "text": "security information event management and logs which is basically gathering a haystack of events",
    "start": "51840",
    "end": "57440"
  },
  {
    "text": "from all the things aggregating them and trying to pick out malicious needles and all of it that's hard because most of the things",
    "start": "57440",
    "end": "64158"
  },
  {
    "text": "that feel like needles turn out to just be pointy pieces of hay now i spend most of my time doing none",
    "start": "64159",
    "end": "70159"
  },
  {
    "text": "of those things i joined shopify in 2017 on the infrastructure security team since then my primary focus has been on",
    "start": "70159",
    "end": "76640"
  },
  {
    "text": "preventing anything bad from happening in the first place mostly by giving developers paved roads",
    "start": "76640",
    "end": "82320"
  },
  {
    "text": "and guardrails so that it's easier for them to deploy secure applications than it is to deploy insecure ones",
    "start": "82320",
    "end": "90159"
  },
  {
    "text": "so with that let me actually introduce falco",
    "start": "90159",
    "end": "95759"
  },
  {
    "text": "now falco is a tool that detects events",
    "start": "95759",
    "end": "102479"
  },
  {
    "text": "that may be suspicious in your environment and i'm going to tell you a bit about",
    "start": "102479",
    "end": "108159"
  },
  {
    "text": "what it's not how to get it running some tips and tricks for making it work better some use cases so that you can",
    "start": "108159",
    "end": "115840"
  },
  {
    "text": "actually make it useful for you if you want to try it and then some next steps for what you can do if you",
    "start": "115840",
    "end": "121680"
  },
  {
    "text": "want to contribute or if you want to get some more help now prevention is always going to be behind",
    "start": "121680",
    "end": "128000"
  },
  {
    "text": "detection so something like falco's really important and if you want to know more about the story of how shopify came",
    "start": "128000",
    "end": "133120"
  },
  {
    "text": "to use it then check out my keynote with chris nova from systig and you can hear more about that",
    "start": "133120",
    "end": "139920"
  },
  {
    "text": "so falco is not new wave",
    "start": "139920",
    "end": "145360"
  },
  {
    "text": "it is also not any of this and you'll see this in my other talk but the most important thing you can do",
    "start": "146400",
    "end": "152720"
  },
  {
    "text": "right now is follow best practices do these things and keep your systems up to date effective monitoring augments that but",
    "start": "152720",
    "end": "159920"
  },
  {
    "text": "it doesn't replace it so this is what people see",
    "start": "159920",
    "end": "166000"
  },
  {
    "text": "when they see shopify and this will get into why shopify is",
    "start": "166000",
    "end": "171920"
  },
  {
    "text": "using it so we've got over a million stores on shopify they all have control over their",
    "start": "171920",
    "end": "177200"
  },
  {
    "text": "own look and feel to the vast majority of people who will interact with shopify in some way",
    "start": "177200",
    "end": "182640"
  },
  {
    "text": "they'll see something that looks a little bit like this and most of the time they don't even",
    "start": "182640",
    "end": "188319"
  },
  {
    "text": "realize that they're looking at a shopify store so that's what our customers see but this is what our merchants see",
    "start": "188319",
    "end": "196080"
  },
  {
    "text": "they see that they're dealing with shopify they've chosen shopify they know it's us big businesses have chosen us",
    "start": "196080",
    "end": "201599"
  },
  {
    "text": "because they want a reliable platform that leaves the branding to them and small businesses want it to be easy",
    "start": "201599",
    "end": "207840"
  },
  {
    "text": "to benefit from that same reliable platform as large ones",
    "start": "207840",
    "end": "212959"
  },
  {
    "text": "this is what i see though i see 10 000 services on 50 clusters and that's a",
    "start": "212959",
    "end": "219440"
  },
  {
    "text": "lot of infrastructure to secure so in some of these clusters including the ones that actually process the",
    "start": "219440",
    "end": "224879"
  },
  {
    "text": "payment card data for 190 million dollars a day we need to do everything we can to",
    "start": "224879",
    "end": "230400"
  },
  {
    "text": "ensure that we're preventing any unauthorized access we do this by following best practices",
    "start": "230400",
    "end": "235519"
  },
  {
    "text": "and by deploying scripts to scan and ensure that all of our workloads really are following the things we've learned in",
    "start": "235519",
    "end": "241200"
  },
  {
    "text": "the past we bolster this by having external auditors validate our security posture and by making some of our systems",
    "start": "241200",
    "end": "247760"
  },
  {
    "text": "eligible for security bug bounty",
    "start": "247760",
    "end": "254799"
  },
  {
    "text": "i mentioned this in my other talk but if you missed any of the things on the left then you might be vulnerable",
    "start": "254799",
    "end": "262400"
  },
  {
    "text": "and if an attacker knew about any of the things on the right before you had a patch for it then you were probably",
    "start": "262400",
    "end": "267600"
  },
  {
    "text": "vulnerable and if you're vulnerable you might be compromised we need monitoring in order to be sure that everything else we're",
    "start": "267600",
    "end": "273520"
  },
  {
    "text": "doing is working and sometimes we're just not even aware of the things that could lead to a compromise this is",
    "start": "273520",
    "end": "280320"
  },
  {
    "text": "why effective monitoring is so important now we've chosen falco specifically",
    "start": "280320",
    "end": "285919"
  },
  {
    "start": "283000",
    "end": "283000"
  },
  {
    "text": "because it sees every syscall it knows exactly what is happening on",
    "start": "285919",
    "end": "291520"
  },
  {
    "text": "the system at the kernel level but it's also containers and kubernetes aware so in our case we use docker so it pulls",
    "start": "291520",
    "end": "298400"
  },
  {
    "text": "the docker socket to see exactly which container correlates to",
    "start": "298400",
    "end": "303680"
  },
  {
    "text": "the process that it saws this call from and then it looks up from the kubernetes api",
    "start": "303680",
    "end": "309360"
  },
  {
    "text": "what pod and name space corresponds to that so with all of this information we can",
    "start": "309360",
    "end": "315199"
  },
  {
    "text": "use a rules engine to decide that it's okay for certain things to perform an action but not for others",
    "start": "315199",
    "end": "321759"
  },
  {
    "text": "now if we do get an alert it makes this information available to the end user as well and that's really useful because",
    "start": "321759",
    "end": "328080"
  },
  {
    "text": "as we'll talk a little bit more about when you get an alert you need to know what to do next",
    "start": "328080",
    "end": "333680"
  },
  {
    "text": "it uses ebpf which is extended berkeley packet filters and that's really cool because uh for one thing",
    "start": "333680",
    "end": "340160"
  },
  {
    "text": "it's performant and another it's it's read only at the user space level so it's a little bit",
    "start": "340160",
    "end": "345759"
  },
  {
    "text": "safer than using some of the other drivers that might be available also focus open",
    "start": "345759",
    "end": "351360"
  },
  {
    "text": "source it's under active development it's got a very responsive development team and if you need to ensure a quick",
    "start": "351360",
    "end": "357520"
  },
  {
    "text": "response from certain members of their team in italy i've heard they love pineapple pizza so just lead with that",
    "start": "357520",
    "end": "363680"
  },
  {
    "text": "since we started using it it was also donated by sysdig its creator to the cncf so it's cool that we get to",
    "start": "363680",
    "end": "370000"
  },
  {
    "text": "work with another cncf project so since this is an intro to falco talk",
    "start": "370000",
    "end": "376240"
  },
  {
    "text": "i should probably tell you a little bit about how you actually get this thing up and running",
    "start": "376240",
    "end": "381600"
  },
  {
    "start": "380000",
    "end": "380000"
  },
  {
    "text": "now the easiest way to do this uh in most cases you can just run helmet and then helm install and it'll",
    "start": "381600",
    "end": "388160"
  },
  {
    "text": "get falco running in your environment um if like us you're using cos on gke",
    "start": "388160",
    "end": "393360"
  },
  {
    "text": "with the ebpf driver instead then it's actually four steps because you need to get the configuration file",
    "start": "393360",
    "end": "400160"
  },
  {
    "text": "and change one line in it to turn on ebpf so it's slightly more complicated but",
    "start": "400160",
    "end": "405919"
  },
  {
    "text": "it's still really fast really easy that doesn't mean it's the best way to do it though",
    "start": "405919",
    "end": "411520"
  },
  {
    "text": "so what we suggest we have a fairly elaborate deployment pipeline that turns the",
    "start": "411520",
    "end": "416639"
  },
  {
    "text": "configures code in the repo into an actual thing running in the cluster tooling validates the rules quickly",
    "start": "416639",
    "end": "423840"
  },
  {
    "text": "before it actually builds this and this is actually really important to us because if you get a typo or something",
    "start": "423840",
    "end": "429360"
  },
  {
    "text": "something's wrong with your syntax you want to know that right away before you've even pushed this image so that you can find out before you've",
    "start": "429360",
    "end": "436319"
  },
  {
    "text": "gone to all the trouble of deploying this to a hundred nodes in a cluster even if that is just a staging cluster",
    "start": "436319",
    "end": "442400"
  },
  {
    "text": "you're saving a lot of time most kernels actually have a driver pre-built for you",
    "start": "442400",
    "end": "447759"
  },
  {
    "text": "but if your cloud provider has tweaked the kernel for your image and it's now non-standard then you might need to build the driver",
    "start": "447759",
    "end": "454400"
  },
  {
    "text": "yourself so have your tooling do that as a separate step in a separate docker stage",
    "start": "454400",
    "end": "460080"
  },
  {
    "text": "and then when you've already got this image you can have it already populated and you don't need to wait for it to build every time the container starts up",
    "start": "460080",
    "end": "467120"
  },
  {
    "text": "because it takes a couple of minutes now at shopify we use our own attested builds with binary authorization to help",
    "start": "467120",
    "end": "473680"
  },
  {
    "text": "protect against software supply chain attacks and of course we spent a couple of years fine tuning it",
    "start": "473680",
    "end": "479840"
  },
  {
    "text": "and we'll continue to tweak it over time",
    "start": "479840",
    "end": "484319"
  },
  {
    "text": "so i'll tell you a little bit about some of the technical challenges and give you some tips and tricks for how you can",
    "start": "485680",
    "end": "491599"
  },
  {
    "start": "490000",
    "end": "490000"
  },
  {
    "text": "improve that one of the things that you might encounter is modifying the rules and",
    "start": "491599",
    "end": "498000"
  },
  {
    "text": "again i said that helm is the easy way but it's very popular because it's so fast",
    "start": "498000",
    "end": "503520"
  },
  {
    "text": "because it's so easy and it is really great if you're just starting out there's also a little script in falco extras called",
    "start": "503520",
    "end": "509120"
  },
  {
    "text": "rules to helm and you can use that to help with escaping and updating the yaml if you're using",
    "start": "509120",
    "end": "514159"
  },
  {
    "text": "the helm chart the problem with using this is that it's slow when you deploy it",
    "start": "514159",
    "end": "519440"
  },
  {
    "text": "every time you use helm upgrade you're going to send this config out each pod will",
    "start": "519440",
    "end": "525279"
  },
  {
    "text": "restart to pick up the new config so in production you don't want to have",
    "start": "525279",
    "end": "532480"
  },
  {
    "text": "to build a new image and wait for the whole thing to deploy every time the rules change",
    "start": "532480",
    "end": "537760"
  },
  {
    "text": "so use a configmap instead that's what they're for you put the configuration files in a config map",
    "start": "537760",
    "end": "543200"
  },
  {
    "text": "the then you project that config map as a volume and mount it as etsy falco",
    "start": "543200",
    "end": "548399"
  },
  {
    "text": "and it turns out actually that the helm chart already does this if you modify the config map you can see",
    "start": "548399",
    "end": "554640"
  },
  {
    "text": "it in the falcon name space then it will change the contents of etsy falco where the config is stored",
    "start": "554640",
    "end": "560320"
  },
  {
    "text": "but the problem with the helm deployment is that there's nothing there to detect that and and restart falco or get",
    "start": "560320",
    "end": "566720"
  },
  {
    "text": "it to recognize that the rules have changed so the only way you can do this is with helm itself and",
    "start": "566720",
    "end": "572240"
  },
  {
    "text": "and that restarts everything um or you can send a hang-up signal uh the the",
    "start": "572240",
    "end": "579040"
  },
  {
    "text": "better alternative i think is you edit the docker file to run a script in each",
    "start": "579040",
    "end": "584320"
  },
  {
    "text": "falco container and then you tell that falco container to run i notify weight and",
    "start": "584320",
    "end": "592480"
  },
  {
    "text": "watch to see if anything in this directory changes then when you change the config map it changes the etsy falco directory",
    "start": "592480",
    "end": "599600"
  },
  {
    "text": "and automatically sends a kill sig hup to the falco process this hang up signal",
    "start": "599600",
    "end": "605839"
  },
  {
    "text": "will tell it to just reload the rules or the configuration without any downtime and an easy way",
    "start": "605839",
    "end": "613760"
  },
  {
    "text": "to do this is just to copy the upstream docker file and add the changes in yourself with a little bash script",
    "start": "613760",
    "end": "619519"
  },
  {
    "text": "and it's quite simple that way so another challenge that a lot of",
    "start": "619519",
    "end": "626959"
  },
  {
    "start": "623000",
    "end": "623000"
  },
  {
    "text": "people will probably run into is that falco sometimes alerts even on behavior that is expected",
    "start": "626959",
    "end": "634959"
  },
  {
    "text": "so the solution to this problem is to make sure that you're always adding events to an allow list now like",
    "start": "634959",
    "end": "641600"
  },
  {
    "text": "falco is great with its ability to add contextual information from kate's to teach it's what's normal um but you need",
    "start": "641600",
    "end": "649200"
  },
  {
    "text": "to make sure that you're staying on top of that now at one point in our own environment we ran into a problem where we had recently updated some rules",
    "start": "649200",
    "end": "656399"
  },
  {
    "text": "and upgraded falco to a newer version and suddenly we were seeing alarms going off telling us that every node",
    "start": "656399",
    "end": "662240"
  },
  {
    "text": "in one of our clusters was connecting to a bitcoin mining site so we got into a bit of a panic had someone",
    "start": "662240",
    "end": "667680"
  },
  {
    "text": "taken over the cluster um was one of our upstream dependencies compromised we looked at the alerts more closely and",
    "start": "667680",
    "end": "674320"
  },
  {
    "text": "saw that the traffic was coming from falco itself so now we're wondering is falco compromised well",
    "start": "674320",
    "end": "679920"
  },
  {
    "text": "no it turns out that the update had added a rule that detects traffic to coin mining websites and it knows",
    "start": "679920",
    "end": "686480"
  },
  {
    "text": "this by their domain name so when we upgraded falco it started up saw the rule that said tell me if you see",
    "start": "686480",
    "end": "692160"
  },
  {
    "text": "anything talking to the mining site and on each node falco dutifully performed a dns lookup for the mining",
    "start": "692160",
    "end": "697920"
  },
  {
    "text": "site so that it would know exactly where traffic should not go the rule that the falco team had created",
    "start": "697920",
    "end": "703680"
  },
  {
    "text": "wouldn't trigger itself but we actually had another rule that was sort of an extra defense against data exfiltration",
    "start": "703680",
    "end": "709440"
  },
  {
    "text": "and falco's own dns lookups were picked up as these unexpected outbound connections to the mining site",
    "start": "709440",
    "end": "715040"
  },
  {
    "text": "and our data exfiltration rules went crazy this is a bit of an extreme example because at first glance it",
    "start": "715040",
    "end": "720480"
  },
  {
    "text": "appeared to be a legitimate alert but even if it's obvious that an alert is false you still need to teach falco",
    "start": "720480",
    "end": "726320"
  },
  {
    "text": "what's expected so that it doesn't keep alerting now in this example problem this is one of the",
    "start": "726320",
    "end": "733040"
  },
  {
    "text": "first things you might see is that when falco launches it detects this privileged container launch",
    "start": "733040",
    "end": "739120"
  },
  {
    "text": "and so we need to teach it that this is okay and the solution to this this is just a",
    "start": "739120",
    "end": "744560"
  },
  {
    "text": "sample of the alert that you would see and then this is what you need to add",
    "start": "744560",
    "end": "749680"
  },
  {
    "text": "to the rules file in order to teach falco that this is okay so in our case there's an image repository",
    "start": "749680",
    "end": "756800"
  },
  {
    "text": "called falco security falco and the list itself had prefixed this with docker and so it",
    "start": "756800",
    "end": "764160"
  },
  {
    "text": "wasn't recognizing this as a falco container was an understanding that it's okay to start by doing this i mean you get rid",
    "start": "764160",
    "end": "770160"
  },
  {
    "text": "of all the noise that you would see when you first start falco it makes for a cleaner startup",
    "start": "770160",
    "end": "776399"
  },
  {
    "text": "so another problem that a lot of people have actually complained about and github issues lately and this is",
    "start": "776399",
    "end": "781600"
  },
  {
    "text": "actively being worked on but is this uh dropped syscall event and",
    "start": "781600",
    "end": "787279"
  },
  {
    "text": "a small number of syscall drops is sort of expected especially if like us you're running on gke",
    "start": "787279",
    "end": "793839"
  },
  {
    "text": "and so what this alert is showing here is that one syscall out of 8200 were dropped and",
    "start": "793839",
    "end": "800000"
  },
  {
    "text": "that it was due to a page fault and this this really isn't that big of a deal we're okay with this um but because the falco developers",
    "start": "800000",
    "end": "807440"
  },
  {
    "text": "didn't expect really any of these uh they created this so that it would appear",
    "start": "807440",
    "end": "812959"
  },
  {
    "text": "as a critical alert and this actually is set up by default",
    "start": "812959",
    "end": "818240"
  },
  {
    "text": "um to report this as a critical alert every 30 seconds on every node and and",
    "start": "818240",
    "end": "823920"
  },
  {
    "text": "so if this is happening all the time that's going to create so much fatigue so fast for no reason at all so",
    "start": "823920",
    "end": "829440"
  },
  {
    "text": "again a simple solution here you just go into the falco configuration and you change it from a critical alert",
    "start": "829440",
    "end": "835120"
  },
  {
    "text": "to just a log and then you tell it to do it less frequently i've shown an example here where",
    "start": "835120",
    "end": "840160"
  },
  {
    "text": "it alerts instead or logs sorry once every hour so these are a few pretty simple",
    "start": "840160",
    "end": "846320"
  },
  {
    "text": "straightforward things that you can do when you're starting out that's going to make the experience a lot better for you when you're trying to",
    "start": "846320",
    "end": "851920"
  },
  {
    "text": "use falco but it still doesn't give you a whole lot of usefulness so let's take a look at some of the things",
    "start": "851920",
    "end": "857920"
  },
  {
    "text": "that we can do and actually in order to actually use falco and detect some attacks so",
    "start": "857920",
    "end": "866079"
  },
  {
    "start": "865000",
    "end": "865000"
  },
  {
    "text": "if we've got for instance suspicious shell access in a container now if you have sensitive workloads hopefully you",
    "start": "866079",
    "end": "871440"
  },
  {
    "text": "aren't routinely keep control executing into them to make changes because they're supposed to be containerized after all",
    "start": "871440",
    "end": "877839"
  },
  {
    "text": "i'm going to demonstrate someone getting shell access and i'm just going to use cubecontrol for the example but",
    "start": "877839",
    "end": "883279"
  },
  {
    "text": "an attacker might also be able to do this by exploiting some other vulnerability in that container or perhaps by finding some less",
    "start": "883279",
    "end": "889279"
  },
  {
    "text": "important but also less secure workload and then pivoting to this one so if an",
    "start": "889279",
    "end": "894800"
  },
  {
    "text": "attacker gains access to your containers somehow then they're probably going to be",
    "start": "894800",
    "end": "900079"
  },
  {
    "text": "looking around trying to see what they can do and then they might need to download some more tools to issue new commands and i'll show you what that",
    "start": "900079",
    "end": "908160"
  },
  {
    "text": "might look like so to start i'm just going to do the demonstration on one of the falco pods",
    "start": "908160",
    "end": "914639"
  },
  {
    "text": "themselves we're switching to the falco namespace",
    "start": "914639",
    "end": "919920"
  },
  {
    "text": "and i'm going to look at which pods are running here and let's just pick the first one and",
    "start": "919920",
    "end": "928079"
  },
  {
    "text": "we're going to suppose in this you know contrived example that the attacker has somehow",
    "start": "928079",
    "end": "933920"
  },
  {
    "text": "compromised this falco pod so our defenses have failed but we can",
    "start": "933920",
    "end": "939120"
  },
  {
    "text": "still detect it so what might an attacker do when they get in here um they're probably going to look at",
    "start": "939120",
    "end": "944320"
  },
  {
    "text": "some things and then maybe they want to sniff traffic for some reason to see what information is going through here",
    "start": "944320",
    "end": "950720"
  },
  {
    "text": "or perhaps to do a little bit of surveillance network reconnaissance so as the attacker i might decide i want to",
    "start": "950720",
    "end": "956079"
  },
  {
    "text": "install tcp dump now for the sake of the example i think i've i've shown enough maybe i've had a",
    "start": "956079",
    "end": "961279"
  },
  {
    "text": "change of heart and i really don't want to fall so i'm just going to exit the container there",
    "start": "961279",
    "end": "966880"
  },
  {
    "text": "let's see what it actually looks like when falco detects this so we're going to take a look at falco",
    "start": "966880",
    "end": "973759"
  },
  {
    "text": "pod and see what it found so down here at the very bottom you can see",
    "start": "973759",
    "end": "980320"
  },
  {
    "text": "that it detected two things and these are really important rules to monitor a shell was spawned in a container with an",
    "start": "980320",
    "end": "985759"
  },
  {
    "text": "attached terminal this is important you want an alert when something like this happens because again it shouldn't be normal practice for",
    "start": "985759",
    "end": "992399"
  },
  {
    "text": "people to just cube control exec into these things but even more importantly is this package management process launched in a",
    "start": "992399",
    "end": "998480"
  },
  {
    "text": "container that should really already have all of its packages installed so when you see something like this you",
    "start": "998480",
    "end": "1004320"
  },
  {
    "text": "can see the command i have to get installed tcp dump by user root and as soon as a human looks at this they're going to know that",
    "start": "1004320",
    "end": "1010160"
  },
  {
    "text": "something strange is going on and they're going to be able to respond to that",
    "start": "1010160",
    "end": "1015759"
  },
  {
    "text": "so another potential use case that you might find valuable",
    "start": "1016399",
    "end": "1022480"
  },
  {
    "text": "is related to the instance metadata service and in 2018 i gave a talk about a report",
    "start": "1022480",
    "end": "1027918"
  },
  {
    "text": "that we received from a researcher who'd managed to exploit a vulnerable application that we were running in a",
    "start": "1027919",
    "end": "1033199"
  },
  {
    "text": "second tier environment at shopify and he used a combination of things to get into this metadata service",
    "start": "1033199",
    "end": "1039438"
  },
  {
    "text": "and ultimately got access to these cuban secrets that could have potentially led to a cluster takeover so i've mentioned",
    "start": "1039439",
    "end": "1046400"
  },
  {
    "text": "before that it's way more important to prevent access to these things than it is to monitor your career ending in real time",
    "start": "1046400",
    "end": "1053919"
  },
  {
    "text": "so in my demo cluster i've got workload identity enabled and what that does is puts a proxy out in front of the metadata service",
    "start": "1053919",
    "end": "1060400"
  },
  {
    "text": "and it hands out only the appropriate service account token and it blocks any inappropriate requests",
    "start": "1060400",
    "end": "1065840"
  },
  {
    "text": "so they can't go through so i'm going to pop into a normal container and i'm going to hit that metadata instance",
    "start": "1065840",
    "end": "1071760"
  },
  {
    "text": "and i'm going to see what it shows me so i've got",
    "start": "1071760",
    "end": "1081840"
  },
  {
    "text": "it's test normal and that just means that it's not privileged it's not host network it's uh sort of a",
    "start": "1084320",
    "end": "1089919"
  },
  {
    "text": "typical container workload that you might see and i'm going to keep control exec into",
    "start": "1089919",
    "end": "1095360"
  },
  {
    "text": "it and again an attacker would find another way of gaining access here um so then i'm going to try to hit",
    "start": "1095360",
    "end": "1102559"
  },
  {
    "text": "that metadata service and this actually came in to prevent",
    "start": "1102559",
    "end": "1109200"
  },
  {
    "text": "ssrf and so the metadata instance requires that we have this metadata",
    "start": "1109200",
    "end": "1114880"
  },
  {
    "text": "flavor header and that just means that it's going to allow it and the idea here is that it would be",
    "start": "1114880",
    "end": "1121840"
  },
  {
    "text": "more difficult to add a header to a request than to just point it somewhere",
    "start": "1121840",
    "end": "1126960"
  },
  {
    "text": "um and i've missed",
    "start": "1126960",
    "end": "1137840"
  },
  {
    "text": "yeah okay so um we can see we can only get the cluster location the cluster name",
    "start": "1147200",
    "end": "1152480"
  },
  {
    "text": "and the cluster id these are things that it's pretty normal to want to be able to access when you are",
    "start": "1152480",
    "end": "1158720"
  },
  {
    "text": "an application running in the cloud somewhere so this is actually pretty good it's good to see this and then",
    "start": "1158720",
    "end": "1164960"
  },
  {
    "text": "if we also want to i'm going to copy and paste this time so i don't make any",
    "start": "1164960",
    "end": "1170000"
  },
  {
    "text": "mistakes if we also want to take a look at the service account that you would be able to access",
    "start": "1170000",
    "end": "1175919"
  },
  {
    "text": "from inside this workload um we can do that as well so we're going to go to",
    "start": "1175919",
    "end": "1181200"
  },
  {
    "text": "the instance service accounts and see what's there and even if",
    "start": "1181200",
    "end": "1187919"
  },
  {
    "text": "you know you can see the name of it there but just to make sure that the default one is the one we're thinking of",
    "start": "1187919",
    "end": "1193120"
  },
  {
    "text": "we can see it here it's falco demo test app at chain falco demo so this is exactly what we",
    "start": "1193120",
    "end": "1199280"
  },
  {
    "text": "should see this is the application service account it has limited privileges it can't impersonate anyone else so",
    "start": "1199280",
    "end": "1206480"
  },
  {
    "text": "let's see what would happen on the other hand if we did this",
    "start": "1206480",
    "end": "1212400"
  },
  {
    "text": "so i'm going to leave that container for a minute and i'm going to come over here instead of",
    "start": "1213360",
    "end": "1219440"
  },
  {
    "text": "the test normal i'm going to go into a test host network and again",
    "start": "1219440",
    "end": "1225520"
  },
  {
    "text": "pull up my shell here",
    "start": "1225520",
    "end": "1235840"
  },
  {
    "text": "so we want to do the same thing and we want to see what attributes are",
    "start": "1237840",
    "end": "1243520"
  },
  {
    "text": "available again this one's on the host network so what this pod can do is it uses the same ip address as the",
    "start": "1243520",
    "end": "1250400"
  },
  {
    "text": "host itself and shares a network with it and this might be for instance an infrastructure workload",
    "start": "1250400",
    "end": "1257120"
  },
  {
    "text": "that needs to be able to interact with everything running on that particular node but if we do gain",
    "start": "1257120",
    "end": "1262960"
  },
  {
    "text": "access to this what we see here is that there's a lot more information available the reason is it's on the host zone network so it",
    "start": "1262960",
    "end": "1269200"
  },
  {
    "text": "doesn't go through the proxy it goes directly to the instance metadata service and what you can do with this kind of",
    "start": "1269200",
    "end": "1276480"
  },
  {
    "text": "access is exactly what the researcher did in the talk that i gave a couple years ago you get the cube end",
    "start": "1276480",
    "end": "1282799"
  },
  {
    "text": "and then you've got the cubelet cert and the cubelet key here you can take those and",
    "start": "1282799",
    "end": "1288400"
  },
  {
    "text": "then you can use them to impersonate the cubelet bootstrap user which you know if other protective measures",
    "start": "1288400",
    "end": "1295200"
  },
  {
    "text": "aren't followed could potentially lead to a cluster takeover so this is pretty bad we can also see",
    "start": "1295200",
    "end": "1300320"
  },
  {
    "text": "another problem here if we go to the instance",
    "start": "1300320",
    "end": "1306400"
  },
  {
    "text": "service account",
    "start": "1306400",
    "end": "1309200"
  },
  {
    "text": "plural this is not an application service account",
    "start": "1313919",
    "end": "1319520"
  },
  {
    "text": "this is actually the instance's own compute service account that the vm itself runs as so",
    "start": "1319520",
    "end": "1326080"
  },
  {
    "text": "if the attacker and this example me uh takes this we can get the token from",
    "start": "1326080",
    "end": "1331440"
  },
  {
    "text": "that and we can use that to impersonate this vm anywhere",
    "start": "1331440",
    "end": "1337440"
  },
  {
    "text": "on the cloud provider's infrastructure so",
    "start": "1337440",
    "end": "1344799"
  },
  {
    "text": "take that pull the token and there it is we could use that and impersonate the vm itself which",
    "start": "1345360",
    "end": "1351679"
  },
  {
    "text": "again is not desirable you want to be able to lock these things down but supposing we did have some sort",
    "start": "1351679",
    "end": "1357360"
  },
  {
    "text": "of misconfiguration and we missed this we can actually try to find out if our",
    "start": "1357360",
    "end": "1362400"
  },
  {
    "text": "monitoring would be able to detect this or not so let's see what our",
    "start": "1362400",
    "end": "1367440"
  },
  {
    "text": "falco pods detected",
    "start": "1367440",
    "end": "1370960"
  },
  {
    "text": "and you can see here that they did in fact detect it you can see outbound connection to cloud instance",
    "start": "1372480",
    "end": "1377679"
  },
  {
    "text": "metadata service and it shows the exact command that i used here trying to get the service account trying",
    "start": "1377679",
    "end": "1383600"
  },
  {
    "text": "to get the cube end and so if we had been running falco with this rule enabled in that second tier cluster in 2018",
    "start": "1383600",
    "end": "1390799"
  },
  {
    "text": "then we would have immediately gotten alert when that researcher was able to compromise this and it would have saved us 25 000 in",
    "start": "1390799",
    "end": "1396960"
  },
  {
    "text": "that case so uh what else can we do i'm actually",
    "start": "1396960",
    "end": "1402080"
  },
  {
    "text": "not going to demonstrate this one because it's going to look pretty much the same but what we can do",
    "start": "1402080",
    "end": "1409919"
  },
  {
    "text": "is you don't even need to get a host network pod if you can get a privileged pod then",
    "start": "1409919",
    "end": "1415919"
  },
  {
    "start": "1410000",
    "end": "1410000"
  },
  {
    "text": "you'll be able to do the exact same thing because even though just running it by default",
    "start": "1415919",
    "end": "1421200"
  },
  {
    "text": "it would still go through that proxy it would still hit workload identity if you have root privileges you can",
    "start": "1421200",
    "end": "1427679"
  },
  {
    "text": "change the rules the redirect to the proxy is done with the network fabric and so in our case we're running",
    "start": "1427679",
    "end": "1433279"
  },
  {
    "text": "iptables with calico so an iptables rule tells requests to",
    "start": "1433279",
    "end": "1438360"
  },
  {
    "text": "metadata.google.internal or 169254 as you saw it tells all those to go to the proxy instead but if you",
    "start": "1438360",
    "end": "1445600"
  },
  {
    "text": "have root privileges you just change the rules you don't go to the proxy you go direct to the instance metadata and you get the same pwnage that we saw",
    "start": "1445600",
    "end": "1451840"
  },
  {
    "text": "in the last example so there's a lot you can do and in order to be able to detect these",
    "start": "1451840",
    "end": "1459039"
  },
  {
    "start": "1459000",
    "end": "1459000"
  },
  {
    "text": "things it really fills in the gaps and so if you've missed anything then you want this ability to see what's happening",
    "start": "1459039",
    "end": "1465440"
  },
  {
    "text": "in your clusters so i'll go to another example now it's been a strange summer there are a lot of people outside who",
    "start": "1465440",
    "end": "1470960"
  },
  {
    "text": "are away from each other and there are some people who are inside away from each other and some of those people who are inside",
    "start": "1470960",
    "end": "1476720"
  },
  {
    "text": "found some exciting new vulnerabilities in kubernetes while they were at home now if you've done any old school",
    "start": "1476720",
    "end": "1481760"
  },
  {
    "text": "sysadmin work then you've probably configured disk usage monitors and like those are",
    "start": "1481760",
    "end": "1487919"
  },
  {
    "text": "usually designed to send you like an email when your disk usage hits 85 then page somebody when it gets to 95",
    "start": "1487919",
    "end": "1493919"
  },
  {
    "text": "percent and if it hits 100 nobody's responded then the server fails and it probably does some unpredictable",
    "start": "1493919",
    "end": "1499919"
  },
  {
    "text": "weird things as well so the cve uh 2020 855.7",
    "start": "1499919",
    "end": "1505760"
  },
  {
    "text": "it just fills up a file uh all the way to a hundred percent uh with junk and once that volume is",
    "start": "1505760",
    "end": "1513279"
  },
  {
    "text": "full that would be bad enough in a container's own file system but the problem is it does this with etsy",
    "start": "1513279",
    "end": "1519600"
  },
  {
    "text": "hosts which lives on the node not the container so it takes down the whole node not just",
    "start": "1519600",
    "end": "1525039"
  },
  {
    "text": "the pod and when this came out the cubelet's eviction manager forgot to consider it c hosts",
    "start": "1525039",
    "end": "1530240"
  },
  {
    "text": "so it would allow it to just keep filling up until the node failed and if you've got large nodes that could",
    "start": "1530240",
    "end": "1535760"
  },
  {
    "text": "run many different workloads it could mean this vulnerable application doesn't just go down itself",
    "start": "1535760",
    "end": "1541200"
  },
  {
    "text": "it brings down 100 larger more important ones so this is actually detectable by falco",
    "start": "1541200",
    "end": "1546880"
  },
  {
    "text": "just using the default rule set so i'm going to demonstrate that now so",
    "start": "1546880",
    "end": "1554960"
  },
  {
    "text": "let's go into uh for the sake of time we're just going to keep control exec",
    "start": "1554960",
    "end": "1560559"
  },
  {
    "text": "again this could be some other exploit that someone's used to gain access to this",
    "start": "1560559",
    "end": "1566159"
  },
  {
    "text": "pod they've compromised it in some way and you want to be able to contain that but thanks to the cv they can bring the",
    "start": "1566159",
    "end": "1572640"
  },
  {
    "text": "whole node down so i'm in this privileged pod and for the example i'm going to do is i'm going",
    "start": "1572640",
    "end": "1578400"
  },
  {
    "text": "to write one line here and i'm going to put it at the end of",
    "start": "1578400",
    "end": "1586640"
  },
  {
    "text": "etsy hosts so in in the real world if someone was taking",
    "start": "1586640",
    "end": "1591919"
  },
  {
    "text": "advantage of this they would be writing a huge amount not just this one line but this suffices for example",
    "start": "1591919",
    "end": "1597440"
  },
  {
    "text": "so let's take a look at what falco detected when we decided to do this so",
    "start": "1597440",
    "end": "1605279"
  },
  {
    "text": "again we'll take a look at our logs from our falco pods and look for",
    "start": "1605279",
    "end": "1612240"
  },
  {
    "text": "this rule triggering and let's just say for the last five minutes",
    "start": "1612240",
    "end": "1617600"
  },
  {
    "text": "there it is so at the exact time that i ran this command you can see error uh file below etsy opened for",
    "start": "1617600",
    "end": "1623039"
  },
  {
    "text": "writing this is just the default rule if you wanted you could make it more specific to detect the cve specifically",
    "start": "1623039",
    "end": "1628880"
  },
  {
    "text": "but it's almost better in my opinion that it just detects this out of the box you teach falco what should be able to",
    "start": "1628880",
    "end": "1634720"
  },
  {
    "text": "write below this directory and if other things are doing it then we know that's bad and if you're looking closely you might",
    "start": "1634720",
    "end": "1640559"
  },
  {
    "text": "notice that it didn't show the echo command that's just because echo is built in so the binary itself",
    "start": "1640559",
    "end": "1646799"
  },
  {
    "text": "was just shell but you can see which file it was that was modified and then you can use some other method",
    "start": "1646799",
    "end": "1653039"
  },
  {
    "text": "to decide how you want to this maybe go check the file size of etsy hosts and figure out if you've been",
    "start": "1653039",
    "end": "1659039"
  },
  {
    "text": "compromised or if you just need to allow list whatever it is that did this",
    "start": "1659039",
    "end": "1665200"
  },
  {
    "text": "so these are some examples that we've looked at of use cases there are hundreds more that you can",
    "start": "1665279",
    "end": "1671760"
  },
  {
    "text": "find in the falco default rule set um also in falco.org you can find out a",
    "start": "1671760",
    "end": "1677600"
  },
  {
    "text": "lot more but let's take a look at what i think is a more difficult problem and that is managing all of these alerts",
    "start": "1677600",
    "end": "1685039"
  },
  {
    "start": "1681000",
    "end": "1681000"
  },
  {
    "text": "so you need to make sure that you're handling your output it needs to be visible searchable aggregated and",
    "start": "1685039",
    "end": "1691120"
  },
  {
    "text": "annotated so that you can see what happened and when so you can see which of your alerts are being problematic",
    "start": "1691120",
    "end": "1697360"
  },
  {
    "text": "and which ones maybe uh are just fine the way they are and you also need to be able to add",
    "start": "1697360",
    "end": "1703279"
  },
  {
    "text": "annotations to these things that's really important because you don't want to spend time investigating something that someone",
    "start": "1703279",
    "end": "1708799"
  },
  {
    "text": "else on your team is already looking at and has maybe already resolved also by being able to see when this",
    "start": "1708799",
    "end": "1715360"
  },
  {
    "text": "alert has triggered before you can decide if maybe it's going off too often",
    "start": "1715360",
    "end": "1720640"
  },
  {
    "text": "and instead of alerting on some specifics maybe you can make the rule a little bit more broad",
    "start": "1720640",
    "end": "1726240"
  },
  {
    "text": "or go the other way make it more specific so teach falco what's normal in your environment so that you're not getting false alarms",
    "start": "1726240",
    "end": "1732240"
  },
  {
    "text": "all the time this is going to create alert fatigue if it's going off too much and a big part of handling this is",
    "start": "1732240",
    "end": "1739200"
  },
  {
    "text": "normalization so as soon as you see something and you know that it's a false alarm you need to promptly go in and allow",
    "start": "1739200",
    "end": "1746080"
  },
  {
    "text": "this this you should also make it as simple as possible maybe using pr templates or even automation so that when a person",
    "start": "1746080",
    "end": "1753039"
  },
  {
    "text": "identifies that this doesn't need to bother somebody this doesn't need to wake somebody up in",
    "start": "1753039",
    "end": "1758320"
  },
  {
    "text": "the morning they can very quickly and easily assign that combination of pod action container and other",
    "start": "1758320",
    "end": "1765840"
  },
  {
    "text": "information to the allow list now once you've got all of that handled out",
    "start": "1765840",
    "end": "1772320"
  },
  {
    "text": "if you do run into problems um you can reach out to falco on the kubernetes slack again one of the things",
    "start": "1772320",
    "end": "1778000"
  },
  {
    "text": "that we like most about falco is how responsive the team is if you're not sure if something's a bug",
    "start": "1778000",
    "end": "1783760"
  },
  {
    "text": "or you've just done something wrong then falco slack is the place to go they also have a weekly community call",
    "start": "1783760",
    "end": "1789360"
  },
  {
    "text": "if you know that it's a bug you can open a github issue or if you really want to contribute the best thing",
    "start": "1789360",
    "end": "1795360"
  },
  {
    "text": "you can do is open a pull request and give back so thanks so much for",
    "start": "1795360",
    "end": "1800720"
  },
  {
    "text": "watching my talk uh if you do want to get involved it's a cncf project there's so many ways you can help out",
    "start": "1800720",
    "end": "1806399"
  },
  {
    "text": "also you can learn more about me uh see what falco is all about uh jump into the",
    "start": "1806399",
    "end": "1811440"
  },
  {
    "text": "slack channel there or also um shopify is now digital by default and we're hiring you can also check out the",
    "start": "1811440",
    "end": "1816559"
  },
  {
    "text": "shopify engineering blog to see what else we're doing so thanks again",
    "start": "1816559",
    "end": "1823840"
  },
  {
    "text": "okay so i'll take any questions that you have now um and i see we've got a question",
    "start": "1829600",
    "end": "1834880"
  },
  {
    "text": "already so the question was is it possible to automatically take actions",
    "start": "1834880",
    "end": "1840799"
  },
  {
    "text": "and uh with falco by itself no but there are so many ways that you",
    "start": "1840799",
    "end": "1846880"
  },
  {
    "text": "can consume these streams that you can use something as trivial as a shell script that's monitoring a log",
    "start": "1846880",
    "end": "1853279"
  },
  {
    "text": "file to do this or i mean if you have an advanced sim then really the sky's the limit there are so",
    "start": "1853279",
    "end": "1859919"
  },
  {
    "text": "many options that you have for going back and changing things and like i mentioned with the config map being",
    "start": "1859919",
    "end": "1865679"
  },
  {
    "text": "able to very quickly deploy these rules changes is going to be critical to having any kind of automation involved at all",
    "start": "1865679",
    "end": "1873120"
  },
  {
    "text": "and in addition it's honoring and when do you automatically take action i think that's uh extremely case",
    "start": "1873120",
    "end": "1880080"
  },
  {
    "text": "by case i would want to be absolutely certain that the action was",
    "start": "1880080",
    "end": "1885360"
  },
  {
    "text": "the right one before i had automation doing something that could affect a very critical production environment",
    "start": "1885360",
    "end": "1892399"
  },
  {
    "text": "um but again like this is a tool that we're using for detection",
    "start": "1892399",
    "end": "1897919"
  },
  {
    "text": "right now if you want to get into prevention or taking automatic action then that's a bit more advanced and it's",
    "start": "1897919",
    "end": "1903679"
  },
  {
    "text": "something that falco will allow with its capabilities but it's not something that it does by itself",
    "start": "1903679",
    "end": "1910320"
  },
  {
    "text": "and as you mentioned yes because any false positive would disrupt your own service so that's that's why um you know you want to be",
    "start": "1910320",
    "end": "1916960"
  },
  {
    "text": "very careful with the sort of automation that you would implement here uh and the next question is is there a",
    "start": "1916960",
    "end": "1923120"
  },
  {
    "text": "free edition of falco or is this a premium feature so falco is completely",
    "start": "1923120",
    "end": "1928799"
  },
  {
    "text": "open source it was donated by systig to the cncf",
    "start": "1928799",
    "end": "1935840"
  },
  {
    "text": "that you can use and we're using open source falco",
    "start": "1936080",
    "end": "1943600"
  },
  {
    "text": "um uh another question here is do you use a ui for falco",
    "start": "1946840",
    "end": "1952640"
  },
  {
    "text": "at all and there is uh this enterprise paid version of",
    "start": "1952640",
    "end": "1959039"
  },
  {
    "text": "systick secure that you can use that does have like a really nice ui but we",
    "start": "1959039",
    "end": "1965519"
  },
  {
    "text": "don't use that so falco itself does not have a fancy web front end or",
    "start": "1965519",
    "end": "1972240"
  },
  {
    "text": "anything and i actually kind of like that because then i can just integrate it into the tools that i was using anyway",
    "start": "1972240",
    "end": "1978880"
  },
  {
    "text": "and if i want to check something i showed in all of these examples uh just looking at the standard output",
    "start": "1978880",
    "end": "1985360"
  },
  {
    "text": "of falco it's also um you know that's probably not how you're going to consume it",
    "start": "1985360",
    "end": "1990799"
  },
  {
    "text": "so we have fluent d ingesting everything from standard out on all of our docker",
    "start": "1990799",
    "end": "1996240"
  },
  {
    "text": "containers and dumping it into splunk so that's one way of consuming it",
    "start": "1996240",
    "end": "2001600"
  },
  {
    "text": "uh there's also falco sidekick which makes it really easy to send alerts to various destinations such as slack and",
    "start": "2001600",
    "end": "2009039"
  },
  {
    "text": "you might have seen because my uh the slides that were supposed to not show uh did show so there were a couple",
    "start": "2009039",
    "end": "2014720"
  },
  {
    "text": "times where you might have seen a slack alert pop up while i was demonstrating something and that is falco's sidekick sending to",
    "start": "2014720",
    "end": "2021919"
  },
  {
    "text": "slack the problem that i find with using slack for alerts is that it becomes extremely overwhelming if an",
    "start": "2021919",
    "end": "2027760"
  },
  {
    "text": "alert triggers 100 times i really only want to know once i want one alert that says",
    "start": "2027760",
    "end": "2033200"
  },
  {
    "text": "this triggered 100 times and there's no real way to aggregate consolidate those in slack so you can",
    "start": "2033200",
    "end": "2040159"
  },
  {
    "text": "just get flooded with a spammy alert and you might miss a much higher priority that came through",
    "start": "2040159",
    "end": "2045679"
  },
  {
    "text": "so that can be really useful in the beginning but as you try to wrangle all of these many alerts you are",
    "start": "2045679",
    "end": "2052320"
  },
  {
    "text": "probably going to want to have something a bit more sophisticated and a bit more searchable",
    "start": "2052320",
    "end": "2058560"
  },
  {
    "text": "i will absolutely post the link to the slides uh after i'm done here",
    "start": "2058560",
    "end": "2065040"
  },
  {
    "text": "uh oh this is a really good question uh could you walk through how you test the rules before",
    "start": "2065440",
    "end": "2070800"
  },
  {
    "text": "deploying them so we have um a shell script that does a very simple",
    "start": "2070800",
    "end": "2077200"
  },
  {
    "text": "verific verification check on this before it gets deployed and that's important because we don't",
    "start": "2077200",
    "end": "2082960"
  },
  {
    "text": "want to waste all this time for ci to try to deploy a whole new container only for it to fail at the last step",
    "start": "2082960",
    "end": "2089599"
  },
  {
    "text": "because of a syntax error but actually making sure that the rules",
    "start": "2089599",
    "end": "2094878"
  },
  {
    "text": "are working as intended we use a staging environment for so we can trigger some of these alerts on",
    "start": "2094879",
    "end": "2100640"
  },
  {
    "text": "command or by contriving some sort of action just like they did in the demo and if we're experimenting with a new",
    "start": "2100640",
    "end": "2106960"
  },
  {
    "text": "rule then we'll come up with how we want it to work we might spin it up in a sandbox and then",
    "start": "2106960",
    "end": "2112240"
  },
  {
    "text": "when we think we've got it the way we want it we'll run it in staging and test it to make sure that it works correctly",
    "start": "2112240",
    "end": "2119200"
  },
  {
    "text": "so hopefully you'll be able to see the link to the other talk that i'm giving a little bit later today with chris nova from systig",
    "start": "2125599",
    "end": "2132880"
  },
  {
    "text": "also about falco and a little bit more about the story behind why we chose it and if there's any other questions then",
    "start": "2132880",
    "end": "2139839"
  },
  {
    "text": "please feel free to ask them now",
    "start": "2139839",
    "end": "2145839"
  },
  {
    "text": "whoa",
    "start": "2170839",
    "end": "2173839"
  },
  {
    "text": "okay i don't see anything else thank you so much for watching take care",
    "start": "2184320",
    "end": "2190160"
  }
]