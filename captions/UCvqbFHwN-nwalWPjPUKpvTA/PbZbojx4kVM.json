[
  {
    "text": "all right everyone well let's get started so I'm Greg this is vanak we're from Google we're going to talk about",
    "start": "320",
    "end": "5640"
  },
  {
    "text": "how crypto miners have been exploring some uh Outback misconfigurations whoa that was not a",
    "start": "5640",
    "end": "12880"
  },
  {
    "text": "good slide transition try that",
    "start": "12880",
    "end": "19680"
  },
  {
    "text": "again so if you were paying attention to the press back in March March or April",
    "start": "19680",
    "end": "24800"
  },
  {
    "text": "beginning of this year you might have seen some headlines along these lines there these uh new attacks that are",
    "start": "24800",
    "end": "30480"
  },
  {
    "text": "leveraging kubernetes our back to back to our clusters we saw some of that happening on on gke and so that's what",
    "start": "30480",
    "end": "35640"
  },
  {
    "text": "we're going to talk about today we're going to talk about the root cause and which was actually a customer",
    "start": "35640",
    "end": "40879"
  },
  {
    "text": "misconfiguration of the cluster and we're going to walk through the whole attack do a demo of the attack and talk",
    "start": "40879",
    "end": "46920"
  },
  {
    "text": "about the prevention and detection options for the that attack I thought it might be interesting",
    "start": "46920",
    "end": "52879"
  },
  {
    "text": "just to cover a little bit about what's actually new here we've had kubernetes misconfigurations before we've had",
    "start": "52879",
    "end": "58800"
  },
  {
    "text": "Docker ports exposed to the internet we've had cubet ports on the internet we've had dashboard uh kubernetes",
    "start": "58800",
    "end": "65158"
  },
  {
    "text": "dashboards exposed to the internet and there's been scanners out there targeting all those things so that's not",
    "start": "65159",
    "end": "71600"
  },
  {
    "text": "really that new uh the other thing that isn't really that new is container delivered crypto miners that's a thing",
    "start": "71600",
    "end": "77400"
  },
  {
    "text": "that's been around for quite a while now uh you can find you know well packaged uh container cry crypto miners on Docker",
    "start": "77400",
    "end": "84560"
  },
  {
    "text": "Hub the the new and interesting thing here is is some kubernetes specific hiding techniques that the attack I used",
    "start": "84560",
    "end": "90960"
  },
  {
    "text": "and and the way they persisted so we'll we'll cover that in a fair amount of detail really quick sort of high level",
    "start": "90960",
    "end": "97439"
  },
  {
    "text": "overview of the attack the root cause here was as I said was this uh customer",
    "start": "97439",
    "end": "102520"
  },
  {
    "text": "aack misconfiguration that effectively kind of gave the whole internet cluster admin and you might be like I would",
    "start": "102520",
    "end": "108200"
  },
  {
    "text": "never do that uh but if you're just Googling for Access Control advice on",
    "start": "108200",
    "end": "113439"
  },
  {
    "text": "the internet and finding pages that give you bad advice there's definitely Pages out there that will tell you to do this",
    "start": "113439",
    "end": "118880"
  },
  {
    "text": "uh to create this binding so it's not perhaps as unusual as you would think so",
    "start": "118880",
    "end": "124320"
  },
  {
    "text": "the attacker was out there on the internet scanning for this kind of misconfiguration found found this one",
    "start": "124320",
    "end": "129599"
  },
  {
    "text": "they came in created a whole bunch of different access to give themselves control over the cluster and then they",
    "start": "129599",
    "end": "135560"
  },
  {
    "text": "also did a little bit of of covering their tracks as well too so we have",
    "start": "135560",
    "end": "141080"
  },
  {
    "text": "Google cloud signals that uh detected this crypto Miner activity and alloted the customer about it we also helped",
    "start": "141080",
    "end": "147120"
  },
  {
    "text": "them out with the investigation to figure out what was going on and once we'd done that we also looked at who",
    "start": "147120",
    "end": "152640"
  },
  {
    "text": "else had made this misconfiguration there were a handful of other customers that had sort of done something similar so we notified them and then uh we",
    "start": "152640",
    "end": "159599"
  },
  {
    "text": "actually prevent it by default now and we'll talk about that in more detail in just a",
    "start": "159599",
    "end": "164720"
  },
  {
    "text": "bit and I'm just going to hand it over to vak to give you a demo thanks Greg uh so yeah before we",
    "start": "164720",
    "end": "172640"
  },
  {
    "text": "jump into the attack demo I just wanted to cover a few kubernetes Concepts so",
    "start": "172640",
    "end": "178120"
  },
  {
    "text": "the first one is cluster admin a lot of you probably know about this role but uh cluster admin gives is a default role",
    "start": "178120",
    "end": "184560"
  },
  {
    "text": "that kubernetes creates and gives all permissions for all resources and if you start using it in cluster all bindings",
    "start": "184560",
    "end": "190040"
  },
  {
    "text": "then you give those permissions across every names space so essentially kind of giving Ruden cluster uh and we kind of",
    "start": "190040",
    "end": "197400"
  },
  {
    "text": "think of it as uh analogous to uh root on Linux where like hey",
    "start": "197400",
    "end": "202879"
  },
  {
    "text": "having these broad permissions is sometimes useful for some users to do maintenance or management but it has to",
    "start": "202879",
    "end": "208280"
  },
  {
    "text": "be wielded very carefully and so uh don't go delete it but uh also make sure",
    "start": "208280",
    "end": "213360"
  },
  {
    "text": "that you're not you're you're auditing who's able to have these permissions uh oop sorry and so uh the",
    "start": "213360",
    "end": "221879"
  },
  {
    "text": "other thing that we wanted to talk about was some system users and groups that might be helpful uh to know before we go",
    "start": "221879",
    "end": "227319"
  },
  {
    "text": "into the demo is and so here I've kind of got a diagram of uh kubernetes o and",
    "start": "227319",
    "end": "233159"
  },
  {
    "text": "so when a request comes in there's like a bunch of authenticators that can like uh that kubernetes has based on your",
    "start": "233159",
    "end": "239239"
  },
  {
    "text": "configuration and then that request can three things can happen the first thing is that it's a successful request so like basically",
    "start": "239239",
    "end": "246280"
  },
  {
    "text": "you have a token and that token is valid and then the authenticator says Yep this is valid and then your identity provider",
    "start": "246280",
    "end": "252879"
  },
  {
    "text": "based on the authenticator you have assigns the user and then the group is system authenticated um and so that kind",
    "start": "252879",
    "end": "259600"
  },
  {
    "text": "of indic uh indicates that hey this user was authenticated and then that information gets passed on to OD Z the",
    "start": "259600",
    "end": "266520"
  },
  {
    "text": "other uh flip side of this could be that you have invalid token and so there's just a failure and so you get a 401 uh",
    "start": "266520",
    "end": "273199"
  },
  {
    "text": "but the third case is that you don't have any Au information and in that case if you have Anonymous Au enabled what",
    "start": "273199",
    "end": "279759"
  },
  {
    "text": "happens is that this Anonymous authenticator is used and all it does is it sets the user to system Anonymous and",
    "start": "279759",
    "end": "286240"
  },
  {
    "text": "then sets the group to system unauthenticated which kind of indicate indicates that hey I don't know who this",
    "start": "286240",
    "end": "292520"
  },
  {
    "text": "person is and they did not authenticate but since the anonymous author is enabled uh that information will that",
    "start": "292520",
    "end": "298440"
  },
  {
    "text": "request won't be rejected and will will be will be passed down to uh",
    "start": "298440",
    "end": "303560"
  },
  {
    "text": "oddz uh okay okay so you must be thinking hey why does system Anonymous",
    "start": "303560",
    "end": "309360"
  },
  {
    "text": "exist and uh it's on by default in KS and KS creates this binding call system",
    "start": "309360",
    "end": "315520"
  },
  {
    "text": "uh public info viewer uh which lets you look at like health status and like cluster versions and stuff like that and",
    "start": "315520",
    "end": "321639"
  },
  {
    "text": "a lot of load balancers use this uh qadm also relies on this to do some like um",
    "start": "321639",
    "end": "328759"
  },
  {
    "text": "private key information exchange during like qadm cluster bootstrap um and then",
    "start": "328759",
    "end": "335080"
  },
  {
    "text": "uh finally uh if you watch the demo for uh by Sig o they were also using this",
    "start": "335080",
    "end": "340600"
  },
  {
    "text": "for uh checking the Healy so like yeah there's like valid scenarios where um",
    "start": "340600",
    "end": "346319"
  },
  {
    "text": "system Anonymous and system unauthenticated uh can be used and then a node on system authenticated uh like a",
    "start": "346319",
    "end": "354000"
  },
  {
    "text": "lot of you might be thinking oh this is this is fine like it's authenticated but based on your cluster setup set up or",
    "start": "354000",
    "end": "360039"
  },
  {
    "text": "your identity provider setup this might mean a lot of things it can mean like hey no one uh and require some",
    "start": "360039",
    "end": "365600"
  },
  {
    "text": "additional setup in your cloud provider or it could mean everyone at your company it could mean all uh everyone at",
    "start": "365600",
    "end": "370880"
  },
  {
    "text": "that identity provider that you're using and so in gke it actually means uh GK",
    "start": "370880",
    "end": "376280"
  },
  {
    "text": "kind of aligns with im's all authenticated user which means like anyone with a Google account but uh one",
    "start": "376280",
    "end": "383000"
  },
  {
    "text": "note is that this is uh authentication and not authorization so just because they can like access the cluster doesn't",
    "start": "383000",
    "end": "390039"
  },
  {
    "text": "mean they might uh doesn't mean they have like any valid permissions in it all right and now I'll move to the",
    "start": "390039",
    "end": "398800"
  },
  {
    "text": "demo where is",
    "start": "398800",
    "end": "402080"
  },
  {
    "text": "it cool uh so let's first look at the customer",
    "start": "406120",
    "end": "411400"
  },
  {
    "text": "misconfiguration here so the customer created a cluster Ro binding where they bound cluster admin the super powerful",
    "start": "411400",
    "end": "417720"
  },
  {
    "text": "role to uh system anonymous and when they create this such a binding they basically give anybody who can",
    "start": "417720",
    "end": "423479"
  },
  {
    "text": "access the qabs server unrestricted access to the uh cluster and so",
    "start": "423479",
    "end": "428639"
  },
  {
    "text": "attackers are usually scanning so like now we on the attacker machine attackers running this super complicated scanning",
    "start": "428639",
    "end": "434120"
  },
  {
    "text": "script and then uh they find a Target and so this is the first thing that the",
    "start": "434120",
    "end": "439319"
  },
  {
    "text": "attacker did in this cluster based on our investigation they created a cluster roll binding and they named it Cube",
    "start": "439319",
    "end": "444720"
  },
  {
    "text": "controller manager and uh if that name sounds familiar it's because it's a core component of so this was like one of the",
    "start": "444720",
    "end": "450479"
  },
  {
    "text": "attempts to kind of hide in the system no and then they bound the role cluster admin",
    "start": "450479",
    "end": "455919"
  },
  {
    "text": "to uh the default service account of cube system namespace so essentially any",
    "start": "455919",
    "end": "461240"
  },
  {
    "text": "workload that runs in Cube system namespace that does not specify a service account gets the default service account and",
    "start": "461240",
    "end": "467120"
  },
  {
    "text": "so uh if a workload does not specify the service account in this case they will run as admin so this was another way to",
    "start": "467120",
    "end": "474759"
  },
  {
    "text": "like kind of hide uh in uh hide the permissions that a workload might have have and so they created a workload",
    "start": "474759",
    "end": "482039"
  },
  {
    "text": "after that so they named it Cube controller they ran it in Cube system namespace uh this was a demon set and",
    "start": "482039",
    "end": "487840"
  },
  {
    "text": "they even attempted to like kind of hi make the image look legitimate by like",
    "start": "487840",
    "end": "493440"
  },
  {
    "text": "almost spelling like kubernetes IO um so so that was another attempt they made to",
    "start": "493440",
    "end": "499360"
  },
  {
    "text": "kind of hide um and then uh as you notice in the spec they don't have a service account specified so this is",
    "start": "499360",
    "end": "505319"
  },
  {
    "text": "running as the default service account in the cube system name space and so this workload is running as cluster",
    "start": "505319",
    "end": "511039"
  },
  {
    "text": "admin based on the biing that they made um and so once they have this they have",
    "start": "511039",
    "end": "516200"
  },
  {
    "text": "a foothold and this workload is running like um is is running the Crypt Miner",
    "start": "516200",
    "end": "521479"
  },
  {
    "text": "but they actually try to install persistence so this was happening from within the Damon set now so the first",
    "start": "521479",
    "end": "527120"
  },
  {
    "text": "thing they did was create a CSR uh which is a certific certificate signing request and it's a way to like send a",
    "start": "527120",
    "end": "534120"
  },
  {
    "text": "request to QB server to get like a certificate signed that you can later use to authenticate with API server and",
    "start": "534120",
    "end": "540480"
  },
  {
    "text": "so uh let's look at this like large Bas 64 uh blob here and",
    "start": "540480",
    "end": "546560"
  },
  {
    "text": "so all I'm doing here is like getting that extracting that from the yaml and then sending it uh basic c4d coding it",
    "start": "546560",
    "end": "553560"
  },
  {
    "text": "and sending it to uh open SSL and you can see the subject here is set to common name equals uh cluster admin so",
    "start": "553560",
    "end": "560200"
  },
  {
    "text": "common name uh CN here stands for common name and so anybody who presents that certificate to Q QB API server now uh",
    "start": "560200",
    "end": "568040"
  },
  {
    "text": "their user will be treated as cluster admin so they'll show up as user cluster admin so this is another attempt to hide",
    "start": "568040",
    "end": "574160"
  },
  {
    "text": "um so now um once this CSR is created somebody has to go approve it right uh",
    "start": "574160",
    "end": "580959"
  },
  {
    "text": "usually that's cluster admin but lucky for them they already have this permission and so they can approve their own",
    "start": "580959",
    "end": "586720"
  },
  {
    "text": "CSR and once a CSR gets approved there's controllers in kubernetes that will go and sign it and so let's check if the",
    "start": "586720",
    "end": "594519"
  },
  {
    "text": "CSR is signed uh yeah okay so yeah yeah you're",
    "start": "594519",
    "end": "599560"
  },
  {
    "text": "getting the CSR and as you can see it's issued so now they can extract the certificate and then what the attacker",
    "start": "599560",
    "end": "605399"
  },
  {
    "text": "did was uh they also deleted the CSR to kind of hide their tracks uh csrs which",
    "start": "605399",
    "end": "611000"
  },
  {
    "text": "are approved are also Auto deleted so",
    "start": "611000",
    "end": "616320"
  },
  {
    "text": "uh okay so now the attacker has a",
    "start": "617160",
    "end": "622360"
  },
  {
    "text": "identity right they have this user cluster admin that they've in uh they've got but that user has no bindings so the",
    "start": "622360",
    "end": "629399"
  },
  {
    "text": "attacker then created another binding uh and in this case they bound cluster admin to that user cluster admin and",
    "start": "629399",
    "end": "637399"
  },
  {
    "text": "giving it so now anybody who holds the certificate has like unrestricted access to the cluster so now the attacker back",
    "start": "637399",
    "end": "643519"
  },
  {
    "text": "on their machine and now they can like if you see what permissions they have based on the",
    "start": "643519",
    "end": "649680"
  },
  {
    "text": "certificate uh they have all the permissions so they're happy Crypt Miner they can they can access this cluster",
    "start": "649680",
    "end": "655920"
  },
  {
    "text": "even if that initial uh misconfiguration has been",
    "start": "655920",
    "end": "661160"
  },
  {
    "text": "removed okay now this one okay",
    "start": "661160",
    "end": "668360"
  },
  {
    "text": "cool uh so some further observations from this attack um the time to exploitation was 8 days which means that",
    "start": "668360",
    "end": "675320"
  },
  {
    "text": "from the time the customer created the misconfiguration to the first signs of malicious activity that we noticed was 8",
    "start": "675320",
    "end": "680920"
  },
  {
    "text": "Days uh what was really unique here was there trying to like blend into the system Noise by like creating",
    "start": "680920",
    "end": "687120"
  },
  {
    "text": "controllers that had like uh creating demon sets with had like Cube controller names in the cube Cube system name space",
    "start": "687120",
    "end": "693160"
  },
  {
    "text": "which is where customers usually run their uh customers are asked not to run their workloads because that's reserved for system workloads trying to use like",
    "start": "693160",
    "end": "699720"
  },
  {
    "text": "a semi legit looking image or even using the trick of like relying on default",
    "start": "699720",
    "end": "705279"
  },
  {
    "text": "service accounts where like if you don't carefully look at the yaml you might miss some information uh the payload",
    "start": "705279",
    "end": "711480"
  },
  {
    "text": "itself was XM rig so nothing special here uh the Damon set was actually",
    "start": "711480",
    "end": "716519"
  },
  {
    "text": "running some kind of script that was running CU curle commands uh this was based off the user agent and then",
    "start": "716519",
    "end": "723040"
  },
  {
    "text": "finally one thing that we noticed was that they actually pushed multiple uh",
    "start": "723040",
    "end": "728399"
  },
  {
    "text": "image updates to the Damon set and in the past we've usually seen people uploading uh updating their payload by",
    "start": "728399",
    "end": "734519"
  },
  {
    "text": "like doing it in payload but they actually relied on like kubernetes deployments and D sets to like update",
    "start": "734519",
    "end": "740560"
  },
  {
    "text": "their payload so that was uh very unique about this attack um and so with that",
    "start": "740560",
    "end": "745800"
  },
  {
    "text": "I've covered the attack portion of it and so I'm going to hand it to GRE to cover the prevention and",
    "start": "745800",
    "end": "752839"
  },
  {
    "text": "detection okay let's talk about prevention if we think about the misconfiguration surface here we sort of",
    "start": "754199",
    "end": "762040"
  },
  {
    "text": "demoed in detail that first one this system Anonymous misconfiguration you could do basically the same thing with",
    "start": "762040",
    "end": "767680"
  },
  {
    "text": "system unauthenticated so system Anonymous is a user system unauthenticated is a group but they're basically the same uh same group of",
    "start": "767680",
    "end": "774440"
  },
  {
    "text": "anyone on the internet kind of stuff and then there's also the system authenticator that we talked about which varies depending on your configuration",
    "start": "774440",
    "end": "781680"
  },
  {
    "text": "and so if we think about each of those there's like three different principles here there's two different places you canb them those uh those those",
    "start": "781680",
    "end": "788279"
  },
  {
    "text": "permissions at the cluster and the namespace level so that's six different combinations of like possible things you might need to worry about so we wrote",
    "start": "788279",
    "end": "795079"
  },
  {
    "text": "them all out there's a link here uh to the to the GitHub where all the demo code is you can see exactly like all",
    "start": "795079",
    "end": "800399"
  },
  {
    "text": "that yaml but when we're think about prevention we're going to try and think about this this whole group of uh of",
    "start": "800399",
    "end": "806079"
  },
  {
    "text": "misconfigurations that's possible big list of prevention options here",
    "start": "806079",
    "end": "811160"
  },
  {
    "text": "we're going to step through each one of these and and talk about them in some detail so the first kind of like most",
    "start": "811160",
    "end": "816600"
  },
  {
    "text": "obvious one was this was a internet exposed API server if that wasn't Network reachable then this wouldn't",
    "start": "816600",
    "end": "824120"
  },
  {
    "text": "wouldn't have been a problem or it would have only been a a smaller problem uh rather than having everyone on the",
    "start": "824120",
    "end": "829440"
  },
  {
    "text": "Internet it's everyone who can like actually get to the API server and so if you're thinking about limiting network access to the API server there's some",
    "start": "829440",
    "end": "835839"
  },
  {
    "text": "other advantages why that's that's occasionally a good thing to have too there's some denial of service",
    "start": "835839",
    "end": "840880"
  },
  {
    "text": "protection you you might get some protection from other authentication or authorization",
    "start": "840880",
    "end": "846000"
  },
  {
    "text": "misconfigurations or uh just vulnerabilities that are in the API Servo so there's a couple different ways",
    "start": "846000",
    "end": "851920"
  },
  {
    "text": "you can do that you can do both of them you can run into a private address space it's not ratable you can put a firewall in front of it on gke we let you do both",
    "start": "851920",
    "end": "858440"
  },
  {
    "text": "of those things uh and most other manage providers will do do the same second one let's talk about",
    "start": "858440",
    "end": "865720"
  },
  {
    "text": "Anonymous o so if we look at the what the C security Benchmark says about Anonymous authentication it says it's",
    "start": "865720",
    "end": "872160"
  },
  {
    "text": "like generally reasonable to allow Anonymous access if you're using a for health checks and Discovery and that was",
    "start": "872160",
    "end": "877440"
  },
  {
    "text": "those uh load balancer and those kind of uh use cases that we talked about before so this setting is true by",
    "start": "877440",
    "end": "884040"
  },
  {
    "text": "default Anonymous SCE that equals true you can set it to false if you have control of the API server Flags if",
    "start": "884040",
    "end": "889600"
  },
  {
    "text": "you're using a managed kubernetes provider you might not have that control you don't have it on gke and so I think",
    "start": "889600",
    "end": "895720"
  },
  {
    "text": "there's more we can do here to make this uh a safer default and so we' actually got that on the agenda for Sig and so if",
    "start": "895720",
    "end": "902320"
  },
  {
    "text": "you're looking at the slide and thinking hey I wish like that was better and we could sort of like restrict this access",
    "start": "902320",
    "end": "909279"
  },
  {
    "text": "without breaking stuff then we we think the same uh and we should go talk about it and uh figure out how we can make",
    "start": "909279",
    "end": "915399"
  },
  {
    "text": "this a safer default so moving on uh assuming that",
    "start": "915399",
    "end": "921279"
  },
  {
    "text": "Anonymous he is on you can make those some of those bindings and so the the thing we saw in this attack was binding",
    "start": "921279",
    "end": "927800"
  },
  {
    "text": "specifically cluster admin to to one of these one of these uh three groups or or",
    "start": "927800",
    "end": "932959"
  },
  {
    "text": "user and you can prevent that with admission it's pretty easy to do that with an emission controller there's a",
    "start": "932959",
    "end": "938120"
  },
  {
    "text": "bunch of them lifted listed here you could use gatekeeper cavon you could actually use the new beta feature of the",
    "start": "938120",
    "end": "943759"
  },
  {
    "text": "validating emission policy that's being built into kubernetes now that doesn't even require you to run uh a separate",
    "start": "943759",
    "end": "950120"
  },
  {
    "text": "sort of um validating admission and that would block these bindings from happening so we're going to uh demo that",
    "start": "950120",
    "end": "956160"
  },
  {
    "text": "from happening on gke we're just out right prevented is cuz there's really like no good reasons to be doing cluster",
    "start": "956160",
    "end": "962959"
  },
  {
    "text": "admin to these particular principles they're kind of dangerous so on on GK as a 128 this is just blocked out",
    "start": "962959",
    "end": "970480"
  },
  {
    "text": "right you could go a little further so that's just just cluster admin to just those those users and groups so we",
    "start": "970480",
    "end": "977360"
  },
  {
    "text": "looked into what people are doing with these users and groups and there's a few different things we already talked about",
    "start": "977360",
    "end": "983000"
  },
  {
    "text": "sort of load balances and like Health checking and that kind of stuff uh QB ADM uses it uh as the bootstrapping",
    "start": "983000",
    "end": "990000"
  },
  {
    "text": "there's a there's a a Rancher uses it as a limit very limited sort of like pre-or",
    "start": "990000",
    "end": "995199"
  },
  {
    "text": "API that they expose bitnami has a a similar thing where they're they're exposing sort of like a a very limited",
    "start": "995199",
    "end": "1003040"
  },
  {
    "text": "subset of functionality just to get the system up and running and the the so if",
    "start": "1003040",
    "end": "1008680"
  },
  {
    "text": "we block any binding there will be a few things that you might run into uh we also saw people using these for uh cicd",
    "start": "1008680",
    "end": "1015319"
  },
  {
    "text": "metrics to be able to give metrics to a dashboard without having that dashboard have to handle authentication and there",
    "start": "1015319",
    "end": "1021199"
  },
  {
    "text": "were a lot of pod security bindings to system authenticated at that's kind of",
    "start": "1021199",
    "end": "1027640"
  },
  {
    "text": "end of life now anyway so the last version that supports p security policies is now is now end of life so I",
    "start": "1027640",
    "end": "1034678"
  },
  {
    "text": "probably don't need to worry about that one too much I think generally this is like reasonably safe to do these are",
    "start": "1034679",
    "end": "1040038"
  },
  {
    "text": "these are smaller use cases that that may not actually affect you and so you can do this with admission we and we'll",
    "start": "1040039",
    "end": "1045880"
  },
  {
    "text": "do that in the demo as well uh so we talked about a few different uh",
    "start": "1045880",
    "end": "1053000"
  },
  {
    "text": "kind of combinations there cluster admin to these groups and then what about just like Bindings that involve cluster admin",
    "start": "1053000",
    "end": "1059400"
  },
  {
    "text": "generally that's a category that we might want to worry about and again the C Benchmark here is hey you should",
    "start": "1059400",
    "end": "1064840"
  },
  {
    "text": "probably be careful with Custer admin it's it's like the root of kubernetes uh so be careful who you give it to it is",
    "start": "1064840",
    "end": "1072520"
  },
  {
    "text": "fairly widely used uh by both by humans probably where it shouldn't be and also by uh system component components uh",
    "start": "1072520",
    "end": "1080520"
  },
  {
    "text": "so you you can uh sort of block this uh but I think I'd like tread fairly carefully so on GK we have a policy",
    "start": "1080520",
    "end": "1087880"
  },
  {
    "text": "controller like a managed uh policy you can enforce that will let the pieces of gke that need this work without breaking",
    "start": "1087880",
    "end": "1095000"
  },
  {
    "text": "gke uh and so I think if you're going to do this on a on a managed platform or a",
    "start": "1095000",
    "end": "1100080"
  },
  {
    "text": "platform where you don't have full control about it just you just need to sort of like carefully work through that um but but it's possible to add",
    "start": "1100080",
    "end": "1106240"
  },
  {
    "text": "restrictions here so let's demo some of that",
    "start": "1106240",
    "end": "1112480"
  },
  {
    "text": "stuff so the first thing we're going to do here is just try and grab the secrets out of the cluster we're completely",
    "start": "1118120",
    "end": "1124679"
  },
  {
    "text": "unauthenticated to this cluster uh we're coming at it from the internet and you can so we're not expecting this to work",
    "start": "1124679",
    "end": "1130720"
  },
  {
    "text": "so you can see here like this access is forid we're user system Anonymous and we don't have access to get to secrets in",
    "start": "1130720",
    "end": "1137559"
  },
  {
    "text": "this cluster and that's that's working as intended we get a four or",
    "start": "1137559",
    "end": "1142400"
  },
  {
    "text": "three so if we just look at the RO that we're going to add to this cluster it's the same one that V talked",
    "start": "1143799",
    "end": "1150240"
  },
  {
    "text": "about system monus to to Cluster admin and we put that on the",
    "start": "1150240",
    "end": "1156960"
  },
  {
    "text": "cluster and then we try the say same thing again and I'm just going to to avoid a giant blob of text on the screen",
    "start": "1161400",
    "end": "1168039"
  },
  {
    "text": "I'm just is going to like kind of summarize this with jQuery and so you can see now this works",
    "start": "1168039",
    "end": "1173640"
  },
  {
    "text": "so we broke the cluster we gave this authentication and now like anyone on the internet can come along and get our",
    "start": "1173640",
    "end": "1178679"
  },
  {
    "text": "secrets so that's bad and we don't want it to be like that so we'll delete that R binding",
    "start": "1178679",
    "end": "1185400"
  },
  {
    "text": "again and now we're going to install Gatekeepers so gatekeeper is an open source admission controller and it's",
    "start": "1188320",
    "end": "1194039"
  },
  {
    "text": "going to help prevent those bindings from getting created in the first place",
    "start": "1194039",
    "end": "1200240"
  },
  {
    "text": "so gatekeeper requires a constraint template and a constraint and so what we're doing here is just adding those",
    "start": "1203919",
    "end": "1209840"
  },
  {
    "text": "two things we're using the disallow Anonymous constraint template and constraint that's built in the gatekeeper to prevent those uh bindings",
    "start": "1209840",
    "end": "1217640"
  },
  {
    "text": "from being",
    "start": "1217640",
    "end": "1220000"
  },
  {
    "text": "created and we'll try making that binding again we get an error from gatekeeper saying hey that's not",
    "start": "1227159",
    "end": "1233320"
  },
  {
    "text": "allowed the unauthenticated user uh reference is not allowed in this role",
    "start": "1233320",
    "end": "1239480"
  },
  {
    "text": "binding so that's great that's how we want things to be I mentioned on gke we're blocking",
    "start": "1239480",
    "end": "1245960"
  },
  {
    "text": "this by default so on uh on GK 128 so we'll just just created a cluster there and we just try the same thing just",
    "start": "1245960",
    "end": "1251960"
  },
  {
    "text": "making The Binding there don't have to create any admission controllers or do any other configuration we're just going to block it out right so G GK Warden is",
    "start": "1251960",
    "end": "1259039"
  },
  {
    "text": "the is the built-in admission that GK has and it's saying yeah you can't bind",
    "start": "1259039",
    "end": "1264600"
  },
  {
    "text": "this uh cluster admin to system",
    "start": "1264600",
    "end": "1268320"
  },
  {
    "text": "Anonymous",
    "start": "1270320",
    "end": "1273320"
  },
  {
    "text": "okay so that's prevention let's talk about detection three different categories",
    "start": "1275559",
    "end": "1280679"
  },
  {
    "text": "here we can talk about detection detecting the misconfiguration so the thing we did wrong uh to start with we",
    "start": "1280679",
    "end": "1286960"
  },
  {
    "text": "can talk about the what the attacker did on the cluster the actual exploitation and then we can talk",
    "start": "1286960",
    "end": "1292520"
  },
  {
    "text": "about the payload itself and so we'll cover those three categories logs are really great here uh",
    "start": "1292520",
    "end": "1299120"
  },
  {
    "text": "so we can find a bunch of stuff in logs there's sort of three different things we could look for Here We can look for exactly that cluster admin to system",
    "start": "1299120",
    "end": "1305760"
  },
  {
    "text": "user or groups U uh thing happening and if that's happening that's really bad that's the thing we're preventing by",
    "start": "1305760",
    "end": "1311679"
  },
  {
    "text": "default on GK but if you're just going to take a detect only strategy like you definitely want to do this one um sort",
    "start": "1311679",
    "end": "1318240"
  },
  {
    "text": "of second there is the any bindings to those those uh big groups or or users um",
    "start": "1318240",
    "end": "1324240"
  },
  {
    "text": "they may or may not be bad we talked a c about a couple of use cases there where it it might it might be intended and",
    "start": "1324240",
    "end": "1330440"
  },
  {
    "text": "then the probably more noisy more used uh bindings to Cluster admin but you can",
    "start": "1330440",
    "end": "1335880"
  },
  {
    "text": "find all this stuff happening in the logs we've actually got a bunch of log queries in the uh in the slides where you can if you want to build this kind",
    "start": "1335880",
    "end": "1341679"
  },
  {
    "text": "of detection yourself you can go do it we also wrote a little script that will audit your existing Ro bindings and tell",
    "start": "1341679",
    "end": "1347279"
  },
  {
    "text": "you if you've got EX exactly this problem that you that there's Bindings that shouldn't be bound to these system",
    "start": "1347279",
    "end": "1352720"
  },
  {
    "text": "users and groups on gke this is done for you with event uh threat detection so it",
    "start": "1352720",
    "end": "1357960"
  },
  {
    "text": "goes and looks at the logs and notifies you about this stuff uh so we just going to show that",
    "start": "1357960",
    "end": "1364600"
  },
  {
    "text": "quickly so this is our security Command Center UI you can see we've got a couple of high priority findings here and this",
    "start": "1370640",
    "end": "1377279"
  },
  {
    "text": "critical one is is this privilege escalation so as we were beating up that cluster misconfiguration it like crazy",
    "start": "1377279",
    "end": "1382919"
  },
  {
    "text": "ETD was in the background looking at the logs it's found a bunch of other stuff here too some like lower severity findings but there's this uh critical",
    "start": "1382919",
    "end": "1390240"
  },
  {
    "text": "one here that is related to these our back bindings so we get a description we",
    "start": "1390240",
    "end": "1395960"
  },
  {
    "text": "get this uh uh the user that created it the time all the stuff that you'd sort",
    "start": "1395960",
    "end": "1401159"
  },
  {
    "text": "of expect",
    "start": "1401159",
    "end": "1403720"
  },
  {
    "text": "here and if we scroll right down we can we get a link to the actual log and so we",
    "start": "1406880",
    "end": "1413240"
  },
  {
    "text": "can go look at the details of the log itself and see kind of the full um all",
    "start": "1413240",
    "end": "1418760"
  },
  {
    "text": "the information that about what happened here and who did this where did they come from and uh what did they do so you",
    "start": "1418760",
    "end": "1426279"
  },
  {
    "text": "can see here cluster admin binding to system",
    "start": "1426279",
    "end": "1430320"
  },
  {
    "text": "Anonymous uh and as I said that's the that's the Google version but there's uh queries in here to uh help you write",
    "start": "1431679",
    "end": "1438760"
  },
  {
    "text": "your own similar detection uh okay so unused permissions",
    "start": "1438760",
    "end": "1444520"
  },
  {
    "text": "cluster admin isn't the only sort of privilege role out there you can just make your own and you can uh make your own mistakes with with your own cluster",
    "start": "1444520",
    "end": "1451360"
  },
  {
    "text": "admin so you could make a new role that's star star just like cluster admin and go bind it to a bunch of stuff that",
    "start": "1451360",
    "end": "1457440"
  },
  {
    "text": "shouldn't have that access and so this is sort of a more General least",
    "start": "1457440",
    "end": "1462480"
  },
  {
    "text": "privileged permissions problem that uh you need to think about and and potentially solve",
    "start": "1462480",
    "end": "1468360"
  },
  {
    "text": "in terms of Open Source tools there's not a whole lot in this area that will help you with this General case uh",
    "start": "1468360",
    "end": "1474960"
  },
  {
    "text": "there's this tool from uh Palo Alto called albac police that can tell you about some privileged roles but it won't",
    "start": "1474960",
    "end": "1480520"
  },
  {
    "text": "tell you if they're in use or like how over permissioned uh it is it it'll just let you know hey there's these things",
    "start": "1480520",
    "end": "1486679"
  },
  {
    "text": "that look like they might be over a permission but you can't tell if it's actually being used there are a bunch of",
    "start": "1486679",
    "end": "1492000"
  },
  {
    "text": "third party tools and a bunch of vendors on the cubec con floor that will be able to sell you uh tools that tell you",
    "start": "1492000",
    "end": "1497480"
  },
  {
    "text": "whether whether uh your permissions that are you've granted are being used and so",
    "start": "1497480",
    "end": "1503279"
  },
  {
    "text": "there's there there's ways to detect this today uh on gke we have IM recommender that covers this for IM and",
    "start": "1503279",
    "end": "1509520"
  },
  {
    "text": "so that if you do your bindings through IM then we'll be able to say hey there's like six out of 10 of these permissions",
    "start": "1509520",
    "end": "1515399"
  },
  {
    "text": "aren't actually being used regularly so you could probably slim down this rooll a bit and get it to something closer to",
    "start": "1515399",
    "end": "1521000"
  },
  {
    "text": "lease privilege and that's really the sort of recommendation we're looking for here so we're not covering our back just",
    "start": "1521000",
    "end": "1526679"
  },
  {
    "text": "yet and then the third category was uh oh so",
    "start": "1526679",
    "end": "1532399"
  },
  {
    "text": "sorry this that was the sort of detection of the misconfiguration and this is the second category the uh",
    "start": "1532399",
    "end": "1537520"
  },
  {
    "text": "exploitation detection so what did the attacker actually do on this cluster so we can look at system Anonymous activity",
    "start": "1537520",
    "end": "1543240"
  },
  {
    "text": "pretty simple here uh if that if the anonymous activity is actually authorized then that's probably probably",
    "start": "1543240",
    "end": "1549559"
  },
  {
    "text": "bad so it's probably a reasonable signal out this one we can look at that certificate creation work that the",
    "start": "1549559",
    "end": "1556559"
  },
  {
    "text": "attacker was doing there is a little bit of system use for the CSR API so",
    "start": "1556559",
    "end": "1562760"
  },
  {
    "text": "depending on sort of which provider you're using and what your own organization is doing with that",
    "start": "1562760",
    "end": "1568080"
  },
  {
    "text": "kubernetes API there might be more noise in this signal so here I filtered out just the stuff that gke does with uh",
    "start": "1568080",
    "end": "1574919"
  },
  {
    "text": "certificates and so it's uh you might have to do similar things so we we issue certificates to the cuet for using this",
    "start": "1574919",
    "end": "1581640"
  },
  {
    "text": "mechanism so you have to filter those out if you like don't want noise in this signal and then the third thing I think",
    "start": "1581640",
    "end": "1588840"
  },
  {
    "text": "pretty common uh sort of security problem in the industry is detecting crypto miners so you can find a lot of",
    "start": "1588840",
    "end": "1594360"
  },
  {
    "text": "vendors that will do this for you I'm sure uh but so typical techniques bad IPS bad domains the containers",
    "start": "1594360",
    "end": "1601279"
  },
  {
    "text": "themselves the binaries in those containers and on gke you can opt into uh having uh we've got a whole bunch of",
    "start": "1601279",
    "end": "1607679"
  },
  {
    "text": "crypto mining detection you can turn on we have event threat detection looking at logs and then if you actually go opt",
    "start": "1607679",
    "end": "1613840"
  },
  {
    "text": "in and ask us to do it we can scan the memory of the VM from out outside the hypervisor and that's what VM threat",
    "start": "1613840",
    "end": "1620480"
  },
  {
    "text": "detection does so we can actually find a a crypto Miner that's running in memory without having an agent and think I",
    "start": "1620480",
    "end": "1626600"
  },
  {
    "text": "think that's pretty cool capability so just summing up here uh we",
    "start": "1626600",
    "end": "1632799"
  },
  {
    "text": "had it's pretty like interesting kubernetes specific attack uh the in",
    "start": "1632799",
    "end": "1639039"
  },
  {
    "text": "terms of the prevention options we talked about limiting access to the API sare and then there's a bunch of stuff you can do at aack level to uh sort of",
    "start": "1639039",
    "end": "1647559"
  },
  {
    "text": "vent those bindings from happening or or at least detect ones uh if if you're not going to prevent on on the detection",
    "start": "1647559",
    "end": "1653679"
  },
  {
    "text": "side there's also a bunch of strategies here uh so you can audit what you've got so if say you put in detection today um",
    "start": "1653679",
    "end": "1660240"
  },
  {
    "text": "then that will kind of cover you from this point onwards but you want to sort of look at what you've already got as well too so uh there's definitely an",
    "start": "1660240",
    "end": "1666039"
  },
  {
    "text": "auditing uh part of this that you need to remember to do uh if you haven't got anything today and but so like overall",
    "start": "1666039",
    "end": "1673120"
  },
  {
    "text": "this was like pretty good news story really so yes there was a compromise yes a bad guy was operating in there but uh",
    "start": "1673120",
    "end": "1679440"
  },
  {
    "text": "we were able to detect it we were able to prevent it for like everyone else uh operating on gke and and then also share",
    "start": "1679440",
    "end": "1685679"
  },
  {
    "text": "that knowledge with the community and hopefully others will be able to build a similar prevention uh and protect",
    "start": "1685679",
    "end": "1691600"
  },
  {
    "text": "Everyone by default so whole bunch of links here all the demo code is uh up on",
    "start": "1691600",
    "end": "1696760"
  },
  {
    "text": "GitHub you can give us feedback through this uh through this QR code everything we link to here is is uh and that'll",
    "start": "1696760",
    "end": "1703279"
  },
  {
    "text": "also get you to the slides and uh at the back of the deck here we've got some more detection log queries if you want",
    "start": "1703279",
    "end": "1708960"
  },
  {
    "text": "to go build that detection yourself so happy to take any questions there's a couple of mics there's one here and one",
    "start": "1708960",
    "end": "1716000"
  },
  {
    "text": "there if folks have",
    "start": "1716000",
    "end": "1719320"
  },
  {
    "text": "questions um thanks for the talk really cool so for that affected customer did",
    "start": "1729840",
    "end": "1735000"
  },
  {
    "text": "you have to rotate their sht after everything was cleaned up yeah so we",
    "start": "1735000",
    "end": "1740559"
  },
  {
    "text": "gave them some advice about clean up uh so uh it's kind of when when you have a",
    "start": "1740559",
    "end": "1746039"
  },
  {
    "text": "compromise like this where attacker has cluster admin it's kind of Burn it Down Right like it there's there's not really",
    "start": "1746039",
    "end": "1751480"
  },
  {
    "text": "any coming back from that and so uh they were running their own incident response process but uh yes uh kind of burn the",
    "start": "1751480",
    "end": "1759720"
  },
  {
    "text": "whole cluster down is is basically basically be advised cuz they've had complete control in there and then you",
    "start": "1759720",
    "end": "1765480"
  },
  {
    "text": "also need to look at the trust relationships that that cluster had so were there secrets in there that give",
    "start": "1765480",
    "end": "1770559"
  },
  {
    "text": "them access to other systems and you think about sort of like those trust relationships as well yeah right that",
    "start": "1770559",
    "end": "1776120"
  },
  {
    "text": "makes sense so if you um even if you delete the cluster role if you still have that certificate then you",
    "start": "1776120",
    "end": "1782519"
  },
  {
    "text": "essentially always have a way in right uh yeah if you delete the cluster",
    "start": "1782519",
    "end": "1788279"
  },
  {
    "text": "binding that was the misconfigure the the cluster roll binding that was the misconfiguration then uh so yeah if you",
    "start": "1788279",
    "end": "1793679"
  },
  {
    "text": "just kind of were like oh I see Anonymous was doing stuff and I went and looked at what Anonymous did and",
    "start": "1793679",
    "end": "1799720"
  },
  {
    "text": "Anonymous created this rooll binding so oh I'm going to clean that up and get rid of that roll binding that's not",
    "start": "1799720",
    "end": "1804799"
  },
  {
    "text": "enough cuz they have created this like separate certificate that gives them access even if you cleaned up that",
    "start": "1804799",
    "end": "1810240"
  },
  {
    "text": "misconfiguration that was the entry point so yeah right I guess my question is um inside of that certificate it said",
    "start": "1810240",
    "end": "1816240"
  },
  {
    "text": "that the group was cluster admin but then even if you delete everything within your cluster that gives any",
    "start": "1816240",
    "end": "1821519"
  },
  {
    "text": "semantics to Cluster admin them having that s they could still essentially get any access they want so the certificate",
    "start": "1821519",
    "end": "1828440"
  },
  {
    "text": "is for the cluster so like the the ca that issued that is for the cluster so if that cluster is gone like that's the",
    "start": "1828440",
    "end": "1833640"
  },
  {
    "text": "end of the access yeah okay thanks",
    "start": "1833640",
    "end": "1838159"
  },
  {
    "text": "yeah thanks for the talk yeah do do you see rback",
    "start": "1840799",
    "end": "1847279"
  },
  {
    "text": "um do you see rback compromises a cross cluster in like GK or Google roles as",
    "start": "1847279",
    "end": "1853200"
  },
  {
    "text": "well and I'm curious how those two work together uh a cross cluster so",
    "start": "1853200",
    "end": "1861360"
  },
  {
    "text": "um I I guess I mean like Google has Federation with the service accounts are Federated with kubernetes and vice versa",
    "start": "1861360",
    "end": "1868200"
  },
  {
    "text": "do you see people hopping between a Google role and then a gke role and then back to",
    "start": "1868200",
    "end": "1874639"
  },
  {
    "text": "Google resources right yeah so when uh just generally when we think about ATT tax if someone is able to operate inside",
    "start": "1874639",
    "end": "1882639"
  },
  {
    "text": "a pod let's say that has a uh kubernetes service account attached then they have",
    "start": "1882639",
    "end": "1889279"
  },
  {
    "text": "sort of whatever privileges that service account has and then if you've used workload Identity or something similar",
    "start": "1889279",
    "end": "1895200"
  },
  {
    "text": "to like match that kuber service account up with a Google service account then they also have whatever privileges that",
    "start": "1895200",
    "end": "1901440"
  },
  {
    "text": "service account had so if it was like I don't know be able to read out of a certain bucket or publish to a pubsub or",
    "start": "1901440",
    "end": "1907080"
  },
  {
    "text": "whatever it is um so we haven't seen attackers do that and be sort of like workload identity aware and like go",
    "start": "1907080",
    "end": "1913880"
  },
  {
    "text": "after the Google resources but sort of once you have that compromise there there's no reason you wouldn't have that",
    "start": "1913880",
    "end": "1920039"
  },
  {
    "text": "access uh if you like that's what the area that you",
    "start": "1920039",
    "end": "1925399"
  },
  {
    "text": "compromised awesome talk um thanks I didn't even know about the system Anonymous stuff that's crazy uh do you",
    "start": "1925760",
    "end": "1932799"
  },
  {
    "text": "guys have a opinion on that being defaulted on I know you mentioned you were going to put it on the schedule for",
    "start": "1932799",
    "end": "1938600"
  },
  {
    "text": "sigo like what what are your thoughts yeah I I think like we've it's been a default for",
    "start": "1938600",
    "end": "1944679"
  },
  {
    "text": "a while now and it has a bunch of dependencies we talked about a few of them and so I think we need to tread fairly carefully there but it would be",
    "start": "1944679",
    "end": "1951519"
  },
  {
    "text": "great if there was a third option that was kind of uh allow the discovery role",
    "start": "1951519",
    "end": "1957799"
  },
  {
    "text": "to work but don't let anyone else bind anything else to this like so there's not a sharp edge there anymore I think",
    "start": "1957799",
    "end": "1962840"
  },
  {
    "text": "like that's that's the sort of thing we're going to go discuss in sigo and see if we can be like hey can we just leave Discovery there and not break the",
    "start": "1962840",
    "end": "1969639"
  },
  {
    "text": "stuff that's that is like quite quite a large amount of dependencies on um but also remove this shop Edge where where",
    "start": "1969639",
    "end": "1976519"
  },
  {
    "text": "people can go go uh configure stuffff buy stuff to this one they probably shouldn't awesome thank you",
    "start": "1976519",
    "end": "1984799"
  },
  {
    "text": "yeah yeah thank you for the talk it's great um wondering if you're going to",
    "start": "1988240",
    "end": "1993360"
  },
  {
    "text": "suggest other Cloud providers to adapt something similar uh in terms of disallowing it as the default yeah I uh",
    "start": "1993360",
    "end": "2001840"
  },
  {
    "text": "part of sharing here is is definitely like uh bringing awareness and uh we I",
    "start": "2001840",
    "end": "2007320"
  },
  {
    "text": "I've talked to the security leads of other Cloud providers pretty regularly I talked to them yesterday about this subject so we we'll see",
    "start": "2007320",
    "end": "2015360"
  },
  {
    "text": "yeah cool all right thanks a lot",
    "start": "2016919",
    "end": "2023519"
  }
]