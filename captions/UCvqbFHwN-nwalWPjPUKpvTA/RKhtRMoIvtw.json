[
  {
    "text": "uh welcome to my snake oil sales pitch I hope you're excited to have a chance to purchase an easy cure for all of your",
    "start": "120",
    "end": "5640"
  },
  {
    "text": "security woes if you call right now then I'll throw in an instant service mesh just Add Water",
    "start": "5640",
    "end": "11040"
  },
  {
    "text": "I want to know who here knows pretty much all of the kubernetes security settings that are on by default",
    "start": "11040",
    "end": "19380"
  },
  {
    "text": "and also which ones are needed by all of your applications and please keep your hand up if you've",
    "start": "19380",
    "end": "25740"
  },
  {
    "text": "never copied and pasted from one manifest to another uh never made a mistake in a yaml file",
    "start": "25740",
    "end": "31439"
  },
  {
    "text": "and nobody except you has access to Creator modify workloads",
    "start": "31439",
    "end": "36600"
  },
  {
    "text": "uh it's just me and I'm lying so I have nothing to teach you if you've still got your hand up but for everybody else",
    "start": "36600",
    "end": "41700"
  },
  {
    "text": "let's go look for some foot guns",
    "start": "41700",
    "end": "45379"
  },
  {
    "text": "um that's me also me I've been breaking systems since I was a kid and my",
    "start": "49800",
    "end": "55020"
  },
  {
    "text": "professional experience in Security started in the military doing intrusion detection systems I was a senior",
    "start": "55020",
    "end": "61260"
  },
  {
    "text": "consultant for an mssp for a while with these big government and financial sector clients and so it was a huge",
    "start": "61260",
    "end": "68520"
  },
  {
    "text": "relief in 2017 when I joined Shopify and got to work on this newfangled kubernetes thing that just about all of",
    "start": "68520",
    "end": "74280"
  },
  {
    "text": "my other clients would have been terrified of but kubernetes and I have both come a long way since then and I've",
    "start": "74280",
    "end": "80580"
  },
  {
    "text": "learned quite a bit in that time I'm really excited to be here with Danny as well Danny yep",
    "start": "80580",
    "end": "85680"
  },
  {
    "text": "thank you Shane um hi I'm Dennis Santos I work at Shopify with chain in the infrasek team",
    "start": "85680",
    "end": "91799"
  },
  {
    "text": "I joined back in 2020 and from the time I joined until now the security attack",
    "start": "91799",
    "end": "97500"
  },
  {
    "text": "landscape has changed considerably especially with a lot of companies opting for the remote work approach and",
    "start": "97500",
    "end": "104280"
  },
  {
    "text": "I've learned the thing to do about kubernetes over these years and how we can Harden our clusters to avoid",
    "start": "104280",
    "end": "109680"
  },
  {
    "text": "takeovers I hope by the end of this talk you'll walk away with some ideas on how to mitigate some risks",
    "start": "109680",
    "end": "116759"
  },
  {
    "text": "so here's the agenda we're going to start talking about why we should care about misconfiguration",
    "start": "116759",
    "end": "123200"
  },
  {
    "text": "and then we're going to talk about cubotit a tool that we use internally and the security principles implement",
    "start": "123200",
    "end": "130440"
  },
  {
    "text": "and then we're going to run a little demo where we're gonna show you the simple trick you're going to see if you",
    "start": "130440",
    "end": "135599"
  },
  {
    "text": "bought it in action and we're going to run some attack defense scenarios and then we're going to talk about how",
    "start": "135599",
    "end": "142080"
  },
  {
    "text": "exactly we used to bought it at Shopify and then we're going to finish by sharing some additional resources",
    "start": "142080",
    "end": "149599"
  },
  {
    "text": "well every year Red Hat releases a report which analyzes emerging Trends in",
    "start": "149700",
    "end": "155160"
  },
  {
    "text": "container kubernetes and Cloud native security it's called the state of kubernetes security report",
    "start": "155160",
    "end": "161400"
  },
  {
    "text": "the latest one was released last year it was a survey conducted with more than",
    "start": "161400",
    "end": "167040"
  },
  {
    "text": "300 engineering professionals and Security Professionals as well and um",
    "start": "167040",
    "end": "173400"
  },
  {
    "text": "pretty much the companies use this report to Benchmark themselves against the findings to determine how they can",
    "start": "173400",
    "end": "179099"
  },
  {
    "text": "accelerate their efforts to apply security controls and as you can see here in the key findings 53 percent of",
    "start": "179099",
    "end": "185940"
  },
  {
    "text": "respondents have witnessed incidents related to misconfiguration in kubernetes in the 12 months prior to",
    "start": "185940",
    "end": "191940"
  },
  {
    "text": "this study so this goes to show how common misconfiguration incidents are",
    "start": "191940",
    "end": "198239"
  },
  {
    "text": "it is a top concern they mentioned in this report that respondents worry about",
    "start": "198239",
    "end": "203700"
  },
  {
    "text": "it above all other security concerns and the reason being is configuration management is hard it poses difficult",
    "start": "203700",
    "end": "211140"
  },
  {
    "text": "challenges for the security practitioners because a lot of times the people responsible for configuring the",
    "start": "211140",
    "end": "216540"
  },
  {
    "text": "workloads may not understand all the security implications of the different settings Within kubernetes",
    "start": "216540",
    "end": "223400"
  },
  {
    "text": "in February 2021 Robert abma from hacker one mentioned customers paid out over",
    "start": "223400",
    "end": "229379"
  },
  {
    "text": "150 000 in Bounties in just a few weeks due to misconfiguration so not properly",
    "start": "229379",
    "end": "235799"
  },
  {
    "text": "setting your configurations can be very expensive but it can be even more so if it hits production",
    "start": "235799",
    "end": "242340"
  },
  {
    "text": "let's take a look at one example of possible misconfiguration attack back in September 2021 Palo Alto networks",
    "start": "242340",
    "end": "249599"
  },
  {
    "text": "research team unit 42 throughout intelligence identified the very first non-vulnerability that allowed the user",
    "start": "249599",
    "end": "256260"
  },
  {
    "text": "of a public cloud service to break out of their environment and execute code and environment belonging to other users",
    "start": "256260",
    "end": "262199"
  },
  {
    "text": "in the same public cloud service tldr cross account takeover",
    "start": "262199",
    "end": "267479"
  },
  {
    "text": "this vulnerability was coined Azure Escape because the cloud provider in question was Azure and scape because the",
    "start": "267479",
    "end": "274080"
  },
  {
    "text": "attack started from a container scape we don't mean to put Azure or Microsoft on the spot here we're bringing this",
    "start": "274080",
    "end": "280979"
  },
  {
    "text": "example to your attention just because it's really scary and interesting by the way luckily there's no record of this",
    "start": "280979",
    "end": "287880"
  },
  {
    "text": "attack being exploited in the wild at least not the window of and that's due to the fact that Microsoft Microsoft and",
    "start": "287880",
    "end": "294060"
  },
  {
    "text": "team acted super fast as soon as the researchers flagged it they packed their containers",
    "start": "294060",
    "end": "300440"
  },
  {
    "text": "so the researchers managed to escape the containers through unknown vulnerability",
    "start": "300440",
    "end": "305520"
  },
  {
    "text": "in bronzi rancy is the low level container runtime which uses native features of Linux to create and run",
    "start": "305520",
    "end": "312240"
  },
  {
    "text": "containers this CV was two years old already and it had not been patched and",
    "start": "312240",
    "end": "319199"
  },
  {
    "text": "there was a patch with that they were able to perform the researchers performed rce on customer containers and",
    "start": "319199",
    "end": "326520"
  },
  {
    "text": "the problem with this is that the attacker could gain complete control over service accessing all data and",
    "start": "326520",
    "end": "332100"
  },
  {
    "text": "secrets stored in the environment allowing for platform infrastructure views of all sorts",
    "start": "332100",
    "end": "339199"
  },
  {
    "text": "but for the CV to be exploited root access in containers was required because the Run C binary is owned by",
    "start": "339900",
    "end": "347160"
  },
  {
    "text": "root the question we can ask ourselves is what if folks had leveraged security",
    "start": "347160",
    "end": "353460"
  },
  {
    "text": "contacts in kubernetes configuration to avoid containers running is privileged or what if they had set run as user to",
    "start": "353460",
    "end": "360660"
  },
  {
    "text": "something other than user zero say user 1000. yeah",
    "start": "360660",
    "end": "367080"
  },
  {
    "text": "so I think it's clear that kubernetes is not inherently secure out of the box and",
    "start": "367080",
    "end": "372240"
  },
  {
    "text": "there's a pretty good reason for this kubernetes needs to be very flexible it needs to support a huge variety of",
    "start": "372240",
    "end": "377280"
  },
  {
    "text": "workloads and privileges that are necessary for one workload for example uh Damon said optimizing a system for a",
    "start": "377280",
    "end": "383940"
  },
  {
    "text": "database workload it could be inherently unsafe for those same privileges to be applied to another for instance a public",
    "start": "383940",
    "end": "390120"
  },
  {
    "text": "web server and we're not the first ones to point this out the flexibility means that it just can't",
    "start": "390120",
    "end": "395759"
  },
  {
    "text": "be secure for every different kind of workload but there are plethora of security tools that are available to us",
    "start": "395759",
    "end": "402300"
  },
  {
    "text": "that can make it secure we just have the challenge of knowing which ones to use and when",
    "start": "402300",
    "end": "408060"
  },
  {
    "text": "it's not easy to get this right every single time at scale and we discovered this uh pretty early on I think in 2017",
    "start": "408060",
    "end": "414660"
  },
  {
    "text": "we saw that we were going to need some automation for this we saw that we were going to need some rigorous controls around this and at the time we couldn't",
    "start": "414660",
    "end": "421020"
  },
  {
    "text": "find anything on the market we couldn't find anything open source so we made our own there are a lot of great tools now",
    "start": "421020",
    "end": "427740"
  },
  {
    "text": "this time I think we're starting around the same time but we've sort of found a niche with who bought it",
    "start": "427740",
    "end": "433199"
  },
  {
    "text": "so it's actually used by several companies and open source projects and I was really excited when we were",
    "start": "433199",
    "end": "438600"
  },
  {
    "text": "preparing for this talk because Danny pointed out that kubernetes goat which is an awesome tutorial for learning",
    "start": "438600",
    "end": "443880"
  },
  {
    "text": "Kate's security actually recommends this in one of its tutorials so let's take a look at what Kubota",
    "start": "443880",
    "end": "450780"
  },
  {
    "text": "could have done to help with Azure Escape that was a pretty scary vulnerability we're lucky that it probably wasn't exploited in the wild",
    "start": "450780",
    "end": "457080"
  },
  {
    "text": "but it wasn't necessary that even with that vulnerability bad things had to",
    "start": "457080",
    "end": "462360"
  },
  {
    "text": "happen if it had been released in the wild um this azer Escape vulnerability was",
    "start": "462360",
    "end": "467639"
  },
  {
    "text": "only exploitable in root containers with high Privileges and Kubota actually Flags both of those it also Flags",
    "start": "467639",
    "end": "474300"
  },
  {
    "text": "containers with capabilities that are not required by most workloads since those are more likely to be exploited",
    "start": "474300",
    "end": "480660"
  },
  {
    "text": "and when they are exploited the danger is much greater there's nothing that Kubota does though",
    "start": "480660",
    "end": "486360"
  },
  {
    "text": "that you couldn't apply yourself so it's actually a lot more important in my opinion that you understand and use the",
    "start": "486360",
    "end": "492120"
  },
  {
    "text": "principles that we put into creating kubotit uh doing this at scale though it requires automation it requires tooling",
    "start": "492120",
    "end": "498300"
  },
  {
    "text": "to help with that and Kubota is just one of a whole bunch of tools you can use for this you should have a comprehensive",
    "start": "498300",
    "end": "505139"
  },
  {
    "text": "security posture so I would never rely on just one tool but the Crux of this is",
    "start": "505139",
    "end": "510900"
  },
  {
    "text": "that pods shouldn't have more privileges than they need to do their job and so that's least privilege and then you",
    "start": "510900",
    "end": "517200"
  },
  {
    "text": "should have separation of Duties where the thing that does one job should not share a workload with a thing that does",
    "start": "517200",
    "end": "523440"
  },
  {
    "text": "another job because they have different requirements for different permissions and above all none of those workloads",
    "start": "523440",
    "end": "529200"
  },
  {
    "text": "should share resources with the hosts that they're running on itself or the infrastructure that's running those",
    "start": "529200",
    "end": "534839"
  },
  {
    "text": "workloads so it wouldn't make sense for my web server to have complete access to the kubernetes API but there are many",
    "start": "534839",
    "end": "540899"
  },
  {
    "text": "smaller examples of things that do not require the same privileges the that actually have them just because they're",
    "start": "540899",
    "end": "546240"
  },
  {
    "text": "baked into the same pod or the same container so this is the closest thing that we",
    "start": "546240",
    "end": "551940"
  },
  {
    "text": "have to one simple trick to solving your security problems the left is a little bit prettier it's more concise but it's",
    "start": "551940",
    "end": "558959"
  },
  {
    "text": "also a lot more insecure he uses a lot of defaults that are not necessarily the best for most workloads uh the right one",
    "start": "558959",
    "end": "566459"
  },
  {
    "text": "on the other hand mitigates a whole bunch of vulnerabilities as we'll see in a minute and so this is the closest thing we have to one simple trick it's",
    "start": "566459",
    "end": "573180"
  },
  {
    "text": "Kubota autofix and in manifest mode this is showing that it can automatically patch in Secure configurations",
    "start": "573180",
    "end": "580200"
  },
  {
    "text": "so we've set up a demo website to see how this might be exploited to be clear",
    "start": "580200",
    "end": "585300"
  },
  {
    "text": "this is not how Shopify works it just so happened that when I asked all of my friends what kind of website to build for my demo they all said e-commerce",
    "start": "585300",
    "end": "593040"
  },
  {
    "text": "so",
    "start": "593040",
    "end": "595639"
  },
  {
    "text": "hey that's what I see um",
    "start": "604160",
    "end": "610380"
  },
  {
    "text": "I'm going to show you this website so this is the cooperware",
    "start": "610380",
    "end": "617160"
  },
  {
    "text": "Emporium and if you're looking for custom attire for shipping and style then we have all of your kubernetes",
    "start": "617160",
    "end": "623279"
  },
  {
    "text": "attire needs and we can add images on here",
    "start": "623279",
    "end": "630240"
  },
  {
    "text": "and they will appear on the T-shirt just like magic and so you have the ability",
    "start": "630240",
    "end": "636120"
  },
  {
    "text": "to customize this and for the sake of this t-shirt store we're using image magic to render the image on the shirt",
    "start": "636120",
    "end": "642660"
  },
  {
    "text": "it's a really popular tool it's used all over the place and unfortunately with its flexibility it's also prone to",
    "start": "642660",
    "end": "648720"
  },
  {
    "text": "vulnerabilities one is called image tragic and basically you could embed a payload inside an image and it would",
    "start": "648720",
    "end": "655320"
  },
  {
    "text": "just execute the script that you put in there now we didn't want to use an old and secure version of image magic so",
    "start": "655320",
    "end": "660600"
  },
  {
    "text": "we've just skipped the pretense of trying to render an image and instead whenever we upload a script our",
    "start": "660600",
    "end": "667680"
  },
  {
    "text": "purposely vulnerable application is just going to execute whatever we put in there and and the point of this is we",
    "start": "667680",
    "end": "673500"
  },
  {
    "text": "want to focus on kubernetes security we know that your application eventually is going to have vulnerabilities and we",
    "start": "673500",
    "end": "679079"
  },
  {
    "text": "want to focus on what you can do to minimize the impact of those and prevent escalation or traversal when that happens",
    "start": "679079",
    "end": "685500"
  },
  {
    "text": "um so I'm running a proxy here because our application is so woefully insecure I didn't want to put it on the public",
    "start": "685500",
    "end": "690540"
  },
  {
    "text": "internet but other than that you can see we're just running it on localhost and I'm going to SSH into an attacker",
    "start": "690540",
    "end": "697140"
  },
  {
    "text": "machine uh because I think that it's probably more realistic if you're able",
    "start": "697140",
    "end": "703800"
  },
  {
    "text": "to catch a reverse shell than that the Pod itself would just be open to the",
    "start": "703800",
    "end": "708839"
  },
  {
    "text": "public internet so I'm gonna fire up this listener and we're going to listen for any incoming traffic on my attacker",
    "start": "708839",
    "end": "715560"
  },
  {
    "text": "Machine Head back here upload that script and what do you know we got a",
    "start": "715560",
    "end": "720779"
  },
  {
    "text": "connection so you can see from the host name here this isn't my attacker EU machine anymore we're now inside of a",
    "start": "720779",
    "end": "726959"
  },
  {
    "text": "pod and we can poke around and see what's in here and I can see like oh look there's the index.html file and I",
    "start": "726959",
    "end": "734160"
  },
  {
    "text": "can do sort of a trivial example of how we might mess with that as an attacker",
    "start": "734160",
    "end": "739920"
  },
  {
    "text": "so I'm just going to put that in there typing is harder in front of people and",
    "start": "739920",
    "end": "746399"
  },
  {
    "text": "I'm not that good at it to begin with and let's see what that did so we're going",
    "start": "746399",
    "end": "752100"
  },
  {
    "text": "to go back to our web page reload it and it's going to be really hard to sell t-shirts if this is all we can see on our webpage",
    "start": "752100",
    "end": "757640"
  },
  {
    "text": "fortunately for us there is a way to fix it Danny's going to show that oh my god I've been paged uh we cannot",
    "start": "757640",
    "end": "764519"
  },
  {
    "text": "sell t-shirts uh what happened they were able to write so likely they have some permissions that they shouldn't have",
    "start": "764519",
    "end": "771660"
  },
  {
    "text": "um luckily I'm going to use Kubota to automatically fix stuff um",
    "start": "771660",
    "end": "777420"
  },
  {
    "text": "so I'm going to run autofix on this",
    "start": "777420",
    "end": "784160"
  },
  {
    "text": "oops Yeah oh yeah if only I could type",
    "start": "791100",
    "end": "797459"
  },
  {
    "text": "demo okay and just to show you the difference",
    "start": "797459",
    "end": "804480"
  },
  {
    "text": "after applying the changes",
    "start": "804480",
    "end": "808459"
  },
  {
    "text": "except I forgot the L all right as you can see here after",
    "start": "813300",
    "end": "819779"
  },
  {
    "text": "running Kubota autofix read-only root file system set to true so he can no longer write he can only",
    "start": "819779",
    "end": "827279"
  },
  {
    "text": "read I'm gonna apply the changes and deploy",
    "start": "827279",
    "end": "832800"
  },
  {
    "text": "the fix oops",
    "start": "832800",
    "end": "837079"
  },
  {
    "text": "all right should be live okay so we'll go back to our page reload",
    "start": "841800",
    "end": "848279"
  },
  {
    "text": "that and it might take a second the Wi-Fi is not perfect",
    "start": "848279",
    "end": "854060"
  },
  {
    "text": "um well waiting for that to finish creating the Pod um the reason that this is not enabled",
    "start": "859860",
    "end": "865740"
  },
  {
    "text": "by default is lots of workloads do require the permission to change the root file system but ideally containers",
    "start": "865740",
    "end": "872100"
  },
  {
    "text": "should be as close to immutable on the root file system as they can be and then you can mount temperatures or other",
    "start": "872100",
    "end": "877380"
  },
  {
    "text": "things as necessary so that you can write to the places that should not have static content with these changes you",
    "start": "877380",
    "end": "882959"
  },
  {
    "text": "can see they're live now I'm just going to leave that old reverse shell start listening for new ones fire",
    "start": "882959",
    "end": "889740"
  },
  {
    "text": "off that malicious workload again and we've cut the reverse shell and I'll just go up here and I'm going to copy",
    "start": "889740",
    "end": "895680"
  },
  {
    "text": "and paste exactly the same command as before and this time it does absolutely nothing because we're on a read-only",
    "start": "895680",
    "end": "902160"
  },
  {
    "text": "file system so this is best practice if the contents of the root file system is static but it's not turned on by default",
    "start": "902160",
    "end": "908279"
  },
  {
    "text": "and just by turning that on with autofix you can completely mitigate that particular attack it's a bit trivial but",
    "start": "908279",
    "end": "914940"
  },
  {
    "text": "let's see another example so we're going to go ahead and apply another",
    "start": "914940",
    "end": "922440"
  },
  {
    "text": "vulnerability as you've probably guessed from the title this one's going to have host Network enabled that is not enabled",
    "start": "922440",
    "end": "928440"
  },
  {
    "text": "by default you shouldn't have it enabled for most of your workloads but I've seen this a number of times where people are",
    "start": "928440",
    "end": "933720"
  },
  {
    "text": "following a tutorial or they're following something that they saw in a manifest somewhere They're copying and pasting and they turn this on because",
    "start": "933720",
    "end": "940560"
  },
  {
    "text": "they want to hear from a number of different pods that are running on the same system maybe for observability",
    "start": "940560",
    "end": "945600"
  },
  {
    "text": "workloads or even other security functionality this is really problematic though because if you have host Network enabled",
    "start": "945600",
    "end": "952920"
  },
  {
    "text": "it's going to share the network with the host itself as you might guess that can bypass all Network policies so anything",
    "start": "952920",
    "end": "959519"
  },
  {
    "text": "that should isolate this workload from the other tenants in your cluster are going to be bypassed and unfortunately",
    "start": "959519",
    "end": "965519"
  },
  {
    "text": "it's also going to bypass about five years of improvements we've made in the",
    "start": "965519",
    "end": "971639"
  },
  {
    "text": "metadata service that runs on just about every cloud provider and you can see",
    "start": "971639",
    "end": "977579"
  },
  {
    "text": "here this is my host name now it's different from the shop web pod that I was in before because we're sharing the",
    "start": "977579",
    "end": "982920"
  },
  {
    "text": "network with the host itself and",
    "start": "982920",
    "end": "987360"
  },
  {
    "text": "if you're familiar with the instance metadata service this is the same address on every cloud provider that I'm",
    "start": "988560",
    "end": "994560"
  },
  {
    "text": "aware of and it's pretty useful it can tell you uh where in the world you are",
    "start": "994560",
    "end": "1001820"
  },
  {
    "text": "and it can give you tokens that you should have access to or in this case because we've got host Network enabled",
    "start": "1001820",
    "end": "1007759"
  },
  {
    "text": "tokens that we should not have access to so I'm going to go ahead and copy that and I'm going to exit my reverse shell",
    "start": "1007759",
    "end": "1015920"
  },
  {
    "text": "there save that token on my attacker machine and at this point I would as an attacker",
    "start": "1015920",
    "end": "1023300"
  },
  {
    "text": "have to kind of go through and enumerate my privileges it would take some time",
    "start": "1023300",
    "end": "1029120"
  },
  {
    "text": "but we're going to skip demonstrating the reconnaissance and I'll just go ahead and show you",
    "start": "1029120",
    "end": "1034780"
  },
  {
    "text": "what would happen once I found something that I had privileges to access so in this case I found that the account that",
    "start": "1034780",
    "end": "1042678"
  },
  {
    "text": "the host was running had access to a shop demo PCI keep out bucket which",
    "start": "1042679",
    "end": "1047720"
  },
  {
    "text": "sounds very interesting to me as an attacker I'm going to go ahead and look at what's in there using just that token",
    "start": "1047720",
    "end": "1053179"
  },
  {
    "text": "that I got if I can type that is",
    "start": "1053179",
    "end": "1058720"
  },
  {
    "text": "okay so this is going to be a really big problem in your next PCI audit and it's probably going to upset a lot of your",
    "start": "1066080",
    "end": "1071419"
  },
  {
    "text": "customers because of course here we've got all of the historical transactions that were processed by the shop now",
    "start": "1071419",
    "end": "1076520"
  },
  {
    "text": "there's no reason that some new person buying that needs to have access to all of this old data so it should be blocked",
    "start": "1076520",
    "end": "1083299"
  },
  {
    "text": "but in our case it wasn't and of course there's a fix that Danny can show you yeah",
    "start": "1083299",
    "end": "1088460"
  },
  {
    "text": "yeah once again Kubota autofix to the rescue um",
    "start": "1088460",
    "end": "1094900"
  },
  {
    "text": "this one was with",
    "start": "1096860",
    "end": "1101620"
  },
  {
    "text": "okay",
    "start": "1103520",
    "end": "1106059"
  },
  {
    "text": "okay I knew the difference",
    "start": "1114260",
    "end": "1119860"
  },
  {
    "text": "yeah right as you can see now like it's back to the default which is host Network set to false and then Shane's",
    "start": "1127820",
    "end": "1133760"
  },
  {
    "text": "gonna see if he can attack rdcs bucket this time unlikely I'm gonna apply the",
    "start": "1133760",
    "end": "1139880"
  },
  {
    "text": "changes okay and",
    "start": "1139880",
    "end": "1147140"
  },
  {
    "text": "okay some control",
    "start": "1147140",
    "end": "1150520"
  },
  {
    "text": "okay so this time it went a little bit quicker thankfully that container is up and running we can see it there and I'm",
    "start": "1152960",
    "end": "1160700"
  },
  {
    "text": "going to start listening again on my attacker machine for that incoming connection fire off",
    "start": "1160700",
    "end": "1166280"
  },
  {
    "text": "the malicious payload and of course we're back in this time you can see it just has the Pod ID and I'm going to run",
    "start": "1166280",
    "end": "1174320"
  },
  {
    "text": "the same curl command and what I expect is I am going to get a token but this time instead of the host's identity it's",
    "start": "1174320",
    "end": "1180260"
  },
  {
    "text": "just going to have the identity that it should have of the Pod itself so it'll have the Privileges necessary to sell",
    "start": "1180260",
    "end": "1185780"
  },
  {
    "text": "those t-shirts it won't have the permissions required to do well just about anything else so",
    "start": "1185780",
    "end": "1192980"
  },
  {
    "text": "there it is running the same command again with my new token file and of course we get a forbidden error because",
    "start": "1192980",
    "end": "1199520"
  },
  {
    "text": "this service account doesn't have those permissions so this is implementing the least privilege that we talked about and",
    "start": "1199520",
    "end": "1204860"
  },
  {
    "text": "finally we'll go on to our third demo so the first one was extremely trivial and",
    "start": "1204860",
    "end": "1211900"
  },
  {
    "text": "attempting to modify that would only really affect the very first replica or",
    "start": "1211900",
    "end": "1217220"
  },
  {
    "text": "the one that you had access to in that first pod if you were running dozens or even hundreds of replicas then there's a",
    "start": "1217220",
    "end": "1224720"
  },
  {
    "text": "very low chance that any given user would hit the one that you've attacked and also the defender could just replace",
    "start": "1224720",
    "end": "1230660"
  },
  {
    "text": "the whole deployment and it would replace all of your changes the second one we still don't have persistence we",
    "start": "1230660",
    "end": "1237020"
  },
  {
    "text": "didn't really change a whole lot but we were able to get a lot of historical data and exfiltrate that and",
    "start": "1237020",
    "end": "1242360"
  },
  {
    "text": "that would be extremely valuable but if we really want to take over the whole cluster then we can take advantage of",
    "start": "1242360",
    "end": "1247760"
  },
  {
    "text": "privileged containers now it might seem strange that you would run a container as root or enable all of these",
    "start": "1247760",
    "end": "1253820"
  },
  {
    "text": "additional privileges but even the the nginx container the nginx image on",
    "start": "1253820",
    "end": "1258860"
  },
  {
    "text": "Docker Hub by default runs as root for some reason and so if you're just",
    "start": "1258860",
    "end": "1263960"
  },
  {
    "text": "copying and pasting if you're following a tutorial even if you've done this a hundred times and you just didn't think",
    "start": "1263960",
    "end": "1269059"
  },
  {
    "text": "of it you just said from nginx you're going to get a root container for this example we've also got hostpid turned on",
    "start": "1269059",
    "end": "1275240"
  },
  {
    "text": "to make it go a little faster that shares the process space with the",
    "start": "1275240",
    "end": "1281299"
  },
  {
    "text": "host and is also problematic but even if we didn't have that it would just take about 10 more minutes to use a container",
    "start": "1281299",
    "end": "1288080"
  },
  {
    "text": "Escape that was demonstrated at black hat 19 and that would allow you to skip the the whole host PID part of it and do",
    "start": "1288080",
    "end": "1295220"
  },
  {
    "text": "exactly what we're going to do with just privileged so we can see our container is running",
    "start": "1295220",
    "end": "1301400"
  },
  {
    "text": "and I'm going to listen for that reverse shell again",
    "start": "1301400",
    "end": "1306820"
  },
  {
    "text": "fire off our malicious payload okay and I caught it and we're gonna see",
    "start": "1307220",
    "end": "1314659"
  },
  {
    "text": "right away this looks really different if we take a look at the file system this isn't the container file system anymore it's got everything the",
    "start": "1314659",
    "end": "1320480"
  },
  {
    "text": "container's got it's also got everything that the root file system has and we can",
    "start": "1320480",
    "end": "1326360"
  },
  {
    "text": "go ahead and use Anna Center this is going to change our namespace from the default",
    "start": "1326360",
    "end": "1332179"
  },
  {
    "text": "one that we were running in as the container and because we had that host PID and we are running as a",
    "start": "1332179",
    "end": "1340100"
  },
  {
    "text": "privileged root user we can escape the container completely and change into the",
    "start": "1340100",
    "end": "1345740"
  },
  {
    "text": "host's namespace uh and we can take a look at this so we're running as root here now that",
    "start": "1345740",
    "end": "1352640"
  },
  {
    "text": "we've done this we can do whatever we want so one thing you might want to do in this case is add your own SSH public",
    "start": "1352640",
    "end": "1358820"
  },
  {
    "text": "key to any authorized Keys files you find on the system so that you get complete persistence you can go back and",
    "start": "1358820",
    "end": "1364280"
  },
  {
    "text": "log in as any user you want that also makes it hard to attribute anything if Defenders do find that you've been",
    "start": "1364280",
    "end": "1370460"
  },
  {
    "text": "accessing it later then it might look like somebody else was doing what you've",
    "start": "1370460",
    "end": "1375559"
  },
  {
    "text": "actually been doing so we're going to enumerate the containers if this was a real Attack I would have to take some",
    "start": "1375559",
    "end": "1381980"
  },
  {
    "text": "time to look at the permissions of all of these in my case I know that this one here happens to you running Cube system",
    "start": "1381980",
    "end": "1388880"
  },
  {
    "text": "and it has a whole bunch of extra privileges and once we're in there you can see this",
    "start": "1388880",
    "end": "1394880"
  },
  {
    "text": "is the stuff that's inside that pod directory and I'm just going to look for the token and there it is so this is the",
    "start": "1394880",
    "end": "1402740"
  },
  {
    "text": "kubernetes service account token for this Cube system highly privileged workload and I'm going to",
    "start": "1402740",
    "end": "1409700"
  },
  {
    "text": "steal that token I'm going to save it in an environment",
    "start": "1409700",
    "end": "1415100"
  },
  {
    "text": "variable and I just notice my proxy stopped here so I'm going to start it again I'm going to save it in an environment variable because what better",
    "start": "1415100",
    "end": "1421580"
  },
  {
    "text": "place to store a secret than there and once I've got that",
    "start": "1421580",
    "end": "1429559"
  },
  {
    "text": "um I can copy I'm not going to try to type this",
    "start": "1429559",
    "end": "1435679"
  },
  {
    "text": "whole thing live it's about five lines if it was condensed but it would be very",
    "start": "1435679",
    "end": "1441380"
  },
  {
    "text": "painful for all of us I think if I tried to type this out live so this is a pretty simple curl command it's just",
    "start": "1441380",
    "end": "1447380"
  },
  {
    "text": "broken down to make it a little bit easier to see and you can see in here we're just replacing it with our own",
    "start": "1447380",
    "end": "1453799"
  },
  {
    "text": "image so I'm going to take that and run that command and this is some ugly Json",
    "start": "1453799",
    "end": "1459860"
  },
  {
    "text": "you don't need to read it all the important part is this part here the message replica set has successfully",
    "start": "1459860",
    "end": "1465620"
  },
  {
    "text": "progressed so that means whatever command we just ran has replaced the running image for every single replica",
    "start": "1465620",
    "end": "1471860"
  },
  {
    "text": "everywhere in the world with the one that we as the attacker have chosen and",
    "start": "1471860",
    "end": "1477440"
  },
  {
    "text": "of course we've completely defaced this webpage uh something terrible has happened phippy has turned to a life of",
    "start": "1477440",
    "end": "1482480"
  },
  {
    "text": "cyber crime because we failed to defend our cluster and it's going to be really hard to sell t-shirts now or maybe",
    "start": "1482480",
    "end": "1488960"
  },
  {
    "text": "easier but uh for the attacker so this has obviously been defaced but what a",
    "start": "1488960",
    "end": "1494120"
  },
  {
    "text": "real attacker would more likely do is they might run a coin Miner on your website using your compete resources to",
    "start": "1494120",
    "end": "1500120"
  },
  {
    "text": "generate money for them or they might go ahead and leave the appearance exactly the same but just put a credit card",
    "start": "1500120",
    "end": "1506600"
  },
  {
    "text": "skimmer on there that's going to send all of your customers credit card numbers to them or it might do something even more nefarious they've got complete",
    "start": "1506600",
    "end": "1513500"
  },
  {
    "text": "persistence because they are able to take advantage of that and it can easily be done if your workloads do not have",
    "start": "1513500",
    "end": "1520280"
  },
  {
    "text": "the lockdown permissions that we recommend and unfortunately by default so many of them don't so of course we're",
    "start": "1520280",
    "end": "1527000"
  },
  {
    "text": "going to see how you can defend against that all right you guessed it you bought it autofix",
    "start": "1527000",
    "end": "1533240"
  },
  {
    "text": "okay",
    "start": "1533240",
    "end": "1535778"
  },
  {
    "text": "to my defense this is not my computer so I'm having a hard time",
    "start": "1546559",
    "end": "1553720"
  },
  {
    "text": "ah what have I missed",
    "start": "1553940",
    "end": "1558460"
  },
  {
    "text": "okay I see I see that show yeah yeah all right",
    "start": "1559220",
    "end": "1566679"
  },
  {
    "text": "okay you see a bunch of things like it turned off allow privilege escalation uh",
    "start": "1576260",
    "end": "1581900"
  },
  {
    "text": "it also set privilege to false and run as no roots are true a bunch of goodies and change can no longer attack us",
    "start": "1581900",
    "end": "1590000"
  },
  {
    "text": "oh so have to support try again just deploy",
    "start": "1590000",
    "end": "1594520"
  },
  {
    "text": "and in the Pod security context having run is not root is important because it means that even if the docker image",
    "start": "1598640",
    "end": "1605059"
  },
  {
    "text": "itself has specified that it's going to run as a root user that will not be allowed",
    "start": "1605059",
    "end": "1610880"
  },
  {
    "text": "by kubernetes it will refuse to allow that to run unless you add run as user and change it to something other than",
    "start": "1610880",
    "end": "1616520"
  },
  {
    "text": "root if the doc fault doesn't specify it then it's trivial to just run as a specified user in the kubernetes yaml",
    "start": "1616520",
    "end": "1622460"
  },
  {
    "text": "it's really up to you where you apply it but it is of course important that you apply it there are very few workloads",
    "start": "1622460",
    "end": "1628220"
  },
  {
    "text": "that really need those privileges that really need to run as root on your systems and so it I would almost never",
    "start": "1628220",
    "end": "1636200"
  },
  {
    "text": "recommend doing this uh in cases where it's just assumed that there are root privileges there are usually ways of",
    "start": "1636200",
    "end": "1641840"
  },
  {
    "text": "getting around that I know Greg Castle is going to talk about some of the work that Google did to try to de-escalate",
    "start": "1641840",
    "end": "1646940"
  },
  {
    "text": "those privileges at Google and so I'm just going to go ahead and run the exact same NS enter command that",
    "start": "1646940",
    "end": "1653779"
  },
  {
    "text": "I ran before that allowed me to escape onto the host and of course I'm going to",
    "start": "1653779",
    "end": "1659360"
  },
  {
    "text": "get permission denied because I'm not root I don't have those privileges I can't do any of that anymore",
    "start": "1659360",
    "end": "1667778"
  },
  {
    "text": "all right so easy right I just run autofix and all our problems are gone right it's not",
    "start": "1675559",
    "end": "1684740"
  },
  {
    "text": "oh yeah but in fact we actually have bad news there's no simple trick it's not",
    "start": "1684740",
    "end": "1692120"
  },
  {
    "text": "the only thing you have to do in order to keep your a complex system like this secure that might be enough for this",
    "start": "1692120",
    "end": "1698600"
  },
  {
    "text": "simple architecture that we just demoed here but in the actual production clusters such as those of Shopify where",
    "start": "1698600",
    "end": "1704360"
  },
  {
    "text": "you have thousands of transactions per day there are many other aspects we need to address in order to make sure all",
    "start": "1704360",
    "end": "1710299"
  },
  {
    "text": "holes in the castle are properly patched and the walls are safe you can enhance your infrastructure",
    "start": "1710299",
    "end": "1716539"
  },
  {
    "text": "security at different stages of the software development life cycle for example at CI there's been a lot of talk",
    "start": "1716539",
    "end": "1722000"
  },
  {
    "text": "about shifting security left and how important it is to surface security concerns as early as possible for",
    "start": "1722000",
    "end": "1728480"
  },
  {
    "text": "example you can add a step in your build to run some tools to catch vulnerabilities in container images",
    "start": "1728480",
    "end": "1733520"
  },
  {
    "text": "early on image scanning tools provided by snake trivia and Encore can be really",
    "start": "1733520",
    "end": "1738559"
  },
  {
    "text": "helpful here even Cloud providers like Google Cloud offer container image scanning as a service we can also run",
    "start": "1738559",
    "end": "1744740"
  },
  {
    "text": "SAS tools static application security testing tools such as simgrap HCI they",
    "start": "1744740",
    "end": "1750260"
  },
  {
    "text": "will flag vulnerabilities in the code and we can also run tools like Cube audit at CI which will flag",
    "start": "1750260",
    "end": "1755960"
  },
  {
    "text": "vulnerabilities in your kubernetes infrastructure as code and that's exactly how we use it at Shopify in fact there are many layers in",
    "start": "1755960",
    "end": "1763279"
  },
  {
    "text": "the security on it I'd like to mention that we do have secure defaults we have custom templating system and we have",
    "start": "1763279",
    "end": "1769520"
  },
  {
    "text": "base kubernetes components with configuration that conforms to the best security practices however with trust",
    "start": "1769520",
    "end": "1775820"
  },
  {
    "text": "and empower the developers they can craft their pods and containers if they believe it is needed so they can modify",
    "start": "1775820",
    "end": "1782419"
  },
  {
    "text": "the base component and the VA from the happy path and that's when problems may come up",
    "start": "1782419",
    "end": "1789080"
  },
  {
    "text": "um we currently have over 17 000 a thousand repos at Shopify and how",
    "start": "1789080",
    "end": "1795080"
  },
  {
    "text": "do we make sure developers are continuously integrating changes and introduce and not introducing this",
    "start": "1795080",
    "end": "1800419"
  },
  {
    "text": "config in other words how do we make sure developers are aware of potential",
    "start": "1800419",
    "end": "1805520"
  },
  {
    "text": "risks when they push changes um we believe it's important to raise",
    "start": "1805520",
    "end": "1810679"
  },
  {
    "text": "security awareness if developers are for example running their containers as privilege or something nasty could",
    "start": "1810679",
    "end": "1816919"
  },
  {
    "text": "happen as Shane has just demonstrated here and maybe they don't really want to need this maybe they might just go for",
    "start": "1816919",
    "end": "1823039"
  },
  {
    "text": "something a little less permissive they're just not aware of it so we have an additional step where we",
    "start": "1823039",
    "end": "1830000"
  },
  {
    "text": "scan the kubernetes Manifest with keyboard we generate a serif report serif is the format the several code",
    "start": "1830000",
    "end": "1836120"
  },
  {
    "text": "scanning tools used to share results including GitHub code scanning so we generate the serif report we upload it",
    "start": "1836120",
    "end": "1843140"
  },
  {
    "text": "to GitHub and get we let GitHub code scanning do its magic if there are critical or high-risk vulnerabilities we",
    "start": "1843140",
    "end": "1849740"
  },
  {
    "text": "see a failing check at CI and then folks are able to read more about why it failed there's a link to documentation",
    "start": "1849740",
    "end": "1855440"
  },
  {
    "text": "more information on the offending configuration and why it poses a security risk",
    "start": "1855440",
    "end": "1860720"
  },
  {
    "text": "and with GitHub code scanning it's very easy for developers to opt out if the",
    "start": "1860720",
    "end": "1865880"
  },
  {
    "text": "alert is not applicable they can choose among one fix false positive or used in tests and even add a comment to justify",
    "start": "1865880",
    "end": "1872299"
  },
  {
    "text": "or provide feedback they can also use custom kubernetes Cub auditory configuration disabling some of the",
    "start": "1872299",
    "end": "1879260"
  },
  {
    "text": "checks or even if you bought it override labels so this is collaborative security rather than adversarial security with",
    "start": "1879260",
    "end": "1886100"
  },
  {
    "text": "this flow developers are security allies we also have monitoring place to observe",
    "start": "1886100",
    "end": "1891140"
  },
  {
    "text": "how often the alerts are dismissed and these metrics are relevant because it allows us to fine-tune our alerts and",
    "start": "1891140",
    "end": "1897380"
  },
  {
    "text": "avoid presenting false positives to devs and the reason this matters is because",
    "start": "1897380",
    "end": "1902600"
  },
  {
    "text": "alert fatigue reduces death's Trust and we want to avoid the boy who cried wolf Behavior this refers to the isop Fable",
    "start": "1902600",
    "end": "1910460"
  },
  {
    "text": "and every Fable has a moral and the moral of the story is if you're a liar even when you tell the truth no one will",
    "start": "1910460",
    "end": "1917720"
  },
  {
    "text": "believe you and we don't want developers to think we're Liars",
    "start": "1917720",
    "end": "1922299"
  },
  {
    "text": "so uh that's what we're doing at Shopify what else are we doing what can you do uh once your manifests are secure you",
    "start": "1923840",
    "end": "1930440"
  },
  {
    "text": "need to Branch out you need to look at how you can apply those same principles at build time deploy time run time all",
    "start": "1930440",
    "end": "1937700"
  },
  {
    "text": "the time uh build a trust model for your cluster these are some of the things you can start working on and then here is",
    "start": "1937700",
    "end": "1944360"
  },
  {
    "text": "how you can sort of map what you've done to what you need to do so this is just one example this is the miter attack",
    "start": "1944360",
    "end": "1950179"
  },
  {
    "text": "framework there are many like it Sans has some good recommendations for how you can do this and the idea is that you",
    "start": "1950179",
    "end": "1956899"
  },
  {
    "text": "want to figure out where you're succeeding already what you've neglected and where you're just not sure and by",
    "start": "1956899",
    "end": "1963140"
  },
  {
    "text": "using Maps like these you can figure that out and then prioritize the rest of the work that remains you can also look",
    "start": "1963140",
    "end": "1969200"
  },
  {
    "text": "at things like the oasp top 10 and that'll tell you what's actually being",
    "start": "1969200",
    "end": "1974480"
  },
  {
    "text": "exploited in the wild so that you can evaluate your own defenses and find out if you are going to successfully be able",
    "start": "1974480",
    "end": "1980480"
  },
  {
    "text": "to defend against those so we're going to make the repo available if you want to get this yourself we've added a whole",
    "start": "1980480",
    "end": "1985820"
  },
  {
    "text": "bunch of other resources there we've seen a few ways today that Kate's can go wrong and if we want Kate's to go right",
    "start": "1985820",
    "end": "1992299"
  },
  {
    "text": "then we need to apply these security principles to apply them effectively it's got to be automated it's got to be",
    "start": "1992299",
    "end": "1997640"
  },
  {
    "text": "flexible and it has to be collaborative there's no simple trick that's going to work all of the time in every situation",
    "start": "1997640",
    "end": "2004419"
  },
  {
    "text": "so please try to apply these principles in your own environment share your lessons with us or even share our",
    "start": "2004419",
    "end": "2009700"
  },
  {
    "text": "tooling PRS are always welcome and we hope that you'll help us to secure all of our software thank you",
    "start": "2009700",
    "end": "2017220"
  },
  {
    "text": "unfortunately we have time for questions one minute",
    "start": "2023980",
    "end": "2029759"
  },
  {
    "text": "uh can we get the mic turned on for questions",
    "start": "2036580",
    "end": "2040799"
  },
  {
    "text": "thank you for your awesome presentation with the attack response it was awesome thank you can you elaborate a little bit",
    "start": "2042940",
    "end": "2049060"
  },
  {
    "text": "more about how you can use Cube audit with either Helm uh operators maybe plug",
    "start": "2049060",
    "end": "2056378"
  },
  {
    "text": "in it code editors githubs things like this do you understand what I mean yeah of course so we don't specifically use",
    "start": "2056379",
    "end": "2063040"
  },
  {
    "text": "helmet Shopify but you can scan any kubernetes manifest either in a file or in the cluster using Kubota I mean you",
    "start": "2063040",
    "end": "2070000"
  },
  {
    "text": "can do the same with uh trivia and sneak have similar tools what we found is who bought it focuses on a small Niche",
    "start": "2070000",
    "end": "2076720"
  },
  {
    "text": "number of things that we thought were the most important and so I think it would be probably good to implement with",
    "start": "2076720",
    "end": "2082118"
  },
  {
    "text": "something like Helm not using the autofix mode but using it in cluster mode so once Helm has deployed it you",
    "start": "2082119",
    "end": "2088118"
  },
  {
    "text": "could use Kubota to monitor what it is that you're already running and that would be uh both a good tool for",
    "start": "2088119",
    "end": "2094000"
  },
  {
    "text": "identifying what's wrong as well as for seeing what you can do next because it's going to show you the things that Helm",
    "start": "2094000",
    "end": "2100060"
  },
  {
    "text": "did by default that are insecure and I can almost guarantee that with any workload you're going to find some",
    "start": "2100060",
    "end": "2105940"
  },
  {
    "text": "things that don't follow best practices and then in some sort of staging or test environment you could try turning those",
    "start": "2105940",
    "end": "2111640"
  },
  {
    "text": "off editing your Helm files and seeing if you can make security improvements that way and in many cases even contribute those back to helm if the if",
    "start": "2111640",
    "end": "2119440"
  },
  {
    "text": "the helm workload was over privileged to begin with it would be awesome to have like an",
    "start": "2119440",
    "end": "2126220"
  },
  {
    "text": "integration in like vs code or things like this to like linter or",
    "start": "2126220",
    "end": "2131320"
  },
  {
    "text": "real time when you're writing your manifest for example I agree we've had a hard time deciding on exactly the best",
    "start": "2131320",
    "end": "2138280"
  },
  {
    "text": "place to implement this so uh originally it was running just in cluster mode and then we found that actually we really",
    "start": "2138280",
    "end": "2144700"
  },
  {
    "text": "want to identify those problems before they're running in production so that's why at Shopify we're using it in GitHub",
    "start": "2144700",
    "end": "2151300"
  },
  {
    "text": "so as soon as you commit it you might have done something wrong but once you push that up to GitHub RCI is going to",
    "start": "2151300",
    "end": "2156880"
  },
  {
    "text": "scan it as soon as it reaches GitHub and that's going to run it on the file until you are the developer what may be",
    "start": "2156880",
    "end": "2163720"
  },
  {
    "text": "insecure about that and as we saw in the screenshot that Danny showed it then has the ability for the developer to tell us",
    "start": "2163720",
    "end": "2170140"
  },
  {
    "text": "like actually you got this completely wrong and we can see that feedback or if it's right they can just apply that and",
    "start": "2170140",
    "end": "2176560"
  },
  {
    "text": "move on with a more secure workload with very little work on their part",
    "start": "2176560",
    "end": "2182200"
  },
  {
    "text": "thanks hello",
    "start": "2182200",
    "end": "2186900"
  },
  {
    "text": "I don't know so the question is we use GitHub is",
    "start": "2189359",
    "end": "2194619"
  },
  {
    "text": "there an option to use gitlab as well and our own integration at Shopify only",
    "start": "2194619",
    "end": "2199660"
  },
  {
    "text": "uses GitHub but who bought it would work just fine with any provider you just need to add the step in your CI process",
    "start": "2199660",
    "end": "2205540"
  },
  {
    "text": "so that it will run the scan and then integrate with whoever your your code repository is so that you can apply the",
    "start": "2205540",
    "end": "2213520"
  },
  {
    "text": "interaction with the developers and that's where you would have to do the work yourself is is to have the ability",
    "start": "2213520",
    "end": "2218859"
  },
  {
    "text": "for the developers to give you that feedback or create the",
    "start": "2218859",
    "end": "2224200"
  },
  {
    "text": "automatic implementation of whatever change you've made you could do that if you wanted a completely vendor neutral",
    "start": "2224200",
    "end": "2230079"
  },
  {
    "text": "platform you could do it with Git pre-commit hooks if you really wanted to",
    "start": "2230079",
    "end": "2235380"
  },
  {
    "text": "I don't see any more questions thanks everyone thank you",
    "start": "2241060",
    "end": "2247800"
  }
]