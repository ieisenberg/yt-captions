[
  {
    "start": "0",
    "end": "55000"
  },
  {
    "text": "hello hello kubecon and welcome to the great kates.gcro.io vanity domain",
    "start": "560",
    "end": "7919"
  },
  {
    "text": "flip my name is steven augustus i am a senior open source engineer at vmware i'm also",
    "start": "7919",
    "end": "15040"
  },
  {
    "text": "one of the sig release co-chairs and kubernetes release manager so we're",
    "start": "15040",
    "end": "20240"
  },
  {
    "text": "generally responsible for maintaining all of the infrastructure as well as",
    "start": "20240",
    "end": "25760"
  },
  {
    "text": "pushing all of the kubernetes that you consume day to day and hello my name is linus harver i'm a",
    "start": "25760",
    "end": "33120"
  },
  {
    "text": "software engineer at google i am the main author of the container image promoter",
    "start": "33120",
    "end": "38960"
  },
  {
    "text": "which we'll be getting into uh more later today and i also contribute to the working",
    "start": "38960",
    "end": "44239"
  },
  {
    "text": "group for case infra we do lots of different things um the image from whatever was probably",
    "start": "44239",
    "end": "49680"
  },
  {
    "text": "one of the biggest uh projects that happened recently in this group",
    "start": "49680",
    "end": "55600"
  },
  {
    "start": "55000",
    "end": "81000"
  },
  {
    "text": "so a quick overview of what we're going to be covering today we're going to be talking about the historical context and the rationale",
    "start": "55600",
    "end": "62879"
  },
  {
    "text": "for uh image promotion and the vanity domain flip overall",
    "start": "62879",
    "end": "67920"
  },
  {
    "text": "um the infrastructure changes that are required so walking you through how the container",
    "start": "67920",
    "end": "74080"
  },
  {
    "text": "image promoter works as well as how it's tested and then finally some lessons that we learned along the way",
    "start": "74080",
    "end": "81438"
  },
  {
    "start": "81000",
    "end": "166000"
  },
  {
    "text": "so what is case.jcr.io is a vanity domain or a human friendly",
    "start": "82000",
    "end": "89920"
  },
  {
    "text": "name that essentially points to a folder uh within a google uh container registry",
    "start": "89920",
    "end": "96960"
  },
  {
    "text": "right so in our case in uh in the before times we're looking at uh gcr.io slash google",
    "start": "96960",
    "end": "104159"
  },
  {
    "text": "containers and today we're uh pointing to kate's uh dash artifacts prod right so the",
    "start": "104159",
    "end": "112560"
  },
  {
    "text": "so why why a vanity domain name right this allows us to uh make infrastructural changes behind",
    "start": "112560",
    "end": "119680"
  },
  {
    "text": "the scenes uh with minimal and hopefully no downtime to operations that depend on these images",
    "start": "119680",
    "end": "126399"
  },
  {
    "text": "um so that flip is something that hopefully you didn't notice it happened in july and uh and yeah that's what we're going",
    "start": "126399",
    "end": "133200"
  },
  {
    "text": "to talk all about today so here is a highly scientific uh",
    "start": "133200",
    "end": "140160"
  },
  {
    "text": "diagram of how we've done the container image flip uh if you imagine uh changing a dns",
    "start": "140160",
    "end": "147520"
  },
  {
    "text": "record you kind of stand up the old thing uh you know stand up the new thing and uh slowly uh move traffic away from",
    "start": "147520",
    "end": "155840"
  },
  {
    "text": "the old thing and you know that culminated in essentially a flip of the backing of the backing registries for that uh",
    "start": "155840",
    "end": "163280"
  },
  {
    "text": "that vanity domain name but is that it there was some infrastructure uh",
    "start": "163280",
    "end": "170239"
  },
  {
    "start": "166000",
    "end": "208000"
  },
  {
    "text": "improvements that we had to do that were absolutely not trivial um but",
    "start": "170239",
    "end": "175519"
  },
  {
    "text": "fortunately that gave us an opportunity to improve the uh the way we do production images",
    "start": "175519",
    "end": "181760"
  },
  {
    "text": "the way we test these images improve the overall security posture of the project",
    "start": "181760",
    "end": "188159"
  },
  {
    "text": "um including things like essentially business continuity right",
    "start": "188159",
    "end": "193360"
  },
  {
    "text": "knowing that we we can we can create backups we can recover from",
    "start": "193360",
    "end": "198480"
  },
  {
    "text": "those states and we're able to audit all of the changes that are happening in that system",
    "start": "198480",
    "end": "203519"
  },
  {
    "text": "so lioness is going to jump into more details on the historical context from the google side",
    "start": "203519",
    "end": "212239"
  },
  {
    "start": "208000",
    "end": "262000"
  },
  {
    "text": "thanks steven so yeah the entire process probably took around two years",
    "start": "212239",
    "end": "218879"
  },
  {
    "text": "so the initial idea of promoting images based on configuration",
    "start": "218879",
    "end": "225120"
  },
  {
    "text": "internally at google while we were still in the old pleasing the old google containers folder that happened",
    "start": "225120",
    "end": "233120"
  },
  {
    "text": "in 2018 and then between 2018 and 2020 we",
    "start": "233120",
    "end": "239439"
  },
  {
    "text": "basically did a rewrite of the internal promoter for the open source community it's",
    "start": "239439",
    "end": "245040"
  },
  {
    "text": "basically the same idea although it's implemented entirely differently",
    "start": "245040",
    "end": "250159"
  },
  {
    "text": "there's also auditing and backups involved which were separate infrastructural pieces",
    "start": "250159",
    "end": "255439"
  },
  {
    "text": "and these changes basically led up to the change for the flip which happened in july",
    "start": "255439",
    "end": "262320"
  },
  {
    "start": "262000",
    "end": "337000"
  },
  {
    "text": "so why did google need an internal promoter to begin with um",
    "start": "262720",
    "end": "268240"
  },
  {
    "text": "so stephen kind of hinted at the some of the reasons and it's basically to uh it was",
    "start": "268240",
    "end": "274639"
  },
  {
    "text": "basically to make it more secure for google to promote these things basically",
    "start": "274639",
    "end": "280400"
  },
  {
    "text": "to give you a little backstory um at the beginning before the internal promoter existed we",
    "start": "280400",
    "end": "286160"
  },
  {
    "text": "had roughly 60 70 googlers who had production access to",
    "start": "286160",
    "end": "291360"
  },
  {
    "text": "you know modify have right access to production and that was considered a you know not a",
    "start": "291360",
    "end": "297280"
  },
  {
    "text": "good security practice so there was basically a mandate saying we need to lock this down to you know",
    "start": "297280",
    "end": "303440"
  },
  {
    "text": "very few people meanwhile we don't want to you know make these 60 70 people uh like unable to",
    "start": "303440",
    "end": "309680"
  },
  {
    "text": "push images on their own uh let's do something about it so we created a",
    "start": "309680",
    "end": "314800"
  },
  {
    "text": "internal uh bot basically that does the pushing of images from",
    "start": "314800",
    "end": "320800"
  },
  {
    "text": "staging to production for the googlers so this also made it",
    "start": "320800",
    "end": "326800"
  },
  {
    "text": "um better in that there was less human error involved and also made the changes you know who",
    "start": "326800",
    "end": "333039"
  },
  {
    "text": "pushed which image that auditable in the history in the source code so this is just basically uh an",
    "start": "333039",
    "end": "341199"
  },
  {
    "text": "illustration of what was happening you know circa 2018 before the internal promoter so people were manually copying images",
    "start": "341199",
    "end": "348080"
  },
  {
    "text": "related to production that's cool containers at this time and obviously you know this",
    "start": "348080",
    "end": "354160"
  },
  {
    "start": "352000",
    "end": "362000"
  },
  {
    "text": "was not a great idea um i won't spend too much time this slide but basically we need",
    "start": "354160",
    "end": "359840"
  },
  {
    "text": "a change and this is what we did internally so we basically had a",
    "start": "359840",
    "end": "367280"
  },
  {
    "start": "362000",
    "end": "380000"
  },
  {
    "text": "production like uh ax a bot that had production access it held the keys to production so humans",
    "start": "367280",
    "end": "374560"
  },
  {
    "text": "weren't allowed to individually change make changes to production and",
    "start": "374560",
    "end": "380639"
  },
  {
    "text": "because of that it made things more secure the history of the changes to production",
    "start": "380639",
    "end": "386800"
  },
  {
    "text": "was auditable because all the changes to production were done in source code this is kind of like you know",
    "start": "386800",
    "end": "392479"
  },
  {
    "text": "configuration as code that concept and we also had pre-submit checks",
    "start": "392479",
    "end": "399280"
  },
  {
    "text": "for any new changes going in into the promoter manifest which is like the green box you see",
    "start": "399280",
    "end": "404560"
  },
  {
    "text": "there in the illustration just to guard against human error and to check that the images are okay and all",
    "start": "404560",
    "end": "410400"
  },
  {
    "text": "this other good stuff so fast forward like a year and it's",
    "start": "410400",
    "end": "415520"
  },
  {
    "start": "412000",
    "end": "532000"
  },
  {
    "text": "like you know late 2019 and basically we decided to do an open",
    "start": "415520",
    "end": "420560"
  },
  {
    "text": "source version of the promoter but you know we couldn't just uh you know copy paste the",
    "start": "420560",
    "end": "425599"
  },
  {
    "text": "code from from google's code base to you know github to donate it um",
    "start": "425599",
    "end": "432639"
  },
  {
    "text": "because i mean we could have technically but it wouldn't have worked anyway because",
    "start": "432639",
    "end": "437680"
  },
  {
    "text": "we needed performance guarantees that really weren't there because",
    "start": "437680",
    "end": "443360"
  },
  {
    "text": "yeah the scale is completely different if you recall the slide from earlier basically",
    "start": "443360",
    "end": "448560"
  },
  {
    "text": "it's an image copy but for the internal like google case uh we were talking about a handful",
    "start": "448560",
    "end": "454800"
  },
  {
    "text": "maybe a couple hundred images uh but for the open source case we're talking",
    "start": "454800",
    "end": "459840"
  },
  {
    "text": "about like everything and also we're at the open source version tracks",
    "start": "459840",
    "end": "465360"
  },
  {
    "text": "a lot more um images roughly 30 000 unique ones to be exact um",
    "start": "465360",
    "end": "472080"
  },
  {
    "text": "so the manifest is like you know basically that much bigger there's a lot",
    "start": "472080",
    "end": "477680"
  },
  {
    "text": "more stakes or intent that is tracked so to do that we have to be ready to go",
    "start": "477680",
    "end": "484240"
  },
  {
    "text": "um it takes roughly 30 seconds or a little bit less than that to read all of these images from",
    "start": "484240",
    "end": "492639"
  },
  {
    "text": "uh gtr which is their production repository and to kind of reference that against the manifest to do",
    "start": "492639",
    "end": "498160"
  },
  {
    "text": "the promotion so that's pretty cool um go lay makes that a little a bit easier because we can use",
    "start": "498160",
    "end": "504080"
  },
  {
    "text": "concurrency you know it's very easy to do there in that language um i'll be also talking a little bit",
    "start": "504080",
    "end": "510400"
  },
  {
    "text": "about the edge data structure which we use for um basically encapsulating the idea of promotions to",
    "start": "510400",
    "end": "517120"
  },
  {
    "text": "make it a little bit more easier to reason about because when you're talking about 90 000 like",
    "start": "517120",
    "end": "522159"
  },
  {
    "text": "edges or promotion basically uh you do you need to simplify",
    "start": "522159",
    "end": "527600"
  },
  {
    "text": "the problem a little bit to basically make debugging easier",
    "start": "527600",
    "end": "532880"
  },
  {
    "start": "532000",
    "end": "607000"
  },
  {
    "text": "so as for the performance optimizations um these are the four steps basically",
    "start": "532880",
    "end": "540399"
  },
  {
    "text": "um so the promoter when it first starts up it reads in uh images in the program",
    "start": "540399",
    "end": "545839"
  },
  {
    "text": "manifest that's the you know stuff checked into github by humans currently um it just describes the",
    "start": "545839",
    "end": "553040"
  },
  {
    "text": "intent of what we need to promote that's the blue circle there it then reads all the",
    "start": "553040",
    "end": "559040"
  },
  {
    "text": "stuff already in production that's the stuff that takes 90 or 30 seconds roughly and then it does a",
    "start": "559040",
    "end": "565440"
  },
  {
    "text": "delta so it removes all the stuff that's already been promoted that's what's in purple and then we only promote what's",
    "start": "565440",
    "end": "571519"
  },
  {
    "text": "left that's the blue circle for the eagle-eyed uh the people in the audience the red",
    "start": "571519",
    "end": "580080"
  },
  {
    "text": "stuff here you know you might ask what's what's that you know what do we do there those are images that are not tracked",
    "start": "580080",
    "end": "586560"
  },
  {
    "text": "yet basically in the manifests that used to be a pretty big chunk but",
    "start": "586560",
    "end": "592399"
  },
  {
    "text": "we actually added a what's called like a legacy or a backfill manifest to track all those as well so",
    "start": "592399",
    "end": "599279"
  },
  {
    "text": "in actuality this red circle or this red part is pretty much non-existent today",
    "start": "599279",
    "end": "606240"
  },
  {
    "start": "607000",
    "end": "643000"
  },
  {
    "text": "so the edges so this is like a pretty simple concept uh basically we",
    "start": "607920",
    "end": "615040"
  },
  {
    "text": "treat each edge as like a timeless encapsulation of an image copy",
    "start": "615040",
    "end": "622079"
  },
  {
    "text": "so the edge has three parts we have the staging name the production name",
    "start": "622079",
    "end": "628079"
  },
  {
    "text": "which are vertices and then we have like a connection between the vertices and that connection is populated by the",
    "start": "628079",
    "end": "634640"
  },
  {
    "text": "data that's it sounds pretty simple but it it does",
    "start": "634640",
    "end": "640320"
  },
  {
    "text": "make it easier to reason about i'll give you an example so let's say somebody wants to promote",
    "start": "640320",
    "end": "646880"
  },
  {
    "start": "643000",
    "end": "704000"
  },
  {
    "text": "from staging to production for this particular image called foo",
    "start": "646880",
    "end": "652160"
  },
  {
    "text": "you might notice that the staging name um staging slash foo is a little bit different than",
    "start": "652160",
    "end": "657680"
  },
  {
    "text": "the production name which says production path to food so it's the destination",
    "start": "657680",
    "end": "662880"
  },
  {
    "text": "uh endpoints are slightly different you might also notice that the tag 1.0 in production",
    "start": "662880",
    "end": "670480"
  },
  {
    "text": "is not the same in staging this is kind of by design like we don't care about the",
    "start": "670480",
    "end": "676160"
  },
  {
    "text": "staging tag because we only care about images by their content and every image",
    "start": "676160",
    "end": "683920"
  },
  {
    "text": "with uh unique contents are well every image has the digest and the digest is",
    "start": "683920",
    "end": "689519"
  },
  {
    "text": "unique because it's a you know secure hash so uh it really doesn't",
    "start": "689519",
    "end": "694800"
  },
  {
    "text": "matter what it's named in staging as long as it can find the hash that the blob",
    "start": "694800",
    "end": "702959"
  },
  {
    "text": "so these are the cases that the edge helps promote or the edge helps",
    "start": "702959",
    "end": "710079"
  },
  {
    "text": "detect so we check against overrides where overrides means putting a",
    "start": "710079",
    "end": "715440"
  },
  {
    "text": "different image into the same production name or endpoint that's bad that's the",
    "start": "715440",
    "end": "721440"
  },
  {
    "text": "first example on the bottom left there like we don't want to promote two different things to the same endpoint",
    "start": "721440",
    "end": "726880"
  },
  {
    "text": "that that's basically you know a disaster right i mean you don't want",
    "start": "726880",
    "end": "732959"
  },
  {
    "text": "one totally different image to somehow magically replace another one that would be really really bad so that's definite no",
    "start": "732959",
    "end": "739839"
  },
  {
    "text": "however we don't mind having multiple copies of the same thing",
    "start": "739839",
    "end": "745839"
  },
  {
    "text": "promoting to the same endpoint so that's the bottom right",
    "start": "745839",
    "end": "751120"
  },
  {
    "text": "if you have two different staging projects let's say r and s they both have the exact same image and",
    "start": "751120",
    "end": "757760"
  },
  {
    "text": "they both want to promote to the same exact end point in production that's fine in",
    "start": "757760",
    "end": "762800"
  },
  {
    "text": "reality we actually do call these out as well to reduce the performance cost although that is",
    "start": "762800",
    "end": "769440"
  },
  {
    "text": "negligible but it's strictly speaking it's not a bad thing",
    "start": "769440",
    "end": "775120"
  },
  {
    "text": "and the middle picture there is like a normal case where you know you have different images from different staging",
    "start": "775120",
    "end": "780880"
  },
  {
    "text": "areas going into different promotion or production endpoints",
    "start": "780880",
    "end": "787120"
  },
  {
    "start": "785000",
    "end": "827000"
  },
  {
    "text": "so this is how it really works as an overview so it gets all the promoter manifests then creates",
    "start": "787120",
    "end": "794959"
  },
  {
    "text": "these edges that's what actually happens well after it reads",
    "start": "794959",
    "end": "800000"
  },
  {
    "text": "you know all the data from production so once we have these edges then we check for illegality et cetera that's like the",
    "start": "800000",
    "end": "806800"
  },
  {
    "text": "simplification step where we go from 90 000 like edges possible and then we just reduce it down to like",
    "start": "806800",
    "end": "813200"
  },
  {
    "text": "just a handful maybe the 10 or the 20 that we need to promote in one one step um or in one sorry pull request",
    "start": "813200",
    "end": "819920"
  },
  {
    "text": "from github and then we just actuate each promotion that's also done in parallel as well",
    "start": "819920",
    "end": "825440"
  },
  {
    "text": "because why not um there are also two other pieces um that i alluded to",
    "start": "825440",
    "end": "832079"
  },
  {
    "text": "earlier which is auditing and backups i'll just cover those um briefly so for auditing",
    "start": "832079",
    "end": "838800"
  },
  {
    "start": "835000",
    "end": "972000"
  },
  {
    "text": "actually this is an interesting slide so there's a lot of different pieces involved here um we use a lot of different cloud",
    "start": "838800",
    "end": "845680"
  },
  {
    "text": "components so the auditor's job before before i get into how it works",
    "start": "845680",
    "end": "851600"
  },
  {
    "text": "the point of the auditor is detect any changes in production that happen outside of the normal",
    "start": "851600",
    "end": "857440"
  },
  {
    "text": "promotion process so you know you can have a team of people using the promoter like",
    "start": "857440",
    "end": "864000"
  },
  {
    "text": "you know day to day that's fine but what if somebody has access to production and does something you know on their own",
    "start": "864000",
    "end": "871199"
  },
  {
    "text": "could be you know and it's a mistake could be a hacker anything any change that you know that",
    "start": "871199",
    "end": "877279"
  },
  {
    "text": "happens in production we want to know about right so",
    "start": "877279",
    "end": "883040"
  },
  {
    "text": "in this example here uh the auditor is designed to basically detect any change so um",
    "start": "883040",
    "end": "890480"
  },
  {
    "text": "the production registry where all our images are stored it's stored in gcp or gcr gcr has this feature where",
    "start": "890480",
    "end": "898880"
  },
  {
    "text": "you can have any change that happens in gcr you know get notified via pops up so",
    "start": "898880",
    "end": "905199"
  },
  {
    "text": "anytime an image gets pushed there any time it gets deleted or anytime a tag is created",
    "start": "905199",
    "end": "911680"
  },
  {
    "text": "all of those things are individual events that pub sub basically generates if you listen to it",
    "start": "911680",
    "end": "918560"
  },
  {
    "text": "so that's what's happening in step one so in this example there's like a bad image that's a red docker image there",
    "start": "918560",
    "end": "925680"
  },
  {
    "text": "and then because the auditor is listening to pub sub um it it spins up and as soon as it",
    "start": "925680",
    "end": "933040"
  },
  {
    "text": "spins up this is in cloud run it pulls github so it says okay i got this these",
    "start": "933040",
    "end": "940399"
  },
  {
    "text": "promoter manifests here that's the official you know everything in the master branch um does",
    "start": "940399",
    "end": "945920"
  },
  {
    "text": "this soccer image that i see does it match stuff in this you know manifest",
    "start": "945920",
    "end": "951360"
  },
  {
    "text": "if not then it alerts error reporting which is another cloud component um if it does match then",
    "start": "951360",
    "end": "958560"
  },
  {
    "text": "nothing happens um the error reporting then gets fed into slack there's a fact channel for this but you",
    "start": "958560",
    "end": "964880"
  },
  {
    "text": "know i didn't i kind of ran out of room i don't want to add in too many things into this slide so",
    "start": "964880",
    "end": "970720"
  },
  {
    "text": "that's how that works and for backups so we also have backups of",
    "start": "970720",
    "end": "977680"
  },
  {
    "start": "972000",
    "end": "1090000"
  },
  {
    "text": "production this is pretty simple we run it every 12 hours there's a full copy of production",
    "start": "977680",
    "end": "983600"
  },
  {
    "text": "um in a production sorry in the backup registry um just i guess there are a",
    "start": "983600",
    "end": "990320"
  },
  {
    "text": "couple things uh here to note um uh well the main thing is that due to quota uh",
    "start": "990320",
    "end": "997040"
  },
  {
    "text": "constraints so the initial implementation of the backups was actually a bit naive so we tried to do a full",
    "start": "997040",
    "end": "1002959"
  },
  {
    "text": "snapshot a snapshot of all 30 000 images every time and that basically",
    "start": "1002959",
    "end": "1010320"
  },
  {
    "text": "uh aid up all of the quota for gcr reads like the gcr api only allows you",
    "start": "1010320",
    "end": "1016079"
  },
  {
    "text": "to read you know a certain number of uh or only allows you to make a certain number",
    "start": "1016079",
    "end": "1022240"
  },
  {
    "text": "of api calls per hour and like per day there's different limits so when we first did our version of this",
    "start": "1022240",
    "end": "1028480"
  },
  {
    "text": "uh the backup job was eating up all of the quota so we actually brought down like",
    "start": "1028480",
    "end": "1034160"
  },
  {
    "text": "the proud jobs and stuff that was running so sorry about that crowd team but we've since fixed it",
    "start": "1034160",
    "end": "1039839"
  },
  {
    "text": "we just do incremental backups today um the i guess the other thing to note",
    "start": "1039839",
    "end": "1046160"
  },
  {
    "text": "here is that production only grows we never delete images because deleting images in",
    "start": "1046160",
    "end": "1052400"
  },
  {
    "text": "production would be a very bad thing because kubernetes as you know is used worldwide it's used everywhere so you never know",
    "start": "1052400",
    "end": "1059039"
  },
  {
    "text": "who's using which image at which time so uh by that reason we always add",
    "start": "1059039",
    "end": "1065039"
  },
  {
    "text": "we never subtract or you know change or modify so that kind of makes the backups easy",
    "start": "1065039",
    "end": "1070240"
  },
  {
    "text": "because you know you only get more stuff in production it only grows so",
    "start": "1070240",
    "end": "1076080"
  },
  {
    "text": "every time you do a snapshot you really only need to snapshot new images and that's about it you don't need to think about",
    "start": "1076080",
    "end": "1082880"
  },
  {
    "text": "deletions or changes to existing data like all of that is kind of unnecessary",
    "start": "1082880",
    "end": "1088400"
  },
  {
    "text": "but this is pretty simple so that's the overview of the three i",
    "start": "1088400",
    "end": "1094640"
  },
  {
    "text": "guess major pieces and steve is going to talk about some of the tests that we do here",
    "start": "1094640",
    "end": "1099840"
  },
  {
    "text": "yeah so you know i think you know the the natural next step is to ask how do we test all of this right",
    "start": "1099840",
    "end": "1108720"
  },
  {
    "start": "1100000",
    "end": "1192000"
  },
  {
    "text": "and uh it's pretty simple right we we uh we tested as you would test any go",
    "start": "1108720",
    "end": "1115120"
  },
  {
    "text": "program standard unit tests there's no extra sauce uh just kind of using the standard um go",
    "start": "1115120",
    "end": "1121840"
  },
  {
    "text": "testing frameworks now the what's a little special about what we do um and maybe it's less special if you if",
    "start": "1121840",
    "end": "1129679"
  },
  {
    "text": "you like testing in prod um is there is a custom end to end",
    "start": "1129679",
    "end": "1135120"
  },
  {
    "text": "test framework which is built around being able to replicate uh the actions that we would do moving",
    "start": "1135120",
    "end": "1142400"
  },
  {
    "text": "from staging to prod what becomes a little trickier about these systems is that",
    "start": "1142400",
    "end": "1148559"
  },
  {
    "text": "when you're operating with a system whose idea is to handle promotion um from a",
    "start": "1148559",
    "end": "1156160"
  },
  {
    "text": "essentially non-prod bucket to a prod bucket uh what you have to consider is we have to test against uh endpoints that would",
    "start": "1156160",
    "end": "1164400"
  },
  {
    "text": "look very similarly to to prod have the same sort of restrictions that",
    "start": "1164400",
    "end": "1169440"
  },
  {
    "text": "we would place on a prod uh uh uh registry so our testing happens in kind of a near",
    "start": "1169440",
    "end": "1176400"
  },
  {
    "text": "prod environment where there is there are gcr endpoint",
    "start": "1176400",
    "end": "1182160"
  },
  {
    "text": "setup uh pub sub cloud run error reporting everything that linus mentioned before",
    "start": "1182160",
    "end": "1187600"
  },
  {
    "text": "as well as a fully replicated backup stack and here we're going to see a pretty diagram of",
    "start": "1187600",
    "end": "1194000"
  },
  {
    "start": "1192000",
    "end": "1226000"
  },
  {
    "text": "what that looks like so again very very similar to what we saw in the previous slides",
    "start": "1194000",
    "end": "1200640"
  },
  {
    "text": "around and around and to end testing instead right so that promoter uh",
    "start": "1200640",
    "end": "1206000"
  },
  {
    "text": "you know that promoter is in play there's a staging and a near prod uh bucket as well as verifications",
    "start": "1206000",
    "end": "1212960"
  },
  {
    "text": "against github uh cloud cloud run and error reporting to handle the auditing pieces",
    "start": "1212960",
    "end": "1218960"
  },
  {
    "text": "as well as that production backup component or that near prod backup component",
    "start": "1218960",
    "end": "1226158"
  },
  {
    "start": "1226000",
    "end": "1487000"
  },
  {
    "text": "so i'll talk actually about the actual flip so we just talked about the",
    "start": "1228240",
    "end": "1233360"
  },
  {
    "text": "infrastructure you know all the different pieces that were necessary to make this happen to make it more robust more secure all this good stuff",
    "start": "1233360",
    "end": "1240720"
  },
  {
    "text": "but what about the actual flip the change for that you know the dns change basically um it wasn't rocket science but um",
    "start": "1240720",
    "end": "1249039"
  },
  {
    "text": "that has kind of its own history so i kind of go briefly over what actually happened so the very first",
    "start": "1249039",
    "end": "1254159"
  },
  {
    "text": "attempt happened on april 1st uh no joke but",
    "start": "1254159",
    "end": "1259679"
  },
  {
    "text": "unfortunately this was rolled back uh it was on a friday so it was a typical like you know it was a nice friday we",
    "start": "1259679",
    "end": "1267440"
  },
  {
    "text": "started on monday and then april 1st you know and then friday it's like oh god",
    "start": "1267440",
    "end": "1273440"
  },
  {
    "text": "you know what is this weird signal that i see and basically we have to roll it back uh",
    "start": "1273440",
    "end": "1279280"
  },
  {
    "text": "long story short there was a hardware uh sorry hard-coded configuration",
    "start": "1279280",
    "end": "1285919"
  },
  {
    "text": "in our code base it basically resulted in uh you know an incident",
    "start": "1285919",
    "end": "1293679"
  },
  {
    "text": "that's that's where i'll leave it um but the good news is that uh because of",
    "start": "1293679",
    "end": "1300080"
  },
  {
    "text": "that incident we had a lot more eyes on this whole project so we had a lot more people come in just from the google side",
    "start": "1300080",
    "end": "1307039"
  },
  {
    "text": "and also maybe yeah i think we had more people interested in it after this like",
    "start": "1307039",
    "end": "1312640"
  },
  {
    "text": "attempt happened that we cut had to undo it so more people in the community were like hey what's wrong you know anything",
    "start": "1312640",
    "end": "1318000"
  },
  {
    "text": "you can do to help so that was a cool uh little uh cool cool",
    "start": "1318000",
    "end": "1323919"
  },
  {
    "text": "cool event as well call it and then the second event happened or attempt sorry happened in june",
    "start": "1323919",
    "end": "1329930"
  },
  {
    "text": "[Music] unfortunately it's like we're kind of you know cursed or something right because reasons so this was a",
    "start": "1329930",
    "end": "1337679"
  },
  {
    "text": "purely non-technical issue so basically if you recall the new production of backing store is a",
    "start": "1337679",
    "end": "1345200"
  },
  {
    "text": "different name well it's called case artifacts prod it's in a different project different",
    "start": "1345200",
    "end": "1351600"
  },
  {
    "text": "project means it's billed differently basically a different credit card",
    "start": "1351600",
    "end": "1357520"
  },
  {
    "text": "so the issue here really is we kind of forgot you know the lightness",
    "start": "1357520",
    "end": "1363600"
  },
  {
    "text": "of the change the domain flip it's a very simple like you know pointer flip like that's",
    "start": "1363600",
    "end": "1369600"
  },
  {
    "text": "very easy but what we did we kind of forgot was that that little pointer uh points",
    "start": "1369600",
    "end": "1377520"
  },
  {
    "text": "millions and millions of api requests like every day it's something on the order of like",
    "start": "1377520",
    "end": "1382880"
  },
  {
    "text": "hundreds of millions like per week or something like that it's huge a huge amount",
    "start": "1382880",
    "end": "1388080"
  },
  {
    "text": "of traffic so what we realized at the last moment there was you know hey if we flip this",
    "start": "1388080",
    "end": "1394159"
  },
  {
    "text": "can the new project can that you know new you know owner or whatever",
    "start": "1394159",
    "end": "1400559"
  },
  {
    "text": "community basically can they pay for it and if they don't have the cred you know credits or something set up already",
    "start": "1400559",
    "end": "1406640"
  },
  {
    "text": "beforehand to take all this traffic you know what if we automatically shut it down or something because that's how",
    "start": "1406640",
    "end": "1412080"
  },
  {
    "text": "you know gcp works or something you know that's how most cloud providers i imagine would work right if you use uh",
    "start": "1412080",
    "end": "1418799"
  },
  {
    "text": "amazon and you've just spent up you know 30 000 videos or ec2 you know and you don't have the money paid for i'm sure they'll",
    "start": "1418799",
    "end": "1425360"
  },
  {
    "text": "shut you down but so in order to avoid that scenario we just kind of but i think we rolled it back immediately i",
    "start": "1425360",
    "end": "1431679"
  },
  {
    "text": "think we spent a few hours on day one it's actually a four day rollout so anyway yeah we kind of realized this",
    "start": "1431679",
    "end": "1439279"
  },
  {
    "text": "a few hours in and just you know preemptively undid it there was no",
    "start": "1439279",
    "end": "1445120"
  },
  {
    "text": "uh issue there in terms of like technical like we didn't hear about any uh issues and the third",
    "start": "1445120",
    "end": "1450559"
  },
  {
    "text": "attempt finally happened on july the 24th all right i think it wrapped up in the",
    "start": "1450559",
    "end": "1455679"
  },
  {
    "text": "24th because i think that was a friday um but yeah it took four days uh it's a",
    "start": "1455679",
    "end": "1461520"
  },
  {
    "text": "four day rollout so we had to wait but uh i think yeah true to our intentions at the beginning",
    "start": "1461520",
    "end": "1468240"
  },
  {
    "text": "uh no systems noticed this so it was a nice like you know under the",
    "start": "1468240",
    "end": "1474000"
  },
  {
    "text": "radar chain that's how it's supposed to work that's what the domain name is for um so that was a nice moment",
    "start": "1474000",
    "end": "1481600"
  },
  {
    "text": "when we finally realized that it did work you know on the third attempt",
    "start": "1481600",
    "end": "1487840"
  },
  {
    "text": "so yeah go ahead yeah so again with a summary uh of a incredibly",
    "start": "1489279",
    "end": "1496799"
  },
  {
    "text": "simple process wouldn't you say linus from uh one registry to another um but",
    "start": "1496799",
    "end": "1504960"
  },
  {
    "text": "it again begs the question is that it",
    "start": "1504960",
    "end": "1509600"
  },
  {
    "start": "1510000",
    "end": "1761000"
  },
  {
    "text": "and no it's it's not it's not so for us to be successful in this endeavor",
    "start": "1510640",
    "end": "1516720"
  },
  {
    "text": "uh lots of work had to happen in the community kind of adjacent to uh the build out of the",
    "start": "1516720",
    "end": "1522400"
  },
  {
    "text": "um container image promoter uh so some of that working included developing tooling for staging",
    "start": "1522400",
    "end": "1527679"
  },
  {
    "text": "projects right staging projects are fundamentally a newer concept in the community",
    "start": "1527679",
    "end": "1533360"
  },
  {
    "text": "right um given given the uh given the background that linus has",
    "start": "1533360",
    "end": "1538400"
  },
  {
    "text": "told you about the pushing uh artifacts to uh pushing artifacts to",
    "start": "1538400",
    "end": "1545039"
  },
  {
    "text": "google containers kind of involved finding the right person who had access",
    "start": "1545039",
    "end": "1550080"
  },
  {
    "text": "uh to do it at any point in time the release process is a little different because the release process has the keys",
    "start": "1550080",
    "end": "1556799"
  },
  {
    "text": "that it needs to write into the uh google containers registry um",
    "start": "1556799",
    "end": "1562000"
  },
  {
    "text": "but for everyone else for every repo across the multiple uh kubernetes kubernetes",
    "start": "1562000",
    "end": "1567360"
  },
  {
    "text": "sigs kubernetes client so on and so forth all of these orgs need a way of being able to produce images and",
    "start": "1567360",
    "end": "1575279"
  },
  {
    "text": "uh and have those promoted within um within github and within uh gcr right so",
    "start": "1575279",
    "end": "1582840"
  },
  {
    "text": "uh to to our our trusty friend bash i think you know some a lot of clever bash was written",
    "start": "1582840",
    "end": "1590320"
  },
  {
    "text": "uh to enable uh us to generate uh generate new staging projects as well",
    "start": "1590320",
    "end": "1596400"
  },
  {
    "text": "as delegate uh iam to various uh component",
    "start": "1596400",
    "end": "1601440"
  },
  {
    "text": "leads to the the various owners of code um sig say uh chairs and technical leads",
    "start": "1601440",
    "end": "1608640"
  },
  {
    "text": "as well as some project owners uh to have that to grant them access uh to write to these staging projects uh or",
    "start": "1608640",
    "end": "1616240"
  },
  {
    "text": "to wire automation to write to these staging projects um so the second component of that is well",
    "start": "1616240",
    "end": "1623279"
  },
  {
    "text": "now that i have access to push to one of these projects how can i do it in a safe way",
    "start": "1623279",
    "end": "1628960"
  },
  {
    "text": "how can i ensure that what i'm doing is um is not looking backwards it's not",
    "start": "1628960",
    "end": "1634720"
  },
  {
    "text": "doing something similar to to what would have happened prior to the image promoter existing right",
    "start": "1634720",
    "end": "1640399"
  },
  {
    "text": "and the way we solve that problem is a combination of prow a combination of",
    "start": "1640399",
    "end": "1647360"
  },
  {
    "text": "prow and which is the kubernetes and several other projects in the ecosystems cicd",
    "start": "1647360",
    "end": "1654640"
  },
  {
    "text": "solution as well as uh google cloud build right so google cloud build and a",
    "start": "1654640",
    "end": "1661480"
  },
  {
    "text": "cloudbuild.yaml file in your repo is a common way to maybe that's hooked into a make target",
    "start": "1661480",
    "end": "1668960"
  },
  {
    "text": "or a bash script that you've written um that essentially tells us or tells",
    "start": "1668960",
    "end": "1674720"
  },
  {
    "text": "uh tells gcv how to build your image and how to push it to your our your staging repository what we get",
    "start": "1674720",
    "end": "1681120"
  },
  {
    "text": "out of this uh is an opportunity to uh again be able to audit some of these",
    "start": "1681120",
    "end": "1688320"
  },
  {
    "text": "changes that are happening right these changes are no longer happening on a developer's laptop they're happening as a result",
    "start": "1688320",
    "end": "1694799"
  },
  {
    "text": "of a pr being approved and merged within a component area and subsequently a proud job kicking off",
    "start": "1694799",
    "end": "1702480"
  },
  {
    "text": "a post submit after that pr has merged which kicks off a gcb or google cloud",
    "start": "1702480",
    "end": "1709679"
  },
  {
    "text": "build job that eventually pushes this image right finally you bring the human into the process and",
    "start": "1709679",
    "end": "1715200"
  },
  {
    "text": "you have uh you have them generate a manifest uh for promotion or an update to a manifest",
    "start": "1715200",
    "end": "1722480"
  },
  {
    "text": "for promotion lots of bash script cleanup uh bash is pretty popular",
    "start": "1722480",
    "end": "1727760"
  },
  {
    "text": "and our release process runs on about 5000 lines of bash which is kind",
    "start": "1727760",
    "end": "1733919"
  },
  {
    "text": "of changing every day so in addition to that we had to make sure that uh",
    "start": "1733919",
    "end": "1739120"
  },
  {
    "text": "the components that we had already built out were uh able to support pushing into a new",
    "start": "1739120",
    "end": "1745279"
  },
  {
    "text": "registry again lots of hard-coded references to consider so maybe a few quarters of work and",
    "start": "1745279",
    "end": "1753360"
  },
  {
    "text": "testing across uh across the release engineering subproject to to wire some of that stuff up",
    "start": "1753360",
    "end": "1761440"
  },
  {
    "start": "1761000",
    "end": "1890000"
  },
  {
    "text": "so what's next right um lots of exciting uh discussion around tooling",
    "start": "1762320",
    "end": "1768240"
  },
  {
    "text": "and how we how we get all of this done um it's it's always good to look into the future",
    "start": "1768240",
    "end": "1774720"
  },
  {
    "text": "get a an idea of what we want to accomplish next with this tool right and i think ultimately um we want",
    "start": "1774720",
    "end": "1781919"
  },
  {
    "text": "consolidation right we have we have a promobot tool that was also written for file",
    "start": "1781919",
    "end": "1789840"
  },
  {
    "text": "promotion right so very similar concept you'll see some of the um some of the same concepts happening",
    "start": "1789840",
    "end": "1796000"
  },
  {
    "text": "within file promotion that happen on the image promotion side and they're similar enough that they",
    "start": "1796000",
    "end": "1801520"
  },
  {
    "text": "should be consolidated right so we are we have started work on uh building one tool to rule them all for promotion",
    "start": "1801520",
    "end": "1809679"
  },
  {
    "text": "for file and image promotion we're working on deduplicating the release engineering libraries",
    "start": "1809679",
    "end": "1814880"
  },
  {
    "text": "so lots of great work has happened on the image promotion side on the file promotion side and as well",
    "start": "1814880",
    "end": "1821440"
  },
  {
    "text": "as the kind of elimination of uh bash scripts to run the release engineering process",
    "start": "1821440",
    "end": "1826960"
  },
  {
    "text": "so bringing all of that knowledge together in uh common libraries for all of us to reuse",
    "start": "1826960",
    "end": "1832240"
  },
  {
    "text": "uh now google has recently announced the artifact registry which is going to be",
    "start": "1832240",
    "end": "1838960"
  },
  {
    "text": "the next generation of the google container registry uh so we need to make sure that the tools that",
    "start": "1838960",
    "end": "1844720"
  },
  {
    "text": "we use uh support any new apis and and that we're present around any",
    "start": "1844720",
    "end": "1851919"
  },
  {
    "text": "potential uh deprecation cycles that we need to consider right we want to make sure that when if",
    "start": "1851919",
    "end": "1858080"
  },
  {
    "text": "we need to do this again we do it in a safe way we do it in a way that minimizes downtime for the community and for the consumers",
    "start": "1858080",
    "end": "1865200"
  },
  {
    "text": "um and then image uh image vulnerability scanning coming soon we have active work on that",
    "start": "1865200",
    "end": "1872799"
  },
  {
    "text": "and finally uh you know finding finding people who are interested in this kind of work",
    "start": "1872799",
    "end": "1878080"
  },
  {
    "text": "and uh and and you know welcoming them into the community uh to do release engineering work to do",
    "start": "1878080",
    "end": "1883760"
  },
  {
    "text": "work around this these uh promotion tools that we've built out over the last few years",
    "start": "1883760",
    "end": "1892159"
  },
  {
    "start": "1890000",
    "end": "2005000"
  },
  {
    "text": "so i'll talk a little bit about the lessons learned here so you know it's a big project uh what did",
    "start": "1892159",
    "end": "1898000"
  },
  {
    "text": "we learn so basically infrastructural changes uh for legacy code i mean i don't call",
    "start": "1898000",
    "end": "1905600"
  },
  {
    "text": "i don't think the existing you know release engineering bash scripts and whatever that legacy code well it works but uh",
    "start": "1905600",
    "end": "1912960"
  },
  {
    "text": "tweaking just a small bit of that you guys even said just little references and stuff that takes time because you",
    "start": "1912960",
    "end": "1918320"
  },
  {
    "text": "have to coordinate all this stuff together right so that was really hard but the rewards",
    "start": "1918320",
    "end": "1923760"
  },
  {
    "text": "i think are worth it because it's so much simpler now anybody who has an interest in contributing new images and",
    "start": "1923760",
    "end": "1929519"
  },
  {
    "text": "stuff they can just come in and make a pr get a staging sub project and get their images in production it's pretty",
    "start": "1929519",
    "end": "1934960"
  },
  {
    "text": "straightforward um i'll also repeat a quote from tim hawkin our principal engineer",
    "start": "1934960",
    "end": "1941679"
  },
  {
    "text": "for kubernetes at google he said to me as i was writing some of this stuff if",
    "start": "1941679",
    "end": "1947360"
  },
  {
    "text": "it is not tested it is broken uh you can actually find that in a github like discussion comment somewhere",
    "start": "1947360",
    "end": "1954240"
  },
  {
    "text": "um so yeah that was really eye-opening when he said that you know and really",
    "start": "1954240",
    "end": "1961360"
  },
  {
    "text": "all of the tests that we have today they really help uh bring some sanity into this",
    "start": "1961360",
    "end": "1966640"
  },
  {
    "text": "uh kind of chaos of you know all these images flying around everywhere basically every day um",
    "start": "1966640",
    "end": "1974000"
  },
  {
    "text": "and also it takes a village because you know none of this happened uh from just one person's efforts it was",
    "start": "1974000",
    "end": "1980080"
  },
  {
    "text": "the community with other googlers it was behind the scenes google security helping out um all of",
    "start": "1980080",
    "end": "1987360"
  },
  {
    "text": "these people like sres gk developers there are so many people that",
    "start": "1987360",
    "end": "1992480"
  },
  {
    "text": "i i should actually name here but i didn't have the time to add them to the slides but yeah it",
    "start": "1992480",
    "end": "1998240"
  },
  {
    "text": "really does take a village sorry for all the people i didn't say i'm going to forget your name i'm gonna",
    "start": "1998240",
    "end": "2003919"
  },
  {
    "text": "try we'll mention them in q a right we can talk about that on on slack with you all",
    "start": "2003919",
    "end": "2010000"
  },
  {
    "start": "2005000",
    "end": "2077000"
  },
  {
    "text": "later uh so how you know to to wrap we wanted to you know just give you an idea of how to",
    "start": "2010000",
    "end": "2016240"
  },
  {
    "text": "get involved right so again the container image promoter and the the other artifact promotion",
    "start": "2016240",
    "end": "2021279"
  },
  {
    "text": "tools are tools that are maintained uh both by sig releases",
    "start": "2021279",
    "end": "2026320"
  },
  {
    "text": "release engineering project uh release engineering subproject as well as the working group kate's",
    "start": "2026320",
    "end": "2032240"
  },
  {
    "text": "infra right so the promotion tooling can be found uh kubernetes sigs container image promoter",
    "start": "2032240",
    "end": "2039039"
  },
  {
    "text": "some of that tooling has already started to be migrated into uh affectionately called k release but",
    "start": "2039039",
    "end": "2045039"
  },
  {
    "text": "that's git dot case dot io slash release and then there are some of the the links in how to contact us right",
    "start": "2045039",
    "end": "2051760"
  },
  {
    "text": "so the uh sig release uh the working group kate's in for the sig release repo as well as where",
    "start": "2051760",
    "end": "2058240"
  },
  {
    "text": "you can find all of the promo promoter manifests that we've been talking about today so thank you again",
    "start": "2058240",
    "end": "2064000"
  },
  {
    "text": "for uh taking the time to hang out with us uh at cubecon uh it has been it's always a thrilling",
    "start": "2064000",
    "end": "2070158"
  },
  {
    "text": "journey uh and it's been really exciting to work on this project with all the community",
    "start": "2070159",
    "end": "2078878"
  }
]