[
  {
    "start": "0",
    "end": "12000"
  },
  {
    "text": "alright everybody let's get started hope you're excited for what's the last talk of day one I'm mark stem and we're going",
    "start": "170",
    "end": "7440"
  },
  {
    "text": "to talk about how to use kubernetes audit logs to secure your cluster so a",
    "start": "7440",
    "end": "12719"
  },
  {
    "start": "12000",
    "end": "23000"
  },
  {
    "text": "little bit about me my work at Cystic I'm a senior software engineer there I'm also one of the maintainer Zahn Falco",
    "start": "12719",
    "end": "18330"
  },
  {
    "text": "which is our open source security product and there's my github alright so",
    "start": "18330",
    "end": "25010"
  },
  {
    "start": "23000",
    "end": "74000"
  },
  {
    "text": "what we're gonna do to start off with Lissa's let's talk a little bit about kubernetes audit events in audit support",
    "start": "25010",
    "end": "30949"
  },
  {
    "text": "so if you don't know anything about it it was a new feature added in version 111 and then it was updated with more",
    "start": "30949",
    "end": "38160"
  },
  {
    "text": "more features in 1.13 and what it does is provides a chronological set of",
    "start": "38160",
    "end": "43590"
  },
  {
    "text": "records that document all the changes to your cluster and it does that by doing",
    "start": "43590",
    "end": "48660"
  },
  {
    "text": "this by adding auditing at the kubernetes api server because almost all",
    "start": "48660",
    "end": "54180"
  },
  {
    "text": "the actions that you do when you're administering your cluster go through the API server it's a natural place to",
    "start": "54180",
    "end": "59670"
  },
  {
    "text": "add auditing to document all the changes and see what's going on each audit event",
    "start": "59670",
    "end": "66990"
  },
  {
    "text": "is a little JSON object that describes what they did what the result was and",
    "start": "66990",
    "end": "72270"
  },
  {
    "text": "who they aren't all that kind of stuff here's an example audit event I've",
    "start": "72270",
    "end": "77340"
  },
  {
    "start": "74000",
    "end": "142000"
  },
  {
    "text": "trimmed it a little bit because there's a whole lot of stuff in there but I kept all the interesting bits so you can see",
    "start": "77340",
    "end": "82830"
  },
  {
    "text": "it's just a you know JSON object and you know it's got stuff like the timestamp of when the person did their operation",
    "start": "82830",
    "end": "90500"
  },
  {
    "text": "what action they were taking that's the verb you know because it's all like restful api s it's very straightforward",
    "start": "90500",
    "end": "97170"
  },
  {
    "text": "to translate the HTTP verbs into the verbs in the audit event you can see what you are all there accessing which",
    "start": "97170",
    "end": "103259"
  },
  {
    "text": "is often the resource that they're grabbing in cases where you're doing something specifically to a referred",
    "start": "103259",
    "end": "110189"
  },
  {
    "text": "object that will be in the audit event as well in this case somebody's trying to do a delete of a namespace so the",
    "start": "110189",
    "end": "116130"
  },
  {
    "text": "object reference is in there and you can say like hey it's a the resources namespaces and then here's the specific",
    "start": "116130",
    "end": "122579"
  },
  {
    "text": "namespace that they're acting on you can see user information in this case it was",
    "start": "122579",
    "end": "127680"
  },
  {
    "text": "mini cube you can see our back information so you can see what the result of the authorization decision",
    "start": "127680",
    "end": "133040"
  },
  {
    "text": "and you can see like the HTTP response code and that kind of stuff so it's a really rich source of information about",
    "start": "133040",
    "end": "138500"
  },
  {
    "text": "what's going on for each of these events so just I wanted to give a preview of",
    "start": "138500",
    "end": "145640"
  },
  {
    "start": "142000",
    "end": "244000"
  },
  {
    "text": "like some of the you know all the stuff that you can kind of get out of these audit logs it's a pretty rich source of",
    "start": "145640",
    "end": "151670"
  },
  {
    "text": "information so just some examples of the stuff you can get is you know obviously all of the changes to your cluster so",
    "start": "151670",
    "end": "157190"
  },
  {
    "text": "anytime anybody creates or destroys or modifies any resources you're gonna see that in the audit log some of the more",
    "start": "157190",
    "end": "164959"
  },
  {
    "text": "specific things is you know you may not know this but if you try to exact into a pod you're actually going to see that in",
    "start": "164959",
    "end": "170750"
  },
  {
    "text": "the audit log because the attempt to exec goes through the API server it's if",
    "start": "170750",
    "end": "176209"
  },
  {
    "text": "you don't know it's actually a git where the resources pod slash exec so you'll",
    "start": "176209",
    "end": "181579"
  },
  {
    "text": "see that in the audit log as well in a whole bunch of our back stuff - you know",
    "start": "181579",
    "end": "186799"
  },
  {
    "text": "if you're creating roles to define access about what things are allowed to do if you create service accounts if you",
    "start": "186799",
    "end": "192799"
  },
  {
    "text": "create role bindings to link the service accounts and the roles together you're gonna see all of that stuff in the audit",
    "start": "192799",
    "end": "198440"
  },
  {
    "text": "log as well so it's a you know great way to see what's going on and also you can",
    "start": "198440",
    "end": "203900"
  },
  {
    "text": "see you know viewing stuff so every time you write cube Caudill get pods that's a basically a get request on the",
    "start": "203900",
    "end": "212060"
  },
  {
    "text": "resource pods and you're gonna see that in the audit log all of the above includes both actions by individual",
    "start": "212060",
    "end": "219650"
  },
  {
    "text": "users so me typing mini cube are you using cube Caudill to manage your production cluster but it also includes",
    "start": "219650",
    "end": "225980"
  },
  {
    "text": "internal kubernetes services so for example when you create a namespace it'll usually create a service account",
    "start": "225980",
    "end": "231560"
  },
  {
    "text": "that's working with that namespace and you'll see that in the audit log even",
    "start": "231560",
    "end": "236780"
  },
  {
    "text": "though you didn't create the service account it was actually something like cubes cubes scheduler creating the service account so you'll see that as",
    "start": "236780",
    "end": "242720"
  },
  {
    "text": "well now let's talk a little bit about how you actually enable and work with",
    "start": "242720",
    "end": "250909"
  },
  {
    "start": "244000",
    "end": "333000"
  },
  {
    "text": "audit logging so there's a couple big pieces the first is the audit policy that controls what events go in the",
    "start": "250909",
    "end": "258169"
  },
  {
    "text": "audit stream so in there you know when you define one of these audit policies",
    "start": "258169",
    "end": "263240"
  },
  {
    "text": "it's basically just a ya know file that has a list of and all of the audit events that are coming out of the API server get matched",
    "start": "263240",
    "end": "270460"
  },
  {
    "text": "against those set of rules and if it finds a match between the rule in the event the event goes in the audit lock",
    "start": "270460",
    "end": "276729"
  },
  {
    "text": "so you can do things there saying I only want to see the things that relate to pods or I only want to see the deletes",
    "start": "276729",
    "end": "283659"
  },
  {
    "text": "of anything so the Paul audit policy is your first step towards filtering out the audit events to show you the stuff",
    "start": "283659",
    "end": "289120"
  },
  {
    "text": "you want to see the other piece is the audit backend and that basically controls where the audit events go you",
    "start": "289120",
    "end": "296620"
  },
  {
    "text": "have a couple choices it can go to log files so you know just some log on the same machine where the API server is",
    "start": "296620",
    "end": "303250"
  },
  {
    "text": "running and you can also go to web hook so you can configure is saying hey when you get a bunch of audit events go to an",
    "start": "303250",
    "end": "309159"
  },
  {
    "text": "HTTP POST to this URI and then somebody else will take care of it from there and that's all in 111 in 113 one thing they",
    "start": "309159",
    "end": "316389"
  },
  {
    "text": "added with this was this notion of dynamic audit backends so there it's a little bit like on the web book and the",
    "start": "316389",
    "end": "322539"
  },
  {
    "text": "audit policy combined but the important thing is that it's a kubernetes resource you can create it and delete it and act",
    "start": "322539",
    "end": "329199"
  },
  {
    "text": "on it like you can with any other resource and we'll talk a little bit more about that in a second so now let's",
    "start": "329199",
    "end": "335439"
  },
  {
    "start": "333000",
    "end": "423000"
  },
  {
    "text": "talk about what goes in the audit log for each of these backends so when you",
    "start": "335439",
    "end": "340659"
  },
  {
    "text": "set up a log back-end it's just one line per JSON record and one record per audit",
    "start": "340659",
    "end": "347740"
  },
  {
    "text": "event so it's just the JSON object that we saw before just one line at a time so pretty simple you have controls to",
    "start": "347740",
    "end": "355330"
  },
  {
    "text": "basically say like where the log file goes how to rotate it you could do",
    "start": "355330",
    "end": "361419"
  },
  {
    "text": "rotation based on size or age or anything like that stuff when you set up a web hook back-end what happens is it",
    "start": "361419",
    "end": "368289"
  },
  {
    "text": "does a little bit of batching so it'll take a small number of events turn it into a little chunk make a giant JSON",
    "start": "368289",
    "end": "374379"
  },
  {
    "text": "array out of it and then post it off to your web book again you have controls",
    "start": "374379",
    "end": "379389"
  },
  {
    "text": "for the location so you can say like what host name and so forth to send it to and then some controls about how the",
    "start": "379389",
    "end": "386560"
  },
  {
    "text": "batching actually happens you can say like oh wait 500 milliseconds before sending me some events or wait five",
    "start": "386560",
    "end": "392379"
  },
  {
    "text": "seconds before sending me some events and also some controls about like there's some like rate limiting and",
    "start": "392379",
    "end": "397849"
  },
  {
    "text": "other kinds of stuff that you can do when you're setting up the web hook back-end when you set up the dynamic",
    "start": "397849",
    "end": "403399"
  },
  {
    "text": "back-end it's a kind of a combination of these things but the important thing is",
    "start": "403399",
    "end": "409309"
  },
  {
    "text": "that it's like I said it's managed like any other kubernetes resources so you make an object out of it using in",
    "start": "409309",
    "end": "415399"
  },
  {
    "text": "something called an audit sink and then you can you know create and the view and modify those just like other resources",
    "start": "415399",
    "end": "423520"
  },
  {
    "start": "423000",
    "end": "477000"
  },
  {
    "text": "so the process for enabling audit logging is a little different between 111 and 113 in 111 a lot of these",
    "start": "423520",
    "end": "430490"
  },
  {
    "text": "components are static so they're generally like arguments to the API server command-line arguments so you",
    "start": "430490",
    "end": "437389"
  },
  {
    "text": "know you'll see a command-line argument this is - - audit web config file and then you'll name a file and then that's",
    "start": "437389",
    "end": "442879"
  },
  {
    "text": "where you're gonna specify where the web hook goes same thing for like the log path and where the policy the audit",
    "start": "442879",
    "end": "449389"
  },
  {
    "text": "policy is located because it's all I can lick a command line you you know",
    "start": "449389",
    "end": "454699"
  },
  {
    "text": "generally have to restart the API server if you ever want to change one of these things so it's not as flexible as the",
    "start": "454699",
    "end": "460129"
  },
  {
    "text": "mechanism that you'll find in 1.13 and it's also a little hard to see what any",
    "start": "460129",
    "end": "466249"
  },
  {
    "text": "of these contents are unless you can get on to the API server and so for like manage kubernetes environments you're",
    "start": "466249",
    "end": "471589"
  },
  {
    "text": "not gonna be able to see that stuff at all or they're gonna have a different visibility way to show it to you in 113",
    "start": "471589",
    "end": "478729"
  },
  {
    "start": "477000",
    "end": "513000"
  },
  {
    "text": "they cleaned up a lot of that stuff so now it's just these audit sync objects that you you know like I said you create",
    "start": "478729",
    "end": "485809"
  },
  {
    "text": "them as resources and can act on like anything else you generally have to be a",
    "start": "485809",
    "end": "491300"
  },
  {
    "text": "cluster admin to do it but the nice thing is you can create multiple of them so you can create one audit sync that",
    "start": "491300",
    "end": "496789"
  },
  {
    "text": "has a policy and a destination and then you can create another audit sync that has a different policy and maybe a",
    "start": "496789",
    "end": "502849"
  },
  {
    "text": "different destination and you can create them in parallel and then the audit events will go to both locations",
    "start": "502849",
    "end": "508209"
  },
  {
    "text": "generally it's a much more operator friendly way to deal with this stuff",
    "start": "508209",
    "end": "513698"
  },
  {
    "start": "513000",
    "end": "599000"
  },
  {
    "text": "okay so now hopefully you know what audit events are now let's talk about",
    "start": "513699",
    "end": "518719"
  },
  {
    "text": "how you're gonna get data out of them and make sense out of what's in the audit log okay so there's two ways to do",
    "start": "518719",
    "end": "526430"
  },
  {
    "text": "it there's the hard way and the easy way I'm a falco engineer so as a little hint the easy way is gonna involve Falco but",
    "start": "526430",
    "end": "533370"
  },
  {
    "text": "first we'll do the hard way so on a really handy program that you can use",
    "start": "533370",
    "end": "538950"
  },
  {
    "text": "for this is called JQ if you haven't used it it's kind of a streaming json processor what happens is it reads JSON",
    "start": "538950",
    "end": "547260"
  },
  {
    "text": "objects from standard input does some transformations and filtering and so forth and then just writes JSON objects",
    "start": "547260",
    "end": "554040"
  },
  {
    "text": "to standard output or strings or something like that so it's a really handy way to act on these audit logs to",
    "start": "554040",
    "end": "560579"
  },
  {
    "text": "extract specific information out of it just some examples of what you can do with JQ so you can do selections so",
    "start": "560579",
    "end": "567149"
  },
  {
    "text": "given this input object show me the value of the property called key and it'll print out some value if",
    "start": "567149",
    "end": "573360"
  },
  {
    "text": "you want to do filtering you can get an array of objects and say hey only give me the objects where the value of key is",
    "start": "573360",
    "end": "579800"
  },
  {
    "text": "v1 and it'll just give you that object you can also do transformations you can",
    "start": "579800",
    "end": "585360"
  },
  {
    "text": "say hey give me take this object and then output a string that's a mix of like plain text and the value of the",
    "start": "585360",
    "end": "592829"
  },
  {
    "text": "property called key from the input object and it'll print out an output string okay so once we have JQ we can",
    "start": "592829",
    "end": "602040"
  },
  {
    "start": "599000",
    "end": "734000"
  },
  {
    "text": "basically build up a bunch of filters that work on the log file to extract",
    "start": "602040",
    "end": "607920"
  },
  {
    "text": "interesting information out of the audit stream so here's just some examples of",
    "start": "607920",
    "end": "613529"
  },
  {
    "text": "what you can do using jq1 you know the first example is let's say I want to",
    "start": "613529",
    "end": "618839"
  },
  {
    "text": "find out anytime somebody creates a namespace so the first line is what we're gonna do the selecting on we're",
    "start": "618839",
    "end": "625140"
  },
  {
    "text": "gonna say show me the objects where the ver the value of the verb property in the object is create and then where this",
    "start": "625140",
    "end": "632699"
  },
  {
    "text": "is like a nested search where object referee source is namespaces so somebody's doing a create and they're",
    "start": "632699",
    "end": "638790"
  },
  {
    "text": "doing it to a namespace the namespaces resource when I do that the string I",
    "start": "638790",
    "end": "644370"
  },
  {
    "text": "want to print you want you to print out is the second line so it's just a plain text string but hey take the time stamp",
    "start": "644370",
    "end": "650579"
  },
  {
    "text": "put some brackets around it so it makes look it makes it look a little bit more like a log and then print out this",
    "start": "650579",
    "end": "655920"
  },
  {
    "text": "string saying namespace was created and then get object graph",
    "start": "655920",
    "end": "660930"
  },
  {
    "text": "okay deleting a namespace is very similar but all we're doing is changing",
    "start": "660930",
    "end": "666749"
  },
  {
    "text": "what the verb is from create to delete this third one's a little bit more fun where we're basically saying like hey",
    "start": "666749",
    "end": "675379"
  },
  {
    "text": "show me the cases where somebody creates a config map and they're really dummies and they put in their AWS private key in",
    "start": "675379",
    "end": "683100"
  },
  {
    "text": "the config map don't do that do secrets instead but if you did do that this would be the way you could look for it",
    "start": "683100",
    "end": "689040"
  },
  {
    "text": "so the first line is very similar it's saying hey show me the objects where somebody's doing it create and the",
    "start": "689040",
    "end": "694410"
  },
  {
    "text": "resource that they're doing is config maps and then the second line is kind of a filter saying okay when I take the",
    "start": "694410",
    "end": "700139"
  },
  {
    "text": "request object and I convert it to a string and then I search in the string do I see AWS access key ID if I see that",
    "start": "700139",
    "end": "708119"
  },
  {
    "text": "then here's the string I want to print out again it's a timestamp and then a message saying hey somebody created this",
    "start": "708119",
    "end": "713610"
  },
  {
    "text": "config map and here's the cop before contents in the config map so you can see exactly what they did wrong",
    "start": "713610",
    "end": "720240"
  },
  {
    "text": "I didn't write just these three I wrote a whole bunch of different ones and you can find them all on github it's a",
    "start": "720240",
    "end": "725490"
  },
  {
    "text": "little just there it's just called JQ filters for kubernetes audit events and I think I got like 20 there's then look",
    "start": "725490",
    "end": "730769"
  },
  {
    "text": "for different use cases so go to town with that okay so that's the hard way um",
    "start": "730769",
    "end": "736829"
  },
  {
    "start": "734000",
    "end": "838000"
  },
  {
    "text": "if you love Jake you stick with Jake you but if you love Falco and you should use",
    "start": "736829",
    "end": "741990"
  },
  {
    "text": "Falco and if you don't know what Falco is I'm gonna make you love Falco so Falco is a recent CN CF project cystic",
    "start": "741990",
    "end": "750029"
  },
  {
    "text": "it owned it for a while we basically moved it over to the CN CF and it's basically a run time activity monitor",
    "start": "750029",
    "end": "756269"
  },
  {
    "text": "what it does is accepts events of various types and then it matches the",
    "start": "756269",
    "end": "761579"
  },
  {
    "text": "events against a bunch of rules to look for notable or suspicious events and when an event is found it basically",
    "start": "761579",
    "end": "767819"
  },
  {
    "text": "sends information about the event to one of a number of outputs back in December",
    "start": "767819",
    "end": "774179"
  },
  {
    "text": "we added support for kubernetes audit events to Falco traditionally it's worked with system calls because that's",
    "start": "774179",
    "end": "780629"
  },
  {
    "text": "kind of the heart of what Falco have been doing and all of what cystic does but we added support for kubernetes",
    "start": "780629",
    "end": "786329"
  },
  {
    "text": "Ogden events back in December we basically added a little embedded web server into the Falco binary",
    "start": "786329",
    "end": "792960"
  },
  {
    "text": "that can be used post these events too and then we wrote you know 30 odd new",
    "start": "792960",
    "end": "798120"
  },
  {
    "text": "rules to look for specific use cases they kind of fell into three different classes on the first one is kind of",
    "start": "798120",
    "end": "805110"
  },
  {
    "text": "suspicious activity this is cases where the rules are pretty opinionated and they're looking for specific notable things or bad things",
    "start": "805110",
    "end": "812450"
  },
  {
    "text": "the second class is just changes to your cluster so this isn't quite so",
    "start": "812450",
    "end": "817680"
  },
  {
    "text": "opinionated but it is letting you know anytime somebody tries to create something or delete something or modify",
    "start": "817680",
    "end": "823170"
  },
  {
    "text": "something and the final class is if you don't get what you want out of the",
    "start": "823170",
    "end": "828390"
  },
  {
    "text": "anything else we do have one rule which is literally print every audit event we get you probably don't want to turn that",
    "start": "828390",
    "end": "834030"
  },
  {
    "text": "on in production but it's a good thing for like debugging type stuff so here's",
    "start": "834030",
    "end": "840420"
  },
  {
    "start": "838000",
    "end": "902000"
  },
  {
    "text": "the architectural diagram of Falco just because you can kind of see the flow of the messages and how it works",
    "start": "840420",
    "end": "845480"
  },
  {
    "text": "everything in the dashed blue box is the Falco binary itself it kind of starts",
    "start": "845480",
    "end": "850650"
  },
  {
    "text": "with these rules the Falco rules and the C my lower right and also your lower",
    "start": "850650",
    "end": "856050"
  },
  {
    "text": "right and the rules get loaded up into a rule engine and then they just accept",
    "start": "856050",
    "end": "861210"
  },
  {
    "text": "events from a variety of sources to see if the events match one of the rules traditionally it works with system calls",
    "start": "861210",
    "end": "867630"
  },
  {
    "text": "so we have this kernel module for system calls but importantly for kubernetes audit support it all comes from this",
    "start": "867630",
    "end": "873900"
  },
  {
    "text": "embedded web server so you enable kubernetes audit support and your API",
    "start": "873900",
    "end": "879240"
  },
  {
    "text": "server have it post to the web hook our web server picks it up takes to the",
    "start": "879240",
    "end": "884370"
  },
  {
    "text": "events matches it against the rules and then when an event matches one of the rules we send it to one of the outputs",
    "start": "884370",
    "end": "890670"
  },
  {
    "text": "so you can send it to like syslog brought it to a log file post it to a slack web hook send an email make pagers",
    "start": "890670",
    "end": "897480"
  },
  {
    "text": "go off if everybody still has a pager so that kind of stuff here's an example of",
    "start": "897480",
    "end": "904860"
  },
  {
    "start": "902000",
    "end": "1073000"
  },
  {
    "text": "what the Falco rule an example Falco rule looks like again we're using this",
    "start": "904860",
    "end": "910260"
  },
  {
    "text": "use case of a config map with private credentials in it we'll just kind of walk through a top to bottom so there's",
    "start": "910260",
    "end": "916260"
  },
  {
    "text": "two kinds of uh this is all yam all there's two kinds of objects here there's macros and rules macros are kind",
    "start": "916260",
    "end": "922290"
  },
  {
    "text": "of just used for code reuse in structure and that kind of stuff so the first macro is called create private",
    "start": "922290",
    "end": "929380"
  },
  {
    "text": "credentials and the condition field is basically a filter that a little filter snippet that we're using to match",
    "start": "929380",
    "end": "935980"
  },
  {
    "text": "against the events in this case we're saying hey it's a like a logical",
    "start": "935980",
    "end": "941830"
  },
  {
    "text": "expression combined with these field names and then it resorts results in a true or false value in this case we're",
    "start": "941830",
    "end": "947560"
  },
  {
    "text": "saying kar ik dot config map object which is basically in the request is",
    "start": "947560",
    "end": "953320"
  },
  {
    "text": "there a config map object and if so give me that as a string and we're just",
    "start": "953320",
    "end": "958690"
  },
  {
    "text": "looking for AWS access key ID or s3 access key ID or password obviously if",
    "start": "958690",
    "end": "966190"
  },
  {
    "text": "you put your password in your config map but you didn't name it password we won't find it but if you did that you're",
    "start": "966190",
    "end": "972430"
  },
  {
    "text": "probably not dumb enough to put your password in the config map in the first place so I'm not worried about those",
    "start": "972430",
    "end": "977920"
  },
  {
    "text": "guys we're worried about the slightly dumber guys so that's the first macro the next macro is basically just called",
    "start": "977920",
    "end": "984610"
  },
  {
    "text": "the config map and it's saying is the target resource config maps again for",
    "start": "984610",
    "end": "990190"
  },
  {
    "text": "each of these fields we're extracting that data out of the JSON audit event we already showed you okay and the third",
    "start": "990190",
    "end": "998020"
  },
  {
    "text": "macro is called modifying we're just saying hey is the verb part of the audit event either create or update or patch",
    "start": "998020",
    "end": "1005220"
  },
  {
    "text": "okay now we have a rule rules have names in this case it's create modify config",
    "start": "1005220",
    "end": "1011250"
  },
  {
    "text": "map with private credentials on they have a description which is nice for output purposes and then they have the",
    "start": "1011250",
    "end": "1016980"
  },
  {
    "text": "condition again where we're filtering against the audit events to see if something matches or doesn't match and",
    "start": "1016980",
    "end": "1022170"
  },
  {
    "text": "we're just taking all the macros and just putting them together with ands so it was a config map and it was a modify",
    "start": "1022170",
    "end": "1028530"
  },
  {
    "text": "action and when you go look at the contents of the config map it had something shady and it like a password",
    "start": "1028530",
    "end": "1035510"
  },
  {
    "text": "when the event matches we have to decide what string to send to our outputs and that's controlled by this output",
    "start": "1035510",
    "end": "1041490"
  },
  {
    "text": "property on the object it's kind of a mix of plaintext and thus printf style fields again the values of these fields",
    "start": "1041490",
    "end": "1049440"
  },
  {
    "text": "come from the audit event itself we kind of run it through a glorified version of sprint up and then that's the message",
    "start": "1049440",
    "end": "1054870"
  },
  {
    "text": "we're going to send off to the emails and slack and so forth okay and",
    "start": "1054870",
    "end": "1060880"
  },
  {
    "text": "then we have like priority so you can do some you know severity matching and only you know really can't make the pages go",
    "start": "1060880",
    "end": "1066279"
  },
  {
    "text": "off or the Critical stuff but not the debug stuff and and you could have tags so you can group rules together okay so",
    "start": "1066279",
    "end": "1075100"
  },
  {
    "start": "1073000",
    "end": "1132000"
  },
  {
    "text": "what I thought we'd do now is let's kind of jump into some ideas about how to use audit logs you know to match some",
    "start": "1075100",
    "end": "1083260"
  },
  {
    "text": "security use cases and for that what kind of you will kind of refer to some",
    "start": "1083260",
    "end": "1088840"
  },
  {
    "text": "of the Falco rules for how to do that though obviously you can do it just as easily using anything else though we",
    "start": "1088840",
    "end": "1094270"
  },
  {
    "text": "love Falco so the first thing is maybe you just want to know what's going on right you're not particularly",
    "start": "1094270",
    "end": "1100559"
  },
  {
    "text": "opinionated to look for bad activity but you just want to see all the changes",
    "start": "1100559",
    "end": "1105610"
  },
  {
    "text": "that are happening to your cluster so we have a bunch of rules that look for all that stuff so kubernetes deployment",
    "start": "1105610",
    "end": "1111429"
  },
  {
    "text": "created or deleted service created or deleted all that kind of stuff both the",
    "start": "1111429",
    "end": "1116500"
  },
  {
    "text": "main resources and also like our back stuff so when you create service accounts or roles or role bindings we'll",
    "start": "1116500",
    "end": "1121899"
  },
  {
    "text": "see all that stuff as well so this isn't it's more about tracking changes and",
    "start": "1121899",
    "end": "1127750"
  },
  {
    "text": "giving visibility than looking for a specific bad behavior okay so getting a",
    "start": "1127750",
    "end": "1135220"
  },
  {
    "start": "1132000",
    "end": "1192000"
  },
  {
    "text": "little bit more opinionated let's say one thing you want to do is you want to just like define what's allowed like",
    "start": "1135220",
    "end": "1142020"
  },
  {
    "text": "only let certain users do stuff to my cluster or only let pods run if the",
    "start": "1142020",
    "end": "1148899"
  },
  {
    "text": "image is in a set of images that I say are okay or only let people run in the",
    "start": "1148899",
    "end": "1154870"
  },
  {
    "text": "production namespace and the dev namespace but not the super hacker or a crypto mining namespace there's somebody",
    "start": "1154870",
    "end": "1160000"
  },
  {
    "text": "created that you didn't find out about until two months later when you wonder why your AWS bill is 10 grand if you're",
    "start": "1160000",
    "end": "1166059"
  },
  {
    "text": "lucky so we have a bunch of rules that look for that kind of stuff and each of these rules is basically associated with",
    "start": "1166059",
    "end": "1171820"
  },
  {
    "text": "a list so along with disallowed gates user there's a list of allowed keith's",
    "start": "1171820",
    "end": "1177700"
  },
  {
    "text": "users and then it's just matching the user against the contents of the list I know someone told me that all security",
    "start": "1177700",
    "end": "1183460"
  },
  {
    "text": "is just list matching and but yeah it is in this case but it's probably some more okay so that's kind of the idea for that",
    "start": "1183460",
    "end": "1190630"
  },
  {
    "text": "one now if you want to get even more opinionated where you're looking for more specific use cases we we can do",
    "start": "1190630",
    "end": "1197679"
  },
  {
    "text": "like another set of class of rules so maybe you want to be maybe you want to",
    "start": "1197679",
    "end": "1203440"
  },
  {
    "text": "limit what pods can access if you want to say okay good no don't leave you",
    "start": "1203440",
    "end": "1211149"
  },
  {
    "text": "can't go to the keynote lock the doors okay so if you want to get a little more",
    "start": "1211149",
    "end": "1218260"
  },
  {
    "text": "opinionated let's say you want to limit what pods can do you know following the principles of least privilege let's try",
    "start": "1218260",
    "end": "1224350"
  },
  {
    "text": "to explicitly enumerate what your pod really needs to do to do its job and not give it any more privileges than that so",
    "start": "1224350",
    "end": "1231100"
  },
  {
    "text": "we have one rule that's create privileged pod that basically just looks for anybody starting a pod where they set the privilege true flag you know",
    "start": "1231100",
    "end": "1238389"
  },
  {
    "text": "maybe there's a good case to do it but generally you at least want to be aware of it and might want to take stronger",
    "start": "1238389",
    "end": "1243429"
  },
  {
    "text": "actions based on that so that's one rule that we have another one is create",
    "start": "1243429",
    "end": "1248830"
  },
  {
    "text": "sensitive mount pod what that does is we basically look to see what mounts you",
    "start": "1248830",
    "end": "1254590"
  },
  {
    "text": "have for the pod when you create it and we see if they're mounting paths from the hosts file system and then for some",
    "start": "1254590",
    "end": "1261070"
  },
  {
    "text": "paths we consider them sensitive so for example if somebody tried to mount Etsy",
    "start": "1261070",
    "end": "1267220"
  },
  {
    "text": "shadow from the host into your pod probably not a great idea or if they tried to mount proc or if they tried to",
    "start": "1267220",
    "end": "1273399"
  },
  {
    "text": "mount the docker socket or if they tried to mount Etsy crontab so they could launch other attacks directly on the",
    "start": "1273399",
    "end": "1279519"
  },
  {
    "text": "host we have a fun blog post about that in crypto mining so we have a rule that basically looks on that we declare some",
    "start": "1279519",
    "end": "1285220"
  },
  {
    "text": "paths on the host to be sensitive and if somebody creates a pod that mounts any of them that's when that rule kicks in",
    "start": "1285220",
    "end": "1292590"
  },
  {
    "text": "another one is creating a pod with host networking to be true generally if you",
    "start": "1292590",
    "end": "1298659"
  },
  {
    "text": "can get away with it try to keep the pods in their own network namespace maybe you don't have maybe you have a",
    "start": "1298659",
    "end": "1303669"
  },
  {
    "text": "good reason for that but at least it's something you might want to be aware of and then another one is creating a pod",
    "start": "1303669",
    "end": "1309970"
  },
  {
    "text": "in the cube any of the cube namespaces so you probably shouldn't be over there you should be on your in your own sandbox so if that we have a rule for",
    "start": "1309970",
    "end": "1316570"
  },
  {
    "text": "that as well and then the dual of this class of rules is instead of limiting what pods can",
    "start": "1316570",
    "end": "1323249"
  },
  {
    "text": "access we can limit access to pods so even if you were really smart and you made sure that on only a couple of pods",
    "start": "1323249",
    "end": "1330960"
  },
  {
    "text": "were running privileged if you let anybody exact into any pod somebody can just exec in exactly into one of your",
    "start": "1330960",
    "end": "1337109"
  },
  {
    "text": "privileged pods and now they can do anything that pod can do so it's a great",
    "start": "1337109",
    "end": "1342299"
  },
  {
    "text": "Avenue for privilege escalations so something you want to really be aware of so we have a rule that basically looks",
    "start": "1342299",
    "end": "1347549"
  },
  {
    "text": "for that is saying hey somebody's trying to exact into a pod and we'll let you know about it we have a bunch of rules",
    "start": "1347549",
    "end": "1355950"
  },
  {
    "start": "1354000",
    "end": "1574000"
  },
  {
    "text": "devoted to like users and account level stuff so we have a rule service account created in the cube namespace so this is",
    "start": "1355950",
    "end": "1363359"
  },
  {
    "text": "exactly that you're any service count and you're and one of the cube namespaces probably shouldn't be over there",
    "start": "1363359",
    "end": "1369749"
  },
  {
    "text": "another one system cluster role modified or deleted if you're doing any action on",
    "start": "1369749",
    "end": "1374839"
  },
  {
    "text": "cluster roles and the name of the role start - a system that's kind of like a reserved thing for vanilla kubernetes",
    "start": "1374839",
    "end": "1381149"
  },
  {
    "text": "probably shouldn't be doing that so we'll let you know if somebody tries these view are about being lazy when",
    "start": "1381149",
    "end": "1388979"
  },
  {
    "text": "you're defining your roles so when you're defining your roles you really should be limited to only explicitly",
    "start": "1388979",
    "end": "1396929"
  },
  {
    "text": "enumerate the things you want and don't ask for anything else don't give them anything else than what they really need",
    "start": "1396929",
    "end": "1402599"
  },
  {
    "text": "to run so if you're writing one of these roles and you're new to our back and you're like oh my god what does all this",
    "start": "1402599",
    "end": "1408539"
  },
  {
    "text": "yeah mole but you saw like oh there's this cluster admin if I had to do that I can just do the things I want to do",
    "start": "1408539",
    "end": "1414440"
  },
  {
    "text": "that's a good idea if you're just learning out but it's probably not a great idea later because",
    "start": "1414440",
    "end": "1420629"
  },
  {
    "text": "cluster admin can do all kinds of stuff so probably not a rule binding that you want to grant and so we ever we have a",
    "start": "1420629",
    "end": "1427080"
  },
  {
    "text": "rule for that um when you're defining your role you might be a little bit lazy and you might say you know what I'm just",
    "start": "1427080",
    "end": "1433379"
  },
  {
    "text": "gonna let people do anything to pods so for the for the verb I'll just say star",
    "start": "1433379",
    "end": "1440099"
  },
  {
    "text": "or I'll say you know what I'm gonna let people do crates or maybe lists on",
    "start": "1440099",
    "end": "1446580"
  },
  {
    "text": "anything so I'll explicitly say get or yeah view or list only but then for the",
    "start": "1446580",
    "end": "1452160"
  },
  {
    "text": "resources I'll just put star so if you do that probably not a great idea it'd be much better if you explicitly laid",
    "start": "1452160",
    "end": "1459270"
  },
  {
    "text": "out the things that you needed and so if you have that we that's what this rule is looking for it's looking for people where they're trying to wild-card either",
    "start": "1459270",
    "end": "1465840"
  },
  {
    "text": "the resources or the verbs when they're defining their role",
    "start": "1465840",
    "end": "1471360"
  },
  {
    "text": "a couple either a couple easier ones that are more specific so if somebody cries tries to create a cluster role",
    "start": "1471360",
    "end": "1477420"
  },
  {
    "text": "that has right privileges will let you know about it obviously there's great great use cases for it but there might be cases where um you at least want to",
    "start": "1477420",
    "end": "1486270"
  },
  {
    "text": "be notified when somebody's doing it and another one this is getting back to this idea of privilege escalation in pods",
    "start": "1486270",
    "end": "1492410"
  },
  {
    "text": "even if you didn't let anybody actually exec into in Depaz but you left the our",
    "start": "1492410",
    "end": "1501000"
  },
  {
    "text": "backside open they could just basically create a role that lets them executive pods even though you didn't let them and",
    "start": "1501000",
    "end": "1507450"
  },
  {
    "text": "then they'll be able to executive pods so it's kind of like a second order security problem so if you've tried to",
    "start": "1507450",
    "end": "1513900"
  },
  {
    "text": "create a role that allows the pod exec privilege we'll let you know about it and then a few I couldn't easily",
    "start": "1513900",
    "end": "1521280"
  },
  {
    "text": "categorize but I still wanted to talk about we already talked about this one the creating the config map with the",
    "start": "1521280",
    "end": "1526440"
  },
  {
    "text": "secret stuff in it there's this there's this one where um it's a little bit legacy but if you create a request and",
    "start": "1526440",
    "end": "1533460"
  },
  {
    "text": "you don't actually have authentication configured properly you end up end up being this anonymous user so we have a",
    "start": "1533460",
    "end": "1538890"
  },
  {
    "text": "rule that says hey somebody who is acting as the anonymous user is doing anything and you're not really supposed to be doing that and one final one is if",
    "start": "1538890",
    "end": "1546870"
  },
  {
    "text": "you create a service you know you have a lot of choices for how to route stuff in the service and one of them is node port",
    "start": "1546870",
    "end": "1552480"
  },
  {
    "text": "which is not super great because it opens the port up on every node so if",
    "start": "1552480",
    "end": "1558270"
  },
  {
    "text": "you try to do that maybe you could find a better way to do it and we'll give you a rule that will let you know if somebody's trying to create services",
    "start": "1558270",
    "end": "1564360"
  },
  {
    "text": "that way all right so let's do some demos",
    "start": "1564360",
    "end": "1571070"
  },
  {
    "start": "1574000",
    "end": "2034000"
  },
  {
    "text": "okay so we got three windows here in the top window I'm just gonna do some cube",
    "start": "1574910",
    "end": "1581010"
  },
  {
    "text": "stuff in the middle window I'm basically I've set up a file based audit logging",
    "start": "1581010",
    "end": "1586890"
  },
  {
    "text": "and I'm just gonna tail it through the log and kind of watch all of the events go by and I've set up all of those JQ",
    "start": "1586890",
    "end": "1594150"
  },
  {
    "text": "filters that I talked about earlier to basically look for a bunch of suspicious and notable activity in the audit stream",
    "start": "1594150",
    "end": "1599820"
  },
  {
    "text": "and in the bottom I've got a copy of Falco running in the cluster as a daemon",
    "start": "1599820",
    "end": "1606300"
  },
  {
    "text": "set where it's got all of the kubernetes audit events set up and we've configured",
    "start": "1606300",
    "end": "1611760"
  },
  {
    "text": "the API server to route events to the Falco service which is inside the cluster so the middle window and the",
    "start": "1611760",
    "end": "1619140"
  },
  {
    "text": "bottom window should be pretty much the same I'm just showing that there's like two ways to do it though we love Falco",
    "start": "1619140",
    "end": "1624210"
  },
  {
    "text": "and you should all use Falco okay so let's let's do something easy we'll just",
    "start": "1624210",
    "end": "1634500"
  },
  {
    "text": "create a simple deployment based on nginx so you can see that it showed up",
    "start": "1634500",
    "end": "1640800"
  },
  {
    "text": "in both both things it showed up a little quicker in the audit log based one mostly because there isn't any",
    "start": "1640800",
    "end": "1647670"
  },
  {
    "text": "batching there so the you know it's just reading the file it just says the second it gets written and it's not waiting to",
    "start": "1647670",
    "end": "1653850"
  },
  {
    "text": "batch up any events and send them to the API server so it shows up a little bit quicker there but it shows up easily in",
    "start": "1653850",
    "end": "1659820"
  },
  {
    "text": "both and you can see it's like hey somebody created a deployment the name is nginx deployment and the image for",
    "start": "1659820",
    "end": "1666780"
  },
  {
    "text": "Falco we actually add a little bit more information like the user in this case mini Hugh the namespace where they were",
    "start": "1666780",
    "end": "1674040"
  },
  {
    "text": "doing it the are back to decision not kind of stuff and so we'll just go just",
    "start": "1674040",
    "end": "1682620"
  },
  {
    "text": "delete that point deployment",
    "start": "1682620",
    "end": "1686180"
  },
  {
    "text": "so we delete it and you can see it's showing up here both in the JQ log and the Falcon log so we can do the same",
    "start": "1698330",
    "end": "1705930"
  },
  {
    "text": "thing for maybe something like a service",
    "start": "1705930",
    "end": "1709670"
  },
  {
    "text": "same thing showing up here showing up here and same thing when we delete it so",
    "start": "1713570",
    "end": "1726750"
  },
  {
    "text": "this is like out of that first class where you're just trying to track the changes but you're not like particularly opinionated to understand what's going",
    "start": "1726750",
    "end": "1732809"
  },
  {
    "text": "on okay all right let me check my little cheat sheet here",
    "start": "1732809",
    "end": "1738500"
  },
  {
    "text": "okay so let's do some stuff for some more stuff related to config Maps here's",
    "start": "1742020",
    "end": "1751180"
  },
  {
    "text": "a sample config map this is getting into that config maps with passwords in it so here's a simple config map up here we",
    "start": "1751180",
    "end": "1757480"
  },
  {
    "text": "got the contents of the config map and look I'm a dummy I put my AWS access key and the kid big map so not a good idea",
    "start": "1757480",
    "end": "1764200"
  },
  {
    "text": "so we'll just go create that and kind of see what happens",
    "start": "1764200",
    "end": "1768690"
  },
  {
    "text": "so when I created the config map I can see hey somebody created config map with",
    "start": "1775020",
    "end": "1780160"
  },
  {
    "text": "this secret stuff in it and I'm letting you know about it with Falco we also include like the verb the name of the",
    "start": "1780160",
    "end": "1786940"
  },
  {
    "text": "config map and the user and all that kind of stuff ok ok so let's do a",
    "start": "1786940",
    "end": "1796350"
  },
  {
    "text": "student exec so we'll create my nginx deployment again and what we're going to",
    "start": "1796350",
    "end": "1807730"
  },
  {
    "text": "do is we're just going to exec into this nginx pod once we go there we go",
    "start": "1807730",
    "end": "1814740"
  },
  {
    "text": "okay so we exactly Intuit running a shell and now we have all the all the powers that you've granted to then nginx",
    "start": "1823690",
    "end": "1829460"
  },
  {
    "text": "deployment but because we've noted the pod exec both in JQ and Falco we will",
    "start": "1829460",
    "end": "1834950"
  },
  {
    "text": "let you know that somebody tried to do the exec it's basically going through the API server and it's just a get on the pods exec resource you can you we",
    "start": "1834950",
    "end": "1852290"
  },
  {
    "text": "can do that with Falco but not using the kubernetes audit events because those once you have the exec session open I'm",
    "start": "1852290",
    "end": "1858950"
  },
  {
    "text": "sorry the question was can you see all the commands that the person is now typing now that they exact you can do",
    "start": "1858950",
    "end": "1865640"
  },
  {
    "text": "that if you use the system call based stuff and we have something that's a little bit like that though it's pretty",
    "start": "1865640",
    "end": "1871730"
  },
  {
    "text": "false puzzled approach you'd have to be pretty targeted for it but you could basically look for execs the exact",
    "start": "1871730",
    "end": "1877130"
  },
  {
    "text": "system call and then you could see the commands that they are running okay so",
    "start": "1877130",
    "end": "1882679"
  },
  {
    "text": "let's do some stuff with our back so the simple thing is first let's just create a service count you can see",
    "start": "1882679",
    "end": "1890139"
  },
  {
    "text": "you can see like just like all of their resources when somebody creates a",
    "start": "1894920",
    "end": "1900980"
  },
  {
    "text": "service account we can see that in the audit events as well all right so let's do a little bit more interesting stuff",
    "start": "1900980",
    "end": "1909340"
  },
  {
    "text": "so here's a cluster role in cluster role binding where we basically gotten lazy",
    "start": "1909610",
    "end": "1914690"
  },
  {
    "text": "about the resources that we have and we're saying hey well let somebody do a get but we won't say what they can get",
    "start": "1914690",
    "end": "1920570"
  },
  {
    "text": "we'll just lay a they'll let them get everything not a great idea so when we",
    "start": "1920570",
    "end": "1926570"
  },
  {
    "text": "try to do that",
    "start": "1926570",
    "end": "1929139"
  },
  {
    "text": "you can see that both in the ghj queue based output and the falco based output because we're looking for the config map",
    "start": "1934429",
    "end": "1940920"
  },
  {
    "text": "we're sorry for the for the cluster role looking at it seeing that there's a wild card in there and we'll let you know",
    "start": "1940920",
    "end": "1946020"
  },
  {
    "text": "about it okay another one so let's look at the one",
    "start": "1946020",
    "end": "1951480"
  },
  {
    "text": "where you try to grant permissions to pod exact even though you weren't able to pod exec before so here's another",
    "start": "1951480",
    "end": "1959460"
  },
  {
    "text": "cluster role in custom role binding where we're basically grant trying to grant ourself the ability to exact into",
    "start": "1959460",
    "end": "1964920"
  },
  {
    "text": "pods in this case the resources pods exec and the reverb has get",
    "start": "1964920",
    "end": "1970970"
  },
  {
    "text": "so when we greet that again Falco's detecting it and JQ is detecting it saying hey somebody created a cluster",
    "start": "1980970",
    "end": "1988180"
  },
  {
    "text": "role where they're trying to get grant the ability to executive pods so let you know about it and then you can decide",
    "start": "1988180",
    "end": "1993730"
  },
  {
    "text": "what you do after that in the last one let's say you just want to try to",
    "start": "1993730",
    "end": "2000750"
  },
  {
    "text": "squirrel your bad stuff away in a namespace so I'm going to create some",
    "start": "2000750",
    "end": "2011280"
  },
  {
    "text": "namespace called secret namespace put all my bad stuff in there and all my crypto mining and stuff well you do that well will detect that to you because",
    "start": "2011280",
    "end": "2017330"
  },
  {
    "text": "number one we can detect when the namespace code created and then also if you had this allowed list not allowed",
    "start": "2017330",
    "end": "2023880"
  },
  {
    "text": "list we'll check it against the list and let you know it's outside of the list of things that we expected to see",
    "start": "2023880",
    "end": "2030559"
  },
  {
    "start": "2034000",
    "end": "2095000"
  },
  {
    "text": "all righty so hopefully you're super psyched about kubernetes audit logs or hopefully Falco because we love Falco so",
    "start": "2034299",
    "end": "2041660"
  },
  {
    "text": "here we've got all the links for you Falco org is the main site for Falco we",
    "start": "2041660",
    "end": "2046760"
  },
  {
    "text": "have a public slack and there's a Falco Channel on there where you can learn more about Falco we got a bunch of blog",
    "start": "2046760",
    "end": "2054050"
  },
  {
    "text": "post where we talked about Falco use cases and that kind of stuff it's all open source so you can just get the",
    "start": "2054050",
    "end": "2059358"
  },
  {
    "text": "source code on github we got Doc's there and you know we published docker images of all the",
    "start": "2059359",
    "end": "2064970"
  },
  {
    "text": "software so you can learn more about the images and that kind of stuff and I think I was supposed to say sche decom",
    "start": "2064970",
    "end": "2072740"
  },
  {
    "text": "if you love this talk and love Falco go review the talk there is that right all right there you go all right thanks a",
    "start": "2072740",
    "end": "2078560"
  },
  {
    "text": "lot",
    "start": "2078560",
    "end": "2080590"
  },
  {
    "text": "I don't know if we have nope did we have time for questions did not just come up",
    "start": "2084200",
    "end": "2090079"
  },
  {
    "text": "and ask me questions alright thanks",
    "start": "2090079",
    "end": "2093879"
  }
]