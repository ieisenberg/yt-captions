[
  {
    "text": "hello everyone so today I'm excited to share with you an intriguing success story the migration of the web",
    "start": "40",
    "end": "5640"
  },
  {
    "text": "enrichement platform to Envoy um so this is a story uh of how we",
    "start": "5640",
    "end": "10719"
  },
  {
    "text": "at Spotify revamp or web proxy layer to use Envoy obviously uh we'll dive into",
    "start": "10719",
    "end": "16160"
  },
  {
    "text": "some technical details share the lessons that we learned and how a bigger picture of how this looked for us but I want to",
    "start": "16160",
    "end": "23279"
  },
  {
    "text": "mention that we are initiating this endeavor with a purpose uh to present to our peers a practical application of",
    "start": "23279",
    "end": "29480"
  },
  {
    "text": "Envoy Our intention is to share some experiences the lessons that we learned",
    "start": "29480",
    "end": "34520"
  },
  {
    "text": "as I said and challenges that we've encountered while adopting aoy and we hope that by doing so we can",
    "start": "34520",
    "end": "41039"
  },
  {
    "text": "initiate some fruitful discussions about the future and uh potential improvements and future uh feature that we can uh",
    "start": "41039",
    "end": "48840"
  },
  {
    "text": "make all make together so yeah today we have a concise",
    "start": "48840",
    "end": "55280"
  },
  {
    "text": "yet impactful agenda we're going to start by presenting the Spotify perameter there U we're going to show an",
    "start": "55280",
    "end": "61280"
  },
  {
    "text": "overview of our operational scope then we're going to zoom in into the web management platform and we want to tell",
    "start": "61280",
    "end": "68040"
  },
  {
    "text": "you about how this is a key component uh that enriches our ecosystem then we're going to explore",
    "start": "68040",
    "end": "74080"
  },
  {
    "text": "the motivation behind our migration um and also uh share some technical",
    "start": "74080",
    "end": "79200"
  },
  {
    "text": "insights into the actual migration work to conclude we're going to wrap up and look at um the migration process and um",
    "start": "79200",
    "end": "88159"
  },
  {
    "text": "look ahead at our vision and evolving infrastructure so with no further Ado uh",
    "start": "88159",
    "end": "93880"
  },
  {
    "text": "let's embark on this journey together exploring technological evolution of Spotify but yeah first and foremost",
    "start": "93880",
    "end": "101119"
  },
  {
    "text": "allow me to introduce ourselves uh my name is Sabrina zotti I am a software engineer at Spotify I'm based in Milan",
    "start": "101119",
    "end": "108680"
  },
  {
    "text": "Italy and today I have the privilege to present alongside Oliver Soul staff engineer Spotify based in Stockholm",
    "start": "108680",
    "end": "116280"
  },
  {
    "text": "Sweden uh Oliver and I both work within the computer networking product area at Spotify and specifically we are part of",
    "start": "116280",
    "end": "123520"
  },
  {
    "text": "the ATC team with a primary focus on the design and management of spotify's",
    "start": "123520",
    "end": "129039"
  },
  {
    "text": "infrastructure perimeter I will now leave the spotlight to Oliver to introduce our",
    "start": "129039",
    "end": "135720"
  },
  {
    "text": "work thanks Sabrina so we'll talk today about our web enrichment platform but",
    "start": "135720",
    "end": "141280"
  },
  {
    "text": "before we do that let's zoom out and talk a little bit about spotify's overall perimeter which can provide some",
    "start": "141280",
    "end": "147319"
  },
  {
    "text": "context for our presentation Spotify runs back-end services in Google's Cloud",
    "start": "147319",
    "end": "152680"
  },
  {
    "text": "platform and traffic from Spotify clients like mobile apps TVs cars",
    "start": "152680",
    "end": "158040"
  },
  {
    "text": "refrigerators what have you are routed through a Google Cloud load balancer just behind that load balancer we have",
    "start": "158040",
    "end": "164360"
  },
  {
    "text": "our Envoy based Edge proxy layer in all five of our gcp regions we presented our",
    "start": "164360",
    "end": "170080"
  },
  {
    "text": "Edge proxy migration story here at Envoy Con in 2019 and we'd be happy to take questions about that later or anytime",
    "start": "170080",
    "end": "176400"
  },
  {
    "text": "during the day just a side note many of you may be curious as an audio service",
    "start": "176400",
    "end": "181879"
  },
  {
    "text": "of course our clients need the audio files themselves those are streamed from a CDN and we're not going to talk about",
    "start": "181879",
    "end": "187519"
  },
  {
    "text": "those today Edge proxy however takes between uh 6 and 10 million RPS every day uh",
    "start": "187519",
    "end": "194920"
  },
  {
    "text": "here's a recent graph of a week's traffic by gcp region however the vast majority of that",
    "start": "194920",
    "end": "200920"
  },
  {
    "text": "traffic is our service traffic like when your Spotify client needs to load a new playlist or you add a track to your",
    "start": "200920",
    "end": "207120"
  },
  {
    "text": "liked songs only about 1 % of our traffic is web traffic and you can",
    "start": "207120",
    "end": "212280"
  },
  {
    "text": "imagine that that traffic has much different patterns and more specific needs in a proxy layer than our regular",
    "start": "212280",
    "end": "218120"
  },
  {
    "text": "service traffic we route the web traffic through Edge proxy and then to our web enrichment platform which has many web",
    "start": "218120",
    "end": "225120"
  },
  {
    "text": "specific capabilities that our web service owners rely on that's what we'll dive into today and Sabrina is going to",
    "start": "225120",
    "end": "231400"
  },
  {
    "text": "tell you a little more about that thank you Oliver so before zooming",
    "start": "231400",
    "end": "237680"
  },
  {
    "text": "into to the web arrangement platform I'd like to start by mentioning an interesting fact so 3 years ago when the",
    "start": "237680",
    "end": "244640"
  },
  {
    "text": "web enement platform was created back then it was team nibler uh the primary goal of this project is to was to",
    "start": "244640",
    "end": "251159"
  },
  {
    "text": "dismantle this monolitic system supporting da spotify.com um into",
    "start": "251159",
    "end": "257079"
  },
  {
    "text": "separate web services developed by different team obviously um to make a long story short this project uh",
    "start": "257079",
    "end": "263440"
  },
  {
    "text": "resulted in the development of the platform uh that we are now going to present uh that allows the seg",
    "start": "263440",
    "end": "269639"
  },
  {
    "text": "segregation of client facing application from common business logic concerns but",
    "start": "269639",
    "end": "274960"
  },
  {
    "text": "not only that as well as uh also breaking up the monolit in multiple linear simpler",
    "start": "274960",
    "end": "280759"
  },
  {
    "text": "applications um this aspect of the platform uh c a lot of attention and",
    "start": "280759",
    "end": "286639"
  },
  {
    "text": "became quite popular within Spotify and fast forward to today uh the web nment",
    "start": "286639",
    "end": "291800"
  },
  {
    "text": "platform is now standard for the web uh for the web traffic so um about the web enement",
    "start": "291800",
    "end": "299560"
  },
  {
    "text": "platform so you might wonder what this is exactly it's an infrastructure designed to handle the routing and the",
    "start": "299560",
    "end": "305880"
  },
  {
    "text": "enrichment of the web requests from an architectural perspective it consists of three layers so a configuration layer a",
    "start": "305880",
    "end": "312880"
  },
  {
    "text": "routing layer obviously and the enrichment layer takeaway until now is that all requests uh directed to Spotify",
    "start": "312880",
    "end": "320840"
  },
  {
    "text": "will pass uh through the web enrichment platform but let's backtrack for a",
    "start": "320840",
    "end": "326319"
  },
  {
    "text": "moment so Oliver mentioned uh the concept of edge proxy right so uh if you",
    "start": "326319",
    "end": "331960"
  },
  {
    "text": "tuned in in our previous presentation in 2019 Edge proxy serves as the initial point of entry for all the requests that",
    "start": "331960",
    "end": "338840"
  },
  {
    "text": "hit Spotify and that still stands however in the case of web services Edge",
    "start": "338840",
    "end": "344039"
  },
  {
    "text": "proxy directs the request utilize the web enrichement platform So within the routing layer the request can be",
    "start": "344039",
    "end": "350639"
  },
  {
    "text": "configured to either directly access the web service meaning that it will only use the routing uh component of the",
    "start": "350639",
    "end": "357199"
  },
  {
    "text": "platform or it can be enhanced with enrichments uh more on that on the next",
    "start": "357199",
    "end": "362319"
  },
  {
    "text": "slide but currently the routing layer is based on Envoy and direct the request to",
    "start": "362319",
    "end": "368199"
  },
  {
    "text": "the appropriate web service the enrichment layer is a tool a",
    "start": "368199",
    "end": "373240"
  },
  {
    "text": "feature that allows developers to incorporate business logic into their requests such as cookie handling market",
    "start": "373240",
    "end": "380280"
  },
  {
    "text": "analysis and or even compliance to information standards like csrf or",
    "start": "380280",
    "end": "387000"
  },
  {
    "text": "CSP but what does the enrichment l actually look like in practice uh once",
    "start": "387080",
    "end": "392440"
  },
  {
    "text": "the request reaches the web enrichment platform during the routing phase the platform will verify whether the request",
    "start": "392440",
    "end": "398919"
  },
  {
    "text": "should be enhanced with some uh business logic or not if yes the router will",
    "start": "398919",
    "end": "404080"
  },
  {
    "text": "initiate a sub request to concierge concierge is another uh component of the platform and serves as the enrichment",
    "start": "404080",
    "end": "412520"
  },
  {
    "text": "orchestrator so to ensure a flexible infrastructure the enrichment layer operates based on a plug-in strategy so",
    "start": "412520",
    "end": "420199"
  },
  {
    "text": "concur any member of our organization can develop an enricher which is essentially a library that performs a",
    "start": "420199",
    "end": "426720"
  },
  {
    "text": "specific function uh this approach allows developers to extract business logic that maybe it's not really related",
    "start": "426720",
    "end": "433840"
  },
  {
    "text": "to their application scope and uh this helps them make uh their work more",
    "start": "433840",
    "end": "439840"
  },
  {
    "text": "efficient their application leader and while also providing the rest of the organization with reusable",
    "start": "439840",
    "end": "446440"
  },
  {
    "text": "functionalities we have an actual Direct Tory of enrichers uh kind of like a",
    "start": "446440",
    "end": "451560"
  },
  {
    "text": "marketplace where people can go and browse and search for an enricher that fits the",
    "start": "451560",
    "end": "457080"
  },
  {
    "text": "requirements um if such an enricher doesn't exist then individuals can develop and enable it with the",
    "start": "457080",
    "end": "463080"
  },
  {
    "text": "assistance of Concierge in the web enrichment platform this sounds something like a Marketplace of En",
    "start": "463080",
    "end": "469240"
  },
  {
    "text": "reachers I can say um I think it sounds pretty convenient right so if you think",
    "start": "469240",
    "end": "474840"
  },
  {
    "text": "about it if we developers at Spotify are already using the platform for routing adding this kind of logic here is not a",
    "start": "474840",
    "end": "481919"
  },
  {
    "text": "bad deal uh currently we support four types of enrichments within our system the",
    "start": "481919",
    "end": "487840"
  },
  {
    "text": "first one is content by enricher uh in this case the response will include a",
    "start": "487840",
    "end": "492960"
  },
  {
    "text": "custom status code and optionally a body content uh so in this case uh the",
    "start": "492960",
    "end": "499360"
  },
  {
    "text": "request will not pass through any web service the second one is content by",
    "start": "499360",
    "end": "504400"
  },
  {
    "text": "redirect with this option the response will be a redirect instead of hitting the web service",
    "start": "504400",
    "end": "510120"
  },
  {
    "text": "uh then we have content by proxy uh in this uh this feature applies the instructions at the routing layer uh and",
    "start": "510120",
    "end": "517360"
  },
  {
    "text": "direct the request to the appropriate web service but the web services uh will process the request and will return the",
    "start": "517360",
    "end": "523680"
  },
  {
    "text": "response forther on to the client uh and then we have the final one client response uh if con responds with client",
    "start": "523680",
    "end": "531320"
  },
  {
    "text": "response then this instructions will be implemented and the instructions will only be visible to the client and not to",
    "start": "531320",
    "end": "538320"
  },
  {
    "text": "the web service one important thing to note is that this process involves a mutual exchange of",
    "start": "538320",
    "end": "544519"
  },
  {
    "text": "information kind of like uh for instance when using a content by redirect the request will pass through the web arment",
    "start": "544519",
    "end": "551320"
  },
  {
    "text": "platform multiple times a spoiler uh if this sounds familiar to you you might be on to",
    "start": "551320",
    "end": "558360"
  },
  {
    "text": "something Oliver will now tell you more about the behind the scenes of the configuration",
    "start": "558360",
    "end": "563680"
  },
  {
    "text": "layer thanks Saina okay let's talk about the configuration layer and this this is",
    "start": "563680",
    "end": "569399"
  },
  {
    "text": "where we have to let you in on a little secret the web enrichment platform was originally built around engine X so this",
    "start": "569399",
    "end": "575399"
  },
  {
    "text": "configuration May uh layer may not smell very much like an Envoy control plane but bear with us so how does it work",
    "start": "575399",
    "end": "583279"
  },
  {
    "text": "logically the configuration layer has two responsibilities Transforming Our configuration API into engine X",
    "start": "583279",
    "end": "589200"
  },
  {
    "text": "configuration and Performing service discovery of the Upstream web services but architecturally we need to manage a",
    "start": "589200",
    "end": "596000"
  },
  {
    "text": "fleet of proxies that autoscale and since we don't have control plane we need that configuration logic to be",
    "start": "596000",
    "end": "601720"
  },
  {
    "text": "running alongside each proxy replica the configuration layer then is collocated",
    "start": "601720",
    "end": "607600"
  },
  {
    "text": "next to each proxy replica as another process in the engine X container and runs service Discovery every 30 seconds",
    "start": "607600",
    "end": "614079"
  },
  {
    "text": "dynamically updating the engine X configuration on the other hand when there's an update to the static",
    "start": "614079",
    "end": "620360"
  },
  {
    "text": "configuration like when a new web service is added we make a new deployment of the router",
    "start": "620360",
    "end": "625880"
  },
  {
    "text": "layer uh and the configuration is bundled along with it as we move to Envoy we use the same approach supported",
    "start": "625880",
    "end": "632839"
  },
  {
    "text": "by envoy's Dynamic configuration mechanism the configuration layer simply produces Envoy Amo rather than engine X",
    "start": "632839",
    "end": "640399"
  },
  {
    "text": "configuration and during the migration the configuration layer played a key role in abstracting away the proxy",
    "start": "640399",
    "end": "645920"
  },
  {
    "text": "implementation from our users ideally they would have no idea that we're changing out the engine so to",
    "start": "645920",
    "end": "653880"
  },
  {
    "text": "speak okay so we just covered the overall structure of the web en R platform and now I I'd like to cover",
    "start": "654279",
    "end": "659680"
  },
  {
    "text": "some of our rationale for rebasing the platform to sit on top of envoy there are many reasons we chose to migrate to",
    "start": "659680",
    "end": "666240"
  },
  {
    "text": "Envoy but the primary reason was organizational the team who originally created the web enrichment platform as",
    "start": "666240",
    "end": "672800"
  },
  {
    "text": "Sabrina mentioned they were called Nibbler had seen that Envoy was gaining a foothold at Spotify and that edge",
    "start": "672800",
    "end": "679079"
  },
  {
    "text": "proxy had benefited greatly from using Envoy they also saw the potential of merging the web en ran platform directly",
    "start": "679079",
    "end": "686279"
  },
  {
    "text": "into Edge proxy which of course would never happen unless it moved to Envoy now from the technical perspective",
    "start": "686279",
    "end": "693639"
  },
  {
    "text": "envoy's feature set was roughly aligned with the features we needed to support in the web enrich platform the team had",
    "start": "693639",
    "end": "699600"
  },
  {
    "text": "done some Discovery into Envoy and hadn't found any major feature blockers and additionally they noted that Envoy",
    "start": "699600",
    "end": "705680"
  },
  {
    "text": "had a vibrant open source Community all of you which made the team feel",
    "start": "705680",
    "end": "710760"
  },
  {
    "text": "confident that we could contribute to Envoy to fill any gaps that we might find the envoy feature set that was most",
    "start": "710760",
    "end": "717560"
  },
  {
    "text": "important to the web en platform form was the set of features supporting extensibility XZ uh xproc support for",
    "start": "717560",
    "end": "725320"
  },
  {
    "text": "Lua wasum the native plug-in model and as we heard earlier uh go as well um however it's important to note",
    "start": "725320",
    "end": "734000"
  },
  {
    "text": "that although Envoy supports um supports high performance performance wasn't terribly important to us for this",
    "start": "734000",
    "end": "740360"
  },
  {
    "text": "application extensibility was really the key feature anyway the team decided to go",
    "start": "740360",
    "end": "745760"
  },
  {
    "text": "ahead with their decision to use Envoy and started engineering work early last year although we don't currently have",
    "start": "745760",
    "end": "751720"
  },
  {
    "text": "concrete plans to merge the web enertion platform with Envoy we have joined the teams nibler merged with ATC earlier",
    "start": "751720",
    "end": "758880"
  },
  {
    "text": "this year and now Sabrina is going to tell you a little bit more about how the engineering work actually",
    "start": "758880",
    "end": "764360"
  },
  {
    "text": "went thank you Oliver let's take now a look at how we reengineered weap on",
    "start": "764360",
    "end": "770199"
  },
  {
    "text": "invoy uh luckily for us the transition was quite intuitive and something that",
    "start": "770199",
    "end": "775279"
  },
  {
    "text": "was very helpful in the process was obviously Envoy flexibility many of the changes uh were primarily um",
    "start": "775279",
    "end": "783079"
  },
  {
    "text": "concerning the configuration and the routing layer with varying degrees of difficulty we were we were lucky to have",
    "start": "783079",
    "end": "789639"
  },
  {
    "text": "a lot of one-on-one matching between the features but I want to mention a few of",
    "start": "789639",
    "end": "794959"
  },
  {
    "text": "the things that we need to change uh starting from the Upstream handling um",
    "start": "794959",
    "end": "800720"
  },
  {
    "text": "we uh first we need to uh slightly change this how the service Discovery Works uh and voy played a crucial role",
    "start": "800720",
    "end": "807160"
  },
  {
    "text": "in this process uh as our services need to find each other through engine room uh the configuration layer then uh we",
    "start": "807160",
    "end": "814199"
  },
  {
    "text": "had the he checks for now we rely on the active heal checks through the outlier detection to ensure that the services",
    "start": "814199",
    "end": "820160"
  },
  {
    "text": "are healthy uh another thing was timeouts uh we can now configure timeouts uh request",
    "start": "820160",
    "end": "825920"
  },
  {
    "text": "uh per Upstream uh and this ensures responsiveness rexes uh so Rex feature",
    "start": "825920",
    "end": "833560"
  },
  {
    "text": "very important for us because we use them uh for request processing so we had to work a bit around the Li itations",
    "start": "833560",
    "end": "839320"
  },
  {
    "text": "with the redax engine in order to keep redax patterns efficient but thanks to",
    "start": "839320",
    "end": "844680"
  },
  {
    "text": "invoid being open source we were able to improve this feature to fit all requirements uh and this resulted in a",
    "start": "844680",
    "end": "850160"
  },
  {
    "text": "PR that we opened allowing us and potentially others to expand the capabilities uh these changes addressed",
    "start": "850160",
    "end": "856560"
  },
  {
    "text": "an issue encountered with the reject reide as part of the redir when we match the mesh pad does not match the entire",
    "start": "856560",
    "end": "863279"
  },
  {
    "text": "path uh the problem was uh that only the MCH section of the original path for instance the prefix was substituted with",
    "start": "863279",
    "end": "870480"
  },
  {
    "text": "the reject re write whereas the expected behavior is to replace the entirety of the",
    "start": "870480",
    "end": "876199"
  },
  {
    "text": "path another thing is that now customers have the ability to determine the appropriate course of action when uh",
    "start": "876199",
    "end": "882680"
  },
  {
    "text": "errors are returned by a vertical this is a feature that we offered in the platform uh this Um this can involve",
    "start": "882680",
    "end": "888959"
  },
  {
    "text": "intercepting the error and invoking another vertical that displays the error page as a result all the verticals",
    "start": "888959",
    "end": "895639"
  },
  {
    "text": "within a website can use the same error page without needing to uh independently implement it it appears that such a",
    "start": "895639",
    "end": "902519"
  },
  {
    "text": "functionality is still not ready for production in invo so we have to depend on our Uh custom law filter to fulfill",
    "start": "902519",
    "end": "908079"
  },
  {
    "text": "this requirement uh further moving on uh speaking of",
    "start": "908079",
    "end": "913320"
  },
  {
    "text": "integration tasks we're incorporating and void to validate the configuration and prevent unsupported or complex",
    "start": "913320",
    "end": "919320"
  },
  {
    "text": "rejects patterns we also managed to simplify our system by using buil-in and voy features",
    "start": "919320",
    "end": "925440"
  },
  {
    "text": "reducing the amount of custume code we had to maintain Fe fees like service out filter Dynamic forward proxy or external",
    "start": "925440",
    "end": "933120"
  },
  {
    "text": "authorization filter played a significant role in reducing our custom Lua",
    "start": "933120",
    "end": "938360"
  },
  {
    "text": "plugins additionally we benefited uh from some new features as well for instance the we greatly uh make greatly",
    "start": "938360",
    "end": "945079"
  },
  {
    "text": "use of the admin um eny admin end point uh to support our operational",
    "start": "945079",
    "end": "950440"
  },
  {
    "text": "tasks on another note uh as Oliver mentioned before throughout this process we were so pleasantly surprised by the",
    "start": "950440",
    "end": "956240"
  },
  {
    "text": "supportive community and assistance that we received while this project is still in progress",
    "start": "956240",
    "end": "961639"
  },
  {
    "text": "we are very pleased with the progress that we made and so enthusiastic about our upcoming",
    "start": "961639",
    "end": "967600"
  },
  {
    "text": "plans Sabrina just covered many of the successes we had as we implemented the envoy layer but of course it wasn't all",
    "start": "967800",
    "end": "974560"
  },
  {
    "text": "perfect there were a few places Envoy wasn't quite so aligned with the features we already offered in the platform let's talk about a couple",
    "start": "974560",
    "end": "981560"
  },
  {
    "text": "specific issues we had rate limiting is the first example the web en R platform",
    "start": "981560",
    "end": "987160"
  },
  {
    "text": "supports rate limiting and quite a quite a few of our users had enabled the feature but the core issue here is that",
    "start": "987160",
    "end": "992720"
  },
  {
    "text": "rate limiting in engine X and rate limiting in Envoy differ in some key ways specifically engine X supports",
    "start": "992720",
    "end": "999040"
  },
  {
    "text": "using the client IP address as the rate limiting key whereas Envoy does not unless we use the global rate limiting",
    "start": "999040",
    "end": "1006040"
  },
  {
    "text": "filter and the separate distributed rate limiting infrastructure we didn't want to build out that separate rate limiting",
    "start": "1006040",
    "end": "1011920"
  },
  {
    "text": "infrastructure so we decided to look at the problem a bit more holistically we looked at our rate",
    "start": "1011920",
    "end": "1017199"
  },
  {
    "text": "limiting users and tried tried to understand their various use cases and it turned out that most of them use rate",
    "start": "1017199",
    "end": "1023079"
  },
  {
    "text": "limiting to protect their services uh from unwanted traffic spikes but supporting that use case has a has a few",
    "start": "1023079",
    "end": "1029839"
  },
  {
    "text": "problems users don't have a good way to determine a specific rate over which",
    "start": "1029839",
    "end": "1035000"
  },
  {
    "text": "they wanted to limit their traffic especially when their traffic varies over the course of a day and from an",
    "start": "1035000",
    "end": "1040400"
  },
  {
    "text": "operational perspective we would have to do capacity planning of a rate limiting infrastructure uh which is especially",
    "start": "1040400",
    "end": "1046280"
  },
  {
    "text": "hard when we don't really know what traffic to expect so we'd been down this path before with",
    "start": "1046280",
    "end": "1051440"
  },
  {
    "text": "Edge proxy and we didn't feel like blindly using the same approach so the de the team decided to pause and look at",
    "start": "1051440",
    "end": "1057760"
  },
  {
    "text": "more long-term Solutions and unfortunately I must say we haven't settled on a solution quite yet but",
    "start": "1057760",
    "end": "1063559"
  },
  {
    "text": "rather we're investing in our broader traffic protection strategy the other example I want to",
    "start": "1063559",
    "end": "1069480"
  },
  {
    "text": "talk about is file serving and I should start by saying that this was not really an engine X versus Envoy issue we had a",
    "start": "1069480",
    "end": "1076919"
  },
  {
    "text": "feature in our web enr platform that allowed users to Define raw engine X",
    "start": "1076919",
    "end": "1082960"
  },
  {
    "text": "config yeah Yes you heard that right it's the definition of a leaky abstraction whatever good reasons the",
    "start": "1082960",
    "end": "1089200"
  },
  {
    "text": "team had for uh including this feature in the first place clearly we couldn't Port that forward uh Port that",
    "start": "1089200",
    "end": "1095400"
  },
  {
    "text": "functionality forward to be supported under Envoy so again we uh we took a",
    "start": "1095400",
    "end": "1100679"
  },
  {
    "text": "look at what our users were doing with this mechanism and luckily we found that everyone was using it simply to serve",
    "start": "1100679",
    "end": "1106400"
  },
  {
    "text": "small files such as a robot not text file I think we really dodged a bullet here this could have been abused much uh",
    "start": "1106400",
    "end": "1113000"
  },
  {
    "text": "much more widely with many more use cases but given our findings we settled on building a proper file serving",
    "start": "1113000",
    "end": "1119240"
  },
  {
    "text": "feature into the API and currently the implementation simply just proxies a a request back to a GCS pocket but in",
    "start": "1119240",
    "end": "1126840"
  },
  {
    "text": "talking to our users about this feature we also heard that they want the ability to use a downstream cache and so we're",
    "start": "1126840",
    "end": "1132520"
  },
  {
    "text": "considering if and how we might support HTTP caching in the platform it's not commonly used for backend services but",
    "start": "1132520",
    "end": "1138760"
  },
  {
    "text": "it would be useful in the web space now Sabrina is going to tell us a bit about the actual",
    "start": "1138760",
    "end": "1144600"
  },
  {
    "text": "migration thank you um so with this slide I would just want to provide a quick snapshot of how the migration",
    "start": "1144600",
    "end": "1152039"
  },
  {
    "text": "process looked uh the good news is that everything went uh smooth and we",
    "start": "1152039",
    "end": "1157280"
  },
  {
    "text": "currently are somewhere near 90% uh completed in terms of the migration",
    "start": "1157280",
    "end": "1162520"
  },
  {
    "text": "until now we have made the switch with zero downtime and pretty much zero issues almost",
    "start": "1162520",
    "end": "1168919"
  },
  {
    "text": "uh however we did take some precautions and systematically move their traffic following this procedure so we set up",
    "start": "1168919",
    "end": "1175480"
  },
  {
    "text": "some migration cohorts uh dividing the user base in order to facilitate the control transition then we contacted the",
    "start": "1175480",
    "end": "1182360"
  },
  {
    "text": "owners of the web services and maintain the clear communication and collaboration with them when it was time",
    "start": "1182360",
    "end": "1188480"
  },
  {
    "text": "to schedule the migration window uh meant uh picking an optimal time frame for minimal",
    "start": "1188480",
    "end": "1194840"
  },
  {
    "text": "disruption uh one thing that was very helpful uh for us was that we were able",
    "start": "1194840",
    "end": "1200000"
  },
  {
    "text": "to temporarily operate traffic splitting with the help of envoy uh Envoy proxy",
    "start": "1200000",
    "end": "1205679"
  },
  {
    "text": "this helped us oversee potential issues in time and also avoid disruptions",
    "start": "1205679",
    "end": "1211159"
  },
  {
    "text": "monitoring was key after all we prepared a set of dashboard with overview of traffic and what was happening with the",
    "start": "1211159",
    "end": "1216679"
  },
  {
    "text": "requests and the en reachers as well monitoring resources when we assess that",
    "start": "1216679",
    "end": "1222240"
  },
  {
    "text": "everything was fine then we did a full switch on uh traffic so 100% of traffic going to the web enagement platform for",
    "start": "1222240",
    "end": "1228480"
  },
  {
    "text": "with and boy and then some more monitoring to ensure Peak Performance as well as collaborating",
    "start": "1228480",
    "end": "1234720"
  },
  {
    "text": "with the service owners for the longterm next Oliver will share a snippet of our future",
    "start": "1234720",
    "end": "1242159"
  },
  {
    "text": "plans so now that we're almost done with the migration Where Do We Go From Here well we're not sure exactly but a main",
    "start": "1242159",
    "end": "1248559"
  },
  {
    "text": "focus area in the next planning cycle is to evolve the web enrichment platform",
    "start": "1248559",
    "end": "1253720"
  },
  {
    "text": "the first couple items that we have here in this list are almost certain a control plane let's face it the current",
    "start": "1253720",
    "end": "1259799"
  },
  {
    "text": "configuration layer is a bit of a hot mess and we'd love to reuse our our expertise with the edge proxy control",
    "start": "1259799",
    "end": "1265400"
  },
  {
    "text": "plane and apply that to the web enrichment platform also the tap filter",
    "start": "1265400",
    "end": "1270919"
  },
  {
    "text": "we we already have a few use cases for the tap filter or at least use cases where we think we might start with a tap",
    "start": "1270919",
    "end": "1276480"
  },
  {
    "text": "filter and iterate towards custom filters if and when we think that makes sense one specific effort we're actually",
    "start": "1276480",
    "end": "1282840"
  },
  {
    "text": "currently working on is creating a granular data set of traffic going through Edge proxy we've already run a",
    "start": "1282840",
    "end": "1289120"
  },
  {
    "text": "prototype that uses the tap filter and some sampling and I think it's pretty likely that we'll use the same approach",
    "start": "1289120",
    "end": "1295640"
  },
  {
    "text": "specifically targeting our web traffic in the web enrichment platform and the other items here are a",
    "start": "1295640",
    "end": "1301440"
  },
  {
    "text": "bit more exploratory uh as Sabrina hinted at before careful viewers may have noticed that the API that we offer",
    "start": "1301440",
    "end": "1307559"
  },
  {
    "text": "in concierge and the enrichment layer looks very similar to envoys XPR API so",
    "start": "1307559",
    "end": "1314159"
  },
  {
    "text": "perhaps we rebuild concierge as uh an Envoy filter and call external in inites",
    "start": "1314159",
    "end": "1319360"
  },
  {
    "text": "with xproc another idea is to have some coordination between the configuration",
    "start": "1319360",
    "end": "1324760"
  },
  {
    "text": "apis of edge proxy and the web enrich platform uh maybe we could automatically",
    "start": "1324760",
    "end": "1330320"
  },
  {
    "text": "provision endpoints in Edge proxy if we know their web enrich platform users and",
    "start": "1330320",
    "end": "1335760"
  },
  {
    "text": "lastly the mythical idea of actually merging the web en Rich platform into Edge proxy itself there are so many ways",
    "start": "1335760",
    "end": "1342120"
  },
  {
    "text": "we could actually do this and I'm sure there'll be plenty of ideas by the team over the coming planning Cycles so of",
    "start": "1342120",
    "end": "1348559"
  },
  {
    "text": "course we'll have to wait and see what the future will bring but I can speak for the team and say that the future is bright with",
    "start": "1348559",
    "end": "1356120"
  },
  {
    "text": "Envoy so lastly we'd like to say a heartfelt thank you to the current and past members of both teams nibler and",
    "start": "1356400",
    "end": "1362600"
  },
  {
    "text": "ATC uh thank you to the conference organizers for inviting us to speak and the countless others who helped this",
    "start": "1362600",
    "end": "1368880"
  },
  {
    "text": "migration a success I extend the thank you as well and with that we'd love to take any",
    "start": "1368880",
    "end": "1376080"
  },
  {
    "text": "questions that you might have uh or give you a short break otherwise um and also please use the QR code here to submit",
    "start": "1376080",
    "end": "1382480"
  },
  {
    "text": "any feedback that you might have for us thank",
    "start": "1382480",
    "end": "1386679"
  },
  {
    "text": "you uh thanks for the presentation I noticed one of the things you listed as a challenge during the migration was",
    "start": "1391279",
    "end": "1396480"
  },
  {
    "text": "something to do with redirect policy for customer response and also dealing with some interesting qus of internal",
    "start": "1396480",
    "end": "1402000"
  },
  {
    "text": "redirects in migration at the moment so I'm curious to hear more about that if you can elaborate that's something we might have",
    "start": "1402000",
    "end": "1408159"
  },
  {
    "text": "to look up I don't remember the details that was something that um I believe one",
    "start": "1408159",
    "end": "1413200"
  },
  {
    "text": "of our past team members submitted an upstream patch and Envoy where I think there was um I think there was something",
    "start": "1413200",
    "end": "1421080"
  },
  {
    "text": "where you could redirect but it didn't maintain the host header it was something like that do you",
    "start": "1421080",
    "end": "1426880"
  },
  {
    "text": "recall yeah um I'm not sure I'll tell you what we'll we'll uh we'll we'll chat later and look it up and get you a",
    "start": "1426880",
    "end": "1433679"
  },
  {
    "text": "better answer",
    "start": "1433679",
    "end": "1439039"
  },
  {
    "text": "curious about your experience with Envoy filters uh uh I mean I've heard typically that it's preferred preferable",
    "start": "1439039",
    "end": "1445520"
  },
  {
    "text": "to use C++ but uh what about some of the other languages what was your experience and the pros and",
    "start": "1445520",
    "end": "1452559"
  },
  {
    "text": "cons I can I can take a stab at this one um this is an interesting question I",
    "start": "1452559",
    "end": "1458240"
  },
  {
    "text": "think specifically for the web enrichment platform uh we already kind of had a choice made for us because we",
    "start": "1458240",
    "end": "1464760"
  },
  {
    "text": "had so much custom code in Lua already um to support engine X we basically just moved everything over and we didn't try",
    "start": "1464760",
    "end": "1471279"
  },
  {
    "text": "and redesign things at that point um from from a more strategic standpoint",
    "start": "1471279",
    "end": "1477480"
  },
  {
    "text": "taking into consider uh consideration both the web andion platform and uh Edge proxy that our team also",
    "start": "1477480",
    "end": "1484320"
  },
  {
    "text": "maintains [Music] um there are differing opinions in the",
    "start": "1484320",
    "end": "1489600"
  },
  {
    "text": "team I think um but maybe we can say that for Edge proxy where we're really",
    "start": "1489600",
    "end": "1496159"
  },
  {
    "text": "running all of spotify's traffic we would prefer to have something which is um uh very maintainable and very high",
    "start": "1496159",
    "end": "1503840"
  },
  {
    "text": "performance um but perhaps there are cases where we might want to prototype",
    "start": "1503840",
    "end": "1509200"
  },
  {
    "text": "something in perhaps a language that uh that team members are are are uh uh more",
    "start": "1509200",
    "end": "1515159"
  },
  {
    "text": "um more practice with we don't have that many people who are actually good at C++ so I think um um we're interested in",
    "start": "1515159",
    "end": "1522880"
  },
  {
    "text": "looking at some of the other interfaces I'm also uh personally interested in was",
    "start": "1522880",
    "end": "1528039"
  },
  {
    "text": "as well because I think some of the some of the logic that we might want to see in in these various proxy layers we",
    "start": "1528039",
    "end": "1534440"
  },
  {
    "text": "might want to run them outside of envoy as well and so then having a portable format would be useful thank",
    "start": "1534440",
    "end": "1542760"
  },
  {
    "text": "you hey two questions for you um I guess first uh are you using Envoy for API",
    "start": "1543559",
    "end": "1549640"
  },
  {
    "text": "also is that your team a different team I'm just curious like you know what that looks like web versus",
    "start": "1549640",
    "end": "1556480"
  },
  {
    "text": "API um so it used to be multiple teams but uh those teams have joined so now it's all one one happy family gotcha",
    "start": "1556480",
    "end": "1564000"
  },
  {
    "text": "okay but are you using Envoy for your apis as well yes yes um uh Edge proxy",
    "start": "1564000",
    "end": "1569200"
  },
  {
    "text": "that we talked about before that's that's where all the apis go got it and then you mentioned control plane have",
    "start": "1569200",
    "end": "1574799"
  },
  {
    "text": "you started your journey into that yet or it's just like an idea right now I'm just curious like have you started looking at I mean there's lots of",
    "start": "1574799",
    "end": "1581240"
  },
  {
    "text": "control planes for Envoy out there right you know I'm curious if you found anything that looks interesting for web",
    "start": "1581240",
    "end": "1586880"
  },
  {
    "text": "specifically or not yeah that's interesting do you want to answer or shall I yes well uh as Oliver",
    "start": "1586880",
    "end": "1593799"
  },
  {
    "text": "mentioned many of the decision that we took are coming from the the previous um",
    "start": "1593799",
    "end": "1600159"
  },
  {
    "text": "um um architecture of the we platform but uh control plan is definitely",
    "start": "1600159",
    "end": "1605200"
  },
  {
    "text": "something that we are looking into and plan to invest in this uh up comic cycle MH and and I can say as well I mean part",
    "start": "1605200",
    "end": "1613399"
  },
  {
    "text": "of your question is interesting um uh anything specifically about web we we haven't really looked at anything",
    "start": "1613399",
    "end": "1618919"
  },
  {
    "text": "specific about web but uh Edge proxy does have a custom control plane written in Java um and I believe we're also the",
    "start": "1618919",
    "end": "1626279"
  },
  {
    "text": "maintainers of the of the Java control plane um in the envoy community so that's that's pretty much the the",
    "start": "1626279",
    "end": "1632679"
  },
  {
    "text": "no-brainer direction will go um how we actually support specific web features I",
    "start": "1632679",
    "end": "1638080"
  },
  {
    "text": "think that'll just be an engineering exercise in the team got it okay thanks",
    "start": "1638080",
    "end": "1644279"
  },
  {
    "text": "sure great talk thank you um a bunch of questions come to mind but I'll just narrow down to two quick ones one of",
    "start": "1644559",
    "end": "1650640"
  },
  {
    "text": "them is um for your um in general this seems like a pretty high throughput",
    "start": "1650640",
    "end": "1657559"
  },
  {
    "text": "application for Envoy I'm wondering if you've looked at your usage of features related to the performance and",
    "start": "1657559",
    "end": "1663080"
  },
  {
    "text": "scalability of your proxy in particular your Reliance on reg X's for doing redirects um we've been shy about",
    "start": "1663080",
    "end": "1670519"
  },
  {
    "text": "scaling about having lots of reg X in your url map thinking they'll be a drag on performance and if you've done flame",
    "start": "1670519",
    "end": "1676039"
  },
  {
    "text": "graphs Etc to look at that um I'll just also shoot out my other question which is that you talked about",
    "start": "1676039",
    "end": "1681640"
  },
  {
    "text": "writing some custom filters and I'm wondering if you're following along what Alyssa referenced about xproc and a way",
    "start": "1681640",
    "end": "1687799"
  },
  {
    "text": "to offload some of that to maybe other services that you might have running to service those content modifications",
    "start": "1687799",
    "end": "1694840"
  },
  {
    "text": "thanks yes okay so those questions um um around performance uh as I",
    "start": "1694840",
    "end": "1702080"
  },
  {
    "text": "mentioned before for this application performance performance isn't very high on our list but I imagine we will get to",
    "start": "1702080",
    "end": "1708760"
  },
  {
    "text": "performance at some point but in in uh in in my mind it very much depends on",
    "start": "1708760",
    "end": "1714640"
  },
  {
    "text": "how we consider merging the web andan platform with Edge proxy in Edge proxy",
    "start": "1714640",
    "end": "1719799"
  },
  {
    "text": "that is very performance uh um um very performance sensitive and and",
    "start": "1719799",
    "end": "1725960"
  },
  {
    "text": "we're we're doing a lot of engineering work to increase performance of web proxy itself um around performance for",
    "start": "1725960",
    "end": "1733519"
  },
  {
    "text": "rxes yes that could conceivably be a problem in in the web been Rich platform",
    "start": "1733519",
    "end": "1738799"
  },
  {
    "text": "but we're not we're not so worried about it we can always just throw more Hardware at it for the time being so I",
    "start": "1738799",
    "end": "1744399"
  },
  {
    "text": "think and around uh xproc um yes we're definitely looking into xproc and I I",
    "start": "1744399",
    "end": "1749880"
  },
  {
    "text": "think xproc can really help us evolve uh the the enrichment part of this",
    "start": "1749880",
    "end": "1756240"
  },
  {
    "text": "platform um thank you for the presentation u in in my company uas we're actually going through a similar",
    "start": "1756919",
    "end": "1763000"
  },
  {
    "text": "migration from a reverse proxy to invoy um actually first question were you able to achieve Tam Ms and retries to",
    "start": "1763000",
    "end": "1769720"
  },
  {
    "text": "Upstream within envo or just you know via envo futters that is a question I don't think",
    "start": "1769720",
    "end": "1776919"
  },
  {
    "text": "I can answer do you have an answer I think we don't extensively use retries I think we set them to one only so I see",
    "start": "1776919",
    "end": "1785120"
  },
  {
    "text": "okay cool yeah the second question you mentioned about the global control plane right in your scale I I assume that you",
    "start": "1785120",
    "end": "1792399"
  },
  {
    "text": "probably have lots of edge proxies right like is a control plane like how how you",
    "start": "1792399",
    "end": "1797559"
  },
  {
    "text": "guys handling let's say updated to invoy updated to the filters you know the the",
    "start": "1797559",
    "end": "1803120"
  },
  {
    "text": "plugins source code how are you achieving that with this kind of you know distributor Edge",
    "start": "1803120",
    "end": "1809760"
  },
  {
    "text": "proxies do you want to come",
    "start": "1811880",
    "end": "1815559"
  },
  {
    "text": "answera is a part of ATC with us yeah so the scalability of control",
    "start": "1818039",
    "end": "1825200"
  },
  {
    "text": "plane for the edge proxy layer has been a a known problem for us so first of all",
    "start": "1825200",
    "end": "1830320"
  },
  {
    "text": "we switched to Delta XDS and recently we had a problem with Java control plan",
    "start": "1830320",
    "end": "1835519"
  },
  {
    "text": "when it got hammered by envo like in a single region let's say we had some",
    "start": "1835519",
    "end": "1840640"
  },
  {
    "text": "issue with the D do attack and then we okay let's scale up the edge layer and then after that when the control plane",
    "start": "1840640",
    "end": "1846039"
  },
  {
    "text": "restarts and all the envoys try to connect roughly simultaneously and to request the first state of the war",
    "start": "1846039",
    "end": "1851159"
  },
  {
    "text": "snapshot then our control plane just went crazy and it's just uh stopped",
    "start": "1851159",
    "end": "1856760"
  },
  {
    "text": "serving request and anvo basically got the stale EDS assignments and for that what we have implemented as a shortterm",
    "start": "1856760",
    "end": "1864080"
  },
  {
    "text": "rough roughly lowcost remediation was what we call XTS rate limiting and we also reached out to the community and",
    "start": "1864080",
    "end": "1869639"
  },
  {
    "text": "ask if other like rest of the community would be interested in that basically how that works every time there is a a",
    "start": "1869639",
    "end": "1875960"
  },
  {
    "text": "new XDS client connecting to the control plane we we keep a internal logic in the Java control plane that U checks okay",
    "start": "1875960",
    "end": "1883120"
  },
  {
    "text": "this is a new client connector or have I seen that client before if it's a new client it has has a configuration of how",
    "start": "1883120",
    "end": "1888399"
  },
  {
    "text": "many concurrent XDS streams is allows per second and if that one reaches it sends uh um I think uh some 5 code and",
    "start": "1888399",
    "end": "1897480"
  },
  {
    "text": "like request resource exhausted try later and we rely on the mechanism in anoid to do retries and like say let's",
    "start": "1897480",
    "end": "1903799"
  },
  {
    "text": "say in the largest region it takes us with 10 uh concurrent XDS per second",
    "start": "1903799",
    "end": "1909000"
  },
  {
    "text": "streams per second it takes us roughly 30 seconds for all the anvo to get the first snapshot but uh in that way we",
    "start": "1909000",
    "end": "1915960"
  },
  {
    "text": "stabilize the control plan and we can scale up we tried a very large like 500 Envoy machines in a single region with a",
    "start": "1915960",
    "end": "1922639"
  },
  {
    "text": "single quum plane and we did cont plane restart and XTS rate limiting uh has been proven a like battle proof uh",
    "start": "1922639",
    "end": "1929840"
  },
  {
    "text": "mechanism for that cool that's great um just one kind of followup question like",
    "start": "1929840",
    "end": "1935000"
  },
  {
    "text": "you know do you have any mechanism allows you to do gradual rout let's say that you are Runing out a new configuration how do you make sure that",
    "start": "1935000",
    "end": "1941519"
  },
  {
    "text": "you know to control the blast radius to star with this is a feature that we are very",
    "start": "1941519",
    "end": "1946880"
  },
  {
    "text": "much looking forward and uh currently we are running on GC and this is not supported and we are on the way to move",
    "start": "1946880",
    "end": "1952880"
  },
  {
    "text": "to kubernetes and this is the feature that we looking for basically every Envoy upgrade for us is a stress uh",
    "start": "1952880",
    "end": "1959240"
  },
  {
    "text": "event we like it's create a risk events calendar we uh notify our company and then we are having our hands shaking and",
    "start": "1959240",
    "end": "1965880"
  },
  {
    "text": "like looking at the graphs uh to for early detection but we have cost bunch of uh bad incidents uh because we we",
    "start": "1965880",
    "end": "1972120"
  },
  {
    "text": "don't have that capability of regional roll outs but we do like Canary deployments and then rolling out globally",
    "start": "1972120",
    "end": "1977799"
  },
  {
    "text": "cool yeah thank you the this is a good um a good input for our deployments team",
    "start": "1977799",
    "end": "1984320"
  },
  {
    "text": "we're definitely looking for uh for globally Progressive rollouts but we don't have that at the",
    "start": "1984320",
    "end": "1989799"
  },
  {
    "text": "moment hi uh I'm wondering what you've considered on the sort of simpler side of rate limiting you said that you don't",
    "start": "1989799",
    "end": "1995840"
  },
  {
    "text": "want to roll out the whole infrastructure that Envoy can provide um and that your users are used to",
    "start": "1995840",
    "end": "2000919"
  },
  {
    "text": "something else that's simpler and different like you said you had some things in mind and I wanted to know what those",
    "start": "2000919",
    "end": "2005960"
  },
  {
    "text": "are yes this is uh This is complicated we can talk more about this afterwards but",
    "start": "2005960",
    "end": "2012279"
  },
  {
    "text": "um I mean we're we're looking from a technology perspective we're looking um um we're looking into",
    "start": "2012279",
    "end": "2018480"
  },
  {
    "text": "rlqs um that doesn't necessarily address the the product side of the problem",
    "start": "2018480",
    "end": "2023960"
  },
  {
    "text": "really um one one idea we had is um um",
    "start": "2023960",
    "end": "2029440"
  },
  {
    "text": "because we're interested in per second rate limits um it durability of the rate",
    "start": "2029440",
    "end": "2036000"
  },
  {
    "text": "limiting infrastructure is isn't so important and so we were we were considering using um um using maglev on",
    "start": "2036000",
    "end": "2045320"
  },
  {
    "text": "the um uh on the rate limiting cluster and",
    "start": "2045320",
    "end": "2051520"
  },
  {
    "text": "um and then like basically you're Distributing the the IP addresses like",
    "start": "2051520",
    "end": "2057560"
  },
  {
    "text": "along the along the cluster hash um and if if one of those rate limiting instances might go down it doesn't",
    "start": "2057560",
    "end": "2064118"
  },
  {
    "text": "matter so much it doesn't take down the whole infrastructure and that way you could also autoscale the the rate",
    "start": "2064119",
    "end": "2069158"
  },
  {
    "text": "limiting infrastructure taking care of some of the capacity planning concerns but that's that's just an idea I have a",
    "start": "2069159",
    "end": "2074638"
  },
  {
    "text": "I have an open tab in my code Editor to like that has something kind of working in Envoy um but that's not supported at",
    "start": "2074639",
    "end": "2080960"
  },
  {
    "text": "the moment I think we're about out of time",
    "start": "2080960",
    "end": "2087679"
  },
  {
    "text": "but uh I think we're about out of time but if there's any more questions um we'd be happy to take them offline good",
    "start": "2087679",
    "end": "2093200"
  },
  {
    "text": "if you need it thanks guys fascinating talk",
    "start": "2093200",
    "end": "2098879"
  }
]