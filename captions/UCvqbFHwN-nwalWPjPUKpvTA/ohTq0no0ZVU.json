[
  {
    "start": "0",
    "end": "14000"
  },
  {
    "text": "hey everyone we're gonna get started so my name is Greg",
    "start": "89",
    "end": "5490"
  },
  {
    "text": "this is CJ orphan communities and gke security team at Google and today we're talking about practical attack and",
    "start": "5490",
    "end": "11849"
  },
  {
    "text": "defense and communities so with security at and kubernetes at the moment the",
    "start": "11849",
    "end": "17520"
  },
  {
    "start": "14000",
    "end": "14000"
  },
  {
    "text": "community is working really hard on security controls there's already a lot of defensive options and it might not be",
    "start": "17520",
    "end": "22830"
  },
  {
    "text": "all that obvious way to start or how to prioritize so we're not going to cover",
    "start": "22830",
    "end": "27930"
  },
  {
    "text": "all the security best practices in this talk it there's a lot to cover and so",
    "start": "27930",
    "end": "33750"
  },
  {
    "text": "today's focus is going to be mostly on prevention we're not going to be talking much about detection or instant response",
    "start": "33750",
    "end": "39780"
  },
  {
    "text": "or application security or a bunch of other kind of topics that we could be talking about I've only got 35 minutes",
    "start": "39780",
    "end": "45809"
  },
  {
    "text": "and we're trying to make it entertaining by having some demos so we're focusing",
    "start": "45809",
    "end": "50910"
  },
  {
    "text": "on cluster administrator and developer tasks and we're focusing on kubernetes",
    "start": "50910",
    "end": "56100"
  },
  {
    "text": "there's there's nothing gke specific in this in this presentation we have a link to a blog post at the end about that",
    "start": "56100",
    "end": "63719"
  },
  {
    "text": "gives you a whole bunch of hardening specifics for for gke so the documentation has the how today we're",
    "start": "63719",
    "end": "70560"
  },
  {
    "text": "trying to give you the the what defenses are interesting why you would apply them in in giving you a kind of like a real",
    "start": "70560",
    "end": "78150"
  },
  {
    "text": "attack scenario to to experience and visualize and a sense of the relative",
    "start": "78150",
    "end": "83280"
  },
  {
    "text": "priority of those things so we're gonna",
    "start": "83280",
    "end": "89909"
  },
  {
    "start": "86000",
    "end": "86000"
  },
  {
    "text": "keep with a pirate theme the Cooney's the threat model assumes application compromised so if you consider the",
    "start": "89909",
    "end": "98070"
  },
  {
    "text": "entire world of communities communities clusters that are running in production there's there's lots of bugs there's",
    "start": "98070",
    "end": "105149"
  },
  {
    "text": "there's lots of vulnerabilities in that whole spectrum so it's really kind of what happens off to a code execution that's actually interesting for",
    "start": "105149",
    "end": "111060"
  },
  {
    "text": "communities security and so our goal is always to be secure by default where we can but often we have some sort of opt",
    "start": "111060",
    "end": "117840"
  },
  {
    "text": "in opt in step for new security controls like we do with our back to make sure we",
    "start": "117840",
    "end": "123479"
  },
  {
    "text": "can keep that backwards compatibility and can give people a migration pause so",
    "start": "123479",
    "end": "129060"
  },
  {
    "start": "128000",
    "end": "128000"
  },
  {
    "text": "we have three demos which is a lot to fit in 35 minutes but hopeful keeps things interesting and the idea is",
    "start": "129060",
    "end": "135690"
  },
  {
    "text": "to show you an attack of learning clusters at different stages of security evolution so the first one is our back",
    "start": "135690",
    "end": "142680"
  },
  {
    "text": "is off or it's in a clan and old cluster that doesn't have our back and there's a fairly well-known kind of application to",
    "start": "142680",
    "end": "149520"
  },
  {
    "text": "cross the escalation path if you if you have a cluster like that so I want to make people aware of that the next one",
    "start": "149520",
    "end": "156330"
  },
  {
    "text": "is we kind of take that cluster and apply some hardening to it and we try the same attack and demonstrate that it",
    "start": "156330",
    "end": "161459"
  },
  {
    "text": "doesn't work and then we move into like a container breakout and privilege escalation kind of problem that can get",
    "start": "161459",
    "end": "167880"
  },
  {
    "text": "you access to the cube way and then from there we apply some more hardening to",
    "start": "167880",
    "end": "173459"
  },
  {
    "text": "that to that cluster and then we run the same attack and kind of once you've",
    "start": "173459",
    "end": "179310"
  },
  {
    "text": "closed off the obvious privilege escalations and there's sort of the attacker looks around a bit and there's",
    "start": "179310",
    "end": "184709"
  },
  {
    "text": "there's kind of not an easy way to escalate on that node they probably look to propagating through the cluster can I look for vulnerable services that are",
    "start": "184709",
    "end": "190680"
  },
  {
    "text": "running in the cluster and so will demonstrate kind of how that might work and then talk about some defenses for that scenario too so I said we're going",
    "start": "190680",
    "end": "200700"
  },
  {
    "start": "198000",
    "end": "198000"
  },
  {
    "text": "to keep the pirate theme and we're gonna actually assume roles here so I'm gonna",
    "start": "200700",
    "end": "206700"
  },
  {
    "text": "be part preview and so I'm gonna be kind",
    "start": "206700",
    "end": "217049"
  },
  {
    "text": "of wreaking havoc on these clusters in an adorable kind of ragamuffin rosy-cheeked pirate kind of way and I",
    "start": "217049",
    "end": "227010"
  },
  {
    "text": "will be your skipper shipper and behind",
    "start": "227010",
    "end": "233220"
  },
  {
    "text": "this well provisioned uniform and cap I hide some slightly lacks coding standards and a bit of security naive",
    "start": "233220",
    "end": "240720"
  },
  {
    "text": "die so to demonstrate some of these attacks and defenses that are available",
    "start": "240720",
    "end": "247530"
  },
  {
    "text": "in kubernetes we're we made up this fake app this isn't real please don't this is",
    "start": "247530",
    "end": "254040"
  },
  {
    "text": "not a real thing but this will let us talk through some of the things that you might think about so taking a look at",
    "start": "254040",
    "end": "260609"
  },
  {
    "text": "what this app looks like we're gonna have a new member web page that allow all of our",
    "start": "260609",
    "end": "266440"
  },
  {
    "text": "new members to sign up we will store their info in some database in the back we'll have a payment processor that that",
    "start": "266440",
    "end": "274360"
  },
  {
    "text": "turns on the database takes our new members and charges them takes our winners and pays them out through some",
    "start": "274360",
    "end": "280570"
  },
  {
    "text": "third party payments API and then you know just so our admins have a have a view into the payment system we'll we'll",
    "start": "280570",
    "end": "287500"
  },
  {
    "text": "build them an admin portal so yeah let's let's ship this app on our first cluster",
    "start": "287500",
    "end": "294750"
  },
  {
    "start": "290000",
    "end": "290000"
  },
  {
    "text": "okay",
    "start": "294750",
    "end": "297750"
  },
  {
    "text": "I just need to start some port forwards",
    "start": "304729",
    "end": "312370"
  },
  {
    "text": "okay readable yeah so here we have our our web front-end that skipper shipper",
    "start": "327590",
    "end": "334160"
  },
  {
    "text": "has built so I've already done some reconnaissance on this web front-end and",
    "start": "334160",
    "end": "339220"
  },
  {
    "text": "I'm pretty sure there's a shell injection in this input field here so",
    "start": "339220",
    "end": "344560"
  },
  {
    "text": "some pretty lacks coding standards going on the skipper ship has been enforcing",
    "start": "344560",
    "end": "350840"
  },
  {
    "text": "so he looking from the kind of doing from my reconnaissance I've kind of realized that he's probably taking this",
    "start": "350840",
    "end": "357470"
  },
  {
    "text": "this this input from the from the internet that's completely untrusted and making and chilling out and making a",
    "start": "357470",
    "end": "364460"
  },
  {
    "text": "call with it without doing any input sanitization so this is obviously a huge no-no so I'm gonna go ahead and exploit",
    "start": "364460",
    "end": "371750"
  },
  {
    "text": "it so I'm gonna close off the previous command with the semicolon and then download a downloaded backdoor and run",
    "start": "371750",
    "end": "379250"
  },
  {
    "text": "the backdoor and over here I've got my Metasploit listener and that's a",
    "start": "379250",
    "end": "384910"
  },
  {
    "text": "penetration testing framework that allows you to run an attack and have",
    "start": "384910",
    "end": "390190"
  },
  {
    "text": "install these backdoors on systems and then connect back to this service so this is my this is my exploitation",
    "start": "390190",
    "end": "396140"
  },
  {
    "text": "server so I'm gonna go ahead and hit submit on that and you can see I have a",
    "start": "396140",
    "end": "403190"
  },
  {
    "text": "shell now on that on that on that card that I've compromised so I'm running in",
    "start": "403190",
    "end": "410090"
  },
  {
    "text": "a dub dub dub directory it's actually readable yeah and you can see my exploit",
    "start": "410090",
    "end": "416690"
  },
  {
    "text": "has landed in there along with a kind of PHP code and other stuff that was already in that directory so I mentioned",
    "start": "416690",
    "end": "425870"
  },
  {
    "text": "that our back is disabled in this cluster or or it's in or it's an old cluster that doesn't have our back",
    "start": "425870",
    "end": "431210"
  },
  {
    "text": "enabled and so since in the interest of time I'm gonna cut kind of straight to the chase here so I know in in clusters",
    "start": "431210",
    "end": "439400"
  },
  {
    "text": "that don't have our back enabled there's a service account that lives at this location on the file system that's very privileged so let's just see if I can",
    "start": "439400",
    "end": "446530"
  },
  {
    "text": "see that on this system and I can so this is the this is the token here",
    "start": "446530",
    "end": "452720"
  },
  {
    "text": "that's the secret for that service account so I'm gonna use Metasploit to",
    "start": "452720",
    "end": "458180"
  },
  {
    "text": "download that token and then I'm gonna on my own attacking machine just write out a cube config file that includes",
    "start": "458180",
    "end": "464860"
  },
  {
    "text": "that token so that can make requests to that to that API server so now if I",
    "start": "464860",
    "end": "471550"
  },
  {
    "text": "switch over to my attacker machine so",
    "start": "471550",
    "end": "478030"
  },
  {
    "text": "this is the cube config file that I wrote out from my attack that includes",
    "start": "478030",
    "end": "484300"
  },
  {
    "text": "the the token that I stole and this is this is completely separate from the cluster now so I've used Metasploit to",
    "start": "484300",
    "end": "490090"
  },
  {
    "text": "extract this token out to my own machine and now I'm gonna come at the API server from completely outside the cluster",
    "start": "490090",
    "end": "496030"
  },
  {
    "text": "using that token I'm gonna try and get pods that works so I can see the pods",
    "start": "496030",
    "end": "504159"
  },
  {
    "text": "that are running in a cluster what else can I do with this took in so let's try getting secrets for all namespaces and",
    "start": "504159",
    "end": "511389"
  },
  {
    "text": "I'm just gonna grip out the cube system stuff to kind of keep this the output",
    "start": "511389",
    "end": "517630"
  },
  {
    "text": "down a little bit so I have a couple of kubernetes service account tokens here",
    "start": "517630",
    "end": "524560"
  },
  {
    "text": "which are not super interesting I already have one of those but this payments API key sounds really",
    "start": "524560",
    "end": "530260"
  },
  {
    "text": "interesting so from from skipper shivers kind of overview of the application this",
    "start": "530260",
    "end": "536500"
  },
  {
    "text": "is how money money gets transferred and stuff gets stuff gets done inside the application so let's try getting that",
    "start": "536500",
    "end": "543970"
  },
  {
    "text": "secret because that one sounds interesting so we're gonna get that payments API output in llam√≥ format and",
    "start": "543970",
    "end": "550390"
  },
  {
    "text": "so we can see this here is the base64 encoded secret so that's actually clear",
    "start": "550390",
    "end": "556240"
  },
  {
    "text": "text it's it's not encrypted in in this view here so I now have that payments",
    "start": "556240",
    "end": "563380"
  },
  {
    "text": "API secret and I could make make some requests for the payments API but it",
    "start": "563380",
    "end": "568990"
  },
  {
    "text": "actually gets worse so the this service",
    "start": "568990",
    "end": "574029"
  },
  {
    "text": "account as I said is very very privileged in the cluster when you don't have all back running so I can actually just exec anywhere in the cluster into",
    "start": "574029",
    "end": "582220"
  },
  {
    "text": "any pod so I can see there's this payments pod so I'm just gonna run a shell inside there so now I've got a",
    "start": "582220",
    "end": "588790"
  },
  {
    "text": "shell from my attacker machine all the way into the payments and you can see like the payments",
    "start": "588790",
    "end": "594300"
  },
  {
    "text": "related code here is running in this directory so that seems kind of bad yeah",
    "start": "594300",
    "end": "604020"
  },
  {
    "text": "so let's let's walk through what happened there our our attacker was able",
    "start": "604020",
    "end": "609870"
  },
  {
    "start": "607000",
    "end": "607000"
  },
  {
    "text": "to find a somewhat obvious pretty simple shell injection into our web facing front end from there he knew that there",
    "start": "609870",
    "end": "616860"
  },
  {
    "text": "was likely a service account token just kind of hanging out inside of that pod using that service account Tok and he",
    "start": "616860",
    "end": "622680"
  },
  {
    "text": "started probing around he proved out that it had a little bit too much access on our API and and from that point he",
    "start": "622680",
    "end": "629970"
  },
  {
    "text": "was able to exact directly into our payments pod maybe he changed the code maybe he's now stealing credit card numbers he was also able to just",
    "start": "629970",
    "end": "636660"
  },
  {
    "text": "directly take our payments API key and you know probably cost me a lot of money so let's talk through what we could have",
    "start": "636660",
    "end": "644670"
  },
  {
    "start": "643000",
    "end": "643000"
  },
  {
    "text": "done to to help prevent that obviously you want to enforce lease privilege on",
    "start": "644670",
    "end": "651660"
  },
  {
    "text": "your workloads and the the most obvious way to do that in kubernetes is to turn our turn our back on that means disable",
    "start": "651660",
    "end": "658980"
  },
  {
    "text": "the the legacy a back or make sure you have some authorization on on what your",
    "start": "658980",
    "end": "665010"
  },
  {
    "text": "service accounts are allowed to do once you and and that'll actually make it so",
    "start": "665010",
    "end": "670650"
  },
  {
    "text": "the service accounts have no privileges by by default you have to grant them if you want them if you do want them it's",
    "start": "670650",
    "end": "677220"
  },
  {
    "text": "nice to separate out your workloads by namespace because then you're able to say well this workload can only have",
    "start": "677220",
    "end": "683130"
  },
  {
    "text": "access inside its own namespace whereas this namespace is completely separate allows you to get that least privilege a",
    "start": "683130",
    "end": "689670"
  },
  {
    "text": "little bit easier and then lastly there are ways to firewall off the network",
    "start": "689670",
    "end": "694740"
  },
  {
    "text": "access to your master so if you know that you're only going to be accessing your kubernetes api from some set of",
    "start": "694740",
    "end": "700260"
  },
  {
    "text": "machines you can say i only ever want to see traffic from this set of machines and what that would have done in this",
    "start": "700260",
    "end": "705720"
  },
  {
    "text": "attack scenario was made it so that our attacker couldn't just take that credential off to the comforts of his",
    "start": "705720",
    "end": "710910"
  },
  {
    "text": "own machine where he probably has more tools more time more ability to probe it",
    "start": "710910",
    "end": "716490"
  },
  {
    "text": "would force them to maintain presence in our cluster if you wanted to continue this compromised so let's fix up some of",
    "start": "716490",
    "end": "723630"
  },
  {
    "start": "722000",
    "end": "722000"
  },
  {
    "text": "those and let's try to again so we're going to apply two of",
    "start": "723630",
    "end": "729040"
  },
  {
    "text": "those defenses we're going to not do the fire rolling because it makes it kind of more interesting to see how the defense",
    "start": "729040",
    "end": "734920"
  },
  {
    "text": "has got applied but we're going to turn on our back and we're going to segregate by namespaces",
    "start": "734920",
    "end": "741390"
  },
  {
    "text": "so same thing again we're gonna we left the vulnerability there but we have a",
    "start": "758920",
    "end": "764589"
  },
  {
    "text": "new cluster now with those defenses enabled same exploitation pattern and we",
    "start": "764589",
    "end": "775299"
  },
  {
    "text": "have our second session open now so the Metasploit actually allows you to have multiple at a time so same thing again",
    "start": "775299",
    "end": "780850"
  },
  {
    "text": "we have a shell let's download that service account open so downloaded it to",
    "start": "780850",
    "end": "789220"
  },
  {
    "text": "my own machine wrote out another cute config and I'm gonna try the same thing",
    "start": "789220",
    "end": "795879"
  },
  {
    "text": "I did last time so let's try and get pods so in in this now that we have our",
    "start": "795879",
    "end": "801369"
  },
  {
    "text": "back on this cluster that that service account is no longer privileged so we can see here the service account in the",
    "start": "801369",
    "end": "808119"
  },
  {
    "text": "sign-up namespace the default service account there can't list pods in the namespace default and we can try some of",
    "start": "808119",
    "end": "815049"
  },
  {
    "text": "the other things we tried so stealing the payments API key also fails and we",
    "start": "815049",
    "end": "820629"
  },
  {
    "text": "can keep trying stuff that we didn't have lost Emma but this by default though the service account has no privileges so this is this is now a dead",
    "start": "820629",
    "end": "827649"
  },
  {
    "text": "end so all right what's next let's look",
    "start": "827649",
    "end": "834069"
  },
  {
    "text": "around a little bit so we're running inside unsurprisingly a Linux container",
    "start": "834069",
    "end": "841019"
  },
  {
    "text": "let's have a look at the amounts that are on this system so it's a big pile of",
    "start": "841019",
    "end": "846069"
  },
  {
    "text": "text here that this actually looks pretty interesting because it looks like there's a a host path amount here",
    "start": "846069",
    "end": "852610"
  },
  {
    "text": "that's dragged in a whole bunch of stuff so host Paul founding is a way to mount stuff from the host in do container and",
    "start": "852610",
    "end": "859689"
  },
  {
    "text": "sometimes you might use that to to do some sort of writing and files or reading of files from the host in this",
    "start": "859689",
    "end": "866649"
  },
  {
    "text": "case skip of Shiva in keeping with the kind of like fairly fast and loose pace here has accidentally mounted in the",
    "start": "866649",
    "end": "875109"
  },
  {
    "text": "whole cubelet directory so the couplet is responsible for scheduling on the on the node and it's a fairly powerful",
    "start": "875109",
    "end": "880779"
  },
  {
    "text": "agent so let's go to poke around in that directory and see what we can find so there's a bunch of stuff in here PKI",
    "start": "880779",
    "end": "889269"
  },
  {
    "text": "sounds really interesting this cube config file tell us what's going on in this directory so let's just try and cut that",
    "start": "889269",
    "end": "896110"
  },
  {
    "text": "out okay permission denied who owns that",
    "start": "896110",
    "end": "902020"
  },
  {
    "text": "file it looks like root owns the file and it's readable and writable by root",
    "start": "902020",
    "end": "907360"
  },
  {
    "text": "so who am i running out I'm running as the Apache user dub dub dub fairly",
    "start": "907360",
    "end": "913840"
  },
  {
    "text": "common setup so I don't have privileges to read that file and at this point kind of in a real attack I'd be looking for",
    "start": "913840",
    "end": "920190"
  },
  {
    "text": "privilege escalation opportunities but since this is skip a shipper and things",
    "start": "920190",
    "end": "925990"
  },
  {
    "text": "of being pretty fast and loose so far I'm just gonna try out this and see if",
    "start": "925990",
    "end": "932230"
  },
  {
    "text": "this works so essentially what we've done here is",
    "start": "932230",
    "end": "938620"
  },
  {
    "text": "is simulate a container break out in a privilege escalation so to make this demo a bit simpler and not require us to",
    "start": "938620",
    "end": "946210"
  },
  {
    "text": "do all that work we've simulated a container breakout and privilege escalation by announcing too much stuff",
    "start": "946210",
    "end": "952540"
  },
  {
    "text": "into the container and then being a little bit crazy with our pseudo privileges so we're gonna take the you",
    "start": "952540",
    "end": "963820"
  },
  {
    "text": "can see here that the there's a cubelet count client key reference and a cubelet a client reference so we really gonna",
    "start": "963820",
    "end": "970210"
  },
  {
    "text": "take copies of those so I'm gonna copy them out of that host path mount write out a cube config file that uses them",
    "start": "970210",
    "end": "977650"
  },
  {
    "text": "and then we're gonna try using the cubelets credentials against the API and see what we can do and to do that I",
    "start": "977650",
    "end": "983650"
  },
  {
    "text": "actually have to download cube control because I'm running inside a container I didn't have Q control in there with me",
    "start": "983650",
    "end": "989920"
  },
  {
    "text": "so now that I've done that I can use the cube config file that has the cubelet",
    "start": "989920",
    "end": "996010"
  },
  {
    "text": "credentials and my copy of cube controller I just downloaded so let's see if I can get secrets",
    "start": "996010",
    "end": "1002540"
  },
  {
    "text": "so this fails so this is the it says this user which is actually the cubelet",
    "start": "1002540",
    "end": "1008790"
  },
  {
    "text": "for this node countless secrets in a namespace default I can only get individual resources of this type so I",
    "start": "1008790",
    "end": "1015960"
  },
  {
    "text": "can only get individual secrets I can't say all secrets okay",
    "start": "1015960",
    "end": "1020930"
  },
  {
    "text": "about show me all the parts then so this is all the pods in all the namespaces",
    "start": "1023850",
    "end": "1029250"
  },
  {
    "text": "just cutting out the cube system stuff I can do that and the reason I can do that",
    "start": "1029250",
    "end": "1034709"
  },
  {
    "text": "is cubelet needs that to do its job so people it has to is scheduling it needs to know kind of what pods to schedule on",
    "start": "1034709",
    "end": "1041548"
  },
  {
    "text": "itself so if I can now that I know the name of a pod maybe I can try exacting",
    "start": "1041549",
    "end": "1048660"
  },
  {
    "text": "into it that's what I did last time with the service account that really privileged service account token so I'm",
    "start": "1048660",
    "end": "1054330"
  },
  {
    "text": "gonna try exactly end of that payment spot and see if that works so that doesn't work so I and the couplet",
    "start": "1054330",
    "end": "1062250"
  },
  {
    "text": "actually isn't allowed to exec around inside the cluster so we can see our back working here too it's it's cooked",
    "start": "1062250",
    "end": "1069120"
  },
  {
    "text": "the the cubelet credentials down to the least privilege required for it to do its job but it's still a reasonably",
    "start": "1069120",
    "end": "1074640"
  },
  {
    "text": "powerful agent so it can as kind of hinted by that previous permission denied I can't actually get individual",
    "start": "1074640",
    "end": "1081210"
  },
  {
    "text": "secrets because the cubit is the thing that's responsible for mounting the secrets into the container so I'm gonna",
    "start": "1081210",
    "end": "1086850"
  },
  {
    "text": "try grabbing this secret and I can still steal that payments API key secret and",
    "start": "1086850",
    "end": "1092340"
  },
  {
    "text": "that's still a little surprising really because this is the web front-end and it has no reason to be able to need to",
    "start": "1092340",
    "end": "1098010"
  },
  {
    "text": "access that that API back-end secret isn't actually necessary for for this",
    "start": "1098010",
    "end": "1103110"
  },
  {
    "text": "this front-end to function so this seems better that's still not great yes let's",
    "start": "1103110",
    "end": "1111179"
  },
  {
    "text": "take a look at what happened their attacker found the same old challenge action we didn't remove it it's more fun",
    "start": "1111179",
    "end": "1116309"
  },
  {
    "text": "that way he took a look at the pod service account token luckily it was not",
    "start": "1116309",
    "end": "1123390"
  },
  {
    "text": "able to do anything in our cluster but we left him a nice little obvious",
    "start": "1123390",
    "end": "1129470"
  },
  {
    "text": "escalation he was able to grab a hold of the cubelet token on the note the qubit credentials on the note that he was",
    "start": "1129470",
    "end": "1135960"
  },
  {
    "text": "running on from there he did have some access to the API he was luckily not able to exec directly",
    "start": "1135960",
    "end": "1143309"
  },
  {
    "text": "into our payment spot again but he was able to grab that API key and probably likely cost me a bunch of money again so",
    "start": "1143309",
    "end": "1150780"
  },
  {
    "start": "1150000",
    "end": "1150000"
  },
  {
    "text": "what could we have done to prevent those obviously limit the local escalation paths that attackers might have",
    "start": "1150780",
    "end": "1157220"
  },
  {
    "text": "don't want to you want to avoid running his route really take a look at what what sort of host path mounts you really",
    "start": "1157220",
    "end": "1162830"
  },
  {
    "text": "need and you can enforce these sort of things with APOD security policy from",
    "start": "1162830",
    "end": "1168200"
  },
  {
    "text": "there you want to ensure that all of your nodes actually have leased privilege so on kubernetes 1.7 and up",
    "start": "1168200",
    "end": "1174230"
  },
  {
    "text": "this means enabling the node authorizer in the node admission controller and as you saw in that cluster that we were",
    "start": "1174230",
    "end": "1179929"
  },
  {
    "text": "looking at we actually did have that that authorizer enabled that's what prevented the node from being able to get all the secrets it was only able to",
    "start": "1179929",
    "end": "1186740"
  },
  {
    "text": "get the secrets that were relevant to pods co-located with that node so once",
    "start": "1186740",
    "end": "1193760"
  },
  {
    "text": "you have lease privileges for nodes you may want to go further and separate sensitive workloads from the more",
    "start": "1193760",
    "end": "1201309"
  },
  {
    "text": "possible you know the web facing type workloads that may be more vulnerable and and there's some scheduling",
    "start": "1201309",
    "end": "1207110"
  },
  {
    "text": "primitives that allow you to do that and that would have prevented our attacker from being able to grab the key if it",
    "start": "1207110",
    "end": "1212990"
  },
  {
    "text": "wasn't Co scheduled with him and then lastly you can turn on certificate rotation for for those cubelet",
    "start": "1212990",
    "end": "1219980"
  },
  {
    "text": "credentials and what that'll do is make sure that the attacker doesn't have a",
    "start": "1219980",
    "end": "1225110"
  },
  {
    "text": "credential that he can just take and use it as leisure for some long period of time the the lifetime of those",
    "start": "1225110",
    "end": "1231590"
  },
  {
    "text": "credentials would be shortened they'll be rotating out from under him again to maintain this compromise our",
    "start": "1231590",
    "end": "1237350"
  },
  {
    "text": "attacker would have to maintain presence in our system so yeah let's fix those",
    "start": "1237350",
    "end": "1242809"
  },
  {
    "text": "things up and now let's let's really ship this thing again let's just get set",
    "start": "1242809",
    "end": "1252590"
  },
  {
    "text": "up here",
    "start": "1252590",
    "end": "1254740"
  },
  {
    "text": "so same thing I'm gonna compromise plot again we have our third session opened",
    "start": "1276480",
    "end": "1285620"
  },
  {
    "text": "so let's have a look around and see how we did with the hardening and removing those those problems from the previous",
    "start": "1287030",
    "end": "1293520"
  },
  {
    "text": "cluster so let's see if we still got that directory from the cubelet we don't have that anymore let's take a look at",
    "start": "1293520",
    "end": "1299760"
  },
  {
    "text": "the amounts to see if there's anything crazy in there and they look much more reasonable we don't have all those all",
    "start": "1299760",
    "end": "1305820"
  },
  {
    "text": "those hosts path mounts so at at this point we don't have that kind of obvious",
    "start": "1305820",
    "end": "1312780"
  },
  {
    "text": "cubelet it's got a escalation path to break out of the container we can relate",
    "start": "1312780",
    "end": "1320370"
  },
  {
    "text": "without that vulnerability I can't really demonstrate having the the scheduling changes that we made that now",
    "start": "1320370",
    "end": "1325410"
  },
  {
    "text": "the now the the sign-up pod is scheduled on a different node to the the payments",
    "start": "1325410",
    "end": "1331290"
  },
  {
    "text": "back-end so if we were to steal secrets we wouldn't be able to get that payments API key so let's assume now that we're",
    "start": "1331290",
    "end": "1339480"
  },
  {
    "text": "kind of attack has landed in this cluster I'm like oh damn no super obvious privilege escalations no obvious",
    "start": "1339480",
    "end": "1346320"
  },
  {
    "text": "route stuff let's take a poke around in this cluster and see if we can propagate elsewhere let's look for some vulnerable",
    "start": "1346320",
    "end": "1353010"
  },
  {
    "text": "services that kind of stuff so really like traditional obvious way to do this is using the nmap utility which is a",
    "start": "1353010",
    "end": "1360420"
  },
  {
    "text": "pullet scanner so i've downloaded a version of nmap that's statically compiled and i'm gonna run a scan across",
    "start": "1360420",
    "end": "1366030"
  },
  {
    "text": "just looking at port 80 across the services IP address range there's a",
    "start": "1366030",
    "end": "1372900"
  },
  {
    "text": "slash 20 that is used for the services in this cluster this takes like two",
    "start": "1372900",
    "end": "1378240"
  },
  {
    "text": "minutes to run which is pretty much an eternity for this presentation so this is the only thing that isn't live so",
    "start": "1378240",
    "end": "1385410"
  },
  {
    "text": "here's one I prepared earlier this is the end map scan results so you can see",
    "start": "1385410",
    "end": "1392640"
  },
  {
    "text": "here that I have a sign up sign up front end running on port 80 I have a payment",
    "start": "1392640",
    "end": "1398940"
  },
  {
    "text": "service running on port 80 as well as some like internal kubernetes other",
    "start": "1398940",
    "end": "1403950"
  },
  {
    "text": "stuff heaps to a dashboard etc so payments sounds interesting let's go",
    "start": "1403950",
    "end": "1412440"
  },
  {
    "text": "with that so I'm just gonna ko it apologies for the kind of big pile of on",
    "start": "1412440",
    "end": "1417960"
  },
  {
    "text": "rendered HTML here but sometimes hacking is dirty and gross so the really an only",
    "start": "1417960",
    "end": "1425309"
  },
  {
    "text": "really interesting part of that hTML is that it's a directory listing that shows us there's a payments PHP app now we",
    "start": "1425309",
    "end": "1432030"
  },
  {
    "text": "could actually like just kind of stop the attack here because this is kind of demonstrating the problem that I",
    "start": "1432030",
    "end": "1437700"
  },
  {
    "text": "shouldn't be out of get to this payment service from from this front-end API of further this front-end pod that I've",
    "start": "1437700",
    "end": "1443690"
  },
  {
    "text": "that I've compromised but I think I want to make it rain and I think we've I",
    "start": "1443690",
    "end": "1449610"
  },
  {
    "text": "think we've been talking about payments a lot but not actually getting paid so let's keep going for a little bit so",
    "start": "1449610",
    "end": "1456720"
  },
  {
    "text": "let's hit the payments uh hit the payments application and I'm super glad",
    "start": "1456720",
    "end": "1462570"
  },
  {
    "text": "about these really helpful error messages but I skip of Shiva has given me because here I can see Oh actually",
    "start": "1462570",
    "end": "1469549"
  },
  {
    "text": "would you like to make a payment because I have a make payment command so let's",
    "start": "1469549",
    "end": "1476730"
  },
  {
    "text": "let's go with that yes I would like to make a payment how to make a payment you",
    "start": "1476730",
    "end": "1482340"
  },
  {
    "text": "need an account number and then amount okay I can definitely do that so let's",
    "start": "1482340",
    "end": "1488549"
  },
  {
    "text": "go with my pirate pew pew account number and my elite amount of dollars and make",
    "start": "1488549",
    "end": "1497340"
  },
  {
    "text": "it rain skipper hey",
    "start": "1497340",
    "end": "1503779"
  },
  {
    "text": "[Applause]",
    "start": "1505050",
    "end": "1511210"
  },
  {
    "text": "okay so yeah not bad but still kind of problems yeah let's talk that one",
    "start": "1511210",
    "end": "1517160"
  },
  {
    "text": "through so what we have there same shell injection same service account token",
    "start": "1517160",
    "end": "1523100"
  },
  {
    "text": "still no permissions no way to escalate directly that was obvious so at that",
    "start": "1523100",
    "end": "1529400"
  },
  {
    "text": "point our attacker starts doing the normal attack things and kind of probing around see even what he might have",
    "start": "1529400",
    "end": "1534740"
  },
  {
    "text": "access to and unfortunately he was able to directly call this this payment",
    "start": "1534740",
    "end": "1540530"
  },
  {
    "text": "service now when I designed this wonderful app I never imagined that my signup form would have any reason to",
    "start": "1540530",
    "end": "1547790"
  },
  {
    "text": "contact my payment service directly so so this was very surprising that it",
    "start": "1547790",
    "end": "1552890"
  },
  {
    "text": "would have this access but our attacker found this made a call and you know cost",
    "start": "1552890",
    "end": "1559880"
  },
  {
    "text": "me some money so what could I have done there as you separate your applications",
    "start": "1559880",
    "end": "1566060"
  },
  {
    "start": "1562000",
    "end": "1562000"
  },
  {
    "text": "out into micro services there are these sort of natural security boundaries where you you get to start thinking through what pieces of my system should",
    "start": "1566060",
    "end": "1573350"
  },
  {
    "text": "really be talking to which other pieces and in kubernetes the network policy object in in 1.7 and later lets you",
    "start": "1573350",
    "end": "1581420"
  },
  {
    "text": "start to define and enforce that so in our case that means an ingress policy on",
    "start": "1581420",
    "end": "1588100"
  },
  {
    "text": "the payment app based on the label that says that I will only accept connections",
    "start": "1588100",
    "end": "1594550"
  },
  {
    "text": "from things that have the label admin portal so the only thing that should be",
    "start": "1594550",
    "end": "1599720"
  },
  {
    "text": "true directly talking to my payment processor is this admin portal that I'm helpfully providing my admins then the",
    "start": "1599720",
    "end": "1607820"
  },
  {
    "text": "other thing that in the past was often floating around the network was the the cubelet api and you really want to make",
    "start": "1607820",
    "end": "1614060"
  },
  {
    "text": "sure that you have authentication and authorization turned on to that there are some fairly privileged things you",
    "start": "1614060",
    "end": "1619550"
  },
  {
    "text": "can do by directly hitting the cubelet api and you definitely want to lock those things down as well okay so we",
    "start": "1619550",
    "end": "1629180"
  },
  {
    "start": "1626000",
    "end": "1626000"
  },
  {
    "text": "mostly focused on well we've entirely focused on existing defenses and talking about prevention so",
    "start": "1629180",
    "end": "1636740"
  },
  {
    "text": "just want to sum up try and give you some some kind of takeaways we talked about a lot of different defenses",
    "start": "1636740",
    "end": "1642140"
  },
  {
    "text": "and to try and help a little bit with priority so hopefully we fairly convincingly made an argument for",
    "start": "1642140",
    "end": "1648740"
  },
  {
    "text": "turning on our back there is that a very powerful privilege escalation that you really want to lock down and it also",
    "start": "1648740",
    "end": "1655370"
  },
  {
    "text": "gives you the ability to you know really apply lease privilege properly T Acosta",
    "start": "1655370",
    "end": "1660500"
  },
  {
    "text": "and if you're interacting with the API server at all so and another really",
    "start": "1660500",
    "end": "1665929"
  },
  {
    "text": "important part of this is keeping up with the kubernetes releases you'll see in all those defensive slides we were talking about the versions where those",
    "start": "1665929",
    "end": "1671720"
  },
  {
    "text": "defenses are available and you know a lot of them are kind of one six one seven fairly recent versions that pace",
    "start": "1671720",
    "end": "1679220"
  },
  {
    "text": "is going to continue and so there's really a lot of value in keeping up with with with the latest versions of",
    "start": "1679220",
    "end": "1684890"
  },
  {
    "text": "kubernetes so I'd like if you're not",
    "start": "1684890",
    "end": "1689929"
  },
  {
    "text": "doing either of those I consider those kind of probably the hardest priorities from there the having a really kind of",
    "start": "1689929",
    "end": "1697460"
  },
  {
    "text": "small container OS actually makes a big difference when an attacker lands in your cluster they're kind of more",
    "start": "1697460",
    "end": "1703250"
  },
  {
    "text": "comfortable they are the easier it is for them so it should be fairly uncomfortable when he landing in a",
    "start": "1703250",
    "end": "1708470"
  },
  {
    "text": "cluster so at one extreme that would be like kind of building like scratch containers but they get really hard to",
    "start": "1708470",
    "end": "1714770"
  },
  {
    "text": "debug so at least a really minimal or less like what we have with cause on gke",
    "start": "1714770",
    "end": "1721179"
  },
  {
    "text": "and then thinking about kind of carefully thinking about you know do I really need w getting coal in this in",
    "start": "1721179",
    "end": "1727010"
  },
  {
    "text": "this in this container do I need a shell and there's trade-offs with debugging",
    "start": "1727010",
    "end": "1732080"
  },
  {
    "text": "there but all those things make attacker actions a lot more easy a lot easier if they're available and obviously as we",
    "start": "1732080",
    "end": "1738860"
  },
  {
    "text": "said no root no host path Network what where where you don't need it and you can enforce those things with pod",
    "start": "1738860",
    "end": "1745070"
  },
  {
    "text": "security policy at the cluster level and then the as kind of siege I mentioned",
    "start": "1745070",
    "end": "1751760"
  },
  {
    "text": "earlier the this decomposition into micro services gives you these really natural boundaries for separate or",
    "start": "1751760",
    "end": "1758210"
  },
  {
    "text": "segregating out your your cluster and then building network policies and",
    "start": "1758210",
    "end": "1764540"
  },
  {
    "text": "dedicated nodes to kind of make propagation harder once an attacker does land in there making it as hard as",
    "start": "1764540",
    "end": "1771020"
  },
  {
    "text": "possible to get to the other places in your cluster is either really valuable thing that that isn't",
    "start": "1771020",
    "end": "1776130"
  },
  {
    "text": "hire fit and there's a whole bunch of companies that are doing work on kind of learning network networking patterns and",
    "start": "1776130",
    "end": "1783180"
  },
  {
    "text": "then helping you enforce network policies kind of automatically so you don't necessarily have to write that",
    "start": "1783180",
    "end": "1788430"
  },
  {
    "text": "bright those manually yourself so we we",
    "start": "1788430",
    "end": "1794490"
  },
  {
    "text": "have a great community I think it's a god we have some really stellar security engineers not talking about myself but",
    "start": "1794490",
    "end": "1800520"
  },
  {
    "text": "dealer but definitely the other people who were working in sigilyph I'm I'm I",
    "start": "1800520",
    "end": "1806640"
  },
  {
    "text": "don't know I'm very I'm very glad to be working with this community because I think there's some some really great",
    "start": "1806640",
    "end": "1811680"
  },
  {
    "text": "security expertise in it and we'd like other people to get involved so we meet",
    "start": "1811680",
    "end": "1817320"
  },
  {
    "text": "every Wednesday for two uh every two weeks every two weeks on Wednesdays",
    "start": "1817320",
    "end": "1823070"
  },
  {
    "text": "obligatory shout out from my team in Seattle was is hiring so if the",
    "start": "1823070",
    "end": "1828450"
  },
  {
    "text": "intersection of security and committees is interesting to you please come talk to me and here's a whole pile of links",
    "start": "1828450",
    "end": "1836100"
  },
  {
    "start": "1834000",
    "end": "1834000"
  },
  {
    "text": "so everything that we talked about today in terms of the defense is on this slide with a link I definitely want to call",
    "start": "1836100",
    "end": "1843720"
  },
  {
    "text": "out again the gke hardening blog post and there's a the second link there is a",
    "start": "1843720",
    "end": "1848730"
  },
  {
    "text": "living document for securing a kubernetes cluster that you know won't",
    "start": "1848730",
    "end": "1853740"
  },
  {
    "text": "age like this presentation will age as as things kind of change and a couple of",
    "start": "1853740",
    "end": "1859860"
  },
  {
    "text": "other call-outs so if you're expecting to see kind of security roadmap of features that sigilyph is working on the",
    "start": "1859860",
    "end": "1865590"
  },
  {
    "text": "in this talk we didn't have time to do that we kind of wanted to deliver here's why what you should do and why I should",
    "start": "1865590",
    "end": "1871800"
  },
  {
    "text": "do it but Jordan Leggett is giving a singles update that has a a good list of the",
    "start": "1871800",
    "end": "1879120"
  },
  {
    "text": "things were working on over the next few quarters so definitely go to his talk",
    "start": "1879120",
    "end": "1884420"
  },
  {
    "text": "yeah thanks happy to take questions yeah",
    "start": "1884420",
    "end": "1891530"
  },
  {
    "text": "you the question is can I use post security policy on gke no you can't right now it on the slides I said come in q1 2018",
    "start": "1895440",
    "end": "1903309"
  },
  {
    "text": "I think we should be it should be early January I think when he'll be able to turn that on",
    "start": "1903309",
    "end": "1909450"
  },
  {
    "text": "so I think the question is what consideration have we given to enforcing l-3 level partitioning based on l7 level",
    "start": "1935960",
    "end": "1946310"
  },
  {
    "text": "traffic being able to automatically discover that sort of thing I think from the kubernetes standpoint we don't want",
    "start": "1946310",
    "end": "1953340"
  },
  {
    "text": "to be really really opinionated about that I think different people have different opinions about how you want to",
    "start": "1953340",
    "end": "1960060"
  },
  {
    "text": "think about application security inside of your cluster and we want to make the tools available such that the",
    "start": "1960060",
    "end": "1966150"
  },
  {
    "text": "information is there that you can build on top of it but the the endgame is",
    "start": "1966150",
    "end": "1972120"
  },
  {
    "text": "definitely up to you I think I think to like in that space like that's probably three or four vendors on within the",
    "start": "1972120",
    "end": "1978030"
  },
  {
    "text": "floor right now that are like that have built systems exactly to do that so it I",
    "start": "1978030",
    "end": "1983970"
  },
  {
    "text": "think that the community is kind of perspective is that you know we want to",
    "start": "1983970",
    "end": "1989940"
  },
  {
    "text": "keep things out of core where they didn't really need to be in court and then provide opportunities for other",
    "start": "1989940",
    "end": "1995430"
  },
  {
    "text": "people to build tooling on top and where there's already kind of like that's already happening and I think that's",
    "start": "1995430",
    "end": "2000800"
  },
  {
    "text": "probably a good indication that we have the right extension points already and we probably don't need to build that in",
    "start": "2000800",
    "end": "2006320"
  },
  {
    "text": "the kubernetes how can I name the vendors no account but they're on there",
    "start": "2006320",
    "end": "2013010"
  },
  {
    "text": "they're on the demo floor oh yeah",
    "start": "2013010",
    "end": "2019930"
  },
  {
    "text": "yeah so it was actually in the in the second DOMA it was actually just so the question was why could you get that",
    "start": "2034200",
    "end": "2041220"
  },
  {
    "text": "that payment secret if the payments thing wasn't scheduled on the on the node where you were where would",
    "start": "2041220",
    "end": "2046649"
  },
  {
    "text": "compromise it so in the in the first demo it actually was we made sure it was it was Co scheduled and then kind of",
    "start": "2046649",
    "end": "2053099"
  },
  {
    "text": "like to fix it we separated it out but yeah that's exactly what the node authorizer and admission does it in make",
    "start": "2053099",
    "end": "2059158"
  },
  {
    "text": "sure like yeah if the the blast radius for compromise of a single node should be the secrets that I could further pods",
    "start": "2059159",
    "end": "2066118"
  },
  {
    "text": "that are currently scheduled on that node and not all the other secrets in the system so that's yeah as of 1:7 that",
    "start": "2066119",
    "end": "2071669"
  },
  {
    "text": "was a case yeah so there is a bit of a",
    "start": "2071669",
    "end": "2083908"
  },
  {
    "text": "weakness in the init ain't scintillations mechanisms at the moment so you the cubelet can change its labels that's",
    "start": "2083909",
    "end": "2090929"
  },
  {
    "text": "exactly one of the things that sorry the question was like if you have the cubes",
    "start": "2090929",
    "end": "2096480"
  },
  {
    "text": "credentials could could you change something to get the other stuff scheduled on you where it isn't supposed",
    "start": "2096480",
    "end": "2102240"
  },
  {
    "text": "to be that's yeah and so yeah there is that weakness at the moment and that's definitely something we're working on in",
    "start": "2102240",
    "end": "2107579"
  },
  {
    "text": "in 2018 we're gonna close that one off I would have the cubelets can't directly",
    "start": "2107579",
    "end": "2112950"
  },
  {
    "text": "schedule pods onto themselves though and they can't create new pods yeah they'd have to change the labels so if you're using the taint scintillations and the",
    "start": "2112950",
    "end": "2120000"
  },
  {
    "text": "label selectors to put them on different pods and the cubic and change those so I think it's still worth doing that at the",
    "start": "2120000",
    "end": "2126660"
  },
  {
    "text": "moment anyway because the the protections are going to come in and you already be set up to set up these own",
    "start": "2126660",
    "end": "2134299"
  },
  {
    "text": "the question was is that the case even when you download cube CTL and yeah it just depends on what identity you're",
    "start": "2141220",
    "end": "2147590"
  },
  {
    "text": "acting as what credentials you grabbed so cube CTL is just gonna use whatever identity you were able to grab and if",
    "start": "2147590",
    "end": "2153650"
  },
  {
    "text": "that's a node identity a cubelet identity you're restricted by the permissions that that cubelet has yes so",
    "start": "2153650",
    "end": "2159230"
  },
  {
    "text": "the prerequisite would be root on the node to get access to those those cubelet credentials so you'd have to do contain a breakout privilege escalation",
    "start": "2159230",
    "end": "2165170"
  },
  {
    "text": "steal the qiblah credentials then do this so there is definitely like a that's not a trivial process there's the",
    "start": "2165170",
    "end": "2170990"
  },
  {
    "text": "serious work involved in that yeah yeah",
    "start": "2170990",
    "end": "2184790"
  },
  {
    "text": "that's basically what network palsy is so is it possible for pods in one namespace",
    "start": "2184790",
    "end": "2190250"
  },
  {
    "text": "at the network level to be blocked from accessing pods in another namespace that's what network policy does for you",
    "start": "2190250",
    "end": "2195830"
  },
  {
    "text": "yeah one more minute",
    "start": "2195830",
    "end": "2202000"
  },
  {
    "text": "yeah so the question is like how do you respond to an attack like this like how do you detect it how do you respond to",
    "start": "2210980",
    "end": "2216900"
  },
  {
    "text": "it we didn't really cover that at all there's definitely a bunch of stuff you can do so one really basic thing you",
    "start": "2216900",
    "end": "2223320"
  },
  {
    "text": "definitely want to do is collect the API master or audit logging so over all",
    "start": "2223320",
    "end": "2228720"
  },
  {
    "text": "those interactions we were making with the API server or get logged and then you can build detections on those on gke",
    "start": "2228720",
    "end": "2234839"
  },
  {
    "text": "they all go into a stack driver and if you enable logging and you can do really",
    "start": "2234839",
    "end": "2240420"
  },
  {
    "text": "quite powerful querying and detection on the API stuff there I think there's also",
    "start": "2240420",
    "end": "2246420"
  },
  {
    "text": "the scope and a bunch of products kind of operating in the space of detecting stuff on the node itself and so there's",
    "start": "2246420",
    "end": "2254849"
  },
  {
    "text": "a bunch of people building products right now to do you know detection of unusual events things that are happening",
    "start": "2254849",
    "end": "2261839"
  },
  {
    "text": "on the node itself is there anything else you'd add to that yeah",
    "start": "2261839",
    "end": "2269750"
  },
  {
    "text": "okay I think we might call it thanks everyone [Applause]",
    "start": "2273600",
    "end": "2281780"
  }
]