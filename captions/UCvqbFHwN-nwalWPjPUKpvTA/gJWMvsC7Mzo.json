[
  {
    "text": "all right I'm going to go ahead and get started uh thank you everybody for coming this morning I'm excited about this talk I hope it is",
    "start": "240",
    "end": "7500"
  },
  {
    "text": "interesting to you all my name is Joe Betts I'm an engineer at Google I've been working on kubernetes for about",
    "start": "7500",
    "end": "12840"
  },
  {
    "text": "five years I spent a couple years as an FCD maintainer and quite a bit of time",
    "start": "12840",
    "end": "18180"
  },
  {
    "text": "as a contributor to Sig API Machinery where I've been working on extensibility features today we're going to talk about",
    "start": "18180",
    "end": "24779"
  },
  {
    "text": "some enhancements that take advantage of something called the common expression language we're using this to try and",
    "start": "24779",
    "end": "31199"
  },
  {
    "text": "address some of the problems that people have been facing with web hooks with kubernetes so I got quite a bit to cover today I'm",
    "start": "31199",
    "end": "38640"
  },
  {
    "text": "going to get started by giving a brief history of web hooks that kind of motivate the problems that we're trying",
    "start": "38640",
    "end": "44579"
  },
  {
    "text": "to solve then I'm going to dive in and give you a more detail explanation of",
    "start": "44579",
    "end": "50340"
  },
  {
    "text": "what the common expression language is and why we think it is a useful enhancement it's going to help us solve",
    "start": "50340",
    "end": "57180"
  },
  {
    "text": "problems I'll then dive into two major use cases the first use case is going to",
    "start": "57180",
    "end": "62300"
  },
  {
    "text": "be crd validation which most people would prefer not to use a web hook to do",
    "start": "62300",
    "end": "68760"
  },
  {
    "text": "and then the second one is admission control usually focusing on policy",
    "start": "68760",
    "end": "75560"
  },
  {
    "text": "enforcement use cases I'll then wrap it up tie it together talk about the future and some areas where we can use some",
    "start": "75560",
    "end": "81659"
  },
  {
    "text": "help so let's um get started by talking about the history of web admission web",
    "start": "81659",
    "end": "87659"
  },
  {
    "text": "hooks so these were introduced back in kubernetes 1.7 roughly this is about",
    "start": "87659",
    "end": "93780"
  },
  {
    "text": "five years ago when I was first starting to work on the project crds at the time were pretty young",
    "start": "93780",
    "end": "99079"
  },
  {
    "text": "and there was a lot of people looking to use kubernetes for all sorts of things that it couldn't do natively and so the",
    "start": "99079",
    "end": "106860"
  },
  {
    "text": "kind of the extension ecosystem was flourishing but not all the extension points were available at that time",
    "start": "106860",
    "end": "113340"
  },
  {
    "text": "and I went back and looked at some of the documents explaining what people were trying to accomplish when they",
    "start": "113340",
    "end": "119880"
  },
  {
    "text": "introduced admission web Hooks and I think they got the list pretty right because when you go and look at what books are used for today it more or less",
    "start": "119880",
    "end": "126119"
  },
  {
    "text": "matches this list so they had identified that organizations needed better policy control",
    "start": "126119",
    "end": "131400"
  },
  {
    "text": "that cloud providers needed better extension points to integrate with kubernetes and that extension authors",
    "start": "131400",
    "end": "137580"
  },
  {
    "text": "need a better way to perform crd validation it's actually a pretty accurate list",
    "start": "137580",
    "end": "142620"
  },
  {
    "text": "and at the time there was a couple different options there was a feature",
    "start": "142620",
    "end": "148200"
  },
  {
    "text": "called initializers that was an alpha at the time there was the built-in",
    "start": "148200",
    "end": "153540"
  },
  {
    "text": "admission controllers and kubernetes that are compiled into the API server and then there was an early form of",
    "start": "153540",
    "end": "160440"
  },
  {
    "text": "admission web hooks that was also an alpha and so after some kind of comparison of",
    "start": "160440",
    "end": "166019"
  },
  {
    "text": "these options the decision was made to invest in admission web hooks mostly because it solved more of the use cases",
    "start": "166019",
    "end": "172319"
  },
  {
    "text": "than any of the other Alternatives and in some sense this was a success because it turned out to be a powerful pressure",
    "start": "172319",
    "end": "179160"
  },
  {
    "text": "relief valve and by what by that I mean it was a kind of an extension mechanism that allowed people to do all sorts of",
    "start": "179160",
    "end": "186000"
  },
  {
    "text": "things both anticipated and anticipated",
    "start": "186000",
    "end": "190980"
  },
  {
    "text": "um and people were successful in implementing a lot of what they needed to build with this a ton of great stuff",
    "start": "191040",
    "end": "196620"
  },
  {
    "text": "has been built you can see web hooks in pretty widespread use across kubernetes but unfortunately that's where things",
    "start": "196620",
    "end": "203220"
  },
  {
    "text": "started to get into trouble um reports started coming in of people um you know cluster admins and Cloud",
    "start": "203220",
    "end": "210540"
  },
  {
    "text": "providers were reporting control plane outages from web hooks they were reporting filled upgrades they were even",
    "start": "210540",
    "end": "215640"
  },
  {
    "text": "recording reporting failed rollbacks and it took a while for everybody to",
    "start": "215640",
    "end": "221580"
  },
  {
    "text": "kind of start to get their head around what had gone wrong but I think there was two major categories of problems",
    "start": "221580",
    "end": "227280"
  },
  {
    "text": "that were causing web hooks to cause so much trouble one is that they're operationally complex so every time you",
    "start": "227280",
    "end": "233400"
  },
  {
    "text": "want to introduce a web hook into a cluster you're introducing a new binary it has to run somewhere you have to",
    "start": "233400",
    "end": "238980"
  },
  {
    "text": "figure out how to deploy that binary upgrade it roll it back monitor it have",
    "start": "238980",
    "end": "244920"
  },
  {
    "text": "you know run books to deal with any problems with it it effectively becomes another component in your control plane",
    "start": "244920",
    "end": "251580"
  },
  {
    "text": "and so if you have a lot of web hooks you have a lot of components in your control plane you now have to manage",
    "start": "251580",
    "end": "257880"
  },
  {
    "text": "the other problem is they're way too easy to misconfigure I think the the most obvious example of this is that",
    "start": "257880",
    "end": "264180"
  },
  {
    "text": "whenever you install a web hook you have to decide what its failure policy is you either have to choose fail open or you",
    "start": "264180",
    "end": "270660"
  },
  {
    "text": "choose fail closed if you choose fail open what you're saying is that if my web hook fails the binary stops serving",
    "start": "270660",
    "end": "278460"
  },
  {
    "text": "requests either it's become unavailable or it starts returning errors then I'm just going to let the request through",
    "start": "278460",
    "end": "284340"
  },
  {
    "text": "anyways even if that web hook would have rejected them so if the purpose of your web Hook was",
    "start": "284340",
    "end": "289680"
  },
  {
    "text": "to enforce some security policy that's clearly a problem on the other hand if you choose to fail",
    "start": "289680",
    "end": "297360"
  },
  {
    "text": "closed what you're saying is if that webbook's having a problem let's return theirs if it's unavailable I'm going to",
    "start": "297360",
    "end": "303600"
  },
  {
    "text": "reject all requests that that were being routed to that web hook right so if I was matching all pods or all deployments",
    "start": "303600",
    "end": "311160"
  },
  {
    "text": "now I'm going to reject all those requests and I'm basically losing my control plane availability",
    "start": "311160",
    "end": "316320"
  },
  {
    "text": "those are your two options right that's kind of at the heart of some of the problems that we have with web hooks",
    "start": "316320",
    "end": "322800"
  },
  {
    "text": "the one way I like to think about this is the more web hooks are using in the cluster the lower the expected cluster",
    "start": "322800",
    "end": "329400"
  },
  {
    "text": "availability and the more types of issues you can expect to have happen I think over time cluster administrators",
    "start": "329400",
    "end": "336000"
  },
  {
    "text": "have become aware of this and have become more and more wary of web hooks but we're stuck in the situation where there's a large classes of functionality",
    "start": "336000",
    "end": "342840"
  },
  {
    "text": "that we want and web hooks is the only way to do it so the story isn't over we're going to",
    "start": "342840",
    "end": "348419"
  },
  {
    "text": "try and tell the rest of the story hopefully we can we can turn some things around here",
    "start": "348419",
    "end": "353940"
  },
  {
    "text": "and one of the one of the pieces of good news is that if you actually go and look at what web books are doing the vast",
    "start": "353940",
    "end": "360000"
  },
  {
    "text": "majority of them are doing super simple stuff they maybe need to make sure that a",
    "start": "360000",
    "end": "365520"
  },
  {
    "text": "particular field in a crd is immutable they need to make sure that a label",
    "start": "365520",
    "end": "370800"
  },
  {
    "text": "works the way they want so maybe they always check that a label's value conforms to a specific format",
    "start": "370800",
    "end": "377039"
  },
  {
    "text": "or maybe if they have a policy in their company where they want um all pods or containers to have some",
    "start": "377039",
    "end": "383280"
  },
  {
    "text": "particular value set in a particular way most of these share the common property of being able to be expressed in just",
    "start": "383280",
    "end": "389639"
  },
  {
    "text": "like a line or two of code so this is a good chance to apply the 80 20 rule we can say that there's 80",
    "start": "389639",
    "end": "396240"
  },
  {
    "text": "percent of these use cases and probably more than 80 honestly could be easily handled by something simpler than",
    "start": "396240",
    "end": "402840"
  },
  {
    "text": "running your own full binary with you know all the power of a complete programming language",
    "start": "402840",
    "end": "409020"
  },
  {
    "text": "there's probably as you know a small percentage of these that still require a",
    "start": "409020",
    "end": "414360"
  },
  {
    "text": "call out to some other system right having a fallback as where we continue to use web hooks is probably not a bad",
    "start": "414360",
    "end": "420660"
  },
  {
    "text": "thing but I think if we can solve this 80 use case we've already made a huge amount of progress on this problem",
    "start": "420660",
    "end": "427919"
  },
  {
    "text": "so I'm going to focus on that today and the tool that we're going to look at is called the common expression language",
    "start": "427919",
    "end": "433979"
  },
  {
    "text": "let me give you just a couple examples of what that looks like so here's some code there's three",
    "start": "433979",
    "end": "440400"
  },
  {
    "text": "examples here the one thing I hope everybody notices is that this is a pretty unsurprising syntax right this is",
    "start": "440400",
    "end": "446819"
  },
  {
    "text": "if you've worked in any c style programming languages you can probably guess what this code does and you're",
    "start": "446819",
    "end": "452099"
  },
  {
    "text": "probably right I'm not going to read through all those examples but I am going to give you a",
    "start": "452099",
    "end": "459840"
  },
  {
    "text": "little bit of access to some of the documentation from cell I think the authors have done a pretty good job of",
    "start": "459840",
    "end": "466139"
  },
  {
    "text": "explaining what the purpose of this language is now you it is only an expression language it's not a scripting",
    "start": "466139",
    "end": "471539"
  },
  {
    "text": "language so you're only going to write a single expression assay program and that limitation causes some problems",
    "start": "471539",
    "end": "478919"
  },
  {
    "text": "but I think in our case it's more of a benefit than anything it's easy to run",
    "start": "478919",
    "end": "484199"
  },
  {
    "text": "sell quickly it comes with a really nice syntax Checker you can run a type checking pass on it",
    "start": "484199",
    "end": "490380"
  },
  {
    "text": "it's easy to extend and it's really easy to embed and integrate with languages so we've been able to successfully",
    "start": "490380",
    "end": "496199"
  },
  {
    "text": "integrate this with the with the kubernetes data system very well both for crds and Native types",
    "start": "496199",
    "end": "501919"
  },
  {
    "text": "and it works really well so here are two",
    "start": "501919",
    "end": "506940"
  },
  {
    "text": "of the major limitations you should know about cell right away the first is because you can only write a single",
    "start": "506940",
    "end": "512159"
  },
  {
    "text": "expression you don't get any native for or while looping instead you're going to be using kind of a comprehension form",
    "start": "512159",
    "end": "519479"
  },
  {
    "text": "so there's there's the comprehensions listed here also you don't have an",
    "start": "519479",
    "end": "524580"
  },
  {
    "text": "explicit if else so instead we're going to be using the ternary operator I just wanted to show a couple examples of that",
    "start": "524580",
    "end": "529980"
  },
  {
    "text": "because this is one of the less obvious things about cell so in this first example what we're",
    "start": "529980",
    "end": "535680"
  },
  {
    "text": "doing is we're verifying that two sets are disjoint so we're using that all comprehension to iterate over one set",
    "start": "535680",
    "end": "542160"
  },
  {
    "text": "and then we just check that it none of those elements are in the second set the second example is even more",
    "start": "542160",
    "end": "548220"
  },
  {
    "text": "complicated so what we're doing is we're taking a list of objects where every object has a priority field and we're",
    "start": "548220",
    "end": "555000"
  },
  {
    "text": "making sure that no two of those objects have the same priority value this is possible to do it's kind of on",
    "start": "555000",
    "end": "561420"
  },
  {
    "text": "the edge of what you can do with cell and it's not super obvious how to write this one I wanted to show a more",
    "start": "561420",
    "end": "567180"
  },
  {
    "text": "difficult example to give people an idea of kind of where the limits of some might be",
    "start": "567180",
    "end": "573560"
  },
  {
    "text": "now one of the things that you'll you'll probably occur to you pretty quick is well if I can only write a single",
    "start": "573899",
    "end": "579360"
  },
  {
    "text": "expression that does limit me in many ways are there utility libraries that I can take advantage of to do more things",
    "start": "579360",
    "end": "585600"
  },
  {
    "text": "and the answer of course is yes cell comes with a pretty good standard Library there are extension libraries",
    "start": "585600",
    "end": "591600"
  },
  {
    "text": "for things like strings regex matching and things like that that we're including in kubernetes we also went and",
    "start": "591600",
    "end": "597600"
  },
  {
    "text": "looked at four or five major programming languages and just kind of went through all of the most fundamental utilities",
    "start": "597600",
    "end": "603779"
  },
  {
    "text": "available in those languages and built out an even more extended library that",
    "start": "603779",
    "end": "609000"
  },
  {
    "text": "we're going to make available with kubernetes so that includes more things for regex more things for list processing we also identified that even",
    "start": "609000",
    "end": "615899"
  },
  {
    "text": "though you could handle like URL parsing with reg X that that's pretty awkward to ask people to do so we're going to",
    "start": "615899",
    "end": "622080"
  },
  {
    "text": "provide first class support for that so here's some examples of some things you can do a cell using the function",
    "start": "622080",
    "end": "627839"
  },
  {
    "text": "libraries you do get kind of like a method type syntax or if you go a receiver type syntax where you can say",
    "start": "627839",
    "end": "634200"
  },
  {
    "text": "dot to call functions we have added a couple special functions like the",
    "start": "634200",
    "end": "639240"
  },
  {
    "text": "ability to check if the list is sorted because we think that's really useful in validation and then the URL processing",
    "start": "639240",
    "end": "645839"
  },
  {
    "text": "we were pretty careful we looked at a lot of examples on how to do that right if you want to learn more about cell I",
    "start": "645839",
    "end": "653339"
  },
  {
    "text": "would encourage you to check out the spec it's being used in a variety of policy systems it's been used in some",
    "start": "653339",
    "end": "659220"
  },
  {
    "text": "systems that extend kubernetes it's being used in other cloud provider systems it's pretty it's got pretty",
    "start": "659220",
    "end": "664680"
  },
  {
    "text": "solid adoption and we've been working a lot with the authors we're pretty confident in it",
    "start": "664680",
    "end": "670079"
  },
  {
    "text": "so next I'm going to dive into two major use cases the first use case I'm going to look at is crd validation which all",
    "start": "670079",
    "end": "676980"
  },
  {
    "text": "has to do with a single field so this is that field it is the x- kubernetes dash",
    "start": "676980",
    "end": "682320"
  },
  {
    "text": "validations field and here is it in use you can use this anywhere in a crd",
    "start": "682320",
    "end": "688440"
  },
  {
    "text": "starting in kubernetes 1.25 we put it in beta there we hope to bring it into gas sometime soon and what you can do is you",
    "start": "688440",
    "end": "696660"
  },
  {
    "text": "can just start writing cell rules under this extension in the open API schema",
    "start": "696660",
    "end": "702839"
  },
  {
    "text": "so in this example the self variable refers to the location in the schema where we put this crd validation rule so",
    "start": "702839",
    "end": "711480"
  },
  {
    "text": "this rule is written right under the spec so self refers to spec and the spec",
    "start": "711480",
    "end": "717600"
  },
  {
    "text": "contains both a replicas and a Max replicas integer field so you can access both of those in the dot operator if you",
    "start": "717600",
    "end": "725279"
  },
  {
    "text": "then update your crd after writing this any any c any custom resources that you",
    "start": "725279",
    "end": "731220"
  },
  {
    "text": "try and write will be validated according to this rule you can add a message next to the rule if you want to give it a human readable error",
    "start": "731220",
    "end": "738120"
  },
  {
    "text": "if you mistype the name of a field and try and update the crd you're going to",
    "start": "738120",
    "end": "743339"
  },
  {
    "text": "immediately get an error when you try and write the crd this prevents you from actually updating a cluster with a",
    "start": "743339",
    "end": "750839"
  },
  {
    "text": "malformed rule so we're doing type checking it's type checking against the fields down below if you just fix the field name then you can write the crd",
    "start": "750839",
    "end": "757380"
  },
  {
    "text": "and you're good again now you can put multiple validation",
    "start": "757380",
    "end": "762420"
  },
  {
    "text": "rules in this in a crd here's an example of me placing the same validation rule",
    "start": "762420",
    "end": "767519"
  },
  {
    "text": "at two different locations so one is up at the spec level and one is down on the",
    "start": "767519",
    "end": "773100"
  },
  {
    "text": "field Foo they're the same Rule and they do exactly the same thing but the one on",
    "start": "773100",
    "end": "778980"
  },
  {
    "text": "the foo field is more convenient because the Field's optional if you put the rule",
    "start": "778980",
    "end": "784139"
  },
  {
    "text": "up at the top at the spec level you have to first check if the Field's present but you don't need to do that if you put",
    "start": "784139",
    "end": "789540"
  },
  {
    "text": "it on the actual field itself because it'll only be run if that value is present so there are some conveniences that you",
    "start": "789540",
    "end": "795899"
  },
  {
    "text": "can get for choosing where to scope the rule we encourage you to scope rules as narrowly as possible because it makes",
    "start": "795899",
    "end": "802139"
  },
  {
    "text": "them easier to write sometimes you need to put this the um rule higher in the schema tree so you",
    "start": "802139",
    "end": "808680"
  },
  {
    "text": "have access to more Fields if you're doing things like Cross Field validation",
    "start": "808680",
    "end": "813980"
  },
  {
    "text": "in addition to the self rule we give you access to an old self what old self is it is the value before",
    "start": "814620",
    "end": "821160"
  },
  {
    "text": "your update so if you're updating the full value from four to five old self will be four self will be five you can",
    "start": "821160",
    "end": "828360"
  },
  {
    "text": "use this to do things like an immutability check which is what we're doing here you could do things like enforce that a value is only a",
    "start": "828360",
    "end": "835440"
  },
  {
    "text": "monatomically increasing you could have an append only list there's a large variety of use cases for this my",
    "start": "835440",
    "end": "841920"
  },
  {
    "text": "colleague Alex zielinski wrote a nice blog entry explaining a bunch of the use cases that you can support with this",
    "start": "841920",
    "end": "849320"
  },
  {
    "text": "uh one of the things that comes up pretty quick when you think about adding a programming language into yaml is like",
    "start": "850019",
    "end": "856800"
  },
  {
    "text": "what types of abuse are we prone to from this um so the good thing is cell is by",
    "start": "856800",
    "end": "862980"
  },
  {
    "text": "Design preventing a lot of types of abuse the way it's interpreted means that you can't really break out of a",
    "start": "862980",
    "end": "868019"
  },
  {
    "text": "Sandbox the fact that you can't allocate variables means that there's tight",
    "start": "868019",
    "end": "873600"
  },
  {
    "text": "memory constraints but there's still the ability to write programs that could take way too long to run",
    "start": "873600",
    "end": "878880"
  },
  {
    "text": "so we're take we're using a kind of a three-prong safety approach against this the first is we're going to take",
    "start": "878880",
    "end": "884579"
  },
  {
    "text": "advantage of the fact that cell is not a Terrain complete programming language and you can use static analysis to",
    "start": "884579",
    "end": "890220"
  },
  {
    "text": "figure out what it's worst time running worst cost running time is",
    "start": "890220",
    "end": "895560"
  },
  {
    "text": "um so we make some assumptions about how big lists can be by the fact that you're processing yaml and there's a three",
    "start": "895560",
    "end": "901560"
  },
  {
    "text": "megabyte limited on that yaml so if you try and write a if you intentionally",
    "start": "901560",
    "end": "907620"
  },
  {
    "text": "write a cell rule that like does like an O cubed operation on the longest possible list we're going to actually",
    "start": "907620",
    "end": "914040"
  },
  {
    "text": "detect that when you write the rule into your crd we're not going to allow you to do it you'll get a narrow say in",
    "start": "914040",
    "end": "919860"
  },
  {
    "text": "something that you've exceeded the estimated cost limit and you're going to either need to rewrite that rule or give it hints about the size of lists and",
    "start": "919860",
    "end": "926459"
  },
  {
    "text": "things so that's our kind of our first prevention that happens statically when",
    "start": "926459",
    "end": "932220"
  },
  {
    "text": "you author crds the second safety functions very similarly but happens at runtime so again we're going to use this",
    "start": "932220",
    "end": "938940"
  },
  {
    "text": "abstract cost unit measure and when your program's running cell is going to start accumulating the cost and that's",
    "start": "938940",
    "end": "945060"
  },
  {
    "text": "platform independent so it doesn't really matter if your CPU is running slow or you've got a lot of load it's",
    "start": "945060",
    "end": "950399"
  },
  {
    "text": "still going to run the same programs towards to the same completion but if",
    "start": "950399",
    "end": "955500"
  },
  {
    "text": "you do hit that limit we're going to Halt sell execution to prevent it from running indefinitely we even have a",
    "start": "955500",
    "end": "961199"
  },
  {
    "text": "third fallback which is we wired goes contacts context cancellation into cell",
    "start": "961199",
    "end": "968040"
  },
  {
    "text": "so that if the request is canceled in any way either because the client went away or because we've hit a timeout",
    "start": "968040",
    "end": "974160"
  },
  {
    "text": "we're also going to stop sell execution immediately so we put a lot of safety nets in place",
    "start": "974160",
    "end": "979199"
  },
  {
    "text": "to try and keep um cell runtime under control just to summarize you can use crd",
    "start": "979199",
    "end": "986220"
  },
  {
    "text": "validation rules to write complex validation for your crds you just use",
    "start": "986220",
    "end": "991440"
  },
  {
    "text": "cell you put it into these x dash kubernetes-validations Fields you can do complex multi-field validation you can",
    "start": "991440",
    "end": "998100"
  },
  {
    "text": "use transition rules to do things like immutability we think this is a sufficient substitute for the vast",
    "start": "998100",
    "end": "1003860"
  },
  {
    "text": "majority of things people are using web hooks for when they do crd validation we think this is mostly a solved problem",
    "start": "1003860",
    "end": "1010459"
  },
  {
    "text": "I'm sure people are going to find Corner cases that we can't support come talk to us but I think the vast majority of",
    "start": "1010459",
    "end": "1017360"
  },
  {
    "text": "these are pretty well solved so once we got that in place we started looking for other opportunities to use",
    "start": "1017360",
    "end": "1024079"
  },
  {
    "text": "cell in fact one of them was the thing I'd wanted to use self for in the first place which was policy enforcement when",
    "start": "1024079",
    "end": "1031819"
  },
  {
    "text": "we looked at all the things people were using admission web hooks for this was by far the largest bucket everybody was",
    "start": "1031819",
    "end": "1037640"
  },
  {
    "text": "kind of telling us generally the things I'm trying to do fall into this category",
    "start": "1037640",
    "end": "1043819"
  },
  {
    "text": "this is a big and complicated space there are many systems built to do policy enforcement and",
    "start": "1043819",
    "end": "1051200"
  },
  {
    "text": "it took us a while to get our heads around a lot of the things that people were trying to achieve and we looked",
    "start": "1051200",
    "end": "1057320"
  },
  {
    "text": "beyond just kubernetes we looked we talked to other people doing policy enforcement other parts of cloud",
    "start": "1057320",
    "end": "1062960"
  },
  {
    "text": "um Cloud infrastructure there are entire programming languages written around this it's a big space but what we did is",
    "start": "1062960",
    "end": "1070280"
  },
  {
    "text": "we tried to focus down on what we needed to do in kubernetes to make this possible with a minimal use of web hooks",
    "start": "1070280",
    "end": "1076820"
  },
  {
    "text": "ultimately we wrote a cup for this it's called sell for admission control you're welcome to check it out",
    "start": "1076820",
    "end": "1082340"
  },
  {
    "text": "and what I'm going to try and do next is explain what's proposed in that cut we're working on implementing this right",
    "start": "1082340",
    "end": "1088760"
  },
  {
    "text": "now we're hoping to get our first Alpha in 1.26 which should be out in around a",
    "start": "1088760",
    "end": "1093799"
  },
  {
    "text": "month or so and to kind of motivate what we're trying to do we wanted to make a clear",
    "start": "1093799",
    "end": "1099620"
  },
  {
    "text": "distinction between two major roles when you do policy enforcement you have the policy author and you have the cluster",
    "start": "1099620",
    "end": "1105620"
  },
  {
    "text": "administrator these are usually not the same person and they're usually in completely different organizations",
    "start": "1105620",
    "end": "1113000"
  },
  {
    "text": "the policy author is concerned with the correctness of a policy so there in our case they'll be writing cell they want",
    "start": "1113000",
    "end": "1118880"
  },
  {
    "text": "to make sure they wrote that right they want to test it they also want to write reusable policies usually they're trying",
    "start": "1118880",
    "end": "1124760"
  },
  {
    "text": "to support more than one organization so they're very concerned with making their policy sufficiently configurable to",
    "start": "1124760",
    "end": "1130580"
  },
  {
    "text": "handle more than just one customer cluster administrators on the other hand",
    "start": "1130580",
    "end": "1136220"
  },
  {
    "text": "are very concerned with making sure that a policy matches the goals of their organization and they're very interested",
    "start": "1136220",
    "end": "1143120"
  },
  {
    "text": "in the operability of those policies rolling out a policy can be kind of a scary thing and they want to make that",
    "start": "1143120",
    "end": "1150200"
  },
  {
    "text": "as safe as possible so what we've done is we've introduced some new kubernetes resources that are",
    "start": "1150200",
    "end": "1157580"
  },
  {
    "text": "aligned with these different responsibilities so the policy author is going to be",
    "start": "1157580",
    "end": "1163220"
  },
  {
    "text": "responsible for writing a validating admission policy here they'll Define in the match",
    "start": "1163220",
    "end": "1169100"
  },
  {
    "text": "constraints which resources that policy applies to this is very similar to how",
    "start": "1169100",
    "end": "1174679"
  },
  {
    "text": "an admission web hook works today then they're going to write cell rules that Express what that policy does",
    "start": "1174679",
    "end": "1183080"
  },
  {
    "text": "in that cell rule they can reference both the object and some other fields and they can reference the params that",
    "start": "1183080",
    "end": "1191120"
  },
  {
    "text": "they use to make this configurable last they Define a params kind which says",
    "start": "1191120",
    "end": "1197059"
  },
  {
    "text": "what type of resource they're using to parametize their policy in this case they're using a crd in a simpler case",
    "start": "1197059",
    "end": "1203840"
  },
  {
    "text": "you could choose to use a config map next the cluster administrator is going",
    "start": "1203840",
    "end": "1210380"
  },
  {
    "text": "to create what we call a binding The Binding is what connects this policy definition to their cluster",
    "start": "1210380",
    "end": "1217580"
  },
  {
    "text": "and they do this with a couple Fields the policy name says which policy they're binding to their cluster the",
    "start": "1217580",
    "end": "1224000"
  },
  {
    "text": "params ref says Which object they're using to parametize that policy and then",
    "start": "1224000",
    "end": "1229460"
  },
  {
    "text": "lastly they can have what's called match resources which further constrain what resources in their cluster this policy",
    "start": "1229460",
    "end": "1235520"
  },
  {
    "text": "applies to so in this case the cluster administrator has constrained this",
    "start": "1235520",
    "end": "1241700"
  },
  {
    "text": "policy to just the objects in their test name Spaces by using this environment",
    "start": "1241700",
    "end": "1248299"
  },
  {
    "text": "label on their namespaces and they've set the max replicas to three for that environment",
    "start": "1248299",
    "end": "1254840"
  },
  {
    "text": "they could create an additional policy policy binding for their you know production environment and set this to a",
    "start": "1254840",
    "end": "1261860"
  },
  {
    "text": "different limit for that so you can have more than one binding for a policy and",
    "start": "1261860",
    "end": "1267679"
  },
  {
    "text": "you can have as many params as you want you can share params between policies if you need or you can create new ones for",
    "start": "1267679",
    "end": "1273140"
  },
  {
    "text": "each now one thing you might notice about this which is a bit of a downside is this is quite a few resources to create",
    "start": "1273140",
    "end": "1279679"
  },
  {
    "text": "to get something done right here in this example you're looking at four different kubernetes resources",
    "start": "1279679",
    "end": "1285740"
  },
  {
    "text": "we can simplify that if you don't need parametrization we can go down to just two resources if the if the policy",
    "start": "1285740",
    "end": "1292580"
  },
  {
    "text": "author doesn't specify any need to parametize their policy then the cluster",
    "start": "1292580",
    "end": "1298280"
  },
  {
    "text": "administrator just needs a single bind and you're done we're down to two resources we take that even further in",
    "start": "1298280",
    "end": "1304340"
  },
  {
    "text": "the most basic case if you're writing a one-off policy you can write the whole thing just in the validating admission",
    "start": "1304340",
    "end": "1309919"
  },
  {
    "text": "policy basically what you're going to do is inline your bio your binding information into that and you can do",
    "start": "1309919",
    "end": "1314960"
  },
  {
    "text": "that as a single resource we think that's useful for cases where somebody just needs to do something",
    "start": "1314960",
    "end": "1321020"
  },
  {
    "text": "simple as a one-off case and they're not building like a larger you know policy engine or something like that",
    "start": "1321020",
    "end": "1327980"
  },
  {
    "text": "we're just getting started with this feature so this is we're working to try and get it out in 1.26 which is in",
    "start": "1327980",
    "end": "1333320"
  },
  {
    "text": "development now in the future before we bring this to Beta we hope to support a variety of",
    "start": "1333320",
    "end": "1338360"
  },
  {
    "text": "other things we hope to support more actions than what we support now so right now you can only admit or deny a",
    "start": "1338360",
    "end": "1344900"
  },
  {
    "text": "request but we don't think that's enough we want to be able to have you support like creating an audit annotation or",
    "start": "1344900",
    "end": "1351740"
  },
  {
    "text": "sending a warning back to the user but not blocking the user if the um if the",
    "start": "1351740",
    "end": "1357260"
  },
  {
    "text": "policy fails we want to support what we call secondary authorization checks this is",
    "start": "1357260",
    "end": "1362600"
  },
  {
    "text": "an interesting case so the example I like to give is imagine that you want to",
    "start": "1362600",
    "end": "1368120"
  },
  {
    "text": "um set up a policy that only allows certain users with like a certain rbac role to",
    "start": "1368120",
    "end": "1374480"
  },
  {
    "text": "change an enum to a particular value that's actually really easy to do and sell because you can check whether or",
    "start": "1374480",
    "end": "1380780"
  },
  {
    "text": "not somebody's changing something to a particular enum value so all we need to do is give you some access to the user's",
    "start": "1380780",
    "end": "1387799"
  },
  {
    "text": "permission sets and you could write a check like that so we do intend to support that use case",
    "start": "1387799",
    "end": "1392840"
  },
  {
    "text": "we also intend to add a lot more support for the rollout of new policies so",
    "start": "1392840",
    "end": "1399320"
  },
  {
    "text": "that's a cluster administrator you probably when you first introduce a new policy you probably don't want it enforcing yet you probably want to just",
    "start": "1399320",
    "end": "1406159"
  },
  {
    "text": "turn it on in kind of a dry run mode and see what happens so we're looking at some ways to do that in a really safe",
    "start": "1406159",
    "end": "1412280"
  },
  {
    "text": "way so you can gather metrics you can look you can see what the policy would do before you turn it fully on",
    "start": "1412280",
    "end": "1418039"
  },
  {
    "text": "there's a fuller list of features here in the cup I would encourage you to check it out if you're interested this",
    "start": "1418039",
    "end": "1424039"
  },
  {
    "text": "is still in development so we're very much looking for feedback from the community on what would be the most",
    "start": "1424039",
    "end": "1429679"
  },
  {
    "text": "valuable all right I'm going to start drawing",
    "start": "1429679",
    "end": "1435260"
  },
  {
    "text": "some conclusions the way that I've been trying to think about the work that we've been doing is that you've got this",
    "start": "1435260",
    "end": "1441200"
  },
  {
    "text": "established set of use cases for kubernetes many of these are supported by declarative apis this is the stuff",
    "start": "1441200",
    "end": "1446900"
  },
  {
    "text": "that you're most familiar with jobs and deployments and are back then you've got this other category of",
    "start": "1446900",
    "end": "1452299"
  },
  {
    "text": "emerging use cases this is the kind of stuff that I've been talking about so these these are things that are not yet",
    "start": "1452299",
    "end": "1457640"
  },
  {
    "text": "supported by the declarative apis we're using our extension mechanisms to handle them",
    "start": "1457640",
    "end": "1462860"
  },
  {
    "text": "the way that cell fits into this is it allows us to move this boundary now that",
    "start": "1462860",
    "end": "1467900"
  },
  {
    "text": "we believe that these use cases are pretty well understood we want to move that boundary and make",
    "start": "1467900",
    "end": "1473960"
  },
  {
    "text": "these supported by declarative apis so you don't need to get web hooks involved in things like this there will always be",
    "start": "1473960",
    "end": "1480320"
  },
  {
    "text": "things that you need web books for and that's okay but we want to lower the barrier of Entry to get things done",
    "start": "1480320",
    "end": "1487220"
  },
  {
    "text": "you should be able to do a lot of these use cases without the operational complexity of web hooks",
    "start": "1487220",
    "end": "1493059"
  },
  {
    "text": "cell moves the boundary for these use cases we think there are a variety of other use cases that we have and have",
    "start": "1493059",
    "end": "1498620"
  },
  {
    "text": "not thought of that would also be useful I've identified a couple of them here so",
    "start": "1498620",
    "end": "1504860"
  },
  {
    "text": "right now if you do have multiple versions of a crd you need to do crd conversion we think that right now you",
    "start": "1504860",
    "end": "1511760"
  },
  {
    "text": "have to introduce a web hook to do that as well we think that's another good place to use cell the kcp project has",
    "start": "1511760",
    "end": "1517820"
  },
  {
    "text": "already been working on implementation of this we've been talking to them we really like the work they've been doing we hope to bring that into kubernetes",
    "start": "1517820",
    "end": "1525200"
  },
  {
    "text": "also um I've been talking mostly about crd validation but we do validation of all",
    "start": "1525200",
    "end": "1530720"
  },
  {
    "text": "the native kubernetes types as well so there might be a benefit to the developers of kubernetes to do that in",
    "start": "1530720",
    "end": "1536659"
  },
  {
    "text": "cell also that could have impact to users if we do it right because right",
    "start": "1536659",
    "end": "1544159"
  },
  {
    "text": "now what happens is if you want to do a lot of like shift left validation of your kubernetes yaml you don't get all",
    "start": "1544159",
    "end": "1550820"
  },
  {
    "text": "the validation rules that are compiled into the API server but if we were to express those in cell and then put them",
    "start": "1550820",
    "end": "1556520"
  },
  {
    "text": "on the open API then that would be available to tooling much earlier to check so a lot of kind of the static",
    "start": "1556520",
    "end": "1563419"
  },
  {
    "text": "analysis that we actually know for sure would be invalid we could then check much earlier and like get get Ops flows",
    "start": "1563419",
    "end": "1570260"
  },
  {
    "text": "and things like that um the other thing I was going to mention is right now we're focusing mostly on validating admission but",
    "start": "1570260",
    "end": "1577159"
  },
  {
    "text": "there's a whole other class of admission called mutating admission and we are interested in supporting",
    "start": "1577159",
    "end": "1582620"
  },
  {
    "text": "those use cases in the future this would probably be a separate cap but sell does",
    "start": "1582620",
    "end": "1587840"
  },
  {
    "text": "support the construction of data in the manipulation of data in a way that would work for this it's one of the things",
    "start": "1587840",
    "end": "1594260"
  },
  {
    "text": "that we considered when we chose cell so we think it's possible we hope to do it sometime in the future",
    "start": "1594260",
    "end": "1601419"
  },
  {
    "text": "if you want to learn more here's a couple links the documentation for crd validation rules is in the main",
    "start": "1601580",
    "end": "1607760"
  },
  {
    "text": "kubernetes documentation documentation for crds the cap has a lot of useful",
    "start": "1607760",
    "end": "1612980"
  },
  {
    "text": "information you can learn a lot about cell just Google for it you can reach us at the",
    "start": "1612980",
    "end": "1618919"
  },
  {
    "text": "API Machinery mailing list and we also have our own slack Channel just for talking about cell you're welcome to",
    "start": "1618919",
    "end": "1624380"
  },
  {
    "text": "drop in we'd love to hear from you I am going to stop there and take",
    "start": "1624380",
    "end": "1630620"
  },
  {
    "text": "questions",
    "start": "1630620",
    "end": "1632980"
  },
  {
    "text": "and what they should be using for example they should have a minimum freedom because we've been using",
    "start": "1657039",
    "end": "1664760"
  },
  {
    "text": "validation do you think this is a replacement",
    "start": "1664760",
    "end": "1670600"
  },
  {
    "text": "uh so um one of the co-authors of this cap is Max Smythe that works on Oppa so",
    "start": "1670600",
    "end": "1676880"
  },
  {
    "text": "we have been working very closely with the OPA team on making sure that we build something that they can use now",
    "start": "1676880",
    "end": "1682520"
  },
  {
    "text": "it's possible that they might not be able to get all their rules directly into the API server this way but we",
    "start": "1682520",
    "end": "1688700"
  },
  {
    "text": "believe that the vast majority of opa would not require a web hook once we do this and they're they intend to work on",
    "start": "1688700",
    "end": "1694580"
  },
  {
    "text": "an implementation yeah here",
    "start": "1694580",
    "end": "1700700"
  },
  {
    "text": "thank you I have two quick questions do you have some tips around how to debug cell once it's in yaml and how to test",
    "start": "1701059",
    "end": "1708620"
  },
  {
    "text": "it once it's enabled um yeah so that's a really good question",
    "start": "1708620",
    "end": "1714140"
  },
  {
    "text": "um I think this is something where we're going to have to do some work um so the",
    "start": "1714140",
    "end": "1719720"
  },
  {
    "text": "good news is because we get type checking you get a lot early on I have seen people do things like um run little",
    "start": "1719720",
    "end": "1727700"
  },
  {
    "text": "kind clusters and or mini cubes as a way to get a control plane and just test things that way so for like a stock crd",
    "start": "1727700",
    "end": "1735559"
  },
  {
    "text": "you can actually like do a lot with that because you don't need the rest of the cluster so that might be a way to do it",
    "start": "1735559",
    "end": "1741200"
  },
  {
    "text": "we are also providing a lot of our sell stuff as a pretty accessible Library this is something we want to make better",
    "start": "1741200",
    "end": "1747559"
  },
  {
    "text": "over time but it should be possible to run some cell just in isolation in the",
    "start": "1747559",
    "end": "1754580"
  },
  {
    "text": "go program",
    "start": "1754580",
    "end": "1757000"
  },
  {
    "text": "right um",
    "start": "1761360",
    "end": "1766778"
  },
  {
    "text": "will look like for someone trying to extend um so it is it's extensible in the sense",
    "start": "1770899",
    "end": "1776840"
  },
  {
    "text": "that whoever brings it into a binary can change the libraries that it uses there",
    "start": "1776840",
    "end": "1782779"
  },
  {
    "text": "are some settings that you can change so it is going as a kubernetes author we",
    "start": "1782779",
    "end": "1788299"
  },
  {
    "text": "can extend it by adding more functions and things like that if you were to use it in your own programs you could also",
    "start": "1788299",
    "end": "1793580"
  },
  {
    "text": "do that we don't have any way to like say have you register new functions at",
    "start": "1793580",
    "end": "1798740"
  },
  {
    "text": "this time so in that sense it's not extensible I hope that makes sense",
    "start": "1798740",
    "end": "1803740"
  },
  {
    "text": "hey thanks for the talk um could you speak to when this might get integrated into Cube builder at all",
    "start": "1804860",
    "end": "1811820"
  },
  {
    "text": "right so uh x-dust validation rules are already there there is um there's I",
    "start": "1811820",
    "end": "1817340"
  },
  {
    "text": "don't have it listed here but if you just look at um the the open API extensions available you can use it",
    "start": "1817340",
    "end": "1823940"
  },
  {
    "text": "today yep",
    "start": "1823940",
    "end": "1826778"
  },
  {
    "text": "um so we when you use cell today uh with the",
    "start": "1830240",
    "end": "1837260"
  },
  {
    "text": "Expressions you were showing and it refers to self is it limited to just looking at self the resource that's updated or is there",
    "start": "1837260",
    "end": "1843080"
  },
  {
    "text": "a way to do cross-resource validation like the you know must have a unique name no we can't do cross",
    "start": "1843080",
    "end": "1850279"
  },
  {
    "text": "um cross resource validation today so that is a limitation um and that is a much harder nut to",
    "start": "1850279",
    "end": "1857480"
  },
  {
    "text": "crack so if you have any ideas let us know it has come up before so we have heard about this problem but it's a",
    "start": "1857480",
    "end": "1864020"
  },
  {
    "text": "harder one to solve can you uh um declare these um validating policies",
    "start": "1864020",
    "end": "1871340"
  },
  {
    "text": "on like a per namespace basis so different policies are in effect in different parts of your cluster",
    "start": "1871340",
    "end": "1878000"
  },
  {
    "text": "um so we think that we want to do that before we go to Beta so you'll the way that it's defined right now is",
    "start": "1878000",
    "end": "1883760"
  },
  {
    "text": "everything is at cluster level but we think that it make it makes sense to also have like a local validated",
    "start": "1883760",
    "end": "1891140"
  },
  {
    "text": "admission policy binding so you could bind it at the namespace level you could put that that resource in the namespace",
    "start": "1891140",
    "end": "1897919"
  },
  {
    "text": "and it will automatically only apply to that home space that's something we have also listed as a feature before we go to Beta",
    "start": "1897919",
    "end": "1905200"
  },
  {
    "text": "for the parameters that are referred to by the",
    "start": "1905720",
    "end": "1910880"
  },
  {
    "text": "by the validating emission policy is that the author's responsibility to define the crd for the parameter kind or",
    "start": "1910880",
    "end": "1918380"
  },
  {
    "text": "will it auto-generate something there we leave it up to the author to define the",
    "start": "1918380",
    "end": "1923480"
  },
  {
    "text": "crd if you don't need a whole crd you can just use a config map which is appropriate for really simple use cases",
    "start": "1923480",
    "end": "1931120"
  },
  {
    "text": "uh how is the if a user fails the policy or if they if they're to apply something",
    "start": "1934840",
    "end": "1940520"
  },
  {
    "text": "that fails a policy how is that return time is it just in the in the terminal right there when they do apply and it just fails um yeah you'll just you'll",
    "start": "1940520",
    "end": "1946700"
  },
  {
    "text": "just see it if you're using like Coupe cuddle you'll just see it just like you would um most other validation errors it actually gets surfaced in things is",
    "start": "1946700",
    "end": "1952940"
  },
  {
    "text": "there plan to like do like a like a send like an HTTP send that you can like give it to like a slap up hook or anything",
    "start": "1952940",
    "end": "1958100"
  },
  {
    "text": "like that I'm sorry I didn't follow that so like we have like a like we use",
    "start": "1958100",
    "end": "1964898"
  },
  {
    "text": "that anyway no I haven't heard of that I would love to talk to you more about that I should understand what these",
    "start": "1968600",
    "end": "1973820"
  },
  {
    "text": "cases oh thank you",
    "start": "1973820",
    "end": "1979899"
  },
  {
    "text": "thinking if",
    "start": "1980179",
    "end": "1983380"
  },
  {
    "text": "only in a specific case that they need to make ensure that if",
    "start": "1990559",
    "end": "1998018"
  },
  {
    "text": "existed resource validation do you think we can see anything like this in the future",
    "start": "2001840",
    "end": "2007720"
  },
  {
    "text": "release um cross cross field stuff's harder we",
    "start": "2007720",
    "end": "2012760"
  },
  {
    "text": "don't have any immediate plans for it I would love to talk to people and understand more of the use cases right",
    "start": "2012760",
    "end": "2018399"
  },
  {
    "text": "now we're mostly focused on the per resource case because that's really useful I know when you talk more about",
    "start": "2018399",
    "end": "2024640"
  },
  {
    "text": "the policy admission case which I talked about second that's there are people very interesting cross cross object",
    "start": "2024640",
    "end": "2030580"
  },
  {
    "text": "checks so I would love to understand more of those use cases maybe we can find a way to do something in the future",
    "start": "2030580",
    "end": "2035919"
  },
  {
    "text": "right now I'm a little pessimistic because it's hard but um who knows before we have time for one more and it",
    "start": "2035919",
    "end": "2041679"
  },
  {
    "text": "was over here",
    "start": "2041679",
    "end": "2044100"
  },
  {
    "text": "if you have some cell expressions all right this one better okay web Hooks",
    "start": "2049359",
    "end": "2056020"
  },
  {
    "text": "and cell Expressions what's the order of execution evict each other is there any built-in safeguard",
    "start": "2056020",
    "end": "2063540"
  },
  {
    "text": "oh yeah so the the order execution is pretty well defined so um validation is",
    "start": "2063700",
    "end": "2068800"
  },
  {
    "text": "comprehensive so crd validation happens at the same phase that crd validation has always happened and it's",
    "start": "2068800",
    "end": "2074378"
  },
  {
    "text": "comprehensive you get all the errors that you get back right so it's going to check all your rules the admission policies are going to happen in the",
    "start": "2074379",
    "end": "2082000"
  },
  {
    "text": "admission control chain which has a very particular flow so first it runs all the built-in controllers",
    "start": "2082000",
    "end": "2088540"
  },
  {
    "text": "um and it then it runs then it's going to run the policy ones and then it's going to rub them when the web hook ones",
    "start": "2088540",
    "end": "2095080"
  },
  {
    "text": "last we always run mutators before we run validators so that your validator is guaranteed to see something whatever is",
    "start": "2095080",
    "end": "2101500"
  },
  {
    "text": "going to be written so there's a very well defined order yeah all right I think we are at time thank",
    "start": "2101500",
    "end": "2108880"
  },
  {
    "text": "you everybody for coming appreciate it",
    "start": "2108880",
    "end": "2112380"
  }
]