[
  {
    "start": "0",
    "end": "112000"
  },
  {
    "text": "before we dive in let's do some introductions Lee would you like to introduce yourself yeah my name is Leah Cho I work on the networking team I I",
    "start": "30",
    "end": "9330"
  },
  {
    "text": "work on specifically managing our from proxy uh and our service mesh which all",
    "start": "9330",
    "end": "15299"
  },
  {
    "text": "runs on envoy and I've been at lift for a few years and I've been on a number of different impro related teams I",
    "start": "15299",
    "end": "21960"
  },
  {
    "text": "currently lead a team that works on resilience engineering and you might have seen some of my team's work in the",
    "start": "21960",
    "end": "28140"
  },
  {
    "text": "open-source all-boy repos these days with the adaptive concurrency work that's going on in there and so if",
    "start": "28140",
    "end": "33450"
  },
  {
    "text": "you're interested in chatting about that I can hang out later and discuss that but let's frame the talk a little bit so",
    "start": "33450",
    "end": "39780"
  },
  {
    "text": "this is not introduction to service mesh I can by now cube con you probably had a dozen of those already what we're going",
    "start": "39780",
    "end": "47129"
  },
  {
    "text": "to do today is look at what to do when your control plan or your data plane is",
    "start": "47129",
    "end": "52140"
  },
  {
    "text": "not behaving in a way that you expected so this could be during dev and test or",
    "start": "52140",
    "end": "57510"
  },
  {
    "text": "it could be a production incident basically how to tease further information out of on boy itself and we're not going to get into specifics of",
    "start": "57510",
    "end": "64228"
  },
  {
    "text": "app mesh or SEO or other control planes but I believe that most of what we will convey is usable for any control plane",
    "start": "64229",
    "end": "71430"
  },
  {
    "text": "that uses envoy so this is a talk in three parts we will first start with the",
    "start": "71430",
    "end": "78540"
  },
  {
    "text": "consideration of config config can be a very complex thing in Envoy you might get config from a bootstrap file and",
    "start": "78540",
    "end": "85560"
  },
  {
    "text": "from three other servers that combines itself into a single Envoy instance and so reasoning about the origin and the",
    "start": "85560",
    "end": "91200"
  },
  {
    "text": "provenance of that config data can be a complex thing we'll talk about some tips for that Lita will present that section",
    "start": "91200",
    "end": "97170"
  },
  {
    "text": "then I'll do a deep dive into logs specifically access logs in Envoy ingress/egress",
    "start": "97170",
    "end": "102930"
  },
  {
    "text": "all types of logs and then we'll wrap up with a look at stats so leader you want",
    "start": "102930",
    "end": "108119"
  },
  {
    "text": "to start us off with config yeah sounds good let's get started so again this is",
    "start": "108119",
    "end": "115740"
  },
  {
    "start": "112000",
    "end": "112000"
  },
  {
    "text": "specific to on boy configuration and I start thought we should start off with a high level picture so humble have two",
    "start": "115740",
    "end": "123060"
  },
  {
    "text": "types of configuration one is the bootstrap file that's a static configuration that lives",
    "start": "123060",
    "end": "128810"
  },
  {
    "text": "either your VM or your container and envoy will read that and then start up and we'll use that configuration for the",
    "start": "128810",
    "end": "136880"
  },
  {
    "text": "lifecycle envoy running however managing a bunch of those",
    "start": "136880",
    "end": "142370"
  },
  {
    "text": "bootstrap files is cumbersome and so on void net also has dynamic configuration",
    "start": "142370",
    "end": "149239"
  },
  {
    "text": "known as the xes api sourced our DS api's and basically",
    "start": "149239",
    "end": "155390"
  },
  {
    "text": "that connects to a control plane that I sense dynamic configuration while envoy",
    "start": "155390",
    "end": "160670"
  },
  {
    "text": "is running so there's no need to hop restart or restart envoy you could on the fly send configuration to envoy directly and",
    "start": "160670",
    "end": "168769"
  },
  {
    "text": "then have quick quick deployment and roll backs as well and so when you're",
    "start": "168769",
    "end": "175160"
  },
  {
    "text": "debugging and kind of need to figure out like what is the main issue is it a xes problem or is it a problem in my",
    "start": "175160",
    "end": "181010"
  },
  {
    "text": "bootstrap file and some tips I have at a high level is that usually startup issues especially if they're global tend",
    "start": "181010",
    "end": "188750"
  },
  {
    "text": "to be due to malformed configuration and envoys will be verbose if there is",
    "start": "188750",
    "end": "194269"
  },
  {
    "text": "malformed figuration giving it to it the and also but however with a if there's a",
    "start": "194269",
    "end": "201829"
  },
  {
    "text": "issue with your dynamic configuration envoy keeps the last well-known config",
    "start": "201829",
    "end": "207500"
  },
  {
    "text": "so you won't if you don't have the popper of the observability in place you may not notice until envoy scales up",
    "start": "207500",
    "end": "213380"
  },
  {
    "text": "which is also not a good situation to be in so what is our tools at our disposal so",
    "start": "213380",
    "end": "219200"
  },
  {
    "start": "216000",
    "end": "216000"
  },
  {
    "text": "the tools I use to debug configuration issues is config dump which is an admin",
    "start": "219200",
    "end": "224780"
  },
  {
    "text": "endpoint that you still have to set up in your Envoy proxy but its interface",
    "start": "224780",
    "end": "230840"
  },
  {
    "text": "where you can curl and I will show you exactly what envoy is running at runtime",
    "start": "230840",
    "end": "236000"
  },
  {
    "text": "both static and dynamic so it's very useful you have to set up the admin",
    "start": "236000",
    "end": "241760"
  },
  {
    "text": "interface at lift we set it up such that there's a local host so you have to have privileged access to curl this endpoint",
    "start": "241760",
    "end": "249200"
  },
  {
    "text": "but then you can see all this data once you're in the box the other ways I've",
    "start": "249200",
    "end": "254420"
  },
  {
    "text": "seen people set this up is they have like a firewall or secure network to curl this information from the VM or",
    "start": "254420",
    "end": "261799"
  },
  {
    "text": "contain directly the second thing that you could leverage is Trace level logging this is super useful especially if you're trying",
    "start": "261799",
    "end": "268840"
  },
  {
    "text": "to set up something new in envoy so let's say you're setting up a new XDS API or a new feature chances are you're",
    "start": "268840",
    "end": "276310"
  },
  {
    "text": "not gonna get that right the first time and um and looking at the trace level logging will tell you exactly what's going on and where the problem is",
    "start": "276310",
    "end": "283210"
  },
  {
    "text": "arising so and oftentimes they were doing a bug report the maintainer Zoar the community will ask you to post a",
    "start": "283210",
    "end": "288879"
  },
  {
    "text": "trace level logging along with your issue and so this is you this is the way you'll go about it either you can set it",
    "start": "288879",
    "end": "295270"
  },
  {
    "text": "turn it on dynamically but via curling the admin endpoint or do a command line",
    "start": "295270",
    "end": "302530"
  },
  {
    "text": "argument on startup - and set - L trace and that will give you all the trace",
    "start": "302530",
    "end": "307870"
  },
  {
    "text": "level logging on when you're starting up envoy okay so let's go into like a",
    "start": "307870",
    "end": "313870"
  },
  {
    "start": "312000",
    "end": "312000"
  },
  {
    "text": "realistic scenario a healthy envoy when it starts up usually ends with this log",
    "start": "313870",
    "end": "319539"
  },
  {
    "text": "line which is all dependencies are initialized starting workers so that means envoy is now able to take traffic",
    "start": "319539",
    "end": "325419"
  },
  {
    "text": "and the workers are the request workers so that's like the happy path and what you're looking for when you're looking",
    "start": "325419",
    "end": "331110"
  },
  {
    "text": "at the logs these lots are not the access logs that Ryan will go into later",
    "start": "331110",
    "end": "336190"
  },
  {
    "text": "in the talk these logs are the sugar logs that Envoy minutes in the main thread but now you're seeing this you're",
    "start": "336190",
    "end": "343810"
  },
  {
    "text": "seeing like an issue with some sort of config you're like it makes a charity",
    "start": "343810",
    "end": "349270"
  },
  {
    "text": "stream call and like realizes there's no healthy upstream and let's say you're",
    "start": "349270",
    "end": "355539"
  },
  {
    "text": "trying to set up your control plane this is the first time you're setting it up and you're seeing this error and Envoy",
    "start": "355539",
    "end": "360849"
  },
  {
    "text": "Haynes says amidst this log line a couple of times and restarts and it",
    "start": "360849",
    "end": "366969"
  },
  {
    "text": "keeps going to this loop so what do you do this log is not enough to kind of figure out what's going on so let's just",
    "start": "366969",
    "end": "374620"
  },
  {
    "text": "try running on void with - with a with trace level logging and so I concatenate",
    "start": "374620",
    "end": "382900"
  },
  {
    "text": "a lot of a lot of the data here like the time stamps and the code line where this",
    "start": "382900",
    "end": "388690"
  },
  {
    "text": "log is submitted just so it will fit in the screen but it gives you a lot of information like it gives you debug logs",
    "start": "388690",
    "end": "394690"
  },
  {
    "text": "as well as trace the logs and we see that warning again so that gives us a form of reference but",
    "start": "394690",
    "end": "403220"
  },
  {
    "text": "ultimately oh look we our dns was not set up correctly and note that that was like stated in the debug line but what",
    "start": "403220",
    "end": "412040"
  },
  {
    "text": "was happening was that the they're so healthy upstream because that DNS didn't resolve to IP addresses and so it was",
    "start": "412040",
    "end": "419480"
  },
  {
    "text": "not able to talk to the config server but then again we were able to get out whoops we were able to get more data",
    "start": "419480",
    "end": "426620"
  },
  {
    "text": "through these traces to see what's going on so let's go to a different scenario",
    "start": "426620",
    "end": "432920"
  },
  {
    "start": "431000",
    "end": "431000"
  },
  {
    "text": "like this one effects real users let's say you're actually running envoy in production and you and in this case",
    "start": "432920",
    "end": "439010"
  },
  {
    "text": "there is a edge proxy that your customers go through before reaching the application and you notice that Oh",
    "start": "439010",
    "end": "445610"
  },
  {
    "text": "certain users are getting 404s and you get a customer report about it so the",
    "start": "445610",
    "end": "452480"
  },
  {
    "text": "application does in and tries a triage this issue and when she like debugs",
    "start": "452480",
    "end": "459410"
  },
  {
    "text": "the endpoint and let's say this application is stateless she gets a 200 she cannot repeat this 404 or we",
    "start": "459410",
    "end": "465950"
  },
  {
    "text": "produced this error whatsoever so now she's like confused and goes to the networking team Elia must be a",
    "start": "465950",
    "end": "471050"
  },
  {
    "text": "networking issue goes to the front proxy and so now it's your job to figure out",
    "start": "471050",
    "end": "477650"
  },
  {
    "text": "what's going on so what's what's what's on our tool belt look can we do to",
    "start": "477650",
    "end": "483560"
  },
  {
    "text": "figure out what's happening here so let's look at convict up so like there's get when you curl this endpoint in envoy",
    "start": "483560",
    "end": "490430"
  },
  {
    "text": "there's gonna be a lot of configuration here but it helps to kind of look at the high level to see what shows up so you",
    "start": "490430",
    "end": "497060"
  },
  {
    "text": "have your bootstrap configuration you have your cluster and listener and routes but any of you have like if you",
    "start": "497060",
    "end": "503660"
  },
  {
    "text": "have secret discovery set up that will also show up here and so that's a good thing to note like you should separate",
    "start": "503660",
    "end": "509420"
  },
  {
    "text": "by type and then try to pick out where to dig into note here also like again it",
    "start": "509420",
    "end": "516050"
  },
  {
    "text": "shows you both static as well as dynamic configuration everything that's dynamic will have a version info with it and",
    "start": "516050",
    "end": "522050"
  },
  {
    "text": "that version is set by the control plane and if you have any issue with your config not updating or like",
    "start": "522050",
    "end": "529810"
  },
  {
    "text": "your XS not updates getting rejected that version info will not match with",
    "start": "529810",
    "end": "535150"
  },
  {
    "text": "your control plane and that's also another signal that something's not working right in your system so when you",
    "start": "535150",
    "end": "542110"
  },
  {
    "text": "when I think of 404s it usually has to do with routes so like about tables misconfigured in some way",
    "start": "542110",
    "end": "548500"
  },
  {
    "text": "and let's say you look into the Envoy access logs which Ryan will go into later and they're getting you're using",
    "start": "548500",
    "end": "555760"
  },
  {
    "text": "nr which is an envoy with specific response and Ryan will go over all the",
    "start": "555760",
    "end": "561700"
  },
  {
    "text": "response flags later in the talk but NRCS for no route usually it means that envoy returned a 404 not the application",
    "start": "561700",
    "end": "569020"
  },
  {
    "text": "meaning that there was no route table that I could find out you couldn't find a route to match the traffic with and so",
    "start": "569020",
    "end": "577170"
  },
  {
    "text": "so let's dig into the route table and see what's going on so you look at all",
    "start": "577170",
    "end": "583780"
  },
  {
    "text": "you like aggregate all the route table are like the dynamic route configs from all your hosts and you notice that",
    "start": "583780",
    "end": "590320"
  },
  {
    "text": "the old ones don't have oh the old ones have the route table properly but the new ones don't",
    "start": "590320",
    "end": "596560"
  },
  {
    "text": "so what does that mean to admit again when I mentioned earlier in the talk envoy keeps the last well-known config",
    "start": "596560",
    "end": "603700"
  },
  {
    "text": "that's how it stays resilient to bad configuration changes in XDS and so then",
    "start": "603700",
    "end": "609220"
  },
  {
    "text": "when the new boxes don't have a well good known what config to go off of it's good it's always still gonna run but",
    "start": "609220",
    "end": "615430"
  },
  {
    "text": "it's not and take traffic but it won't route it has no it has no routing",
    "start": "615430",
    "end": "620500"
  },
  {
    "text": "information to send that traffic to so you know that there's something wrong with your xes configuration so knowing",
    "start": "620500",
    "end": "629890"
  },
  {
    "text": "that like there is an issue with configuration you could see that looking",
    "start": "629890",
    "end": "634990"
  },
  {
    "text": "at the server loss you it states clearly now why it got rejected so there's a",
    "start": "634990",
    "end": "641230"
  },
  {
    "text": "duplicate entry and that's why it rejected the update and we and and thus",
    "start": "641230",
    "end": "646690"
  },
  {
    "text": "you know to rollback your bad access change and then you'll be able to serve",
    "start": "646690",
    "end": "652450"
  },
  {
    "text": "your customers traffic note here that there is also stacks that you could like alarm on this and so as long as you have",
    "start": "652450",
    "end": "659920"
  },
  {
    "text": "the proper observer you shouldn't beep you shouldn't get to this state but note that but also note",
    "start": "659920",
    "end": "667240"
  },
  {
    "text": "that all the way we'll tell you exactly why I reject it also to help blue cause",
    "start": "667240",
    "end": "672490"
  },
  {
    "text": "your issues and the other thing I wanted to mention on the side is that if you",
    "start": "672490",
    "end": "678130"
  },
  {
    "text": "decide to statically define your route table and your bootstrap file that would be you know that would be a critical",
    "start": "678130",
    "end": "683470"
  },
  {
    "text": "error and um boy won't start but however if you use X yes it will it will run but",
    "start": "683470",
    "end": "690040"
  },
  {
    "text": "it won't it will end up just rejecting the update so some quick config takeaways before we move on to logging",
    "start": "690040",
    "end": "697380"
  },
  {
    "text": "they're the main tools or that I leverage is the config dump as well as",
    "start": "697380",
    "end": "702850"
  },
  {
    "text": "trace level log E and they will show you both static and conferring table will show you both static and dynamic",
    "start": "702850",
    "end": "708730"
  },
  {
    "text": "dynamic level configuration that which I'm always running at runtime tray slots",
    "start": "708730",
    "end": "714130"
  },
  {
    "text": "and then the oh sorry the other thing I wanted to mention is that dynamic configuration envoy will use the last",
    "start": "714130",
    "end": "721030"
  },
  {
    "text": "known well last well-known good config that's how envoy stays resilient and so",
    "start": "721030",
    "end": "726850"
  },
  {
    "text": "you won't see any dynamic it config issues on scale-up unless you have the",
    "start": "726850",
    "end": "731920"
  },
  {
    "text": "proper observability in place and then also trace level logging it's very",
    "start": "731920",
    "end": "737110"
  },
  {
    "text": "useful especially if you're enabling a new feature or if you want to dig into what's going on it gives you a lot of",
    "start": "737110",
    "end": "744490"
  },
  {
    "text": "data I didn't go into I didn't go too deep into it but like a will show you",
    "start": "744490",
    "end": "750190"
  },
  {
    "text": "the xes payloads it will show you the headers that are being set in the data plane so",
    "start": "750190",
    "end": "757510"
  },
  {
    "text": "and also like the bytes information if you want to so definitely use that if to",
    "start": "757510",
    "end": "765010"
  },
  {
    "text": "your advantage but note that it's very verbose so you could also customize the",
    "start": "765010",
    "end": "770410"
  },
  {
    "text": "level of tracing to this component of where you care about whether that's like the upstream section the config area or",
    "start": "770410",
    "end": "776620"
  },
  {
    "text": "the HDTV connection manager like you could you can enable tracing for those specific components okay and then Ryan's",
    "start": "776620",
    "end": "785140"
  },
  {
    "text": "gonna take it off with logs so to motivate this section just a very small",
    "start": "785140",
    "end": "791200"
  },
  {
    "start": "788000",
    "end": "788000"
  },
  {
    "text": "toy example here you might imagine that you have a people app that there's a weather app it",
    "start": "791200",
    "end": "796350"
  },
  {
    "text": "calls into some edge proxy that transits to a sidecar the service performs some weather forecasting or data collection",
    "start": "796350",
    "end": "802830"
  },
  {
    "text": "and as part of that it calls out to some external api's to get data so I guess this is like a an interplanetary weather",
    "start": "802830",
    "end": "809760"
  },
  {
    "text": "app it calls out and gets the weather on Mars here but you've got some problems with this third party call and you want",
    "start": "809760",
    "end": "815190"
  },
  {
    "text": "to know what's going on in each of those calls and so you want to know a lot of details about that so we're gonna use",
    "start": "815190",
    "end": "820350"
  },
  {
    "text": "envoy logs to do that and so in this section number one we're gonna look at how to configure a log for traffic",
    "start": "820350",
    "end": "825690"
  },
  {
    "text": "that's exiting the mesh so the point I want - it's gonna make your super explicitly as you'll notice there's no",
    "start": "825690",
    "end": "831300"
  },
  {
    "text": "arrow from this service directly to the API there's only basically a line that",
    "start": "831300",
    "end": "836670"
  },
  {
    "text": "goes from the service to envoy and then out to this third party so this is known as using envoy for egressing your",
    "start": "836670",
    "end": "842910"
  },
  {
    "text": "external traffic sometimes people call this I believe a forward proxy to proxy traffic outside of your system data and",
    "start": "842910",
    "end": "849750"
  },
  {
    "text": "data center so we'll look at how to set that up and what some benefits are we'll dive into the filtering capabilities of",
    "start": "849750",
    "end": "856470"
  },
  {
    "text": "access logs you can build like super sophisticated and potentially very complex logging rules and then we'll",
    "start": "856470",
    "end": "862950"
  },
  {
    "text": "look at an alternative to using file based logs which is known as the access log service which is a mechanism by",
    "start": "862950",
    "end": "868800"
  },
  {
    "text": "which you can send log events over G RPC so how to set up envoy for addressing",
    "start": "868800",
    "end": "875040"
  },
  {
    "start": "872000",
    "end": "872000"
  },
  {
    "text": "traffic to a third party this is generally done by setting up a dedicated listener and so you might have some",
    "start": "875040",
    "end": "881040"
  },
  {
    "text": "listeners associated with traffic coming in and out of your service mesh and in this example what we're saying is we're",
    "start": "881040",
    "end": "886170"
  },
  {
    "text": "going to allocate port 7001 to all traffic going to this external service and so the the code that is actually",
    "start": "886170",
    "end": "893370"
  },
  {
    "text": "reaching out to this API it won't use that that URL explicitly it will call it a local hosts port 7001",
    "start": "893370",
    "end": "899430"
  },
  {
    "text": "it will specify a host header of API on nasa.gov and then envoy will route that",
    "start": "899430",
    "end": "904530"
  },
  {
    "text": "traffic out so what are some benefits of doing this big big benefit is that you",
    "start": "904530",
    "end": "910560"
  },
  {
    "text": "get all the stats you get all the same stats you would if you're using envoy at the edge or if you're using all-boy in",
    "start": "910560",
    "end": "915630"
  },
  {
    "text": "the mesh and you get it in a sort of a nice unified format further you get the",
    "start": "915630",
    "end": "921000"
  },
  {
    "text": "explicit retry policies of envoy so you can tweak the retry policy have it handle that on your behalf if you want",
    "start": "921000",
    "end": "926730"
  },
  {
    "text": "to use rate limiting possible as well there's really a bunch of benefits we'll do connection warming out-of-band dns resolution and the list",
    "start": "926730",
    "end": "933120"
  },
  {
    "text": "goes on and on but for our example critically it gives us the ability to specify a log file for this traffic",
    "start": "933120",
    "end": "940670"
  },
  {
    "text": "sorry about the animal wouldn't be a cube con talk without pages of yeah Mille in fact I asked for speed back on",
    "start": "940670",
    "end": "948900"
  },
  {
    "text": "my slides and Lena told me I just needed more Taylor Swift I don't have that all I have is the animal for you sorry so",
    "start": "948900",
    "end": "955920"
  },
  {
    "text": "this page of Yambol defines a listener and it's this is the exact type of config you would do if you were trying",
    "start": "955920",
    "end": "961800"
  },
  {
    "text": "to set up this type of egress and so you can see bind this localhost dedicate port 7001 listen on that if you look",
    "start": "961800",
    "end": "969000"
  },
  {
    "text": "down to the bottom you see the route is basically saying send everything to api nasa.gov and then here's the access log",
    "start": "969000",
    "end": "977130"
  },
  {
    "text": "specifier so even if you've never seen one of these before you can probably guess what's going on this is kind of like a you know printf style format",
    "start": "977130",
    "end": "983610"
  },
  {
    "text": "string here if you google envoy access log it will land you on a really",
    "start": "983610",
    "end": "989190"
  },
  {
    "text": "excellent page of the documentation that outlines what each of these fields are all the possibilities that you could",
    "start": "989190",
    "end": "994590"
  },
  {
    "text": "include in your own custom format strings so you could you can do a lot of things in here you can specify the",
    "start": "994590",
    "end": "1001460"
  },
  {
    "text": "fields related to RPC for example you could extract headers that are very specific to your environment and your",
    "start": "1001460",
    "end": "1006920"
  },
  {
    "text": "infrastructure and you can include those here to maximize the benefit of this so",
    "start": "1006920",
    "end": "1013670"
  },
  {
    "start": "1013000",
    "end": "1013000"
  },
  {
    "text": "that gets you the log file that gets you lots of visibility into this data that's egressing your service but maybe you",
    "start": "1013670",
    "end": "1019670"
  },
  {
    "text": "realize you've just got too much data now and you need to slim it down so enter the filter section so the filter",
    "start": "1019670",
    "end": "1026630"
  },
  {
    "text": "section of the config allows you to specify one of a handful of very powerful filters for your access logs so",
    "start": "1026630",
    "end": "1032420"
  },
  {
    "text": "in this case we're saying the numerator is 1 denominator is a hundred so sample effectively 1 percent of traffic going",
    "start": "1032420",
    "end": "1039079"
  },
  {
    "text": "out and send that to this file based log you might notice that runtime key below that gives you the interesting",
    "start": "1039080",
    "end": "1044329"
  },
  {
    "text": "capability here which is to turn these knobs live at runtime without reloading on voice so you might for example have a",
    "start": "1044330",
    "end": "1051770"
  },
  {
    "text": "default state of a very low sample percentage and during an incident you may want to crank this up and so you",
    "start": "1051770",
    "end": "1057800"
  },
  {
    "text": "could specify a higher sample percentage in real to get more fidelity out of your logging",
    "start": "1057800",
    "end": "1063010"
  },
  {
    "text": "system different scenario maybe you want to log only errors for external traffic so don't care about the to hundreds",
    "start": "1063010",
    "end": "1069640"
  },
  {
    "start": "1064000",
    "end": "1064000"
  },
  {
    "text": "don't care about the redirects you want to know about the 404 is the pipe of threes all that sort of thing so the",
    "start": "1069640",
    "end": "1075490"
  },
  {
    "text": "first thing you might see here is at the top we've got a predicate filter so there are I believe two of these that",
    "start": "1075490",
    "end": "1081790"
  },
  {
    "text": "are that are supported by envoy and and or and so in this case we have the or filter specified by a list of other",
    "start": "1081790",
    "end": "1087549"
  },
  {
    "text": "filter sort of nested underneath the first of which is the status code filter it basically says look at the status",
    "start": "1087549",
    "end": "1095590"
  },
  {
    "text": "code look at the operand and if it's greater than or equal to in this case log it it or can it or is that with the",
    "start": "1095590",
    "end": "1102510"
  },
  {
    "text": "output of the other filter this is the response flag filter I actually didn't really get into that as much as I wanted",
    "start": "1102510",
    "end": "1108460"
  },
  {
    "text": "to back here I I did I did circle this you might notice that response flags in the in the access log format in fact if",
    "start": "1108460",
    "end": "1114730"
  },
  {
    "text": "you get really one thing from this talk and you're not familiar with the response flags it's well worth your time",
    "start": "1114730",
    "end": "1119980"
  },
  {
    "text": "just spending a little bit of time studying what these response flags are so the canonical example is that that",
    "start": "1119980",
    "end": "1126549"
  },
  {
    "text": "leta alluded to earlier you you hit an end point you get 404 the natural question is was this on where they gave",
    "start": "1126549",
    "end": "1132549"
  },
  {
    "text": "me the 404 or was this the remote service that gave me the 404 and so if you all you have is response code",
    "start": "1132549",
    "end": "1138429"
  },
  {
    "text": "there's really no way of reasoning or disambiguating these things but if you have that that response code you can",
    "start": "1138429",
    "end": "1144130"
  },
  {
    "text": "look at that you can reference it with the codes that are documented in our way and understand precisely who was",
    "start": "1144130",
    "end": "1149470"
  },
  {
    "text": "responsible for returning that code and there's there's a really rich set of data in there that can accelerate your triage capabilities so back to logging",
    "start": "1149470",
    "end": "1157480"
  },
  {
    "text": "external traffic so this does a greater than or equal to on the operand if it's 400 it will return it or if on boy has",
    "start": "1157480",
    "end": "1163960"
  },
  {
    "text": "set that response flag at all if it's set any flag there it will also return a true here so basically the two of these",
    "start": "1163960",
    "end": "1171010"
  },
  {
    "text": "put together will give you every error in that egressing traffic what if you",
    "start": "1171010",
    "end": "1176049"
  },
  {
    "start": "1174000",
    "end": "1174000"
  },
  {
    "text": "want to log slow calls and in this case we'll say to an authenticated external service this is somewhat contrived but I",
    "start": "1176049",
    "end": "1183280"
  },
  {
    "text": "think it shows the power of the filter capabilities very clearly again we've got a predicate filter and the first",
    "start": "1183280",
    "end": "1190150"
  },
  {
    "text": "filter that we're hitting is a header filter so that says look at egressing traffic does it contain and authorization header if it does and",
    "start": "1190150",
    "end": "1197590"
  },
  {
    "text": "the duration of that request is greater than or equal to 2,000 milliseconds then log it so you can probably start to see",
    "start": "1197590",
    "end": "1205360"
  },
  {
    "start": "1204000",
    "end": "1204000"
  },
  {
    "text": "with file based logging with these filters how you might be able to compose some really sophisticated and powerful",
    "start": "1205360",
    "end": "1211230"
  },
  {
    "text": "logging mechanisms within your own infrastructure but simultaneously you're probably also painfully aware of the",
    "start": "1211230",
    "end": "1216909"
  },
  {
    "text": "limits of file based logging particularly if you're deployed in an environment like kubernetes where maybe you'd want to keep read-only file",
    "start": "1216909",
    "end": "1222640"
  },
  {
    "text": "systems or if you're doing something fancy like with all these filters and multiple access logs maybe you have like five logs and your logging system really",
    "start": "1222640",
    "end": "1230530"
  },
  {
    "text": "wants everything on standard out standard error what if you wanted to avoid file based logging altogether so",
    "start": "1230530",
    "end": "1235809"
  },
  {
    "text": "envoy provides this mechanism known as the access log service and it's",
    "start": "1235809",
    "end": "1241210"
  },
  {
    "text": "illustrated here in blue so the general idea is open source envoy defines an endpoint",
    "start": "1241210",
    "end": "1246580"
  },
  {
    "text": "in the open source repo so there's this proto definition there and then you as a as a customer you implement that G RPC",
    "start": "1246580",
    "end": "1252909"
  },
  {
    "text": "endpoint that's what the blue box is and then you point your envoys to that",
    "start": "1252909",
    "end": "1258010"
  },
  {
    "text": "service and then it streams VG RPC very low latency all the log events to that",
    "start": "1258010",
    "end": "1264070"
  },
  {
    "text": "service and then you choose what to do with it from there so this is kind of a glue when I was probably like a stateless glue service that basically",
    "start": "1264070",
    "end": "1269890"
  },
  {
    "text": "grabs this unpacks it and then hands it off to some other internal system maybe it's elastic or maybe you treat it more",
    "start": "1269890",
    "end": "1276370"
  },
  {
    "text": "like a streaming data platform problem we do this at lyft that I've been working on this actually over the last couple months with some teams and you",
    "start": "1276370",
    "end": "1283419"
  },
  {
    "text": "know few observations from that is is recasting this like file logging problem into more of a streaming data platform",
    "start": "1283419",
    "end": "1289559"
  },
  {
    "text": "problem it lets you think a little more clearly about what you're trying to do you get all this type safety and",
    "start": "1289559",
    "end": "1294640"
  },
  {
    "text": "extensibility but you also get to leverage your existing system so like we run we run flink jobs over these event",
    "start": "1294640",
    "end": "1301840"
  },
  {
    "text": "streams in real time these these events find themselves into Druid so we get",
    "start": "1301840",
    "end": "1307090"
  },
  {
    "text": "near real-time access to these events via a sequel interface they find their way to hive so we can query be a presto",
    "start": "1307090",
    "end": "1313510"
  },
  {
    "text": "for example large sets of this data and different teams have found this to be",
    "start": "1313510",
    "end": "1318730"
  },
  {
    "text": "enormous ly valuable and it's allowed them to combine these data sources with other data sources for like much more",
    "start": "1318730",
    "end": "1323799"
  },
  {
    "text": "powerful use cases so it sounds a little bit complicated but it's actually be straightforward so this is what a",
    "start": "1323799",
    "end": "1329860"
  },
  {
    "text": "config looks like if you're pointing an envoy at the an access log service implementation so instead of saying file",
    "start": "1329860",
    "end": "1336520"
  },
  {
    "text": "access log you say HDTV GRP access log and then you give it a cluster name and that's a cluster name specified like any",
    "start": "1336520",
    "end": "1342520"
  },
  {
    "text": "other cluster or an envoy and that's all there is to it you'll notice the filter section is there available to you can so",
    "start": "1342520",
    "end": "1348070"
  },
  {
    "text": "you can compose those same filter capabilities together to give you not non file based access logging with super",
    "start": "1348070",
    "end": "1354610"
  },
  {
    "text": "sophisticated filtering capabilities what about the other side of it so what about what if you're implementing that",
    "start": "1354610",
    "end": "1360250"
  },
  {
    "start": "1355000",
    "end": "1355000"
  },
  {
    "text": "blue box that access log service if you've never done it before might sound sort of daunting how to implement gr PC",
    "start": "1360250",
    "end": "1365470"
  },
  {
    "text": "endpoint well it turns out there's help within the Envoy repo there's this thing called the go control plane it's kind of",
    "start": "1365470",
    "end": "1371650"
  },
  {
    "text": "like you could think of it like a Lego set for composing your own control plane and so there's an example of an access",
    "start": "1371650",
    "end": "1378580"
  },
  {
    "text": "log service implementation in that repo and I've just taken this directly from there so you can see really just like a half a page of code is that is the meat",
    "start": "1378580",
    "end": "1385390"
  },
  {
    "text": "of the implementation there's one method you can see what it does you can follow it even if you don't know go code basically loop forever go pull a",
    "start": "1385390",
    "end": "1392200"
  },
  {
    "text": "messages off this stream look at the message type and then at the bottom you've got full access to this",
    "start": "1392200",
    "end": "1398890"
  },
  {
    "text": "structured very very rich logging event data and then I say rich it's it's",
    "start": "1398890",
    "end": "1404320"
  },
  {
    "text": "extremely rich there's all these are very sophisticated timings in their time to first byte time to last buy it upstream downstream tons of super useful",
    "start": "1404320",
    "end": "1410500"
  },
  {
    "text": "things in there I did I did kind of skip past this too but on the configuration side there's these optional fields where",
    "start": "1410500",
    "end": "1416320"
  },
  {
    "text": "it's it's like if as these events are coming through you can choose to extract request or response headers and include",
    "start": "1416320",
    "end": "1421780"
  },
  {
    "text": "those in this event prior to it being dispatched off to that service you know so again maybe you have some headers",
    "start": "1421780",
    "end": "1426970"
  },
  {
    "text": "that are super specific to your environment but very vital maybe identify users or sessions or that sort of thing you can pull them out of here",
    "start": "1426970",
    "end": "1432580"
  },
  {
    "text": "put them in the response and then forward that along and have full access to that in the pipeline so that's config",
    "start": "1432580",
    "end": "1439540"
  },
  {
    "text": "that's the implementation not actually that much to it so some takeaways if you",
    "start": "1439540",
    "end": "1445060"
  },
  {
    "start": "1441000",
    "end": "1441000"
  },
  {
    "text": "wanna use file based logging there's it's highly configurable you can specify the format to your liking",
    "start": "1445060",
    "end": "1452230"
  },
  {
    "text": "very flexible composable filtering mechanism for access logs as you saw we can combine this with various predicate",
    "start": "1452230",
    "end": "1457330"
  },
  {
    "text": "logic to get really sophisticated use cases realized and then if you want to avoid file based entirely you can use this access log",
    "start": "1457330",
    "end": "1463899"
  },
  {
    "text": "service it gives you tight low latency mechanisms for doing pretty fancy things",
    "start": "1463899",
    "end": "1469289"
  },
  {
    "text": "in terms of the future I think there there's some interesting potentials here",
    "start": "1469289",
    "end": "1474369"
  },
  {
    "text": "and specifically one of them my team's gonna do some work on in the coming year",
    "start": "1474369",
    "end": "1479440"
  },
  {
    "text": "is this notion of like dynamic fidelity so maybe you have your logging turned",
    "start": "1479440",
    "end": "1484509"
  },
  {
    "text": "way down or almost off but dynamically at runtime you can have a knob to",
    "start": "1484509",
    "end": "1489820"
  },
  {
    "text": "basically throw out all that up and and and change the throughput and change the richness of that that logging data that's coming through to get really",
    "start": "1489820",
    "end": "1496749"
  },
  {
    "text": "precise information about very specific aspects of your service mesh another",
    "start": "1496749",
    "end": "1502479"
  },
  {
    "text": "thing that occurred to me actually while I was working on this talk is I think there's some interesting opportunities for collaboration and open source on a",
    "start": "1502479",
    "end": "1508149"
  },
  {
    "text": "reusable access log server implementation so I think you don't have to squint too hard to to a picture an",
    "start": "1508149",
    "end": "1514269"
  },
  {
    "text": "open source project that basically is a sync for these these events it grabs it in via G RPC performs perhaps some sort",
    "start": "1514269",
    "end": "1521679"
  },
  {
    "text": "of optional transformation on it and then has a pluggable back-end maybe you have a Kinesis back-end a Kafka back-end",
    "start": "1521679",
    "end": "1527919"
  },
  {
    "text": "some other pub/sub some elastic back-end that could be very broadly usable I think across a lot of companies so",
    "start": "1527919",
    "end": "1535960"
  },
  {
    "text": "that's logs the final section is that's back to you Lita actually stature one of",
    "start": "1535960",
    "end": "1545440"
  },
  {
    "text": "my favorite things about envoy and so there's a lot of them and so will crack",
    "start": "1545440",
    "end": "1551139"
  },
  {
    "text": "a little bit about how to go about navigating the world of stats particularly an envoy so I decided to",
    "start": "1551139",
    "end": "1557320"
  },
  {
    "start": "1555000",
    "end": "1555000"
  },
  {
    "text": "like try to figure out a taxonomy of stats if that was possible like if you curl the admin endpoint slash stats",
    "start": "1557320",
    "end": "1563559"
  },
  {
    "text": "there's overwhelmed with a lot of data I like in figure and that's been my",
    "start": "1563559",
    "end": "1569309"
  },
  {
    "text": "learning curve it's like how do I think about what stats I care about where should I be looking if I'm having",
    "start": "1569309",
    "end": "1575289"
  },
  {
    "text": "networking issues or if I'm trying to debug or I'm trying to roll out a new voice feature so this is what I came up",
    "start": "1575289",
    "end": "1581830"
  },
  {
    "text": "with I well with the help of the docs and just like thinking about it a lot",
    "start": "1581830",
    "end": "1586989"
  },
  {
    "text": "but know you I've organized them to like boundary stats so these are your listener stats so if you",
    "start": "1586989",
    "end": "1593520"
  },
  {
    "text": "issues with like TLS or codec problems or like specifically with requests",
    "start": "1593520",
    "end": "1599610"
  },
  {
    "text": "coming into your proxy you'll be probably looking in your down tree of stats and and then there's the",
    "start": "1599610",
    "end": "1606300"
  },
  {
    "text": "up Shu stats and then the control playing stats which are I'm not going to go too deeply into but I do lovers these",
    "start": "1606300",
    "end": "1613650"
  },
  {
    "text": "a lot so sitting around like if an update was rejected or the configuration was misconfigured I will be looking in",
    "start": "1613650",
    "end": "1620880"
  },
  {
    "text": "there and then your envoy internal so let's go into the each one of these",
    "start": "1620880",
    "end": "1627240"
  },
  {
    "text": "little sections so down down shoot stats again these are requests coming in to the proxy these are your listeners stats",
    "start": "1627240",
    "end": "1633960"
  },
  {
    "text": "when you're trying to set up TLS we have mutual TLS you'll be looking at the TLS inspector and seeing like it's my it's",
    "start": "1633960",
    "end": "1639990"
  },
  {
    "text": "my cert it meant as long as the traffic correctly am I getting what are the certificates I'm getting so those are",
    "start": "1639990",
    "end": "1646380"
  },
  {
    "text": "the things where were these stats to be helpful here well you when you're wanting to inspect the traffic coming into your proxy the second is the",
    "start": "1646380",
    "end": "1654330"
  },
  {
    "text": "cluster stat so these are the stats actually use the most these stats are emitted when envoy is the client and",
    "start": "1654330",
    "end": "1661110"
  },
  {
    "text": "sending off to either your like third party API or to another service this is",
    "start": "1661110",
    "end": "1666390"
  },
  {
    "text": "where your load balancer stats will live this is where your health checking will live and service discovery would live",
    "start": "1666390",
    "end": "1672230"
  },
  {
    "text": "again that this is the stats are like you care most of for me I care most",
    "start": "1672230",
    "end": "1677760"
  },
  {
    "text": "about what the client is seeing because at the end of the day that's like that's the",
    "start": "1677760",
    "end": "1683730"
  },
  {
    "text": "most important Wow like so I usually check the view of of 5x X 4x ads from",
    "start": "1683730",
    "end": "1691620"
  },
  {
    "text": "the cluster perspective which is I could equate it to the client perspective and the process that's well this is the",
    "start": "1691620",
    "end": "1700170"
  },
  {
    "start": "1696000",
    "end": "1696000"
  },
  {
    "text": "actual server itself or the process of envoy self so I get a lot of questions around like is envoy performant how much",
    "start": "1700170",
    "end": "1705930"
  },
  {
    "text": "memory does it take how much CPU utilization this is take on but amidst those stats the Envoy has that's around",
    "start": "1705930",
    "end": "1712830"
  },
  {
    "text": "memory usage and if you using hot envoys hot restart functionality this is where",
    "start": "1712830",
    "end": "1718470"
  },
  {
    "text": "the stat will live you it will show you the amount of connections in the parrot process as well as the child process to",
    "start": "1718470",
    "end": "1724860"
  },
  {
    "text": "ensure that the hot start is working as properly but also this would be good to monitor along with",
    "start": "1724860",
    "end": "1730490"
  },
  {
    "text": "if you're using like if you have container stats for your VM stats it would be good to see compare those to",
    "start": "1730490",
    "end": "1737060"
  },
  {
    "text": "see do they match up is something funky going on if they're not munching up and",
    "start": "1737060",
    "end": "1742340"
  },
  {
    "text": "so that's that's extremely useful that envoy admits those so I decided to go",
    "start": "1742340",
    "end": "1747470"
  },
  {
    "text": "into some of my youthful stats that I decided to share with you so most of",
    "start": "1747470",
    "end": "1753860"
  },
  {
    "text": "these are cluster stats so the upstream request pending total and upstream request pending active so if usually in",
    "start": "1753860",
    "end": "1763070"
  },
  {
    "text": "a in a happy path the active should match the total whenever the total is",
    "start": "1763070",
    "end": "1769430"
  },
  {
    "text": "not matching the unlike the total requests pending total is a lot greater than request pending active that means",
    "start": "1769430",
    "end": "1776780"
  },
  {
    "text": "envoys request to is backed up and something and either your applications not responding quickly enough to your",
    "start": "1776780",
    "end": "1785210"
  },
  {
    "text": "requests so there there's a load issue there or maybe your you miss configured",
    "start": "1785210",
    "end": "1790340"
  },
  {
    "text": "how much active requests your assistant can take so that maybe there's an uni degree configure there's a non-void",
    "start": "1790340",
    "end": "1797570"
  },
  {
    "text": "configuration you should update but usually like monitoring those when you're treating issues these are the",
    "start": "1797570",
    "end": "1804500"
  },
  {
    "text": "stats I'm looking at to make ensure that your system is running along pepper lay or if it's backing up and can lead to",
    "start": "1804500",
    "end": "1813160"
  },
  {
    "text": "cascading failure the other sets I look at is service discovery this health",
    "start": "1813160",
    "end": "1820280"
  },
  {
    "start": "1815000",
    "end": "1815000"
  },
  {
    "text": "check health checking is a very important aspect of my job so I look at both health check we use active health",
    "start": "1820280",
    "end": "1826280"
  },
  {
    "text": "checking as well as passive health tracking which is a outlier detection so I tend to look at that I also look at",
    "start": "1826280",
    "end": "1834050"
  },
  {
    "text": "membership stats so that's how many healthy hosts there are in ideally membership total should match members",
    "start": "1834050",
    "end": "1839300"
  },
  {
    "text": "membership healthy and also a panic routing so like that's on voice loud way",
    "start": "1839300",
    "end": "1844970"
  },
  {
    "text": "of saying your mesh is not converging it and so we page on this if this ever",
    "start": "1844970",
    "end": "1850940"
  },
  {
    "text": "happening but ultimately there's a lot of you again like I didn't I wanted to",
    "start": "1850940",
    "end": "1857900"
  },
  {
    "text": "put a list of all the stats on but it didn't fit on the slide so and I don't think that's that that's the",
    "start": "1857900",
    "end": "1865990"
  },
  {
    "text": "experience you should give to your end users which is your application developers so at least we provide a",
    "start": "1865990",
    "end": "1872480"
  },
  {
    "text": "dashboard to make the network understandable and transparent so here's a normal like a service dashboard but",
    "start": "1872480",
    "end": "1878450"
  },
  {
    "text": "our service owner can see like what are the network requests coming in and what a network request I'm admitting out like",
    "start": "1878450",
    "end": "1885010"
  },
  {
    "text": "what service and we show what services you're talking to as well as what services are talking to me if we have",
    "start": "1885010",
    "end": "1891140"
  },
  {
    "text": "that data we we also look at retry accounts as well and this this - where",
    "start": "1891140",
    "end": "1897230"
  },
  {
    "text": "doesn't show it but we have timeouts as well so this is a at the end of the day like I think most people do that most",
    "start": "1897230",
    "end": "1903770"
  },
  {
    "text": "companies do this where we try to convert all these useful stats and distill it down to a dashboard that's",
    "start": "1903770",
    "end": "1909110"
  },
  {
    "text": "easy to understand and then if we're triage rating or not like trying to root cause an issue we make custom incident",
    "start": "1909110",
    "end": "1916520"
  },
  {
    "text": "dashboards to see like what's going on and try to figure out root cause issues so the key takeaways of the start is",
    "start": "1916520",
    "end": "1923450"
  },
  {
    "text": "that I try to organize success as a taxonomy to figure out where what what",
    "start": "1923450",
    "end": "1928670"
  },
  {
    "text": "am I trying to solve what question I'm trying to answer and then use that to leverage where to look because there's a",
    "start": "1928670",
    "end": "1935120"
  },
  {
    "text": "lot of stats in on voice again yeah envoy mitts a lot of stats and you can do a lot of root cause analysis just",
    "start": "1935120",
    "end": "1941510"
  },
  {
    "text": "purely on stats which is pretty amazing but again like it requires you to figure out where we're like what questions like",
    "start": "1941510",
    "end": "1949670"
  },
  {
    "text": "am I worried about like it's did TLS break was it am i getting a bunch of 500 in my",
    "start": "1949670",
    "end": "1955340"
  },
  {
    "text": "question it's my request q backing up and my applications not responding quickly so trying to figure out what",
    "start": "1955340",
    "end": "1965420"
  },
  {
    "text": "question trying to answer and then organizing the stats of downstream upstream and then the process stats it",
    "start": "1965420",
    "end": "1971420"
  },
  {
    "text": "will help and then and then the day is worth making a dashboard for your end users so that they could also monitor",
    "start": "1971420",
    "end": "1977840"
  },
  {
    "text": "the network in an understandable way like um there's too many stats for one person like for every engineer to",
    "start": "1977840",
    "end": "1985040"
  },
  {
    "text": "understand so distilling it down to like something that your company can monitor",
    "start": "1985040",
    "end": "1990590"
  },
  {
    "text": "the health of their system would be a use it's useful as an useful to us I lift and that's it thank you so much for",
    "start": "1990590",
    "end": "1998049"
  },
  {
    "text": "coming to our talk thanks so much [Applause]",
    "start": "1998049",
    "end": "2005880"
  }
]