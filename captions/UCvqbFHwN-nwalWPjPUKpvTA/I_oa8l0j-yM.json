[
  {
    "start": "0",
    "end": "12000"
  },
  {
    "text": "all right can you guys hear me that's cool so good morning and welcome to this",
    "start": "30",
    "end": "5640"
  },
  {
    "text": "talk it's great to see so many people interested in what we have to say so my",
    "start": "5640",
    "end": "12990"
  },
  {
    "start": "12000",
    "end": "35000"
  },
  {
    "text": "name is Erica and we are software engineers at Spotify we work in the ATC",
    "start": "12990",
    "end": "20760"
  },
  {
    "text": "team and that's the team that owns and operates Spotify perimeter the perimeter",
    "start": "20760",
    "end": "27930"
  },
  {
    "text": "is on the path of each and every communication between clients and Spotify back-end and so for that reason",
    "start": "27930",
    "end": "34710"
  },
  {
    "text": "it's a very critical piece of infrastructure as you can imagine Spotify is adopt an opt-in teams model",
    "start": "34710",
    "end": "43640"
  },
  {
    "start": "35000",
    "end": "74000"
  },
  {
    "text": "meaning they're a team that developed a service is also responsible for operating it 24/7 in production and our",
    "start": "43640",
    "end": "52289"
  },
  {
    "text": "team is no different so on a daily basis we deal with both operational kind of",
    "start": "52289",
    "end": "57390"
  },
  {
    "text": "work which just stems from keeping the lights on so to speak but also with development work which has to do with",
    "start": "57390",
    "end": "64228"
  },
  {
    "text": "how we decide to evolve the perimeter over time in our team we also have an",
    "start": "64229",
    "end": "69840"
  },
  {
    "text": "on-call rotation which is on a weekly basis we are here today because we want",
    "start": "69840",
    "end": "76380"
  },
  {
    "start": "74000",
    "end": "113000"
  },
  {
    "text": "to share with you how we migrated apart of Spotify perimeter to an employee",
    "start": "76380",
    "end": "81780"
  },
  {
    "text": "based solution of course we will explain how we did it and also share with you",
    "start": "81780",
    "end": "87450"
  },
  {
    "text": "what worked well during this work what didn't so the lessons that we learned along the way and also we will briefly",
    "start": "87450",
    "end": "95040"
  },
  {
    "text": "talk about our vision for Spotify perimeter moving forward finally we want",
    "start": "95040",
    "end": "100439"
  },
  {
    "text": "to leave you with let's say the key takeaways from all of this migration work that we've done with the hope that",
    "start": "100439",
    "end": "106770"
  },
  {
    "text": "they might be useful to you if you're going to do similar migration in the future hopefully the majority of you in",
    "start": "106770",
    "end": "114899"
  },
  {
    "start": "113000",
    "end": "134000"
  },
  {
    "text": "the audience is familiar with Spotify has heard of it before even better you're a user or even even better you're",
    "start": "114899",
    "end": "121829"
  },
  {
    "text": "like a pain user but just in case let me quickly say what Spotify is so Spotify",
    "start": "121829",
    "end": "128640"
  },
  {
    "text": "is an audio streaming platform and it's available on a wide variety of devices and client",
    "start": "128640",
    "end": "134540"
  },
  {
    "text": "Spotify has 248 million monthly active users making it the most popular audio",
    "start": "134540",
    "end": "141660"
  },
  {
    "text": "streaming subscription service as you can imagine all those users generate quite a bit of traffic but just to give",
    "start": "141660",
    "end": "148260"
  },
  {
    "text": "you a more precise idea of the volumes we're talking about at peak Spotify",
    "start": "148260",
    "end": "153270"
  },
  {
    "text": "Perimeter handles more than 8 million requests per second as fortifies beckon",
    "start": "153270",
    "end": "159000"
  },
  {
    "text": "is a distributed system and it has a micro service architecture we have more than a thousand micro services deployed",
    "start": "159000",
    "end": "166200"
  },
  {
    "text": "in production also nearly all of Spotify the services and infrastructure is",
    "start": "166200",
    "end": "171390"
  },
  {
    "text": "hosted in Google cloud and we are present in three regions one from Europe one for the US and one for Asia but",
    "start": "171390",
    "end": "179760"
  },
  {
    "text": "let's now see how the backend the perimeter and the clients all fit together to make Spotify work so on the",
    "start": "179760",
    "end": "188970"
  },
  {
    "start": "187000",
    "end": "328000"
  },
  {
    "text": "right hand side of this diagram you can see if fortifies back-end and like I just said it's made up of many many",
    "start": "188970",
    "end": "196110"
  },
  {
    "text": "services of course some of these services like for instance the login",
    "start": "196110",
    "end": "201120"
  },
  {
    "text": "service or search or playlist have to be exposed to the public internet so that",
    "start": "201120",
    "end": "207079"
  },
  {
    "text": "your smartphone or whatever other device out there can actually talk to these",
    "start": "207079",
    "end": "213120"
  },
  {
    "text": "services when you're using it Spotify and that's exactly where the Perimeter comes in it allows exposure of back-end",
    "start": "213120",
    "end": "220440"
  },
  {
    "text": "services to the internet so that clients can communicate with them but it also acts as kind of a wall protective wall",
    "start": "220440",
    "end": "227850"
  },
  {
    "text": "between Spotify back-end and the Internet but let's now zoom in a little",
    "start": "227850",
    "end": "233640"
  },
  {
    "text": "bit more on the perimeter itself this diagram is somewhat of a simplified view",
    "start": "233640",
    "end": "239519"
  },
  {
    "text": "of our perimeter but it still kind of serves to illustrate the main use cases",
    "start": "239519",
    "end": "244739"
  },
  {
    "text": "for the perimeter the first one is represented by the vertical on your left hand side and it's",
    "start": "244739",
    "end": "252840"
  },
  {
    "text": "to basically allow HTTP clients on the Internet to communicate with back-end",
    "start": "252840",
    "end": "259019"
  },
  {
    "text": "services that only understand herm√®s now if you've never heard of or",
    "start": "259019",
    "end": "264450"
  },
  {
    "text": "miss before that totally fine because it proprietary protocol that Spotify",
    "start": "264450",
    "end": "269720"
  },
  {
    "text": "developed back in 2012 and though it's now being phased out in favor of JRPG we",
    "start": "269720",
    "end": "277490"
  },
  {
    "text": "still have a lot of services that use it so the perimeter has an HTTP to Hermes",
    "start": "277490",
    "end": "283460"
  },
  {
    "text": "gateway just dedicated to this use case but spotty voice back and also has quite",
    "start": "283460",
    "end": "290000"
  },
  {
    "text": "a bit of services that talk HTTP so in that case the perimeter has a web",
    "start": "290000",
    "end": "296600"
  },
  {
    "text": "gateway that you can see in the middle of the diagram for these HTTP clients - HTTP services use case and finally one",
    "start": "296600",
    "end": "306320"
  },
  {
    "text": "more use case by the perimeter is to allow persistent connections between Spotify back-end and clients and that to",
    "start": "306320",
    "end": "314780"
  },
  {
    "text": "allow state changes that originate in the backend to be pushed out to all the connected clients so a typical example",
    "start": "314780",
    "end": "320840"
  },
  {
    "text": "of this would be if a new track is re to a Spotify playlist for example this talk",
    "start": "320840",
    "end": "329870"
  },
  {
    "start": "328000",
    "end": "359000"
  },
  {
    "text": "is going to focus on the part of the perimeter that is allotted by the red box so the HTTP clients - HTTP services",
    "start": "329870",
    "end": "339050"
  },
  {
    "text": "use case and it's going to cover how we removed or si replaced this part of the",
    "start": "339050",
    "end": "346700"
  },
  {
    "text": "perimeter with an ember based solution now Wladimir will zoom in a little bit",
    "start": "346700",
    "end": "351950"
  },
  {
    "text": "on this red box and explain what's inside we call it Bob internally it's a",
    "start": "351950",
    "end": "386090"
  },
  {
    "start": "359000",
    "end": "497000"
  },
  {
    "text": "custom google cloud with nginx for SSL termination and proxy to proxy it she",
    "start": "386090",
    "end": "393289"
  },
  {
    "text": "proxy is responsible break-ins and it's proxies",
    "start": "393289",
    "end": "403850"
  },
  {
    "text": "so each OB is hosting Google cloud with",
    "start": "417080",
    "end": "423470"
  },
  {
    "text": "the next versus elimination which proxy Stacia proxy it's a proxy proxies to beckons and for example the backend",
    "start": "423470",
    "end": "430560"
  },
  {
    "text": "which handles traffic for the dub dub dub switch icon for each URL the docks",
    "start": "430560",
    "end": "438270"
  },
  {
    "text": "which become account specific home there are multiple exposure settings like",
    "start": "438270",
    "end": "444270"
  },
  {
    "text": "request a mouse how to have a check overall like 25 different things there",
    "start": "444270",
    "end": "450510"
  },
  {
    "text": "but that is responsible for configuring both nginx and Asia proxy from",
    "start": "450510",
    "end": "457320"
  },
  {
    "text": "configuration from github service discovery was also done by piped each",
    "start": "457320",
    "end": "463920"
  },
  {
    "text": "puppet Ram peppadews ring continuously and it resolved the backends from our",
    "start": "463920",
    "end": "469530"
  },
  {
    "text": "service discovery system each pod pepper an updated configuration file for each",
    "start": "469530",
    "end": "476550"
  },
  {
    "text": "proxy with NPS and ports for the backends when sports which were per",
    "start": "476550",
    "end": "482250"
  },
  {
    "text": "wanted to expose a website or an HTTP upstream they made a poor request to a",
    "start": "482250",
    "end": "487800"
  },
  {
    "text": "puppet get rapper in this single configuration file so let's see if there",
    "start": "487800",
    "end": "494880"
  },
  {
    "text": "was something to improve the parameter had some flaws and those became apparent",
    "start": "494880",
    "end": "501900"
  },
  {
    "text": "as in the past speed 5 prioritized",
    "start": "501900",
    "end": "507030"
  },
  {
    "text": "mobile traffic over the web traffic and that made up a perimeter kind of ops",
    "start": "507030",
    "end": "513620"
  },
  {
    "text": "kind of an afterthought compared to the traffic which walker was coming from iOS devices and Android",
    "start": "513620",
    "end": "520890"
  },
  {
    "text": "advanced features were added over time sometimes haphazardly and there's a",
    "start": "520890",
    "end": "528030"
  },
  {
    "text": "perimeter became absurd with the available features were not relevant and Helen fishers were",
    "start": "528030",
    "end": "536029"
  },
  {
    "text": "available things were so bad that the product teams will bring their own",
    "start": "536029",
    "end": "541100"
  },
  {
    "text": "parameters based on engine X's and even on n voice behind our perimeter and",
    "start": "541100",
    "end": "546350"
  },
  {
    "text": "before their beckons to get the needed features the old perimeter was insane",
    "start": "546350",
    "end": "555230"
  },
  {
    "text": "prone sorry there were several scary",
    "start": "555230",
    "end": "560779"
  },
  {
    "text": "problems and kept a patron took around like five to ten minutes and that put a",
    "start": "560779",
    "end": "565940"
  },
  {
    "text": "limit on how fast the new back-end could be discovered and that in turn was a big",
    "start": "565940",
    "end": "571850"
  },
  {
    "text": "issue because expert if I our features and product teams move too fast changing",
    "start": "571850",
    "end": "579140"
  },
  {
    "text": "ephemeral infrastructure such as kubernetes our perimeter was cosmetic",
    "start": "579140",
    "end": "587180"
  },
  {
    "text": "rate it was like a lot of instant it gets to 28 in the role it was mentioned",
    "start": "587180",
    "end": "593180"
  },
  {
    "text": "in 30 it was difficult to troubleshoot because of poor observability on the SSP",
    "start": "593180",
    "end": "601520"
  },
  {
    "text": "upstream we could evolve the all primitive fix the service cavalry and I",
    "start": "601520",
    "end": "606980"
  },
  {
    "text": "kept the relevant features but that would mean that we would invest only in the SSP to access LeapPad part of the",
    "start": "606980",
    "end": "613940"
  },
  {
    "text": "parameter that Erica told us about since it's obvious where are we going with",
    "start": "613940",
    "end": "619220"
  },
  {
    "text": "this looks like we're a migration from it which also in five perimeter and the",
    "start": "619220",
    "end": "626000"
  },
  {
    "start": "621000",
    "end": "656000"
  },
  {
    "text": "one awesome gateway doing all things perimeter and based on Android and coded",
    "start": "626000",
    "end": "633170"
  },
  {
    "text": "edge all our protocols this video here means pure SB and JC",
    "start": "633170",
    "end": "641690"
  },
  {
    "text": "would need the similar features like authentication organization security features and metrics and so on",
    "start": "641690",
    "end": "648470"
  },
  {
    "text": "and so on it makes a lot of sense to implemented once so immigration sure but",
    "start": "648470",
    "end": "658460"
  },
  {
    "start": "656000",
    "end": "770000"
  },
  {
    "text": "like why I'm going which way grow is becoming more and more cognitive the",
    "start": "658460",
    "end": "665060"
  },
  {
    "text": "Korean French Department which I would seem is part of is leading the kubernetes migration and you could hear",
    "start": "665060",
    "end": "671540"
  },
  {
    "text": "the James when talk yesterday also we're trying to scope this Hermus protocol for",
    "start": "671540",
    "end": "677570"
  },
  {
    "text": "the JBC and so using a sincere it makes a lot of sense to use native as well the",
    "start": "677570",
    "end": "689660"
  },
  {
    "text": "perimeter is far from specific or business so it makes a lot of sense to use a cloud to use a CNC F baked one",
    "start": "689660",
    "end": "697250"
  },
  {
    "text": "which has taken off as a standard already like it's kind of an easy choice",
    "start": "697250",
    "end": "703760"
  },
  {
    "text": "to make exist protocol allows us to configure our invoice with hello Java",
    "start": "703760",
    "end": "712850"
  },
  {
    "text": "control plane which with lots of tests using abstractions and using Spotify",
    "start": "712850",
    "end": "720529"
  },
  {
    "text": "domain terminology this will allow us to provide a bliss set of use cases to the",
    "start": "720529",
    "end": "726890"
  },
  {
    "text": "users between developers we call this use cases golden parts and we would use",
    "start": "726890",
    "end": "734570"
  },
  {
    "text": "the same practices and tools that the rest of speech way uses for development",
    "start": "734570",
    "end": "741370"
  },
  {
    "text": "will also like that invoice is enjoys a lot of community activity and a lot of",
    "start": "741370",
    "end": "749270"
  },
  {
    "text": "companies like ours or even bigger contribute to it we also want to",
    "start": "749270",
    "end": "756380"
  },
  {
    "text": "contribute back and our team members they're sitting in the front row or as I've made a handful of poor requests",
    "start": "756380",
    "end": "762670"
  },
  {
    "text": "back to Android so let's see how we're going to redesign the perimeter with",
    "start": "762670",
    "end": "768370"
  },
  {
    "text": "voice so this is edge of new perimeter",
    "start": "768370",
    "end": "773750"
  },
  {
    "text": "system drone is a set of boxes the bigger blue box is the hvm on the VM",
    "start": "773750",
    "end": "780290"
  },
  {
    "text": "there are like a few docker processes and the first one and the main one is anyway this into",
    "start": "780290",
    "end": "786200"
  },
  {
    "text": "space traffic asbestos abyss traffic coming from the Google HTTP a load",
    "start": "786200",
    "end": "792860"
  },
  {
    "text": "balancer handles both PC traffic and participate in why issue incoming",
    "start": "792860",
    "end": "799760"
  },
  {
    "text": "requests is caught by invoice extol filter which passes to ex-old service",
    "start": "799760",
    "end": "805190"
  },
  {
    "text": "which runs on the same host which owns service checks the authentication we",
    "start": "805190",
    "end": "813890"
  },
  {
    "text": "currently only support dealer with tokens and also it does decoration of",
    "start": "813890",
    "end": "821420"
  },
  {
    "text": "the incoming requests with like geolocation date it much as I purposes",
    "start": "821420",
    "end": "827660"
  },
  {
    "text": "of the of the users to the countries and cities where are they coming from",
    "start": "827660",
    "end": "833270"
  },
  {
    "text": "o in what instances are configured by our control plane cluster visual PC",
    "start": "833270",
    "end": "840590"
  },
  {
    "text": "control service which we implement it allows us to limit the rich set of things that you could do in any way with",
    "start": "840590",
    "end": "847910"
  },
  {
    "text": "the set of blessed use cases which parameter should support so how did",
    "start": "847910",
    "end": "853490"
  },
  {
    "text": "integrate a ricotta right so pretty",
    "start": "853490",
    "end": "860210"
  },
  {
    "start": "858000",
    "end": "963000"
  },
  {
    "text": "early on we identify the core major requirements for this migration work",
    "start": "860210",
    "end": "865960"
  },
  {
    "text": "first of all it shouldn't create any additional work for the owners of the",
    "start": "865960",
    "end": "871640"
  },
  {
    "text": "upstreams being migrated the main idea here is that product teams in Spotify should be able to stay focused on",
    "start": "871640",
    "end": "878810"
  },
  {
    "text": "developing new product features and the switch to a new parameter should be completely transparent to them the",
    "start": "878810",
    "end": "886160"
  },
  {
    "text": "second requirement would be the migration should be transparent to the end users of the up streams so in this",
    "start": "886160",
    "end": "892460"
  },
  {
    "text": "case we're talking about a target of zero downtime or at least as close to that as possible",
    "start": "892460",
    "end": "899110"
  },
  {
    "text": "third the migration should happen gradually and that's for mainly two reasons",
    "start": "899590",
    "end": "904760"
  },
  {
    "text": "up until the point edge actually served virtually no traffic so while we were",
    "start": "904760",
    "end": "911390"
  },
  {
    "text": "pretty sure that it was but already we didn't actually have any metrics to prove that so we kind of needed to build",
    "start": "911390",
    "end": "918410"
  },
  {
    "text": "some evidence in the new perimeter if you will and also we wanted to minimize",
    "start": "918410",
    "end": "923880"
  },
  {
    "text": "impact on end-users in case of unforeseen problems with edge and lastly",
    "start": "923880",
    "end": "930310"
  },
  {
    "text": "we should have a quick fall back so if during the migration at any point something goes wrong and the users are",
    "start": "930310",
    "end": "938470"
  },
  {
    "text": "impacted then we want to have a way to revert back to a working state and that",
    "start": "938470",
    "end": "944649"
  },
  {
    "text": "must happen quickly within minutes so we kind of want a big panic button that we",
    "start": "944649",
    "end": "950019"
  },
  {
    "text": "can push any time we even suspect we're in trouble given these poor requirements we came up",
    "start": "950019",
    "end": "956649"
  },
  {
    "text": "with a migration in three different stages so now we're going to talk about each of the stages the main objective",
    "start": "956649",
    "end": "964990"
  },
  {
    "start": "963000",
    "end": "1021000"
  },
  {
    "text": "for this first stage was to put some traffic on edge and learn as much as possible about its behavior under load",
    "start": "964990",
    "end": "972930"
  },
  {
    "text": "we decided to migrate one of the HTTP to Hermes gateways in the perimeter",
    "start": "972930",
    "end": "980290"
  },
  {
    "text": "these Pacific gateway serves on the traffic for experimental features or features that are under development and",
    "start": "980290",
    "end": "987430"
  },
  {
    "text": "makes no guarantees about its availability or reliability so it's kind of less critical compared to similar",
    "start": "987430",
    "end": "994390"
  },
  {
    "text": "gateways that serve production traffic also we ourselves own that that gateway",
    "start": "994390",
    "end": "1000540"
  },
  {
    "text": "so what kind of stakeholders of this first stage so we don't have to",
    "start": "1000540",
    "end": "1006660"
  },
  {
    "text": "coordinate or interact with other teams for this reason during this particular",
    "start": "1006660",
    "end": "1012990"
  },
  {
    "text": "stage of demography decided to deviate a little bit from our requirements and to",
    "start": "1012990",
    "end": "1018329"
  },
  {
    "text": "optimize for speed over safety we decided to switch traffic over to add",
    "start": "1018329",
    "end": "1024240"
  },
  {
    "text": "for a global DNS change and yes clearly that was a bit of a risky move but we",
    "start": "1024240",
    "end": "1030000"
  },
  {
    "text": "thought that being able to move quickly through this stage was actually worth that risk this initial stage proved",
    "start": "1030000",
    "end": "1037740"
  },
  {
    "text": "useful so the degree kind of showed that edge was you know good enough for for traffic with but already it also",
    "start": "1037740",
    "end": "1044970"
  },
  {
    "text": "uncovered the bug in our ex tops implementation so we kind of fix this before moving on to the next stage",
    "start": "1044970",
    "end": "1052919"
  },
  {
    "text": "the main objective of this second stage was to put some real production traffic on edge we settled on migrating the HTTP",
    "start": "1052919",
    "end": "1062309"
  },
  {
    "start": "1059000",
    "end": "1123000"
  },
  {
    "text": "upstream for Spotify Web Player if you're not familiar with it it's hosted at open dot Spotify comm and it's what",
    "start": "1062309",
    "end": "1069390"
  },
  {
    "text": "you would use to browse or play your Spotify music on Chrome or Safari for example contrary to the first stage we",
    "start": "1069390",
    "end": "1078840"
  },
  {
    "text": "were now migrating a critical upstream that accounts for 5 to 10% of Spotify",
    "start": "1078840",
    "end": "1084809"
  },
  {
    "text": "traffic to HTTP services also during this stage we now had stakeholders",
    "start": "1084809",
    "end": "1090809"
  },
  {
    "text": "outside of our team and Department so first of all the team that owns the web",
    "start": "1090809",
    "end": "1096779"
  },
  {
    "text": "player but also customer support so what does this all mean in practice well this",
    "start": "1096779",
    "end": "1104220"
  },
  {
    "text": "second stage clearly was much more delicate than the first stage and required a well for our strategy we",
    "start": "1104220",
    "end": "1111929"
  },
  {
    "text": "couldn't just simply wing it and hope for the best the strategy had to",
    "start": "1111929",
    "end": "1116970"
  },
  {
    "text": "optimize for safety but still allow us to migrate at a decent speed after some",
    "start": "1116970",
    "end": "1125100"
  },
  {
    "start": "1123000",
    "end": "1160000"
  },
  {
    "text": "discussing and brainstorming we came up with an iterative strategy that",
    "start": "1125100",
    "end": "1130350"
  },
  {
    "text": "consisted in shifting traffic to edge shifting progressively more and more",
    "start": "1130350",
    "end": "1135840"
  },
  {
    "text": "traffic to edge the monitoring and making any adjustments along the way if",
    "start": "1135840",
    "end": "1141480"
  },
  {
    "text": "necessary and then repeating until 100 percent of the web player traffic was",
    "start": "1141480",
    "end": "1146789"
  },
  {
    "text": "moved to edge since there were external stakeholders impacted by this we also",
    "start": "1146789",
    "end": "1152100"
  },
  {
    "text": "had to take into account some coordination work but let's see how this",
    "start": "1152100",
    "end": "1158039"
  },
  {
    "text": "happened in practice so this first",
    "start": "1158039",
    "end": "1163380"
  },
  {
    "start": "1160000",
    "end": "1253000"
  },
  {
    "text": "diagram illustrates the set up for the web player on the old web gateway so",
    "start": "1163380",
    "end": "1169139"
  },
  {
    "text": "before any of this migration happened and we call the old web gateway well",
    "start": "1169139",
    "end": "1175649"
  },
  {
    "text": "being wobble beam so that's what's in the so in the top right corner we have",
    "start": "1175649",
    "end": "1181320"
  },
  {
    "text": "the web player upstream which is configured to be exposed the internet through the web will be in",
    "start": "1181320",
    "end": "1188490"
  },
  {
    "text": "front of the web will be we have a google cloud reginald tcp load balancer proxying traffic to it when i user types",
    "start": "1188490",
    "end": "1196830"
  },
  {
    "text": "open dot spotify dot-com in our browser we want her to be resolved to the google cloud region that is closest to her we",
    "start": "1196830",
    "end": "1205320"
  },
  {
    "text": "use dns GSLV to distribute traffic across different geographies we write",
    "start": "1205320",
    "end": "1212010"
  },
  {
    "text": "this DNS configuration and then I have an internal tool that we used to push push this out to our public dns",
    "start": "1212010",
    "end": "1219330"
  },
  {
    "text": "providers so as I said earlier our strategy was to progressively shift more",
    "start": "1219330",
    "end": "1226860"
  },
  {
    "text": "and more of the web player traffic to edge but this original setup couldn't really get us there it needed",
    "start": "1226860",
    "end": "1233970"
  },
  {
    "text": "some tweaking so what to do well we considered several different options but",
    "start": "1233970",
    "end": "1240750"
  },
  {
    "text": "in the end the one that kind of fit most naturally with this setup that we had",
    "start": "1240750",
    "end": "1246060"
  },
  {
    "text": "made use of the Google cloud the HTTP load balancer so let's see how we use",
    "start": "1246060",
    "end": "1251760"
  },
  {
    "text": "that in this second drive diagram I have colored in blue the things that are",
    "start": "1251760",
    "end": "1257550"
  },
  {
    "text": "either new or different compared to the original set up so the very first thing",
    "start": "1257550",
    "end": "1264030"
  },
  {
    "text": "we did is that we stood up an HTTP load balancer in front of the web will be and",
    "start": "1264030",
    "end": "1271050"
  },
  {
    "text": "proxy in traffic to it it's the blue cloud that you see on the right hand side of the diagram to minimize risk",
    "start": "1271050",
    "end": "1278220"
  },
  {
    "text": "initially we modified our DNS just a big configuration so that only Sweden would",
    "start": "1278220",
    "end": "1283740"
  },
  {
    "text": "be resolved to the new load balancer and the rest of the traffic would still go through the old TCP one and we run like",
    "start": "1283740",
    "end": "1291150"
  },
  {
    "text": "this for like a whole day I believe just to be on the safe side and then once we",
    "start": "1291150",
    "end": "1297120"
  },
  {
    "text": "felt confident we updated once more the DNS just a big configuration so that all",
    "start": "1297120",
    "end": "1302670"
  },
  {
    "text": "the traffic will now resolve to the new HTTP load balancer so at this point note",
    "start": "1302670",
    "end": "1309990"
  },
  {
    "text": "that we still don't have any traffic going twedge what I just described was kind of",
    "start": "1309990",
    "end": "1315390"
  },
  {
    "text": "a preparatory step in that direction so let's see what we did next",
    "start": "1315390",
    "end": "1321050"
  },
  {
    "start": "1321000",
    "end": "1474000"
  },
  {
    "text": "so first off we added a new back-end for edge behind the HTTP load balancer and",
    "start": "1321050",
    "end": "1329430"
  },
  {
    "text": "so at this point we had to pay backends behind them we had one for the old web",
    "start": "1329430",
    "end": "1335100"
  },
  {
    "text": "gateway the web Alby and a new one for edge but no traffic was sent to edge",
    "start": "1335100",
    "end": "1340620"
  },
  {
    "text": "just yet however in the HTTP load balancer you can configure a target",
    "start": "1340620",
    "end": "1346410"
  },
  {
    "text": "utilization for each back-end this can be defined either in terms of CPU usage",
    "start": "1346410",
    "end": "1352440"
  },
  {
    "text": "or RPS we informal in our team called this configuration the capacity scaler",
    "start": "1352440",
    "end": "1359000"
  },
  {
    "text": "and basically we effectively used this capacity scaler as a dial that we could",
    "start": "1359000",
    "end": "1365430"
  },
  {
    "text": "use to either turn up or turn down traffic that was going to edge and the",
    "start": "1365430",
    "end": "1373380"
  },
  {
    "text": "capacity scaler also doubled that hour a panic button because we could set the target utilization for the edge back-end",
    "start": "1373380",
    "end": "1379770"
  },
  {
    "text": "to zero and that would route all the traffic to web will be within minutes so",
    "start": "1379770",
    "end": "1386790"
  },
  {
    "text": "to recap the strategy first we stood up a new HTTP load balancer second we",
    "start": "1386790",
    "end": "1393030"
  },
  {
    "text": "gradually resolved all of the web player traffic to this new load balancer and lastly we added an edge back-end to sit",
    "start": "1393030",
    "end": "1401070"
  },
  {
    "text": "behind this new load balancer and use the capacity scaler to gradually ramp up",
    "start": "1401070",
    "end": "1406650"
  },
  {
    "text": "traffic to the new edge back-end initially we routed traffic to edge only",
    "start": "1406650",
    "end": "1411840"
  },
  {
    "text": "during office hours we monitored the performance of edge under load and we",
    "start": "1411840",
    "end": "1417770"
  },
  {
    "text": "tuned their alerts so that they would have sensible thresholds for things like resource usage or latency we also",
    "start": "1417770",
    "end": "1425880"
  },
  {
    "text": "created the Kingdome alert that would probe open dot Paulo Filho comm for low",
    "start": "1425880",
    "end": "1431310"
  },
  {
    "text": "latency and for availability so that in case of issues with the web player we would be notified and page pretty",
    "start": "1431310",
    "end": "1437130"
  },
  {
    "text": "quickly after a few days of this dialing up and down the traffic on edge we felt",
    "start": "1437130",
    "end": "1442650"
  },
  {
    "text": "confident to live here on 24/7 at that point we trusted our alerts to notify us",
    "start": "1442650",
    "end": "1449010"
  },
  {
    "text": "in case of problems and also we had the panic button to get us quickly out of trouble in case we",
    "start": "1449010",
    "end": "1454510"
  },
  {
    "text": "got paged at 2:00 a.m. or something the second stage of emigration also went",
    "start": "1454510",
    "end": "1459780"
  },
  {
    "text": "smoothly we build even more confidence in the new gateway and once more we",
    "start": "1459780",
    "end": "1466420"
  },
  {
    "text": "discover the bug in our ex top service so we fixed that before moving on to the last stage so there was this was all",
    "start": "1466420",
    "end": "1476410"
  },
  {
    "text": "good but we now had another 130 upstreams to migrate to edge so let's",
    "start": "1476410",
    "end": "1482350"
  },
  {
    "text": "see how we tackle those blood we",
    "start": "1482350",
    "end": "1487390"
  },
  {
    "text": "mentioned earlier that the old web gateway had 25 different configuration parameters before just adding them to",
    "start": "1487390",
    "end": "1495040"
  },
  {
    "text": "edge blindly we kind of took a step back and evaluated each config option in the",
    "start": "1495040",
    "end": "1500410"
  },
  {
    "text": "context of a use case if we found that there was no strong use case for a",
    "start": "1500410",
    "end": "1508300"
  },
  {
    "text": "particular configuration option then we just simply dropped it our main",
    "start": "1508300",
    "end": "1514060"
  },
  {
    "text": "objective in this case was to keep the configuration API for edge as simple and",
    "start": "1514060",
    "end": "1519610"
  },
  {
    "text": "streamlined as possible to give you a practical example the old web gateway",
    "start": "1519610",
    "end": "1524860"
  },
  {
    "text": "allowed the exposure of both HTTP and HTTPS endpoints however we decided to",
    "start": "1524860",
    "end": "1530920"
  },
  {
    "text": "drop support for HTTP endpoint in edge as a way to encourage better security",
    "start": "1530920",
    "end": "1536650"
  },
  {
    "text": "practices moving forward also since we had a lot of upstreams to migrate we",
    "start": "1536650",
    "end": "1542890"
  },
  {
    "text": "wrote a Python script that would parse the configuration on the old perimeter",
    "start": "1542890",
    "end": "1549070"
  },
  {
    "text": "and translate it to edge configuration the script covered 75 percent roughly of",
    "start": "1549070",
    "end": "1554800"
  },
  {
    "text": "the upstream for the remaining 25 we relied on manual translation as a",
    "start": "1554800",
    "end": "1560080"
  },
  {
    "text": "process of peer review once the configuration were ready then we were good to go we just simply repeated what",
    "start": "1560080",
    "end": "1568240"
  },
  {
    "text": "we've done for the web player but this time on a bigger scale because we were shifting the traffic to edge for all of",
    "start": "1568240",
    "end": "1574990"
  },
  {
    "text": "the 130 app streams at once you might wonder how it went well vladimir will",
    "start": "1574990",
    "end": "1580810"
  },
  {
    "text": "cover that next a lot of things went well",
    "start": "1580810",
    "end": "1590200"
  },
  {
    "text": "most importantly we didn't cause any global HTTP oldish by doing this",
    "start": "1591860",
    "end": "1597800"
  },
  {
    "text": "the Grado and staggered approach helped tremendously none of us engineers in ATC paced during",
    "start": "1597800",
    "end": "1606020"
  },
  {
    "text": "the night because of any edge problem but the panic button helped a lot we used it at least four times and it",
    "start": "1606020",
    "end": "1612860"
  },
  {
    "text": "helped us yeah we sent agent Jay Jay",
    "start": "1612860",
    "end": "1619640"
  },
  {
    "text": "email just before specify how quick that meant that we encouraged Oh which way",
    "start": "1619640",
    "end": "1624650"
  },
  {
    "text": "teams to expose the high peak services on our new system as much for her quick",
    "start": "1624650",
    "end": "1631610"
  },
  {
    "text": "is deterrence which we were held innovations like the discovery weekly is",
    "start": "1631610",
    "end": "1637010"
  },
  {
    "text": "the thing that was implemented during her quick and the social listening is",
    "start": "1637010",
    "end": "1643430"
  },
  {
    "text": "the thing that allows you to share the play cue with your friends to listen",
    "start": "1643430",
    "end": "1649040"
  },
  {
    "text": "together it's it's also started as a quick so after the how quick we received surprised that it's it was kind of easy",
    "start": "1649040",
    "end": "1656360"
  },
  {
    "text": "to use something to to expose services so using Android turned out to be a good",
    "start": "1656360",
    "end": "1664910"
  },
  {
    "text": "thing for us there were bugs and the sisters but we never blocked there was",
    "start": "1664910",
    "end": "1671180"
  },
  {
    "text": "always a way forward so we didn't have a lot of experience before but the dogs",
    "start": "1671180",
    "end": "1677480"
  },
  {
    "text": "are good and we read the source and how team members committed the poor requests",
    "start": "1677480",
    "end": "1682610"
  },
  {
    "text": "and pushed what is more important than",
    "start": "1682610",
    "end": "1688280"
  },
  {
    "text": "successes failures obviously we had few",
    "start": "1688280",
    "end": "1693560"
  },
  {
    "start": "1691000",
    "end": "1751000"
  },
  {
    "text": "bugs and missed a few things the zero downtime promise was not fulfilled completely examples would be our better",
    "start": "1693560",
    "end": "1700580"
  },
  {
    "text": "script missed a few as edge cases and few services were overexposed the pin",
    "start": "1700580",
    "end": "1706610"
  },
  {
    "text": "that for a few days we were it so instead of returning in four threes from the perimeter for some parts we let the",
    "start": "1706610",
    "end": "1716020"
  },
  {
    "text": "don't stream back up stream back and handle it nothing bad happened through and it was",
    "start": "1716020",
    "end": "1723460"
  },
  {
    "text": "later caught by a scanner and humans I guess the the example would be to be mr.",
    "start": "1723460",
    "end": "1732040"
  },
  {
    "text": "protocol somebody in the old gateway was easy WebSockets but it was like completely not clear",
    "start": "1732040",
    "end": "1738820"
  },
  {
    "text": "from the reason the configuration and our first session didn't support no",
    "start": "1738820",
    "end": "1743830"
  },
  {
    "text": "seconds at all so I had to use the panic button to quickly shift everybody back",
    "start": "1743830",
    "end": "1750840"
  },
  {
    "text": "our old service was overloaded and we",
    "start": "1751530",
    "end": "1757630"
  },
  {
    "text": "expect that Google to handle it for us by sheets in traffic back out of but",
    "start": "1757630",
    "end": "1765700"
  },
  {
    "text": "that didn't happen for some reason and we dig into it and turns out that we",
    "start": "1765700",
    "end": "1771880"
  },
  {
    "text": "configured our envoi to return 403 forbidden in case of any and 403",
    "start": "1771880",
    "end": "1782920"
  },
  {
    "text": "forbidden is not is acquainted and Google was not expecting to ship traffic",
    "start": "1782920",
    "end": "1788560"
  },
  {
    "text": "in this case so I guess the takeaway here is that you need to understand how",
    "start": "1788560",
    "end": "1795580"
  },
  {
    "text": "the system behaves in case of the company's failures also if we had the proper health check first so that kind",
    "start": "1795580",
    "end": "1805660"
  },
  {
    "text": "of resulted in us returning for a phrase forbidden for 10% of this be traffic for",
    "start": "1805660",
    "end": "1810750"
  },
  {
    "text": "30 minutes until we stopped the load test so there is a software in trippy it",
    "start": "1810750",
    "end": "1819910"
  },
  {
    "start": "1816000",
    "end": "1870000"
  },
  {
    "text": "doesn't makes things easier and the whole system had lots of entropy there were sites that were exposed the people",
    "start": "1819910",
    "end": "1828460"
  },
  {
    "text": "not used and there were like 30 of them I'm pretty surprised at the number of sizes so well also there was officials",
    "start": "1828460",
    "end": "1838120"
  },
  {
    "text": "that were used by tiny fraction of websites and also for example officials",
    "start": "1838120",
    "end": "1844960"
  },
  {
    "text": "like WebSockets were used but they will not explicit advertised that they're being used so I",
    "start": "1844960",
    "end": "1851510"
  },
  {
    "text": "guess the takeaway here is to design for food entropy design against the unused",
    "start": "1851510",
    "end": "1859550"
  },
  {
    "text": "things like features and websites and design for expressiveness we think big",
    "start": "1859550",
    "end": "1871910"
  },
  {
    "text": "things ahead but short-term fixes and leftovers in the big immigration and in",
    "start": "1871910",
    "end": "1878060"
  },
  {
    "text": "this bill so I guess after that we would",
    "start": "1878060",
    "end": "1887740"
  },
  {
    "text": "invest on supporting more excel that authentication schemes like there are",
    "start": "1887740",
    "end": "1893450"
  },
  {
    "text": "lots of in Spotify we're going to we",
    "start": "1893450",
    "end": "1899150"
  },
  {
    "text": "need the reclamation but our own perimeter part of its already support",
    "start": "1899150",
    "end": "1904340"
  },
  {
    "text": "reclamation and if we want to unify the perimeter we need to we want to also",
    "start": "1904340",
    "end": "1915290"
  },
  {
    "start": "1913000",
    "end": "1941000"
  },
  {
    "text": "invest in automating mitigation against bad depots that means that we have like",
    "start": "1915290",
    "end": "1923390"
  },
  {
    "text": "lots of tests we are also going to have candidates like we have one canary but",
    "start": "1923390",
    "end": "1928550"
  },
  {
    "text": "eventually we would need to shard on perimeter so that we could deploy the changes very great now tomorrow",
    "start": "1928550",
    "end": "1938420"
  },
  {
    "text": "internments our mobile transition is to",
    "start": "1938420",
    "end": "1945950"
  },
  {
    "start": "1941000",
    "end": "1969000"
  },
  {
    "text": "unify perimeter like a dream under one awesome gateway and possibly one",
    "start": "1945950",
    "end": "1951830"
  },
  {
    "text": "protocols are ABC over HTTP 3 we also want beckons our clients to be one big",
    "start": "1951830",
    "end": "1957830"
  },
  {
    "text": "service mesh and just to edge for each to handle all the types of ingress and",
    "start": "1957830",
    "end": "1963260"
  },
  {
    "text": "egress traffic it's all serious as you",
    "start": "1963260",
    "end": "1972380"
  },
  {
    "start": "1969000",
    "end": "1988000"
  },
  {
    "text": "remember it does the authentication and geolocation we want to move the geolocation into a native Android filter",
    "start": "1972380",
    "end": "1978590"
  },
  {
    "text": "so that the Excel series would be",
    "start": "1978590",
    "end": "1983080"
  },
  {
    "text": "much simpler and has less responsibilities we also want developers",
    "start": "1983770",
    "end": "1990640"
  },
  {
    "start": "1988000",
    "end": "2013000"
  },
  {
    "text": "to have the quality of infrastructure so",
    "start": "1990640",
    "end": "1996280"
  },
  {
    "text": "I guess it's a thing now and yeah we wanted so the feature of the parameter",
    "start": "1996280",
    "end": "2003420"
  },
  {
    "text": "hood is bread yeah just before",
    "start": "2003420",
    "end": "2008790"
  },
  {
    "text": "concluding we wanted to share the four key takeaways from all this migration work so the first one would be expect",
    "start": "2008790",
    "end": "2016050"
  },
  {
    "start": "2013000",
    "end": "2053000"
  },
  {
    "text": "things to go wrong sorry I'm president second I expect things to go wrong and",
    "start": "2016050",
    "end": "2021270"
  },
  {
    "text": "be prepared for it most importantly so if you're migrating at scale and adopting a new technology that you're",
    "start": "2021270",
    "end": "2027660"
  },
  {
    "text": "not familiar with as well as our case with envoi most likely you will bump into problems along the way if on top of",
    "start": "2027660",
    "end": "2034650"
  },
  {
    "text": "that the stakes of the migration are high then definitely you want to have a way to roll back to a working state so",
    "start": "2034650",
    "end": "2042480"
  },
  {
    "text": "the takeaway would be invest in a good panic button and also think about how granular should be with a global one be",
    "start": "2042480",
    "end": "2049770"
  },
  {
    "text": "enough for do you need a per service one a second key takeaway would be work",
    "start": "2049770",
    "end": "2056100"
  },
  {
    "start": "2053000",
    "end": "2081000"
  },
  {
    "text": "iteratively start small and possibly non-critical maybe fail quickly learn",
    "start": "2056100",
    "end": "2062398"
  },
  {
    "text": "and adjust and then go progressively bigger and more critical this helps a",
    "start": "2062399",
    "end": "2067800"
  },
  {
    "text": "lot when you are migrating a big number of services over the span of a few months it allows you to quickly learn",
    "start": "2067800",
    "end": "2073950"
  },
  {
    "text": "about the new system you're migrating to and also to uncover bugs while minimizing the impact on users a third",
    "start": "2073950",
    "end": "2081658"
  },
  {
    "start": "2081000",
    "end": "2112000"
  },
  {
    "text": "key takeaway is look for opportunities to reduce the migration surface this is",
    "start": "2081659",
    "end": "2087030"
  },
  {
    "text": "especially relevant if you are migrating away from a legacy system that is been around for some time and has evolved in",
    "start": "2087030",
    "end": "2094950"
  },
  {
    "text": "weird ways over time identifying elements that in this legacy system that",
    "start": "2094950",
    "end": "2100410"
  },
  {
    "text": "are no longer relevant or not used and doing this early rather than late in the",
    "start": "2100410",
    "end": "2106140"
  },
  {
    "text": "migration can really put things into a different perspective",
    "start": "2106140",
    "end": "2111290"
  },
  {
    "text": "and finally when we started all this migration work we thought it was very",
    "start": "2111810",
    "end": "2116850"
  },
  {
    "start": "2112000",
    "end": "2134000"
  },
  {
    "text": "daunting and scary but it turns out that giving yourself room to fail and having",
    "start": "2116850",
    "end": "2124170"
  },
  {
    "text": "a reliable on it button to get you out of trouble makes the whole thing remarkably pain-free and weirdly enough",
    "start": "2124170",
    "end": "2131610"
  },
  {
    "text": "kind of fun all right so this is out thank you very much for taking the time",
    "start": "2131610",
    "end": "2137730"
  },
  {
    "start": "2134000",
    "end": "2152000"
  },
  {
    "text": "to listen to us today we're badly out of time so if you have any questions feel free to approach us and would be happy",
    "start": "2137730",
    "end": "2144960"
  },
  {
    "text": "to chat about this topic or even envoi in general thank you all right [Applause]",
    "start": "2144960",
    "end": "2154550"
  }
]