[
  {
    "text": "[Music]",
    "start": "710",
    "end": "14920"
  },
  {
    "text": "foreign [Music]",
    "start": "14920",
    "end": "27328"
  },
  {
    "text": "all right hello and welcome to cloud native live where we dive into the call behind cloud",
    "start": "33040",
    "end": "39040"
  },
  {
    "text": "native i'm itai shakuri i'm director of open source at apple security i'm also a cloud native ambassador and",
    "start": "39040",
    "end": "46160"
  },
  {
    "text": "will be your host for today um so every week we bring a new set of",
    "start": "46160",
    "end": "52079"
  },
  {
    "text": "presenters to showcase how to work with cloud native technologies they will build things and break things",
    "start": "52079",
    "end": "58239"
  },
  {
    "text": "and answer your questions um join us every wednesday at 11 a.m eastern",
    "start": "58239",
    "end": "63920"
  },
  {
    "text": "this week we have billy click which with us today to talk about uh improving kubernetes experience",
    "start": "63920",
    "end": "70880"
  },
  {
    "text": "sounds very intriguing before we jump into that uh i would like to draw your attention",
    "start": "70880",
    "end": "77920"
  },
  {
    "text": "to a kubecon cloud native con north america that is open for registration",
    "start": "77920",
    "end": "84110"
  },
  {
    "text": "[Music] in person conference and also virtual so very exciting you should see the link",
    "start": "84110",
    "end": "92079"
  },
  {
    "text": "uh popping up right now if you want to take a look and register we really hope to see you",
    "start": "92079",
    "end": "97759"
  },
  {
    "text": "there and also just a quick uh reminder that this is an official live stream of the",
    "start": "97759",
    "end": "103920"
  },
  {
    "text": "cncf and as such is subject to the cncf code of conduct please don't add anything to the chat or",
    "start": "103920",
    "end": "110399"
  },
  {
    "text": "questions that would be in violation of the code of conduct so basically just uh please be respectful of your fellow",
    "start": "110399",
    "end": "117040"
  },
  {
    "text": "participants and presenters so uh billy would you like to introduce",
    "start": "117040",
    "end": "122719"
  },
  {
    "text": "yourself yeah hi my name is uh billy click i'm a staff engineer at digitalocean in the past group but we we",
    "start": "122719",
    "end": "129840"
  },
  {
    "text": "build things like kubernetes or doks marketplace app platform",
    "start": "129840",
    "end": "134879"
  },
  {
    "text": "um uh i'm sure there's some things that i'm forgetting uh and uh dbas is another one that we've",
    "start": "134879",
    "end": "141520"
  },
  {
    "text": "been working on a lot lately and i've been writing go code primarily go codes for since about the end of 2013 shortly",
    "start": "141520",
    "end": "148560"
  },
  {
    "text": "before go 1.2 came out we talked a lot about a lot of go today i'm also the uh",
    "start": "148560",
    "end": "154720"
  },
  {
    "text": "the package main i'm i'm also the maintainer for for vimgo so if you write go and you're using vimgo um you're",
    "start": "154720",
    "end": "161200"
  },
  {
    "text": "probably you're using something that i work on thank you yeah um",
    "start": "161200",
    "end": "167440"
  },
  {
    "text": "great so actually a quite uh intriguing title how can you",
    "start": "167440",
    "end": "174560"
  },
  {
    "text": "offer to improve our kubernetes experience yeah so i'm going to tell you a little story um so when i started digital in",
    "start": "174560",
    "end": "181440"
  },
  {
    "text": "2017 they had started creating a platform on top of kubernetes so",
    "start": "181440",
    "end": "186560"
  },
  {
    "text": "it's been said that kubernetes is a platform upon which to build platforms and that's exactly what what digitalocean had done",
    "start": "186560",
    "end": "192319"
  },
  {
    "text": "the platform is called docc and it provides a a an opinionated platform really",
    "start": "192319",
    "end": "198000"
  },
  {
    "text": "simplifies the kubernetes experience so that um all the kubernetes users don't have to understand all the particulars of all",
    "start": "198000",
    "end": "204000"
  },
  {
    "text": "the yaml and groups versions and kinds they don't have to worry about updates or upgrades or anything like that that's all taken",
    "start": "204000",
    "end": "210080"
  },
  {
    "text": "care of for them um and of course it's opinionated so it'll it's going to do things like it's going to inject environment variables",
    "start": "210080",
    "end": "216560"
  },
  {
    "text": "into people's applications so they have information on what region they're in or what what particular",
    "start": "216560",
    "end": "222159"
  },
  {
    "text": "cluster and we run about 14 clusters these clusters are somewhere",
    "start": "222159",
    "end": "227840"
  },
  {
    "text": "between 15 and 40 nodes typically and they all the nodes have between 24 and 48 cpu",
    "start": "227840",
    "end": "234959"
  },
  {
    "text": "so these are large um shared environments um and so we want to kind of we want to protect",
    "start": "234959",
    "end": "240959"
  },
  {
    "text": "uh those large environments from you know people that might might be doing something that would be dangerous to others right you have to",
    "start": "240959",
    "end": "246480"
  },
  {
    "text": "worry about noisy neighbors and things like that um so there's a lot of protections built into the occ um but the occ oftentimes does not have",
    "start": "246480",
    "end": "254879"
  },
  {
    "text": "um you know it satisfies the 80 case people sometimes need to get outside that box and go to",
    "start": "254879",
    "end": "260320"
  },
  {
    "text": "more of a coupe cuddle experience where they're using kubernetes manifest directly but even in those cases they want to",
    "start": "260320",
    "end": "266160"
  },
  {
    "text": "they they've come to expect certain things to be available in docc and the the team that",
    "start": "266160",
    "end": "271440"
  },
  {
    "text": "maintains the occ needs to be able to change how things work change a lot of implementation details and so",
    "start": "271440",
    "end": "278320"
  },
  {
    "text": "what we found is um using things like mutating emission web hooks and valving and mission web hooks um allows the doc team to make sure that",
    "start": "278320",
    "end": "286160"
  },
  {
    "text": "regardless of how you're creating your applications whether you're using the doc manifest which is json and can take like i've seen it take",
    "start": "286160",
    "end": "293120"
  },
  {
    "text": "like 280 lines of yaml down to about 70 lines of json um it'll so regardless of whether",
    "start": "293120",
    "end": "300000"
  },
  {
    "text": "you're using that or whether you're using kubernetes manifest you still want to have those environment barrels injected you still want to have your syslog sockets",
    "start": "300000",
    "end": "306000"
  },
  {
    "text": "and things hooked up and mutating emission web hooks is how we do that without having to make sure that everybody in the company",
    "start": "306000",
    "end": "311919"
  },
  {
    "text": "understands all how how the nodes are configured and make sure that they don't have to",
    "start": "311919",
    "end": "317039"
  },
  {
    "text": "worry about hooking things up like all those environment variables all right so uh to clarify this for the",
    "start": "317039",
    "end": "323919"
  },
  {
    "text": "audience is the topic of the call uh docc and how it can help them or how",
    "start": "323919",
    "end": "329280"
  },
  {
    "text": "you the dlcc team used admission controllers and web hooks to improve your experience",
    "start": "329280",
    "end": "336080"
  },
  {
    "text": "yeah so it's about how how we use a mission web hooks um so what we you know the mission web",
    "start": "336080",
    "end": "342080"
  },
  {
    "text": "hooks are really the fundamental building block to creating a platform on top of on top",
    "start": "342080",
    "end": "347199"
  },
  {
    "text": "of kubernetes um you can also combine that with custom resources but we're not going to get into customer resources today we're",
    "start": "347199",
    "end": "352560"
  },
  {
    "text": "going to focus just on providing a curated experience to you so if you're maintaining or managing a",
    "start": "352560",
    "end": "357840"
  },
  {
    "text": "cluster for some folks and you want to make sure they have certain features available whether that's mounting volumes automatically or",
    "start": "357840",
    "end": "363759"
  },
  {
    "text": "injecting environment variables into applications that you that you can you know how to do that and start building",
    "start": "363759",
    "end": "369120"
  },
  {
    "text": "that platform got it so maybe let's start by introducing the",
    "start": "369120",
    "end": "374240"
  },
  {
    "text": "concept of admission web books and controllers and see how it goes from",
    "start": "374240",
    "end": "379360"
  },
  {
    "text": "there yeah sounds good so um i'm going to share my screen here um and i believe i'm going to share my",
    "start": "379360",
    "end": "387919"
  },
  {
    "text": "i'll just share uh batch my terminal window for right now um i've stood up a doks cluster in",
    "start": "387919",
    "end": "394639"
  },
  {
    "text": "digital ocean and also created a um uh digital ocean registry and hooked that up to the cluster already",
    "start": "394639",
    "end": "401120"
  },
  {
    "text": "so just real quick let's kind of go can you see my screen okay not yet i'm sure in a second",
    "start": "401120",
    "end": "410160"
  },
  {
    "text": "make sure i select the right one",
    "start": "417759",
    "end": "423840"
  },
  {
    "text": "click the terminal window um",
    "start": "424639",
    "end": "432479"
  },
  {
    "text": "i do not okay now we got it okay great so we have we have here that has a",
    "start": "432479",
    "end": "437759"
  },
  {
    "text": "uh a small cluster that has three nodes um this is running in doks um i'm going",
    "start": "437759",
    "end": "442800"
  },
  {
    "text": "to just show real quick that we have a uh like a deployment",
    "start": "442800",
    "end": "448240"
  },
  {
    "text": "and we just call i just call this one example",
    "start": "448240",
    "end": "452319"
  },
  {
    "text": "and you can see that this deployment is really simple it has a single container that all that container does is prints",
    "start": "454639",
    "end": "461360"
  },
  {
    "text": "out the the date and the hostname every 15 seconds we put a cpu limit in place and a cpu",
    "start": "461360",
    "end": "467840"
  },
  {
    "text": "some cpu requests in place and the reason we put those limits in place is what we're going to do today is walk",
    "start": "467840",
    "end": "473120"
  },
  {
    "text": "through how to build a muting emission web book that will react to",
    "start": "473120",
    "end": "478160"
  },
  {
    "text": "that cpu limit and inject some environment variables based on that all right okay so so right now um",
    "start": "478160",
    "end": "485850"
  },
  {
    "text": "[Music] there are no pods in um in the default",
    "start": "485850",
    "end": "491360"
  },
  {
    "text": "myspace because i've as i've scaled the",
    "start": "491360",
    "end": "497120"
  },
  {
    "text": "application down i'm going to scale it up so we get one pod",
    "start": "497120",
    "end": "507840"
  },
  {
    "text": "and you remember that when we looked at that deployment there were no environment variables there so now if we go look at",
    "start": "512159",
    "end": "519039"
  },
  {
    "text": "um there's one one pod that we that we've created we see that there's a go max go max prox",
    "start": "519039",
    "end": "526320"
  },
  {
    "text": "uh our variable's been injected and the reason we did that as we is is digital which is primarily a ghost",
    "start": "526320",
    "end": "532959"
  },
  {
    "text": "shop so all the things we're going to talk about today we're going to focus just on this one environment variable because it's simple",
    "start": "532959",
    "end": "538320"
  },
  {
    "text": "and can provide um the path forward but it's it's not it's not overly complicated but you can",
    "start": "538320",
    "end": "544480"
  },
  {
    "text": "you can do very complicated things with with mutating mission web books to to provide that platform that you want",
    "start": "544480",
    "end": "551440"
  },
  {
    "text": "in this case we chose go max prox because go by by very nature is is highly concurrent",
    "start": "551440",
    "end": "558320"
  },
  {
    "text": "and built for concurrency and parallelism when we have users running their applications",
    "start": "558320",
    "end": "564480"
  },
  {
    "text": "on these nodes that have 48 processors go automatically wants to spin up 48",
    "start": "564480",
    "end": "570000"
  },
  {
    "text": "threads to manage all the go routines but when you have a cpu limit of 1 that means",
    "start": "570000",
    "end": "575440"
  },
  {
    "text": "you're going to have 48 threads but you only have one cpu so you can't really take advantage of all the things you'd want to take advantage of for",
    "start": "575440",
    "end": "581040"
  },
  {
    "text": "parallelism so you want in instead of thrashing between all those threads we want to",
    "start": "581040",
    "end": "587040"
  },
  {
    "text": "make sure that the level parallelism is the same as or reasonable according to what the",
    "start": "587040",
    "end": "594240"
  },
  {
    "text": "the user set the cpu limit to and so that happened through a mutating emission web",
    "start": "594240",
    "end": "601279"
  },
  {
    "text": "so to set this up um there's a couple of things that things that we need to do um first thing is you",
    "start": "601279",
    "end": "608480"
  },
  {
    "text": "have to create a uh a",
    "start": "608480",
    "end": "612640"
  },
  {
    "text": "mutating webhook configuration um so let's go take a look and see what that looks like",
    "start": "613760",
    "end": "619839"
  },
  {
    "text": "so the prepaid webhook configuration is very is pretty straightforward it",
    "start": "626079",
    "end": "632240"
  },
  {
    "text": "really consists of of a web hooks property that contains an array of admission review versions",
    "start": "632240",
    "end": "639519"
  },
  {
    "text": "and that emission review version uh contains a client config which has a",
    "start": "639519",
    "end": "644720"
  },
  {
    "text": "ca bundle so this is going to be the certificate that that the kubernetes control plane will trust so",
    "start": "644720",
    "end": "652160"
  },
  {
    "text": "that all the um all the kubernetes web hooks have to have uh",
    "start": "652160",
    "end": "660320"
  },
  {
    "text": "have to be secure with ssl or tls so um it's https only and so in order",
    "start": "660320",
    "end": "666640"
  },
  {
    "text": "for the control plane to be able to trust the uh what it's what it's talking to you put the ca",
    "start": "666640",
    "end": "672079"
  },
  {
    "text": "bundle in the meeting or in the mutating web hook configuration you also provide the url for this",
    "start": "672079",
    "end": "679120"
  },
  {
    "text": "particular web hook a failure policy which can be either failed or ignored",
    "start": "679120",
    "end": "684480"
  },
  {
    "text": "a match a match policy a name for the uh sorry about that uh",
    "start": "684480",
    "end": "692959"
  },
  {
    "text": "and a name for the particular um review version which in this case is",
    "start": "692959",
    "end": "699680"
  },
  {
    "text": "going to be uh we'll go up to this yeah we're gonna do object ignorable go match procs",
    "start": "699680",
    "end": "705519"
  },
  {
    "text": "um then a selector which says what things what resources this should apply to um and within the cluster and then of",
    "start": "705519",
    "end": "713360"
  },
  {
    "text": "course the kinds of resources and the operations on those resources that this should apply to um",
    "start": "713360",
    "end": "720160"
  },
  {
    "text": "and then maybe we can describe in a second the high level flow",
    "start": "720160",
    "end": "726000"
  },
  {
    "text": "of things so that people can visualize it in their mind so any and",
    "start": "726000",
    "end": "731440"
  },
  {
    "text": "someone creates a resource let's say pod api server handles this request",
    "start": "731440",
    "end": "738880"
  },
  {
    "text": "and because we register this web book then we tell basically",
    "start": "738880",
    "end": "745440"
  },
  {
    "text": "kubernetes whenever something like this happened that matches this criteria please call out to my um web book",
    "start": "745440",
    "end": "752480"
  },
  {
    "text": "handler my my web server that i stood up in advance right and this is where for example the uh",
    "start": "752480",
    "end": "760320"
  },
  {
    "text": "the ca bundle comes in because how would kubernetes know that uh it can trust that server and this is",
    "start": "760320",
    "end": "767120"
  },
  {
    "text": "the criteria and so on right just wanted to summarize the high level flow for the viewers yeah that that's exactly",
    "start": "767120",
    "end": "773920"
  },
  {
    "text": "right that so the the con what this mutating webhook configuration is doing is is",
    "start": "773920",
    "end": "779200"
  },
  {
    "text": "providing a configuration so that the so the kubernetes control plane coupe controller",
    "start": "779200",
    "end": "784399"
  },
  {
    "text": "can knows what to call knows when to call it and knows what whether or not it could be trusted a a",
    "start": "784399",
    "end": "792320"
  },
  {
    "text": "a web hook can be either a validating web hook or mutating web hook validating web hooks can be used to make",
    "start": "792320",
    "end": "798880"
  },
  {
    "text": "sure that someone has the right permissions to modify a certain field or that they don't use certain fields so like in",
    "start": "798880",
    "end": "803920"
  },
  {
    "text": "earlier i talked about docc docc for instance because it's a large multi-tenant environment makes sure that",
    "start": "803920",
    "end": "810560"
  },
  {
    "text": "people can't use host network it does things like make sure that people can't spin up privileged pods right because",
    "start": "810560",
    "end": "816639"
  },
  {
    "text": "because we don't want all those users getting access to the underlying nodes we also",
    "start": "816639",
    "end": "823040"
  },
  {
    "text": "put restrictions on what volumes they come out if someone is using kubernetes directly but um so yeah that",
    "start": "823040",
    "end": "830720"
  },
  {
    "text": "this this is all just uh explaining to to the control plane exactly how to",
    "start": "830720",
    "end": "836160"
  },
  {
    "text": "connect when to when when to use the web hook and what things it should apply to great um by the way could you make the",
    "start": "836160",
    "end": "844000"
  },
  {
    "text": "font a little bit bigger please bigger absolutely how's that that's good thanks okay all right so",
    "start": "844000",
    "end": "852000"
  },
  {
    "text": "so that that's that's the mutating mutating web hook um in this case we are we are running",
    "start": "852000",
    "end": "857920"
  },
  {
    "text": "the uh the the web hook in the cluster itself um and because because we're running it",
    "start": "857920",
    "end": "864320"
  },
  {
    "text": "in the cluster we also want to make sure that um if the web hook is down for some reason",
    "start": "864320",
    "end": "871040"
  },
  {
    "text": "um or if uh or you know certain critical things that might need to be",
    "start": "871040",
    "end": "876160"
  },
  {
    "text": "executed executing the cluster like like your your cni if you're running that in your in your",
    "start": "876160",
    "end": "881440"
  },
  {
    "text": "cluster that it's the the lack of the uh instance",
    "start": "881440",
    "end": "886560"
  },
  {
    "text": "if the instance is down if you spam a new cluster or if you're doing an update or something while someone else is is trying to make",
    "start": "886560",
    "end": "892800"
  },
  {
    "text": "changes to cni that we don't get into a circular dependency problems so",
    "start": "892800",
    "end": "898000"
  },
  {
    "text": "we make these uh these match policies a little bit more complicated what they would need to be",
    "start": "898000",
    "end": "904240"
  },
  {
    "text": "in this case the the base admission policy is this last one here which is just",
    "start": "904240",
    "end": "910320"
  },
  {
    "text": "go max prox c l web hook configuration um then we had we had two others",
    "start": "910320",
    "end": "917680"
  },
  {
    "text": "they're really functions escape hatches the first one is na is ns ignorable go max prox",
    "start": "917680",
    "end": "924800"
  },
  {
    "text": "with that name and what it does is make sure that hey if if a label uh c l webhook allow webhook failure and",
    "start": "924800",
    "end": "930639"
  },
  {
    "text": "this is customizable exists on the namespace and it doesn't exist on the object",
    "start": "930639",
    "end": "936480"
  },
  {
    "text": "uh then we're gonna use a policy of ignore so that if the web hook fails it's okay it that the the uh the",
    "start": "936480",
    "end": "943839"
  },
  {
    "text": "pod can still be created and then we do something similar with the with the object ignorable where we say hey if",
    "start": "943839",
    "end": "950320"
  },
  {
    "text": "the namespace selector doesn't exist but the the object label does then that's that's",
    "start": "950320",
    "end": "956639"
  },
  {
    "text": "okay we're also going to ignore in that case so all those critical components that we run in the clusters",
    "start": "956639",
    "end": "962480"
  },
  {
    "text": "we make sure they actually have all the things that are necessary that the mutating mission web hooks",
    "start": "962480",
    "end": "968560"
  },
  {
    "text": "don't aren't going to have to operate on them",
    "start": "968560",
    "end": "972399"
  },
  {
    "text": "so that's that's the uh that's the configuration um real quick i'd like to show the",
    "start": "973600",
    "end": "980720"
  },
  {
    "text": "deployment itself that we're running here",
    "start": "980720",
    "end": "996880"
  },
  {
    "text": "this also is it's a very simple um web hook um it's a very",
    "start": "996880",
    "end": "1003279"
  },
  {
    "text": "very simple container i have a cnl web hook uh container that's hosted in the uh the",
    "start": "1003279",
    "end": "1009519"
  },
  {
    "text": "docr registry or exposing port 443 um and i've mounted in a certificate in this",
    "start": "1009519",
    "end": "1016320"
  },
  {
    "text": "case i just use a self-signed certificate there's obviously if you're going to do this in production you want to do something",
    "start": "1016320",
    "end": "1021600"
  },
  {
    "text": "probably more robust than that and so this this runs in the",
    "start": "1021600",
    "end": "1028959"
  },
  {
    "text": "coordinate space and i also um have this this deployment has",
    "start": "1028959",
    "end": "1037438"
  },
  {
    "text": "the uh all the pods has that label we talked about before to allow it to be ignored so that",
    "start": "1037439",
    "end": "1043038"
  },
  {
    "text": "if the web hook isn't running that's the web hook pods can still be created yeah so um",
    "start": "1043039",
    "end": "1051760"
  },
  {
    "text": "i i mean people are now exposed to the concept of uh validating webhook mutating workbook",
    "start": "1051760",
    "end": "1058720"
  },
  {
    "text": "and you've shown a few examples or how you are using it um i guess with jesus or",
    "start": "1058720",
    "end": "1065200"
  },
  {
    "text": "ocean is this like do you have any uh recommendations for or ideas more what people uh",
    "start": "1065200",
    "end": "1072799"
  },
  {
    "text": "could or should uh um look after with those tools like what",
    "start": "1072799",
    "end": "1080160"
  },
  {
    "text": "what uh what possibilities uh what are the possibilities for people to",
    "start": "1080160",
    "end": "1087120"
  },
  {
    "text": "enforce or to change yeah so if you're doing mutating your mission web hook um you know one of like some of the",
    "start": "1087120",
    "end": "1093679"
  },
  {
    "text": "things that we do in docc they're they're very useful is hooking up the syslog socket for people um",
    "start": "1093679",
    "end": "1099039"
  },
  {
    "text": "we and we because we have a most of our services um in order to get logging to central",
    "start": "1099039",
    "end": "1104880"
  },
  {
    "text": "centralized logging uh are going to be using syslog um and so we go ahead and hook that syslog up",
    "start": "1104880",
    "end": "1110559"
  },
  {
    "text": "into all the pods for people automatically we also do things um like uh inject environment variables to",
    "start": "1110559",
    "end": "1117600"
  },
  {
    "text": "the left hill know what which applications know which cluster they're running in which region they're in",
    "start": "1117600",
    "end": "1122880"
  },
  {
    "text": "what their service domain name space is um or sorry what their service domain is",
    "start": "1122880",
    "end": "1130080"
  },
  {
    "text": "um and and the cluster the cluster name itself and that all feeds into centralized logging so we can identify",
    "start": "1130080",
    "end": "1137039"
  },
  {
    "text": "um where something actually is and you know we have 14 large clusters uh if you have",
    "start": "1137039",
    "end": "1143919"
  },
  {
    "text": "your application deployed into five of those seeing errors in the logs you need to know exactly which one it's coming from",
    "start": "1143919",
    "end": "1150480"
  },
  {
    "text": "so we we inject all of that we also do things like inject the the",
    "start": "1150480",
    "end": "1157200"
  },
  {
    "text": "root ca certificate so that we can establish trust",
    "start": "1157200",
    "end": "1162960"
  },
  {
    "text": "with all the other services that that are running in in the in the clusters so so the people don't have to worry",
    "start": "1162960",
    "end": "1168480"
  },
  {
    "text": "about including all those things in their containers or on their applications that just gets hooked up automatically for them",
    "start": "1168480",
    "end": "1174480"
  },
  {
    "text": "yeah it makes complete sense actually and it's also maybe",
    "start": "1174480",
    "end": "1179840"
  },
  {
    "text": "expressing a a well-known um debate or idea of the separation between",
    "start": "1179919",
    "end": "1189280"
  },
  {
    "text": "the developers role and the operations people role when it comes to kubernetes",
    "start": "1189280",
    "end": "1194720"
  },
  {
    "text": "which is kind of in the middle so the developer you know is mostly concerned with writing their code and",
    "start": "1194720",
    "end": "1200480"
  },
  {
    "text": "making sure the application is functional uh where does the line go like do we ask",
    "start": "1200480",
    "end": "1205919"
  },
  {
    "text": "them to also know about kubernetes primitives to the partner up and if they do",
    "start": "1205919",
    "end": "1211840"
  },
  {
    "text": "um how far should their uh knowledge or familiarity with the platform go and",
    "start": "1211840",
    "end": "1218400"
  },
  {
    "text": "in this couple of examples did you just shared i think we see a nice idea of",
    "start": "1218400",
    "end": "1226640"
  },
  {
    "text": "letting the developer deploy their applications using kubernetes",
    "start": "1226640",
    "end": "1232799"
  },
  {
    "text": "primitive but kind of a simplified version of it where you say don't worry about it i will fix up",
    "start": "1232799",
    "end": "1239840"
  },
  {
    "text": "whatever i need meaning the operation people uh in order for that to work in the bigger",
    "start": "1239840",
    "end": "1245840"
  },
  {
    "text": "context that's right yeah this this is all about making sure or trying to make sure that",
    "start": "1245840",
    "end": "1251679"
  },
  {
    "text": "that application developers can focus on delivering that business value and they don't have to worry about all those",
    "start": "1251679",
    "end": "1257360"
  },
  {
    "text": "operations and particulars about how to how to configure their applications or operate their applications in these large",
    "start": "1257360",
    "end": "1263760"
  },
  {
    "text": "multi-tenant environments and especially as as uh organization grows and gets more",
    "start": "1263760",
    "end": "1268799"
  },
  {
    "text": "complicated you want people to be able to specialize and you want application developers to really be able to focus on",
    "start": "1268799",
    "end": "1274480"
  },
  {
    "text": "developing code and delivering business value and operations folks to be able to just focus on operations",
    "start": "1274480",
    "end": "1279840"
  },
  {
    "text": "and these mutant web hooks can help bridge that gap and to reduce",
    "start": "1279840",
    "end": "1285120"
  },
  {
    "text": "that tribal knowledge it also frees up operations and administrators to make changes to how the clusters are",
    "start": "1285120",
    "end": "1290159"
  },
  {
    "text": "configured right if if i if we decide you know we for whatever reason we want to put the syslog socket into a different place or",
    "start": "1290159",
    "end": "1296720"
  },
  {
    "text": "we want to start introducing new environment variables um to to explain or to allow applications",
    "start": "1296720",
    "end": "1303840"
  },
  {
    "text": "to to understand more context about where they are or what else might be near them then mutating english and web books can",
    "start": "1303840",
    "end": "1309760"
  },
  {
    "text": "can help with that and you can just introduce new mutant mission web books and let people know hey when you redeploy you're going",
    "start": "1309760",
    "end": "1315120"
  },
  {
    "text": "to have these these new things yep so if if it's okay i'd like to start",
    "start": "1315120",
    "end": "1321039"
  },
  {
    "text": "going into exactly how we build one of these mutating emission web hooks and start going to controller runtime",
    "start": "1321039",
    "end": "1327360"
  },
  {
    "text": "and so i'm going to i'm going to start out very simply we're going to start at high level and go through um",
    "start": "1327360",
    "end": "1333120"
  },
  {
    "text": "the main you know just the the high level of how this works um and hopefully by the end we'll be",
    "start": "1333120",
    "end": "1339600"
  },
  {
    "text": "able to talk about testing a little bit um because control runtime has some great testing features um",
    "start": "1339600",
    "end": "1346000"
  },
  {
    "text": "we'll back up just just just for a minute um kubernetes uh if you've written",
    "start": "1346000",
    "end": "1351280"
  },
  {
    "text": "kubernetes code you're probably familiar with with controllers um controllers are going to",
    "start": "1351280",
    "end": "1357039"
  },
  {
    "text": "work with informers or watch or watchers controller runtime takes informers and",
    "start": "1357039",
    "end": "1363260"
  },
  {
    "text": "[Music] watchers and and those concepts and reconciliation concepts and",
    "start": "1363260",
    "end": "1369440"
  },
  {
    "text": "abstracts a little bit further so they're even easier to work with controller runtime also provides the",
    "start": "1369440",
    "end": "1374559"
  },
  {
    "text": "framework for for working with web hooks more easily so you know kubernetes itself doesn't prescribe",
    "start": "1374559",
    "end": "1380400"
  },
  {
    "text": "what a web hook has to be implemented in it just says it needs to be https you could implement your",
    "start": "1380400",
    "end": "1385919"
  },
  {
    "text": "web hooks and ruby if you want to you can you can put your web hooks in and go or rust or whatever feels most",
    "start": "1385919",
    "end": "1392000"
  },
  {
    "text": "comfortable to you but controller run time is targeted go and makes it very easy to start creating",
    "start": "1392000",
    "end": "1399440"
  },
  {
    "text": "web hooks so what we have here is we have a very simple um application that is is our web hook server and",
    "start": "1399440",
    "end": "1407520"
  },
  {
    "text": "the main function just calls real main so we give back an error um it's a common pattern it's just it does",
    "start": "1407520",
    "end": "1412640"
  },
  {
    "text": "really three simple things it creates a creates the configuration um passes that",
    "start": "1412640",
    "end": "1418480"
  },
  {
    "text": "configuration off to the controller in this case controller is not like a reconciler",
    "start": "1418480",
    "end": "1423520"
  },
  {
    "text": "it's just um uh it's just it's a control in the sense that it's gonna run it's going to it's",
    "start": "1423520",
    "end": "1429520"
  },
  {
    "text": "going to have some lifetime you could think of this as anything that's runnable um this this code is borrowed from",
    "start": "1429520",
    "end": "1436159"
  },
  {
    "text": "some of the things we have a digital ocean that i've paired down a lot so this is kind of set up so you can build",
    "start": "1436159",
    "end": "1441760"
  },
  {
    "text": "out from it and start making much more complicated introducing more more more than just this one",
    "start": "1441760",
    "end": "1447039"
  },
  {
    "text": "web hook you start introducing reconcilers and things like that if you wanted to start dealing with um reconciling resources in your in your",
    "start": "1447039",
    "end": "1454480"
  },
  {
    "text": "cluster so so after we create config we create the controller and we want to we want to hook up uh",
    "start": "1454480",
    "end": "1461360"
  },
  {
    "text": "contacts handling so that when when the when the pod needs to be terminated by",
    "start": "1461360",
    "end": "1466559"
  },
  {
    "text": "kubernetes it will handle the termination signal and ship the controller down quickly so it doesn't have to be killed",
    "start": "1466559",
    "end": "1473360"
  },
  {
    "text": "and then we run the controller so all all pretty all pretty straightforward",
    "start": "1473360",
    "end": "1478640"
  },
  {
    "text": "um i'm going to go over here into new config because it has some it sets up flags and",
    "start": "1478640",
    "end": "1486000"
  },
  {
    "text": "some things we don't need to worry about too much today but one of the important things it does here um is it has to create a",
    "start": "1486000",
    "end": "1494000"
  },
  {
    "text": "a manager and this is this is one of the key things in in controller runtime it's this concept",
    "start": "1494000",
    "end": "1500240"
  },
  {
    "text": "of a manager a manager uh provides the scheme um a cert directory report a number of",
    "start": "1500240",
    "end": "1506960"
  },
  {
    "text": "other options that you can add um if you're if you're gonna be dealing with uh resources so if you're doing",
    "start": "1506960",
    "end": "1512799"
  },
  {
    "text": "something this uh that is mutating a custom resource or even some core resources",
    "start": "1512799",
    "end": "1519120"
  },
  {
    "text": "you you need to add the scheme um to to your options and you do that by just",
    "start": "1519120",
    "end": "1524400"
  },
  {
    "text": "doing runtime.new scheme adding that to scheme uh and passing",
    "start": "1524400",
    "end": "1529679"
  },
  {
    "text": "passing everything off to to the manager and that's a critical piece for uh for a controller runtime",
    "start": "1529679",
    "end": "1537840"
  },
  {
    "text": "manager after after we create the config then we need to go create the uh the",
    "start": "1537840",
    "end": "1544799"
  },
  {
    "text": "controller itself again this is this is really straightforward pretty simple we have a base rail that we that we need to",
    "start": "1544799",
    "end": "1550960"
  },
  {
    "text": "configure we have a number of options that we got from new config and we and it creates the controller",
    "start": "1550960",
    "end": "1558480"
  },
  {
    "text": "or just it's just uh in this case it's just a thing that has a run method you might remember from",
    "start": "1558480",
    "end": "1565039"
  },
  {
    "text": "over here on main that when we're done uh after hooking up the context uh",
    "start": "1565039",
    "end": "1570720"
  },
  {
    "text": "we recall when we're done hooking up the signal handling we call run on the controller",
    "start": "1570720",
    "end": "1577840"
  },
  {
    "text": "and this is this is where the meat of things happens so we set the logger on controller runtime",
    "start": "1578400",
    "end": "1583679"
  },
  {
    "text": "so that both our application and the uh the controller runtime manager",
    "start": "1583679",
    "end": "1590000"
  },
  {
    "text": "will be using the same log so everything will get to the same log sync so they're gonna we're",
    "start": "1590000",
    "end": "1595840"
  },
  {
    "text": "then going to register some web hooks we're going to register the webhook configuration and this might be",
    "start": "1595840",
    "end": "1601679"
  },
  {
    "text": "controversial i know that a lot of people like to work with straight yaml and so that mutating",
    "start": "1601679",
    "end": "1607520"
  },
  {
    "text": "webhook configuration we saw earlier is actually being created in this case by our our process so i i personally",
    "start": "1607520",
    "end": "1615120"
  },
  {
    "text": "don't like to work with i don't like to have my yaml separated far away from my code",
    "start": "1615120",
    "end": "1620559"
  },
  {
    "text": "and i want to be more dynamic so that if i deploy a new version of our controller",
    "start": "1620559",
    "end": "1627360"
  },
  {
    "text": "that the mutang web hook configuration also gets updated so it's all there so they're tightly coupled because they are",
    "start": "1627360",
    "end": "1634159"
  },
  {
    "text": "tightly coupled um that allows us to move a little faster it gives us",
    "start": "1634159",
    "end": "1641440"
  },
  {
    "text": "locality of reference um and it makes it a little bit more testable as well so we create the we register the webhook",
    "start": "1641440",
    "end": "1648159"
  },
  {
    "text": "configuration we'll go to that here in just just a minute um have we have a set of handlers and",
    "start": "1648159",
    "end": "1654880"
  },
  {
    "text": "these handlers in this case it's just going to be a bunch of a bunch of runnables in this case one of them is going to be the manager",
    "start": "1654880",
    "end": "1662159"
  },
  {
    "text": "we run all those in the go routine and wait for it wait for them to return and uh and then once we're done we",
    "start": "1662159",
    "end": "1669440"
  },
  {
    "text": "return back out of our run function the main exits and the pod is done so",
    "start": "1669440",
    "end": "1676320"
  },
  {
    "text": "so i just want to clarify what you said um like a moment ago about the yaml being",
    "start": "1676320",
    "end": "1683160"
  },
  {
    "text": "[Music] coupled with the code does that mean that when it when i want to deploy this admission",
    "start": "1683160",
    "end": "1690480"
  },
  {
    "text": "webhook instead of deploying the code and registering it i would just deploy the",
    "start": "1690480",
    "end": "1696880"
  },
  {
    "text": "pod and it would register itself that's exactly right yeah so um you you",
    "start": "1696880",
    "end": "1703200"
  },
  {
    "text": "certainly could um have your manager yaml separately um from from the code that you're deploying",
    "start": "1703200",
    "end": "1709039"
  },
  {
    "text": "but then the problem of course is that then you need to go deploy your code and then you have to go up you know you deploy your app your update and then you have",
    "start": "1709039",
    "end": "1715200"
  },
  {
    "text": "to go update the gamble or you and so there's this time period where something uh there could be an",
    "start": "1715200",
    "end": "1720799"
  },
  {
    "text": "impedance mismatch between what's actually running and what the configuration is of course if you do the opposite order you have you have the exact same problem",
    "start": "1720799",
    "end": "1727039"
  },
  {
    "text": "so by putting it into code we can be assured that like when when we start running we update the",
    "start": "1727039",
    "end": "1732720"
  },
  {
    "text": "configuration right away and immediately the handler kicks off great thanks for the explanation yeah",
    "start": "1732720",
    "end": "1740000"
  },
  {
    "text": "um so again and run we're right to the web hooks and what we're doing is we're going to",
    "start": "1740000",
    "end": "1745600"
  },
  {
    "text": "be registering with the manager we're going to register the web configuration um we're going to for that",
    "start": "1745600",
    "end": "1750640"
  },
  {
    "text": "we're actually going to register it with uh the kubernetes control plane uh we register the handlers and so let's",
    "start": "1750640",
    "end": "1758159"
  },
  {
    "text": "let's dig into what registering which registering to web hooks actually looks like um so this is again",
    "start": "1758159",
    "end": "1766720"
  },
  {
    "text": "a pretty simple method um we have a uh we get the url for our for our for",
    "start": "1766720",
    "end": "1772480"
  },
  {
    "text": "this one particular um web hook remember our mutating webhook configuration can can describe",
    "start": "1772480",
    "end": "1778640"
  },
  {
    "text": "multiple hooks so in this case we're just doing the go max prox web hook then we",
    "start": "1778640",
    "end": "1786559"
  },
  {
    "text": "we write we register that with uh with the hook server which is oh sorry about that",
    "start": "1786559",
    "end": "1794880"
  },
  {
    "text": "you mention that with uh with the manager so we we grab the webhook server from the manager and that this is",
    "start": "1794880",
    "end": "1801279"
  },
  {
    "text": "that controller runtime manager type register it now all we do is we just",
    "start": "1801279",
    "end": "1806720"
  },
  {
    "text": "give it an emission type and the an emission is an interface",
    "start": "1806720",
    "end": "1812880"
  },
  {
    "text": "that has a handler method and that's kind of it and so in this case if we take a look at",
    "start": "1812880",
    "end": "1821840"
  },
  {
    "text": "a registered server obviously it just takes an http handler which if you're familiar with those it has",
    "start": "1821840",
    "end": "1828640"
  },
  {
    "text": "it's a simple function that has a response and a request an http response an http request so",
    "start": "1828640",
    "end": "1835679"
  },
  {
    "text": "that's that's all you pass off to register this admission type has has a handler and it",
    "start": "1835679",
    "end": "1842480"
  },
  {
    "text": "is a handler interface which just has a single handle",
    "start": "1842480",
    "end": "1848080"
  },
  {
    "text": "method um and in this case uh we are going to create a",
    "start": "1848080",
    "end": "1856640"
  },
  {
    "text": "mutate pod strategy handler so remember this is really part of a larger piece of",
    "start": "1857919",
    "end": "1863120"
  },
  {
    "text": "code so you wouldn't have to have a strategy you could just have a single handler that will take care of what the strategy",
    "start": "1863120",
    "end": "1869440"
  },
  {
    "text": "does here but we'll take a look at the strategy you can see again it's really pretty pretty straightforward",
    "start": "1869440",
    "end": "1875440"
  },
  {
    "text": "we hook up a logger and a uh and a mutate function in this case the mutate function is",
    "start": "1875440",
    "end": "1880880"
  },
  {
    "text": "gonna be modifying our our gomax procs in the handle method there's a couple of things you need to do",
    "start": "1880880",
    "end": "1887279"
  },
  {
    "text": "you need to decode your pod because that comes in on the web hook admission request and",
    "start": "1887279",
    "end": "1894320"
  },
  {
    "text": "then in our case we're going we're going to mutate it we'll be modifying the uh the pod in some way potentially then we",
    "start": "1894320",
    "end": "1901600"
  },
  {
    "text": "marshal the result of that process and then provide a patch response so",
    "start": "1901600",
    "end": "1907600"
  },
  {
    "text": "when we what what what this does is this tells the control plane hey you gave me this raw thing",
    "start": "1907600",
    "end": "1913600"
  },
  {
    "text": "originally that which is json i'm going to give you",
    "start": "1913600",
    "end": "1919679"
  },
  {
    "text": "a json response back to that and what the control plane will do is look at those the differences between",
    "start": "1919679",
    "end": "1927200"
  },
  {
    "text": "those two things um and well actually sorry like the patch response from raw gives",
    "start": "1927200",
    "end": "1934480"
  },
  {
    "text": "compares uh the raw and the marshall figures out exactly how to construct a patch that kubernetes",
    "start": "1934480",
    "end": "1940720"
  },
  {
    "text": "understands and passes that back in the response for kubernetes when you take the plot itself so",
    "start": "1940720",
    "end": "1945840"
  },
  {
    "text": "so we're not these these web hooks don't don't mutate the pods themselves it",
    "start": "1945840",
    "end": "1952240"
  },
  {
    "text": "tells kubernetes how to mutate it and then once once we've done once we've",
    "start": "1952240",
    "end": "1959200"
  },
  {
    "text": "done that we now have our web hook is registered and it's time to com it's time to",
    "start": "1959200",
    "end": "1965120"
  },
  {
    "text": "con update the uh configuration before we go on the configuration you have any questions about",
    "start": "1965120",
    "end": "1970559"
  },
  {
    "text": "how those handlers work do we want to get into looking looking at the actual handler for the go",
    "start": "1970559",
    "end": "1975600"
  },
  {
    "text": "max prox now or should we keep going to uh the configuration first",
    "start": "1975600",
    "end": "1981840"
  },
  {
    "text": "i don't see any questions coming up on chat",
    "start": "1982320",
    "end": "1987200"
  },
  {
    "text": "so yeah we can continue just a quick clarification actually a question of mine uh so we uh in the previous step",
    "start": "1988000",
    "end": "1996399"
  },
  {
    "text": "we uh got the raw uh object into the workbook handler we did",
    "start": "1996399",
    "end": "2002240"
  },
  {
    "text": "something and we returned the attach does the patch go through the same",
    "start": "2002240",
    "end": "2007279"
  },
  {
    "text": "pipeline and again through the admission webhook or is there some kind of",
    "start": "2007279",
    "end": "2012720"
  },
  {
    "text": "exception there uh",
    "start": "2012720",
    "end": "2018000"
  },
  {
    "text": "i'm not sure i understand understand the question so if the uh if the result of this",
    "start": "2018000",
    "end": "2024320"
  },
  {
    "text": "operation is a a uh a patch meaning please kubernetes do something",
    "start": "2024320",
    "end": "2030640"
  },
  {
    "text": "that is another like a an operation against kubernetes api and the webhook is validating or muting",
    "start": "2030640",
    "end": "2038240"
  },
  {
    "text": "that request as well or not yeah so so if if if",
    "start": "2038240",
    "end": "2045279"
  },
  {
    "text": "i i think your question is like if we if we if we modify the pod in some way mutate it does it it didn't",
    "start": "2045279",
    "end": "2050800"
  },
  {
    "text": "get sent back through again because because it's being modified yeah i mean the actual uh request to",
    "start": "2050800",
    "end": "2057760"
  },
  {
    "text": "modify yeah yeah so um when we're we're creating a plot in this case so it's actually part of the mutating",
    "start": "2057760",
    "end": "2065040"
  },
  {
    "text": "webhook configuration about whether or not you you can call multiple times or not so you you can you can you say yes call",
    "start": "2065040",
    "end": "2071520"
  },
  {
    "text": "me at least you can call me up to one more time or don't call me again um and so",
    "start": "2071520",
    "end": "2077118"
  },
  {
    "text": "if you have a if like one of your web hooks these might need to respond to changes",
    "start": "2077119",
    "end": "2082720"
  },
  {
    "text": "that other web hooks might do then you want to make sure that you can call this web book multiple times for a single",
    "start": "2082720",
    "end": "2088480"
  },
  {
    "text": "creation event um if but if you're if you don't care if you just need to do",
    "start": "2088480",
    "end": "2093520"
  },
  {
    "text": "your thing and and move on then you can say yeah don't don't call me again and that's that's part of the web",
    "start": "2093520",
    "end": "2100839"
  },
  {
    "text": "configuration thanks yeah that's a good question",
    "start": "2100839",
    "end": "2106400"
  },
  {
    "text": "so after we create the create and register the the web hook um with the manager then we we want to",
    "start": "2106400",
    "end": "2112320"
  },
  {
    "text": "go ahead and register these web configurations with the control plane um in this case again we're going to need that webhook based url because we have",
    "start": "2112320",
    "end": "2118720"
  },
  {
    "text": "to put that into the mutating webhook configuration",
    "start": "2118720",
    "end": "2124000"
  },
  {
    "text": "so in this case what we've done is we've created a a a set of weapon configurations so what",
    "start": "2124000",
    "end": "2130160"
  },
  {
    "text": "we're going to do is we're going to say hey give me all all the mission web hook configurations and we have a a set of these see if i",
    "start": "2130160",
    "end": "2137680"
  },
  {
    "text": "can find them under there yeah so it's just a string of them um or a slice of strings of them for the",
    "start": "2137680",
    "end": "2145200"
  },
  {
    "text": "ones we can pick want to configure and then we say okay give me give me this the webhook config and what we've",
    "start": "2145200",
    "end": "2151040"
  },
  {
    "text": "done here is we've defined a type in our code that is really just the things that we",
    "start": "2151040",
    "end": "2156880"
  },
  {
    "text": "care about on on a web hook to pay the things are going to vary among our web hooks and that's going to be the path so or we have we have we're",
    "start": "2156880",
    "end": "2163520"
  },
  {
    "text": "going to be running an http server we want to provide a path so we can deal with different",
    "start": "2163520",
    "end": "2169280"
  },
  {
    "text": "different web hooks being served by the same server we're going to describe a failure policy because we might this might be ignored it might be fail",
    "start": "2169280",
    "end": "2176880"
  },
  {
    "text": "we're going to have the reinvocation policy which is what you were just asking about um which is you know how do we how do we",
    "start": "2176880",
    "end": "2184240"
  },
  {
    "text": "deal with this web hook if another web hook changes something",
    "start": "2184240",
    "end": "2189280"
  },
  {
    "text": "on about as well you can look at this documentation that describes",
    "start": "2189280",
    "end": "2194400"
  },
  {
    "text": "what this particular policy type means so again it can be called at least one additional time",
    "start": "2194400",
    "end": "2201440"
  },
  {
    "text": "in this case because we have if needed reinvocation policy",
    "start": "2201440",
    "end": "2206240"
  },
  {
    "text": "and in this case because we're because we're dealing with pods we really don't care about cree i don't care if you",
    "start": "2206960",
    "end": "2212320"
  },
  {
    "text": "if somebody is trying to update a pod or something like that we're modifying the containers and",
    "start": "2212320",
    "end": "2217680"
  },
  {
    "text": "environment variables on it so we don't need to worry about anything other than other than creates",
    "start": "2217680",
    "end": "2223440"
  },
  {
    "text": "um you do need to make sure you set the scope um it's either uh main space or or",
    "start": "2223440",
    "end": "2229119"
  },
  {
    "text": "unnamed space scope because we're dealing with pods they are main spaced",
    "start": "2229119",
    "end": "2234400"
  },
  {
    "text": "so we're gonna go through that set of web configurations we'll grab the url for each of them so",
    "start": "2234400",
    "end": "2239920"
  },
  {
    "text": "we can build it and that's and so what we're doing here is we're grabbing the base url from our",
    "start": "2239920",
    "end": "2245599"
  },
  {
    "text": "controller and just adding the path from the configuration we just looked at",
    "start": "2245599",
    "end": "2250880"
  },
  {
    "text": "onto that and and make sure we resolve the reference up properly in order to set that on to",
    "start": "2250880",
    "end": "2259520"
  },
  {
    "text": "this mutating webhook client config is here we also go ahead and include",
    "start": "2259520",
    "end": "2266400"
  },
  {
    "text": "that search bundle for for the server we apply the rules to the configuration the",
    "start": "2266400",
    "end": "2272560"
  },
  {
    "text": "policy all those things that are uh that we just talked about",
    "start": "2272560",
    "end": "2278079"
  },
  {
    "text": "um and this is our our initial handler now remember we said we want to be able to",
    "start": "2278079",
    "end": "2283280"
  },
  {
    "text": "make sure we respond appropriately if there are uh if they're",
    "start": "2283280",
    "end": "2289040"
  },
  {
    "text": "for for for critical things that need that don't care about the web look that is like it's okay if the web book fails because we have those things fully",
    "start": "2289040",
    "end": "2294800"
  },
  {
    "text": "configured in those cases usually what's happening is like the operators of the cluster are making sure that everything is is",
    "start": "2294800",
    "end": "2300400"
  },
  {
    "text": "configured um for those things correctly because these web hooks are primarily focused on",
    "start": "2300400",
    "end": "2306400"
  },
  {
    "text": "making it easy for promotes users if the failure organization on",
    "start": "2306400",
    "end": "2314079"
  },
  {
    "text": "this uh on this particular web hook is fail then we're going to",
    "start": "2314079",
    "end": "2320800"
  },
  {
    "text": "add a add a couple of selectors first one we're going to make sure the namespace that doesn't have the",
    "start": "2320800",
    "end": "2327760"
  },
  {
    "text": "allow webhook failure table we're also going to make sure the object doesn't have",
    "start": "2327760",
    "end": "2333119"
  },
  {
    "text": "the allow webhook failure and then we're going to add that to mutating webhooks we're also going to",
    "start": "2333119",
    "end": "2339839"
  },
  {
    "text": "pass um in this video we're going to get those additional um web hooks based on this particular hook so we're",
    "start": "2339839",
    "end": "2346400"
  },
  {
    "text": "going to create the normals from rotating webhook and this is in that's in the controller to make to",
    "start": "2346400",
    "end": "2352240"
  },
  {
    "text": "make it easy and a couple things we're going to copy",
    "start": "2352240",
    "end": "2357520"
  },
  {
    "text": "our original hook because when you deal with kubernetes objects when there's so many pointers involved",
    "start": "2357520",
    "end": "2363680"
  },
  {
    "text": "that you want to do a deep copy that we get a fresh full copy because you don't want to modify shared",
    "start": "2363680",
    "end": "2369440"
  },
  {
    "text": "objects or shared values on on these on these two nested structures so in this case we're",
    "start": "2369440",
    "end": "2376320"
  },
  {
    "text": "going to say hey the failure policy is going to be ignore if the label uh selector for the",
    "start": "2376320",
    "end": "2383359"
  },
  {
    "text": "namespace doesn't exist sorry the label for the namespace doesn't exist but it does exist on the object",
    "start": "2383359",
    "end": "2389280"
  },
  {
    "text": "and we're gonna do some do the same thing but for the namespace where we say hey if the",
    "start": "2389280",
    "end": "2395119"
  },
  {
    "text": "lab if the name space has the the allow web of failure label then it can be ignored as well",
    "start": "2395119",
    "end": "2403680"
  },
  {
    "text": "then we return all those those uh web hooks from admission webhook configs and we",
    "start": "2403760",
    "end": "2410800"
  },
  {
    "text": "just do a pretty straightforward absurd operation where we",
    "start": "2410800",
    "end": "2425839"
  },
  {
    "text": "didn't mean to um so we we check to see if the mutant web configuration already exists",
    "start": "2426480",
    "end": "2431520"
  },
  {
    "text": "and if it does not exist then we want to create it otherwise we want to what was already",
    "start": "2431520",
    "end": "2437599"
  },
  {
    "text": "there standard absurd operation and then finally we'll we might register",
    "start": "2437599",
    "end": "2444160"
  },
  {
    "text": "some handlers and this in this case is mostly just the runways you'll see here in a minute",
    "start": "2444160",
    "end": "2449760"
  },
  {
    "text": "um with when we did some of these tests about how this works with with other handlers if",
    "start": "2449760",
    "end": "2456160"
  },
  {
    "text": "we were running more than just the one server",
    "start": "2456160",
    "end": "2460799"
  },
  {
    "text": "any questions before i before we go into the gomax prox mutating function to see see how it",
    "start": "2461359",
    "end": "2468640"
  },
  {
    "text": "actually works uh no i don't think so i'm monitoring",
    "start": "2468640",
    "end": "2473839"
  },
  {
    "text": "the chat so if something comes up i'll let you know",
    "start": "2473839",
    "end": "2478078"
  },
  {
    "text": "so we're going to writes for web hooks and",
    "start": "2479520",
    "end": "2486400"
  },
  {
    "text": "new mutate bill max prox so and so our we have a a uh a strategy um",
    "start": "2489440",
    "end": "2496319"
  },
  {
    "text": "so we so we can um reduce the boilerplate and that strategy takes a mutate pod which is just a function that takes a",
    "start": "2496319",
    "end": "2503280"
  },
  {
    "text": "context a namespace string or the name of a namespace and a pod um",
    "start": "2503280",
    "end": "2509200"
  },
  {
    "text": "and so in this case our uh our mutate pod function comes from this constructor pneum you",
    "start": "2509200",
    "end": "2515520"
  },
  {
    "text": "take bill max prox um and it passes past the back set go next proxima so this is the thing in our",
    "start": "2515520",
    "end": "2521280"
  },
  {
    "text": "case that really is going to be doing the work um of figuring out what the pod should look like",
    "start": "2521280",
    "end": "2526720"
  },
  {
    "text": "so first thing we're going to do is we're going to go through all the containers in the pod spec remember we've we already decoded this",
    "start": "2526720",
    "end": "2532160"
  },
  {
    "text": "over in the strategy to reduce the boiler plate when we have multiple um multiple pod",
    "start": "2532160",
    "end": "2538560"
  },
  {
    "text": "uh mutators first thing we're doing say hey does it have a bill max prox environment",
    "start": "2538560",
    "end": "2543680"
  },
  {
    "text": "variable if it does then we don't want to do anything we just want to continue because at that point we're assuming that the uh",
    "start": "2543680",
    "end": "2550480"
  },
  {
    "text": "the the the the users have conf have intentionally configured go max prox and we don't want to do it we don't",
    "start": "2550480",
    "end": "2556960"
  },
  {
    "text": "want to overwrite whatever they've done in that case and assuming that they don't have go max",
    "start": "2556960",
    "end": "2562720"
  },
  {
    "text": "proc set we're going to grab the cpu uh make sure it's not zero um and then and then we're going to",
    "start": "2562720",
    "end": "2570640"
  },
  {
    "text": "see if uh if if if if it's less than the minimum cpu if it is and we'll set",
    "start": "2570640",
    "end": "2576800"
  },
  {
    "text": "the cpu limit to the minimum cpu and then we're going to set an environment variable for um",
    "start": "2576800",
    "end": "2582960"
  },
  {
    "text": "for gomax procs and that go back to proc is always going to be a whole integer value so we do some energy division here",
    "start": "2582960",
    "end": "2590240"
  },
  {
    "text": "we so we set max prox on the go matchbox environment variable add that to the uh enb slice",
    "start": "2591040",
    "end": "2598319"
  },
  {
    "text": "and then add set the container back so it has that new environment variable",
    "start": "2598319",
    "end": "2604079"
  },
  {
    "text": "one thing um i feel like i should point out here is that at the top of this uh this function it does talk about",
    "start": "2604079",
    "end": "2612400"
  },
  {
    "text": "uh i think it's in here there is there are multiple maybe i",
    "start": "2612400",
    "end": "2619200"
  },
  {
    "text": "don't have it in here but there are multiple ways you can set environment variables um it could be it could be uh env or it",
    "start": "2619200",
    "end": "2625839"
  },
  {
    "text": "could be like from enb i think or env from in which case it could come from like a secret or",
    "start": "2625839",
    "end": "2631280"
  },
  {
    "text": "something um we don't mess with those in in this for this mutating mission web hook um you certainly could if you wanted to",
    "start": "2631280",
    "end": "2638560"
  },
  {
    "text": "cover all the cases but um we're just trying to get you know 80 95 of the cases here to help protect the",
    "start": "2638560",
    "end": "2645520"
  },
  {
    "text": "health of the clusters and that's what the gomax prox web hook",
    "start": "2645520",
    "end": "2654079"
  },
  {
    "text": "itself looks like and so at this point [Music] we we have our controller and",
    "start": "2654079",
    "end": "2661359"
  },
  {
    "text": "uh and we've run it and now we are we are simply waiting for the whole thing to finish before before the process ends",
    "start": "2661359",
    "end": "2668400"
  },
  {
    "text": "um and that's what the weight is for ground now it's meant to say hey we're stopping the controller",
    "start": "2668400",
    "end": "2677838"
  },
  {
    "text": "so there's a couple other things we should talk about one is testing controller runtime has some really nice",
    "start": "2681440",
    "end": "2688000"
  },
  {
    "text": "test environments where you can you can create very holistic tests that will actually use a",
    "start": "2688000",
    "end": "2694000"
  },
  {
    "text": "a uh a a subset of the control plane you use a cube api server and etd",
    "start": "2694000",
    "end": "2699440"
  },
  {
    "text": "um so if you have those binaries locally you can you can run your tests against",
    "start": "2699440",
    "end": "2705760"
  },
  {
    "text": "the api server and that ncd um so you can actually make sure that hey i'm expecting to modify this pod",
    "start": "2705760",
    "end": "2711440"
  },
  {
    "text": "right so this this is getting beyond unit tests and getting into like testing the integration right we we want to trust the coupe controller to do what",
    "start": "2711440",
    "end": "2717599"
  },
  {
    "text": "i supposed to do we want to trust do what's supposed to do but we want to make sure that qapi server uh is is calling our web hook and that",
    "start": "2717599",
    "end": "2724400"
  },
  {
    "text": "our web hook is delivering the proper response um so uh controller runtime provides an",
    "start": "2724400",
    "end": "2730000"
  },
  {
    "text": "uh an env test i believe this i believe that's a practice name i always have to look it up",
    "start": "2730000",
    "end": "2735520"
  },
  {
    "text": "um if i can find it real quick",
    "start": "2735520",
    "end": "2747839"
  },
  {
    "text": "yeah it is it is it is named env test um and",
    "start": "2748800",
    "end": "2755440"
  },
  {
    "text": "we'll take a look at the documentation here in just a minute um but if you have those binaries locally you can you can run",
    "start": "2755440",
    "end": "2760640"
  },
  {
    "text": "your tests against them to make sure like yeah hey my pod after i create it i actually go grab it",
    "start": "2760640",
    "end": "2766160"
  },
  {
    "text": "and actually looks the way i expect it to look and so we'll take a look at those tests but before we do that um",
    "start": "2766160",
    "end": "2771839"
  },
  {
    "text": "i want to real quick show what this uh what this would look like this one",
    "start": "2771839",
    "end": "2780880"
  },
  {
    "text": "let me know when you can see the browser",
    "start": "2781280",
    "end": "2789839"
  },
  {
    "text": "do you see the env test documentation yeah now we do okay great so enb test",
    "start": "2800400",
    "end": "2807200"
  },
  {
    "text": "come it's it's pretty straightforward um you can control things the cube builder assets environment variable that just",
    "start": "2807200",
    "end": "2813520"
  },
  {
    "text": "specifies a location on your on your machine where where you can find a qa guy",
    "start": "2813520",
    "end": "2820240"
  },
  {
    "text": "server and an etd you do not have to be running on linux",
    "start": "2820240",
    "end": "2825440"
  },
  {
    "text": "to do this so although kubernetes really only publishes the the linux binaries",
    "start": "2825440",
    "end": "2831200"
  },
  {
    "text": "you can you can get the source code for kubernetes go into the the root directory the repository",
    "start": "2831200",
    "end": "2836640"
  },
  {
    "text": "and run make kube api server and it'll build the cube api server for",
    "start": "2836640",
    "end": "2841680"
  },
  {
    "text": "you on your system so i'm on a i'm on a macbook and we'll see what that looks like here in just a",
    "start": "2841680",
    "end": "2847359"
  },
  {
    "text": "minute to actually run these we run these tests locally um also going to show",
    "start": "2847359",
    "end": "2852400"
  },
  {
    "text": "exactly kind of what that what using sony's test looks like and how to configure something",
    "start": "2852400",
    "end": "2859839"
  },
  {
    "text": "back to the terminal window",
    "start": "2863760",
    "end": "2872079"
  },
  {
    "text": "there you go you see it now yeah great so first thing we'll do is we'll just do",
    "start": "2872079",
    "end": "2879680"
  },
  {
    "text": "go test here um you're gonna see",
    "start": "2879680",
    "end": "2886400"
  },
  {
    "text": "not much you're gonna see you're gonna see test pass",
    "start": "2886400",
    "end": "2890319"
  },
  {
    "text": "right now we're gonna say",
    "start": "2891760",
    "end": "2901839"
  },
  {
    "text": "all right",
    "start": "2903040",
    "end": "2914400"
  },
  {
    "text": "so in this case i have um the tests that use the the emv test environment tagged with",
    "start": "2914400",
    "end": "2919839"
  },
  {
    "text": "with a sandbox environment because they require something more than what someone might have on their on their machine",
    "start": "2919839",
    "end": "2926160"
  },
  {
    "text": "and so we separate those from standard unit tests so i provide the sandbox",
    "start": "2926160",
    "end": "2933119"
  },
  {
    "text": "tag to go test",
    "start": "2933119",
    "end": "2936480"
  },
  {
    "text": "while it's running uh there's a question in the chat um what's the best way to conditionally",
    "start": "2940160",
    "end": "2947040"
  },
  {
    "text": "set go max cross because it's only applicable for go applications so uh you mentioned that",
    "start": "2947040",
    "end": "2954640"
  },
  {
    "text": "you are go show so maybe you are not concerned with it but do you have a general recommendation for people yeah you know",
    "start": "2954640",
    "end": "2961680"
  },
  {
    "text": "so i i i go so the specific question i",
    "start": "2961680",
    "end": "2966720"
  },
  {
    "text": "i think the the answers just said go max procs just as if you have a lot of go code just go ahead and set it it's not going to hurt other",
    "start": "2966720",
    "end": "2973359"
  },
  {
    "text": "other things the the general question of how you would control that",
    "start": "2973359",
    "end": "2978559"
  },
  {
    "text": "um if there were some other kind of environment variable that you might want to set for say for",
    "start": "2978559",
    "end": "2984559"
  },
  {
    "text": "whatever reason for a java application but not for a net application um in that case",
    "start": "2984559",
    "end": "2990079"
  },
  {
    "text": "i would you would probably have to go with an annotation um and the value there too though is that you can",
    "start": "2990079",
    "end": "2996160"
  },
  {
    "text": "you can using annotations and providing a set of annotations for your",
    "start": "2996160",
    "end": "3001520"
  },
  {
    "text": "users that you support you abstract away the details of what might happen so you might say hey",
    "start": "3001520",
    "end": "3006880"
  },
  {
    "text": "in our particular environment um we know that we're going to want to do certain things uh those those things",
    "start": "3006880",
    "end": "3013599"
  },
  {
    "text": "might be like oh yeah i need to hook up logging so one of the things that we do at digitalocean and we talked about",
    "start": "3013599",
    "end": "3018720"
  },
  {
    "text": "getting the logs of centralized logging i talked about syslog but we actually have more than one way to get locks to centralized logging we",
    "start": "3018720",
    "end": "3025520"
  },
  {
    "text": "can we can have the application right directly to syslog but we can also read it directly from",
    "start": "3025520",
    "end": "3031200"
  },
  {
    "text": "standard error standard out and using fluid bit and get those things to syslog so in that case",
    "start": "3031200",
    "end": "3036640"
  },
  {
    "text": "we provide uh to provide an annotation of two annotations actually um that allow people to kind of opt in",
    "start": "3036640",
    "end": "3044400"
  },
  {
    "text": "to the syslog experience or just to do the standard out logging to get their their logs extend to um to",
    "start": "3044400",
    "end": "3051680"
  },
  {
    "text": "to centralized logging and so when you're building a platform you want to provide something that you can support um and so if you had some",
    "start": "3051680",
    "end": "3058640"
  },
  {
    "text": "kind of environmental that you people may be able to set maybe it's not actually environmentally needs that they want to be able to set an annotation and",
    "start": "3058640",
    "end": "3065119"
  },
  {
    "text": "then your your web hook can look at that annotation and take appropriate action",
    "start": "3065119",
    "end": "3070480"
  },
  {
    "text": "that might be selling environment variable it might be something else right you might have something that says hey i i want all i want all of our our",
    "start": "3070480",
    "end": "3077200"
  },
  {
    "text": "folks to um annotate their pods with or with with kind of what kinds of",
    "start": "3077200",
    "end": "3083119"
  },
  {
    "text": "things are running in this like how how they're being run um because you might want to hook up jbm environment variables or something",
    "start": "3083119",
    "end": "3090240"
  },
  {
    "text": "like that great thank you so so here you can see",
    "start": "3090240",
    "end": "3096319"
  },
  {
    "text": "we we got a lot more uh a lot a lot more tests that came out of this or a lot more a",
    "start": "3096319",
    "end": "3101520"
  },
  {
    "text": "lot more logs that came out of this and the reason is because it spun up the uh the um",
    "start": "3101520",
    "end": "3108559"
  },
  {
    "text": "api server and ftp i'm gonna run this in verbose mode so you can really see all the logs because um i'll show you in",
    "start": "3108559",
    "end": "3114559"
  },
  {
    "text": "just a minute um the the tests are configured so that when we run tests in verbose mode we",
    "start": "3114559",
    "end": "3121760"
  },
  {
    "text": "also hook up the uh the api server and sed logs to standard standard out so we can",
    "start": "3121760",
    "end": "3128000"
  },
  {
    "text": "see everything that outputs which is really useful whenever you're having a problem you know",
    "start": "3128000",
    "end": "3133920"
  },
  {
    "text": "maybe your your server is crashing your control isn't working or it's not trusting the certificate and so",
    "start": "3133920",
    "end": "3139520"
  },
  {
    "text": "your tests are failing because but you can't see why because it's really cube api server is getting a",
    "start": "3139520",
    "end": "3144800"
  },
  {
    "text": "response it can't handle so here we have a whole lot more logs and these all come from etd",
    "start": "3144800",
    "end": "3149839"
  },
  {
    "text": "and from from cube api server let's go let's go take a look let's go",
    "start": "3149839",
    "end": "3155760"
  },
  {
    "text": "take a look at those those tests real quick so in this case we have",
    "start": "3155760",
    "end": "3162880"
  },
  {
    "text": "a simple uh test function tesco max prox and what we do here is we we create a",
    "start": "3162880",
    "end": "3170240"
  },
  {
    "text": "pod notice it doesn't have uh the the gomax",
    "start": "3170240",
    "end": "3176480"
  },
  {
    "text": "proc set um and but we do make sure it has a cpu limit and then when we're when we're done we",
    "start": "3176480",
    "end": "3183920"
  },
  {
    "text": "make sure that hey our uh our env um variable or environment variable for the",
    "start": "3183920",
    "end": "3189680"
  },
  {
    "text": "container has has to go max box set um and the value is what we want it to",
    "start": "3189680",
    "end": "3194800"
  },
  {
    "text": "be obviously this could be you can handle all of your other edge cases you can make sure like yeah if i if i have go max prox set that it",
    "start": "3194800",
    "end": "3200319"
  },
  {
    "text": "doesn't override it you can make sure that when you're dealing with parts and cpus that it does the right thing",
    "start": "3200319",
    "end": "3205680"
  },
  {
    "text": "in this case i just want to do something simple to show you like we can we can actually test this and the way this works is i've created",
    "start": "3205680",
    "end": "3213040"
  },
  {
    "text": "this function with test env [Music] tags",
    "start": "3213040",
    "end": "3220078"
  },
  {
    "text": "we have with with test env which creates a new ts test cnb and then executes the",
    "start": "3221440",
    "end": "3228160"
  },
  {
    "text": "function that we pass in here to actually do the test but this new test cmv is a thing that",
    "start": "3228160",
    "end": "3233839"
  },
  {
    "text": "actually sets up cube api server and you know the control plane that we",
    "start": "3233839",
    "end": "3239359"
  },
  {
    "text": "need for for for these tests it's pretty straightforward again you can create an emv test environment",
    "start": "3239359",
    "end": "3245119"
  },
  {
    "text": "again this comes from controller runtime we grab the api server we make sure we configure you can pass",
    "start": "3245119",
    "end": "3251839"
  },
  {
    "text": "pretty much any you can configure all the api server flags that you want um through this method you configure",
    "start": "3251839",
    "end": "3257839"
  },
  {
    "text": "returns back a a set of process arguments that have an append method",
    "start": "3257839",
    "end": "3262880"
  },
  {
    "text": "that you can see you can add additional arguments to api server and then you start it making it back as",
    "start": "3262880",
    "end": "3269040"
  },
  {
    "text": "a rest config that is you're if you're not familiar with these",
    "start": "3269040",
    "end": "3274160"
  },
  {
    "text": "this is a type in uh believe it i believe it's in i think it's in client go",
    "start": "3274160",
    "end": "3280319"
  },
  {
    "text": "um yeah it's in client go it contains the host api path um the credentials you might need as",
    "start": "3280319",
    "end": "3286960"
  },
  {
    "text": "well as a tls tls config so that allows you to connect to the uh the api server that",
    "start": "3286960",
    "end": "3295520"
  },
  {
    "text": "that stood up and again the cpi server is working locally you can connect to uh to a real cluster",
    "start": "3295520",
    "end": "3301520"
  },
  {
    "text": "if you want to um but you mostly don't need to because because all you really want to do in",
    "start": "3301520",
    "end": "3306720"
  },
  {
    "text": "this case is usually it's like hey the pod has the right form and then then we're going to trust kubernetes to",
    "start": "3306720",
    "end": "3312480"
  },
  {
    "text": "do the right thing with it and there and then we pass that rest",
    "start": "3312480",
    "end": "3318400"
  },
  {
    "text": "config off to our new config function that we saw earlier that configures",
    "start": "3318400",
    "end": "3324880"
  },
  {
    "text": "the manager and everything and so i really encourage people to to use test",
    "start": "3324880",
    "end": "3331440"
  },
  {
    "text": "cnv and you don't have to use that you don't even have to be using controller runtime if you're writing",
    "start": "3331440",
    "end": "3336480"
  },
  {
    "text": "code in um you're not using controller runtime for",
    "start": "3336480",
    "end": "3341680"
  },
  {
    "text": "whatever reason you're using watchers and formers you can still use controllers runtime testdmv to really write very robust tests",
    "start": "3341680",
    "end": "3348160"
  },
  {
    "text": "that's a good good tip thanks uh and also thanks for the crash course here on",
    "start": "3348160",
    "end": "3354319"
  },
  {
    "text": "controller runtime webhook admission controllers i think that it was very educated even people",
    "start": "3354319",
    "end": "3359839"
  },
  {
    "text": "who might have been familiar with the concept uh looking at the code and looking at uh",
    "start": "3359839",
    "end": "3366079"
  },
  {
    "text": "actually a real world use case uh sharing from your experience so thank",
    "start": "3366079",
    "end": "3371680"
  },
  {
    "text": "you for that um we do have like a couple of more",
    "start": "3371680",
    "end": "3376720"
  },
  {
    "text": "minutes if someone wants to ask uh some questions over the chat",
    "start": "3376720",
    "end": "3381839"
  },
  {
    "text": "if not you could use the slack channel that we have uh which is um cloud dash",
    "start": "3381839",
    "end": "3389760"
  },
  {
    "text": "live on the cncf workspace on slack so feel free to ask further questions",
    "start": "3389760",
    "end": "3396640"
  },
  {
    "text": "there i don't see any other questions so",
    "start": "3396640",
    "end": "3402160"
  },
  {
    "text": "i think we could uh uh wrap it up um in a uh last uh words uh",
    "start": "3402160",
    "end": "3408640"
  },
  {
    "text": "summary really yeah so um a couple things you know i i just kind of want to re-emphasize that um mutating",
    "start": "3408640",
    "end": "3414960"
  },
  {
    "text": "what emission web hooks and validating emission web hooks are really the foundation upon which you can start to build",
    "start": "3414960",
    "end": "3420880"
  },
  {
    "text": "a platform on top of kubernetes for your users and start to get rid of some of that tribal knowledge and allow your",
    "start": "3420880",
    "end": "3426240"
  },
  {
    "text": "your administrators and operators to be more flexible in how they deal with everything um how they how they",
    "start": "3426240",
    "end": "3431760"
  },
  {
    "text": "provide a consistent experience to their users um thanks for having me this is a lot of",
    "start": "3431760",
    "end": "3437599"
  },
  {
    "text": "fun i if anybody has any questions feel free to reach out all right",
    "start": "3437599",
    "end": "3443359"
  },
  {
    "text": "thank you and uh just there this is cloud native live we're here uh every wednesday so uh tune in next",
    "start": "3443359",
    "end": "3451040"
  },
  {
    "text": "time and uh thank you billy and uh see you next time everyone",
    "start": "3451040",
    "end": "3457359"
  },
  {
    "text": "goodbye",
    "start": "3458839",
    "end": "3461839"
  }
]