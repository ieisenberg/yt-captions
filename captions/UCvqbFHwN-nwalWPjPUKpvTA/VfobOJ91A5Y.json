[
  {
    "text": "all right good afternoon everybody thanks for finding your way down here to",
    "start": "0",
    "end": "6330"
  },
  {
    "text": "the dungeon to to learn about accordion s my name is John Bell Americ I'm one of",
    "start": "6330",
    "end": "14070"
  },
  {
    "text": "the maintainer accordion s and as well as kubernetes and here to talk about",
    "start": "14070",
    "end": "21710"
  },
  {
    "text": "specifically the extension points in core dns for developers so this is the",
    "start": "21710",
    "end": "28560"
  },
  {
    "text": "deep dive I'm not going to go over what queer DNS is other than very very",
    "start": "28560",
    "end": "33780"
  },
  {
    "text": "briefly but really gonna jump into actual things you can do to customize it",
    "start": "33780",
    "end": "39629"
  },
  {
    "text": "and make it work work how you want I do",
    "start": "39629",
    "end": "44730"
  },
  {
    "text": "have another session tomorrow on core DNS that's more around configuring it for sort of advanced use cases as",
    "start": "44730",
    "end": "51090"
  },
  {
    "text": "opposed to modifying it and building it but so if you're interested in that sort of thing please come to that as well so",
    "start": "51090",
    "end": "59309"
  },
  {
    "text": "we have essentially three three ways",
    "start": "59309",
    "end": "65460"
  },
  {
    "text": "that you can customize DNS that people with customized QWERTY enough that",
    "start": "65460",
    "end": "70710"
  },
  {
    "text": "people would typically do the first one is rebuilding it with external plugins and another is to use",
    "start": "70710",
    "end": "79080"
  },
  {
    "text": "it as a library to build your own DNS server or executables some short and finally it's building your own plugin",
    "start": "79080",
    "end": "84780"
  },
  {
    "text": "which allows you to do all sorts of fun stuff so I will talk about all three of",
    "start": "84780",
    "end": "90509"
  },
  {
    "text": "those today and well and so let's get",
    "start": "90509",
    "end": "97560"
  },
  {
    "text": "started in advance no all right all",
    "start": "97560",
    "end": "103100"
  },
  {
    "text": "right we'll start with the the easiest one actually in fact it's called the",
    "start": "103100",
    "end": "108210"
  },
  {
    "text": "subtitle is extensions points for developers but this one you actually don't need to be a developer to do you",
    "start": "108210",
    "end": "114000"
  },
  {
    "text": "don't need to go you don't need anything except docker and a shell so what what",
    "start": "114000",
    "end": "125399"
  },
  {
    "text": "this is sort of getting at is that core D&S this is one of those things I'll talk briefly about what it is it's a DNS",
    "start": "125399",
    "end": "131129"
  },
  {
    "text": "server but but it's it's architected in such a that every request that it picks up goes",
    "start": "131129",
    "end": "136329"
  },
  {
    "text": "through a chain of plugins and each plug-in has the option to either service",
    "start": "136329",
    "end": "143950"
  },
  {
    "text": "that request and provide a response or to modify the request and pass it on to",
    "start": "143950",
    "end": "149469"
  },
  {
    "text": "the next plug-in in the chain or to simply do nothing with it just pass it on to the next plug-in and then when a",
    "start": "149469",
    "end": "156250"
  },
  {
    "text": "plug-in does actually do something with a request it gets passed back down that",
    "start": "156250",
    "end": "161260"
  },
  {
    "text": "should the response essentially gets passed back down that chain it's got a call stack of functions and you can",
    "start": "161260",
    "end": "167889"
  },
  {
    "text": "actually manipulate the response on the way back out if you want so that plug-in system makes it really",
    "start": "167889",
    "end": "176379"
  },
  {
    "text": "easy to add in your custom behaviors there's a bunch of third-party plugins",
    "start": "176379",
    "end": "182769"
  },
  {
    "text": "available when I say it's an external plug-in what that really means is that",
    "start": "182769",
    "end": "188849"
  },
  {
    "text": "it's not it's not built into core DNS the one you'd pull down off of github or",
    "start": "188849",
    "end": "194019"
  },
  {
    "text": "the one you'd pull down off of docker docker hub instead it's it's one you",
    "start": "194019",
    "end": "200799"
  },
  {
    "text": "have to build in yourself it also means that we as the core maintainer of",
    "start": "200799",
    "end": "206459"
  },
  {
    "text": "Cordilleras aren't really gonna give you a lot of help with it if it doesn't work you're gonna have to go talk to whoever",
    "start": "206459",
    "end": "213729"
  },
  {
    "text": "built it we what one I guess thing I",
    "start": "213729",
    "end": "219459"
  },
  {
    "text": "didn't call out it's on the slide is that you'll hear I say you have to build it the reason for that is that core DNS",
    "start": "219459",
    "end": "226239"
  },
  {
    "text": "is completely statically compiled there's no dynamic loading it's written and go and and certainly when we wrote",
    "start": "226239",
    "end": "232449"
  },
  {
    "text": "it there wasn't you you you didn't do that and go you couldn't you can now and we're versions ago but we still don't do",
    "start": "232449",
    "end": "238479"
  },
  {
    "text": "it we instead we control it with a simple file that you modify and rebuild",
    "start": "238479",
    "end": "248879"
  },
  {
    "text": "the other thing well I'll call it out in a minute but um so let's actually do this now so",
    "start": "248879",
    "end": "257739"
  },
  {
    "text": "hopefully our network connectivity is good enough that it works but these are",
    "start": "257739",
    "end": "262750"
  },
  {
    "text": "the three simple steps you need to do to include a new plugin first clone it from github",
    "start": "262750",
    "end": "272060"
  },
  {
    "text": "second modify plug-in CFG third build it and then you're done so first step",
    "start": "272060",
    "end": "278430"
  },
  {
    "text": "cloning it so it looks like kind of a nasty docker command here but what we're",
    "start": "278430",
    "end": "284940"
  },
  {
    "text": "doing is not actually that bad the this is just using the the golang",
    "start": "284940",
    "end": "293490"
  },
  {
    "text": "docker image so that you don't have to install a go development environment on your workstation it's running that let's",
    "start": "293490",
    "end": "303090"
  },
  {
    "text": "see if it's a point or show up probably not the the - view statement essentially",
    "start": "303090",
    "end": "310140"
  },
  {
    "text": "is just saying when we clone this normally this docker container is going to run as root we don't want all the",
    "start": "310140",
    "end": "316110"
  },
  {
    "text": "stuff that gets cloned down to our file system here to be on by root because then we can't modify plugins CF gene without so you know so it's just a",
    "start": "316110",
    "end": "322680"
  },
  {
    "text": "convenience so we we we cloned it into a directory and we CD into that directory",
    "start": "322680",
    "end": "330300"
  },
  {
    "text": "and we check out a particular branch I just do that in slides really and you'd",
    "start": "330300",
    "end": "335340"
  },
  {
    "text": "want to do it if you want your builds to be repeatable but you know all of the dependencies tend to progress and if you",
    "start": "335340",
    "end": "342030"
  },
  {
    "text": "don't check out a particular branch you run into all kinds of annoying problems alright let's give this a try the setup",
    "start": "342030",
    "end": "348420"
  },
  {
    "text": "here is a little weird I need to move this see I'm gonna have to come down",
    "start": "348420",
    "end": "356550"
  },
  {
    "text": "there so I think so I can see what's going on move this over",
    "start": "356550",
    "end": "363530"
  },
  {
    "text": "I mean I have a shell here but I can't",
    "start": "368639",
    "end": "381449"
  },
  {
    "text": "see the screen from up there so I will come down here and join you all right",
    "start": "381449",
    "end": "393800"
  },
  {
    "text": "there yeah all right so I will paste in",
    "start": "400039",
    "end": "408090"
  },
  {
    "text": "that command except that I didn't copy it properly",
    "start": "408090",
    "end": "414949"
  },
  {
    "text": "all right so that might take a minute so we'll talk a little bit well yeah that's",
    "start": "418819",
    "end": "424949"
  },
  {
    "text": "kind of slow uh we'll talk a little bit well does that and you get to see my",
    "start": "424949",
    "end": "431699"
  },
  {
    "text": "notes so let's see all right so this is",
    "start": "431699",
    "end": "442289"
  },
  {
    "text": "what the plugin see if she is well it's cloning hopefully we'll see the plug-in in CFG in just a moment",
    "start": "442289",
    "end": "448129"
  },
  {
    "text": "actually all right it's a really simple",
    "start": "448129",
    "end": "458969"
  },
  {
    "text": "file it's just the directive and the go module so in the core file that is the",
    "start": "458969",
    "end": "466080"
  },
  {
    "text": "file that we use to configure or DNS you'll see a bunch of you know configuration directives that's actually",
    "start": "466080",
    "end": "473460"
  },
  {
    "text": "just what comes right out of here and then the the go module normally is you",
    "start": "473460",
    "end": "480240"
  },
  {
    "text": "know basically we don't see a bunch of slashes in there we're gonna assume it's in the root core DNS repository but if",
    "start": "480240",
    "end": "487199"
  },
  {
    "text": "we see a bunch of slashes then we're gonna we're gonna pull it from wherever",
    "start": "487199",
    "end": "493469"
  },
  {
    "text": "so in this case we're gonna pull the firewall clog in the firewall plugin is",
    "start": "493469",
    "end": "498659"
  },
  {
    "text": "really cool and you can see it in my notes I will talk about that a little bit tomorrow when I have if when I have a",
    "start": "498659",
    "end": "505389"
  },
  {
    "text": "little more time all right so here we can see so",
    "start": "505389",
    "end": "520750"
  },
  {
    "text": "firewall plugin basically will allow you to do sort of advanced blocking of queries and so it fits in in this plugin",
    "start": "520750",
    "end": "528040"
  },
  {
    "text": "chain along with the Akal so so the plugin CFG actually defines the order that the request will be processed in",
    "start": "528040",
    "end": "534310"
  },
  {
    "text": "just like that just like the plug-in they're all built in at compile time actually the ordering of processing is",
    "start": "534310",
    "end": "540430"
  },
  {
    "text": "built in at compile time which kind of sucks but it's how it is right now and um and we haven't had a good enough",
    "start": "540430",
    "end": "546310"
  },
  {
    "text": "reason to change it because it's not that hard to rebuild if you've got some really crazy requirements so I want for",
    "start": "546310",
    "end": "551350"
  },
  {
    "text": "a while to live in roughly the same place because it does roughly the same",
    "start": "551350",
    "end": "557320"
  },
  {
    "text": "thing alright cool so that's it we edited that and then we want to build it",
    "start": "557320",
    "end": "565830"
  },
  {
    "text": "to build it I'm also gonna use docker and the reason is because I don't want",
    "start": "565830",
    "end": "571180"
  },
  {
    "text": "to have to install go on this machine actually I have go 111 on this machine but it doesn't work with go 111 it at",
    "start": "571180",
    "end": "576940"
  },
  {
    "text": "this point all right that is gonna build the next thing I'm going to show you",
    "start": "576940",
    "end": "583390"
  },
  {
    "text": "after we do the pulling in an external plug-in is the way to sort of build your",
    "start": "583390",
    "end": "590710"
  },
  {
    "text": "own special-purpose executable and one of the reasons you want to do that so then you'll have to deal with all of",
    "start": "590710",
    "end": "596110"
  },
  {
    "text": "this so here we're pulling in all kinds of stuff a lot of this stuff comes in from all the plugins that are already",
    "start": "596110",
    "end": "602080"
  },
  {
    "text": "part of core D&S so for example the kubernetes plugin pulls in a bunch of libraries to do authentication against",
    "start": "602080",
    "end": "609940"
  },
  {
    "text": "all the different things that cube config you know you can authenticate so it's got stuff from AWS and imagine for",
    "start": "609940",
    "end": "615970"
  },
  {
    "text": "Google Cloud and all of that so there's tons of dependencies that get pulled into an ordinary Korean s if you don't",
    "start": "615970",
    "end": "622630"
  },
  {
    "text": "want all those dependencies you want a small executable then you can do this a",
    "start": "622630",
    "end": "628120"
  },
  {
    "text": "little bit differently and you can even just strip out all those plugins from your plugin CFG too that's another way",
    "start": "628120",
    "end": "633520"
  },
  {
    "text": "all right let's see if I can talk more while we wait for it to bill one of the",
    "start": "633520",
    "end": "641920"
  },
  {
    "text": "things about this since we're using docker to do this actual build even though I'm building this on this this",
    "start": "641920",
    "end": "648190"
  },
  {
    "text": "Mac I'm running you know Linux container and docker the build so the executable",
    "start": "648190",
    "end": "653649"
  },
  {
    "text": "that I get out of this it's gonna be dropped in my local file system but it's gonna be a Linux executable I won't be able to run it so when we go to run it I",
    "start": "653649",
    "end": "660760"
  },
  {
    "text": "will also use a docker command and what I will run is a very simple extraction",
    "start": "660760",
    "end": "668410"
  },
  {
    "text": "show this it's a very simple command",
    "start": "668410",
    "end": "675010"
  },
  {
    "text": "that's just going to spit out the list of plugins that are used that are",
    "start": "675010",
    "end": "681730"
  },
  {
    "text": "installed in for DNS so whenever you come across a strange binary you know",
    "start": "681730",
    "end": "687670"
  },
  {
    "text": "and you choose to choose to run it for whatever reason you could get you could do - plugins and see if you have the",
    "start": "687670",
    "end": "694600"
  },
  {
    "text": "plug-in you're looking for is actually installed unfortunately it orders them alphabetically not in the order of the",
    "start": "694600",
    "end": "700450"
  },
  {
    "text": "plug-in CFG so another thing that would be really nice to fix",
    "start": "700450",
    "end": "705420"
  },
  {
    "text": "you see all the kubernetes class getting compiled let's see this was the the the",
    "start": "718970",
    "end": "725780"
  },
  {
    "text": "command we used to build it's just a simple make through make file you can actually also use go build but when you",
    "start": "725780",
    "end": "732920"
  },
  {
    "text": "modify the plugin C of G the make file will also do a go generate which will actually change a bunch of imports and",
    "start": "732920",
    "end": "740240"
  },
  {
    "text": "stuff so you want to do that and then that's next yeah oh my goodness all",
    "start": "740240",
    "end": "749750"
  },
  {
    "text": "right it's not that exciting so why don't we move on so I don't know oh except that it's done all right yeah so",
    "start": "749750",
    "end": "760160"
  },
  {
    "text": "then we can run it so yeh we listed all the plugins one of which is our firewall",
    "start": "760160",
    "end": "768260"
  },
  {
    "text": "plug-in which is now included all right so the reason it says DNS dot firewall",
    "start": "768260",
    "end": "773630"
  },
  {
    "text": "is cuz Cordy and ass internally if this doesn't collapse I mean Claudio next",
    "start": "773630",
    "end": "779570"
  },
  {
    "text": "internally is built using a product called caddy which is a go based web",
    "start": "779570",
    "end": "786560"
  },
  {
    "text": "server originally but really it's just a server framework at this point and so you could actually use it to to build",
    "start": "786560",
    "end": "794410"
  },
  {
    "text": "any kind of server and we used it to build a DNS server alright I should have",
    "start": "794410",
    "end": "801160"
  },
  {
    "text": "move this window over and it worked to where I can see it before alright so",
    "start": "801160",
    "end": "808640"
  },
  {
    "text": "that is including an external plug-in the the next thing is what I mentioned",
    "start": "808640",
    "end": "816140"
  },
  {
    "text": "oh my goodness that's painful",
    "start": "816140",
    "end": "823450"
  },
  {
    "text": "all right sorry about this folks all right present and I need my notes sorry",
    "start": "829959",
    "end": "841449"
  },
  {
    "text": "the next thing is the building that that",
    "start": "841449",
    "end": "847010"
  },
  {
    "text": "main executable replacing the main go and that that's done for example by the",
    "start": "847010",
    "end": "852680"
  },
  {
    "text": "if you've heard of the kubernetes node local DNS service so that's actually based on core DNS it it runs it builds a",
    "start": "852680",
    "end": "863600"
  },
  {
    "text": "special core DNS that includes only a",
    "start": "863600",
    "end": "869089"
  },
  {
    "text": "few plugins it includes like the the forward plug-in which is what we use to",
    "start": "869089",
    "end": "875750"
  },
  {
    "text": "talk to the upstream accordion on us or upstream from from node local and in",
    "start": "875750",
    "end": "881750"
  },
  {
    "text": "cash of course and then things to manage or DNS like health checks and readiness checks and",
    "start": "881750",
    "end": "887959"
  },
  {
    "text": "things like that metrics but um the reason it does it this way is that one it makes it much smaller so we basically",
    "start": "887959",
    "end": "894470"
  },
  {
    "text": "get down to about as small as you can get for a go runtime which is like 10 Meg's in and RSS there's a bunch of",
    "start": "894470",
    "end": "900170"
  },
  {
    "text": "stuff that just comes with gal that makes it a little bit bigger and since it's gonna be on every single node we want it to be as small as possible the",
    "start": "900170",
    "end": "909110"
  },
  {
    "text": "other reason is that this way it can actually hook into the startup code and",
    "start": "909110",
    "end": "914540"
  },
  {
    "text": "it can do something different and what it does in particular is it does some fancy tricks to steal the VIP so that",
    "start": "914540",
    "end": "920990"
  },
  {
    "text": "the the dns traffic goes to the local instance of it instead of to the upstream and it also in particular",
    "start": "920990",
    "end": "928130"
  },
  {
    "text": "really nice thing it does is turn off connection tracking for those unibit calls which cup events a lot of issues",
    "start": "928130",
    "end": "933889"
  },
  {
    "text": "and avoid some bugs in certain versions of Linux panel so that's a really cool project if you run kubernetes which most",
    "start": "933889",
    "end": "940250"
  },
  {
    "text": "of you probably do here to check out is the node local DNS which is a beta feature at this point ok so another",
    "start": "940250",
    "end": "950449"
  },
  {
    "text": "example of this is something I call DNS cache key this is actually just written in order to teach this stuff it's not",
    "start": "950449",
    "end": "957110"
  },
  {
    "text": "actually like something I mean guess you could use it there's no reason not to but it's its source code is in this in",
    "start": "957110",
    "end": "965029"
  },
  {
    "text": "this repository here and it's a very simple DNS caching server users of it",
    "start": "965029",
    "end": "973760"
  },
  {
    "text": "don't even know that wouldn't even know that core DNS is behind it basically it just runs on your local",
    "start": "973760",
    "end": "979880"
  },
  {
    "text": "node and presumably and answers queries sending them upstream as it needs to and",
    "start": "979880",
    "end": "987260"
  },
  {
    "text": "they can run it and and don't have to worry about how to write a core file which is our configuration file to make",
    "start": "987260",
    "end": "993230"
  },
  {
    "text": "it do do what you want because you're sort of taking over the main function",
    "start": "993230",
    "end": "998870"
  },
  {
    "text": "you can change the command line flags to do whatever you want I can show you what",
    "start": "998870",
    "end": "1006279"
  },
  {
    "text": "that looks like I do this awkward dance again hopefully not bad I'm not gonna",
    "start": "1006279",
    "end": "1015100"
  },
  {
    "text": "build this one though so in here it's",
    "start": "1015100",
    "end": "1030130"
  },
  {
    "text": "actually pretty simple well there's some like I said we use",
    "start": "1030130",
    "end": "1037178"
  },
  {
    "text": "caddy as this sort of framework so there's some initialization stuff you need to do in order to to get the caddy",
    "start": "1037179",
    "end": "1044530"
  },
  {
    "text": "to behave exactly how we want and then there's a very simple main function this is all does it it parses the flags that",
    "start": "1044530",
    "end": "1050169"
  },
  {
    "text": "come in so that creates this structure that just captures the configuration and the way I did this one is then that",
    "start": "1050169",
    "end": "1057640"
  },
  {
    "text": "object that captures that configuration will generate a core file which in turn gets fed into the caddy start routines",
    "start": "1057640",
    "end": "1065049"
  },
  {
    "text": "so when we when we pull in the individual plugins that were interested",
    "start": "1065049",
    "end": "1070299"
  },
  {
    "text": "in they also pull in pull in what we call our dns server our internals being",
    "start": "1070299",
    "end": "1077169"
  },
  {
    "text": "a server function another class and that in turn is sort of registered at the anit function for that what i just",
    "start": "1077169",
    "end": "1083440"
  },
  {
    "text": "release with the candy framework so that's how a caddy knows to start up a DNS server and not to start up a HTTP",
    "start": "1083440",
    "end": "1090580"
  },
  {
    "text": "server because it's sort of through this the module routines in in that DNS server",
    "start": "1090580",
    "end": "1097419"
  },
  {
    "text": "function so finally after we start that we just wait forever basically how much",
    "start": "1097419",
    "end": "1106419"
  },
  {
    "text": "time do I have left I should probably click in to the DNS",
    "start": "1106419",
    "end": "1116080"
  },
  {
    "text": "cache D itself if it's interesting so",
    "start": "1116080",
    "end": "1127079"
  },
  {
    "text": "this is what actually does the logic here's how we decide in this particular",
    "start": "1127079",
    "end": "1133479"
  },
  {
    "text": "instance which plugins we want to include so we just do these anonymous imports and that pulls in these are the",
    "start": "1133479",
    "end": "1140320"
  },
  {
    "text": "only plugins built into this particular executable when it when it runs so then",
    "start": "1140320",
    "end": "1145619"
  },
  {
    "text": "we parse flags and finally those flags",
    "start": "1145619",
    "end": "1151450"
  },
  {
    "text": "and the the struct that results from that are just used to actually generate trip train a core file that just like",
    "start": "1151450",
    "end": "1158529"
  },
  {
    "text": "you would do for an ordinary c√°rdenas instance which which ends up instantiating all of those those things",
    "start": "1158529",
    "end": "1163889"
  },
  {
    "text": "alright so that is that's number two for",
    "start": "1163889",
    "end": "1169929"
  },
  {
    "text": "number three let's go back here",
    "start": "1169929",
    "end": "1175498"
  },
  {
    "text": "number three is writing your own plugin so writing your own plugin is actually",
    "start": "1175919",
    "end": "1184599"
  },
  {
    "text": "super easy you you basically write four functions we'll talk about those in a second but one of the things that as a",
    "start": "1184599",
    "end": "1192399"
  },
  {
    "text": "sort of community we want to do with core DNS one of the goals of it is simplicity and part of simplicity it's",
    "start": "1192399",
    "end": "1198669"
  },
  {
    "text": "sort of like we try and live by the the UNIX philosophy a little bit of like do one thing do it well at least respect",
    "start": "1198669",
    "end": "1204099"
  },
  {
    "text": "for our plugins so while we tend to categorize plugins into three different categories I tend to think of them as",
    "start": "1204099",
    "end": "1210429"
  },
  {
    "text": "these these backends backends are ones that will pull data from some source so kubernetes pulls data from the",
    "start": "1210429",
    "end": "1215859"
  },
  {
    "text": "community's API file pulls data from a zone file etc those those do that that",
    "start": "1215859",
    "end": "1225249"
  },
  {
    "text": "function another category are what I call Mutai so these are things that operate on the requests they take the requests and they",
    "start": "1225249",
    "end": "1231370"
  },
  {
    "text": "do something with it they rewrite it they append something like NS ID to it they are they maybe they block it and",
    "start": "1231370",
    "end": "1238270"
  },
  {
    "text": "echo or configurators kind of a weird",
    "start": "1238270",
    "end": "1243460"
  },
  {
    "text": "word I mean upward maybe but those modified internal state what IP address joy behind - you know should I log this",
    "start": "1243460",
    "end": "1251830"
  },
  {
    "text": "I guess yeah log I would pick on it's not - how ready so those those don't do anything - the",
    "start": "1251830",
    "end": "1257350"
  },
  {
    "text": "requested per se but and they don't provide a source of data but they they",
    "start": "1257350",
    "end": "1262930"
  },
  {
    "text": "change the way for DNS behaves so if they're gonna write a plug-in that you want to share then I would suggest that",
    "start": "1262930",
    "end": "1270880"
  },
  {
    "text": "you follow that best practice and you may want to break your plug-in you know may have some functionality you want to break it into several different plugins",
    "start": "1270880",
    "end": "1277210"
  },
  {
    "text": "in order to follow that but that's it it's it's a rough model there's nothing there's nothing in the code that's gonna",
    "start": "1277210",
    "end": "1282850"
  },
  {
    "text": "make that happen it's just it's just philosophy okay like I said for",
    "start": "1282850",
    "end": "1290950"
  },
  {
    "text": "functions in order to implement a plug-in name the name function literally",
    "start": "1290950",
    "end": "1297820"
  },
  {
    "text": "just returns the name super simple serve DNS that's the meaning one that does stuff with the request or the response",
    "start": "1297820",
    "end": "1304500"
  },
  {
    "text": "and then in it and set up in it is just what registers the the directive with",
    "start": "1304500",
    "end": "1312700"
  },
  {
    "text": "the it registers a directive with caddy and points it to the set up function",
    "start": "1312700",
    "end": "1318070"
  },
  {
    "text": "that has Caddy's parsing because it caddy actually is what parses the core file as it sees that directive it's",
    "start": "1318070",
    "end": "1324520"
  },
  {
    "text": "going to make a call to that set up function whatever set up function you provide it at an it time and then the set up is the thing that sort of gets",
    "start": "1324520",
    "end": "1331810"
  },
  {
    "text": "you ready to go so I have another example in that same repository the",
    "start": "1331810",
    "end": "1338590"
  },
  {
    "text": "learning or DNS repository that's an example plug-in that does something maybe not all that useful but who knows",
    "start": "1338590",
    "end": "1345840"
  },
  {
    "text": "basically if you've got a DNS request that goes out and returns a bunch of data then it will actually pick one out",
    "start": "1345840",
    "end": "1355570"
  },
  {
    "text": "of the many repeat of the many instances of a particular type of data so in this case it would take these",
    "start": "1355570",
    "end": "1362110"
  },
  {
    "text": "3a records and distill them down to one really just there because it it's sort",
    "start": "1362110",
    "end": "1370030"
  },
  {
    "text": "of a useful didactically useful thing all right so the first tips would fit on",
    "start": "1370030",
    "end": "1377380"
  },
  {
    "text": "a slide just return the name that's used when we're logging and things like that",
    "start": "1377380",
    "end": "1382450"
  },
  {
    "text": "so we need to know the name and as we go through that set up that go",
    "start": "1382450",
    "end": "1388210"
  },
  {
    "text": "you've got your init function which just registers the only one directive as a",
    "start": "1388210",
    "end": "1393540"
  },
  {
    "text": "DNS directive and tells it to call the setup function you'll notice the two",
    "start": "1393540",
    "end": "1398740"
  },
  {
    "text": "file names so by convention we put all of our setup stuff inside of echo we put",
    "start": "1398740",
    "end": "1405190"
  },
  {
    "text": "the sort of main meet of the plug-in in only one that go so please follow that",
    "start": "1405190",
    "end": "1410890"
  },
  {
    "text": "convention - especially if you want it to be accepted as a primary plug-in",
    "start": "1410890",
    "end": "1415990"
  },
  {
    "text": "without without us telling you to change it all right",
    "start": "1415990",
    "end": "1421000"
  },
  {
    "text": "the setup that go also has the setup function shockingly all it does is call",
    "start": "1421000",
    "end": "1426580"
  },
  {
    "text": "this parse function so the Cadi controller in this context it's essentially just a handle into the place",
    "start": "1426580",
    "end": "1432549"
  },
  {
    "text": "in the in the core file where your",
    "start": "1432549",
    "end": "1437590"
  },
  {
    "text": "directive appears and it's going to hand you it's gonna hand you sort of a utility class for parsing that out so we",
    "start": "1437590",
    "end": "1445870"
  },
  {
    "text": "call this parse function I'm not gonna get into that because it's long and hairy and not useful not relevant but",
    "start": "1445870",
    "end": "1452760"
  },
  {
    "text": "finally after it gets back the the struct that gets parsed out of there it",
    "start": "1452760",
    "end": "1459640"
  },
  {
    "text": "calls this add plug-in function so DNS server get config it's the deep dive I",
    "start": "1459640",
    "end": "1467890"
  },
  {
    "text": "hope you're already familiar somewhat with a core file core file has a bunch of stanzas a config internally in the",
    "start": "1467890",
    "end": "1474070"
  },
  {
    "text": "code kind of roughly maps too directly",
    "start": "1474070",
    "end": "1479380"
  },
  {
    "text": "to a stanza inside of a server block for a particular directive it's not a",
    "start": "1479380",
    "end": "1485020"
  },
  {
    "text": "one-to-one and there's some sort of subtlety and complexity there that we can talk about afterwards if somebody's",
    "start": "1485020",
    "end": "1490929"
  },
  {
    "text": "really interested but from from a thinking perspective you can think of it as almost",
    "start": "1490929",
    "end": "1495970"
  },
  {
    "text": "mapping directly to his own and hanging off of that config is that plug-in chain so remember that any request that comes",
    "start": "1495970",
    "end": "1502870"
  },
  {
    "text": "in gets routed based upon these stanzas to a particular or gets rerouted based",
    "start": "1502870",
    "end": "1509980"
  },
  {
    "text": "upon its its labels com example etc into",
    "start": "1509980",
    "end": "1514990"
  },
  {
    "text": "one of these stanzas and from there that has its own defined plug-in chain so this is sort of the mechanism of how",
    "start": "1514990",
    "end": "1521680"
  },
  {
    "text": "that happens is through these these configs so what we're doing here is we're telling we're grabbing the config and we're adding this plugin when we add",
    "start": "1521680",
    "end": "1529960"
  },
  {
    "text": "this plug-in actually we're adding a func and why in the world are we doing that well the reason is that this setup",
    "start": "1529960",
    "end": "1535450"
  },
  {
    "text": "happens actually during parsing time but we don't build that plug-in chain",
    "start": "1535450",
    "end": "1541440"
  },
  {
    "text": "actually until the DNS server itself is spun out and in order to build that",
    "start": "1541440",
    "end": "1546520"
  },
  {
    "text": "plug-in chain we actually just go through this and and call all of these these add plugins which you turn call",
    "start": "1546520",
    "end": "1552490"
  },
  {
    "text": "these functions so it's kind of like a delayed it's the instantiation this is",
    "start": "1552490",
    "end": "1558910"
  },
  {
    "text": "important and I call it out because some plugins like say metrics or the ready plugin they want to know about the other",
    "start": "1558910",
    "end": "1565900"
  },
  {
    "text": "plugins in the chain in which they exist and those won't actually necessarily be",
    "start": "1565900",
    "end": "1571420"
  },
  {
    "text": "available at the time you do your setup they'll be available later and so",
    "start": "1571420",
    "end": "1577180"
  },
  {
    "text": "there's a there's a bunch of event handlers that we get out of the Cadi framework and one of them is called on",
    "start": "1577180",
    "end": "1582790"
  },
  {
    "text": "startup so when when the actual server is starting up its gonna send an event",
    "start": "1582790",
    "end": "1588340"
  },
  {
    "text": "to each of the those who've read just read just get a callback for that event so if you need to know about the other",
    "start": "1588340",
    "end": "1595420"
  },
  {
    "text": "plugins in your chain you need to use the on startup callback for that all",
    "start": "1595420",
    "end": "1602260"
  },
  {
    "text": "right lots of details all right so the serve DNS this one I cannot fit on a slide so let's um let's actually it is I",
    "start": "1602260",
    "end": "1612100"
  },
  {
    "text": "have seven minutes I want to leave a couple minutes for Q&A",
    "start": "1612100",
    "end": "1619590"
  },
  {
    "text": "okay let's talk through this one because this is probably the more interesting one to people anyway serve DNS it takes",
    "start": "1621040",
    "end": "1628270"
  },
  {
    "text": "a context it takes a what we call a response writer and it takes a DNS message the DNS message here is the",
    "start": "1628270",
    "end": "1634690"
  },
  {
    "text": "actual DNS request that that was made and the response writer is essentially a",
    "start": "1634690",
    "end": "1640780"
  },
  {
    "text": "strop that will let you write back to the client socket directly if you want to sometimes okay so the typically these",
    "start": "1640780",
    "end": "1649750"
  },
  {
    "text": "first five or six lines here you'll see that almost the same thing in every sort of DNS you've got this this sort of",
    "start": "1649750",
    "end": "1656200"
  },
  {
    "text": "convenience struct called a request that we create and for some reason we always call it state and then you have this",
    "start": "1656200",
    "end": "1664210"
  },
  {
    "text": "check this is important so in in your in your in most plugins the first parameter",
    "start": "1664210",
    "end": "1669970"
  },
  {
    "text": "they take to their configuration is a list of zones so that if your overall",
    "start": "1669970",
    "end": "1675370"
  },
  {
    "text": "stanza say maybe handles five zones you want this particular plug-in to only",
    "start": "1675370",
    "end": "1680500"
  },
  {
    "text": "handle one of those five zones this is where you do that check so you won't even get here if your stands are your",
    "start": "1680500",
    "end": "1687430"
  },
  {
    "text": "primary standard doesn't doesn't take that zone but nonetheless if you if you",
    "start": "1687430",
    "end": "1692650"
  },
  {
    "text": "limp can limit those then this is the check and basically if it doesn't match",
    "start": "1692650",
    "end": "1697900"
  },
  {
    "text": "the zone it calls this next or failure I'll talk more about that in a second",
    "start": "1697900",
    "end": "1702970"
  },
  {
    "text": "but so so assuming that we we actually want to handle this request it's something that's of interest to us then",
    "start": "1702970",
    "end": "1709290"
  },
  {
    "text": "then then there's the meat of the function did this particular function as",
    "start": "1709290",
    "end": "1714460"
  },
  {
    "text": "you recall what it does is it looks at the response coming back and modifies it well it's not a back-end it's a mutator",
    "start": "1714460",
    "end": "1721390"
  },
  {
    "text": "as a mutator it has to see an in particular a response mutator it has to",
    "start": "1721390",
    "end": "1727540"
  },
  {
    "text": "see that response before it can do anything with it so we actually have a special kind of of DNS that response",
    "start": "1727540",
    "end": "1735460"
  },
  {
    "text": "writer this is an interface we have a special genus that the response writer called an on writer and what an on",
    "start": "1735460",
    "end": "1741670"
  },
  {
    "text": "writer does is when any of anybody calls the write function on it it just instead stuffs it in memory and doesn't write it",
    "start": "1741670",
    "end": "1748150"
  },
  {
    "text": "back to the client socket otherwise you'd end up writing twice back which you don't want to do",
    "start": "1748150",
    "end": "1754210"
  },
  {
    "text": "so we create an on writer and we just call them extra failure passing that new",
    "start": "1754210",
    "end": "1759820"
  },
  {
    "text": "response writer in instead of the original one we got we get back maybe an",
    "start": "1759820",
    "end": "1768460"
  },
  {
    "text": "error maybe not if you get an error back we just you just go along but but this",
    "start": "1768460",
    "end": "1773920"
  },
  {
    "text": "essentially is calling all of those plugins in the chain so now we've inserted ourselves in the processing we",
    "start": "1773920",
    "end": "1780640"
  },
  {
    "text": "haven't done anything yet to modify it we've just said hey we're interested in the result go figure out what to do",
    "start": "1780640",
    "end": "1786700"
  },
  {
    "text": "and it does we get back that that this response writer this new writer is going",
    "start": "1786700",
    "end": "1793810"
  },
  {
    "text": "to contain whatever message the up that the the later plugins in the in the",
    "start": "1793810",
    "end": "1799600"
  },
  {
    "text": "chain wrote so then we call this trim records which is does the actual",
    "start": "1799600",
    "end": "1805750"
  },
  {
    "text": "deduplication in this case and we write it back so you can see how we are one mutator and and we write to the to the",
    "start": "1805750",
    "end": "1812980"
  },
  {
    "text": "response writer that we got in actually it could also be a non writer we don't know it depends on what the user is configured and so we can get this sort",
    "start": "1812980",
    "end": "1819760"
  },
  {
    "text": "of stack of non writers that then that gets unwound as we tweak each one along",
    "start": "1819760",
    "end": "1826660"
  },
  {
    "text": "the way alright I'll take one more minute and I will talk about next or",
    "start": "1826660",
    "end": "1834820"
  },
  {
    "text": "failure I only want to mention this because you're gonna want to use this function it's a utility function and",
    "start": "1834820",
    "end": "1841230"
  },
  {
    "text": "it's it does more you know do you think you just like like oh just call the next",
    "start": "1841230",
    "end": "1846430"
  },
  {
    "text": "plug-in who cares and it does a little bit more than that what it does is in fact what is this so if if the next if",
    "start": "1846430",
    "end": "1857590"
  },
  {
    "text": "there is no next one defined it returns a sort of fail so that's that's all good we'd want to do that anyway so it does a little error handling from us but more",
    "start": "1857590",
    "end": "1864160"
  },
  {
    "text": "interesting is it actually handles our tracing so one of the the plugins in",
    "start": "1864160",
    "end": "1870600"
  },
  {
    "text": "core DNS is a distributed trace plug-in and so if you actually enable that and",
    "start": "1870600",
    "end": "1876550"
  },
  {
    "text": "you send a trace somewhere and you pull it up you can actually watch a request as it goes through different plugins and",
    "start": "1876550",
    "end": "1882090"
  },
  {
    "text": "we only trace selectively we don't trace every single",
    "start": "1882090",
    "end": "1887220"
  },
  {
    "text": "request unless you configure that way typically it's terrible for performance so if you're enabling this anything but",
    "start": "1887220",
    "end": "1892919"
  },
  {
    "text": "the bug you want to do like one in 10,000 right so this this kind of takes care of that for you and keeps the",
    "start": "1892919",
    "end": "1899160"
  },
  {
    "text": "tracing going even if without you having to do any extra work all right so that",
    "start": "1899160",
    "end": "1906720"
  },
  {
    "text": "is actually it for how you create and you plug-in yay so wow I gotta put them",
    "start": "1906720",
    "end": "1916020"
  },
  {
    "text": "that back on the screen you can find my",
    "start": "1916020",
    "end": "1921419"
  },
  {
    "text": "question yes all right so you don't have",
    "start": "1921419",
    "end": "1927000"
  },
  {
    "text": "to remember all of this there is a how-to on the website the coordinates at",
    "start": "1927000",
    "end": "1935760"
  },
  {
    "text": "i/o website it's not great probably should be updated but it's there",
    "start": "1935760",
    "end": "1941549"
  },
  {
    "text": "that's where accordion is github is recently released a book with cricket",
    "start": "1941549",
    "end": "1946890"
  },
  {
    "text": "Lou called learning core DNS all of these examples and everything there's",
    "start": "1946890",
    "end": "1952620"
  },
  {
    "text": "actually a lot more detail in the book if you're interested in this of course with a lot of other stuff and cricket",
    "start": "1952620",
    "end": "1958830"
  },
  {
    "text": "works for Infoblox and they are giving away 60 copies of the book tomorrow so if you go there quick you'll be there",
    "start": "1958830",
    "end": "1965309"
  },
  {
    "text": "to sign them too and if you don't get there in time then they're giving away popcorn to like caramel corn and stuff",
    "start": "1965309",
    "end": "1973140"
  },
  {
    "text": "right good stuff if you want I can't be there unfortunately but if you want me to sign it I'm happy to do that if you",
    "start": "1973140",
    "end": "1979140"
  },
  {
    "text": "track me down at the next session tomorrow at 3:20 and you can always",
    "start": "1979140",
    "end": "1985080"
  },
  {
    "text": "reach us on slack we are actually very friendly and easily easy to find so",
    "start": "1985080",
    "end": "1991250"
  },
  {
    "text": "that's it any questions and can I get a volunteer to run the microphone around because I don't have a",
    "start": "1991250",
    "end": "1998130"
  },
  {
    "text": "track host no volunteers",
    "start": "1998130",
    "end": "2004010"
  },
  {
    "text": "how about questions okay you might not need you there doesn't seem to be any question any yeah",
    "start": "2004010",
    "end": "2013629"
  },
  {
    "text": "does that mean what is the relation",
    "start": "2013780",
    "end": "2024020"
  },
  {
    "text": "between the relationship between cordials and cube DNS so cubed in us is",
    "start": "2024020",
    "end": "2030940"
  },
  {
    "text": "where DNS has replaced cube DNS as the primary of the default in cluster DNS",
    "start": "2030940",
    "end": "2036980"
  },
  {
    "text": "server so Gordian ass is a general-purpose do not authoritative DNS server and cube Geonosis only built for",
    "start": "2036980",
    "end": "2044860"
  },
  {
    "text": "specifically to be used in in kubernetes um one of the issues with cube DMS",
    "start": "2044860",
    "end": "2051260"
  },
  {
    "text": "there's a number of them but one is that it's quite a bit more complicated you've got like three different containers",
    "start": "2051260",
    "end": "2056810"
  },
  {
    "text": "running in the pod you've got DNS mask you've got the cube DNS itself and",
    "start": "2056810",
    "end": "2062510"
  },
  {
    "text": "you've got a sidecar for any metrics and things like that all of that's built into Cordy and ass there's different",
    "start": "2062510",
    "end": "2070190"
  },
  {
    "text": "scaling properties for both of them but they both in kubernetes essentially",
    "start": "2070190",
    "end": "2075408"
  },
  {
    "text": "serve the same function it's just with 40 of us you can also customize your core file to do all kinds",
    "start": "2075409",
    "end": "2080658"
  },
  {
    "text": "of other things if you want to yes so",
    "start": "2080659",
    "end": "2101300"
  },
  {
    "text": "that's an example of how you can if you had a very specific set of requirements that you wanted from a DNS server and",
    "start": "2101300",
    "end": "2109190"
  },
  {
    "text": "you did not want the the people using that or the systems and that's gonna be on to be able to do anything about other",
    "start": "2109190",
    "end": "2116150"
  },
  {
    "text": "than what you exposed to these command lines like either because it you don't want the complexity of having to support them or whatever it is right",
    "start": "2116150",
    "end": "2122270"
  },
  {
    "text": "it lets you it lets you sort of not have to do much work and actually build a",
    "start": "2122270",
    "end": "2128360"
  },
  {
    "text": "fairly functional DNS server",
    "start": "2128360",
    "end": "2133150"
  },
  {
    "text": "I'm are you asking are we looking for people who have built those things Oh",
    "start": "2143430",
    "end": "2150270"
  },
  {
    "text": "dynamic plugins so there's two things I would like to do but it's not",
    "start": "2153730",
    "end": "2159970"
  },
  {
    "text": "necessarily a priority and also add complexity one is dynamic loading of plugins sure the other is dynamic",
    "start": "2159970",
    "end": "2166810"
  },
  {
    "text": "ordering of plugins and so there's no reason technically why we can't order",
    "start": "2166810",
    "end": "2172090"
  },
  {
    "text": "them however you put you know however you want it's just backwards",
    "start": "2172090",
    "end": "2177400"
  },
  {
    "text": "compatibility first of all what you know the most natural way to do that would be take them in the order they're in the",
    "start": "2177400",
    "end": "2182859"
  },
  {
    "text": "they're listed in the stanza but that's gonna screw everybody backwards with backwards compatibility another way",
    "start": "2182859",
    "end": "2188950"
  },
  {
    "text": "would be to you know separately list out the order which is awkward so we sort of haven't had a real need and so and and",
    "start": "2188950",
    "end": "2196300"
  },
  {
    "text": "and there's issues with it so we haven't really pursued it any other question all right well thank",
    "start": "2196300",
    "end": "2208030"
  },
  {
    "text": "you for bearing with me with the with the awkwardness of going back and forth",
    "start": "2208030",
    "end": "2213280"
  },
  {
    "text": "and finding your way down here but have a great I have a great rest your rest",
    "start": "2213280",
    "end": "2218950"
  },
  {
    "text": "your cute card and enjoy the party tonight [Applause]",
    "start": "2218950",
    "end": "2226050"
  }
]