[
  {
    "text": "[Music] thank you Kevin",
    "start": "6990",
    "end": "13209"
  },
  {
    "text": "my name is Simon as I said I work as an infrastructure lead a company called Shopify based out of Canada",
    "start": "13209",
    "end": "19349"
  },
  {
    "text": "Shopify just as a way of introduction is a company that powers a fairly large",
    "start": "19349",
    "end": "24640"
  },
  {
    "text": "amount of online commerce actually both here in Scandinavia but also in North America so if you bought something",
    "start": "24640",
    "end": "30880"
  },
  {
    "text": "that's not been on Amazon there's a good probability that you may have been through a Shopify store and use some of",
    "start": "30880",
    "end": "37180"
  },
  {
    "text": "the infrastructure that we're going to talk about today the talk today is going to be a fairly high level and I'm gonna",
    "start": "37180",
    "end": "43269"
  },
  {
    "text": "be talking a lo of the architecture that we built at Shopify to support these",
    "start": "43269",
    "end": "49449"
  },
  {
    "text": "very very large sales that we see from some of the largest or biggest American celebrities and some of the largest",
    "start": "49449",
    "end": "55480"
  },
  {
    "text": "brands both in Europe and also in North America so we're gonna be talking about over especially the architecture that",
    "start": "55480",
    "end": "61539"
  },
  {
    "text": "we've evolved over the past five years and we won't go super deep into any particular point but rather give a",
    "start": "61539",
    "end": "67630"
  },
  {
    "text": "comprehensive overview of all the different components how they fit together and hopefully inspire something that I think can be leveraged in a lot",
    "start": "67630",
    "end": "74170"
  },
  {
    "text": "of other companies especially SAS companies that can have a similar architecture to ours",
    "start": "74170",
    "end": "80940"
  },
  {
    "text": "clickers having trouble so Shopify is a",
    "start": "87140",
    "end": "93920"
  },
  {
    "text": "company that helps people sell both online and in many other places and about five years ago we faced a bit of a",
    "start": "93920",
    "end": "101240"
  },
  {
    "text": "fork in the road we were starting to see these customers that were sort of online",
    "start": "101240",
    "end": "106370"
  },
  {
    "text": "first when retailers went online about 7 8 10 years ago",
    "start": "106370",
    "end": "111770"
  },
  {
    "text": "often they'd had a physical presence and then moved online but we were starting to see a lot more customers that started",
    "start": "111770",
    "end": "119270"
  },
  {
    "text": "with an online presence and they also started to require new ways of selling with social media becoming very very big",
    "start": "119270",
    "end": "126710"
  },
  {
    "text": "over the past the past decade and especially five years ago smartphones were out in everyone's hands and",
    "start": "126710",
    "end": "132890"
  },
  {
    "text": "Instagram Facebook Twitter and so on had become quite large and dissin able new ways of selling online that people",
    "start": "132890",
    "end": "139220"
  },
  {
    "text": "hadn't quite been able to do in the past what we call this a flash sale and yeah",
    "start": "139220",
    "end": "145220"
  },
  {
    "text": "idea of a flash sale is that you announce a product sometimes minutes in advance sometimes days in advance",
    "start": "145220",
    "end": "150890"
  },
  {
    "text": "sometimes hours in advance that you're going to release some kind of exclusive product at this day and time and as you",
    "start": "150890",
    "end": "156739"
  },
  {
    "text": "can imagine that can drive an astonishing amount of traffic to one site in from just one minute to the",
    "start": "156739",
    "end": "162830"
  },
  {
    "text": "other it's one minute before noon and everything is good but at noon you have",
    "start": "162830",
    "end": "167840"
  },
  {
    "text": "hundreds of thousands of people coming in trying to buy some of the same products at the same time placing an",
    "start": "167840",
    "end": "174019"
  },
  {
    "text": "enormous strain on the system you can imagine this from superball",
    "start": "174019",
    "end": "179390"
  },
  {
    "text": "Kylie Jenner if some of you know her famous from for being famous and she's",
    "start": "179390",
    "end": "185150"
  },
  {
    "text": "out of the Kardashian family selling lipstick and she can drive a very amount enormous amount of traffic such as good",
    "start": "185150",
    "end": "190250"
  },
  {
    "text": "and Kanye can do that as well so about five years ago is not these very large",
    "start": "190250",
    "end": "195290"
  },
  {
    "text": "Super Bowls and things like that that we're starting to use his way of selling but rather still customers that could",
    "start": "195290",
    "end": "201680"
  },
  {
    "text": "drive a very enormous amount of traffic and we were faced with a fork in the road do we become a company that tries",
    "start": "201680",
    "end": "208760"
  },
  {
    "text": "to support these sales or do we just tell them to go and find another",
    "start": "208760",
    "end": "214760"
  },
  {
    "text": "platform a platform that actually didn't exist but it's a very hard thing to be profitable from takes thousands of",
    "start": "214760",
    "end": "221060"
  },
  {
    "text": "engineering hours to be able to scale to these sales when you have an architected for it from day one we chose the path of",
    "start": "221060",
    "end": "230080"
  },
  {
    "text": "trying to support these we chose to see these sales as a way to identify bottlenecks and it's a bit of a canary",
    "start": "230080",
    "end": "236959"
  },
  {
    "text": "in a coal mine as to what it's going to break next the flash sales of today tell us something",
    "start": "236959",
    "end": "242030"
  },
  {
    "text": "about what the traffic is going to look like one or two years from now this was",
    "start": "242030",
    "end": "247220"
  },
  {
    "text": "what wrong direction this was such a powerful decision at the time and so important to our CEO who's very",
    "start": "247220",
    "end": "254209"
  },
  {
    "text": "technical that he wrote an internal essay on why we support flash sales this",
    "start": "254209",
    "end": "260780"
  },
  {
    "text": "is really important in our company philosophy that we want to as in the face of adversity become stronger and",
    "start": "260780",
    "end": "267729"
  },
  {
    "text": "not weaker or just not use it as an opportunity to grow when something bad",
    "start": "267729",
    "end": "273500"
  },
  {
    "text": "happens we want to come out stronger and he wrote an essay about why flash sales were such a case we have a very strong",
    "start": "273500",
    "end": "279200"
  },
  {
    "text": "culture internally of trying to inject chaos into various parts of the organization and try to come out",
    "start": "279200",
    "end": "285169"
  },
  {
    "text": "stronger as a result if you drop a piece of glass it breaks if you drop a rock",
    "start": "285169",
    "end": "290630"
  },
  {
    "text": "it's indifferent but what can you drop that becomes stronger as a result you know if you go down to the gym you run",
    "start": "290630",
    "end": "296840"
  },
  {
    "text": "on a treadmill you come back a couple days later and you can run further and faster how can you build software in",
    "start": "296840",
    "end": "302840"
  },
  {
    "text": "that way and flash sales was such a thing for our organization it was a way for our infrastructure to become",
    "start": "302840",
    "end": "308300"
  },
  {
    "text": "stronger just a couple before we get into the meat of the talk and with this",
    "start": "308300",
    "end": "314960"
  },
  {
    "text": "preface of how and how important flash sales have been to the history of our application here's some of the numbers",
    "start": "314960",
    "end": "321200"
  },
  {
    "text": "to keep in the back of your head for the scale that we're running at we support about half a million merchants paying merchants all over the world",
    "start": "321200",
    "end": "328250"
  },
  {
    "text": "we processes almost six billion dollars in the last quarter we run up to 80,000",
    "start": "328250",
    "end": "335330"
  },
  {
    "text": "requests per second to our Ruby on Rails processes we do about 42 place deploys a",
    "start": "335330",
    "end": "342050"
  },
  {
    "text": "day to this and we have over 2,000 employees a large fraction of those engineers deploying all the time the",
    "start": "342050",
    "end": "350120"
  },
  {
    "text": "mental model that I wanted to incorporate for this talk is that we have about three different tiers that going to talk about we have the",
    "start": "350120",
    "end": "356000"
  },
  {
    "text": "trafficked here with all the traffic coming in and which is responsible for getting your requests from your home",
    "start": "356000",
    "end": "361460"
  },
  {
    "text": "network all the way to our infrastructure serving back to page that you're requesting we're gonna be talking about the application and the data it's",
    "start": "361460",
    "end": "367460"
  },
  {
    "text": "here that work together to serve those pages and we're gonna be talking a bit about some of these arrows how do we",
    "start": "367460",
    "end": "373100"
  },
  {
    "text": "failover between regions with zero downtime how do we shard our application",
    "start": "373100",
    "end": "378590"
  },
  {
    "text": "and how do we balance those shards as some shops grow bigger so that Kanye and Kylie are not on the same same chart but",
    "start": "378590",
    "end": "384740"
  },
  {
    "text": "rather spread out and how do we get from the traffic layer into your application layer and failover regions how does all",
    "start": "384740",
    "end": "390380"
  },
  {
    "text": "of this stuff work together you should have a pretty good idea for how that works for us by the end of this talk",
    "start": "390380",
    "end": "395590"
  },
  {
    "text": "we're going to be starting by talking about the traffic tear as I mentioned the traffic tear to me is the layer that",
    "start": "395590",
    "end": "401870"
  },
  {
    "text": "is responsible for how to get the request from A to B in this case from your home network to our network we're",
    "start": "401870",
    "end": "408860"
  },
  {
    "text": "going to be talking about how we do global routing because this is something that we face a lot of debate with internally we're going to be talking",
    "start": "408860",
    "end": "415100"
  },
  {
    "text": "about a technology called open resti which is absolutely incredible but quite underused we're going to be talking",
    "start": "415100",
    "end": "420950"
  },
  {
    "text": "about how we protect ourselves from bots doing sales how we serve cache hits from the load balancers instead of the",
    "start": "420950",
    "end": "426320"
  },
  {
    "text": "application tier orders of magnitudes faster and how we throttle the checkouts doing very very large sales to",
    "start": "426320",
    "end": "435530"
  },
  {
    "text": "understand how your request gets from the customer to our data centers or",
    "start": "435530",
    "end": "440600"
  },
  {
    "text": "regions as we call them we need to understand a little bit about how the internet works this is a very high-level overview of how the internet works and",
    "start": "440600",
    "end": "447470"
  },
  {
    "text": "how their routes propagate if you are Facebook or Google and you have one",
    "start": "447470",
    "end": "453020"
  },
  {
    "text": "domain and not a bunch of customers pointing their dns to your domain then you can do a lot of really complex",
    "start": "453020",
    "end": "459140"
  },
  {
    "text": "traffic engineering at the dns layer but when you have about a million domains from half a million different customers",
    "start": "459140",
    "end": "464780"
  },
  {
    "text": "pointing to your IP you have very limited amount of control at your traffic level you only have the IPS that",
    "start": "464780",
    "end": "470720"
  },
  {
    "text": "your customer that the customers are pointing us to you do can't control anything at the DNS level so we did",
    "start": "470720",
    "end": "475790"
  },
  {
    "text": "something that hasn't had a lot of use in the industry for those of you who",
    "start": "475790",
    "end": "481010"
  },
  {
    "text": "know about networks it's called BGP TCP any caste and I'll explain here how it works how does traffic get from the",
    "start": "481010",
    "end": "488210"
  },
  {
    "text": "customer to our regions in with this TCP BGP",
    "start": "488210",
    "end": "493849"
  },
  {
    "text": "anycast so what happens is that Shopify has eyepiece as you can see here we have this slash 24 on this block of 255 IPs",
    "start": "493849",
    "end": "502039"
  },
  {
    "text": "and our regions will announce to the Internet that these IPS can be routed by",
    "start": "502039",
    "end": "510110"
  },
  {
    "text": "these regions so if the ISP sees that IP it should be routed to the Shopify region so what Shopify will do is that we will",
    "start": "510110",
    "end": "516740"
  },
  {
    "text": "connect our routers into our ayahs piece and say hey we own these IPS to our I Jason a is piece so we may have let's",
    "start": "516740",
    "end": "522680"
  },
  {
    "text": "say two ISPs do we connect directly to from our regions and we tell them if you encounter these IP send them to us",
    "start": "522680",
    "end": "528259"
  },
  {
    "text": "because that is Shopify traffic for some Shopify store those eyes those eyes piece then tell their adjacent neighbors",
    "start": "528259",
    "end": "535129"
  },
  {
    "text": "that the ISPs that they're plugged into that they can route those IPs and they know how to route them and like that",
    "start": "535129",
    "end": "540470"
  },
  {
    "text": "it's propagating through this entire rap you can think of this as a bit of a gossip algorithm where every neighbour",
    "start": "540470",
    "end": "546439"
  },
  {
    "text": "or every our ISP is constantly telling its neighboring ISPs which IP as it knows how to route this entire",
    "start": "546439",
    "end": "552980"
  },
  {
    "text": "propagation - you can imagine ISPs ranging from Asia to Europe to America",
    "start": "552980",
    "end": "558110"
  },
  {
    "text": "to South America of DS IPS that entire internet broadcast takes about seven minutes which is either amazing or very",
    "start": "558110",
    "end": "566449"
  },
  {
    "text": "slow depending on where you're coming from so now we have this connected web how does that customer then get their",
    "start": "566449",
    "end": "573529"
  },
  {
    "text": "traffic to the region while they make a request right so in this case they're going to do a walrus tour and there it's",
    "start": "573529",
    "end": "581360"
  },
  {
    "text": "pointing to the Shopify owned IP that is part of that block that IP block that the region's are announcing so it's",
    "start": "581360",
    "end": "587689"
  },
  {
    "text": "going to our ISP and then it either needs to turn left or right depending on which region is closest to that ISP in",
    "start": "587689",
    "end": "594319"
  },
  {
    "text": "this case we're going right at least from where I'm standing and the request",
    "start": "594319",
    "end": "599720"
  },
  {
    "text": "is then routed to the region this works really really well for when you're pointing all these customer domains",
    "start": "599720",
    "end": "604910"
  },
  {
    "text": "directly to IPs and you don't have too much control over it so now we know how",
    "start": "604910",
    "end": "610730"
  },
  {
    "text": "the traffic gets to Shopify now I want to talk a little bit about what happens when that request enters our network we",
    "start": "610730",
    "end": "617149"
  },
  {
    "text": "use the technology called open rusty open rusty is perhaps one of the",
    "start": "617149",
    "end": "622579"
  },
  {
    "text": "best editions we've done to our technology stack in the past four years it is it enables you to script your load",
    "start": "622579",
    "end": "630319"
  },
  {
    "text": "balancers your nginx load balancers with Lua you can do pretty much everything",
    "start": "630319",
    "end": "635329"
  },
  {
    "text": "that you desire you can customize your load balancing algorithm you can redirect to other data centers you can change the headers you can inspect",
    "start": "635329",
    "end": "642290"
  },
  {
    "text": "cookies you can serve different content based on requests and cookies you can do external networks you can do all of this",
    "start": "642290",
    "end": "648860"
  },
  {
    "text": "stuff all in the comfort of inside of nginx which is extremely fast and extremely stable I think open resti is",
    "start": "648860",
    "end": "656480"
  },
  {
    "text": "quite underrated and I don't hear quite enough talk about it because it is so stable so fast and so scalable I want to",
    "start": "656480",
    "end": "664339"
  },
  {
    "text": "talk about a couple of modules that we built with this it really has become our hammer and nail to solve a lot of traffic related issues and we've gotten",
    "start": "664339",
    "end": "671569"
  },
  {
    "text": "away with waiting off a lot of D doses and doses just from simple Liuba modules",
    "start": "671569",
    "end": "678009"
  },
  {
    "text": "there's really powerful to be able to script your low balancing tier and here's just a very quick example of what",
    "start": "678009",
    "end": "684769"
  },
  {
    "text": "it looks like this is a very bare-bones nginx config that is just listening on a port and in this case serving some",
    "start": "684769",
    "end": "689779"
  },
  {
    "text": "content by Lua and you can do all kinds of things here right you can do customized low balancing algorithms like",
    "start": "689779",
    "end": "695480"
  },
  {
    "text": "you can imagine doing Network IO in this block you could do pretty much anything",
    "start": "695480",
    "end": "700540"
  },
  {
    "text": "so one of the modules I want to explain is that we have this big problem of bots",
    "start": "700540",
    "end": "706059"
  },
  {
    "text": "there is surprisingly as we learned there is a very large secondary market",
    "start": "706059",
    "end": "712639"
  },
  {
    "text": "for sneakers so there's a lot of people out there sneaker heads and they collect sneakers and when to get these sneakers",
    "start": "712639",
    "end": "719809"
  },
  {
    "text": "you need to be there when the sale happens and you need to be really lucky because there's limited inventory maybe",
    "start": "719809",
    "end": "725179"
  },
  {
    "text": "there is you know two hundred thousand people competing for 5,000 pairs of shoes when that happens there is an",
    "start": "725179",
    "end": "731720"
  },
  {
    "text": "economy here where you can buy these shoes and if you buy them you don't wear them you sell them on eBay for maybe two",
    "start": "731720",
    "end": "738410"
  },
  {
    "text": "times three times four times the price of course merchants don't want that they don't want secondhand market charging",
    "start": "738410",
    "end": "743720"
  },
  {
    "text": "more than they were and not controlling the customer experience so they were asking us to come up with a way to",
    "start": "743720",
    "end": "748850"
  },
  {
    "text": "detect these bots and banned em so we took out our hammer and nail open rusty",
    "start": "748850",
    "end": "755119"
  },
  {
    "text": "and built some modules helped us solve this problem the CAF Galaga module is one that we've had for",
    "start": "755119",
    "end": "760490"
  },
  {
    "text": "a long time every single request that comes in to Shopify is locked into Kafka a distributed message bus and all the",
    "start": "760490",
    "end": "766970"
  },
  {
    "text": "messages there are relayed into our data warehouse but we can also consume these messages in real time and make decisions",
    "start": "766970",
    "end": "773000"
  },
  {
    "text": "about them so you can imagine that there's a Catholic luster here and for a checkout we log that check out into",
    "start": "773000",
    "end": "779270"
  },
  {
    "text": "Kafka then there's a stream a stream aggregator and this is the baud Squasher",
    "start": "779270",
    "end": "784970"
  },
  {
    "text": "it listens on Kafka and tries to in all of these different events see whether there's a suspicious pattern is there",
    "start": "784970",
    "end": "791810"
  },
  {
    "text": "something that doesn't look like a human is it refreshing a page very very rapidly in a way that a human in a Chrome browser would never do or is",
    "start": "791810",
    "end": "799070"
  },
  {
    "text": "there something else at stake this is fairly sophisticated algorithm to try to figure out what is going on it is not an",
    "start": "799070",
    "end": "805820"
  },
  {
    "text": "open or SD module it's just a simple consumer I think written in go in this case and when it finds something an IP",
    "start": "805820",
    "end": "811340"
  },
  {
    "text": "or user rating or something else that looks like a bot it can tell the rule banner which is written in engine",
    "start": "811340",
    "end": "817310"
  },
  {
    "text": "accents just a simple DSL that allows you to ban-ban various patterns very",
    "start": "817310",
    "end": "824120"
  },
  {
    "text": "simple patterns like user agents eyepiece and the bot cog washer can then based on the assumptions made from the",
    "start": "824120",
    "end": "829340"
  },
  {
    "text": "CAFTA stream ban an IP or something else with the rule banner on all the low bouncers now we can reject these BOTS in",
    "start": "829340",
    "end": "835460"
  },
  {
    "text": "few microseconds and people can write very sophisticated algorithms that the",
    "start": "835460",
    "end": "840590"
  },
  {
    "text": "bot squashing layer to ban these BOTS very rapidly when we deployed this we saw a fairly sizable decrease in the",
    "start": "840590",
    "end": "847010"
  },
  {
    "text": "amount requests coming to Shopify and we have to turn it off again because we're so flustered like this was way too many",
    "start": "847010",
    "end": "852110"
  },
  {
    "text": "but turns out that a very very large fraction of our traffic was actually just bought another thing we do with",
    "start": "852110",
    "end": "859190"
  },
  {
    "text": "open rest is that we serve cache hits so we can if you go and browse a Shopify product there's probably someone else",
    "start": "859190",
    "end": "865130"
  },
  {
    "text": "maybe browsing the same page at the same product later so we can cache that if nothing changes we can go to the",
    "start": "865130",
    "end": "871820"
  },
  {
    "text": "application tier and serve that cache hit which is stored in memcache but we can do this orders of magnitude faster",
    "start": "871820",
    "end": "877490"
  },
  {
    "text": "if we do that the nginx layer layer just because of the overhead of the Ruby VM and a whole stack that we have there",
    "start": "877490",
    "end": "883460"
  },
  {
    "text": "which is very difficult to optimize at this point so you can imagine a request coming in it's getting some collection",
    "start": "883460",
    "end": "890180"
  },
  {
    "text": "of full filled with walrus products and you have a cache miss you get to the web",
    "start": "890180",
    "end": "896240"
  },
  {
    "text": "application tier but when you are fulfilling that request getting all the data from the data stores and rendering",
    "start": "896240",
    "end": "901940"
  },
  {
    "text": "requests back to the user we're also filling the recruitment filling the request into the cache to someone else conservative really really",
    "start": "901940",
    "end": "907040"
  },
  {
    "text": "simple stuff nothing novel but on the next hit what can happen is that each cache which is an open or SD module will",
    "start": "907040",
    "end": "913580"
  },
  {
    "text": "check the cache directly at the low bouncing tier this can this is fairly simple right so now we can get it",
    "start": "913580",
    "end": "919430"
  },
  {
    "text": "directly from the cache and not even touching the application tier making is able to handle orders of magnitude more",
    "start": "919430",
    "end": "925220"
  },
  {
    "text": "requests per second with a fairly small addition to the stack this is more complex than it looks at least for our",
    "start": "925220",
    "end": "930920"
  },
  {
    "text": "stack because generating and cache keys and things like that has turned out to be quite complex but for smaller",
    "start": "930920",
    "end": "936110"
  },
  {
    "text": "applications this might be quite simple we don't have this turned on for everyone but we do have this turned on for some larger merchants and the reason",
    "start": "936110",
    "end": "942890"
  },
  {
    "text": "why this is hard for us to turn on is that people can on Shopify can customize their themes completely and getting out",
    "start": "942890",
    "end": "947930"
  },
  {
    "text": "to play very well with caching has turned out to be more difficult than we thought the last one I want to talk",
    "start": "947930",
    "end": "954260"
  },
  {
    "text": "about is the checkout throttle some merchants come in and can drive so much",
    "start": "954260",
    "end": "959420"
  },
  {
    "text": "traffic that we can't handle the amount of Rights that they can do on a checkout and you can't cash a write so you need",
    "start": "959420",
    "end": "964670"
  },
  {
    "text": "to do something at some point there's so many rides going into the database for Eddy adding the checkout or running",
    "start": "964670",
    "end": "970250"
  },
  {
    "text": "scripts that modify the cart all these kinds of very complex are operations that happen when you're checking out",
    "start": "970250",
    "end": "975710"
  },
  {
    "text": "getting shipping rates processing payments that we have to throttle it very few merchants ever hit this I would",
    "start": "975710",
    "end": "982580"
  },
  {
    "text": "say probably less than 10 or 20 unique merchants in the lifetime of Shopify have ever hit this throttle but when it",
    "start": "982580",
    "end": "988040"
  },
  {
    "text": "does happen it's very important that all the shops that are on the same chart as you do not suffer under your sale so",
    "start": "988040",
    "end": "996530"
  },
  {
    "text": "what we do is that when a request comes in for a very busy store to the checkout we will put that request into a queue",
    "start": "996530",
    "end": "1003310"
  },
  {
    "text": "again happening at the low balancing tier now the while you're in the queue",
    "start": "1003310",
    "end": "1008500"
  },
  {
    "text": "you're redirected to a wait area which is completely customizable for the Virgin again we strive as hard as possible to not put people in this at",
    "start": "1008500",
    "end": "1014950"
  },
  {
    "text": "all but we need to have a safeguard in case it does happen which control the rate of which we leak from the queue",
    "start": "1014950",
    "end": "1021340"
  },
  {
    "text": "with a throttle and then when the throttle is done we will redirect you back to the checkout",
    "start": "1021340",
    "end": "1026670"
  },
  {
    "text": "now we've talked a little bit about the traffic tear some of the opener rst modulus we do and how traffic gets all",
    "start": "1026670",
    "end": "1032350"
  },
  {
    "text": "the way to Shopify now I want to dig a bit into how does our application layer work and how does our data tier work I'm",
    "start": "1032350",
    "end": "1038110"
  },
  {
    "text": "gonna talk about both of them at the same time because they're quite intermingle a very important concept for",
    "start": "1038110",
    "end": "1046270"
  },
  {
    "text": "us is what we call a pod a cut some companies make hole there's a shard but a shard to us means a my sequel I'd",
    "start": "1046270",
    "end": "1053020"
  },
  {
    "text": "like a relational Sharpe iPod to us encompasses more a part to us is a small",
    "start": "1053020",
    "end": "1058330"
  },
  {
    "text": "Shopify small isolated Shopify that can run anywhere in the world can run in a",
    "start": "1058330",
    "end": "1063430"
  },
  {
    "text": "cloud it can run in the data center can run anywhere so a pod is an isolated unit of Shopify",
    "start": "1063430",
    "end": "1068860"
  },
  {
    "text": "that would one or more shops you can look at it like this if we have let's say pod 7 part 2 and part 14 they all",
    "start": "1068860",
    "end": "1076060"
  },
  {
    "text": "have a bunch of shops on them these shops don't talk to each other the pods don't talk to each other they're completely sharted and isolated from",
    "start": "1076060",
    "end": "1082420"
  },
  {
    "text": "each other giving us some very nice scaling capabilities this is a fundamental isolate isolation principle",
    "start": "1082420",
    "end": "1089110"
  },
  {
    "text": "that we call the shop isolation principle all shops must be isolated from each other if you want to do something cross shop you have to use the",
    "start": "1089110",
    "end": "1095920"
  },
  {
    "text": "data warehouse or some other mechanism because doing things across hundreds of shops hundreds of pods in multiple",
    "start": "1095920",
    "end": "1101470"
  },
  {
    "text": "region is not something that's going to scale at least to do in real time so another thing I want you to note here is",
    "start": "1101470",
    "end": "1107890"
  },
  {
    "text": "that these pots are not at the same size some have more shops than others and we're gonna address that problem later",
    "start": "1107890",
    "end": "1113050"
  },
  {
    "text": "but first I want to look at what's in a pod so a pod is one or more stores what does that mean well it means that all",
    "start": "1113050",
    "end": "1118690"
  },
  {
    "text": "the stateful layers of that pod are isolated so they if they're a pod has a my sequel it has a memcache instance it",
    "start": "1118690",
    "end": "1125590"
  },
  {
    "text": "has writers instances and it has cron workers that are doing periodic work so all the stateful data of all of these",
    "start": "1125590",
    "end": "1131260"
  },
  {
    "text": "shops is shared between or is isolated from all the other pods in all the other shops now there is a tier that is well",
    "start": "1131260",
    "end": "1140100"
  },
  {
    "text": "that is shared and those are the workers so when a web request is handled or a job is handle it's shared between the",
    "start": "1140100",
    "end": "1146800"
  },
  {
    "text": "pods now why is that why would that tier be shared the reason is because of the",
    "start": "1146800",
    "end": "1152230"
  },
  {
    "text": "sales remember the profits of this is that we have to architect for these massive sales and",
    "start": "1152230",
    "end": "1157540"
  },
  {
    "text": "pod too is experiencing a massive sale some kind of launch then they may need",
    "start": "1157540",
    "end": "1162670"
  },
  {
    "text": "to be able to get perhaps sixty to seventy percent of all the worker capacity to handle that sale so the",
    "start": "1162670",
    "end": "1168730"
  },
  {
    "text": "stateless stuff is shared and the stateful stuff is isolated by pod now",
    "start": "1168730",
    "end": "1174910"
  },
  {
    "text": "why wouldn't you have an auto scaler for this this sounds like the canonical way it's a thing to solve with a cloud",
    "start": "1174910",
    "end": "1180550"
  },
  {
    "text": "autoscaler right so when you have a sale you just start spending up more instances the problem is that spinning",
    "start": "1180550",
    "end": "1186610"
  },
  {
    "text": "up those instances is going to take tens of seconds and during that time you're going to be serving a lot of errors and",
    "start": "1186610",
    "end": "1192670"
  },
  {
    "text": "have a very bad experience for all the customers coming in so we don't do that and maybe one day we can maybe we can do",
    "start": "1192670",
    "end": "1198940"
  },
  {
    "text": "some really crazy things so soda we can spin up these workers fast enough with an auto scaler but today it's not the",
    "start": "1198940",
    "end": "1204790"
  },
  {
    "text": "case another stainless thing that is shared is the traffic here that we talked about before where all the open",
    "start": "1204790",
    "end": "1210820"
  },
  {
    "text": "rusty modules are running and the low bouncing is happening another tool that",
    "start": "1210820",
    "end": "1217810"
  },
  {
    "text": "I just want to introduce while we're here to test the stay list here is that we have a load testing tool called",
    "start": "1217810",
    "end": "1222820"
  },
  {
    "text": "Genghis what Genghis does is that it runs Lua scripts that define a flow through our application and allow us to",
    "start": "1222820",
    "end": "1229570"
  },
  {
    "text": "test with an astonishing amount of load using cloud instances what happens when we send for example 10,000 people per",
    "start": "1229570",
    "end": "1236800"
  },
  {
    "text": "minute through the checkout it can you can customize this as much as you want with Lua scripts that allow you to say",
    "start": "1236800",
    "end": "1242980"
  },
  {
    "text": "things like oh this customer is gonna go to the product page you're gonna browse around a bit they're gonna be a little bit indecisive then we're gonna add some",
    "start": "1242980",
    "end": "1249220"
  },
  {
    "text": "products remove some products from the cart checkout the entire thing and pay for it and then you multiply that with maybe 10,000 6000 the interface to this",
    "start": "1249220",
    "end": "1256480"
  },
  {
    "text": "is really simple we have a slack bot which just responds when you tell it to",
    "start": "1256480",
    "end": "1262300"
  },
  {
    "text": "in queue some Lua script the JSON file here that you were in queueing describes with Lua script to use which store to",
    "start": "1262300",
    "end": "1267490"
  },
  {
    "text": "target how long to do it and at what rate how many of these executions do you want per minute so remember that problem",
    "start": "1267490",
    "end": "1276220"
  },
  {
    "text": "from before of all of these pods being of different sizes this year that's a problem that we've been trying to",
    "start": "1276220",
    "end": "1281560"
  },
  {
    "text": "address in the past what we've done is that when we needed to provision a new pod because we've had too many shops we",
    "start": "1281560",
    "end": "1288040"
  },
  {
    "text": "replicated everything in that old pod that we wanted to split in half over to a new pod den for",
    "start": "1288040",
    "end": "1294940"
  },
  {
    "text": "a short duration of time we would change the routing layer to have half the shops go to the new pod and the other half to",
    "start": "1294940",
    "end": "1301090"
  },
  {
    "text": "the old pod and then start cleaning up the old pod it was a bit of a mess and a very operational manual amount of work I",
    "start": "1301090",
    "end": "1307780"
  },
  {
    "text": "think the checklist for doing this was like a hundred items so we wanted to bake make this better and less risky and",
    "start": "1307780",
    "end": "1313150"
  },
  {
    "text": "have less like big hand wavy movements to move all of these shops between shops with less downtime so we wanted to be",
    "start": "1313150",
    "end": "1319960"
  },
  {
    "text": "really really good at moving shops between parts and we wanted to see if we could do this with the minimal then the",
    "start": "1319960",
    "end": "1326350"
  },
  {
    "text": "smallest amount of downtime possible we shouldn't punish large merchants such as a large Shopify store that may take",
    "start": "1326350",
    "end": "1332770"
  },
  {
    "text": "hours to move and give them hours of downtime even if they can schedule it that's a terrible experience for a",
    "start": "1332770",
    "end": "1338170"
  },
  {
    "text": "merchant that maybe has an opportunity cause there of perhaps several million dollars that they're losing in that",
    "start": "1338170",
    "end": "1343720"
  },
  {
    "text": "transition so what the pod balancer does is that it looks at these pods and it looks at the shops and then the pod",
    "start": "1343720",
    "end": "1349810"
  },
  {
    "text": "balancer will make some decisions about how to balance these pod so you can imagine in this case it sees that part",
    "start": "1349810",
    "end": "1355750"
  },
  {
    "text": "two is a bit bigger it moves from shelf to pod 7 but in interim pod 14 grew one",
    "start": "1355750",
    "end": "1361480"
  },
  {
    "text": "of these shops is occupying three units three shop units this could be a shop",
    "start": "1361480",
    "end": "1366640"
  },
  {
    "text": "that has large sales it could be a shop that is very large maybe this is a shop that is replac forming from another",
    "start": "1366640",
    "end": "1372010"
  },
  {
    "text": "commerce solution and has grown tremendously in size some of these jobs are bigger than others just in terms of",
    "start": "1372010",
    "end": "1377170"
  },
  {
    "text": "size scale sales whatever they do and the pod balancer just continues to work",
    "start": "1377170",
    "end": "1382690"
  },
  {
    "text": "right so it moves some other shops from pod 14 over to some of the other pods but the complexity increases because you",
    "start": "1382690",
    "end": "1389350"
  },
  {
    "text": "also have sign ups you have new shops coming in and you have other shops growing and the pod balancer just keeps",
    "start": "1389350",
    "end": "1395320"
  },
  {
    "text": "working at it the pod balancer keeps trying to to fill up all these positive equal size before we had this we would",
    "start": "1395320",
    "end": "1403270"
  },
  {
    "text": "have some pods that were maybe twice as big as others giving you a bit of a noisy neighborhood problem where on some",
    "start": "1403270",
    "end": "1409510"
  },
  {
    "text": "of these shards they were you were experiencing more incidents than before so what happens now when they're all",
    "start": "1409510",
    "end": "1415090"
  },
  {
    "text": "filled up well you create a new pod and we're working this year on making that really easy and the pod balancers simply making",
    "start": "1415090",
    "end": "1420850"
  },
  {
    "text": "a decision to create a new pod and then moving the shops over wanted to be something that is always on",
    "start": "1420850",
    "end": "1426360"
  },
  {
    "text": "and something that we never have to touch it just creates pods continuously this is not something that is perfect",
    "start": "1426360",
    "end": "1432480"
  },
  {
    "text": "yet and there's still a little bit of or still some manual labor involved here but this is what we're going and it's",
    "start": "1432480",
    "end": "1438059"
  },
  {
    "text": "going quite well so far I want to just talk a little bit about how we move",
    "start": "1438059",
    "end": "1443130"
  },
  {
    "text": "those shops from sharp - sharp how can we do that with minimal downtown how can we not punish these shops that are very",
    "start": "1443130",
    "end": "1448380"
  },
  {
    "text": "large so if we just look at two of the data stores here like red isn't my sequel we can imagine if we want to move",
    "start": "1448380",
    "end": "1454230"
  },
  {
    "text": "a shop from pod 9 to pod 23 they're very naive way of doing that is that you copied a shop by going through",
    "start": "1454230",
    "end": "1459840"
  },
  {
    "text": "every single table and you find all the records that belong to the shop with a simple query like this give me all the",
    "start": "1459840",
    "end": "1465450"
  },
  {
    "text": "orders where the shop ID is guess give me all the products where the shop idea.this put it into the target shard and while that is happening you don't",
    "start": "1465450",
    "end": "1473490"
  },
  {
    "text": "accept any rights because the problem is that if you have a shop and while you're copying that shop it's inserting a check",
    "start": "1473490",
    "end": "1479490"
  },
  {
    "text": "up but you've just copied to checkout table that checkout is going to be lost so you need to basically lock the shop",
    "start": "1479490",
    "end": "1486330"
  },
  {
    "text": "while you're copying it for a small shop that's not a problem that may just take a minute maybe less than a minute maybe",
    "start": "1486330",
    "end": "1491460"
  },
  {
    "text": "a couple seconds but for a large shop this can take a very long time if you don't allow any rights while you're",
    "start": "1491460",
    "end": "1496620"
  },
  {
    "text": "copying it what we're working on now is not doing this lock move on lock but",
    "start": "1496620",
    "end": "1503010"
  },
  {
    "text": "instead we look at the my sequel bin log and stream these events as we're copying the shop to avoid locking the shop at",
    "start": "1503010",
    "end": "1509460"
  },
  {
    "text": "having downtime while we're copying it the bin log is what is in my sequel",
    "start": "1509460",
    "end": "1514649"
  },
  {
    "text": "vocabulary where every modification to the database is logged so if you change",
    "start": "1514649",
    "end": "1520440"
  },
  {
    "text": "a row insert a new check out it is registered in the bin log as events you know insert a new check out for this",
    "start": "1520440",
    "end": "1525570"
  },
  {
    "text": "shop insert a new product for this shop so what the pod balancer is do is going to do and we're starting to work on now",
    "start": "1525570",
    "end": "1532169"
  },
  {
    "text": "is that the pod bouncer is going to stream the bin log and look at new events that are coming in that haven't",
    "start": "1532169",
    "end": "1537899"
  },
  {
    "text": "been copied at the bottom so the bottom tries to copy Alden all the old beta and the bin log tailor part component of the",
    "start": "1537899",
    "end": "1545970"
  },
  {
    "text": "pod balancer is replicating new events so old at the bottom new at the top this means that we don't have to lock the",
    "start": "1545970",
    "end": "1551520"
  },
  {
    "text": "shop for an extended duration of time now when that's done and we can now",
    "start": "1551520",
    "end": "1557610"
  },
  {
    "text": "imagine this is discreet moment in time where the shop is completely replicated for now we need",
    "start": "1557610",
    "end": "1563470"
  },
  {
    "text": "to move it to the new pod by updating the routing information about it so first we locked a shop no rights can",
    "start": "1563470",
    "end": "1569050"
  },
  {
    "text": "come in we interrupt all jobs all web requests that's going on for that shop for a brief couple of seconds then we go",
    "start": "1569050",
    "end": "1577150"
  },
  {
    "text": "into a routing data store the data store that is dead is storing that the mapping from shop to pod and from pot to data",
    "start": "1577150",
    "end": "1583510"
  },
  {
    "text": "center and we update the shops pot ID in there immediately this is reflected and",
    "start": "1583510",
    "end": "1588850"
  },
  {
    "text": "things start going to the new pod we unlocked a shop and the shop has been moved then we remove it from the my sequel",
    "start": "1588850",
    "end": "1595480"
  },
  {
    "text": "layer we move the jobs and other things that are in Redis over as well which are asynchronous and now the shop has been",
    "start": "1595480",
    "end": "1601210"
  },
  {
    "text": "completely moved you multiply this by running a thousand of these in parallel and suddenly you can move a lot of shops",
    "start": "1601210",
    "end": "1607270"
  },
  {
    "text": "to a lot of pods very very rapidly and you also add on top of this making really good decisions about which shops",
    "start": "1607270",
    "end": "1613210"
  },
  {
    "text": "you're moving at what time to keep all those shelves balanced so now we've",
    "start": "1613210",
    "end": "1619210"
  },
  {
    "text": "talked a bit about traffic we've talked a bit about how the application tier works with these pods now I want to talk",
    "start": "1619210",
    "end": "1624250"
  },
  {
    "text": "talk briefly about how we connect these two how does the traffic layer know how",
    "start": "1624250",
    "end": "1629380"
  },
  {
    "text": "to route the request to the correct pods for this we have a very well may named",
    "start": "1629380",
    "end": "1635760"
  },
  {
    "text": "component called sorting hat or sorting hat does is that it looks at requests that are coming in to the Shopify",
    "start": "1635760",
    "end": "1641080"
  },
  {
    "text": "network and tries to figure out which pod that request belongs to it needs to go to the region where that pod is",
    "start": "1641080",
    "end": "1646840"
  },
  {
    "text": "active and it needs to work with things like failovers and shop moves and all of these different components this is a",
    "start": "1646840",
    "end": "1653890"
  },
  {
    "text": "very very core part of the potting architecture and one of the first things that we worked on so again we have the",
    "start": "1653890",
    "end": "1661270"
  },
  {
    "text": "traffic layer and we have another open resti lua module called sorting hat what sorting hat does is that it looks at",
    "start": "1661270",
    "end": "1667600"
  },
  {
    "text": "these it knows which pods are active and which parts are inactive so in a region a pod is active or inactive there's",
    "start": "1667600",
    "end": "1673810"
  },
  {
    "text": "always a hot replica pair so that pot two can become active in region a if there's a cat a catastrophe or we need",
    "start": "1673810",
    "end": "1679660"
  },
  {
    "text": "to do some maintenance in that region and of course the other way around too so they're always set up in pairs then",
    "start": "1679660",
    "end": "1686230"
  },
  {
    "text": "we have this routing database from before that we use when we move shops around sorting hat is the consumer of that",
    "start": "1686230",
    "end": "1692390"
  },
  {
    "text": "is the only thing that queries it and asks about where shops are living so if you have a customer coming in getting",
    "start": "1692390",
    "end": "1698840"
  },
  {
    "text": "their products for sneaker shop comm sorting hat is going to ask the routing layer to route sneaker shop comm sticker",
    "start": "1698840",
    "end": "1704930"
  },
  {
    "text": "shop comm is gonna return back a shop ID shop 238 it's on pot 2 and we know that",
    "start": "1704930",
    "end": "1711260"
  },
  {
    "text": "it is active in region B so sorting had been routes the traffic there this is",
    "start": "1711260",
    "end": "1717860"
  },
  {
    "text": "very simple it's I think a couple hundred lines of Lua querying this data store and doing this thousands and",
    "start": "1717860",
    "end": "1725210"
  },
  {
    "text": "thousands of times a second this is what all what ties this whole part potting",
    "start": "1725210",
    "end": "1730490"
  },
  {
    "text": "architecture together and makes the traffic layer marry the data and",
    "start": "1730490",
    "end": "1735590"
  },
  {
    "text": "application layer the last thing I want to talk about is how we fill these",
    "start": "1735590",
    "end": "1741320"
  },
  {
    "text": "regions over right we have the active pod and we have the inactive pod how do we flip them over and how do we do that",
    "start": "1741320",
    "end": "1746630"
  },
  {
    "text": "with minimal disruption for this we have the pod mover the pod mover moves parts",
    "start": "1746630",
    "end": "1751850"
  },
  {
    "text": "with between regions with minimal downtime we're now at a point where we're getting very very close to having almost zero downtime regional failures",
    "start": "1751850",
    "end": "1758930"
  },
  {
    "text": "this is really important for us because we think this is such a core thing that we want to be able to do all the time if",
    "start": "1758930",
    "end": "1764180"
  },
  {
    "text": "someone wants to do maintenance in a cloud region with without any repercussions they should be able to",
    "start": "1764180",
    "end": "1769640"
  },
  {
    "text": "move all the pods to another region due to your maintenance and move them back without any risk this avoids this",
    "start": "1769640",
    "end": "1775190"
  },
  {
    "text": "problem of having very expensive staging production environments that emulate an entire data center when instead you can",
    "start": "1775190",
    "end": "1781100"
  },
  {
    "text": "just get really really good at moving parts between data centers so what the",
    "start": "1781100",
    "end": "1786170"
  },
  {
    "text": "pod mover does is that if region B is having some kind of incident it may be out of power power we may be doing",
    "start": "1786170",
    "end": "1792320"
  },
  {
    "text": "maintenance it may be subject to a hurricane it may be subject to flooding whatever happens we need to be able to",
    "start": "1792320",
    "end": "1798710"
  },
  {
    "text": "move that region over this is the pod movers job and it can do this very very rapidly the way the podmobile works is",
    "start": "1798710",
    "end": "1805430"
  },
  {
    "text": "that it goes through a series of steps to failover region the first thing it does is disable cron in both regions so we're not doing new periodic jobs the",
    "start": "1805430",
    "end": "1812810"
  },
  {
    "text": "second thing it does is that it goes back to that routing data store the data store that keeps all the information between shop to pod to region mappings",
    "start": "1812810",
    "end": "1819650"
  },
  {
    "text": "and where the shop balancer or the pod balancer was looking and modifying the",
    "start": "1819650",
    "end": "1825320"
  },
  {
    "text": "shop to Padma the pot mover is responsible for the pot to region mapping so it updates it what",
    "start": "1825320",
    "end": "1831059"
  },
  {
    "text": "happens now it's sorting hat that thing that was looking at requests and routing them to the appropriate regions routes",
    "start": "1831059",
    "end": "1836220"
  },
  {
    "text": "the request to the new target region we then failover my sequel to the target region that little animation that was",
    "start": "1836220",
    "end": "1842399"
  },
  {
    "text": "before we didn't enable cron and we transfer the jobs that have not yet been executed in the source that's in the source to the target to then be executed",
    "start": "1842399",
    "end": "1849659"
  },
  {
    "text": "later it's fairly simple at a high level of course there's a lot the devil is in the detail here but this is at a high",
    "start": "1849659",
    "end": "1855239"
  },
  {
    "text": "level what happens when we do a pod move so what about the errors right I mentioned these I mentioned that we",
    "start": "1855239",
    "end": "1861210"
  },
  {
    "text": "wanted to minimize the errors when you when sorting hat starts to route to that in active region the database is not yet",
    "start": "1861210",
    "end": "1868200"
  },
  {
    "text": "rewritable there if someone is doing a check out they're gonna have that dreaded experience that everyone in this",
    "start": "1868200",
    "end": "1873929"
  },
  {
    "text": "room has probably tried your checking out and you get an error back when you've just entered your credit card details and now you have to call someone",
    "start": "1873929",
    "end": "1880619"
  },
  {
    "text": "and ask what's going on we don't want that scenario so we sat down and thought about how we could fix this again we",
    "start": "1880619",
    "end": "1888239"
  },
  {
    "text": "took out our hammer and nail open resti and solve this problem if you have my CSI at my sequel replicant to data",
    "start": "1888239",
    "end": "1894929"
  },
  {
    "text": "centers they can't both be writable at the same time one will be writable one would be readable there will be a couple",
    "start": "1894929",
    "end": "1900539"
  },
  {
    "text": "seconds of downtime where people have these terrible experiences but what if you can pause the request that the",
    "start": "1900539",
    "end": "1906359"
  },
  {
    "text": "trafficked here if you can pause the request of all they can't be served in the new region and you know that they're going to do a right you can do basically",
    "start": "1906359",
    "end": "1913470"
  },
  {
    "text": "zero downtime failovers so the Pasir module will pause request in the middle",
    "start": "1913470",
    "end": "1919169"
  },
  {
    "text": "of failovers to avoid serving errors so a customer comes in they're trying to create a new check out doing a failover",
    "start": "1919169",
    "end": "1925320"
  },
  {
    "text": "doing those critical seconds where the database is not yet writable in the new region so we add them into a queue we we",
    "start": "1925320",
    "end": "1933749"
  },
  {
    "text": "drain that queue from a throttle to avoid too many people coming in at the same time and the throttle is of course",
    "start": "1933749",
    "end": "1939299"
  },
  {
    "text": "disabled while we're failing over the region and my Seco has not fell over yet then the posture will finally give you",
    "start": "1939299",
    "end": "1946559"
  },
  {
    "text": "an HTTP 5 a 200 response later so this instead of this giving you dist dreaded err page when you've entered in your",
    "start": "1946559",
    "end": "1951809"
  },
  {
    "text": "credit card details you're just waiting five seconds this works now and it's in production for us",
    "start": "1951809",
    "end": "1958260"
  },
  {
    "text": "so this changes the pot mover flow a little bit all this stuff is the same but sorting had when it rounds requested",
    "start": "1958260",
    "end": "1963419"
  },
  {
    "text": "a target region it inspects the request and makes a good judgment on whether or not this is a request that would perform",
    "start": "1963419",
    "end": "1968549"
  },
  {
    "text": "it right if it will it will hold the request back at the low bouncing tier then it will fail over to my Seco region",
    "start": "1968549",
    "end": "1974130"
  },
  {
    "text": "resume the request enable cron and then transfer to jobs really really simple",
    "start": "1974130",
    "end": "1979470"
  },
  {
    "text": "and this has gotten us down to very very few errors doing failures we want to be",
    "start": "1979470",
    "end": "1985890"
  },
  {
    "text": "so confident these failures that people can just issue a command in slack and fail over a region we already have this",
    "start": "1985890",
    "end": "1992580"
  },
  {
    "text": "working but we're not quite confident enough yet to do it in production pods but it will be just weeks before we're",
    "start": "1992580",
    "end": "1998130"
  },
  {
    "text": "there you type in a command and then you fail over a pod you don't have to care about the customer disruption because",
    "start": "1998130",
    "end": "2004190"
  },
  {
    "text": "there should be none and we work as hard as possible to make that true this is a core primitive of the pod architecture",
    "start": "2004190",
    "end": "2009440"
  },
  {
    "text": "if there's an incident if there's an incident someone should just be able to come in middle of the night failover all",
    "start": "2009440",
    "end": "2014450"
  },
  {
    "text": "the pods and go back to bed maybe some day this will be automated but that dis is still a tremendous step from where we",
    "start": "2014450",
    "end": "2021200"
  },
  {
    "text": "were years ago just the last thing I want to note no dolphin is just another",
    "start": "2021200",
    "end": "2026510"
  },
  {
    "text": "one of these secondary benefits of second-order benefits of this pods architecture right now we're starting to",
    "start": "2026510",
    "end": "2033530"
  },
  {
    "text": "experimenting more with the cloud and with this architecture it's just a matter of putting a couple of clouds in or a couple pods in the cloud of course",
    "start": "2033530",
    "end": "2040730"
  },
  {
    "text": "there's a lot of work going on to get all these stateful tears and the stateless tears in the cloud but when we have it there we can just gradually move",
    "start": "2040730",
    "end": "2048169"
  },
  {
    "text": "shops there without disrupting the rest of the platform so we have a little gas pedal we're slowly we move shops to the",
    "start": "2048169",
    "end": "2056270"
  },
  {
    "text": "cloud and as we gain that operational expertise with the cloud we can move all of Shopify over there this really March",
    "start": "2056270",
    "end": "2063950"
  },
  {
    "text": "the end of my talk I hope you have a pretty good idea now of how Shopify works at a high level and maybe some of",
    "start": "2063950",
    "end": "2069679"
  },
  {
    "text": "this you can take home and and and think about maybe some of this will be applicable and especially if you're a",
    "start": "2069679",
    "end": "2074929"
  },
  {
    "text": "SAS company a lot of this should be applicable I've talked about all these components the pods the pod bouncer the",
    "start": "2074929",
    "end": "2081500"
  },
  {
    "text": "pod mover and sorting hat thank you so much",
    "start": "2081500",
    "end": "2085750"
  },
  {
    "text": "really cool talk Thank You Simon hey there's also some really good questions and one of them is they",
    "start": "2091339",
    "end": "2097950"
  },
  {
    "text": "understand how you move parts but how do you move them is the region is down unreachable yeah quick question so okay",
    "start": "2097950",
    "end": "2104849"
  },
  {
    "text": "let me go back to this slide because it's quite it's quite close here so the question is what happens when when",
    "start": "2104849",
    "end": "2114029"
  },
  {
    "text": "region B here is on fire that region is unreachable how do you fail it over well there's certain things you can't do but you can do checks right so the problem",
    "start": "2114029",
    "end": "2120599"
  },
  {
    "text": "one of the problems would be well the database is not completely caught up in the target - in the new region so you",
    "start": "2120599",
    "end": "2129180"
  },
  {
    "text": "have to make a judgment call right at this point that MIT did process is still manual and it will tell you hey you're going to lose this much data if you",
    "start": "2129180",
    "end": "2136020"
  },
  {
    "text": "perform this failover are you sure you want to do it so the pod mover is as resilient as possible best case it will",
    "start": "2136020",
    "end": "2143190"
  },
  {
    "text": "do a pod move with all the jobs all the data moved but indicates where it can't it will ask you questions it will ask",
    "start": "2143190",
    "end": "2150029"
  },
  {
    "text": "you are you okay with losing this much data are you okay with not transferring jobs and it will still perform the best effort thing that we can do cool there's",
    "start": "2150029",
    "end": "2160109"
  },
  {
    "text": "a one there's a question about like it sounds like the pod more a respond in",
    "start": "2160109",
    "end": "2165930"
  },
  {
    "text": "multiple instances how do you avoid rake race condition between them and how to avoid smaller shells being moved all the",
    "start": "2165930",
    "end": "2172289"
  },
  {
    "text": "time yeah I think the slide is appropriate to show that so when we talked about the pod move herb initially",
    "start": "2172289",
    "end": "2177299"
  },
  {
    "text": "what we wanted to do is well okay let's design it so that when you update the routing information there's a bunch of",
    "start": "2177299",
    "end": "2183630"
  },
  {
    "text": "subscribers one that's responsible for jobs one that's responsible for stopping cron once it's responsible for failing over one miss responsible for sorting",
    "start": "2183630",
    "end": "2189750"
  },
  {
    "text": "hat and then they all subscribe to just like kind of pop subsystem but distributive carbonate coordination is",
    "start": "2189750",
    "end": "2194880"
  },
  {
    "text": "very difficult so we didn't want to do it it's too complex and the ROI is just not high enough so this is literally one",
    "start": "2194880",
    "end": "2201329"
  },
  {
    "text": "script that is running on a machine somewhere right and which machine it will run on is of course resilient to which readings are down and things like",
    "start": "2201329",
    "end": "2207720"
  },
  {
    "text": "that but it's one machine doing a bunch of sequential steps that is resilient and it's very very simple",
    "start": "2207720",
    "end": "2214849"
  },
  {
    "text": "sounds like how you would avoid that it's a question in this another question here is the customization of engine egg",
    "start": "2215210",
    "end": "2221940"
  },
  {
    "text": "a task for feature de Ville of us or operation the Indian X task the",
    "start": "2221940",
    "end": "2230010"
  },
  {
    "text": "murse T oh yeah okay so we have it's primarily been a place",
    "start": "2230010",
    "end": "2235320"
  },
  {
    "text": "where infrastructure engineers have made modifications the opener st layer but we have had some application engineers and",
    "start": "2235320",
    "end": "2241920"
  },
  {
    "text": "do various modifications for example to redirect fractions of traffic and do",
    "start": "2241920",
    "end": "2247530"
  },
  {
    "text": "tests and things like that so I would say it's probably like 90% infrastructure engineering at this tier and 10% product and product engineering",
    "start": "2247530",
    "end": "2257330"
  },
  {
    "text": "there's no question about like how do you implement molten tendency within a part yeah okay",
    "start": "2257330",
    "end": "2263730"
  },
  {
    "text": "this is almost a talk in itself but sharding is essentially we shard by the key so the shop ID and every time you do",
    "start": "2263730",
    "end": "2272220"
  },
  {
    "text": "a query you were always in the context of the shop so you can imagine that if you're doing a wipe request or a job you can only curry data that is belonging to",
    "start": "2272220",
    "end": "2278610"
  },
  {
    "text": "that shop because every query is appended with the shop ID so it does like select all from orders where shop",
    "start": "2278610",
    "end": "2284070"
  },
  {
    "text": "ideas desk or select product where ID is this and shop ID is this so they're all",
    "start": "2284070",
    "end": "2289530"
  },
  {
    "text": "in they're all in the same schema we don't run hundreds or thousands of schemas because that's not something",
    "start": "2289530",
    "end": "2294810"
  },
  {
    "text": "that that's not a very normal workload for my sequel and we want the workload to try to be as normalized as possible",
    "start": "2294810",
    "end": "2300090"
  },
  {
    "text": "that's the very high level overview want one other thing I'll note is that we do this charting at the application level",
    "start": "2300090",
    "end": "2305760"
  },
  {
    "text": "we don't have a proxy or something like that when we implemented sharding that's not something we were comfortable with so it's application level sharding",
    "start": "2305760",
    "end": "2311820"
  },
  {
    "text": "sharted that the shop ID key schema is shared between the shops on the pod and every single table has a shop ID key",
    "start": "2311820",
    "end": "2318540"
  },
  {
    "text": "embedded in it so that we can do these queries efficiently really cool like I",
    "start": "2318540",
    "end": "2324000"
  },
  {
    "text": "think one of the two last questions M just there's something about really a",
    "start": "2324000",
    "end": "2331100"
  },
  {
    "text": "question about it's a cafe is it something that would replace my school",
    "start": "2331100",
    "end": "2336810"
  },
  {
    "text": "pin lock for moving shops I'm not entirely sure how to interpret that",
    "start": "2336810",
    "end": "2343050"
  },
  {
    "text": "question but I'll give it my best if the question is whether we could put the",
    "start": "2343050",
    "end": "2350280"
  },
  {
    "text": "entire my single bin log into CAF can use that instead the answer is yes we currently don't relate the bin log into into",
    "start": "2350280",
    "end": "2357520"
  },
  {
    "text": "not sure not sure exactly why it's not something that we really found it use for tailing the bin log works really",
    "start": "2357520",
    "end": "2364130"
  },
  {
    "text": "really well for us right now moving to Kafka maybe that's something that we would do if if that's if there were",
    "start": "2364130",
    "end": "2370130"
  },
  {
    "text": "other use cases for it but right now I don't really see that like the ROI on using Kafka but have been longer that's",
    "start": "2370130",
    "end": "2375349"
  },
  {
    "text": "very high and I think the last question somebody asked are you looking into",
    "start": "2375349",
    "end": "2380930"
  },
  {
    "text": "kubernetes yes yes like those those little cloud",
    "start": "2380930",
    "end": "2386180"
  },
  {
    "text": "regions there on the right that's criminales series in production yes okay okay I",
    "start": "2386180",
    "end": "2393859"
  },
  {
    "text": "think there was a really a gift salmon hand and remember to write in in the app",
    "start": "2393859",
    "end": "2398930"
  },
  {
    "text": "a few fingers good and also check out Simon's blog he has a really cool blog",
    "start": "2398930",
    "end": "2404539"
  },
  {
    "text": "where he writes about of this and cookie his name and you will find it it's really good but give me a hand thank you",
    "start": "2404539",
    "end": "2411120"
  },
  {
    "text": "[Applause]",
    "start": "2411120",
    "end": "2419380"
  }
]