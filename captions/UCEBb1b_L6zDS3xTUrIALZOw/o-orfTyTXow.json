[
  {
    "start": "0",
    "end": "50000"
  },
  {
    "text": "All right, you guys, let's\ngo ahead and get started. ",
    "start": "0",
    "end": "7120"
  },
  {
    "text": "I am back. I know you guys all missed me. ",
    "start": "7120",
    "end": "13779"
  },
  {
    "text": "Just a couple of announcements. Since you guys didn't have\nrecitations this week. I want to make sure that\nyou guys remember the Design",
    "start": "13779",
    "end": "19775"
  },
  {
    "text": "Project 2 proposals\nare due next tomorrow in class, as is Hands On 6.",
    "start": "19775",
    "end": "26770"
  },
  {
    "text": "Also, Quiz 2 is graded and\nis ready to be handed back. If you go to office hours\nwith your TA this afternoon,",
    "start": "26770",
    "end": "33690"
  },
  {
    "text": "you can pick it up or you\ncan get it in class tomorrow. ",
    "start": "33690",
    "end": "42254"
  },
  {
    "text": "We will post the statistics\nas soon as we get them. We are still waiting to get\nthe scores from one of the TAs into the thing, so I do\nnot want to say anything",
    "start": "42255",
    "end": "48210"
  },
  {
    "text": "until we know for sure.  All right. What we have seen so\nfar, we saw last time,",
    "start": "48210",
    "end": "55070"
  },
  {
    "start": "50000",
    "end": "144000"
  },
  {
    "text": "we talked about this\nnotion of transactions, we talked about the\nnotion of making",
    "start": "55070",
    "end": "60179"
  },
  {
    "text": "actions durable and consistent. This time what we\nare going to do is look at a related topic, a\nslightly more advanced topic",
    "start": "60180",
    "end": "69040"
  },
  {
    "text": "that is more related to the\nnotion of atomic actions that we spent two or\nthree lectures previous",
    "start": "69040",
    "end": "75340"
  },
  {
    "text": "to the one about\ntransactions talking about. If you remember,\nan atomic action,",
    "start": "75340",
    "end": "84180"
  },
  {
    "text": "we say it is both\nrecoverable and isolated.",
    "start": "84180",
    "end": "92145"
  },
  {
    "text": " When we say an action\nis recoverable,",
    "start": "92145",
    "end": "99150"
  },
  {
    "text": "that means, remember,\nit either all happens or it does not happen at all. When we say an\naction is isolated,",
    "start": "99150",
    "end": "107710"
  },
  {
    "text": "it means, from the point\nof view of other actions that are running\nconcurrently in the system, the action appears\nto only be one unit.",
    "start": "107710",
    "end": "114060"
  },
  {
    "text": "So then none of the intermediate\nstates of the action is visible to any other actions\nthat are running concurrently.",
    "start": "114060",
    "end": "120280"
  },
  {
    "text": "And we talked about the\nuse of the logging protocol to allow us to recover actions.",
    "start": "120280",
    "end": "126340"
  },
  {
    "text": "We also, in the\ntext and in class, talked briefly about version\nhistories as an alternative way",
    "start": "126340",
    "end": "131590"
  },
  {
    "text": "that we can recover actions. And we talked about\nhow to do isolation. We talked about several\ndifferent methods",
    "start": "131590",
    "end": "137189"
  },
  {
    "text": "for doing isolation. We spent a while talking\nabout locking as a mechanism that we use to isolate\nactions from each other.",
    "start": "137190",
    "end": "143660"
  },
  {
    "text": "What we are going to talk\nabout today is a related topic, and it has to do with\nwhen you have actions",
    "start": "143660",
    "end": "150330"
  },
  {
    "start": "144000",
    "end": "312000"
  },
  {
    "text": "that are spread\nacross multiple sites, multiple different computers. And this is going to tie\ntogether some of the concepts",
    "start": "150330",
    "end": "155940"
  },
  {
    "text": "that we learned in the\nprevious section on networking with the more recent stuff\nthat we have been talking",
    "start": "155940",
    "end": "161580"
  },
  {
    "text": "about with atomic action. The topic today is\nmulti-site atomicity.",
    "start": "161580",
    "end": "166800"
  },
  {
    "start": "166800",
    "end": "174106"
  },
  {
    "text": "And just to give you a\nsimple example of what we mean by a situation\nin which you might care about multi-site\natomicity, suppose that you",
    "start": "174106",
    "end": "181400"
  },
  {
    "text": "are running a travel website. You have some travel\nsite, and that",
    "start": "181400",
    "end": "190170"
  },
  {
    "text": "travel site you have\nnegotiated agreements with various different people\nwho sell airline tickets.",
    "start": "190170",
    "end": "195730"
  },
  {
    "text": "Maybe you have agreements\nwith Jet Blue and USAir",
    "start": "195730",
    "end": "202830"
  },
  {
    "text": "and some other set of airlines. And you want to make it so\nthat when somebody purchases",
    "start": "202830",
    "end": "210390"
  },
  {
    "text": "a ticket, they may purchase\na set of flights that are purchased together\nas one unit where there are different flights\non different airlines.",
    "start": "210390",
    "end": "217329"
  },
  {
    "text": "I might want to purchase\na flight from here to San Francisco\non JetBlue and then a flight from San Francisco\nback to here on USAir.",
    "start": "217330",
    "end": "224250"
  },
  {
    "text": "Sometimes people want to use\nmultiple different vendors when they are purchasing\ntheir tickets. And it may be the way that your\ntravel site talks to JetBlue",
    "start": "224250",
    "end": "232660"
  },
  {
    "text": "and USAir is over the Internet. They use some remote\nprocedure call",
    "start": "232660",
    "end": "239070"
  },
  {
    "text": "to ask JetBlue or USAir to\nreserve a seat on their behalf.",
    "start": "239070",
    "end": "245310"
  },
  {
    "text": "But when somebody is\nusing your website, you want to create the illusion\nthat these reservations that are made on the website are\nsort of one atomic unit.",
    "start": "245310",
    "end": "252370"
  },
  {
    "text": "You do not want it to\nbe that a person gets a reservation on\nJetBlue and does not get a reservation on USAir. You want them to\nmake a reservation",
    "start": "252370",
    "end": "258190"
  },
  {
    "text": "and get all of the reservation\nor none of the reservation. In order to make\nthat work, we are going to need some\nsort of special support",
    "start": "258190",
    "end": "264600"
  },
  {
    "text": "from the travel site,\nJetBlue and USAir. Suppose, for example, I did\nnot have any special support",
    "start": "264600",
    "end": "270520"
  },
  {
    "text": "from the JetBlue\nwebsite and I said I want to purchase this\nticket to San Francisco.",
    "start": "270520",
    "end": "275840"
  },
  {
    "text": " JetBlue goes ahead\nand says I am ready",
    "start": "275840",
    "end": "281340"
  },
  {
    "text": "and I purchased\nthat ticket for you. And then suppose we cannot\nget this reservation on USAir. Now we are in trouble.",
    "start": "281340",
    "end": "286590"
  },
  {
    "text": "We need some way to back out\nof the action with JetBlue and say wait, never\nmind, I did not",
    "start": "286590",
    "end": "291910"
  },
  {
    "text": "mean to actually\npurchase that ticket because I could not complete\nthe rest of my purchase. We are going to talk about how\nto provide this kind of, what",
    "start": "291910",
    "end": "298530"
  },
  {
    "text": "we call, multi-site\natomicity where we want this whole action that\nincludes purchases of tickets from these different websites\nto appear as though it",
    "start": "298530",
    "end": "305336"
  },
  {
    "text": "was one atomic action. Particularly we want to make\nsure that this whole thing is both recoverable and isolated. ",
    "start": "305336",
    "end": "319104"
  },
  {
    "text": "To sneak up on this\ntopic, because there are a bunch of different issues\nthat are going to come up here and are going to be a\nlittle bit complicated, we are going to start\nby looking at a simpler",
    "start": "319104",
    "end": "325854"
  },
  {
    "text": "version of this problem. Let's suppose that we have\nall of these things running",
    "start": "325854",
    "end": "332030"
  },
  {
    "text": "on the same computer\ntogether, that is they are not connected\nover the Internet,",
    "start": "332030",
    "end": "337360"
  },
  {
    "text": "there is not this possibility of\na message being lost like there would be on the Internet. So we are going to\nlook at these things",
    "start": "337360",
    "end": "342720"
  },
  {
    "text": "as though they are all running\ntogether on the same computer. In that case, we call\nthese actions that are running together\non the same computer",
    "start": "342720",
    "end": "349150"
  },
  {
    "text": "\"nested atomic actions\". ",
    "start": "349150",
    "end": "357940"
  },
  {
    "text": "Once we see how this works\non just the single computer case then we will\nsort of look and see how it gets more complicated\nwhen we extend it out",
    "start": "357940",
    "end": "364240"
  },
  {
    "text": "to the multi-computer case.  Let's simplify\nthis a little bit.",
    "start": "364240",
    "end": "370790"
  },
  {
    "text": "Suppose we had our buy ticket\nprocedure looking something like begin, buy on JetBlue,\nthen buy on USAir and then end.",
    "start": "370790",
    "end": "388040"
  },
  {
    "text": "I am just going to call these\ntwo things A and B for now just to sort of simplify it so\nI do not have to write JetBlue",
    "start": "388040",
    "end": "394250"
  },
  {
    "text": "and USAir over and over again. And the property that we want is\nthat each one of these actions,",
    "start": "394250",
    "end": "400960"
  },
  {
    "text": "in and of itself, should\nbe atomic with respect to the other actions.",
    "start": "400960",
    "end": "407150"
  },
  {
    "text": "We want atomic with\nrespect to each other.",
    "start": "407150",
    "end": "415570"
  },
  {
    "text": "That is one property we want. We want that because,\nfor example, suppose",
    "start": "415570",
    "end": "423889"
  },
  {
    "text": "that buying JetBlue requires\nme to provide some credit card number or debit card number that\nis going to go out and purchase",
    "start": "423890",
    "end": "429830"
  },
  {
    "text": "the ticket. Well, I do not want to\nhave the action that purchases from JetBlue and\nthe action that purchases",
    "start": "429830",
    "end": "435170"
  },
  {
    "text": "from USAir simultaneously\ndecrementing my, say, bank account. Because we saw how you could\nimagine getting into trouble",
    "start": "435170",
    "end": "441776"
  },
  {
    "text": "where they would both read\nthe balance at the same time and then both decrement and then\nboth write at the same time. You could get some mixed up\nbalance left in your bank",
    "start": "441776",
    "end": "449490"
  },
  {
    "text": "account, for example. So if these things are,\nlet's say, for example, debiting a bank\naccount, you want",
    "start": "449490",
    "end": "455300"
  },
  {
    "text": "to make sure that these actions\nare atomic with respect to one another.",
    "start": "455300",
    "end": "460760"
  },
  {
    "text": "You also want to make sure\nthat this whole thing is atomic with respect\nto the outside world.",
    "start": "460760",
    "end": "467905"
  },
  {
    "start": "467905",
    "end": "474290"
  },
  {
    "text": "That is to say that\nthe caller, somebody",
    "start": "474290",
    "end": "479450"
  },
  {
    "text": "who invokes this procedure\nto buy this pair of tickets never gets to see a state where\none of the tickets is purchased",
    "start": "479450",
    "end": "485004"
  },
  {
    "text": "and one of the tickets\nis not purchased. It either looks like the ticket\nhas been completely purchased or it has not been\npurchased at all,",
    "start": "485004",
    "end": "491000"
  },
  {
    "text": "so we want it to be isolated. And we also want it\nto be recoverable. We want it to be the case\nthat if we crash halfway",
    "start": "491000",
    "end": "497000"
  },
  {
    "text": "through here, after we have\nbought the ticket on JetBlue, if the whole system\ncrashes at that point, when",
    "start": "497000",
    "end": "502550"
  },
  {
    "text": "the system comes back up,\nwe do not want the system to be in some\nhalfway state where we paid the money for\nthe JetBlue ticket",
    "start": "502550",
    "end": "508729"
  },
  {
    "text": "and have not paid the\nmoney for the USAir ticket. So we should either\ncomplete the transaction or we should completely\nroll back the transaction",
    "start": "508730",
    "end": "514320"
  },
  {
    "text": "and abort it. So this is this notion of\nnested atomic actions, which",
    "start": "514320",
    "end": "519530"
  },
  {
    "text": "is we have this outer\naction and then it has these two actions\nthat are nested within it. And each of these actions\nis, in and of itself,",
    "start": "519530",
    "end": "525990"
  },
  {
    "text": "an atomic action. ",
    "start": "525990",
    "end": "534360"
  },
  {
    "text": "If you think about what's\ngoing on here for a minute,",
    "start": "534360",
    "end": "541329"
  },
  {
    "text": "so if you think about what the\nsort of condition that we want is, we've got A and B.",
    "start": "541330",
    "end": "547530"
  },
  {
    "text": "And we want A to\ncommit if B commits",
    "start": "547530",
    "end": "555450"
  },
  {
    "text": "and we want B to\ncommit if A commits.",
    "start": "555450",
    "end": "566740"
  },
  {
    "text": "Because, if A doesn't commit,\nwe need both of these actions to definitely commit or\ndefinitely not commit.",
    "start": "566740",
    "end": "573852"
  },
  {
    "text": "Otherwise, we're kind of in\ntrouble for this example. But the way that\nI've worded this, it kind of sounds\nimpossible, like how",
    "start": "573852",
    "end": "580459"
  },
  {
    "text": "is it A is waiting\nfor B to commit and B is waiting for A to\ncommit so how are we ever going to make any progress?",
    "start": "580460",
    "end": "586680"
  },
  {
    "text": "And the trick is\nthat we're going to introduce a third-party,\nsomething that is in charge of deciding whether\nor not the entire action has",
    "start": "586680",
    "end": "596330"
  },
  {
    "text": "committed. So we're going to\nintroduce a node S which we call the \"supervisor\". ",
    "start": "596330",
    "end": "604480"
  },
  {
    "text": "And S is in charge of\ndeciding whether or not the entire action, the action\nwith both A and B inside of it",
    "start": "604480",
    "end": "612829"
  },
  {
    "text": "actually commits. So let's see how that\nworks because just seeing",
    "start": "612830",
    "end": "618550"
  },
  {
    "text": "that we still have\nto have some way of S knowing that A is\nready to commit and S knowing that B\nis ready to commit.",
    "start": "618550",
    "end": "625560"
  },
  {
    "text": "And we still need\nsome way of making it so that A and B both make\nthe decision to commit",
    "start": "625560",
    "end": "631760"
  },
  {
    "text": "at exactly the same time. So let's see how we can\ngo about doing that.",
    "start": "631760",
    "end": "649605"
  },
  {
    "start": "643000",
    "end": "795000"
  },
  {
    "text": "The idea is that we're\ngoing to introduce something we call \"tentative commits\". ",
    "start": "649605",
    "end": "659330"
  },
  {
    "text": "So what we want to\ndo is get A and B to a point where they're\nboth exactly ready",
    "start": "659330",
    "end": "667410"
  },
  {
    "text": "to commit but they haven't\nyet actually committed their results. So they haven't actually\nmade their results available,",
    "start": "667410",
    "end": "672829"
  },
  {
    "text": "but they want to give up\ncontrol to S as to the instant that they'll actually commit.",
    "start": "672829",
    "end": "678810"
  },
  {
    "text": "So what we're trying\nto get is a way in which S can instantaneously\nmake a decision",
    "start": "678810",
    "end": "684329"
  },
  {
    "text": "about whether both A and\nB commit or neither A or B commits. And so what we're\ngoing to do is,",
    "start": "684330",
    "end": "690240"
  },
  {
    "text": "the idea with a\ntentative commit is we're going to run A and B\nuntil they tentatively commit.",
    "start": "690240",
    "end": "695860"
  },
  {
    "text": "And what that means is\nthat they're going to do, so we want A and\nB to do everything",
    "start": "695860",
    "end": "708170"
  },
  {
    "text": "except actually commit. ",
    "start": "708170",
    "end": "714632"
  },
  {
    "text": "So what does that mean? It means that A and B are\ngoing to read all of the data that they would\nnormally read, they're going to write all the things\nthat they would normally write.",
    "start": "714632",
    "end": "721620"
  },
  {
    "text": "If we are using a locking\nprotocol they would acquire all of the locks that they\nwould need to acquire in order to process the\ntransaction, process",
    "start": "721620",
    "end": "729829"
  },
  {
    "text": "their part of the action. But they're not actually\ngoing to commit. So not committing means\nthat, in particular, they",
    "start": "729830",
    "end": "740780"
  },
  {
    "text": "are not going to expose\ntheir results out to the outside world. So we say they don't\nexpose results beyond S.",
    "start": "740780",
    "end": "767600"
  },
  {
    "text": "So a tentatively\ncommitted transaction, I'm just going to\nwrite as TC, says that it's not\ngoing to expose any",
    "start": "767600",
    "end": "775009"
  },
  {
    "text": "of the results of its\naction outside of S. If we're using a\nlocking protocol, how do we prevent one\nof these nested actions",
    "start": "775010",
    "end": "783920"
  },
  {
    "text": "from being able to\nexpose its results? Or, how do we make it so that\nit doesn't expose its results",
    "start": "783920",
    "end": "792470"
  },
  {
    "text": "or it makes its results\nvisible outside? Yeah. STUDENT: Whenever a stop\naction wants to commit,",
    "start": "792470",
    "end": "798890"
  },
  {
    "start": "795000",
    "end": "934000"
  },
  {
    "text": "we would just move the lock\nto its higher level of action,",
    "start": "798890",
    "end": "804020"
  },
  {
    "text": "to the action it belongs to. Right. That's essentially what\nwe're going to want to do.",
    "start": "804020",
    "end": "809680"
  },
  {
    "text": "If we just want to make it\nso that the action's results aren't visible, we're\njust going to make it so that that action doesn't\nrelease any of its locks.",
    "start": "809680",
    "end": "816670"
  },
  {
    "text": "If it doesn't release\nits locks then nobody else can get locks on\nany of the data that it updated. And, therefore, none of its\nupdates will be visible.",
    "start": "816671",
    "end": "823920"
  },
  {
    "text": "The solution that\nwas proposed here is what we're going\nto work up to, which is that basically we want\nto make sure that if we want",
    "start": "823920",
    "end": "831420"
  },
  {
    "text": "S to be able to see the\nresults of a tentatively committed sub-action, which\nwe will and I'll explain why.",
    "start": "831420",
    "end": "838480"
  },
  {
    "text": "Then what we're\ngoing to do is we're going to hand the locks\noff from the sub-action up to S, the superior action.",
    "start": "838480",
    "end": "845440"
  },
  {
    "text": "We're work through\nhow that works. The way that this\nis going to work, this is going to\nallow us to get,",
    "start": "845440",
    "end": "853220"
  },
  {
    "text": "so we can draw a graph\nthat looks like this. We say S, we've got some action\nA, we've got some action B,",
    "start": "853220",
    "end": "860980"
  },
  {
    "text": "and we may, in principle,\nhave other actions that are sub-actions\nof these sub-actions.",
    "start": "860980",
    "end": "866511"
  },
  {
    "text": "And what we're\ngoing to do is we're going to draw a graph\nwhere we put arrows pointing from the\nsub-action up to its parent",
    "start": "866512",
    "end": "872740"
  },
  {
    "text": "action, the action that\nit is depending on. And we're going to\nlabel the states, we can label each\none of these actions",
    "start": "872740",
    "end": "879290"
  },
  {
    "text": "in this graph as either\ntentatively committed. Or, if it's not\ntentatively committed, it hasn't finished doing\nall of its processing",
    "start": "879290",
    "end": "885246"
  },
  {
    "text": "yet we might label\nit as pending. ",
    "start": "885246",
    "end": "901386"
  },
  {
    "text": "Let's look in a\nlittle bit more detail about how we might actually\nget this tentative commit thing",
    "start": "901387",
    "end": "908579"
  },
  {
    "text": "to work. And hopefully that will\nmake it a little bit more clear what's going on here.",
    "start": "908580",
    "end": "913939"
  },
  {
    "text": "And, in particular,\nwhat I want to do is I want to look at\nthe way in which a log",
    "start": "913939",
    "end": "919959"
  },
  {
    "text": "action on this machine\nmight be being maintained. And this is really going\nto help us get at how",
    "start": "919960",
    "end": "927790"
  },
  {
    "text": "we do recovery via logging.",
    "start": "927790",
    "end": "936880"
  },
  {
    "start": "934000",
    "end": "1043000"
  },
  {
    "text": "This is for these\nnested actions. Suppose we have some log\nand this has actions in it.",
    "start": "936880",
    "end": "947740"
  },
  {
    "text": " When S first starts\nrunning the transaction,",
    "start": "947740",
    "end": "954630"
  },
  {
    "text": "when the transaction first\nstarts running this supervisor",
    "start": "954630",
    "end": "960630"
  },
  {
    "text": "module writes a begin\ntransaction message. And then what it's\ngoing to do is",
    "start": "960630",
    "end": "967900"
  },
  {
    "text": "it's going to invoke each one\nof these subatomic actions.",
    "start": "967900",
    "end": "974355"
  },
  {
    "text": "And each one of those\nsubatomic actions is going to write a\nbegin record as well. ",
    "start": "974355",
    "end": "982800"
  },
  {
    "text": "And then there's going\nto be some processing, so these actions are\ngoing to execute, they're going to\nobtain some locks",
    "start": "982800",
    "end": "988279"
  },
  {
    "text": "and they are going\nto update some data. We're going to write those\nlog records for that data that was updated into the log.",
    "start": "988280",
    "end": "995540"
  },
  {
    "text": "And then, at some\npoint later, we will see tentative commits for\nA and tentative commits for B.",
    "start": "995540",
    "end": "1003170"
  },
  {
    "text": "And then finally\nwhat we'll do is, once those guys are\ntentatively committed,",
    "start": "1003170",
    "end": "1008900"
  },
  {
    "text": "we'll write the\ncommit record for S.",
    "start": "1008900",
    "end": "1017350"
  },
  {
    "text": "Now let's look at what we\ncan say at various points sort of during it.",
    "start": "1017350",
    "end": "1022470"
  },
  {
    "text": "If you think of this log as\nbeing a timeline about when things happen in\nthe system, let's look and see what we can\nsay at various points.",
    "start": "1022470",
    "end": "1029619"
  },
  {
    "text": "One thing we can say is that\nthis time when this commit S record was written,\nthis is the commit point",
    "start": "1029619",
    "end": "1035959"
  },
  {
    "text": "for this entire transaction. So we say this is the commit\npoint for both A and B",
    "start": "1035960",
    "end": "1046260"
  },
  {
    "start": "1043000",
    "end": "1202000"
  },
  {
    "text": "and anything else\nthat maybe S did. If you remember, what\nthe commit point is,",
    "start": "1046260",
    "end": "1052970"
  },
  {
    "text": "it's sort of the\npoint of no return. Once we reach the\ncommit point we've guaranteed that this\naction is going to persist.",
    "start": "1052970",
    "end": "1060759"
  },
  {
    "text": "Even if the system crashes,\nit will recover in the state as though that action\nhad taken effect.",
    "start": "1060760",
    "end": "1066030"
  },
  {
    "text": "And if we crash prior\nto the commit point then what we want to guaranty\nis that this action was not",
    "start": "1066030",
    "end": "1072281"
  },
  {
    "text": "visible. When we recover we're\ngoing to undo any effects that anything in\nthis action did.",
    "start": "1072281",
    "end": "1077919"
  },
  {
    "text": "If we were to crash\nright here, just before we wrote\nthe commit record, then we would undo\nthis whole action.",
    "start": "1077920",
    "end": "1085562"
  },
  {
    "text": "And if we were to crash\nany time after we write the commit record\nthen we're going to make sure that we redo any\nupdates that the action may",
    "start": "1085562",
    "end": "1091561"
  },
  {
    "text": "have needed to do. We're going to guaranty that\nthis action is forced to disc.",
    "start": "1091561",
    "end": "1097080"
  },
  {
    "text": "But notice that there are these\ntwo tentative commit records. What do these tentative\ncommit records correspond to?",
    "start": "1097080",
    "end": "1104283"
  },
  {
    "text": "What these tentative\ncommit records mean is that A and B, this buy\nJetBlue and buy USAir,",
    "start": "1104284",
    "end": "1110169"
  },
  {
    "text": "did all of the work\nthat they had to do. So, in particular, it means\nthat neither A or B is going",
    "start": "1110170",
    "end": "1116029"
  },
  {
    "text": "to have to acquire\nanymore locks, they're not going to\nwrite anymore data. They're at exactly this point\nwhere they're ready to commit.",
    "start": "1116030",
    "end": "1122984"
  },
  {
    "text": "And the thing that's\ngoing to make them commit is the writing of this\ncommit S log record. ",
    "start": "1122984",
    "end": "1129770"
  },
  {
    "text": "Effectively, A and B,\nthe sort of whether or not A and B commit is now\nout of control of A and B once they write this log record.",
    "start": "1129770",
    "end": "1135830"
  },
  {
    "text": "And it's completely in the hands\nof this outer supervisor module S. And so the outer\nsupervisor module",
    "start": "1135830",
    "end": "1142090"
  },
  {
    "text": "S, of course it can\ncommit, but you also have to realize that it's also\nOK if this outer module aborts.",
    "start": "1142090",
    "end": "1147820"
  },
  {
    "text": "And if it aborts then it will\nwrite an abort log record and we will have to go and undo\nthe effects of the whole thing.",
    "start": "1147820",
    "end": "1153440"
  },
  {
    "text": "But we can still do that because\nwe haven't, as of this point",
    "start": "1153440",
    "end": "1158710"
  },
  {
    "text": "here, actually exposed any\nresults outside of this action. So there is nobody else who has\nseen the effects of this thing.",
    "start": "1158710",
    "end": "1163910"
  },
  {
    "text": "We're still isolated\nwith respect to any outside action that\nmight be running on the system. So it's OK if we abort any\ntime up to this commit record.",
    "start": "1163910",
    "end": "1171990"
  },
  {
    "text": "It also means that\nafter this commit point, this is sort of the\npoint where we're going to start exposing results.",
    "start": "1171990",
    "end": "1177519"
  },
  {
    "text": "If we're locking we're going\nto release our write locks after this commit point.",
    "start": "1177520",
    "end": "1183450"
  },
  {
    "text": "And the act of\nreleasing the locks is what's going to make\nit so that other actions",
    "start": "1183450",
    "end": "1189480"
  },
  {
    "text": "outside of this system can see\nthe effects of A and B running. ",
    "start": "1189480",
    "end": "1204720"
  },
  {
    "start": "1202000",
    "end": "1295000"
  },
  {
    "text": "Just to make it clear, we\nsay A and B commit or abort",
    "start": "1204720",
    "end": "1217549"
  },
  {
    "text": "when S commits or aborts. I have just written CA\nhere for commit or abort.",
    "start": "1217550",
    "end": "1223544"
  },
  {
    "text": "There is one other\nlittle detail that we need to point out\nwhich is that S can commit even if A or B fail.",
    "start": "1223544",
    "end": "1237769"
  },
  {
    "text": "So this may seem a little\nbit counterintuitive, but the intuition here\nis that this action S,",
    "start": "1237770",
    "end": "1244630"
  },
  {
    "text": "suppose that S tries to run\nA and it cannot get a hold",
    "start": "1244630",
    "end": "1249900"
  },
  {
    "text": "of the tickets on\nJetBlue that it wanted. Well, S is free to go and\ntry and make a reservation",
    "start": "1249900",
    "end": "1255230"
  },
  {
    "text": "on some other airline that also\nsatisfies the user's request. So the fact that A failed\ndoesn't say anything about",
    "start": "1255230",
    "end": "1262670"
  },
  {
    "text": "whether or not S is\nnecessarily going to fail. S still gets to decide\nwhether it fails or not.",
    "start": "1262670",
    "end": "1267812"
  },
  {
    "text": "And this is kind of\nan important property because it means that these\nactions that are running inside",
    "start": "1267812",
    "end": "1273120"
  },
  {
    "text": "of S are actually,\nwhile they are running, are isolated with respect to\nS and the other actions that",
    "start": "1273120",
    "end": "1278539"
  },
  {
    "text": "are running on S. Any of the updates that they\nmake while they're running aren't seen by S or any\nof the other actions.",
    "start": "1278540",
    "end": "1285170"
  },
  {
    "text": "This is just one little\nthing to keep in mind. ",
    "start": "1285170",
    "end": "1295810"
  },
  {
    "text": "There is one last detail that\nI've sort of brushed over here that we hinted at a\nlittle bit a minute ago.",
    "start": "1295810",
    "end": "1302400"
  },
  {
    "text": "And that's the problem which\nis what if A and B conflict",
    "start": "1302400",
    "end": "1308590"
  },
  {
    "text": "with each other? We said that A and B might both\nupdate the same bank account",
    "start": "1308590",
    "end": "1314299"
  },
  {
    "text": "balance, right? Well, we have a little\nbit of a problem if that happens\nbecause I've got my S",
    "start": "1314300",
    "end": "1321260"
  },
  {
    "text": "and I've got my A and my B. And it may be the\ncase that suppose",
    "start": "1321260",
    "end": "1328270"
  },
  {
    "text": "we start running A first, A gets\nthe lock on the bank account and then B starts\nrunning and tries to get",
    "start": "1328270",
    "end": "1334322"
  },
  {
    "text": "the lock on the bank account. And it waits for A\nbecause A is still holding this lock on the bank account. So we may have this\nsituation where",
    "start": "1334322",
    "end": "1341049"
  },
  {
    "text": "B is waiting for A to release\nthe lock on the bank account. But the way that I've\ndescribed this so far,",
    "start": "1341050",
    "end": "1347520"
  },
  {
    "text": "it may not be clear\nthat B is ever",
    "start": "1347520",
    "end": "1353226"
  },
  {
    "text": "going to be able to\nactually obtain the lock. Because we said that these\ntentatively committed actions",
    "start": "1353226",
    "end": "1358830"
  },
  {
    "text": "don't release their locks\nuntil after the commit point has been reached.",
    "start": "1358830",
    "end": "1364120"
  },
  {
    "text": "It turns out that we need to\nsort of modify that statement just a little bit. And that kind of\ngets to the comment that was made before\nwhich points this out.",
    "start": "1364120",
    "end": "1370900"
  },
  {
    "text": "What we want to say is\nthat when an action like A",
    "start": "1370900",
    "end": "1376460"
  },
  {
    "text": "tentatively commits,\nwe want to make it",
    "start": "1376460",
    "end": "1383820"
  },
  {
    "text": "so that S and its children\ncan see A's updates.",
    "start": "1383820",
    "end": "1391690"
  },
  {
    "text": " After A has\ntentatively committed,",
    "start": "1391690",
    "end": "1398230"
  },
  {
    "text": "the other actions\nthat are underneath S should be able to see\nthe updates that A made.",
    "start": "1398230",
    "end": "1403659"
  },
  {
    "text": "So A is going to go ahead\nand withdraw the money from the bank account, and then\nit's going to say OK, I'm done,",
    "start": "1403660",
    "end": "1409110"
  },
  {
    "text": "I've withdrawn my money. And now any other\naction within S that needs to run\nthat maybe also needs to update the bank\naccount will be allowed",
    "start": "1409110",
    "end": "1415611"
  },
  {
    "text": "to go ahead and do that. So B could go ahead and run\nand update the bank account. Notice that we haven't\nsaid that A's updates are",
    "start": "1415611",
    "end": "1422790"
  },
  {
    "text": "visible outside of S. Nobody else gets to see\nthat this bank account balance got changed. It's just the action B that gets\nto see that the bank account",
    "start": "1422790",
    "end": "1430800"
  },
  {
    "text": "balance is going to change. Effectively, what\nthis amounts to is that when A\ntentatively commits",
    "start": "1430800",
    "end": "1436380"
  },
  {
    "text": "it assigns all of its\nlocks up to the S action. ",
    "start": "1436380",
    "end": "1448210"
  },
  {
    "start": "1446000",
    "end": "1587000"
  },
  {
    "text": "That's as much as\nI'm going to say about this notion of\nnested atomic actions.",
    "start": "1448210",
    "end": "1453660"
  },
  {
    "text": "What this has given us\nis this way to have, on a single site,\none action that is composed of\nmultiple sub-actions",
    "start": "1453660",
    "end": "1460310"
  },
  {
    "text": "where those sub-actions are\nisolated from each other. And all of the sub-actions\neither commit or abort",
    "start": "1460310",
    "end": "1467250"
  },
  {
    "text": "together as a batch.  But we said what we\nultimately wanted",
    "start": "1467250",
    "end": "1473200"
  },
  {
    "text": "was the ability to do this\nacross multiple sites. ",
    "start": "1473200",
    "end": "1480510"
  },
  {
    "text": "Just to draw a simple\narchitecture diagram",
    "start": "1480510",
    "end": "1485980"
  },
  {
    "text": "about the multi-site case\nseeing what this looks like, suppose we have some\naction S and suppose",
    "start": "1485980",
    "end": "1493450"
  },
  {
    "text": "we still have our A and our B.",
    "start": "1493450",
    "end": "1503799"
  },
  {
    "text": "Now, just to conceptualize\nthis, suppose that there is some network in\nthe middle of these things.",
    "start": "1503800",
    "end": "1511080"
  },
  {
    "text": "And this is a\nbest-effort network",
    "start": "1511080",
    "end": "1517262"
  },
  {
    "text": "so it has all the problems\nthat we talked about that best-effort networks have. It has congestion, it has\ndelays, it can lose packets.",
    "start": "1517262",
    "end": "1524543"
  },
  {
    "text": " And the way to think\nabout these things",
    "start": "1524543",
    "end": "1529990"
  },
  {
    "text": "is that these actions are going\nto interact with each other. These nodes are going to\ninteract with each other using",
    "start": "1529990",
    "end": "1535990"
  },
  {
    "text": "RPCs. And they're just\ngoing to send actions, they're just going\nto send requests to each other and\nresponses over these links.",
    "start": "1535990",
    "end": "1542950"
  },
  {
    "text": "So S is going to send RPC to A\nsaying reserve a seat for me, for example, and then A\nis going to send a reply",
    "start": "1542950",
    "end": "1549960"
  },
  {
    "text": "back saying OK, I went ahead\nand reserved that seat. So what I want to\ndo is sort of go from this informal\ndescription of what",
    "start": "1549960",
    "end": "1556890"
  },
  {
    "text": "we want in the multi-site case\nto an actual description of how the protocol works so you\nguys can see that there",
    "start": "1556890",
    "end": "1562304"
  },
  {
    "text": "are some pretty subtle details\nthat are involved in this. And it's worth pointing out\nthat this situation is fairly",
    "start": "1562305",
    "end": "1568920"
  },
  {
    "text": "similar to many of\nthe things that, some of the problems\nthat you're going to have to deal with in the\ncontext of the design project",
    "start": "1568920",
    "end": "1574314"
  },
  {
    "text": "so it probably is a good idea\nfor you to pay attention. ",
    "start": "1574314",
    "end": "1579440"
  },
  {
    "text": "So let's talk about how\nthis protocol would work. The idea here is we\nwant to provide --",
    "start": "1579440",
    "end": "1591160"
  },
  {
    "start": "1587000",
    "end": "1995000"
  },
  {
    "text": "Suppose we're still in this\nsame travel site example. The client wants to make these\nreservations over this network,",
    "start": "1591160",
    "end": "1599759"
  },
  {
    "text": "and the protocol we're going\nto use is a protocol called \"two-phase commit\". ",
    "start": "1599760",
    "end": "1613610"
  },
  {
    "text": "Suppose we have our node\nS which is the coordinator node, the node that\nrepresents the travel site,",
    "start": "1613610",
    "end": "1619400"
  },
  {
    "text": "and we also have our two\nworker nodes that correspond",
    "start": "1619400",
    "end": "1625990"
  },
  {
    "text": "to JetBlue and USAir A and B.",
    "start": "1625990",
    "end": "1631020"
  },
  {
    "text": "I just want to show\nthat each of these sites",
    "start": "1631020",
    "end": "1640180"
  },
  {
    "text": "is going to maintain\na bit of a log that reflects the state of the\nactions that it's running. So I'm going to show\nthe state of the log",
    "start": "1640180",
    "end": "1646720"
  },
  {
    "text": "on each of these nodes. ",
    "start": "1646720",
    "end": "1652440"
  },
  {
    "text": "Suppose at some time S\nstarts executing this action,",
    "start": "1652440",
    "end": "1658320"
  },
  {
    "text": "let's call it T, so it's going\nto write a log record that says start T, and\nthen it's going",
    "start": "1658320",
    "end": "1664900"
  },
  {
    "text": "to request that each of\nthe subordinate nodes, the sub-nodes goes ahead\nand does the processing,",
    "start": "1664900",
    "end": "1672039"
  },
  {
    "text": "say purchases the\nticket that it wants. It is going to send a message\nhere saying, for example,",
    "start": "1672040",
    "end": "1680740"
  },
  {
    "text": "say the message consists\nof do something, do X, purchase this ticket.",
    "start": "1680740",
    "end": "1686830"
  },
  {
    "text": "And, at the same\ntime, it may also send a message to B telling\nit to do something else. Say, for example, do Y.",
    "start": "1686830",
    "end": "1698782"
  },
  {
    "text": "Now what's going to happen\nis that each of these guys is going to receive this\nrequest to do something, so it's going to write a\nlog record that says start.",
    "start": "1698782",
    "end": "1706034"
  },
  {
    "text": "It's going to keep some\ninformation about what it started doing,\nit's going to say X, and it's going to remember\nthat maybe this was",
    "start": "1706034",
    "end": "1711670"
  },
  {
    "text": "a part of transaction T. And, similarly,\nthis guy is going to start Y which was a\npart of transaction T.",
    "start": "1711670",
    "end": "1722130"
  },
  {
    "text": "And then these two As\nand Bs now are just going to start\nexecuting the action that they were asked to execute.",
    "start": "1722130",
    "end": "1727380"
  },
  {
    "text": "So they are going to, for\nexample, purchase the ticket. They're going to run. They're going to\nacquire whatever locks that they need\nto process and then",
    "start": "1727380",
    "end": "1733840"
  },
  {
    "text": "they are, at some point,\ngoing to enter the tentatively committed state. The same thing is going\nto happen over here.",
    "start": "1733840",
    "end": "1741580"
  },
  {
    "text": "They are both going\nto run these actions. When they reach the\ntentatively committed state,",
    "start": "1741580",
    "end": "1748590"
  },
  {
    "text": "what they're going\nto do is they're going to send a message back\nthat says something like did X?",
    "start": "1748590",
    "end": "1757880"
  },
  {
    "text": "This message is\nsometimes called a vote. Basically it says\nwhether or not this site agrees that it was able\nto finish the work that it",
    "start": "1757880",
    "end": "1765690"
  },
  {
    "text": "was able to do. So if it votes yes that means,\nyes, I'm done, I'm ready to go. And if it votes no\nthat means sorry,",
    "start": "1765690",
    "end": "1771610"
  },
  {
    "text": "I couldn't do the\nthing that you wanted. So similarly B is going to send\nback its vote that says did Y.",
    "start": "1771610",
    "end": "1781690"
  },
  {
    "text": "So let's suppose, in both these\ncases, both of these actions were able to do the work\nthat they wanted to do. ",
    "start": "1781690",
    "end": "1796483"
  },
  {
    "text": "At this point now\nwhat's going to happen is that S is going to look\nat the votes from the actions that it is tasked, and it's\ngoing to decide whether or not",
    "start": "1796484",
    "end": "1804540"
  },
  {
    "text": "this action is going to commit\nor is not going to commit. So S is the one that's\nresponsible for deciding",
    "start": "1804540",
    "end": "1809600"
  },
  {
    "text": "whether or not this\nentire action commits. And suppose it decides\nit's going to commit,",
    "start": "1809600",
    "end": "1817034"
  },
  {
    "text": "it's going to\nwrite a record that says commit this transaction T.",
    "start": "1817035",
    "end": "1825470"
  },
  {
    "text": "So this is now the commit point. As soon as S writes\nthe commit record, that means this action\nis going to commit,",
    "start": "1825470",
    "end": "1831429"
  },
  {
    "text": "it's going to be made\nvisible to the outside world, all the work has been done. And it's OK if it does\nthis because A and B are",
    "start": "1831430",
    "end": "1838414"
  },
  {
    "text": "both in the tentatively\ncommitted state. They've said I'm\nready to go, I've done all the work I need to\ndo, I can commit whenever",
    "start": "1838414",
    "end": "1844519"
  },
  {
    "text": "you tell me it's OK to commit. So, after this point,\neverything is going to commit.",
    "start": "1844520",
    "end": "1851067"
  },
  {
    "text": "The reason this is called the\ntwo-phase commit protocol, typically this part\nis called phase one where we're deciding whether\nor not we agree to commit.",
    "start": "1851067",
    "end": "1859660"
  },
  {
    "text": "And then here in this next\nstep we enter phase two. So what do we have\nto do in phase two?",
    "start": "1859660",
    "end": "1866902"
  },
  {
    "text": " Notice that these guys\nhave tentatively committed.",
    "start": "1866902",
    "end": "1873279"
  },
  {
    "text": "A and B don't actually\nknow whether or not the action has committed\nso they don't actually know whether they should\nrelease their locks",
    "start": "1873280",
    "end": "1879020"
  },
  {
    "text": "and make their updates\nvisible to the outside world. So we need to make sure that\nS tells A and B that OK,",
    "start": "1879020",
    "end": "1884190"
  },
  {
    "text": "this action is done, I've\ncommitted and it's OK for you to also go ahead and commit\nand expose your results",
    "start": "1884190",
    "end": "1889470"
  },
  {
    "text": "to the outside world. This is slightly different\nthan the protocol we looked at before\nbecause these things are on different machines and so\nwe have to pass information",
    "start": "1889470",
    "end": "1896263"
  },
  {
    "text": "from S to A and B to let\nthem know that this action is ready to go.",
    "start": "1896263",
    "end": "1901320"
  },
  {
    "text": "S is going to send a\nmessage to A saying commit,",
    "start": "1901320",
    "end": "1908250"
  },
  {
    "text": "A is going to write a log\nrecord that says commit,",
    "start": "1908250",
    "end": "1914300"
  },
  {
    "text": "and then it's going\nto do the same thing, send the message to\nB that says commit.",
    "start": "1914300",
    "end": "1921642"
  },
  {
    "text": "And, similarly, B\nis going to write a log record that says commit.",
    "start": "1921642",
    "end": "1929870"
  },
  {
    "text": "This is the basic\ntwo-phase commit protocol. ",
    "start": "1929870",
    "end": "1935610"
  },
  {
    "text": "If you count the number of\nmessages that you see here, if you have N sites,\nthe number of messages you have to send\nin two-phase commit",
    "start": "1935610",
    "end": "1941490"
  },
  {
    "text": "is 3N in the basic\nprotocol without any loss.",
    "start": "1941490",
    "end": "1947490"
  },
  {
    "text": "Notice I haven't said\nanything about what happens when a message is lost. And remember these\nbest-effort networks",
    "start": "1947490",
    "end": "1953530"
  },
  {
    "text": "have this property that messages\ncan be lost, we can lose data, so we want to make\nsure that we understand",
    "start": "1953530",
    "end": "1959970"
  },
  {
    "text": "how this protocol works in\nthe face of data being lost. The other thing\nthat we need to do is to make sure\nthat we understand",
    "start": "1959970",
    "end": "1966040"
  },
  {
    "text": "how this protocol\nworks in the event that either S crashes\nor A and B crash at different points in the\nexecution of the protocol.",
    "start": "1966040",
    "end": "1972800"
  },
  {
    "text": "So that's what we're going\nto talk through now, sort of these nitty-gritty\ndetails about how we actually get this thing to work in\nthe face of these properties",
    "start": "1972800",
    "end": "1978799"
  },
  {
    "text": "that best-effort\nnetworks introduce. ",
    "start": "1978800",
    "end": "1990070"
  },
  {
    "text": "To remind you guys\nhow we deal with loss",
    "start": "1990070",
    "end": "2002019"
  },
  {
    "start": "1995000",
    "end": "3048000"
  },
  {
    "text": "in best-effort\nnetworks, I am just going to very quickly\nreview exactly once RPC protocol that we\ntalked about a few weeks ago.",
    "start": "2002020",
    "end": "2009470"
  },
  {
    "text": "Exactly once RPC\nremember is a way",
    "start": "2009470",
    "end": "2016789"
  },
  {
    "text": "to make it so that a procedure\ncall gets executed once, a remote procedure call gets\nexecuted once, and only once,",
    "start": "2016790",
    "end": "2022780"
  },
  {
    "text": "between a client and a server. So if we've got our\nclient and our server,",
    "start": "2022780",
    "end": "2027890"
  },
  {
    "text": "what we do is keep\nat the client, we keep a list of\nmessages, at the server we keep a list of \"nonces.\"",
    "start": "2027890",
    "end": "2033930"
  },
  {
    "text": " The client sends a request,\na message, for example,",
    "start": "2033930",
    "end": "2039430"
  },
  {
    "text": "to the server asking\nit to do something and it attaches a\nnonce to it, say N1.",
    "start": "2039430",
    "end": "2047460"
  },
  {
    "text": "So the client puts in its\nmessage table message, N1 stores that information.",
    "start": "2047460",
    "end": "2053250"
  },
  {
    "text": "The server receives\nthis request,",
    "start": "2053250",
    "end": "2058710"
  },
  {
    "text": "it stores the nonce in\nits nonce table and, one, sends an acknowledgement\nand processes the request.",
    "start": "2058710",
    "end": "2065610"
  },
  {
    "text": "The acknowledgement comes\nback, and maybe it's",
    "start": "2065610",
    "end": "2070980"
  },
  {
    "text": "lost because these are\nbest-ever networks. Remember we have this timeout. After some timeout period\nthe client resends.",
    "start": "2070980",
    "end": "2080158"
  },
  {
    "text": "This is message, N1 again. When the message gets\nresent, the server",
    "start": "2080159",
    "end": "2085489"
  },
  {
    "text": "checks to see if this message\nis already in its nonce table. If it is, it doesn't process\nthe message again but it sends",
    "start": "2085489",
    "end": "2090888"
  },
  {
    "text": "the [ACE?] for that message. Now this [ACE?]\nmessage gets received,",
    "start": "2090889",
    "end": "2096341"
  },
  {
    "text": "the client crosses it off its\nmessage list because it knows it's done processing. ",
    "start": "2096342",
    "end": "2104800"
  },
  {
    "text": "That's the basic exactly\nonce RPC protocol. And what this guarantees is\nthat this persistent client is",
    "start": "2104800",
    "end": "2112220"
  },
  {
    "text": "going to retry\nsending the request until it gets an\nacknowledgement. And the problem with that is\nthat it can generate multiple,",
    "start": "2112220",
    "end": "2118270"
  },
  {
    "text": "the server can hear this\nmessage multiple times so the server uses this\nnonce table to filter out",
    "start": "2118270",
    "end": "2123538"
  },
  {
    "text": "duplicate messages. ",
    "start": "2123539",
    "end": "2138520"
  },
  {
    "text": "Let's see how we can use this\nnotion of this exactly once in our two-phase\ncommit protocol. ",
    "start": "2138520",
    "end": "2145470"
  },
  {
    "text": "I'm going to erase this and just\nredraw a similar example with a [LOSI?] protocol instead\nof a [LOSLS?] protocol.",
    "start": "2145470",
    "end": "2155570"
  },
  {
    "text": "And just to sort of make the\nnotation a little bit simpler, let's now just suppose we\nhave one worker site A.",
    "start": "2155570",
    "end": "2162340"
  },
  {
    "text": "We're not going to show A or B. But this generalizes completely\nto as many As, Bs, Cs as we",
    "start": "2162340",
    "end": "2169050"
  },
  {
    "text": "want. What's going to happen\nnow is, what I want to do",
    "start": "2169050",
    "end": "2176539"
  },
  {
    "text": "is I want to keep a list\nof pending actions at S, as well as the log of NS.",
    "start": "2176540",
    "end": "2183990"
  },
  {
    "text": "And I'm also at A going\nto keep a list of pending actions and the log at A.",
    "start": "2183990",
    "end": "2195069"
  },
  {
    "text": "At some point S is going\nto go ahead and start processing the transaction\nagain and it's going to write start T.",
    "start": "2195070",
    "end": "2201220"
  },
  {
    "text": "It's going to add T to its\nlist of pending actions. And then it's going to send this\nmessage that says do X to A.",
    "start": "2201220",
    "end": "2209920"
  },
  {
    "text": "Of course, it may be the case\nthat this message gets lost because this is a\n[LOSI?] network.",
    "start": "2209920",
    "end": "2216940"
  },
  {
    "text": "So we're just going\nto use our persistent. We're going to\nmake S persistently",
    "start": "2216940",
    "end": "2222690"
  },
  {
    "text": "retry so some time later,\nafter some timeout, it's going to resend\nthis do X message.",
    "start": "2222690",
    "end": "2229100"
  },
  {
    "text": "And it knows that\nit needs to timeout because it sees that\nthere is this action here that's still pending. ",
    "start": "2229100",
    "end": "2238210"
  },
  {
    "text": "Now this site A is going\nto receive this request.",
    "start": "2238210",
    "end": "2243520"
  },
  {
    "text": "It's going to add\nX for transaction T to its pending list, it's\ngoing to write its start",
    "start": "2243520",
    "end": "2250289"
  },
  {
    "text": "X of T record, and it's\ngoing to go ahead and process just like it did before\nuntil it tentatively commits.",
    "start": "2250290",
    "end": "2257580"
  },
  {
    "text": " And now, once it is\ntentatively committed,",
    "start": "2257580",
    "end": "2264809"
  },
  {
    "text": "it's going to go ahead and\nmark this in its pending table this action is\ntentatively committed",
    "start": "2264810",
    "end": "2271660"
  },
  {
    "text": "and it's going to send a\nrequest back that says did X.",
    "start": "2271660",
    "end": "2278319"
  },
  {
    "text": "Of course, this request\ncan also be lost. So, again, remember we have the\nserver persistently retrying.",
    "start": "2278320",
    "end": "2286750"
  },
  {
    "text": "So, at some point, it didn't\nhear this did X request. It's just going to\nsay hey, do it again.",
    "start": "2286750",
    "end": "2292700"
  },
  {
    "text": "And now when A\nreceives this request, it's going to look up\nin its pending table,",
    "start": "2292700",
    "end": "2297710"
  },
  {
    "text": "it's going to see that it has\nalready tentatively committed this action. So it's just going to not\nprocess the action at all,",
    "start": "2297710",
    "end": "2303220"
  },
  {
    "text": "it's just going to send\nback the request that says, this should say do X,\nit's going to say did X.",
    "start": "2303220",
    "end": "2313010"
  },
  {
    "text": "Now, once S has received the\ntentative commits from all of the other actions, it\ncan go ahead and write",
    "start": "2313010",
    "end": "2319060"
  },
  {
    "text": "its commit record and we can\ngo ahead and enter phase two,",
    "start": "2319060",
    "end": "2325040"
  },
  {
    "text": "just like we did before. ",
    "start": "2325040",
    "end": "2330907"
  },
  {
    "text": "You can kind of see how\nthis is going to work out. The process is just going\nto continue in the same way.",
    "start": "2330907",
    "end": "2337660"
  },
  {
    "text": "After S writes\nits commit record, it's going to go ahead and\nsend the commit message. ",
    "start": "2337660",
    "end": "2347252"
  },
  {
    "text": "And, of course, it is possible\nfor the commit message to be lost. So, in this case, notice that\nthe server doesn't actually",
    "start": "2347252",
    "end": "2354960"
  },
  {
    "text": "know whether the commit\nmessage has been lost or not. And we haven't shown A\nsending out any responses",
    "start": "2354960",
    "end": "2361030"
  },
  {
    "text": "back to the server after the\ncommit message has been sent. So that means that A is\nthe one that actually",
    "start": "2361030",
    "end": "2366470"
  },
  {
    "text": "has to retry in this case. Now, A is just going\nto say hey, S, I did X.",
    "start": "2366470",
    "end": "2376869"
  },
  {
    "text": "And that's OK. Now what's going\nto happen is S is going to go ahead and\nlook up in its table, when",
    "start": "2376870",
    "end": "2383310"
  },
  {
    "text": "it wrote the commit\nmessage to change the state of this message to\ncommitted, this transaction to committed, so S is just\ngoing to look up in its table,",
    "start": "2383310",
    "end": "2392609"
  },
  {
    "text": "see that the\ntransaction is committed and is going to send\nthis message again.",
    "start": "2392610",
    "end": "2398590"
  },
  {
    "text": "And now, hopefully, this\ntime it gets through. And S can go ahead and change\nthe state of this action to committed, it can release its\nlocks and the protocol is done.",
    "start": "2398590",
    "end": "2407640"
  },
  {
    "text": "One thing to note\nis that as soon as A knows that the\naction is committed,",
    "start": "2407640",
    "end": "2413930"
  },
  {
    "text": "it doesn't need to keep any\nmore state about the action around anymore. It knows it's committed.",
    "start": "2413930",
    "end": "2419680"
  },
  {
    "text": "That means that S has\ndefinitely heard about the fact that it did X. And so A can go\nahead and just forget",
    "start": "2419680",
    "end": "2425760"
  },
  {
    "text": "any information it had in\nthis pending transaction table about the action.",
    "start": "2425760",
    "end": "2431520"
  },
  {
    "text": "We haven't quite\nsolved the problem but we still, in S, have to\nkeep this information around",
    "start": "2431520",
    "end": "2437030"
  },
  {
    "text": "about the fact that the\ntransaction committed because we never\nactually know, in S,",
    "start": "2437030",
    "end": "2442890"
  },
  {
    "text": "whether this final commit\nmessage got through or not. So it's always possible\nthat A could re-request",
    "start": "2442890",
    "end": "2448900"
  },
  {
    "text": "the state of transaction T. And S needs to be able\nto answer that correctly.",
    "start": "2448900",
    "end": "2454290"
  },
  {
    "text": "So this complicates\nthis a little bit, and there are a\ncouple of solutions that people have proposed.",
    "start": "2454290",
    "end": "2460345"
  },
  {
    "text": "The obvious one is we\njust add an extra round of acknowledgements\nonto the end of this. So that's a simple thing we can\ndo, is just have A acknowledge",
    "start": "2460345",
    "end": "2466830"
  },
  {
    "text": "that it heard the message. And then, as soon as S\nhas heard acknowledgements from all of its\nsubordinates, it can go ahead",
    "start": "2466830",
    "end": "2471890"
  },
  {
    "text": "and delete the information. There is another\nvariant of this, which is talked about a\nlittle bit in the text,",
    "start": "2471890",
    "end": "2476958"
  },
  {
    "text": "something called\npresumed commit where basically if A doesn't know\nanything about the action, it assumes that the\naction committed.",
    "start": "2476958",
    "end": "2482900"
  },
  {
    "text": "So A can discard the fact\nabout any committed actions. Getting that to work is\na little bit trickier.",
    "start": "2482900",
    "end": "2488200"
  },
  {
    "text": "And the details of it are\na little bit complicated",
    "start": "2488200",
    "end": "2494270"
  },
  {
    "text": "but you can sort\nof see the idea.",
    "start": "2494270",
    "end": "2499327"
  },
  {
    "text": "I just want to quickly spend\na couple of minutes talking about what happens in the\ncase when these systems crash",
    "start": "2499327",
    "end": "2507520"
  },
  {
    "text": "during different\nphases of execution so you guys can get a\nsense of how recovery would work in this environment.",
    "start": "2507520",
    "end": "2513650"
  },
  {
    "text": "Let's suppose that S crashes.  And there are two situations\nwe're worried about.",
    "start": "2513650",
    "end": "2520550"
  },
  {
    "text": "Either it crashes before commit\nor it crashes after commit. If it crashes before\ncommit that means",
    "start": "2520550",
    "end": "2531230"
  },
  {
    "text": "that, S is the sort of\nlead transaction here,",
    "start": "2531230",
    "end": "2539900"
  },
  {
    "text": "we want to treat\nthis just like we would treat this in sort\nof traditional recoverable systems.",
    "start": "2539900",
    "end": "2545080"
  },
  {
    "text": "So if we crash before\nthe main commit, well, what we want to do is undo the\neffects of this transaction",
    "start": "2545080",
    "end": "2550660"
  },
  {
    "text": "completely. So we're going to undo T.",
    "start": "2550660",
    "end": "2556349"
  },
  {
    "text": "Notice, however, that if\nthere are multiple As, Bs and Cs it may be the\ncase that S crashes and some",
    "start": "2556350",
    "end": "2563480"
  },
  {
    "text": "of the subordinates are still\nprocessing messages and send did finish processing\nrequests to S.",
    "start": "2563480",
    "end": "2570940"
  },
  {
    "text": "That means when S crashes it\nrecovers, it comes back up, it undoes the transaction and\nit remembers that T aborted.",
    "start": "2570940",
    "end": "2582580"
  },
  {
    "text": "So it puts T in its\ntransaction table so that when it gets a request\nfrom somebody saying hey, I finished doing this\npart of transaction T,",
    "start": "2582580",
    "end": "2589410"
  },
  {
    "text": "it can tell that guy oh, by the\nway, that transaction aborted. Now, suppose that we crashed\nafter the commit, well,",
    "start": "2589410",
    "end": "2596077"
  },
  {
    "text": "you know what's going to happen. We want this transaction\nto be durable. We said that the commit\nis the commit point,",
    "start": "2596077",
    "end": "2601079"
  },
  {
    "text": "we want this thing to\nappear to have happened. So we need to make sure\nthat we run redo on T",
    "start": "2601080",
    "end": "2608720"
  },
  {
    "text": "and that we remember\nthat T committed.",
    "start": "2608720",
    "end": "2616109"
  },
  {
    "text": " Now, if A crashes, the situation\nis a little bit easier.",
    "start": "2616110",
    "end": "2624804"
  },
  {
    "text": "Basically, there are\nonly two situations we have to worry about in A. It's either before\nor after we've",
    "start": "2624804",
    "end": "2630070"
  },
  {
    "text": "gone into the\ntentative commit state. ",
    "start": "2630070",
    "end": "2638010"
  },
  {
    "text": "If it's before the\ntentative commit state, well, we're just going to undo\nthe effects of this transaction completely. We're going to roll\nit back and basically",
    "start": "2638010",
    "end": "2644458"
  },
  {
    "text": "going to forget about it. And it's going to be\nS's responsibility to try and redo this action\nwith us, if it wants to,",
    "start": "2644458",
    "end": "2653579"
  },
  {
    "text": "or S may go ask somebody else\nto do this part of the action. If we crashed after\nthe tentative commit,",
    "start": "2653580",
    "end": "2658640"
  },
  {
    "text": "though, remember that at\nthis point it's up to S. This is A crashes.",
    "start": "2658640",
    "end": "2664025"
  },
  {
    "text": " At this point it's up to S.",
    "start": "2664025",
    "end": "2670490"
  },
  {
    "text": "So, after we've reached\nthe tentative commit, this action needs to go\nahead and check with S",
    "start": "2670490",
    "end": "2676330"
  },
  {
    "text": "and see what the final\noutcome of this thing was. It crashes, it comes\nback up, it sees it was in the tentative\ncommit state for T,",
    "start": "2676330",
    "end": "2684109"
  },
  {
    "text": "and so it sends a\nmessage to S saying hey, whatever happened to T? And then S sends a\nresponse back if it knows.",
    "start": "2684109",
    "end": "2689120"
  },
  {
    "text": " This is the basic outline\nof how we do crash recovery",
    "start": "2689120",
    "end": "2695300"
  },
  {
    "text": "and how we deal\nwith lost messages in this two-phase\ncommit protocol. ",
    "start": "2695300",
    "end": "2701980"
  },
  {
    "text": "With the last few minutes, I\nwant to talk about something. This two-phase commit\nprotocol seems really great. It seems like we\ngot in this way we",
    "start": "2701980",
    "end": "2708549"
  },
  {
    "text": "have actions that\nare distributed across multiple sites. We've made it so that\nif the action commits,",
    "start": "2708550",
    "end": "2713980"
  },
  {
    "text": "we have this nice property\nthat if the action commits, we can make it so that\neither A or B don't commit",
    "start": "2713980",
    "end": "2721450"
  },
  {
    "text": "or they definitely both commit. We have this way in which\nS is the ultimate arbiter and authority of what commits.",
    "start": "2721450",
    "end": "2728050"
  },
  {
    "text": "This seems like a really\nnice system that we built. And it is. And it has all these\ngreat properties,",
    "start": "2728050",
    "end": "2736180"
  },
  {
    "text": "but there is one property\nthat it doesn't have. The question is, say in this\nenvironment with A and B,",
    "start": "2736180",
    "end": "2755200"
  },
  {
    "text": "do they make their results\nvisible at the same time.",
    "start": "2755200",
    "end": "2772619"
  },
  {
    "text": "I had written commit before. And, in some sense, they\ndo commit at the same time because they're going to\ndefinitely commit at the point",
    "start": "2772620",
    "end": "2779030"
  },
  {
    "text": "that this record gets written. But the answer to the question\nare there results visible, the question is\nare there results",
    "start": "2779030",
    "end": "2784305"
  },
  {
    "text": "visible at the same time, if\nyou stare at this for a little while you realize no\nbecause their results",
    "start": "2784305",
    "end": "2790339"
  },
  {
    "text": "become visible at the point\nat which these A and B receive the commit message from S.",
    "start": "2790340",
    "end": "2797060"
  },
  {
    "text": "Not at the point that S\nwrites the commit record. So they're going to expose their\nresults at a slightly different",
    "start": "2797060",
    "end": "2803230"
  },
  {
    "text": "point in time. And, in fact, it\ncould be a long time because it may be that\nA crashed after it went",
    "start": "2803230",
    "end": "2809342"
  },
  {
    "text": "into the tentative commit\nrecord and it took it two days to recover. And then it came back up\nand then it checks with S",
    "start": "2809342",
    "end": "2814869"
  },
  {
    "text": "and says hey, whatever\nhappened to T? So it could be a very\nlong time before, say,",
    "start": "2814870",
    "end": "2820220"
  },
  {
    "text": "A commits, makes\nits results visible, whereas B may have\ndone immediately",
    "start": "2820220",
    "end": "2826560"
  },
  {
    "text": "after it received the first\ncommit message from S. You might ask the question\nis it possible to guaranty",
    "start": "2826560",
    "end": "2836560"
  },
  {
    "text": "that A and B expose their\nresults to the outside world at exactly the same instant. And the answer to this\nquestion, it turns out, is no.",
    "start": "2836560",
    "end": "2845990"
  },
  {
    "text": "And this is kind of\na fundamental result. The reason for this,\nlet me just give you,",
    "start": "2845990",
    "end": "2852650"
  },
  {
    "text": "there's a simple example that's\ntalked about in the book. It's called the \"two\ngenerals problem\". ",
    "start": "2852650",
    "end": "2861070"
  },
  {
    "text": "And the idea is as follows. Suppose there are two generals\nand they have their armies.",
    "start": "2861070",
    "end": "2867220"
  },
  {
    "text": "They've flanking somebody\nwho they are attacking and they're on the\nsides of a valley and they're both going to dive\ninto the valley with the armies",
    "start": "2867220",
    "end": "2873520"
  },
  {
    "text": "at the same time. They're trying to\nagree what time they're going to do this at. And they want to make sure they\nboth attack at the same time",
    "start": "2873520",
    "end": "2879880"
  },
  {
    "text": "because, if they don't\nattack at the same time, they're afraid that\none of them will lose. So the only way they\nhave to communicate",
    "start": "2879880",
    "end": "2886030"
  },
  {
    "text": "with each other is by\nsending these messengers, say, across the valleys. They have some guy\nwho runs across. But, of course, this\nguy may not make it.",
    "start": "2886030",
    "end": "2892460"
  },
  {
    "text": "He may collapse from exhaustion\nor he may get shot or whatever. ",
    "start": "2892460",
    "end": "2898980"
  },
  {
    "text": "So the first general\nsends a runner out to the second general that\nsays we'll attack at dawn.",
    "start": "2898980",
    "end": "2904259"
  },
  {
    "text": "And maybe that\nrunner gets through. And then the second general\nsends a runner back that says yes, we'll attack at dawn.",
    "start": "2904260",
    "end": "2910660"
  },
  {
    "text": "And maybe that runner gets\nthrough, or maybe he doesn't. The second runner\ndoesn't get through,",
    "start": "2910660",
    "end": "2916270"
  },
  {
    "text": "and the first\ngeneral says man, I don't know if the second\ngeneral heard about this or not. So he sends another runner\nthat says we'll attack at dawn.",
    "start": "2916270",
    "end": "2922500"
  },
  {
    "text": "And the second general says\nI already sent a runner but I guess he\ndidn't get through and he sends another one back.",
    "start": "2922500",
    "end": "2928490"
  },
  {
    "text": "And, ultimately, they\nboth need to agree that they'll both\nattack at dawn so you need a certain number of\nrunners to successfully get",
    "start": "2928490",
    "end": "2934500"
  },
  {
    "text": "through in order\nfor this to happen. The issue here,\nthough, is that suppose",
    "start": "2934500",
    "end": "2939600"
  },
  {
    "text": "the general have a\nfixed number of runners and they want to say what's\nthe maximum number of runners",
    "start": "2939600",
    "end": "2945250"
  },
  {
    "text": "that I could possibly\never need in order to agree on this thing? And, if you think about\nthis for a minute,",
    "start": "2945250",
    "end": "2950960"
  },
  {
    "text": "you will see that\nthere's no finite bound on the number of runners\nthat could possibly",
    "start": "2950960",
    "end": "2956900"
  },
  {
    "text": "be needed, because it's always\nthe case that a huge number",
    "start": "2956900",
    "end": "2964804"
  },
  {
    "text": "of runners could be\nlost because this is this best-effort network\nwhere there's always some probability of\nsomething being lost.",
    "start": "2964804",
    "end": "2970160"
  },
  {
    "text": "There is always this\ninfinitesimal little chance that a million runners in a\nrow wouldn't make it through.",
    "start": "2970160",
    "end": "2976770"
  },
  {
    "text": "So this is essentially\nthe two generals problem. And what it says is it's\nimpossible for these two guys",
    "start": "2976770",
    "end": "2982190"
  },
  {
    "text": "to guaranty that they\nwill achieve consensus about something using a\nfixed number of messages,",
    "start": "2982190",
    "end": "2987390"
  },
  {
    "text": "using a fixed number of runners. That means, in the case\nof two-phase commit,",
    "start": "2987390",
    "end": "2994400"
  },
  {
    "text": "what that suggests is that\nthis S or one of these clients may need to continually\nretransmit, say,",
    "start": "2994400",
    "end": "3000550"
  },
  {
    "text": "an infinite number of times,\na very large number of times before its request is\nactually processed.",
    "start": "3000550",
    "end": "3005770"
  },
  {
    "text": "Because there's always this sort\nof small chance of a message being lost by the\nbest-effort network.",
    "start": "3005770",
    "end": "3011310"
  },
  {
    "text": "So that's the two\ngenerals problem and it's just sort of a\nnice result to keep in mind. It's one of those results\nin computer science",
    "start": "3011310",
    "end": "3017180"
  },
  {
    "text": "that sometimes it turns\nout to be important. In practice, in this\nkind of environment it doesn't matter that much.",
    "start": "3017180",
    "end": "3024220"
  },
  {
    "text": "The probabilities\nof loss are small. And so most of the\ntime this is going to achieve consensus after a\nlimited number of messages.",
    "start": "3024220",
    "end": "3032730"
  },
  {
    "text": "So that's it for our\ndiscussion of fault tolerance and recovery. Next time we're going to\nstart talking about security",
    "start": "3032730",
    "end": "3038180"
  },
  {
    "text": "and protection of information. We will see you on Monday.",
    "start": "3038180",
    "end": "3043490"
  },
  {
    "start": "3043490",
    "end": "3049359"
  }
]